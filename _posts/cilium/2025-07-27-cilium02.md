---
title: Cilium 2ì£¼ì°¨ ì •ë¦¬
date: 2025-07-27 01:30:00 +0900
categories: [Cilium]
tags: [Cilium]
---

## **ğŸ–¥ï¸ ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±**

### **1. Vagrantfile ë‹¤ìš´ë¡œë“œ ë° ê°€ìƒë¨¸ì‹  êµ¬ì„±**

```bash
curl -O https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/2w/Vagrantfile

vagrant up
```

âœ…Â **ì¶œë ¥**

```bash
Bringing machine 'k8s-ctr' up with 'virtualbox' provider...
Bringing machine 'k8s-w1' up with 'virtualbox' provider...
Bringing machine 'k8s-w2' up with 'virtualbox' provider...
==> k8s-ctr: Preparing master VM for linked clones...
    k8s-ctr: This is a one time operation. Once the master VM is prepared,
    k8s-ctr: it will be used as a base for linked clones, making the creation
    k8s-ctr: of new VMs take milliseconds on a modern system.
==> k8s-ctr: Importing base box 'bento/ubuntu-24.04'...
==> k8s-ctr: Cloning VM...
==> k8s-ctr: Matching MAC address for NAT networking...
==> k8s-ctr: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-ctr: Setting the name of the VM: k8s-ctr
==> k8s-ctr: Clearing any previously set network interfaces...
==> k8s-ctr: Preparing network interfaces based on configuration...
    k8s-ctr: Adapter 1: nat
    k8s-ctr: Adapter 2: hostonly
==> k8s-ctr: Forwarding ports...
    k8s-ctr: 22 (guest) => 60000 (host) (adapter 1)
==> k8s-ctr: Running 'pre-boot' VM customizations...
==> k8s-ctr: Booting VM...
==> k8s-ctr: Waiting for machine to boot. This may take a few minutes...
    k8s-ctr: SSH address: 127.0.0.1:60000
    k8s-ctr: SSH username: vagrant
    k8s-ctr: SSH auth method: private key
    k8s-ctr: 
    k8s-ctr: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-ctr: this with a newly generated keypair for better security.
    k8s-ctr: 
    k8s-ctr: Inserting generated public key within guest...
    k8s-ctr: Removing insecure key from the guest if it's present...
    k8s-ctr: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-ctr: Machine booted and ready!
==> k8s-ctr: Checking for guest additions in VM...
==> k8s-ctr: Setting hostname...
==> k8s-ctr: Configuring and enabling network interfaces...
==> k8s-ctr: Running provisioner: shell...
    k8s-ctr: Running: /tmp/vagrant-shell20250725-4641-sd34li.sh
    k8s-ctr: >>>> Initial Config Start <<<<
    k8s-ctr: [TASK 1] Setting Profile & Bashrc
    k8s-ctr: [TASK 2] Disable AppArmor
    k8s-ctr: [TASK 3] Disable and turn off SWAP
    k8s-ctr: [TASK 4] Install Packages
    k8s-ctr: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-ctr: [TASK 6] Install Packages & Helm
    k8s-ctr: >>>> Initial Config End <<<<
==> k8s-ctr: Running provisioner: shell...
    k8s-ctr: Running: /tmp/vagrant-shell20250725-4641-ffu2wg.sh
    k8s-ctr: >>>> K8S Controlplane config Start <<<<
    k8s-ctr: [TASK 1] Initial Kubernetes
    k8s-ctr: [TASK 2] Setting kube config file
    k8s-ctr: [TASK 3] Source the completion
    k8s-ctr: [TASK 4] Alias kubectl to k
    k8s-ctr: [TASK 5] Install Kubectx & Kubens
    k8s-ctr: [TASK 6] Install Kubeps & Setting PS1
    k8s-ctr: [TASK 7] Install Cilium CNI
    k8s-ctr: [TASK 8] Install Cilium CLI
    k8s-ctr: cilium
    k8s-ctr: [TASK 9] local DNS with hosts file
    k8s-ctr: >>>> K8S Controlplane Config End <<<<
==> k8s-w1: Cloning VM...
==> k8s-w1: Matching MAC address for NAT networking...
==> k8s-w1: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-w1: Setting the name of the VM: k8s-w1
==> k8s-w1: Clearing any previously set network interfaces...
==> k8s-w1: Preparing network interfaces based on configuration...
    k8s-w1: Adapter 1: nat
    k8s-w1: Adapter 2: hostonly
==> k8s-w1: Forwarding ports...
    k8s-w1: 22 (guest) => 60001 (host) (adapter 1)
==> k8s-w1: Running 'pre-boot' VM customizations...
==> k8s-w1: Booting VM...
==> k8s-w1: Waiting for machine to boot. This may take a few minutes...
    k8s-w1: SSH address: 127.0.0.1:60001
    k8s-w1: SSH username: vagrant
    k8s-w1: SSH auth method: private key
    k8s-w1: 
    k8s-w1: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-w1: this with a newly generated keypair for better security.
    k8s-w1: 
    k8s-w1: Inserting generated public key within guest...
    k8s-w1: Removing insecure key from the guest if it's present...
    k8s-w1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-w1: Machine booted and ready!
==> k8s-w1: Checking for guest additions in VM...
==> k8s-w1: Setting hostname...
==> k8s-w1: Configuring and enabling network interfaces...
==> k8s-w1: Running provisioner: shell...
    k8s-w1: Running: /tmp/vagrant-shell20250725-4641-wbk3an.sh
    k8s-w1: >>>> Initial Config Start <<<<
    k8s-w1: [TASK 1] Setting Profile & Bashrc
    k8s-w1: [TASK 2] Disable AppArmor
    k8s-w1: [TASK 3] Disable and turn off SWAP
    k8s-w1: [TASK 4] Install Packages
    k8s-w1: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-w1: [TASK 6] Install Packages & Helm
    k8s-w1: >>>> Initial Config End <<<<
==> k8s-w1: Running provisioner: shell...
    k8s-w1: Running: /tmp/vagrant-shell20250725-4641-3fipel.sh
    k8s-w1: >>>> K8S Node config Start <<<<
    k8s-w1: [TASK 1] K8S Controlplane Join
    k8s-w1: >>>> K8S Node config End <<<<
==> k8s-w2: Cloning VM...
==> k8s-w2: Matching MAC address for NAT networking...
==> k8s-w2: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-w2: Setting the name of the VM: k8s-w2
==> k8s-w2: Clearing any previously set network interfaces...
==> k8s-w2: Preparing network interfaces based on configuration...
    k8s-w2: Adapter 1: nat
    k8s-w2: Adapter 2: hostonly
==> k8s-w2: Forwarding ports...
    k8s-w2: 22 (guest) => 60002 (host) (adapter 1)
==> k8s-w2: Running 'pre-boot' VM customizations...
==> k8s-w2: Booting VM...
==> k8s-w2: Waiting for machine to boot. This may take a few minutes...
    k8s-w2: SSH address: 127.0.0.1:60002
    k8s-w2: SSH username: vagrant
    k8s-w2: SSH auth method: private key
    k8s-w2: 
    k8s-w2: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-w2: this with a newly generated keypair for better security.
    k8s-w2: 
    k8s-w2: Inserting generated public key within guest...
    k8s-w2: Removing insecure key from the guest if it's present...
    k8s-w2: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-w2: Machine booted and ready!
==> k8s-w2: Checking for guest additions in VM...
==> k8s-w2: Setting hostname...
==> k8s-w2: Configuring and enabling network interfaces...
==> k8s-w2: Running provisioner: shell...
    k8s-w2: Running: /tmp/vagrant-shell20250725-4641-9v5rvk.sh
    k8s-w2: >>>> Initial Config Start <<<<
    k8s-w2: [TASK 1] Setting Profile & Bashrc
    k8s-w2: [TASK 2] Disable AppArmor
    k8s-w2: [TASK 3] Disable and turn off SWAP
    k8s-w2: [TASK 4] Install Packages
    k8s-w2: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-w2: [TASK 6] Install Packages & Helm
    k8s-w2: >>>> Initial Config End <<<<
==> k8s-w2: Running provisioner: shell...
    k8s-w2: Running: /tmp/vagrant-shell20250725-4641-c0575o.sh
    k8s-w2: >>>> K8S Node config Start <<<<
    k8s-w2: [TASK 1] K8S Controlplane Join
    k8s-w2: >>>> K8S Node config End <<<<
```

### **2. VM ì ‘ì† ë° ê¸°ë³¸ ì •ë³´ í™•ì¸**

**(1) k8s-ctr ì ‘ì†**

```bash
vagrant ssh k8s-ctr
```

âœ…Â **ì¶œë ¥**

```bash
Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-53-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Fri Jul 25 08:33:03 PM KST 2025

  System load:           0.57
  Usage of /:            25.0% of 30.34GB
  Memory usage:          50%
  Swap usage:            0%
  Processes:             171
  Users logged in:       0
  IPv4 address for eth0: 10.0.2.15
  IPv6 address for eth0: fd17:625c:f037:2:a00:27ff:fe6b:69c9

This system is built by the Bento project by Chef Software
More information can be found at https://github.com/chef/bento

Use of this system is acceptance of the OS vendor EULA and License Agreements.
(âˆ|HomeLab:N/A) root@k8s-ctr:~#
```

**(2) í˜¸ìŠ¤íŠ¸ë„¤ì„, IP ë§¤í•‘ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat /etc/hosts
```

âœ…Â **ì¶œë ¥**

```bash
127.0.0.1 localhost
127.0.1.1 vagrant

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
127.0.2.1 k8s-ctr k8s-ctr
192.168.10.100 k8s-ctr
```

**(3) sshpassë¥¼ í†µí•´ k8s-w1, k8s-w2ì— ì›ê²© ì ‘ì†í•˜ì—¬ í˜¸ìŠ¤íŠ¸ë„¤ì„ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w1 hostname
Warning: Permanently added 'k8s-w1' (ED25519) to the list of known hosts.
k8s-w1

(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w2 hostname
Warning: Permanently added 'k8s-w2' (ED25519) to the list of known hosts.
k8s-w2
```

### **3. kubeadm-config ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl describe cm -n kube-system kubeadm-config
```

âœ…Â **ì¶œë ¥**

```bash
Name:         kubeadm-config
Namespace:    kube-system
Labels:       <none>
Annotations:  <none>

Data
====
ClusterConfiguration:
----
apiServer: {}
apiVersion: kubeadm.k8s.io/v1beta4
caCertificateValidityPeriod: 87600h0m0s
certificateValidityPeriod: 8760h0m0s
certificatesDir: /etc/kubernetes/pki
clusterName: kubernetes
controllerManager: {}
dns: {}
encryptionAlgorithm: RSA-2048
etcd:
  local:
    dataDir: /var/lib/etcd
imageRepository: registry.k8s.io
kind: ClusterConfiguration
kubernetesVersion: v1.33.2
networking:
  dnsDomain: cluster.local
  podSubnet: 10.244.0.0/16
  serviceSubnet: 10.96.0.0/16
proxy:
  disabled: true
scheduler: {}

BinaryData
====

Events:  <none>
```

- ë„¤íŠ¸ì›Œí¬ ì…‹íŒ… í™•ì¸
    - `dnsDomain: cluster.local`, `podSubnet: 10.244.0.0/16`, `serviceSubnet: 10.96.0.0/16`

### **4. kubelet-config ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl describe cm -n kube-system kubelet-config
```

âœ…Â **ì¶œë ¥**

```bash
Name:         kubelet-config
Namespace:    kube-system
Labels:       <none>
Annotations:  kubeadm.kubernetes.io/component-config.hash: sha256:0ff07274ab31cc8c0f9d989e90179a90b6e9b633c8f3671993f44185a0791127

Data
====
kubelet:
----
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    cacheTTL: 0s
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
cgroupDriver: systemd
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerRuntimeEndpoint: ""
cpuManagerReconcilePeriod: 0s
crashLoopBackOff: {}
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 0s
imageMaximumGCAge: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
logging:
  flushFrequency: 0
  options:
    json:
      infoBufferSize: "0"
    text:
      infoBufferSize: "0"
  verbosity: 0
memorySwap: {}
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
resolvConf: /run/systemd/resolve/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 0s
shutdownGracePeriod: 0s
shutdownGracePeriodCriticalPods: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s

BinaryData
====

Events:  <none>
```

### **5. ë…¸ë“œ ìƒíƒœ ë° IP í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get node -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME      STATUS   ROLES           AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-ctr   Ready    control-plane   12m     v1.33.2   192.168.10.100   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w1    Ready    <none>          9m38s   v1.33.2   192.168.10.101   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w2    Ready    <none>          7m40s   v1.33.2   192.168.10.102   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
```

### **6. ë…¸ë“œë³„ kubeadm-flags.env ì •ë³´ í™•ì¸**

k8s-ctr: `192.168.10.100`, k8s-w1: `192.168.10.101`, k8s-w2: `192.168.10.102`

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat /var/lib/kubelet/kubeadm-flags.env
```

âœ…Â **ì¶œë ¥**

```bash
KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=192.168.10.100 --pod-infra-container-image=registry.k8s.io/pause:3.10"
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w2 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i cat /var/lib/kubelet/kubeadm-flags.env ; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node : k8s-w1 <<
KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=192.168.10.101 --pod-infra-container-image=registry.k8s.io/pause:3.10"

>> node : k8s-w2 <<
KUBELET_KUBEADM_ARGS="--container-runtime-endpoint=unix:///run/containerd/containerd.sock --node-ip=192.168.10.102 --pod-infra-container-image=registry.k8s.io/pause:3.10"
```

### **7. Pod CIDR í™•ì¸**

**(1) kubecontrollerê°€ í• ë‹¹í•œ Pod CIDR í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.podCIDR}{"\n"}{end}'
```

âœ…Â **ì¶œë ¥**

```bash
k8s-ctr	10.244.0.0/24
k8s-w1	10.244.1.0/24
k8s-w2	10.244.2.0/24
```

**(2) Ciliumì´ ê´€ë¦¬í•˜ëŠ” Pod CIDR í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumnode -o json | grep podCIDRs -A2
```

âœ…Â **ì¶œë ¥**

```bash
                    "podCIDRs": [
                        "172.20.0.0/24"
                    ],
--
                    "podCIDRs": [
                        "172.20.1.0/24"
                    ],
--
                    "podCIDRs": [
                        "172.20.2.0/24"
                    ],
```

### **8. Cilium ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium status
```

âœ…Â **ì¶œë ¥**

```bash
    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK
 \__/Â¯Â¯\__/    Operator:           OK
 /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK
 \__/Â¯Â¯\__/    Hubble Relay:       disabled
    \__/       ClusterMesh:        disabled

DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3
DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3
Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1
Containers:            cilium                   Running: 3
                       cilium-envoy             Running: 3
                       cilium-operator          Running: 1
                       clustermesh-apiserver    
                       hubble-relay             
Cluster Pods:          2/2 managed by Cilium
Helm chart version:    1.17.6
Image versions         cilium             quay.io/cilium/cilium:v1.17.6@sha256:544de3d4fed7acba72758413812780a4972d47c39035f2a06d6145d8644a3353: 3
                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.33.4-1752151664-7c2edb0b44cf95f326d628b837fcdd845102ba68@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3
                       cilium-operator    quay.io/cilium/operator-generic:v1.17.6@sha256:91ac3bf7be7bed30e90218f219d4f3062a63377689ee7246062fa0cc3839d096: 1
```

- Hubble Relay: `disabled`

### **9. Cilium ì„¸ë¶€ ì„¤ì •ê°’ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium config view
```

âœ…Â **ì¶œë ¥**

```bash
agent-not-ready-taint-key                         node.cilium.io/agent-not-ready
arping-refresh-period                             30s
auto-direct-node-routes                           true
bpf-distributed-lru                               false
bpf-events-drop-enabled                           true
bpf-events-policy-verdict-enabled                 true
bpf-events-trace-enabled                          true
bpf-lb-acceleration                               disabled
bpf-lb-algorithm-annotation                       false
bpf-lb-external-clusterip                         false
bpf-lb-map-max                                    65536
bpf-lb-mode-annotation                            false
bpf-lb-sock                                       false
bpf-lb-source-range-all-types                     false
bpf-map-dynamic-size-ratio                        0.0025
bpf-policy-map-max                                16384
bpf-root                                          /sys/fs/bpf
cgroup-root                                       /run/cilium/cgroupv2
cilium-endpoint-gc-interval                       5m0s
cluster-id                                        0
cluster-name                                      default
cluster-pool-ipv4-cidr                            172.20.0.0/16
cluster-pool-ipv4-mask-size                       24
clustermesh-enable-endpoint-sync                  false
clustermesh-enable-mcs-api                        false
cni-exclusive                                     true
cni-log-file                                       /var/run/cilium/cilium-cni.log
custom-cni-conf                                   false
datapath-mode                                     veth
debug                                             true
debug-verbose                                     
default-lb-service-ipam                           lbipam
direct-routing-skip-unreachable                   false
dnsproxy-enable-transparent-mode                  true
dnsproxy-socket-linger-timeout                    10
egress-gateway-reconciliation-trigger-interval    1s
enable-auto-protect-node-port-range               true
enable-bpf-clock-probe                            false
enable-bpf-masquerade                             true
enable-endpoint-health-checking                   false
enable-endpoint-lockdown-on-policy-overflow       false
enable-endpoint-routes                            true
enable-experimental-lb                            false
enable-health-check-loadbalancer-ip               false
enable-health-check-nodeport                      true
enable-health-checking                            false
enable-hubble                                     false
enable-internal-traffic-policy                      true
enable-ipv4                                       true
enable-ipv4-big-tcp                               false
enable-ipv4-masquerade                            true
enable-ipv6                                       false
enable-ipv6-big-tcp                               false
enable-ipv6-masquerade                            true
enable-k8s-networkpolicy                          true
enable-k8s-terminating-endpoint                   true
enable-l2-neigh-discovery                         true
enable-l7-proxy                                   true
enable-lb-ipam                                    true
enable-local-redirect-policy                      false
enable-masquerade-to-route-source                 false
enable-metrics                                    true
enable-node-selector-labels                       false
enable-non-default-deny-policies                  true
enable-policy                                     default
enable-policy-secrets-sync                        true
enable-runtime-device-detection                   true
enable-sctp                                       false
enable-source-ip-verification                      true
enable-svc-source-range-check                     true
enable-tcx                                        true
enable-vtep                                       false
enable-well-known-identities                      false
enable-xt-socket-fallback                         true
envoy-access-log-buffer-size                       4096
envoy-base-id                                     0
envoy-keep-cap-netbindservice                     false
external-envoy-proxy                              true
health-check-icmp-failure-threshold               3
http-retry-count                                  3
identity-allocation-mode                          crd
identity-gc-interval                              15m0s
identity-heartbeat-timeout                        30m0s
install-no-conntrack-iptables-rules               true
ipam                                              cluster-pool
ipam-cilium-node-update-rate                      15s
iptables-random-fully                             false
ipv4-native-routing-cidr                          172.20.0.0/16
k8s-require-ipv4-pod-cidr                         false
k8s-require-ipv6-pod-cidr                         false
kube-proxy-replacement                            true
kube-proxy-replacement-healthz-bind-address       
max-connected-clusters                            255
mesh-auth-enabled                                 true
mesh-auth-gc-interval                             5m0s
mesh-auth-queue-size                              1024
mesh-auth-rotated-identities-queue-size           1024
monitor-aggregation                               medium
monitor-aggregation-flags                          all
monitor-aggregation-interval                      5s
nat-map-stats-entries                             32
nat-map-stats-interval                            30s
node-port-bind-protection                         true
nodeport-addresses                                
nodes-gc-interval                                 5m0s
operator-api-serve-addr                           127.0.0.1:9234
operator-prometheus-serve-addr                    :9963
policy-cidr-match-mode                            
policy-secrets-namespace                          cilium-secrets
policy-secrets-only-from-secrets-namespace        true
preallocate-bpf-maps                              false
procfs                                            /host/proc
proxy-connect-timeout                             2
proxy-idle-timeout-seconds                        60
proxy-initial-fetch-timeout                       30
proxy-max-concurrent-retries                      128
proxy-max-connection-duration-seconds             0
proxy-max-requests-per-connection                 0
proxy-xff-num-trusted-hops-egress                  0
proxy-xff-num-trusted-hops-ingress                 0
remove-cilium-node-taints                         true
routing-mode                                      native
service-no-backend-response                       reject
set-cilium-is-up-condition                        true
set-cilium-node-taints                            true
synchronize-k8s-nodes                             true
tofqdns-dns-reject-response-code                  refused
tofqdns-enable-dns-compression                    true
tofqdns-endpoint-max-ip-per-hostname              1000
tofqdns-idle-connection-grace-period              0s
tofqdns-max-deferred-connection-deletes           10000
tofqdns-proxy-response-max-delay                  100ms
tunnel-protocol                                   vxlan
tunnel-source-port-range                          0-0
unmanaged-pod-watcher-interval                    15
vtep-cidr                                         
vtep-endpoint                                     
vtep-mac                                          
vtep-mask                                         
write-cni-conf-when-ready                         /host/etc/cni/net.d/05-cilium.conflist
```

- CNI ë™ì‘, BPF ì •ì±…, L7 Proxy, metrics, DNSProxy ë“± ë‹¤ì–‘í•œ í•­ëª©ì˜ í˜„ì¬ ì„¤ì • ìƒíƒœ í™•ì¸ ê°€ëŠ¥

### **10. Cilium Agent ë‚´ë¶€ ë™ì  ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system -c cilium-agent -it ds/cilium -- cilium-dbg config
```

âœ…Â **ì¶œë ¥**

```bash
##### Read-write configurations #####
ConntrackAccounting               : Disabled
ConntrackLocal                    : Disabled
Debug                             : Disabled
DebugLB                           : Disabled
DebugPolicy                       : Enabled
DropNotification                  : Enabled
MonitorAggregationLevel           : Medium
PolicyAccounting                  : Enabled
PolicyAuditMode                   : Disabled
PolicyTracing                     : Disabled
PolicyVerdictNotification         : Enabled
SourceIPVerification              : Enabled
TraceNotification                 : Enabled
PolicyEnforcement                 : default
```

### **11. Cilium Endpoint ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumendpoints -A
```

âœ…Â **ì¶œë ¥**

```bash
NAMESPACE     NAME                       SECURITY IDENTITY   ENDPOINT STATE   IPV4          IPV6
kube-system   coredns-674b8bbfcf-8lcmh   3235                ready            172.20.0.21   
kube-system   coredns-674b8bbfcf-gjs6z   3235                ready            172.20.0.11
```

- ê°ê°ì˜ IPv4: `172.20.0.21`, `172.20.0.11`

### **12. Ciliumê³¼ Hubbleì˜ ëª¨ë‹ˆí„°ë§ ê°•ì ê³¼ ê°œë°œ ë°°ê²½**

- Ciliumì€ ë‹¤ë¥¸ CNIì— ë¹„í•´ **ëª¨ë‹ˆí„°ë§ ì§€ì›ì´ ë›°ì–´ë‚¨**
- eBPF ê¸°ë°˜ì´ë¼ ê¸°ì¡´ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œê³¼ì˜ í˜¸í™˜ì´ ì–´ë µê³ , ë³„ë„ì˜ ë¡œê¹…Â·ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ êµ¬ì¶•ì´ ì‰½ì§€ ì•ŠìŒ
- ì´ëŸ¬í•œ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ Ciliumì€ ì´ˆê¸°ë‹¨ê³„ë¶€í„° Hubbleì„ í•¨ê»˜ ê°œë°œí•˜ì—¬ ëª¨ë‹ˆí„°ë§ì„ ì†ì‰½ê²Œ ì§€ì›í•˜ë„ë¡ í•¨

### **13. Hubble ì„¤ì¹˜ ì „ í™•ì¸**

**(1) Hubble í™œì„±í™” ì—¬ë¶€ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium config view | grep -i hubble
```

âœ…Â **ì¶œë ¥**

```bash
enable-hubble                                     false
```

**(2) Hubble ê´€ë ¨ Secret ì¡´ì¬ ì—¬ë¶€ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get secret -n kube-system | grep -iE 'cilium-ca|hubble'
```

- ì•„ë¬´ê²ƒë„ ì¶œë ¥ë˜ì§€ ì•ŠìŒ
- í˜„ì¬ Hubble ë¯¸ì„¤ì¹˜ ìƒíƒœì´ë©°, ì„¤ì¹˜ ì‹œ Secretì´ ìƒì„±ë  ì˜ˆì •

**(3) í˜„ì¬ ì—´ë¦° TCP í¬íŠ¸ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ss -tnlp | grep -iE 'cilium|hubble' | tee before.txt
```

âœ…Â **ì¶œë ¥**

```bash
LISTEN 0      4096        127.0.0.1:46395      0.0.0.0:*    users:(("cilium-agent",pid=5229,fd=42))                
LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=4772,fd=9))              
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=25))                
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=24))                
LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=5229,fd=6))                 
LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=4772,fd=6))              
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=27))                
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=26))                
LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=5229,fd=61))                
LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=4772,fd=7)) 
```

- Hubble í™œì„±í™” ì „ í¬íŠ¸ ìƒíƒœë¥¼ ê¸°ë¡í•´ë‘ê³  ì´í›„ ë¹„êµí•˜ê¸° ìœ„í•¨

---

## **ğŸ”­ Hubble ì„¤ì¹˜ ë° ì„¤ì • ê³¼ì •**

### **1. Hubble ì„¤ì¹˜ (Helm ì—…ê·¸ë ˆì´ë“œ)**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
--set hubble.enabled=true \
--set hubble.relay.enabled=true \
--set hubble.ui.enabled=true \
--set hubble.ui.service.type=NodePort \
--set hubble.ui.service.nodePort=31234 \
--set hubble.export.static.enabled=true \
--set hubble.export.static.filePath=/var/run/cilium/hubble/events.log \
--set prometheus.enabled=true \
--set operator.prometheus.enabled=true \
--set hubble.metrics.enableOpenMetrics=true \
--set hubble.metrics.enabled="{dns,drop,tcp,flow,port-distribution,icmp,httpV2:exemplars=true;labelsContext=source_ip\,source_namespace\,source_workload\,destination_ip\,destination_namespace\,destination_workload\,traffic_direction}"
```

âœ…Â **ì¶œë ¥**

```bash
Release "cilium" has been upgraded. Happy Helming!
NAME: cilium
LAST DEPLOYED: Fri Jul 25 21:03:35 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 2
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is 1.17.6.

For any further help, visit https://docs.cilium.io/en/v1.17/gettinghelp
```

- UI ì„œë¹„ìŠ¤ëŠ” `NodePort 31234`ë¡œ ì§€ì •
- Prometheus ë° OpenMetrics í™œì„±í™”

### **2. ì„¤ì¹˜ í›„ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium status
```

âœ…Â **ì¶œë ¥**

```bash
    /Â¯Â¯\
 /Â¯Â¯\__/Â¯Â¯\    Cilium:             OK
 \__/Â¯Â¯\__/    Operator:           OK
 /Â¯Â¯\__/Â¯Â¯\    Envoy DaemonSet:    OK
 \__/Â¯Â¯\__/    Hubble Relay:       OK
    \__/       ClusterMesh:        disabled

DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3
DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3
Deployment             cilium-operator          Desired: 1, Ready: 1/1, Available: 1/1
Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1
Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1
Containers:            cilium                   Running: 3
                       cilium-envoy             Running: 3
                       cilium-operator          Running: 1
                       clustermesh-apiserver    
                       hubble-relay             Running: 1
                       hubble-ui                Running: 1
Cluster Pods:          4/4 managed by Cilium
Helm chart version:    1.17.6
Image versions         cilium             quay.io/cilium/cilium:v1.17.6@sha256:544de3d4fed7acba72758413812780a4972d47c39035f2a06d6145d8644a3353: 3
                       cilium-envoy       quay.io/cilium/cilium-envoy:v1.33.4-1752151664-7c2edb0b44cf95f326d628b837fcdd845102ba68@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3
                       cilium-operator    quay.io/cilium/operator-generic:v1.17.6@sha256:91ac3bf7be7bed30e90218f219d4f3062a63377689ee7246062fa0cc3839d096: 1
                       hubble-relay       quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60: 1
                       hubble-ui          quay.io/cilium/hubble-ui-backend:v0.13.2@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1
                       hubble-ui          quay.io/cilium/hubble-ui:v0.13.2@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1
```

- Hubble Relay: OKë¡œ ë³€ê²½
- hubble-relay, hubble-ui íŒŒë“œê°€ ì¶”ê°€ë¡œ ë°°í¬ë¨

### **3. Config ë³€ê²½ ì‚¬í•­ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium config view | grep -i hubble
```

âœ…Â **ì¶œë ¥**

```bash
enable-hubble                                     true
enable-hubble-open-metrics                        true
hubble-disable-tls                                false
hubble-export-allowlist                           
hubble-export-denylist                            
hubble-export-fieldmask                           
hubble-export-file-max-backups                    5
hubble-export-file-max-size-mb                    10
hubble-export-file-path                           /var/run/cilium/hubble/events.log
hubble-listen-address                             :4244
hubble-metrics                                    dns drop tcp flow port-distribution icmp httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction
hubble-metrics-server                             :9965
hubble-metrics-server-enable-tls                  false
hubble-socket-path                                /var/run/cilium/hubble.sock
hubble-tls-cert-file                              /var/lib/cilium/tls/hubble/server.crt
hubble-tls-client-ca-files                        /var/lib/cilium/tls/hubble/client-ca.crt
hubble-tls-key-file                               /var/lib/cilium/tls/hubble/server.key
```

- `enable-hubble: true`
- `hubble-metrics-server: :9965`
- `hubble-listen-address: :4244`
- `hubble-export-file-path: /var/run/cilium/hubble/events.log`
- TLS ê´€ë ¨ cert/key ê²½ë¡œê°€ ì¶”ê°€ë¨

### **4. Secret ìƒì„± í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get secret -n kube-system | grep -iE 'cilium-ca|hubble'
```

âœ…Â **ì¶œë ¥**

```bash
cilium-ca                      Opaque                          2      3m43s
hubble-relay-client-certs      kubernetes.io/tls               3      3m43s
hubble-server-certs            kubernetes.io/tls               3      3m43s
```

- ì„¤ì¹˜ ì „ì—ëŠ” ì¡´ì¬í•˜ì§€ ì•Šì•˜ë˜ Secretë“¤ì´ ìƒˆë¡œ ì¶”ê°€ë¨

### **5. í¬íŠ¸ ë³€ê²½ ì‚¬í•­ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ss -tnlp | grep -iE 'cilium|hubble' | tee after.txt
```

âœ…Â **ì¶œë ¥**

```bash
LISTEN 0      4096        127.0.0.1:46395      0.0.0.0:*    users:(("cilium-agent",pid=7666,fd=53))                
LISTEN 0      4096        127.0.0.1:9234       0.0.0.0:*    users:(("cilium-operator",pid=4772,fd=9))              
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=25))                
LISTEN 0      4096          0.0.0.0:9964       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=24))                
LISTEN 0      4096        127.0.0.1:9890       0.0.0.0:*    users:(("cilium-agent",pid=7666,fd=6))                 
LISTEN 0      4096        127.0.0.1:9891       0.0.0.0:*    users:(("cilium-operator",pid=4772,fd=6))              
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=27))                
LISTEN 0      4096        127.0.0.1:9878       0.0.0.0:*    users:(("cilium-envoy",pid=4828,fd=26))                
LISTEN 0      4096        127.0.0.1:9879       0.0.0.0:*    users:(("cilium-agent",pid=7666,fd=58))                
LISTEN 0      4096                *:4244             *:*    users:(("cilium-agent",pid=7666,fd=49))                
LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=7666,fd=31))                
LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=4772,fd=7))              
LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=7666,fd=7)) 
```

- ì„¤ì¹˜ ì „ ëŒ€ë¹„ ì¶”ê°€ëœ í¬íŠ¸: **4244**, **9965**, **9962**
- 4244: ê° ë…¸ë“œ cilium-agentì—ì„œ Hubble í”„ë¡œì„¸ìŠ¤ê°€ ë¦¬ìŠ¤ë‹
- 9965: Hubble Metrics ì„œë²„
- 9962: ì¶”ê°€ ë‚´ë¶€ í¬íŠ¸

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# vi -d before.txt after.txt
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/848e3fb7-c418-4aa5-a38b-07c260781935/image.png)

### **6. ë…¸ë“œë³„ 4244 í¬íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w2 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i sudo ss -tnlp |grep 4244 ; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node : k8s-w1 <<
LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=6068,fd=52))                

>> node : k8s-w2 <<
LISTEN 0      4096               *:4244             *:*    users:(("cilium-agent",pid=5995,fd=52))
```

- ê° ë…¸ë“œ(`k8s-w1`, `k8s-w2`)ì—ì„œ 4244 í¬íŠ¸ê°€ ì—´ë ¤ ìˆìŒ
- ì´ëŠ” Hubbleì´ ê° ë…¸ë“œì˜ cilium-agentì— ì¶”ê°€ëœ í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•œë‹¤ëŠ” ì˜ë¯¸

### **7. Hubble Relay ë™ì‘ í™•ì¸**

**(1) hubble-relay íŒŒë“œ ìƒíƒœ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get pod -n kube-system -l k8s-app=hubble-relay
```

âœ…Â **ì¶œë ¥**

```bash
NAME                           READY   STATUS    RESTARTS   AGE
hubble-relay-5dcd46f5c-s4wqq   1/1     Running   0          9m3s
```

- `hubble-relay` íŒŒë“œê°€ ì •ìƒ ë°°í¬ë˜ì–´ Running ìƒíƒœ
- 4245/TCP í¬íŠ¸ë¡œ ë°ì´í„° ìˆ˜ì§‘

**(2) hubble-relay íŒŒë“œ ìƒì„¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe pod -n kube-system -l k8s-app=hubble-relay
```

âœ…Â **ì¶œë ¥**

```bash
Name:             hubble-relay-5dcd46f5c-s4wqq
Namespace:        kube-system
Priority:         0
Service Account:  hubble-relay
Node:             k8s-w2/192.168.10.102
Start Time:       Fri, 25 Jul 2025 21:03:38 +0900
Labels:           app.kubernetes.io/name=hubble-relay
                  app.kubernetes.io/part-of=cilium
                  k8s-app=hubble-relay
                  pod-template-hash=5dcd46f5c
Annotations:      <none>
Status:           Running
IP:               172.20.2.58
IPs:
  IP:           172.20.2.58
Controlled By:  ReplicaSet/hubble-relay-5dcd46f5c
Containers:
  hubble-relay:
    Container ID:  containerd://d385feef54ef21ba44f32d93715f5c95124d84cd878a410bbcd11be2cc9bf62d
    Image:         quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60
    Image ID:      quay.io/cilium/hubble-relay@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60
    Port:          4245/TCP
    Host Port:     0/TCP
    Command:
      hubble-relay
    Args:
      serve
      --debug
    State:          Running
      Started:      Fri, 25 Jul 2025 21:04:03 +0900
    Ready:          True
    Restart Count:  0
    Liveness:       grpc <pod>:4222  delay=10s timeout=10s period=10s #success=1 #failure=12
    Readiness:      grpc <pod>:4222  delay=0s timeout=3s period=10s #success=1 #failure=3
    Startup:        grpc <pod>:4222  delay=10s timeout=1s period=3s #success=1 #failure=20
    Environment:    <none>
    Mounts:
      /etc/hubble-relay from config (ro)
      /var/lib/hubble-relay/tls from tls (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      hubble-relay-config
    Optional:  false
  tls:
    Type:        Projected (a volume that contains injected data from multiple sources)
    SecretName:  hubble-relay-client-certs
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  kubernetes.io/os=linux
Tolerations:     node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason       Age    From               Message
  ----     ------       ----   ----               -------
  Normal   Scheduled    9m40s  default-scheduler  Successfully assigned kube-system/hubble-relay-5dcd46f5c-s4wqq to k8s-w2
  Warning  FailedMount  9m39s  kubelet            MountVolume.SetUp failed for volume "config" : failed to sync configmap cache: timed out waiting for the condition
  Normal   Pulling      9m24s  kubelet            Pulling image "quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60"
  Normal   Pulled       9m15s  kubelet            Successfully pulled image "quay.io/cilium/hubble-relay:v1.17.6@sha256:7d17ec10b3d37341c18ca56165b2f29a715cb8ee81311fd07088d8bf68c01e60" in 8.579s (8.579s including waiting). Image size: 29149253 bytes.
  Normal   Created      9m15s  kubelet            Created container: hubble-relay
  Normal   Started      9m15s  kubelet            Started container hubble-relay
```

**(3) ì„œë¹„ìŠ¤ì™€ ì—”ë“œí¬ì¸íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc get svc,ep -n kube-system hubble-relay
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE
service/hubble-relay   ClusterIP   10.96.50.64   <none>        80/TCP    11m

NAME                     ENDPOINTS          AGE
endpoints/hubble-relay   172.20.2.58:4245   11m
```

- `service/hubble-relay` â†’ `endpoints/hubble-relay` ë¡œ ì—°ê²°
- ClusterIP `10.96.50.64`ì˜ 80/TCPë¡œ ì ‘ê·¼ ì‹œ ë‚´ë¶€ì ìœ¼ë¡œ 4245 í¬íŠ¸ë¡œ ì „ë‹¬

**(4) Hubble Relayì™€ Hubble Peer ì—°ë™**

- `hubble-relay`ëŠ” `hubble-peer` ì„œë¹„ìŠ¤(ClusterIP:443)ë¥¼ í†µí•´ ê° ë…¸ë“œì˜ `:4244` í¬íŠ¸ì—ì„œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
- ê° ë…¸ë“œì˜ cilium-agent ë‚´ í—ˆë¸” í”„ë¡œì„¸ìŠ¤ë¥¼ í†µí•´ íë¦„ ë°ì´í„°(Flow)ë¥¼ ê°€ì ¸ì˜´
- ë…¸ë“œ ìˆ˜ê°€ ì¦ê°€í•˜ë©´ `hubble-peer`ì˜ ì—”ë“œí¬ì¸íŠ¸ê°€ ìë™ìœ¼ë¡œ ëŠ˜ì–´ë‚˜ë©°, ìˆ˜ì§‘ ë²”ìœ„ê°€ í™•ëŒ€ë¨

### **8. ConfigMap ëª©ë¡ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cm -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                                   DATA   AGE
cilium-config                                           158    51m
cilium-envoy-config                                     1      51m
coredns                                                1      51m
extension-apiserver-authentication                     6      51m
hubble-relay-config                                     1      13m
hubble-ui-nginx                                        1      13m
kube-apiserver-legacy-service-account-token-tracking   1      51m
kube-root-ca.crt                                       1      51m
kubeadm-config                                          1      51m
kubelet-config                                          1      51m
```

- `hubble-relay-config`, `hubble-ui-nginx` ë“± Hubble ê´€ë ¨ ConfigMap ìƒì„± í™•ì¸

### **9. Hubble Relay ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl describe cm -n kube-system hubble-relay-config
```

âœ…Â **ì¶œë ¥**

```bash
Name:         hubble-relay-config
Namespace:    kube-system
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: cilium
              meta.helm.sh/release-namespace: kube-system

Data
====
config.yaml:
----
cluster-name: default
peer-service: "hubble-peer.kube-system.svc.cluster.local.:443"
listen-address: :4245
gops: true
gops-port: "9893"
retry-timeout: 
sort-buffer-len-max: 
sort-buffer-drain-timeout: 
tls-hubble-client-cert-file: /var/lib/hubble-relay/tls/client.crt
tls-hubble-client-key-file: /var/lib/hubble-relay/tls/client.key
tls-hubble-server-ca-files: /var/lib/hubble-relay/tls/hubble-server-ca.crt

disable-server-tls: true

BinaryData
====

Events:  <none>
```

- `peer-service`ë¡œ `hubble-peer.kube-system.svc.cluster.local.:443` ì§€ì •
- `listen-address: :4245` ì„¤ì • â†’ Hubble Relayê°€ 4245 í¬íŠ¸ì—ì„œ ë™ì‘
- TLS ì¸ì¦ì„œ ê²½ë¡œ(`/var/lib/hubble-relay/tls/`) ë“± ì„¸ë¶€ ì„¤ì • í™•ì¸ ê°€ëŠ¥

### **10. Hubble Peer ì„œë¹„ìŠ¤ ë° ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc,ep -n kube-system hubble-peer
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                  TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/hubble-peer   ClusterIP   10.96.99.7   <none>        443/TCP   15m

NAME                    ENDPOINTS                                                     AGE
endpoints/hubble-peer   192.168.10.100:4244,192.168.10.101:4244,192.168.10.102:4244   15m
```

- `hubble-peer` ì„œë¹„ìŠ¤ê°€ ClusterIP `10.96.99.7`ë¡œ ìƒì„±ë¨
- ì—”ë“œí¬ì¸íŠ¸ëŠ” ê° ë…¸ë“œì˜ `4244` í¬íŠ¸ë¥¼ ì‚¬ìš©
    - `192.168.10.100:4244`, `192.168.10.101:4244`, `192.168.10.102:4244`
- ê° cilium-agentê°€ í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‚¬ìš©í•˜ì—¬ 4244 í¬íŠ¸ë¥¼ ì§ì ‘ ë…¸ì¶œí•¨

### **11. Hubble UI íŒŒë“œ êµ¬ì„± í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe pod -n kube-system -l k8s-app=hubble-ui
```

âœ…Â **ì¶œë ¥**

```bash
Name:             hubble-ui-76d4965bb6-p4blh
Namespace:        kube-system
Priority:         0
Service Account:  hubble-ui
Node:             k8s-w1/192.168.10.101
Start Time:       Fri, 25 Jul 2025 21:03:38 +0900
Labels:           app.kubernetes.io/name=hubble-ui
                  app.kubernetes.io/part-of=cilium
                  k8s-app=hubble-ui
                  pod-template-hash=76d4965bb6
Annotations:      <none>
Status:           Running
IP:               172.20.1.79
IPs:
  IP:           172.20.1.79
Controlled By:  ReplicaSet/hubble-ui-76d4965bb6
Containers:
  frontend:
    Container ID:   containerd://e4f17c9e17383bd95bb54c77040bad5c4e0bbe619c99306f72edf3c29433bbd9
    Image:          quay.io/cilium/hubble-ui:v0.13.2@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392
    Image ID:       quay.io/cilium/hubble-ui@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392
    Port:           8081/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 25 Jul 2025 21:04:02 +0900
    Ready:          True
    Restart Count:  0
    Liveness:       http-get http://:8081/healthz delay=0s timeout=1s period=10s #success=1 #failure=3
    Readiness:      http-get http://:8081/ delay=0s timeout=1s period=10s #success=1 #failure=3
    Environment:    <none>
    Mounts:
      /etc/nginx/conf.d/default.conf from hubble-ui-nginx-conf (rw,path="nginx.conf")
      /tmp from tmp-dir (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-62g8t (ro)
  backend:
    Container ID:   containerd://339fc85862a2589dfaced99bcc55e1abe29d23d59dd8e35e64566fca9f5cf65c
    Image:          quay.io/cilium/hubble-ui-backend:v0.13.2@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15
    Image ID:       quay.io/cilium/hubble-ui-backend@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15
    Port:           8090/TCP
    Host Port:      0/TCP
    State:          Running
      Started:      Fri, 25 Jul 2025 21:04:10 +0900
    Ready:          True
    Restart Count:  0
    Environment:
      EVENTS_SERVER_PORT:  8090
      FLOWS_API_ADDR:      hubble-relay:80
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-62g8t (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True 
  Initialized                 True 
  Ready                       True 
  ContainersReady             True 
  PodScheduled                True 
Volumes:
  hubble-ui-nginx-conf:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      hubble-ui-nginx
    Optional:  false
  tmp-dir:
    Type:       EmptyDir (a temporary directory that shares a pod's lifetime)
    Medium:     
    SizeLimit:  <unset>
  kube-api-access-62g8t:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    Optional:                false
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              kubernetes.io/os=linux
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  20m   default-scheduler  Successfully assigned kube-system/hubble-ui-76d4965bb6-p4blh to k8s-w1
  Normal  Pulling    19m   kubelet            Pulling image "quay.io/cilium/hubble-ui:v0.13.2@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392"
  Normal  Pulled     19m   kubelet            Successfully pulled image "quay.io/cilium/hubble-ui:v0.13.2@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392" in 7.822s (7.822s including waiting). Image size: 11129482 bytes.
  Normal  Created    19m   kubelet            Created container: frontend
  Normal  Started    19m   kubelet            Started container frontend
  Normal  Pulling    19m   kubelet            Pulling image "quay.io/cilium/hubble-ui-backend:v0.13.2@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15"
  Normal  Pulled     19m   kubelet            Successfully pulled image "quay.io/cilium/hubble-ui-backend:v0.13.2@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15" in 7.109s (7.109s including waiting). Image size: 20317203 bytes.
  Normal  Created    19m   kubelet            Created container: backend
  Normal  Started    19m   kubelet            Started container backend
```

- `hubble-ui` íŒŒë“œì—ëŠ” frontend(8081/TCP)ì™€ backend(8090/TCP) ë‘ ì»¨í…Œì´ë„ˆ ì¡´ì¬
- frontend(Nginx)ê°€ backendë¡œ í”„ë¡ì‹œí•˜ì—¬ Hubble Relayì—ì„œ ë°›ì€ Flow ë°ì´í„°ë¥¼ UIë¡œ ì œê³µ
- backend ì»¨í…Œì´ë„ˆëŠ” `FLOWS_API_ADDR=hubble-relay:80` ì„¤ì •ìœ¼ë¡œ Hubble Relayì™€ ì—°ë™

### **12. Hubble UI Nginx ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cm -n kube-system hubble-ui-nginx
```

âœ…Â **ì¶œë ¥**

```bash
Name:         hubble-ui-nginx
Namespace:    kube-system
Labels:       app.kubernetes.io/managed-by=Helm
Annotations:  meta.helm.sh/release-name: cilium
              meta.helm.sh/release-namespace: kube-system

Data
====
nginx.conf:
----
server {
    listen       8081;
    listen       [::]:8081;
    server_name  localhost;
    root /app;
    index index.html;
    client_max_body_size 1G;

    location / {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        location /api {
            proxy_http_version 1.1;
            proxy_pass_request_headers on;
            proxy_pass http://127.0.0.1:8090;
        }
        location / {
            # double `/index.html` is required here 
            try_files $uri $uri/ /index.html /index.html;
        }

        # Liveness probe
        location /healthz {
            access_log off;
            add_header Content-Type text/plain;
            return 200 'ok';
        }
    }
}

BinaryData
====

Events:  <none>
```

- Nginxê°€ `8081` í¬íŠ¸ì—ì„œ ëŒ€ê¸°
- `/api` ìš”ì²­ì€ backend(`127.0.0.1:8090`)ë¡œ í”„ë¡ì‹œ, ë‚˜ë¨¸ì§€ëŠ” `/index.html`ë¡œ ì²˜ë¦¬
- `/healthz` ì—”ë“œí¬ì¸íŠ¸ë¡œ í—¬ìŠ¤ì²´í¬ ì§€ì›

### **13. Hubble UI ì„œë¹„ìŠ¤ì™€ ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc,ep -n kube-system hubble-ui
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
service/hubble-ui   NodePort   10.96.93.209   <none>        80:31234/TCP   22m

NAME                  ENDPOINTS          AGE
endpoints/hubble-ui   172.20.1.79:8081   22m
```

- `hubble-ui` ì„œë¹„ìŠ¤ê°€ NodePort **31234**ë¡œ ìƒì„±ë¨
- ClusterIP `10.96.93.209:80` â†’ íŒŒë“œ `172.20.1.79:8081`ë¡œ ë§¤í•‘
- ì™¸ë¶€ì—ì„œ `<ì»¨íŠ¸ë¡¤í”Œë ˆì¸IP>:31234` ì ‘ì† ì‹œ Hubble UIì— ì ‘ê·¼ ê°€ëŠ¥

### **14. Hubble UI ì›¹ ì ‘ì†**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# NODEIP=$(ip -4 addr show eth1 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
echo -e "http://$NODEIP:31234"
```

âœ…Â **ì¶œë ¥**

```bash
http://192.168.10.100:31234
```
![](https://velog.velcdn.com/images/tlsalswls123/post/56faf0b1-084f-4029-a727-e58641895352/image.png)

**`kube-system` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ë™í•˜ë©´ Hubble Relayë¥¼ í†µí•´ ìˆ˜ì§‘ëœ Flow ì •ë³´ ìƒì„¸ í™•ì¸ ê°€ëŠ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/b538166f-fbf1-4f87-ad37-a326611279e0/image.png)

**Flowë¥¼ í´ë¦­í•˜ë©´ í†µì‹  ìƒì„¸ ì •ë³´(ì†ŒìŠ¤, ëª©ì ì§€, í”„ë¡œí† ì½œ ë“±) í™•ì¸ ê°€ëŠ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/6bc1a076-7716-4f25-8a50-55dd281c5ed4/image.png)

---

## **ğŸ’» Hubble Client ì„¤ì¹˜**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# HUBBLE_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/hubble/master/stable.txt)
HUBBLE_ARCH=amd64
if [ "$(uname -m)" = "aarch64" ]; then HUBBLE_ARCH=arm64; fi
curl -L --fail --remote-name-all https://github.com/cilium/hubble/releases/download/$HUBBLE_VERSION/hubble-linux-${HUBBLE_ARCH}.tar.gz{,.sha256sum}
sudo tar xzvfC hubble-linux-${HUBBLE_ARCH}.tar.gz /usr/local/bin
which hubble
```

âœ…Â **ì¶œë ¥**

```bash
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100 24.6M  100 24.6M    0     0  9606k      0  0:00:02  0:00:02 --:--:-- 12.6M
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
100    92  100    92    0     0    187      0 --:--:-- --:--:-- --:--:--   187

hubble
/usr/local/bin/hubble
```

Hubble Clientë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ **ì ‘ì†í•  Hubble Relayì˜ ì£¼ì†Œ**ë¥¼ ëª…ì‹œí•´ì•¼ í•¨

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble status
failed getting status: rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp 127.0.0.1:4245: connect: connection refused"
```

---

## **ğŸ”‘ Hubble API ì ‘ê·¼ ê²€ì¦**

### **1. Hubble API í¬íŠ¸í¬ì›Œë”© ì‹¤í–‰**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium hubble port-forward&
[1] 8917
(âˆ|HomeLab:N/A) root@k8s-ctr:~# â„¹ï¸  Hubble Relay is available at 127.0.0.1:4245
```

- ë°±ê·¸ë¼ìš´ë“œì—ì„œ Hubble Relay(í¬íŠ¸ 4245)ë¡œ í¬íŠ¸í¬ì›Œë”©ì„ ì‹œì‘

### **2. í¬íŠ¸í¬ì›Œë”©ëœ Hubble API í¬íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ss -tnlp | grep 4245
```

âœ…Â **ì¶œë ¥**

```bash
LISTEN 0      4096        127.0.0.1:4245       0.0.0.0:*    users:(("cilium",pid=8917,fd=7))                       
LISTEN 0      4096            [::1]:4245          [::]:*    users:(("cilium",pid=8917,fd=8))
```

- `127.0.0.1:4245`ì™€ `[::1]:4245` í¬íŠ¸ê°€ `cilium` í”„ë¡œì„¸ìŠ¤ë¡œ ì—´ë¦¼

### **3. Hubble ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble status
```

âœ…Â **ì¶œë ¥**

```bash
Healthcheck (via localhost:4245): Ok
Current/Max Flows: 12,285/12,285 (100.00%)
Flows/s: 35.77
Connected Nodes: 3/3
```

### **4. Hubble CLI ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble config view 
```

âœ…Â **ì¶œë ¥**

```bash
basic-auth-password: ""
basic-auth-username: ""
config: /root/.config/hubble/config.yaml
debug: false
kube-context: ""
kube-namespace: kube-system
kubeconfig: ""
port-forward: false
port-forward-port: "4245"
request-timeout: 12s
server: localhost:4245
timeout: 5s
tls: false
tls-allow-insecure: false
tls-ca-cert-files: []
tls-client-cert-file: ""
tls-client-key-file: ""
tls-server-name: ""
```

### **5. Hubble CLI ì„œë²„ ì˜µì…˜ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble help status | grep 'server string'
```

âœ…Â **ì¶œë ¥**

```bash
      --server string                 Address of a Hubble server. Ignored when --input-file or --port-forward is provided. (default "localhost:4245")
```

- `--server string` ì˜µì…˜ìœ¼ë¡œ Hubble ì„œë²„ ì£¼ì†Œ ì§€ì • ê°€ëŠ¥

### **6. CiliumEndpoints ì •ë³´ ì¡°íšŒ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumendpoints.cilium.io -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4          IPV6
coredns-674b8bbfcf-8lcmh       3235                ready            172.20.0.21   
coredns-674b8bbfcf-gjs6z       3235                ready            172.20.0.11   
hubble-relay-5dcd46f5c-s4wqq   40607               ready            172.20.2.58   
hubble-ui-76d4965bb6-p4blh     14998               ready            172.20.1.79
```

### **7. Hubble Observeë¡œ ì‹¤ì‹œê°„ íŠ¸ë˜í”½ ê´€ì°°**

`hubble-relay`, `hubble-ui`, `coredns` ë“±ê³¼ì˜ TCP/UDP íë¦„ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ê¸°ë¡

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe
```

âœ…Â **ì¶œë ¥**

```bash
Jul 26 01:38:52.399: kube-system/hubble-relay-5dcd46f5c-s4wqq:60070 (ID:40607) -> 192.168.10.102:4244 (host) to-stack FORWARDED (TCP Flags: ACK)
Jul 26 01:38:52.613: kube-system/hubble-relay-5dcd46f5c-s4wqq:53066 (ID:40607) <- 192.168.10.100:4244 (kube-apiserver) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) -> kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-endpoint FORWARDED (TCP Flags: SYN)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) <- kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-stack FORWARDED (TCP Flags: SYN, ACK)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) -> kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-endpoint FORWARDED (TCP Flags: ACK)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) -> kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:53.990: 10.0.2.15:41170 (host) <- kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-stack FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:53.991: 10.0.2.15:41170 (host) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:53.991: 10.0.2.15:41170 (host) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:53.991: 10.0.2.15:41170 (host) -> kube-system/hubble-relay-5dcd46f5c-s4wqq:4222 (ID:40607) to-endpoint FORWARDED (TCP Flags: ACK, RST)
Jul 26 01:38:54.690: 10.0.2.15:44558 (host) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:54.690: 10.0.2.15:44558 (host) -> kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:54.690: 10.0.2.15:44558 (host) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:54.690: 10.0.2.15:44558 (host) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:54.691: 10.0.2.15:44558 (host) <- kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-stack FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:54.691: 10.0.2.15:44558 (host) <- kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-stack FORWARDED (TCP Flags: ACK, FIN)
Jul 26 01:38:54.691: 10.0.2.15:44558 (host) -> kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-endpoint FORWARDED (TCP Flags: ACK, FIN)
Jul 26 01:38:54.836: 127.0.0.1:32922 (world) <> 192.168.10.102 (host) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:54.943: 127.0.0.1:54908 (world) <> 192.168.10.101 (host) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.466: 192.168.10.100:54270 (kube-apiserver) -> kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:38:55.467: 127.0.0.1:8090 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.467: 127.0.0.1:8090 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.467: 127.0.0.1:39880 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.467: 127.0.0.1:39880 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.467: 127.0.0.1:39880 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.468: 127.0.0.1:8090 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.468: 127.0.0.1:8090 (world) <> kube-system/hubble-ui-76d4965bb6-p4blh (ID:14998) pre-xlate-rev TRACED (TCP)
Jul 26 01:38:55.468: 192.168.10.100:54270 (kube-apiserver) <- kube-system/hubble-ui-76d4965bb6-p4blh:8081 (ID:14998) to-network FORWARDED (TCP Flags: ACK, PSH)
...
```

### **8. Cilium Agent ë‹¨ì¶•í‚¤ ì§€ì •**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export CILIUMPOD0=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-ctr -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD1=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w1  -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD2=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w2  -o jsonpath='{.items[0].metadata.name}')
echo $CILIUMPOD0 $CILIUMPOD1 $CILIUMPOD2

alias c0="kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- cilium"
alias c1="kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- cilium"
alias c2="kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- cilium"

alias c0bpf="kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- bpftool"
alias c1bpf="kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- bpftool"
alias c2bpf="kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- bpftool"
```

âœ…Â **ì¶œë ¥**

```bash
cilium-kk8gc cilium-x4kvl cilium-w4fhn
```

---

## **ğŸ® Star Wars ë°ëª¨ & Hubble/UI ì‹œì‘í•˜ê¸°**

- [https://docs.cilium.io/en/stable/gettingstarted/demo/](https://docs.cilium.io/en/stable/gettingstarted/demo/)

### **Deploy the Demo Application**
![](https://velog.velcdn.com/images/tlsalswls123/post/a58db8bb-a767-4dc5-9256-0c82d19e78c7/image.png)

### **1. Star Wars Demo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml

# ê²°ê³¼
service/deathstar created
deployment.apps/deathstar created
pod/tiefighter created
pod/xwing created
```

### **2. íŒŒë“œ ë¼ë²¨(Label) í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get pod --show-labels
```

âœ…Â **ì¶œë ¥**

```bash
NAME                        READY   STATUS    RESTARTS   AGE   LABELS
deathstar-8c4c77fb7-4lc96   1/1     Running   0          29s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7
deathstar-8c4c77fb7-dwnlx   1/1     Running   0          29s   app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=8c4c77fb7
tiefighter                   1/1     Running   0          29s   app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire
xwing                       1/1     Running   0          29s   app.kubernetes.io/name=xwing,class=xwing,org=alliance
```

### **3. ë°°í¬Â·ì„œë¹„ìŠ¤Â·ì—”ë“œí¬ì¸íŠ¸ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get deploy,svc,ep deathstar
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                        READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deathstar   2/2     2            2           96s

NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/deathstar   ClusterIP   10.96.192.29   <none>        80/TCP    96s

NAME                  ENDPOINTS                       AGE
endpoints/deathstar   172.20.1.188:80,172.20.2.9:80   96s
```

### **4. CiliumEndpoints ì „ì²´ ì¡°íšŒ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumendpoints.cilium.io -A
```

âœ…Â **ì¶œë ¥**

```bash

NAMESPACE     NAME                           SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6
default       deathstar-8c4c77fb7-4lc96      55683               ready            172.20.2.9     
default       deathstar-8c4c77fb7-dwnlx      37697               ready            172.20.1.188   
default       tiefighter                      19379               ready            172.20.2.116   
default       xwing                          37711               ready            172.20.1.61    
kube-system   coredns-674b8bbfcf-8lcmh       3235                ready            172.20.0.21    
kube-system   coredns-674b8bbfcf-gjs6z       3235                ready            172.20.0.11    
kube-system   hubble-relay-5dcd46f5c-s4wqq   40607               ready            172.20.2.58    
kube-system   hubble-ui-76d4965bb6-p4blh     14998               ready            172.20.1.79
```

### **5. CiliumIdentities ì¡°íšŒ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumidentities.cilium.io
```

âœ…Â **ì¶œë ¥**

```bash
NAME    NAMESPACE     AGE
14998   kube-system   13h
19379   default       2m47s
3235    kube-system   14h
37697   default       2m47s
37711   default       2m47s
40607   kube-system   13h
55683   default       2m47s
```

### **6. Cilium Agentì—ì„œ ì—”ë“œí¬ì¸íŠ¸ ë¦¬ìŠ¤íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- cilium endpoint list
```

âœ…Â **ì¶œë ¥**

```bash

ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
184        Disabled           Disabled          37697      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.188   ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire                                                                                             
827        Disabled           Disabled          14998      k8s:app.kubernetes.io/name=hubble-ui                                                172.20.1.79    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                          
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-ui                                                                                      
2272       Disabled           Disabled          37711      k8s:app.kubernetes.io/name=xwing                                                    172.20.1.61    ready   
                                                           k8s:class=xwing                                                                                            
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=alliance                                                                                           
2439       Disabled           Disabled          1          reserved:host                                                                                      ready
```

- í•´ë‹¹ ë…¸ë“œì— ì˜¬ë¼ê°„ ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ ì¶œë ¥
- deathstar, hubble-ui, xwing, host ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ í™•ì¸

### **7. ê° ë…¸ë“œë³„ Cilium ì—”ë“œí¬ì¸íŠ¸ ë¦¬ìŠ¤íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c0 endpoint list
```

âœ…Â **ì¶œë ¥**

```bash

ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4          STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                    
1083       Disabled           Disabled          3235       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.21   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                  
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                           
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                               
                                                           k8s:k8s-app=kube-dns                                                                                      
1119       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                         ready   
                                                           k8s:node.kubernetes.io/exclude-from-external-load-balancers                                               
                                                           reserved:host                                                                                             
1122       Disabled           Disabled          3235       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.11   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                  
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                           
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                               
                                                           k8s:k8s-app=kube-dns
```

- kube-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤(coredns ë“±) ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ ì¶œë ¥

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c1 endpoint list
```

âœ…Â **ì¶œë ¥**

```bash
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
184        Disabled           Disabled          37697      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.188   ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire                                                                                             
827        Disabled           Disabled          14998      k8s:app.kubernetes.io/name=hubble-ui                                                172.20.1.79    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                          
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-ui                                                                                      
2272       Disabled           Disabled          37711      k8s:app.kubernetes.io/name=xwing                                                    172.20.1.61    ready   
                                                           k8s:class=xwing                                                                                            
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=alliance                                                                                           
2439       Disabled           Disabled          1          reserved:host                                                                                      ready
```

- `deathstar`, `hubble-ui`, `xwing` ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ ì¶œë ¥

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c2 endpoint list
```

âœ…Â **ì¶œë ¥**

```bash

ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
61         Disabled           Disabled          40607      k8s:app.kubernetes.io/name=hubble-relay                                             172.20.2.58    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-relay                                                       
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-relay                                                                                   
115        Disabled           Disabled          55683      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.9     ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire                                                                                             
451        Disabled           Disabled          1          reserved:host                                                                                      ready   
2643       Disabled           Disabled          19379      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.116   ready   
                                                           k8s:class=tiefighter                                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire
```

- `hubble-relay`, `deathstar`, `tiefighter` ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ ì¶œë ¥
- ê° ì—”ë“œí¬ì¸íŠ¸ê°€ ì–´ë–¤ ë¼ë²¨(Label) ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ê°€ ì •ì±… ê²°ì •ì— ë§¤ìš° ì¤‘ìš”

---

## **ğŸ‘€ í˜„ì¬ ì ‘ê·¼ ìƒíƒœ í™•ì¸**

### **1. í˜„ì¬ deathstar ì ‘ê·¼ ê°€ëŠ¥ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c1 endpoint list | grep -iE 'xwing|tiefighter|deathstar'
```

âœ…Â **ì¶œë ¥**

```bash
184        Disabled           Disabled          37697      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.188   ready   
                                                           k8s:class=deathstar                                                                                        
2272       Disabled           Disabled          37711      k8s:app.kubernetes.io/name=xwing                                                    172.20.1.61    ready   
                                                           k8s:class=xwing 
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c2 endpoint list | grep -iE 'xwing|tiefighter|deathstar'
```

âœ…Â **ì¶œë ¥**

```bash
115        Disabled           Disabled          55683      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.9     ready   
                                                           k8s:class=deathstar                                                                                        
2643       Disabled           Disabled          19379      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.116   ready   
                                                           k8s:class=tiefighter
```

- Deathstar ì„œë¹„ìŠ¤ëŠ” ì›ë˜ `org=empire` ë¼ë²¨ë§Œ í—ˆìš©í•˜ë„ë¡ ì„¤ê³„
- ì•„ì§ ë„¤íŠ¸ì›Œí¬ ì •ì±…(CNP)ì„ ì ìš©í•˜ì§€ ì•Šì•„ `xwing`ê³¼ `tiefighter` ëª¨ë‘ ì ‘ê·¼ ê°€ëŠ¥
- ê° ë…¸ë“œì—ì„œ Deathstar, Xwing, Tiefighter íŒŒë“œ ëª¨ë‘ Ready ìƒíƒœ í™•ì¸

### **2. ê° ë…¸ë“œ(C0/C1/C2) ëª¨ë‹ˆí„°ë§ í™•ì¸**

Cilium ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´ë¡œ íŠ¸ë˜í”½ íë¦„ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c0 monitor -v -v
```

âœ…Â **ì¶œë ¥**

```bash
Listening for events on 2 CPUs with 64x4096 of shared memory
Press Ctrl-C to quit
------------------------------------------------------------------------------
time="2025-07-26T01:56:34.86612445Z" level=info msg="Initializing dissection cache..." subsys=monitor
Ethernet	{Contents=[..14..] Payload=[..78..] SrcMAC=08:00:27:cf:db:ea DstMAC=08:00:27:36:0a:32 EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..56..] Version=4 IHL=5 TOS=0 Length=76 Id=13401 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=28728 SrcIP=192.168.10.100 DstIP=192.168.10.102 Options=[] Padding=[]}
TCP	{Contents=[..32..] Payload=[..24..] SrcPort=56870 DstPort=10250 Seq=1360120777 Ack=634515328 DataOffset=8 FIN=false SYN=false RST=false PSH=true ACK=true URG=false ECE=false CWR=false NS=false Window=991 Checksum=38489 Urgent=0 Options=[TCPOption(NOP:), TCPOption(NOP:), TCPOption(Timestamps:3450183246/4076572814 0xcda59e4ef2fb908e)] Padding=[] Multipath=false}
CPU 01: MARK 0xe50d4628 FROM 1119 to-network: 90 bytes (90 captured), state established, interface eth1, , identity host->unknown, orig-ip 192.168.10.100
------------------------------------------------------------------------------
Ethernet	{Contents=[..14..] Payload=[..62..] SrcMAC=f6:8a:5d:17:4b:ae DstMAC=fa:3a:73:16:b2:e8 EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..40..] Version=4 IHL=5 TOS=0 Length=60 Id=1306 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=32116 SrcIP=10.0.2.15 DstIP=172.20.0.11 Options=[] Padding=[]}
TCP	{Contents=[..40..] Payload=[] SrcPort=46488 DstPort=8181(intermapper) Seq=3425383573 Ack=0 DataOffset=10 FIN=false SYN=true RST=false PSH=false ACK=false URG=false ECE=false CWR=false NS=false Window=64240 Checksum=47196 Urgent=0 Options=[..5..] Padding=[] Multipath=false}
CPU 01: MARK 0x7bc3aa86 FROM 1122 to-endpoint: 74 bytes (74 captured), state new, interface lxc13029d3e0d35, , identity host->3235, orig-ip 10.0.2.15, to endpoint 1122
------------------------------------------------------------------------------
...
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c1 monitor -v -v
```

âœ…Â **ì¶œë ¥**

```bash
Listening for events on 2 CPUs with 64x4096 of shared memory
Press Ctrl-C to quit
------------------------------------------------------------------------------
time="2025-07-26T01:56:44.690724179Z" level=info msg="Initializing dissection cache..." subsys=monitor
Ethernet	{Contents=[..14..] Payload=[..62..] SrcMAC=4a:f1:4d:a8:56:1f DstMAC=62:83:f4:95:c7:a1 EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..40..] Version=4 IHL=5 TOS=0 Length=60 Id=47457 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=51176 SrcIP=10.0.2.15 DstIP=172.20.1.79 Options=[] Padding=[]}
TCP	{Contents=[..40..] Payload=[] SrcPort=49718 DstPort=8081(sunproxyadmin) Seq=2450151608 Ack=0 DataOffset=10 FIN=false SYN=true RST=false PSH=false ACK=false URG=false ECE=false CWR=false NS=false Window=64240 Checksum=47520 Urgent=0 Options=[..5..] Padding=[] Multipath=false}
CPU 01: MARK 0xfe7f56b8 FROM 827 to-endpoint: 74 bytes (74 captured), state new, interface lxcd54448478341, , identity host->14998, orig-ip 10.0.2.15, to endpoint 827
------------------------------------------------------------------------------
Ethernet	{Contents=[..14..] Payload=[..62..] SrcMAC=62:83:f4:95:c7:a1 DstMAC=4a:f1:4d:a8:56:1f EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..40..] Version=4 IHL=5 TOS=0 Length=60 Id=0 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=33098 SrcIP=172.20.1.79 DstIP=10.0.2.15 Options=[] Padding=[]}
TCP	{Contents=[..40..] Payload=[] SrcPort=8081(sunproxyadmin) DstPort=49718 Seq=1872207516 Ack=2450151609 DataOffset=10 FIN=false SYN=true RST=false PSH=false ACK=true URG=false ECE=false CWR=false NS=false Window=65160 Checksum=47520 Urgent=0 Options=[..5..] Padding=[] Multipath=false}
CPU 01: MARK 0x2bf841f5 FROM 827 to-stack: 74 bytes (74 captured), state reply, , identity 14998->host, orig-ip 0.0.0.0
------------------------------------------------------------------------------
...
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c2 monitor -v -v
```

âœ…Â **ì¶œë ¥**

```bash
Listening for events on 2 CPUs with 64x4096 of shared memory
Press Ctrl-C to quit
------------------------------------------------------------------------------
time="2025-07-26T01:56:56.589423599Z" level=info msg="Initializing dissection cache..." subsys=monitor
Ethernet	{Contents=[..14..] Payload=[..54..] SrcMAC=08:00:27:36:0a:32 DstMAC=08:00:27:cf:db:ea EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..32..] Version=4 IHL=5 TOS=0 Length=52 Id=5472 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=36681 SrcIP=192.168.10.102 DstIP=192.168.10.100 Options=[] Padding=[]}
TCP	{Contents=[..32..] Payload=[] SrcPort=47870 DstPort=6443(sun-sr-https) Seq=2993297840 Ack=594274701 DataOffset=8 FIN=false SYN=false RST=false PSH=false ACK=true URG=false ECE=false CWR=false NS=false Window=6125 Checksum=38465 Urgent=0 Options=[TCPOption(NOP:), TCPOption(NOP:), TCPOption(Timestamps:4076599536/3450204970 0xf2fbf8f0cda5f32a)] Padding=[] Multipath=false}
CPU 01: MARK 0xd11396d8 FROM 451 to-network: 66 bytes (66 captured), state established, interface eth1, , identity host->unknown, orig-ip 192.168.10.102
------------------------------------------------------------------------------
Ethernet	{Contents=[..14..] Payload=[..62..] SrcMAC=b2:be:eb:e9:e7:5a DstMAC=5a:0d:e7:cf:c6:f4 EthernetType=IPv4 Length=0}
IPv4	{Contents=[..20..] Payload=[..40..] Version=4 IHL=5 TOS=0 Length=60 Id=2669 Flags=DF FragOffset=0 TTL=64 Protocol=TCP Checksum=30194 SrcIP=10.0.2.15 DstIP=172.20.2.58 Options=[] Padding=[]}
TCP	{Contents=[..40..] Payload=[] SrcPort=49850 DstPort=4222 Seq=1225774167 Ack=0 DataOffset=10 FIN=false SYN=true RST=false PSH=false ACK=false URG=false ECE=false CWR=false NS=false Window=64240 Checksum=47755 Urgent=0 Options=[..5..] Padding=[] Multipath=false}
CPU 01: MARK 0xb856b576 FROM 61 to-endpoint: 74 bytes (74 captured), state new, interface lxc96f91b710874, , identity host->40607, orig-ip 10.0.2.15, to endpoint 61
------------------------------------------------------------------------------
...
```

- TCP SYN, ACK, ë°ì´í„° ì „ì†¡ ë“± íŒ¨í‚· íë¦„ ì‹¤ì‹œê°„ í‘œì‹œ

### **3. Hubble Observeë¡œ ì „ì²´ íŠ¸ë˜í”½ í™•ì¸**

Hubble Relayë¥¼ í†µí•´ ëª¨ë“  ë…¸ë“œì˜ íŠ¸ë˜í”½ì„ í•œ ë²ˆì— ê´€ì°°

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f
```

âœ…Â **ì¶œë ¥**

```bash
Jul 26 01:59:37.530: kube-system/coredns-674b8bbfcf-gjs6z:49010 (ID:3235) -> 192.168.10.100:6443 (host) to-stack FORWARDED (TCP Flags: ACK)
Jul 26 01:59:37.625: kube-system/hubble-ui-76d4965bb6-p4blh:59568 (ID:14998) -> 192.168.10.100:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:59:37.626: kube-system/hubble-ui-76d4965bb6-p4blh:59568 (ID:14998) <- 192.168.10.100:6443 (kube-apiserver) to-endpoint FORWARDED (TCP Flags: ACK, PSH)
Jul 26 01:59:37.717: 10.0.2.15:54464 (host) -> 10.0.2.3:53 (world) to-network FORWARDED (UDP)
Jul 26 01:59:37.737: 127.0.0.1:51666 (world) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:37.737: 127.0.0.1:51666 (world) <> kube-system/hubble-relay-5dcd46f5c-s4wqq (ID:40607) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.190: 127.0.0.1:34518 (world) <> 192.168.10.100 (host) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:49862 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:49862 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:49862 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:49862 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.522: 127.0.0.1:49862 (world) <> kube-system/coredns-674b8bbfcf-gjs6z (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:49868 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:49868 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:49868 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:8080 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:49868 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:38.524: 127.0.0.1:49868 (world) <> kube-system/coredns-674b8bbfcf-8lcmh (ID:3235) pre-xlate-rev TRACED (TCP)
Jul 26 01:59:39.277: 192.168.10.102:47870 (host) -> 192.168.10.100:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)
Jul 26 01:59:39.318: 192.168.10.101:55504 (host) -> 192.168.10.100:6443 (kube-apiserver) to-network FORWARDED (TCP Flags: ACK)
Jul 26 01:59:39.414: 10.0.2.15:37754 (host) -> kube-system/coredns-674b8bbfcf-8lcmh:8080 (ID:3235) to-endpoint FORWARDED (TCP Flags: SYN)
Jul 26 01:59:39.414: 10.0.2.15:37754 (host) <- kube-system/coredns-674b8bbfcf-8lcmh:8080 (ID:3235) to-stack FORWARDED (TCP Flags: SYN, ACK)
Jul 26 01:59:39.414: 10.0.2.15:37754 (host) -> kube-system/coredns-674b8bbfcf-8lcmh:8080 (ID:3235) to-endpoint FORWARDED (TCP Flags: ACK)
...
```

### **4. xwingì—ì„œ deathstarë¡œ ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/a4e724db-f2e0-4d09-9447-1c331cca99dc/image.png)

**xwing â†’ deathstar ìš”ì²­ ì„±ê³µ**
![](https://velog.velcdn.com/images/tlsalswls123/post/7a3a32a7-eb20-4330-908c-15d8bc5ce36f/image.png)

### **5. tiefighterì—ì„œ deathstarë¡œ ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/66d6d18e-8d12-43a8-aaa5-e44b9dd91dee/image.png)

**tiefighter â†’ deathstar ìš”ì²­ ì„±ê³µ**
![](https://velog.velcdn.com/images/tlsalswls123/post/e98adc2e-0eb1-4c72-954b-a661572bf3b4/image.png)

### **6. deathstar, xwing, tiefighter ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c1 endpoint list | grep -iE 'xwing|tiefighter|deathstar'
c2 endpoint list | grep -iE 'xwing|tiefighter|deathstar'
```

âœ…Â **ì¶œë ¥**

```bash
184        Disabled           Disabled          37697      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.188   ready   
                                                           k8s:class=deathstar                                                                                        
2272       Disabled           Disabled          37711      k8s:app.kubernetes.io/name=xwing                                                    172.20.1.61    ready   
                                                           k8s:class=xwing                                                                                            
115        Disabled           Disabled          55683      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.9     ready   
                                                           k8s:class=deathstar                                                                                        
2643       Disabled           Disabled          19379      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.116   ready   
                                                           k8s:class=tiefighter
```

**IDENTITY ê°’ ì¶”ì¶œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# XWINGID=37711
TIEFIGHTERID=19379
DEATHSTARID=37697
DEATHSTARID=55683
```

### **7. xwingì—ì„œ ì¶œë°œí•œ íŠ¸ë˜í”½ë§Œ ëª¨ë‹ˆí„°ë§**

```bash
hubble observe -f --from-identity $XWINGID
```

**deathstarë¡œì˜ ìš”ì²­ íë¦„ í™•ì¸**

```bash
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/f6da99ac-6e1c-4d51-ae2f-4727d43d522f/image.png)

### **8. xwing UDP íŠ¸ë˜í”½ë§Œ ëª¨ë‹ˆí„°ë§**

```bash
hubble observe -f --protocol udp --from-identity $XWINGID
```

```bash
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/1b1732e0-6dcd-4dc6-96f5-e34e8a72d0be/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/ce677c3a-2680-4feb-aa68-fe433152d5c9/image.png)

### **9. xwing TCP íŠ¸ë˜í”½ë§Œ ëª¨ë‹ˆí„°ë§**

SYN â†’ SYN/ACK â†’ ACK, ë°ì´í„° ì „ì†¡ í›„ FIN íŒ¨í‚·ê¹Œì§€ 3-way handshake ë° ì¢…ë£Œ ê³¼ì • í™•ì¸ ê°€ëŠ¥
![](https://velog.velcdn.com/images/tlsalswls123/post/72ad1cbd-ca24-4db6-bab1-b71261c16ae2/image.png)

### **10. tiefighterì—ì„œ deathstarë¡œ ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
hubble observe -f --protocol tcp --from-identity $DEATHSTARID
```

```bash
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/c79ee007-e173-4cf0-bc84-516dbba9d266/image.png)
- tiefighterì—ì„œ deathstarë¡œ ìš”ì²­ ì„±ê³µ
- Hubble observeì—ì„œ ì •ìƒì ì¸ ìš”ì²­Â·ì‘ë‹µ íë¦„ í™•ì¸

---

## **ğŸ“œ Apply an L3/L4 Policy**

- [https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy](https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-an-l3-l4-policy)

### **1. L3/L4 ì •ì±… ì ìš©**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_policy.yaml
ciliumnetworkpolicy.cilium.io/rule1 created
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cnp
NAME    AGE   VALID
rule1   72s   True
```

### **2. xwing â†’ deathstar ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --type drop
```

**í˜¸ì¶œì‹œë„**

```bash
kubectl exec xwing -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing --connect-timeout 2
```
![](https://velog.velcdn.com/images/tlsalswls123/post/9ca2e3ea-97ac-428f-b8af-08baf2f676fb/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/2cbd504d-5961-4553-a4cc-cb23391474df/image.png)

### **3. tiefighter â†’ deathstar ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
hubble observe -f --protocol tcp --from-identity $DEATHSTARID
```

```bash
kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/43e583ed-d15e-45f8-81e5-55adc2086151/image.png)
- tiefighterëŠ” `org=empire` ë¼ë²¨ì„ ê°€ì§€ê³  ìˆìœ¼ë¯€ë¡œ deathstarë¡œ ì ‘ê·¼ í—ˆìš©
- í—ˆìš©ëœ íŠ¸ë˜í”½ì´ Hubble observeì— í‘œì‹œë¨

### **4. ì •ì±… ì ìš© í›„ ì—”ë“œí¬ì¸íŠ¸ ìƒíƒœ í™•ì¸ (c0, c1, c2)**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c0 endpoint list
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4          STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                    
1083       Disabled           Disabled          3235       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.21   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                  
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                           
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                               
                                                           k8s:k8s-app=kube-dns                                                                                      
1119       Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                         ready   
                                                           k8s:node.kubernetes.io/exclude-from-external-load-balancers                                               
                                                           reserved:host                                                                                             
1122       Disabled           Disabled          3235       k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          172.20.0.11   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                  
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                           
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                               
                                                           k8s:k8s-app=kube-dns
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c1 endpoint list
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
184        Enabled            Disabled          37697      k8s:app.kubernetes.io/name=deathstar                                                172.20.1.188   ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire                                                                                             
827        Disabled           Disabled          14998      k8s:app.kubernetes.io/name=hubble-ui                                                172.20.1.79    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                          
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-ui                                                                                      
2272       Disabled           Disabled          37711      k8s:app.kubernetes.io/name=xwing                                                    172.20.1.61    ready   
                                                           k8s:class=xwing                                                                                            
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=alliance                                                                                           
2439       Disabled           Disabled          1          reserved:host                                                                                      ready
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# c2 endpoint list
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
61         Disabled           Disabled          40607      k8s:app.kubernetes.io/name=hubble-relay                                             172.20.2.58    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-relay                                                       
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-relay                                                                                   
115        Enabled            Disabled          55683      k8s:app.kubernetes.io/name=deathstar                                                172.20.2.9     ready   
                                                           k8s:class=deathstar                                                                                        
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire                                                                                             
451        Disabled           Disabled          1          reserved:host                                                                                      ready   
2643       Disabled           Disabled          19379      k8s:app.kubernetes.io/name=tiefighter                                               172.20.2.116    ready   
                                                           k8s:class=tiefighter                                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
                                                           k8s:org=empire
```

- xwingì€ `org=alliance` ë¼ë²¨ë¡œ, ì •ì±…ì— ë§ì§€ ì•Šì•„ ì ‘ê·¼ ë¶ˆê°€
- tiefighterëŠ” `org=empire`ë¡œ í—ˆìš© ëŒ€ìƒ

### **5. CiliumNetworkPolicy ìƒì„¸ í™•ì¸**

ì •ì±…ì´ ì¦‰ì‹œ ì ìš©ë˜ì–´ íŠ¸ë˜í”½ ì œì–´ ìˆ˜í–‰

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cnp rule1
Name:         rule1
Namespace:    default
Labels:       <none>
Annotations:  <none>
API Version:  cilium.io/v2
Kind:         CiliumNetworkPolicy
Metadata:
  Creation Timestamp:  2025-07-26T03:40:08Z
  Generation:          1
  Resource Version:    23448
  UID:                 c6537744-baa5-4a00-baf3-b68515037c3f
Spec:
  Description:  L3-L4 policy to restrict deathstar access to empire ships only
  Endpoint Selector:
    Match Labels:
      Class:  deathstar
      Org:    empire
  Ingress:
    From Endpoints:
      Match Labels:
        Org:  empire
    To Ports:
      Ports:
        Port:      80
        Protocol:  TCP
Status:
  Conditions:
    Last Transition Time:  2025-07-26T03:40:08Z
    Message:               Policy validation succeeded
    Status:                True
    Type:                  Valid
Events:                    <none>
```

---

## **ğŸ“¦ Life of a Packet**

- Ciliumì—ì„œ L7 ë™ì‘ ì²˜ë¦¬ëŠ” **cilium-envoy ë°ëª¬ì…‹**ì´ ë‹´ë‹¹
- eBPFë¡œ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ë˜, L7 ë ˆë²¨ ì²˜ë¦¬ëŠ” ê° ë…¸ë“œì— ë°°í¬ëœ `cilium-envoy`ê°€ ìˆ˜í–‰
- https://docs.cilium.io/en/stable/network/ebpf/lifeofapacket/

### **1. cilium-envoy ë°ëª¬ì…‹ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ds -n kube-system
NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
cilium         3         3         3       3            3           kubernetes.io/os=linux   16h
cilium-envoy   3         3         3       3            3           kubernetes.io/os=linux   16h
```

### **2. cilium-envoy íŒŒë“œ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get pod -n kube-system -l k8s-app=cilium-envoy -owide
NAME                 READY   STATUS    RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES
cilium-envoy-fmwrj   1/1     Running   0          16h   192.168.10.102   k8s-w2    <none>           <none>
cilium-envoy-wtq2z   1/1     Running   0          16h   192.168.10.100   k8s-ctr   <none>           <none>
cilium-envoy-zzvpw   1/1     Running   0          16h   192.168.10.101   k8s-w1    <none>           <none>
```

### **3. cilium-envoy ìƒì„¸ ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe ds -n kube-system cilium-envoy
Name:           cilium-envoy
Namespace:      kube-system
Selector:       k8s-app=cilium-envoy
Node-Selector:  kubernetes.io/os=linux
Labels:         app.kubernetes.io/managed-by=Helm
                app.kubernetes.io/name=cilium-envoy
                app.kubernetes.io/part-of=cilium
                k8s-app=cilium-envoy
                name=cilium-envoy
Annotations:    deprecated.daemonset.template.generation: 1
                meta.helm.sh/release-name: cilium
                meta.helm.sh/release-namespace: kube-system
Desired Number of Nodes Scheduled: 3
Current Number of Nodes Scheduled: 3
Number of Nodes Scheduled with Up-to-date Pods: 3
Number of Nodes Scheduled with Available Pods: 3
Number of Nodes Misscheduled: 0
Pods Status:  3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:           app.kubernetes.io/name=cilium-envoy
                    app.kubernetes.io/part-of=cilium
                    k8s-app=cilium-envoy
                    name=cilium-envoy
  Service Account:  cilium-envoy
  Containers:
   cilium-envoy:
    Image:      quay.io/cilium/cilium-envoy:v1.33.4-1752151664-7c2edb0b44cf95f326d628b837fcdd845102ba68@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171
    Port:       9964/TCP
    Host Port:  9964/TCP
    Command:
      /usr/bin/cilium-envoy-starter
    Args:
      --
      -c /var/run/cilium/envoy/bootstrap-config.json
      --base-id 0
      --log-level info
    Liveness:   http-get http://127.0.0.1:9878/healthz delay=0s timeout=5s period=30s #success=1 #failure=10
    Readiness:  http-get http://127.0.0.1:9878/healthz delay=0s timeout=5s period=30s #success=1 #failure=3
    Startup:    http-get http://127.0.0.1:9878/healthz delay=5s timeout=1s period=2s #success=1 #failure=105
    Environment:
      K8S_NODE_NAME:             (v1:spec.nodeName)
      CILIUM_K8S_NAMESPACE:      (v1:metadata.namespace)
      KUBERNETES_SERVICE_HOST:  192.168.10.100
      KUBERNETES_SERVICE_PORT:  6443
    Mounts:
      /sys/fs/bpf from bpf-maps (rw)
      /var/run/cilium/envoy/ from envoy-config (ro)
      /var/run/cilium/envoy/artifacts from envoy-artifacts (ro)
      /var/run/cilium/envoy/sockets from envoy-sockets (rw)
  Volumes:
   envoy-sockets:
    Type:          HostPath (bare host directory volume)
    Path:          /var/run/cilium/envoy/sockets
    HostPathType:  DirectoryOrCreate
   envoy-artifacts:
    Type:          HostPath (bare host directory volume)
    Path:          /var/run/cilium/envoy/artifacts
    HostPathType:  DirectoryOrCreate
   envoy-config:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      cilium-envoy-config
    Optional:  false
   bpf-maps:
    Type:               HostPath (bare host directory volume)
    Path:               /sys/fs/bpf
    HostPathType:       DirectoryOrCreate
  Priority Class Name:  system-node-critical
  Node-Selectors:       kubernetes.io/os=linux
  Tolerations:          op=Exists
Events:                 <none>
```

- ë³¼ë¥¨ ë§ˆìš´íŠ¸
    - `/var/run/cilium/envoy/sockets`
    - `/sys/fs/bpf`

### **4. ì†Œì¼“ ì—°ê²° ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- ss -xnp | grep -i -envoy
u_str ESTAB 0      0                                                /var/run/cilium/envoy/sockets/admin.sock 27023            * 27022                                     
u_str ESTAB 0      0                                                  /var/run/cilium/envoy/sockets/xds.sock 36056            * 36915 users:(("cilium-agent",pid=1,fd=65))
u_str ESTAB 0      0                                                /var/run/cilium/envoy/sockets/admin.sock 27017            * 27016
```

- `u_str ESTAB` ìƒíƒœë¡œ envoy ì†Œì¼“(admin.sock, xds.sock)ê³¼ ì—°ê²°
- `users:(("cilium-agent",pid=1,fd=65))` í˜•íƒœë¡œ ì—°ê²° ì£¼ì²´ê°€ cilium-agentì„ì„ í™•ì¸

---

## **ğŸŒ HTTP ê¸°ë°˜ L7 ì •ì±… ì ìš©ê³¼ í…ŒìŠ¤íŠ¸**

- [https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy](https://docs.cilium.io/en/stable/gettingstarted/demo/#apply-and-test-http-aware-l7-policy)

### **1. L7 ì •ì±… ì ìš© ì „ í…ŒìŠ¤íŠ¸**

`tiefighter` íŒŒë“œì—ì„œ `deathStar`ì˜ ìœ ì§€ë³´ìˆ˜ API(`/v1/exhaust-port`)ë¡œ PUT ìš”ì²­ì„ ì‹¤í–‰

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec tiefighter -- curl -s -XPUT deathstar.default.svc.cluster.local/v1/exhaust-port
```

âœ…Â **ì¶œë ¥**

```bash
Panic: deathstar exploded

goroutine 1 [running]:
main.HandleGarbage(0x2080c3f50, 0x2, 0x4, 0x425c0, 0x5, 0xa)
        /code/src/github.com/empire/deathstar/
        temp/main.go:9 +0x64
main.main()
        /code/src/github.com/empire/deathstar/
        temp/main.go:5 +0x85
```

- `Panic: deathstar exploded` â†’ **L7 ë ˆë²¨ì˜ ì œì–´ê°€ ì—†ì–´ í—ˆìš©ëœ ìƒíƒœ**
- Hubbleì—ì„œëŠ” L3/L4 ë ˆë²¨ë¡œë§Œ ê´€ì°°ë˜ì–´ **Forwarded**ë¡œ í‘œì‹œë˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ì—ì„œ ë¬¸ì œ ë°œìƒ

![](https://velog.velcdn.com/images/tlsalswls123/post/60db55f3-7351-4d4a-86a3-c3d6174ccb73/image.png)

### **2. ê¸°ì¡´ L3/L4 ì •ì±…(rule1) ì—…ë°ì´íŠ¸ â†’ L7 ì •ì±… ì ìš©**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/sw_l3_l4_l7_policy.yaml
ciliumnetworkpolicy.cilium.io/rule1 configured
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cnp
```

âœ…Â **ì¶œë ¥**

```bash
Name:         rule1
Namespace:    default
Labels:       <none>
Annotations:  <none>
API Version:  cilium.io/v2
Kind:         CiliumNetworkPolicy
Metadata:
  Creation Timestamp:  2025-07-26T03:40:08Z
  Generation:          2
  Resource Version:    27633
  UID:                 c6537744-baa5-4a00-baf3-b68515037c3f
Spec:
  Description:  L7 policy to restrict access to specific HTTP call
  Endpoint Selector:
    Match Labels:
      Class:  deathstar
      Org:    empire
  Ingress:
    From Endpoints:
      Match Labels:
        Org:  empire
    To Ports:
      Ports:
        Port:      80
        Protocol:  TCP
      Rules:
        Http:
          Method:  POST
          Path:    /v1/request-landing
Status:
  Conditions:
    Last Transition Time:  2025-07-26T03:40:08Z
    Message:               Policy validation succeeded
    Status:                True
    Type:                  Valid
Events:                    <none>
```

- **ëª©ì ì§€:** `org=empire`, `class=deathstar`
- **í—ˆìš© ê·œì¹™:** `HTTP POST` ë©”ì„œë“œ, ê²½ë¡œ `/v1/request-landing`ë§Œ í—ˆìš©
- ë‚˜ë¨¸ì§€ HTTP ë©”ì„œë“œëŠ” ì°¨ë‹¨

### **3. L7 ì •ì±… ëª¨ë‹ˆí„°ë§ (Hubble ì‚¬ìš©)**

**(1) deathStar íŒŒë“œ ê¸°ì¤€ HTTP í”„ë¡œí† ì½œ ëª¨ë‹ˆí„°ë§**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --pod deathstar --protocol http
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/dbc0e8f5-38e7-4765-98a2-ee02735ffd2c/image.png)

**(2) `tiefighter`ì—ì„œ ì •ìƒ API í˜¸ì¶œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec tiefighter -- curl -s -XPOST deathstar.default.svc.cluster.local/v1/request-landing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/2f6cc6a4-963a-4858-9ea7-2b381229a5d9/image.png)

**(3) L7 ì •ë³´ í•„ë“œê°’ í™•ì¸ ê°€ëŠ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/af8a3f97-5bdb-4f0c-b309-4a0a61585080/image.png)

### **4. ë¹„í—ˆìš© API ìš”ì²­ í…ŒìŠ¤íŠ¸ ë° ë“œë¡­ ë¡œê·¸ í™•ì¸**

**ë¹„í—ˆìš© APIë¥¼ í˜¸ì¶œí•˜ê±°ë‚˜, ì •ì±…ì— ë§ì§€ ì•ŠëŠ” ì ‘ê·¼ ì‹œë„ â†’ Hubbleì—ì„œ DROPPED ì´ë²¤íŠ¸ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/b5b8edfe-6426-4d52-bbf0-606f861dc989/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/cbf02ecf-8361-4a38-9f67-8b764feab3c6/image.png)

**íŒŒë“œ ì´ë¦„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --pod xwing
```
![](https://velog.velcdn.com/images/tlsalswls123/post/7c6db03a-4025-4c19-af29-ac705795dc3b/image.png)

**L7 DROPê³¼ ì°¨ì´ê°€ ìˆìŒ**
![](https://velog.velcdn.com/images/tlsalswls123/post/9a368840-8e46-47f6-ba35-fbc4f99cc7a2/image.png)

### **5. ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì •ë¦¬**

**(1) ì‹¤ìŠµ í›„ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl delete -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/minikube/http-sw-app.yaml
kubectl delete cnp rule1
service "deathstar" deleted
deployment.apps "deathstar" deleted
pod "tiefighter" deleted
pod "xwing" deleted
ciliumnetworkpolicy.cilium.io "rule1" deleted
```

**(2) ì‚­ì œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cnp
No resources found in default namespace.
```

---

## **ğŸ“¤ Hubble Exporter ì„¤ì •í•˜ê¸°**

Hubble ExporterëŠ” file rotation, size limits, filters, field masksë¥¼ ì§€ì›í•¨

### **1. Hubble Exporter ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cm -n kube-system cilium-config -o json | grep hubble-export
```

âœ…Â **ì¶œë ¥**

```bash
        "hubble-export-allowlist": "",
        "hubble-export-denylist": "",
        "hubble-export-fieldmask": "",
        "hubble-export-file-max-backups": "5",
        "hubble-export-file-max-size-mb": "10",
        "hubble-export-file-path": "/var/run/cilium/hubble/events.log",
```

### **2. Hubble Exporter íë¦„ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system exec ds/cilium -- tail -f /var/run/cilium/hubble/events.log
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/8f28aa00-b83f-47ea-bfe0-d58e2e89294c/image.png)

### **3. Hubble Exporter ë¡œê·¸ë¥¼ JSON í˜•íƒœë¡œ ë³´ê¸°**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system exec ds/cilium -- sh -c 'tail -f /var/run/cilium/hubble/events.log' | jq
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/d2ba947d-92ad-4f8e-a26a-f5ab8e4102c6/image.png)

---

## **ğŸ“Š Prometheus & Grafana ì‹¤í–‰í•˜ê¸°**

### 1. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜(webpod) ë°°í¬

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
EOF

# ê²°ê³¼
deployment.apps/webpod created
service/webpod created
```

### **2. curl-pod ë°°í¬**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOF

# ê²°ê³¼
pod/curl-pod created
```

### **3. ë°°í¬ ìƒíƒœ ë° Cilium ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it -n kube-system ds/cilium -c cilium-agent -- cilium-dbg endpoint list
```

âœ…Â **ì¶œë ¥**

```bash
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                  IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                     
772        Disabled           Disabled          7053       k8s:app=webpod                                                                      172.20.1.197   ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                     
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                            
                                                           k8s:io.kubernetes.pod.namespace=default                                                                    
827        Disabled           Disabled          14998      k8s:app.kubernetes.io/name=hubble-ui                                                172.20.1.79    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                       
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                   
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                          
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                
                                                           k8s:k8s-app=hubble-ui                                                                                      
2439       Disabled           Disabled          1          reserved:host                                                                                      ready
```

### **4. curl-podë¡œ webpod ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- curl webpod | grep Hostname
Hostname: webpod-697b545f57-kg77r

(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- curl webpod | grep Hostname
Hostname: webpod-697b545f57-mbjvf

...
```

**ë©”íŠ¸ë¦­ ìƒì„±ì„ ìœ„í•´ í˜¸ì¶œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s webpod | grep Hostname; sleep 1; done'
```
![](https://velog.velcdn.com/images/tlsalswls123/post/c2f614d6-3367-4653-b2ed-d8e183858f31/image.png)

---

## **ğŸ“ˆ Prometheus & Grafana ì„¤ì¹˜í•˜ê¸°**

- [https://docs.cilium.io/en/stable/observability/grafana/](https://docs.cilium.io/en/stable/observability/grafana/)

### **1. Prometheus & Grafana ì„¤ì¹˜**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl apply -f https://raw.githubusercontent.com/cilium/cilium/1.17.6/examples/kubernetes/addons/prometheus/monitoring-example.yaml

# ê²°ê³¼
namespace/cilium-monitoring created
serviceaccount/prometheus-k8s created
configmap/grafana-config created
configmap/grafana-cilium-dashboard created
configmap/grafana-cilium-operator-dashboard created
configmap/grafana-hubble-dashboard created
configmap/grafana-hubble-l7-http-metrics-by-workload created
configmap/prometheus created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
service/grafana created
service/prometheus created
deployment.apps/grafana created
deployment.apps/prometheus created
```

### **2. Prometheus & Grafana ë¦¬ì†ŒìŠ¤ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get deploy,pod,svc,ep -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                         READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/grafana      1/1     1            1           45s
deployment.apps/prometheus   1/1     1            1           45s

NAME                              READY   STATUS    RESTARTS   AGE
pod/grafana-5c69859d9-cd9fn       1/1     Running   0          45s
pod/prometheus-6fc896bc5d-85d4w   1/1     Running   0          45s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/grafana      ClusterIP   10.96.169.141   <none>        3000/TCP   45s
service/prometheus   ClusterIP   10.96.253.138   <none>        9090/TCP   45s

NAME                   ENDPOINTS           AGE
endpoints/grafana      172.20.1.207:3000   45s
endpoints/prometheus   172.20.2.76:9090    45s
```

### **3. Grafana ëŒ€ì‹œë³´ë“œ ConfigMap í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cm -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                         DATA   AGE
grafana-cilium-dashboard                     1      92s
grafana-cilium-operator-dashboard            1      91s
grafana-config                                3      92s
grafana-hubble-dashboard                     1      91s
grafana-hubble-l7-http-metrics-by-workload   1      91s
kube-root-ca.crt                             1      92s
prometheus                                   1      91s
```

### **4. Prometheus ì„œë²„ ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cm -n cilium-monitoring prometheus
```

âœ…Â **ì¶œë ¥**

```bash
Name:         prometheus
Namespace:    cilium-monitoring
Labels:       <none>
Annotations:  <none>

Data
====
prometheus.yaml:
----
global:
  scrape_interval: 10s
  scrape_timeout: 10s
  evaluation_interval: 10s
rule_files:
  - "/etc/prometheus-rules/*.rules"
scrape_configs:
  # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L79
  - job_name: 'kubernetes-endpoints'
    kubernetes_sd_configs:
      - role: endpoints
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_k8s_app]
        action: keep
        regex: cilium
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
        action: replace
        target_label: __scheme__
        regex: (https?)
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]
        action: replace
        target_label: __address__
        regex: (.+)(?::\d+);(\d+)
        replacement: $1:$2
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_service_name]
        action: replace
        target_label: service

  # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L156
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: (.+):(?:\d+);(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_port_number]
        action: keep
        regex: \d+

  # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L119
  - job_name: 'kubernetes-services'
    metrics_path: /metrics
    params:
      module: [http_2xx]
    kubernetes_sd_configs:
      - role: service
    relabel_configs:
      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_probe]
        action: keep
        regex: true
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_service_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
      - source_labels: [__meta_kubernetes_service_name]
        target_label: service

  - job_name: 'kubernetes-cadvisor'
    scheme: https
    tls_config:
      ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
    bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)
      - target_label: __address__
        replacement: kubernetes.default.svc:443
      - source_labels: [__meta_kubernetes_node_name]
        regex: (.+)
        target_label: __metrics_path__
        replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor

BinaryData
====

Events:  <none>
```

### **5. Grafana ì„œë²„ ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cm -n cilium-monitoring grafana-config
```

âœ…Â **ì¶œë ¥**

```bash
Name: grafana-config
Namespace: cilium-monitoring
Labels: app=grafana
...

config.yaml:
providers:
- name: 'cilium-dashboard-config'
  type: file
  options:
    path: '/configmap/dashboards/'
...

grafana.ini:
app_mode = production
[server]
http_port = 3000
[security]
admin_user = admin
admin_password = admin
disable_gravatar = true
[auth.anonymous]
enabled = true
org_name = Main Org.
org_role = Admin
[metrics]
enabled = true
interval_seconds = 10
...

prometheus-datasource.yaml:
datasources:
- name: prometheus
  type: prometheus
  url: http://prometheus:9090
  editable: true
...
```

---

## **ğŸš€ ë©”íŠ¸ë¦­ í™œì„±í™” ìƒíƒœë¡œ Ciliumê³¼ Hubble ë°°í¬í•˜ê¸°**

### **1. í˜¸ìŠ¤íŠ¸ì˜ í¬íŠ¸ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ss -tnlp | grep -E '9962|9963|9965'
```

âœ…Â **ì¶œë ¥**

```bash
LISTEN 0      4096                *:9965             *:*    users:(("cilium-agent",pid=7666,fd=31))                
LISTEN 0      4096                *:9963             *:*    users:(("cilium-operator",pid=4772,fd=7))              
LISTEN 0      4096                *:9962             *:*    users:(("cilium-agent",pid=7666,fd=7)) 
```

- `9962`: cilium-agent
- `9963`: cilium-operator
- `9965`: cilium-agent

### **2. ì›Œì»¤ ë…¸ë“œë³„ í¬íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w2 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i sudo ss -tnlp | grep -E '9962|9963|9965' ; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node : k8s-w1 <<
LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=6068,fd=32))                
LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=6068,fd=7))                 

>> node : k8s-w2 <<
LISTEN 0      4096               *:9962             *:*    users:(("cilium-agent",pid=5995,fd=7))                 
LISTEN 0      4096               *:9965             *:*    users:(("cilium-agent",pid=5995,fd=31))
```

- `9962`: cilium-agent
- `9965`: cilium-agent

---

## **ğŸ”Œ hostPCì—ì„œ ì ‘ì†ì„ ìœ„í•œ NodePort ì„¤ì • ë° â€˜Prometheus & Grafanaâ€™ ì›¹ ì ‘ì† í™•ì¸**

### **1. cilium-monitoring ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì„œë¹„ìŠ¤ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
grafana      ClusterIP   10.96.169.141   <none>        3000/TCP   11m
prometheus   ClusterIP   10.96.253.138   <none>        9090/TCP   11m
```

- ì´ˆê¸° ìƒíƒœëŠ” **ClusterIP** ë¡œ ì™¸ë¶€ ì ‘ê·¼ ë¶ˆê°€

### **2. ì™¸ë¶€ ì ‘ê·¼ì„ ìœ„í•œ NodePort ì„¤ì •**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl patch svc -n cilium-monitoring prometheus -p '{"spec": {"type": "NodePort", "ports": [{"port": 9090, "targetPort": 9090, "nodePort": 30001}]}}'
kubectl patch svc -n cilium-monitoring grafana -p '{"spec": {"type": "NodePort", "ports": [{"port": 3000, "targetPort": 3000, "nodePort": 30002}]}}'

# ê²°ê³¼
service/prometheus patched
service/grafana patched
```

- Prometheusì™€ Grafanaë¥¼ ì™¸ë¶€ì—ì„œ ì ‘ì†í•  ìˆ˜ ìˆë„ë¡ **NodePort**ë¡œ ë³€ê²½
- Prometheus: 9090 â†’ NodePort 30001
- Grafana: 3000 â†’ NodePort 30002

### **3. NodePort ë³€ê²½ ê²°ê³¼ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
grafana      NodePort   10.96.169.141   <none>        3000:30002/TCP   13m
prometheus   NodePort   10.96.253.138   <none>        9090:30001/TCP   13m
```

### **4. ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# echo "http://192.168.10.100:30001"
echo "http://192.168.10.100:30002"
```

âœ…Â **ì¶œë ¥**

```bash
http://192.168.10.100:30001 # prometheus
http://192.168.10.100:30002 # grafana
```

**Prometheus**
![](https://velog.velcdn.com/images/tlsalswls123/post/2f0ace22-7148-48e1-973b-dcc73e2dafd5/image.png)

**Grafana**
![](https://velog.velcdn.com/images/tlsalswls123/post/0940aee2-17c5-4693-9cee-e603e2b16d67/image.png)

**(ì°¸ê³ ) Prometheus íŒŒë“œ ì›¹ ì ‘ì† ì‹œ, ì„œë²„ì™€ ë¸Œë¼ìš°ì €ê°„ ì‹œê°„ ì°¨ì´ ë°œìƒ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it -n cilium-monitoring deploy/prometheus -- date
Sat Jul 26 05:21:01 UTC 2025
(âˆ|HomeLab:N/A) root@k8s-ctr:~# date
Sat Jul 26 02:21:13 PM KST 2025

# í•´ê²°
ëª¨ë“  ê°€ìƒë¨¸ì‹  reboot í›„ ì¬ì ‘ì† ì‹œ ë¬¸ì œ í•´ê²°ë¨
```

### **5. Prometheus ê¸°ë³¸ ì„¤ì •ê°’ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/f7f31a41-c2da-4d04-8b08-d5b9c9b1fc7c/image.png)

### **6. Service Discoveryë¡œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ëŒ€ìƒ íƒì§€**
![](https://velog.velcdn.com/images/tlsalswls123/post/ae7921dc-5609-4077-a4aa-4d4c9b1e96fd/image.png)

**ì‹¤ì œë¡œ íƒì§€ëœ ëŒ€ìƒì€ Targets í™”ë©´ì— í‘œì‹œë¨**
![](https://velog.velcdn.com/images/tlsalswls123/post/59da9cd0-32b2-434f-bba4-3cd2dc67e809/image.png)
- ex. `cilium-agent`ì˜ metric exporter â†’ `http://192.168.10.102:9962/metrics`

### **7. Grafanaì˜ ë°ì´í„° ì†ŒìŠ¤ ì„¤ì •**

- GrafanaëŠ” ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ **Prometheus ì„œë¹„ìŠ¤ëª…**(`prometheus:9090`)ì„ ë°ì´í„° ì†ŒìŠ¤ë¡œ ì„¤ì •
- Grafana íŒŒë“œê°€ `prometheus` ì„œë¹„ìŠ¤ì˜ 9090 í¬íŠ¸ë¡œ ì—°ê²°í•˜ì—¬ ë©”íŠ¸ë¦­ì„ ê°€ì ¸ì˜´

![](https://velog.velcdn.com/images/tlsalswls123/post/b5c88983-6a1e-4a73-8d1e-5ae1e26b7517/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/d570f88b-ec6f-4999-97dd-21d7d80f8a36/image.png)

### **8. Serviceì™€ Endpoints í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
grafana      NodePort   10.96.169.141   <none>        3000:30002/TCP   42m
prometheus   NodePort   10.96.253.138   <none>        9090:30001/TCP   42m
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc,ep -n cilium-monitoring
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                 TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
service/grafana      NodePort   10.96.169.141   <none>        3000:30002/TCP   44m
service/prometheus   NodePort   10.96.253.138   <none>        9090:30001/TCP   44m

NAME                   ENDPOINTS           AGE
endpoints/grafana      172.20.1.207:3000   44m
endpoints/prometheus   172.20.2.76:9090    44m
```

- grafana â†’ `172.20.1.207:3000`
- prometheus â†’ `172.20.2.76:9090`

### **9. ê¸°ë³¸ Grafana ëŒ€ì‹œë³´ë“œ í™•ì¸**

**ConfigMapì— ì‚¬ì „ ì£¼ì…(pre-loading)ëœ 4ê°œì˜ ëŒ€ì‹œë³´ë“œ ìë™ ë“±ë¡**
![](https://velog.velcdn.com/images/tlsalswls123/post/fee6691e-0f8b-47ed-b893-e00738b319d7/image.png)

### **10. Cilium Metrics ëŒ€ì‹œë³´ë“œ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/cd128386-4fc4-4913-8ce6-16cfc580cccf/image.png)

### **11. PromQL ì¿¼ë¦¬ ì´í•´**

**(1) map ops (average node) íŒ¨ë„ ë¶„ì„**
![](https://velog.velcdn.com/images/tlsalswls123/post/a31924c7-6e46-4ccc-9248-10a20f33ce9d/image.png)

**metrics browser ë‚´ìš©**

```bash
topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium", pod=~"$pod"}[5m])) by (pod, map_name, operation))
```

**(2) Prometheusì—ì„œ ì¿¼ë¦¬ í•´ë³´ë©´ì„œ ì´í•´í•˜ê¸°**

```bash
cilium_bpf_map_ops_total
```
![](https://velog.velcdn.com/images/tlsalswls123/post/87773e58-c1b5-4a9a-8f4b-5c5a19b7191e/image.png)

**ìµœê·¼ 5ë¶„ ê°„ì˜ ë°ì´í„°ë¡œ ì¦ê°€ìœ¨ ê³„ì‚°**

```bash
rate(cilium_bpf_map_ops_total{k8s_app="cilium"}[5m])
```
![](https://velog.velcdn.com/images/tlsalswls123/post/50db9dfb-8437-4c66-abf5-a980f204df28/image.png)

**ì—¬ëŸ¬ ì‹œê³„ì—´(metric series)ì˜ ê°’ì˜ í‰ê· **

```bash
avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium"}[5m])) by (pod, map_name, operation)
```
![](https://velog.velcdn.com/images/tlsalswls123/post/c8971279-7670-4471-8afe-49e6065008ab/image.png)

**ì§‘ê³„ í•¨ìˆ˜ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì–´ë–¤ ë ˆì´ë¸”(label)ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í™”í• ì§€ë¥¼ ì§€ì •í•˜ëŠ” ê·¸ë£¹í•‘**

```bash
avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium"}[5m])) by (pod)
```
![](https://velog.velcdn.com/images/tlsalswls123/post/c27a915a-8cb4-4186-ae68-960b4ba7c467/image.png)

```bash
avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium"}[5m])) by (pod, map_name, operation)
```
![](https://velog.velcdn.com/images/tlsalswls123/post/dbb46b82-6dc8-42b1-a815-b32493a34dd5/image.png)

**ì‹œê³„ì—´ ì¤‘ì—ì„œ ê°€ì¥ í° kê°œë¥¼ ì„ íƒ**

```bash
topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium"}[5m]))) by (pod, map_name, operation)
```
![](https://velog.velcdn.com/images/tlsalswls123/post/1405a6f6-908a-4af5-beee-f2a0036886c5/image.png)

### **12. Grafana ë³€ìˆ˜**
```bash
topk(5, avg(rate(cilium_bpf_map_ops_total{k8s_app="cilium", pod=~"$pod"}[5m])) by (pod, map_name, operation))
```

**pod=~"`$pod`" ë³€ìˆ˜ ì‚¬ìš©**
![](https://velog.velcdn.com/images/tlsalswls123/post/d19c1b02-62b4-4bee-8760-bd58f68c6551/image.png)
```bash
label_values(cilium_version, pod)
```

**Prometheusì—ì„œ ì¿¼ë¦¬**
![](https://velog.velcdn.com/images/tlsalswls123/post/6dc44326-b32b-471a-bd9a-4f4d5a1ea01c/image.png)

### **13. Hubble ëŒ€ì‹œë³´ë“œ**
General Processing, Network, Network Policy, HTTP, DNS
![](https://velog.velcdn.com/images/tlsalswls123/post/7a3893f5-a571-4888-9f98-60aa3f8a36c3/image.png)

---

## **âš™ï¸ Cilium Metrics ì„¤ì • ë° ìˆ˜ì§‘ ë°©ë²•**

### **1. Cilium Metrics Annotations í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl describe pod -n kube-system -l k8s-app=cilium | grep prometheus
```

âœ…Â **ì¶œë ¥**

```bash
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true
      Message:   ved:unknown\"  destination_label:\"reserved:host\"  destination_label:\"reserved:remote-node\"  destination_label:\"k8s:app=prometheus\",destination_label:\"k8s:k8s-app=kube-dns\"  destination_port:\"53\",source_fqdn:\"*.cluster.local*\",destination_fqdn:\"*.cluster.local*\"}" buffer_size=4095 number_of_flows=17011 subsys=hubble took=1h4m50.122419715s whitelist="{source_pod:\"default/\"  reply:false,destination_pod:\"default/\"  reply:false}"
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true
                      prometheus.io/port: 9962
                      prometheus.io/scrape: true
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl describe pod -n kube-system -l name=cilium-operator | grep prometheus
```

âœ…Â **ì¶œë ¥**

```bash
Annotations:          prometheus.io/port: 9963
                      prometheus.io/scrape: true
```

### **2. Prometheus Service Discoveryë¡œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘**

`cilium-agent` â†’ í¬íŠ¸ **9962**, `cilium-operator` â†’ í¬íŠ¸ **9963** ì—ì„œ ë©”íŠ¸ë¦­ì„ ë…¸ì¶œ
![](https://velog.velcdn.com/images/tlsalswls123/post/3ea5c8d8-c124-4e48-918f-75d7c222ce8d/image.png)

### **3. Prometheus ConfigMap ì„¤ì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe cm -n cilium-monitoring prometheus
```

âœ…Â **ì¶œë ¥**

```bash
...
  # https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml#L156
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: (.+):(?:\d+);(\d+)
        replacement: ${1}:${2}
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod
      - source_labels: [__meta_kubernetes_pod_container_port_number]
        action: keep
        regex: \d+
...
```

---

## **ğŸ’¾ Hubble Metrics ì„¤ì • ë° ìˆ˜ì§‘ ë°©ë²•**

### **1. hubble-metrics í—¤ë“œë¦¬ìŠ¤ ì„œë¹„ìŠ¤ ìƒì„± í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc -n kube-system hubble-metrics
```

âœ…Â **ì¶œë ¥**

```bash
NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE
hubble-metrics   ClusterIP   None         <none>        9965/TCP   19h
```

### **2. hubble-metrics ì„œë¹„ìŠ¤ ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kc describe svc -n kube-system hubble-metrics
```

âœ…Â **ì¶œë ¥**

```bash
Name:                     hubble-metrics
Namespace:                kube-system
Labels:                   app.kubernetes.io/managed-by=Helm
                          app.kubernetes.io/name=hubble
                          app.kubernetes.io/part-of=cilium
                          k8s-app=hubble
Annotations:              meta.helm.sh/release-name: cilium
                          meta.helm.sh/release-namespace: kube-system
                          prometheus.io/port: 9965
                          prometheus.io/scrape: true
Selector:                 k8s-app=cilium
Type:                     ClusterIP
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       None
IPs:                      None
Port:                     hubble-metrics  9965/TCP
TargetPort:               hubble-metrics/TCP
Endpoints:                192.168.10.101:9965,192.168.10.102:9965,192.168.10.100:9965
Session Affinity:         None
Internal Traffic Policy:  Cluster
Events:                   <none>
```

---

## **ğŸ“¡ L7 í”„ë¡œí† ì½œ ê°€ì‹œí™”**

### **1. L7 ë„¤íŠ¸ì›Œí¬ ì •ì±…ì˜ ì˜ë¯¸**

- L7 ë„¤íŠ¸ì›Œí¬ ì •ì±…ì€ **ê°€ì‹œì„±(Visibility)** ì„ ì œê³µí•˜ê³  ë™ì‹œì— **íŠ¸ë˜í”½ ì œì–´** ê¸°ëŠ¥ì„ ìˆ˜í–‰í•¨
- DNS ê·œì¹™ê³¼ HTTP ê·œì¹™ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ ì„¤ì • ê°€ëŠ¥
- ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” íŠ¸ë˜í”½ì€ ì°¨ë‹¨(Drop)ë¨

### **2. default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ Podì˜ Egress íŠ¸ë˜í”½ ì œì–´**

- `default` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìˆëŠ” **ëª¨ë“  Pod** ëŒ€ìƒìœ¼ë¡œ **egress ì •ì±…** ì ìš©
- **DNS í¬íŠ¸(53)** ì— ëŒ€í•´ ëª¨ë“  ë„ë©”ì¸ ì¡°íšŒ í—ˆìš© (`matchPattern: *`)
- **HTTP í¬íŠ¸(80, 8080)** ë¡œ default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ë‹¤ë¥¸ Podë¡œì˜ ìš”ì²­ í—ˆìš©
- L7 ê°€ì‹œì„±ì„ ìœ„í•´ `http: [{}]` ê·œì¹™ ì„¤ì •

### **3. L7 ì •ì±… ë°°í¬**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat <<EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: "l7-visibility"
spec:
  endpointSelector:
    matchLabels:
      "k8s:io.kubernetes.pod.namespace": default  # default ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì•ˆì˜ ëª¨ë“  Podì— ëŒ€í•´ egress ì •ì±…ì´ ì ìš©
  egress:
  - toPorts:
    - ports:
      - port: "53"
        protocol: ANY  # TCP, UDP ë‘˜ ë‹¤ í—ˆìš©
      rules:
        dns:
        - matchPattern: "*"  # ëª¨ë“  ë„ë©”ì¸ ì¡°íšŒ í—ˆìš©, L7 ê°€ì‹œì„± í™œì„±í™”
  - toEndpoints:
    - matchLabels:
        "k8s:io.kubernetes.pod.namespace": default
    toPorts:
    - ports:
      - port: "80"  # default ë‹¤ë¥¸ íŒŒë“œì˜ HTTP TCP 80 ìš”ì²­ í—ˆìš©
        protocol: TCP
      - port: "8080"  # default ë‹¤ë¥¸ íŒŒë“œì˜ HTTP TCP 8080 ìš”ì²­ í—ˆìš©
        protocol: TCP
      rules:
        http: [{}]  # ëª¨ë“  HTTP ìš”ì²­ì„ í—ˆìš©, L7 ê°€ì‹œì„± í™œì„±í™”
EOF

# ê²°ê³¼
ciliumnetworkpolicy.cilium.io/l7-visibility created
```

**ì •ì±…ì´ ì •ìƒì ìœ¼ë¡œ ì ìš©ë¨**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get cnp -o yaml
```

âœ…Â **ì¶œë ¥**

```bash
apiVersion: v1
items:
- apiVersion: cilium.io/v2
  kind: CiliumNetworkPolicy
  metadata:
    annotations:
      kubectl.kubernetes.io/last-applied-configuration: |
        {"apiVersion":"cilium.io/v2","kind":"CiliumNetworkPolicy","metadata":{"annotations":{},"name":"l7-visibility","namespace":"default"},"spec":{"egress":[{"toPorts":[{"ports":[{"port":"53","protocol":"ANY"}],"rules":{"dns":[{"matchPattern":"*"}]}}]},{"toEndpoints":[{"matchLabels":{"k8s:io.kubernetes.pod.namespace":"default"}}],"toPorts":[{"ports":[{"port":"80","protocol":"TCP"},{"port":"8080","protocol":"TCP"}],"rules":{"http":[{}]}}]}],"endpointSelector":{"matchLabels":{"k8s:io.kubernetes.pod.namespace":"default"}}}}
    creationTimestamp: "2025-07-26T07:28:30Z"
    generation: 1
    name: l7-visibility
    namespace: default
    resourceVersion: "49854"
    uid: 5b8c403d-5fbf-48ee-b978-0dae890621ef
  spec:
    egress:
    - toPorts:
      - ports:
        - port: "53"
          protocol: ANY
        rules:
          dns:
          - matchPattern: '*'
    - toEndpoints:
      - matchLabels:
          k8s:io.kubernetes.pod.namespace: default
      toPorts:
      - ports:
        - port: "80"
          protocol: TCP
        - port: "8080"
          protocol: TCP
        rules:
          http:
          - {}
    endpointSelector:
      matchLabels:
        k8s:io.kubernetes.pod.namespace: default
  status:
    conditions:
    - lastTransitionTime: "2025-07-26T07:28:30Z"
      message: Policy validation succeeded
      status: "True"
      type: Valid
kind: List
metadata:
  resourceVersion: ""
```

### **4. L7 ì •ì±… ì ìš© í›„ í†µì‹  í™•ì¸**

curl-podì—ì„œ webpodìœ¼ë¡œ ìš”ì²­ í…ŒìŠ¤íŠ¸
![](https://velog.velcdn.com/images/tlsalswls123/post/6972dd8c-7396-4e1d-bedb-327ae7a2d8c2/image.png)
- ì •ìƒì ìœ¼ë¡œ `Hostname` ì‘ë‹µ ìˆ˜ì‹ 
- HTTP Headerì— **X-Envoy** ê°’ì´ ì¶”ê°€ë˜ì–´, ìš”ì²­ì´ **cilium-envoy** ë¥¼ ê±°ì³ê°„ ê²ƒì„ í™•ì¸

### **5. ë°˜ë³µ ìš”ì²­**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s webpod | grep Hostname; sleep 1; done'
```
![](https://velog.velcdn.com/images/tlsalswls123/post/677a0bc8-d9a6-42a1-959c-20934b680940/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/12b2ce7e-b5aa-431e-b43d-c3a1d0d4797d/image.png)

---

## **ğŸ›¡ï¸ Security Implications & ì‹¤ìŠµ**

- [https://docs.cilium.io/en/stable/observability/visibility/#security-implications](https://docs.cilium.io/en/stable/observability/visibility/#security-implications)

### **1. L7 íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì‹œ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­**

- L7 íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ì‹œ ì‚¬ìš©ì ì´ë¦„, ë¹„ë°€ë²ˆí˜¸, ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ ë“± ë¯¼ê°ì •ë³´ê°€ ë¡œê·¸ë¡œ ë…¸ì¶œë  ê°€ëŠ¥ì„± ìˆìŒ
- ë”°ë¼ì„œ, **ë³´ì•ˆ ì •ì±… ìˆ˜ë¦½ ë° ë¯¼ê°ì •ë³´ ë§ˆìŠ¤í‚¹** í•„ìš”

### **2. user_id ì¶œë ¥ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/0bdc45dc-6ba1-4336-8671-377648a9ea8a/image.png)
- Hubble UI / ëª¨ë‹ˆí„°ë§ì—ì„œ `user_id` ê°’ì´ **í‰ë¬¸ìœ¼ë¡œ ë…¸ì¶œ**ë˜ëŠ” ìƒí™©ì„ í™•ì¸
- ì´ëŠ” L7 íŠ¸ë˜í”½ ëª¨ë‹ˆí„°ë§ ê³¼ì •ì—ì„œ ë°œìƒí•œ ë¯¼ê°ì •ë³´ ë…¸ì¶œ ì‚¬ë¡€ì„

### **3. ë¯¼ê°ì •ë³´ ë¯¸ì¶œë ¥(ë§ˆìŠ¤í‚¹) ì„¤ì •**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# helm upgrade cilium cilium/cilium --namespace kube-system --reuse-values \
  --set extraArgs="{--hubble-redact-enabled,--hubble-redact-http-urlquery}"
```

âœ…Â **ì¶œë ¥**

```bash
Release "cilium" has been upgraded. Happy Helming!
NAME: cilium
LAST DEPLOYED: Sat Jul 26 16:55:55 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 3
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is 1.17.6.

For any further help, visit https://docs.cilium.io/en/v1.17/gettinghelp
```

Hubble ë¡œê·¸ì— ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë° ë¯¼ê°ì •ë³´(user_id ë“±) ê°€ ë” ì´ìƒ ì¶œë ¥ë˜ì§€ ì•ŠìŒ
![](https://velog.velcdn.com/images/tlsalswls123/post/bc9406d9-f97c-4000-a8ee-44589d459f78/image.png)

