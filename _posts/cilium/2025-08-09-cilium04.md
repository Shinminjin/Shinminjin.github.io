---
title: Cilium 4ì£¼ì°¨ ì •ë¦¬
date: 2025-08-09 22:30:00 +0900
categories: [Cilium]
tags: [Cilium]
---

## **ğŸ”§ ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±**
![](https://velog.velcdn.com/images/tlsalswls123/post/71d7188d-4f7f-4375-b57b-47643435f01d/image.png)

### **1. ë„¤íŠ¸ì›Œí¬ êµ¬ì¡° ë³€í™”**

- ì§€ë‚œ ì£¼ ì‹¤ìŠµì—ì„œëŠ” ëª¨ë“  k8s ë…¸ë“œê°€ ë™ì¼ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì— ì¡´ì¬
- ë³€ê²½ ì§€ì 
    - ì»¨íŠ¸ë¡¤í”Œë ˆì¸(`192.168.10.100`), ì›Œì»¤ë…¸ë“œ1(`192.168.10.101`) â†’ **`192.168.10.0/24`**
    - ì›Œì»¤ë…¸ë“œ0(`192.168.20.100`) â†’ **`192.168.20.0/24`**
- ì„œë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ê°„ í†µì‹ ì„ ìœ„í•´ ë¼ìš°í„°(eth1: `192.168.10.200`, eth2: `192.168.20.200`) ì‚¬ìš©
- ë¼ìš°í„°ì—ëŠ” loopback ì¸í„°í˜ì´ìŠ¤(loop1, loop2)ì™€ IP Forward í™œì„±í™”

### **2. í´ëŸ¬ìŠ¤í„° êµ¬ì„± ë° Pod CIDR ì„¤ì •**

- **Cilium Cluster Scope** IPAM ì‚¬ìš©

```bash
--set ipam.mode="cluster-pool" \
--set ipam.operator.clusterPoolIPv4PodCIDRList={"172.20.0.0/16"} \
--set ipv4NativeRoutingCIDR=172.20.0.0/16
```

- ë…¸ë“œë³„ í• ë‹¹ëœ Pod CIDR
    - k8s-ctr: `172.20.0.0/24`
    - k8s-w1: `172.20.1.0/24`
    - k8s-w0: `172.20.2.0/24`

### **3. VirtualBox IP ëŒ€ì—­ ì œí•œ ë¬¸ì œ í•´ê²°**

```bash
curl -O https://raw.githubusercontent.com/gasida/vagrant-lab/refs/heads/main/cilium-study/4w/Vagrantfile

vagrant up
```

**ğŸ“¢ ì˜¤ë¥˜ ë°œìƒ**

```bash
...
==> router: Cloning VM...
==> router: Matching MAC address for NAT networking...
==> router: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> router: Setting the name of the VM: router
==> router: Clearing any previously set network interfaces...
The IP address configured for the host-only network is not within the
allowed ranges. Please update the address used to be within the allowed
ranges and run the command again.

  Address: 192.168.20.200
  Ranges: 192.168.10.0/24

Valid ranges can be modified in the /etc/vbox/networks.conf file. For
more information including valid format see:

  https://www.virtualbox.org/manual/ch06.html#network_hostonly
```

- **ì˜¤ë¥˜ ì›ì¸**: `192.168.20.200`ì´ VirtualBox host-only ë„¤íŠ¸ì›Œí¬ í—ˆìš© ë²”ìœ„ ë°–
- **í•´ê²° ë°©ë²•**
  - `/etc/vbox/networks.conf` í¸ì§‘
  - í—ˆìš© ë²”ìœ„ ì¶”ê°€
    - `* 192.168.0.0/16`
  - `vagrant halt` í›„ `vagrant up` ì¬ì‹¤í–‰
    

### **4. Vagrant ê¸°ë°˜ k8s ì‹¤ìŠµ í™˜ê²½ VM ë¶€íŒ… ë° ì´ˆê¸° ì„¤ì •**

```bash
vagrant up
```

âœ…Â **ì¶œë ¥**

```bash
Bringing machine 'k8s-ctr' up with 'virtualbox' provider...
Bringing machine 'k8s-w1' up with 'virtualbox' provider...
Bringing machine 'router' up with 'virtualbox' provider...
Bringing machine 'k8s-w0' up with 'virtualbox' provider...
==> k8s-ctr: Cloning VM...
==> k8s-ctr: Matching MAC address for NAT networking...
==> k8s-ctr: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-ctr: Setting the name of the VM: k8s-ctr
==> k8s-ctr: Clearing any previously set network interfaces...
==> k8s-ctr: Preparing network interfaces based on configuration...
    k8s-ctr: Adapter 1: nat
    k8s-ctr: Adapter 2: hostonly
==> k8s-ctr: Forwarding ports...
    k8s-ctr: 22 (guest) => 60000 (host) (adapter 1)
==> k8s-ctr: Running 'pre-boot' VM customizations...
==> k8s-ctr: Booting VM...
==> k8s-ctr: Waiting for machine to boot. This may take a few minutes...
    k8s-ctr: SSH address: 127.0.0.1:60000
    k8s-ctr: SSH username: vagrant
    k8s-ctr: SSH auth method: private key
    k8s-ctr: 
    k8s-ctr: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-ctr: this with a newly generated keypair for better security.
    k8s-ctr: 
    k8s-ctr: Inserting generated public key within guest...
    k8s-ctr: Removing insecure key from the guest if it's present...
    k8s-ctr: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-ctr: Machine booted and ready!
==> k8s-ctr: Checking for guest additions in VM...
==> k8s-ctr: Setting hostname...
==> k8s-ctr: Configuring and enabling network interfaces...
==> k8s-ctr: Running provisioner: shell...
    k8s-ctr: Running: /tmp/vagrant-shell20250807-101867-bkdz3.sh
    k8s-ctr: >>>> Initial Config Start <<<<
    k8s-ctr: [TASK 1] Setting Profile & Bashrc
    k8s-ctr: [TASK 2] Disable AppArmor
    k8s-ctr: [TASK 3] Disable and turn off SWAP
    k8s-ctr: [TASK 4] Install Packages
    k8s-ctr: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-ctr: [TASK 6] Install Packages & Helm
    k8s-ctr: >>>> Initial Config End <<<<
==> k8s-ctr: Running provisioner: shell...
    k8s-ctr: Running: /tmp/vagrant-shell20250807-101867-7y47ad.sh
    k8s-ctr: >>>> K8S Controlplane config Start <<<<
    k8s-ctr: [TASK 1] Initial Kubernetes
    k8s-ctr: [TASK 2] Setting kube config file
    k8s-ctr: [TASK 3] Source the completion
    k8s-ctr: [TASK 4] Alias kubectl to k
    k8s-ctr: [TASK 5] Install Kubectx & Kubens
    k8s-ctr: [TASK 6] Install Kubeps & Setting PS1
    k8s-ctr: [TASK 7] Install Cilium CNI
    k8s-ctr: [TASK 8] Install Cilium / Hubble CLI
    k8s-ctr: cilium
    k8s-ctr: hubble
    k8s-ctr: [TASK 9] Remove node taint
    k8s-ctr: node/k8s-ctr untainted
    k8s-ctr: [TASK 10] local DNS with hosts file
    k8s-ctr: [TASK 11] Dynamically provisioning persistent local storage with Kubernetes
    k8s-ctr: [TASK 12] Install Prometheus & Grafana
    k8s-ctr: [TASK 13] Install Metrics-server
    k8s-ctr: [TASK 14] Install k9s
    k8s-ctr: >>>> K8S Controlplane Config End <<<<
==> k8s-ctr: Running provisioner: shell...
    k8s-ctr: Running: /tmp/vagrant-shell20250807-101867-ret6h0.sh
    k8s-ctr: >>>> Route Add Config Start <<<<
    k8s-ctr: >>>> Route Add Config End <<<<
==> k8s-w1: Cloning VM...
==> k8s-w1: Matching MAC address for NAT networking...
==> k8s-w1: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-w1: Setting the name of the VM: k8s-w1
==> k8s-w1: Clearing any previously set network interfaces...
==> k8s-w1: Preparing network interfaces based on configuration...
    k8s-w1: Adapter 1: nat
    k8s-w1: Adapter 2: hostonly
==> k8s-w1: Forwarding ports...
    k8s-w1: 22 (guest) => 60001 (host) (adapter 1)
==> k8s-w1: Running 'pre-boot' VM customizations...
==> k8s-w1: Booting VM...
==> k8s-w1: Waiting for machine to boot. This may take a few minutes...
    k8s-w1: SSH address: 127.0.0.1:60001
    k8s-w1: SSH username: vagrant
    k8s-w1: SSH auth method: private key
    k8s-w1: 
    k8s-w1: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-w1: this with a newly generated keypair for better security.
    k8s-w1: 
    k8s-w1: Inserting generated public key within guest...
    k8s-w1: Removing insecure key from the guest if it's present...
    k8s-w1: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-w1: Machine booted and ready!
==> k8s-w1: Checking for guest additions in VM...
==> k8s-w1: Setting hostname...
==> k8s-w1: Configuring and enabling network interfaces...
==> k8s-w1: Running provisioner: shell...
    k8s-w1: Running: /tmp/vagrant-shell20250807-101867-mkfn7y.sh
    k8s-w1: >>>> Initial Config Start <<<<
    k8s-w1: [TASK 1] Setting Profile & Bashrc
    k8s-w1: [TASK 2] Disable AppArmor
    k8s-w1: [TASK 3] Disable and turn off SWAP
    k8s-w1: [TASK 4] Install Packages
    k8s-w1: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-w1: [TASK 6] Install Packages & Helm
    k8s-w1: >>>> Initial Config End <<<<
==> k8s-w1: Running provisioner: shell...
    k8s-w1: Running: /tmp/vagrant-shell20250807-101867-nsboky.sh
    k8s-w1: >>>> K8S Node config Start <<<<
    k8s-w1: [TASK 1] K8S Controlplane Join
    k8s-w1: >>>> K8S Node config End <<<<
==> k8s-w1: Running provisioner: shell...
    k8s-w1: Running: /tmp/vagrant-shell20250807-101867-ub8q45.sh
    k8s-w1: >>>> Route Add Config Start <<<<
    k8s-w1: >>>> Route Add Config End <<<<
==> router: Cloning VM...
==> router: Matching MAC address for NAT networking...
==> router: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> router: Setting the name of the VM: router
==> router: Clearing any previously set network interfaces...
==> router: Preparing network interfaces based on configuration...
    router: Adapter 1: nat
    router: Adapter 2: hostonly
    router: Adapter 3: hostonly
==> router: Forwarding ports...
    router: 22 (guest) => 60009 (host) (adapter 1)
==> router: Running 'pre-boot' VM customizations...
==> router: Booting VM...
==> router: Waiting for machine to boot. This may take a few minutes...
    router: SSH address: 127.0.0.1:60009
    router: SSH username: vagrant
    router: SSH auth method: private key
    router: 
    router: Vagrant insecure key detected. Vagrant will automatically replace
    router: this with a newly generated keypair for better security.
    router: 
    router: Inserting generated public key within guest...
    router: Removing insecure key from the guest if it's present...
    router: Key inserted! Disconnecting and reconnecting using new SSH key...
==> router: Machine booted and ready!
==> router: Checking for guest additions in VM...
==> router: Setting hostname...
==> router: Configuring and enabling network interfaces...
==> router: Running provisioner: shell...
    router: Running: /tmp/vagrant-shell20250807-101867-8m4vi7.sh
    router: >>>> Initial Config Start <<<<
    router: [TASK 0] Setting eth2
    router: [TASK 1] Setting Profile & Bashrc
    router: [TASK 2] Disable AppArmor
    router: [TASK 3] Add Kernel setting - IP Forwarding
    router: [TASK 4] Setting Dummy Interface
    router: [TASK 5] Install Packages
    router: [TASK 6] Install Apache
    router: >>>> Initial Config End <<<<
==> k8s-w0: Cloning VM...
==> k8s-w0: Matching MAC address for NAT networking...
==> k8s-w0: Checking if box 'bento/ubuntu-24.04' version '202502.21.0' is up to date...
==> k8s-w0: Setting the name of the VM: k8s-w0
==> k8s-w0: Clearing any previously set network interfaces...
==> k8s-w0: Preparing network interfaces based on configuration...
    k8s-w0: Adapter 1: nat
    k8s-w0: Adapter 2: hostonly
==> k8s-w0: Forwarding ports...
    k8s-w0: 22 (guest) => 60010 (host) (adapter 1)
==> k8s-w0: Running 'pre-boot' VM customizations...
==> k8s-w0: Booting VM...
==> k8s-w0: Waiting for machine to boot. This may take a few minutes...
    k8s-w0: SSH address: 127.0.0.1:60010
    k8s-w0: SSH username: vagrant
    k8s-w0: SSH auth method: private key
    k8s-w0: 
    k8s-w0: Vagrant insecure key detected. Vagrant will automatically replace
    k8s-w0: this with a newly generated keypair for better security.
    k8s-w0: 
    k8s-w0: Inserting generated public key within guest...
    k8s-w0: Removing insecure key from the guest if it's present...
    k8s-w0: Key inserted! Disconnecting and reconnecting using new SSH key...
==> k8s-w0: Machine booted and ready!
==> k8s-w0: Checking for guest additions in VM...
==> k8s-w0: Setting hostname...
==> k8s-w0: Configuring and enabling network interfaces...
==> k8s-w0: Running provisioner: shell...
    k8s-w0: Running: /tmp/vagrant-shell20250807-101867-5qlp47.sh
    k8s-w0: >>>> Initial Config Start <<<<
    k8s-w0: [TASK 1] Setting Profile & Bashrc
    k8s-w0: [TASK 2] Disable AppArmor
    k8s-w0: [TASK 3] Disable and turn off SWAP
    k8s-w0: [TASK 4] Install Packages
    k8s-w0: [TASK 5] Install Kubernetes components (kubeadm, kubelet and kubectl)
    k8s-w0: [TASK 6] Install Packages & Helm
    k8s-w0: >>>> Initial Config End <<<<
==> k8s-w0: Running provisioner: shell...
    k8s-w0: Running: /tmp/vagrant-shell20250807-101867-vdcosy.sh
    k8s-w0: >>>> K8S Node config Start <<<<
    k8s-w0: [TASK 1] K8S Controlplane Join
    k8s-w0: >>>> K8S Node config End <<<<
==> k8s-w0: Running provisioner: shell...
    k8s-w0: Running: /tmp/vagrant-shell20250807-101867-53icua.sh
    k8s-w0: >>>> Route Add Config Start <<<<
    k8s-w0: >>>> Route Add Config End <<<<
```

### **5. ì»¨íŠ¸ë¡¤í”Œë ˆì¸ SSH ì ‘ì†**

```bash
vagrant ssh k8s-ctr
```

âœ…Â **ì¶œë ¥**

```bash

Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-53-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/pro

 System information as of Thu Aug  7 11:32:20 PM KST 2025

  System load:           0.5
  Usage of /:            29.6% of 30.34GB
  Memory usage:          49%
  Swap usage:            0%
  Processes:             216
  Users logged in:       0
  IPv4 address for eth0: 10.0.2.15
  IPv6 address for eth0: fd17:625c:f037:2:a00:27ff:fe6b:69c9

This system is built by the Bento project by Chef Software
More information can be found at https://github.com/chef/bento

Use of this system is acceptance of the OS vendor EULA and License Agreements.
(âˆ|HomeLab:N/A) root@k8s-ctr:~# 
```

### **6. k9s ì‹¤í–‰**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k9s
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/ecde9e23-4063-4c79-9758-cf4793ccf37a/image.png)

### **7. ì›Œì»¤ë…¸ë“œ ë° ë¼ìš°í„° ì›ê²© ì ‘ì† í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w0 hostname
Warning: Permanently added 'k8s-w0' (ED25519) to the list of known hosts.
k8s-w0

(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@k8s-w1 hostname
Warning: Permanently added 'k8s-w1' (ED25519) to the list of known hosts.
k8s-w1

(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh -o StrictHostKeyChecking=no vagrant@router hostname
Warning: Permanently added 'router' (ED25519) to the list of known hosts.
router
```

### **8. Cilium Pod CIDR í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumnode -o json | grep podCIDRs -A2
```

âœ…Â **ì¶œë ¥**

```bash
                    "podCIDRs": [
                        "172.20.0.0/24"
                    ],
--
                    "podCIDRs": [
                        "172.20.2.0/24"
                    ],
--
                    "podCIDRs": [
                        "172.20.1.0/24"
                    ],
```

- Cilium Cluster-Scope IPAMì—ì„œ ê° ë…¸ë“œë³„ Pod CIDR í• ë‹¹ í™•ì¸

---

## **ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸**

### **1. ë…¸ë“œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get node -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME      STATUS   ROLES           AGE     VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-ctr   Ready    control-plane   11m     v1.33.2   192.168.10.100   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w0    Ready    <none>          5m9s    v1.33.2   192.168.20.100   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w1    Ready    <none>          8m43s   v1.33.2   192.168.10.101   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
```

- `192.168.10.x` ëŒ€ì—­(k8s-ctr, k8s-w1)ê³¼ `192.168.20.x` ëŒ€ì—­(k8s-w0)ìœ¼ë¡œ ë¶„ë¦¬

### **2. ë¼ìš°í„° ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@router ip -br -c -4 addr
```

âœ…Â **ì¶œë ¥**

```bash
lo               UNKNOWN        127.0.0.1/8 
eth0             UP             10.0.2.15/24 metric 100 
eth1             UP             192.168.10.200/24 
eth2             UP             192.168.20.200/24 
loop1            UNKNOWN        10.10.1.200/24 
loop2            UNKNOWN        10.10.2.200/24 
```

- eth1(`192.168.10.200`), eth2(`192.168.20.200`)ê°€ ê° ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ê²Œì´íŠ¸ì›¨ì´ ì—­í•  ìˆ˜í–‰, loopback ì¸í„°í˜ì´ìŠ¤ ì¡´ì¬

### **3. ì›Œì»¤ë…¸ë“œ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@k8s-w1 ip -c -4 addr show dev eth1
```

âœ…Â **ì¶œë ¥**

```bash
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    altname enp0s8
    inet 192.168.10.101/24 brd 192.168.10.255 scope global eth1
       valid_lft forever preferred_lft forever
```

- ì›Œì»¤ë…¸ë“œ1: `eth1` â†’  `192.168.10.101/24`

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@k8s-w0 ip -c -4 addr show dev eth1
```

âœ…Â **ì¶œë ¥**

```bash
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    altname enp0s8
    inet 192.168.20.100/24 brd 192.168.20.255 scope global eth1
       valid_lft forever preferred_lft forever
```

- ì›Œì»¤ë…¸ë“œ0: `eth1` â†’ `192.168.20.100/24`

### **4. ë¼ìš°í„°ì˜ ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@router ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200 
10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200 
192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200 
192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200
```

### **5. ì»¨íŠ¸ë¡¤í”Œë ˆì¸ Static Route í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip -c route | grep static
```

âœ…Â **ì¶œë ¥**

```bash
10.10.0.0/16 via 192.168.10.200 dev eth1 proto static # ë¼ìš°í„° ë”ë¯¸ ì¸í„°í˜ì´ìŠ¤
172.20.0.0/16 via 192.168.10.200 dev eth1 proto static
192.168.20.0/24 via 192.168.10.200 dev eth1 proto static # ì›Œì»¤ë…¸ë“œ0 í†µì‹ ìš©
```

### **6. autoDirectNodeRoutes ë™ì‘ í™•ì¸**

**`--set routingMode=native --set autoDirectNodeRoutes=true`**

**(1) ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë¼ìš°íŒ…í…Œì´ë¸” í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.0.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 
172.20.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.0.253 dev cilium_host proto kernel scope link 
172.20.1.0/24 via 192.168.10.101 dev eth1 proto kernel 
192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100 
192.168.20.0/24 via 192.168.10.200 dev eth1 proto static 
```

- ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ë…¸ë“œë¼ë¦¬ë§Œ PodCIDR ìë™ ë¼ìš°íŒ… ì¶”ê°€ë¨
- ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ë…¸ë“œëŠ” ìë™ ë¼ìš°íŒ… ë¶ˆê°€
    - L3 ë„¤íŠ¸ì›Œí¬ ì¥ë¹„ì—ì„œ ë³„ë„ ë¼ìš°íŒ… í•„ìš”

**(2) ì›Œì»¤ë…¸ë“œ ë¼ìš°íŒ…í…Œì´ë¸” í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@k8s-w1 ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.0.0/24 via 192.168.10.100 dev eth1 proto kernel 
172.20.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.1.0/24 via 172.20.1.238 dev cilium_host proto kernel src 172.20.1.238 
172.20.1.238 dev cilium_host proto kernel scope link 
192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.101 
192.168.20.0/24 via 192.168.10.200 dev eth1 proto static
```

- `172.20.0.0/24 via 192.168.10.100 dev eth1 proto kernel`
- **k8s-w1**: ì»¨íŠ¸ë¡¤í”Œë ˆì¸ PodCIDR(`172.20.0.0/24`) ìë™ ë¼ìš°íŒ… ì¡´ì¬



```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# sshpass -p 'vagrant' ssh vagrant@k8s-w0 ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.0.0/16 via 192.168.20.200 dev eth1 proto static 
172.20.0.0/16 via 192.168.20.200 dev eth1 proto static 
172.20.2.0/24 via 172.20.2.13 dev cilium_host proto kernel src 172.20.2.13 
172.20.2.13 dev cilium_host proto kernel scope link 
192.168.10.0/24 via 192.168.20.200 dev eth1 proto static 
192.168.20.0/24 dev eth1 proto kernel scope link src 192.168.20.100 
```

- **k8s-w0**: ë‹¤ë¥¸ ë…¸ë“œ PodCIDR ì •ë³´ ì—†ìŒ â†’ í†µì‹  ë¶ˆê°€

### **7. í†µì‹  í™•ì¸**

**(1) ë¼ìš°í„° ë”ë¯¸ ì¸í„°í˜ì´ìŠ¤ í†µì‹  í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ping -c 1 10.10.1.200
```

âœ…Â **ì¶œë ¥**

```bash
PING 10.10.1.200 (10.10.1.200) 56(84) bytes of data.
64 bytes from 10.10.1.200: icmp_seq=1 ttl=64 time=0.949 ms

--- 10.10.1.200 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.949/0.949/0.949/0.000 ms
```

- ì»¨íŠ¸ë¡¤í”Œë ˆì¸(`k8s-ctr`)ì—ì„œ ë¼ìš°í„° ë”ë¯¸ ì¸í„°í˜ì´ìŠ¤(`10.10.1.200`)ë¡œ ping í…ŒìŠ¤íŠ¸
- ì‘ë‹µ ì •ìƒ ìˆ˜ì‹  â†’ ë¼ìš°í„°ì™€ì˜ ì—°ê²° ìƒíƒœ ì •ìƒ í™•ì¸

**(2) ì›Œì»¤ë…¸ë“œ ë¬¼ë¦¬ ì¸í„°í˜ì´ìŠ¤ í†µì‹  í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ping -c 1 192.168.20.100
```

âœ…Â **ì¶œë ¥**

```bash
PING 192.168.20.100 (192.168.20.100) 56(84) bytes of data.
64 bytes from 192.168.20.100: icmp_seq=1 ttl=63 time=2.22 ms

--- 192.168.20.100 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 2.215/2.215/2.215/0.000 ms
```

- ì»¨íŠ¸ë¡¤í”Œë ˆì¸ì—ì„œ ì›Œì»¤ë…¸ë“œ `k8s-w0`ì˜ ë¬¼ë¦¬ ì¸í„°í˜ì´ìŠ¤(`192.168.20.100`)ë¡œ ping í…ŒìŠ¤íŠ¸
- ì •ìƒ ì‘ë‹µ ìˆ˜ì‹  â†’ ì„œë¡œ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ê°„ ë¬¼ë¦¬ IP í†µì‹  ê°€ëŠ¥

**(3) ë…¸ë“œ ì¡°ì¸ ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get node -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME      STATUS   ROLES           AGE   VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME
k8s-ctr   Ready    control-plane   45m   v1.33.2   192.168.10.100   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w0    Ready    <none>          39m   v1.33.2   192.168.20.100   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
k8s-w1    Ready    <none>          42m   v1.33.2   192.168.10.101   <none>        Ubuntu 24.04.2 LTS   6.8.0-53-generic   containerd://1.7.27
```

- `k8s-w0`(192.168.20.100) í¬í•¨ ëª¨ë“  ë…¸ë“œê°€ `Ready` ìƒíƒœ
- ë¬¼ë¦¬ IP í†µì‹  ê°€ëŠ¥í•˜ë¯€ë¡œ í´ëŸ¬ìŠ¤í„° ì¡°ì¸ ì •ìƒ

**(4) L3 ì¥ë¹„ ê²½ìœ  ê²½ë¡œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# tracepath -n 192.168.20.100
```

âœ…Â **ì¶œë ¥**

```bash
 1?: [LOCALHOST]                      pmtu 1500
 1:  192.168.10.200                                        0.816ms 
 1:  192.168.10.200                                        0.546ms 
 2:  192.168.20.100                                        1.048ms reached
     Resume: pmtu 1500 hops 2 back 2
```

- `tracepath` ì‹¤í–‰ ê²°ê³¼, `192.168.20.100` ê²½ìœ  ì „ `192.168.10.200`(ë¼ìš°í„°) ê²½ìœ  í™•ì¸
- ë¼ìš°í„° â†’ ëª©ì ì§€ ë…¸ë“œë¡œ 2í™‰ ê²½ë¡œ ì •ìƒ

---

## **ğŸš¦Native Routing mode**

### **1. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webpod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: webpod
  template:
    metadata:
      labels:
        app: webpod
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - sample-app
            topologyKey: "kubernetes.io/hostname"
      containers:
      - name: webpod
        image: traefik/whoami
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: webpod
  labels:
    app: webpod
spec:
  selector:
    app: webpod
EOFype: ClusterIP0

# ê²°ê³¼
deployment.apps/webpod created
service/webpod created
```

- `webpod` Deployment 3ê°œ íŒŒë“œê°€ ì»¨íŠ¸ë¡¤í”Œë ˆì¸, w1, w0 ë…¸ë“œì— ë¶„ì‚° ë°°ì¹˜ë¨

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: curl-pod
  labels:
    app: curl
spec:
  nodeName: k8s-ctr
  containers:
  - name: curl
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOF

# ê²°ê³¼
pod/curl-pod created
```

- ì»¨íŠ¸ë¡¤í”Œë ˆì¸ ë…¸ë“œì— `curl-pod` ë°°í¬í•´ í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¤€ë¹„

### **2. ì—”ë“œí¬ì¸íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get deploy,svc,ep webpod -owide
```

âœ…Â **ì¶œë ¥**

```bash
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS   IMAGES           SELECTOR
deployment.apps/webpod   3/3     3            3           116s   webpod       traefik/whoami   app=webpod

NAME             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE    SELECTOR
service/webpod   ClusterIP   10.96.163.90   <none>        80/TCP    116s   app=webpod

NAME               ENDPOINTS                                      AGE
endpoints/webpod   172.20.0.66:80,172.20.1.126:80,172.20.2.1:80   116s
```

- `172.20.0.66`, `172.20.1.126`, `172.20.2.1` 3ê°œ íŒŒë“œ IP í™•ì¸

### **3. Cilium ì—”ë“œí¬ì¸íŠ¸ ì¡°íšŒ**

**(1) ê° íŒŒë“œì˜ Cilium ê´€ë¦¬ IP ë° Identity í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ciliumendpoints
```

âœ…Â **ì¶œë ¥**

```bash
NAME                      SECURITY IDENTITY   ENDPOINT STATE   IPV4           IPV6
curl-pod                  63446               ready            172.20.0.96    
webpod-697b545f57-fz95q   8469                ready            172.20.2.1     
webpod-697b545f57-gkvrf   8469                ready            172.20.0.66    
webpod-697b545f57-rpz7h   8469                ready            172.20.1.126
```

**(2) IP-to-Identity ë§¤í•‘ ì •ë³´ ì¡°íšŒ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg ip list
```

âœ…Â **ì¶œë ¥**

```bash
IP                  IDENTITY                                                                            SOURCE
0.0.0.0/0           reserved:world                                                                      
172.20.1.0/24       reserved:world                                                                      
172.20.2.0/24       reserved:world                                                                      
10.0.2.15/32        reserved:host                                                                       
                    reserved:kube-apiserver                                                             
172.20.0.33/32      k8s:app=grafana                                                                     custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=cilium-monitoring    
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=default                                     
                    k8s:io.kubernetes.pod.namespace=cilium-monitoring                                   
172.20.0.66/32      k8s:app=webpod                                                                      custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default              
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=default                                     
                    k8s:io.kubernetes.pod.namespace=default                                             
172.20.0.71/32      k8s:app=prometheus                                                                  custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=cilium-monitoring    
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=prometheus-k8s                              
                    k8s:io.kubernetes.pod.namespace=cilium-monitoring                                   
172.20.0.72/32      k8s:app=local-path-provisioner                                                      custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=local-path-storage   
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=local-path-provisioner-service-account      
                    k8s:io.kubernetes.pod.namespace=local-path-storage                                  
172.20.0.73/32      k8s:app.kubernetes.io/name=hubble-ui                                                custom-resource
                    k8s:app.kubernetes.io/part-of=cilium                                                
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                   
                    k8s:io.kubernetes.pod.namespace=kube-system                                         
                    k8s:k8s-app=hubble-ui                                                               
172.20.0.75/32      k8s:app.kubernetes.io/instance=metrics-server                                       custom-resource
                    k8s:app.kubernetes.io/name=metrics-server                                           
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=metrics-server                              
                    k8s:io.kubernetes.pod.namespace=kube-system                                         
172.20.0.96/32      k8s:app=curl                                                                        custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default              
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=default                                     
                    k8s:io.kubernetes.pod.namespace=default                                             
172.20.0.163/32     k8s:app.kubernetes.io/name=hubble-relay                                             custom-resource
                    k8s:app.kubernetes.io/part-of=cilium                                                
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=hubble-relay                                
                    k8s:io.kubernetes.pod.namespace=kube-system                                         
                    k8s:k8s-app=hubble-relay                                                            
172.20.0.197/32     k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          custom-resource
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=coredns                                     
                    k8s:io.kubernetes.pod.namespace=kube-system                                         
                    k8s:k8s-app=kube-dns                                                                
172.20.0.248/32     k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system          custom-resource
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=coredns                                     
                    k8s:io.kubernetes.pod.namespace=kube-system                                         
                    k8s:k8s-app=kube-dns                                                                
172.20.0.253/32     reserved:host                                                                       
                    reserved:kube-apiserver                                                             
172.20.1.126/32     k8s:app=webpod                                                                      custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default              
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=default                                     
                    k8s:io.kubernetes.pod.namespace=default                                             
172.20.1.238/32     reserved:remote-node                                                                
172.20.2.1/32       k8s:app=webpod                                                                      custom-resource
                    k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default              
                    k8s:io.cilium.k8s.policy.cluster=default                                            
                    k8s:io.cilium.k8s.policy.serviceaccount=default                                     
                    k8s:io.kubernetes.pod.namespace=default                                             
172.20.2.13/32      reserved:remote-node                                                                
192.168.10.100/32   reserved:host                                                                       
                    reserved:kube-apiserver                                                             
192.168.10.101/32   reserved:remote-node                                                                
192.168.20.100/32   reserved:remote-node    
```

**(3) ì—”ë“œí¬ì¸íŠ¸ ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg endpoint list
```

âœ…Â **ì¶œë ¥**

```bash
ENDPOINT   POLICY (ingress)   POLICY (egress)   IDENTITY   LABELS (source:key[=value])                                                         IPv6   IPv4           STATUS   
           ENFORCEMENT        ENFORCEMENT                                                                                                                            
275        Disabled           Disabled          1          k8s:node-role.kubernetes.io/control-plane                                                                 ready   
                                                           k8s:node.kubernetes.io/exclude-from-external-load-balancers                                                       
                                                           reserved:host                                                                                                     
364        Disabled           Disabled          18480      k8s:app=prometheus                                                                         172.20.0.71    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=cilium-monitoring                                  
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=prometheus-k8s                                                            
                                                           k8s:io.kubernetes.pod.namespace=cilium-monitoring                                                                 
406        Disabled           Disabled          63446      k8s:app=curl                                                                               172.20.0.96    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                            
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                                   
                                                           k8s:io.kubernetes.pod.namespace=default                                                                           
465        Disabled           Disabled          48231      k8s:app=local-path-provisioner                                                             172.20.0.72    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=local-path-storage                                 
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=local-path-provisioner-service-account                                    
                                                           k8s:io.kubernetes.pod.namespace=local-path-storage                                                                
810        Disabled           Disabled          58623      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                 172.20.0.248   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                                   
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                       
                                                           k8s:k8s-app=kube-dns                                                                                              
1203       Disabled           Disabled          58623      k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                 172.20.0.197   ready   
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=coredns                                                                   
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                       
                                                           k8s:k8s-app=kube-dns                                                                                              
1769       Disabled           Disabled          8469       k8s:app=webpod                                                                             172.20.0.66    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=default                                            
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                                   
                                                           k8s:io.kubernetes.pod.namespace=default                                                                           
2060       Disabled           Disabled          5827       k8s:app.kubernetes.io/instance=metrics-server                                              172.20.0.75    ready   
                                                           k8s:app.kubernetes.io/name=metrics-server                                                                         
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                        
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=metrics-server                                                            
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                       
2321       Disabled           Disabled          22595      k8s:app.kubernetes.io/name=hubble-ui                                                       172.20.0.73    ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                              
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                        
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-ui                                                                 
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                       
                                                           k8s:k8s-app=hubble-ui                                                                                             
2795       Disabled           Disabled          7496       k8s:app=grafana                                                                            172.20.0.33    ready   
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=cilium-monitoring                                  
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=default                                                                   
                                                           k8s:io.kubernetes.pod.namespace=cilium-monitoring                                                                 
3315       Disabled           Disabled          32707      k8s:app.kubernetes.io/name=hubble-relay                                                    172.20.0.163   ready   
                                                           k8s:app.kubernetes.io/part-of=cilium                                                                              
                                                           k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=kube-system                                        
                                                           k8s:io.cilium.k8s.policy.cluster=default                                                                          
                                                           k8s:io.cilium.k8s.policy.serviceaccount=hubble-relay                                                              
                                                           k8s:io.kubernetes.pod.namespace=kube-system                                                                       
                                                           k8s:k8s-app=hubble-relay 
```

### **4. Cilium ì„œë¹„ìŠ¤ ë¦¬ìŠ¤íŠ¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg service list
```

âœ…Â **ì¶œë ¥**

```bash
ID   Frontend                Service Type   Backend                                 
1    0.0.0.0:30003/TCP       NodePort       1 => 172.20.0.73:8081/TCP (active)      
4    10.96.67.8:80/TCP       ClusterIP      1 => 172.20.0.73:8081/TCP (active)      
5    10.96.0.10:53/TCP       ClusterIP      1 => 172.20.0.197:53/TCP (active)       
                                            2 => 172.20.0.248:53/TCP (active)       
6    10.96.0.10:53/UDP       ClusterIP      1 => 172.20.0.197:53/UDP (active)       
                                            2 => 172.20.0.248:53/UDP (active)       
7    10.96.0.10:9153/TCP     ClusterIP      1 => 172.20.0.197:9153/TCP (active)     
                                            2 => 172.20.0.248:9153/TCP (active)     
8    10.96.133.165:443/TCP   ClusterIP      1 => 172.20.0.75:10250/TCP (active)     
9    0.0.0.0:30002/TCP       NodePort       1 => 172.20.0.33:3000/TCP (active)      
12   10.96.60.80:3000/TCP    ClusterIP      1 => 172.20.0.33:3000/TCP (active)      
13   0.0.0.0:30001/TCP       NodePort       1 => 172.20.0.71:9090/TCP (active)      
16   10.96.97.168:9090/TCP   ClusterIP      1 => 172.20.0.71:9090/TCP (active)      
17   10.96.213.163:443/TCP   ClusterIP      1 => 192.168.10.100:4244/TCP (active)   
18   10.96.33.53:80/TCP      ClusterIP      1 => 172.20.0.163:4245/TCP (active)     
19   10.96.0.1:443/TCP       ClusterIP      1 => 192.168.10.100:6443/TCP (active)   
20   10.96.163.90:80/TCP     ClusterIP      1 => 172.20.0.66:80/TCP (active)        
                                            2 => 172.20.1.126:80/TCP (active)       
                                            3 => 172.20.2.1:80/TCP (active) 
```

- ì„œë¹„ìŠ¤ì˜ Frontend(ClusterIP, NodePort)ì™€ Backend íŒŒë“œ ë§¤í•‘ ì¡°íšŒ
- `webpod` ì„œë¹„ìŠ¤
    - `10.96.163.90:80/TCP` â†’ `172.20.0.66`, `172.20.1.126`, `172.20.2.1` ë°±ì—”ë“œ íŒŒë“œë¡œ ë¶„ì‚°

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   58m
webpod       ClusterIP   10.96.163.90   <none>        80/TCP    7m19s
```

### **5. BPF ë¡œë“œë°¸ëŸ°ì‹± ë§¤í•‘ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg bpf lb list | grep 10.96.163.90
```

âœ…Â **ì¶œë ¥**

```bash
10.96.163.90:80/TCP (2)        172.20.1.126:80/TCP (20) (2)                                   
10.96.163.90:80/TCP (1)        172.20.0.66:80/TCP (20) (1)                                    
10.96.163.90:80/TCP (0)        0.0.0.0:0 (20) (0) [ClusterIP, non-routable]                   
10.96.163.90:80/TCP (3)        172.20.2.1:80/TCP (20) (3)   
```

- ClusterIPì— ëŒ€í•œ BPF LB ë§¤í•‘ ì¡°íšŒ
- ê° ë°±ì—”ë“œ íŒŒë“œë¡œ ì¸ë±ìŠ¤ ê¸°ë°˜ ë¶„ì‚° ì²˜ë¦¬ í™•ì¸

### **6. BPF NAT í…Œì´ë¸” í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg bpf nat list
```

âœ…Â **ì¶œë ¥**

```bash
ICMP OUT 192.168.10.100:8403 -> 10.10.1.200:0 XLATE_SRC 192.168.10.100:8403 Created=1305sec ago NeedsCT=1
TCP IN 104.16.100.215:443 -> 10.0.2.15:42902 XLATE_DST 10.0.2.15:42902 Created=665sec ago NeedsCT=1
TCP OUT 10.0.2.15:42902 -> 104.16.100.215:443 XLATE_SRC 10.0.2.15:42902 Created=665sec ago NeedsCT=1
TCP OUT 10.0.2.15:35146 -> 3.94.224.37:443 XLATE_SRC 10.0.2.15:35146 Created=712sec ago NeedsCT=1
TCP OUT 10.0.2.15:40482 -> 98.85.153.80:443 XLATE_SRC 10.0.2.15:40482 Created=665sec ago NeedsCT=1
TCP IN 104.16.98.215:443 -> 10.0.2.15:57124 XLATE_DST 10.0.2.15:57124 Created=708sec ago NeedsCT=1
TCP OUT 10.0.2.15:49870 -> 44.208.254.194:443 XLATE_SRC 10.0.2.15:49870 Created=668sec ago NeedsCT=1
ICMP IN 192.168.20.100:0 -> 192.168.10.100:8432 XLATE_DST 192.168.10.100:8432 Created=1241sec ago NeedsCT=1
TCP IN 44.208.254.194:443 -> 10.0.2.15:49884 XLATE_DST 10.0.2.15:49884 Created=665sec ago NeedsCT=1
TCP OUT 10.0.2.15:57908 -> 3.94.224.37:443 XLATE_SRC 10.0.2.15:57908 Created=666sec ago NeedsCT=1
TCP OUT 10.0.2.15:49884 -> 44.208.254.194:443 XLATE_SRC 10.0.2.15:49884 Created=665sec ago NeedsCT=1
UDP OUT 192.168.10.100:56494 -> 192.168.20.100:44444 XLATE_SRC 192.168.10.100:56494 Created=945sec ago NeedsCT=1
TCP OUT 10.0.2.15:57888 -> 3.94.224.37:443 XLATE_SRC 10.0.2.15:57888 Created=669sec ago NeedsCT=1
UDP OUT 10.0.2.15:52293 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:52293 Created=712sec ago NeedsCT=1
TCP IN 44.208.254.194:443 -> 10.0.2.15:34700 XLATE_DST 10.0.2.15:34700 Created=710sec ago NeedsCT=1
TCP IN 192.168.10.101:10250 -> 192.168.10.100:43366 XLATE_DST 192.168.10.100:43366 Created=3613sec ago NeedsCT=1
TCP IN 3.94.224.37:443 -> 10.0.2.15:57908 XLATE_DST 10.0.2.15:57908 Created=666sec ago NeedsCT=1
UDP OUT 10.0.2.15:44980 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:44980 Created=712sec ago NeedsCT=1
UDP IN 192.168.20.100:44445 -> 192.168.10.100:56494 XLATE_DST 192.168.10.100:56494 Created=944sec ago NeedsCT=1
TCP OUT 10.0.2.15:34714 -> 44.208.254.194:443 XLATE_SRC 10.0.2.15:34714 Created=708sec ago NeedsCT=1
TCP IN 3.94.224.37:443 -> 10.0.2.15:35146 XLATE_DST 10.0.2.15:35146 Created=712sec ago NeedsCT=1
TCP OUT 10.0.2.15:49464 -> 104.16.98.215:443 XLATE_SRC 10.0.2.15:49464 Created=664sec ago NeedsCT=1
TCP OUT 10.0.2.15:40472 -> 98.85.153.80:443 XLATE_SRC 10.0.2.15:40472 Created=668sec ago NeedsCT=1
UDP OUT 10.0.2.15:51117 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:51117 Created=712sec ago NeedsCT=1
TCP OUT 192.168.10.100:36046 -> 192.168.20.100:10250 XLATE_SRC 192.168.10.100:36046 Created=3401sec ago NeedsCT=1
TCP OUT 10.0.2.15:34700 -> 44.208.254.194:443 XLATE_SRC 10.0.2.15:34700 Created=710sec ago NeedsCT=1
TCP OUT 10.0.2.15:51854 -> 98.85.153.80:443 XLATE_SRC 10.0.2.15:51854 Created=711sec ago NeedsCT=1
TCP IN 44.208.254.194:443 -> 10.0.2.15:34684 XLATE_DST 10.0.2.15:34684 Created=712sec ago NeedsCT=1
TCP IN 104.16.98.215:443 -> 10.0.2.15:49454 XLATE_DST 10.0.2.15:49454 Created=665sec ago NeedsCT=1
UDP IN 192.168.20.100:44446 -> 192.168.10.100:56494 XLATE_DST 192.168.10.100:56494 Created=944sec ago NeedsCT=1
TCP IN 44.208.254.194:443 -> 10.0.2.15:34714 XLATE_DST 10.0.2.15:34714 Created=708sec ago NeedsCT=1
TCP IN 104.16.97.215:443 -> 10.0.2.15:43064 XLATE_DST 10.0.2.15:43064 Created=708sec ago NeedsCT=1
TCP IN 98.85.153.80:443 -> 10.0.2.15:40472 XLATE_DST 10.0.2.15:40472 Created=668sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:39251 XLATE_DST 10.0.2.15:39251 Created=708sec ago NeedsCT=1
TCP OUT 192.168.10.100:43366 -> 192.168.10.101:10250 XLATE_SRC 192.168.10.100:43366 Created=3613sec ago NeedsCT=1
TCP IN 98.85.153.80:443 -> 10.0.2.15:51854 XLATE_DST 10.0.2.15:51854 Created=711sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:44980 XLATE_DST 10.0.2.15:44980 Created=712sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:52293 XLATE_DST 10.0.2.15:52293 Created=712sec ago NeedsCT=1
UDP IN 192.168.20.100:44444 -> 192.168.10.100:56494 XLATE_DST 192.168.10.100:56494 Created=945sec ago NeedsCT=1
TCP OUT 10.0.2.15:34684 -> 44.208.254.194:443 XLATE_SRC 10.0.2.15:34684 Created=712sec ago NeedsCT=1
TCP IN 3.94.224.37:443 -> 10.0.2.15:35154 XLATE_DST 10.0.2.15:35154 Created=708sec ago NeedsCT=1
TCP IN 44.208.254.194:443 -> 10.0.2.15:49870 XLATE_DST 10.0.2.15:49870 Created=668sec ago NeedsCT=1
TCP IN 98.85.153.80:443 -> 10.0.2.15:51860 XLATE_DST 10.0.2.15:51860 Created=710sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:60066 XLATE_DST 10.0.2.15:60066 Created=708sec ago NeedsCT=1
TCP OUT 10.0.2.15:43064 -> 104.16.97.215:443 XLATE_SRC 10.0.2.15:43064 Created=708sec ago NeedsCT=1
UDP OUT 10.0.2.15:60066 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:60066 Created=708sec ago NeedsCT=1
TCP IN 192.168.20.100:10250 -> 192.168.10.100:36046 XLATE_DST 192.168.10.100:36046 Created=3401sec ago NeedsCT=1
TCP IN 98.85.153.80:443 -> 10.0.2.15:40482 XLATE_DST 10.0.2.15:40482 Created=665sec ago NeedsCT=1
TCP OUT 10.0.2.15:49454 -> 104.16.98.215:443 XLATE_SRC 10.0.2.15:49454 Created=665sec ago NeedsCT=1
TCP OUT 10.0.2.15:57902 -> 3.94.224.37:443 XLATE_SRC 10.0.2.15:57902 Created=667sec ago NeedsCT=1
UDP OUT 192.168.10.100:56494 -> 192.168.20.100:44446 XLATE_SRC 192.168.10.100:56494 Created=944sec ago NeedsCT=1
UDP OUT 10.0.2.15:39251 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:39251 Created=708sec ago NeedsCT=1
UDP OUT 10.0.2.15:52382 -> 10.0.2.3:53 XLATE_SRC 10.0.2.15:52382 Created=712sec ago NeedsCT=1
TCP IN 3.94.224.37:443 -> 10.0.2.15:57902 XLATE_DST 10.0.2.15:57902 Created=667sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:52382 XLATE_DST 10.0.2.15:52382 Created=712sec ago NeedsCT=1
TCP OUT 10.0.2.15:35154 -> 3.94.224.37:443 XLATE_SRC 10.0.2.15:35154 Created=708sec ago NeedsCT=1
TCP OUT 10.0.2.15:51860 -> 98.85.153.80:443 XLATE_SRC 10.0.2.15:51860 Created=710sec ago NeedsCT=1
TCP IN 104.16.98.215:443 -> 10.0.2.15:49464 XLATE_DST 10.0.2.15:49464 Created=664sec ago NeedsCT=1
ICMP IN 10.10.1.200:0 -> 192.168.10.100:8403 XLATE_DST 192.168.10.100:8403 Created=1305sec ago NeedsCT=1
ICMP OUT 192.168.10.100:8432 -> 192.168.20.100:0 XLATE_SRC 192.168.10.100:8432 Created=1241sec ago NeedsCT=1
TCP OUT 10.0.2.15:57124 -> 104.16.98.215:443 XLATE_SRC 10.0.2.15:57124 Created=708sec ago NeedsCT=1
TCP IN 3.94.224.37:443 -> 10.0.2.15:57888 XLATE_DST 10.0.2.15:57888 Created=669sec ago NeedsCT=1
UDP IN 10.0.2.3:53 -> 10.0.2.15:51117 XLATE_DST 10.0.2.15:51117 Created=712sec ago NeedsCT=1
UDP OUT 192.168.10.100:56494 -> 192.168.20.100:44445 XLATE_SRC 192.168.10.100:56494 Created=944sec ago NeedsCT=1
```

- IN/OUT íŠ¸ë˜í”½ì— ëŒ€í•´ `XLATE_SRC`(ì†ŒìŠ¤ ë³€í™˜), `XLATE_DST`(ëª©ì ì§€ ë³€í™˜) ë§¤í•‘ ì •ë³´ ì¡°íšŒ
- ì™¸ë¶€ IP â†” ë‚´ë¶€ íŒŒë“œ/ë…¸ë“œ IP ë³€í™˜ ë‚´ì—­ í¬í•¨

### **7. í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ ë§µ í•„í„°ë§**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg map list | grep -v '0             0'
```

âœ…Â **ì¶œë ¥**

```bash
Name                           Num entries   Num errors   Cache enabled
cilium_policy_v2_01769         3             0            true
cilium_policy_v2_00406         3             0            true
cilium_ipcache_v2              22            0            true
cilium_lb4_services_v2         45            0            true
cilium_lb4_reverse_nat         20            0            true
cilium_lb4_reverse_sk          9             0            true
cilium_policy_v2_00275         2             0            true
cilium_policy_v2_00810         3             0            true
cilium_policy_v2_00465         3             0            true
cilium_policy_v2_02060         3             0            true
cilium_policy_v2_00364         3             0            true
cilium_policy_v2_03315         3             0            true
cilium_policy_v2_02321         3             0            true
cilium_policy_v2_02795         3             0            true
cilium_runtime_config           256           0            true
cilium_lxc                     13            0            true
cilium_lb4_backends_v3         16            0            true
cilium_policy_v2_01203         3             0            true
```

- ì •ì±…, IP ìºì‹œ, LB ì„œë¹„ìŠ¤, ë°±ì—”ë“œ ë“± í™œì„± ë§µ í™•ì¸ ê°€ëŠ¥

### **8. ì„œë¹„ìŠ¤ ë§µ ìƒì„¸ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system ds/cilium -- cilium-dbg map get cilium_lb4_services_v2
```

âœ…Â **ì¶œë ¥**

```bash
Key                            Value                     State   Error
10.96.60.80:3000/TCP (0)       0 1[0] (12) [0x0 0x0]             
10.0.2.15:30003/TCP (0)        0 1[0] (2) [0x42 0x0]             
10.96.0.10:53/UDP (0)          0 2[0] (6) [0x0 0x0]              
10.0.2.15:30002/TCP (1)        10 0[0] (10) [0x42 0x0]           
10.96.67.8:80/TCP (0)          0 1[0] (4) [0x0 0x0]              
10.96.0.10:53/TCP (1)          3 0[0] (5) [0x0 0x0]              
10.96.0.10:53/TCP (0)          0 2[0] (5) [0x0 0x0]              
10.0.2.15:30002/TCP (0)        0 1[0] (10) [0x42 0x0]            
10.96.163.90:80/TCP (1)        14 0[0] (20) [0x0 0x0]            
192.168.10.100:30001/TCP (1)   11 0[0] (15) [0x42 0x0]           
10.96.97.168:9090/TCP (1)      11 0[0] (16) [0x0 0x0]            
10.96.0.10:9153/TCP (2)        8 0[0] (7) [0x0 0x0]              
10.96.33.53:80/TCP (0)         0 1[0] (18) [0x0 0x0]             
192.168.10.100:30001/TCP (0)   0 1[0] (15) [0x42 0x0]            
10.96.0.1:443/TCP (0)          0 1[0] (19) [0x0 0x0]             
0.0.0.0:30002/TCP (1)          10 0[0] (9) [0x2 0x0]             
10.96.133.165:443/TCP (0)      0 1[0] (8) [0x0 0x0]              
0.0.0.0:30002/TCP (0)          0 1[0] (9) [0x2 0x0]              
10.0.2.15:30001/TCP (1)        11 0[0] (14) [0x42 0x0]           
10.96.67.8:80/TCP (1)          12 0[0] (4) [0x0 0x0]             
0.0.0.0:30003/TCP (0)          0 1[0] (1) [0x2 0x0]              
10.96.163.90:80/TCP (3)        15 0[0] (20) [0x0 0x0]            
10.96.60.80:3000/TCP (1)       10 0[0] (12) [0x0 0x0]            
0.0.0.0:30001/TCP (1)          11 0[0] (13) [0x2 0x0]            
10.96.0.10:9153/TCP (1)        7 0[0] (7) [0x0 0x0]              
10.96.163.90:80/TCP (0)        0 3[0] (20) [0x0 0x0]             
192.168.10.100:30003/TCP (0)   0 1[0] (3) [0x42 0x0]             
10.0.2.15:30001/TCP (0)        0 1[0] (14) [0x42 0x0]            
10.96.213.163:443/TCP (1)      2 0[0] (17) [0x0 0x10]            
10.96.0.1:443/TCP (1)          1 0[0] (19) [0x0 0x0]             
10.96.133.165:443/TCP (1)      9 0[0] (8) [0x0 0x0]              
10.96.0.10:53/UDP (1)          5 0[0] (6) [0x0 0x0]              
10.96.97.168:9090/TCP (0)      0 1[0] (16) [0x0 0x0]             
10.96.0.10:9153/TCP (0)        0 2[0] (7) [0x0 0x0]              
10.96.163.90:80/TCP (2)        16 0[0] (20) [0x0 0x0]            
192.168.10.100:30002/TCP (1)   10 0[0] (11) [0x42 0x0]           
10.96.33.53:80/TCP (1)         13 0[0] (18) [0x0 0x0]            
10.96.0.10:53/UDP (2)          6 0[0] (6) [0x0 0x0]              
192.168.10.100:30003/TCP (1)   12 0[0] (3) [0x42 0x0]            
10.0.2.15:30003/TCP (1)        12 0[0] (2) [0x42 0x0]            
192.168.10.100:30002/TCP (0)   0 1[0] (11) [0x42 0x0]            
0.0.0.0:30003/TCP (1)          12 0[0] (1) [0x2 0x0]             
0.0.0.0:30001/TCP (0)          0 1[0] (13) [0x2 0x0]             
10.96.213.163:443/TCP (0)      0 1[0] (17) [0x0 0x10]            
10.96.0.10:53/TCP (2)          4 0[0] (5) [0x0 0x0]
```

- `webpod` ì„œë¹„ìŠ¤ IP(`10.96.163.90:80/TCP`)ê°€ 3ê°œì˜ ë°±ì—”ë“œ íŒŒë“œë¡œ ë§¤í•‘ë˜ì–´ ìˆìŒ
- NodePort, ClusterIP, ì™¸ë¶€ ë…¸ì¶œ IPê¹Œì§€ ëª¨ë“  ë§¤í•‘ ì •ë³´ í™•ì¸ ê°€ëŠ¥

## **ğŸ“¡ í†µì‹  í™•ì¸ & í—ˆë¸”**

### **1. í†µì‹  ë¶ˆì•ˆì • í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-rpz7h
---
---
Hostname: webpod-697b545f57-rpz7h
---
```

- `curl` ëª…ë ¹ì— `--connect-timeout 1` ì˜µì…˜ì„ ì ìš©í•˜ì—¬ `webpod` ì„œë¹„ìŠ¤ í˜¸ì¶œ ì‹œ ê°„í—ì ìœ¼ë¡œ ì‘ë‹µì´ ì—†ìŒì„ í™•ì¸
- ì •ìƒ ì‘ë‹µ ì‹œ `Hostname`ì´ `webpod-697b545f57-rpz7h` ë˜ëŠ” `webpod-697b545f57-gkvrf`ë¡œ í‘œì‹œë¨

### **2. Hubble UI ì ‘ì†**
![](https://velog.velcdn.com/images/tlsalswls123/post/653c9c52-88f3-4cca-9555-af0b8db38aaa/image.png)
- ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë…¸ë“œì˜ `curl-pod`ê°€ 3ê°œ ë…¸ë“œì— ë°°í¬ëœ `webpod` ì—”ë“œí¬ì¸íŠ¸ë¡œ ìš”ì²­
- ë¼ìš°í„° ê²½ìœ  ê²½ë¡œë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´ ë¼ìš°í„°ì—ì„œ `tcpdump` ì§„í–‰ ê³„íš ìˆ˜ë¦½

### **3. webpod IP í™•ì¸ ë° ping í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export WEBPOD=$(kubectl get pod -l app=webpod --field-selector spec.nodeName=k8s-w0 -o jsonpath='{.items[0].status.podIP}')
echo $WEBPOD

# ê²°ê³¼
172.20.2.1
```

- ì›Œì»¤ë…¸ë“œ0(`k8s-w0`)ì— ë°°í¬ëœ `webpod`ì˜ IP(`172.20.2.1`) ì¶”ì¶œ í›„ `ping` ì‹œë„

```bash
root@router:~# tcpdump -i any icmp -nn
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
```

- ë¼ìš°í„°ì—ì„œ tcpdump

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- ping -c 2 -w 1 -W 1 $WEBPOD
```

âœ…Â **ì¶œë ¥**

```bash
PING 172.20.2.1 (172.20.2.1) 56(84) bytes of data.

--- 172.20.2.1 ping statistics ---
1 packets transmitted, 0 received, 100% packet loss, time 0ms

command terminated with exit code 1
```

- íŒ¨í‚· ì†ì‹¤ 100% ë°œìƒ (ì‘ë‹µ ì—†ìŒ)

### **4. ë¼ìš°í„° tcpdump ê²°ê³¼ ë¶„ì„ (ICMP)**

```bash
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
22:47:59.061351 eth1  In  IP 172.20.0.96 > 172.20.2.1: ICMP echo request, id 1155, seq 1, length 64
22:47:59.061370 eth0  Out IP 172.20.0.96 > 172.20.2.1: ICMP echo request, id 1155, seq 1, length 64
```

- `curl-pod`(172.20.0.96) â†’ `webpod`(172.20.2.1) ICMP ìš”ì²­ì´ `eth1`ë¡œ IN
- ëª©ì ì§€ê°€ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(`eth2`)ê°€ ì•„ë‹Œ ì¸í„°ë„· ì „ìš© `eth0`ìœ¼ë¡œ OUT
- **ì›ì¸**: ë¼ìš°í„° ë¼ìš°íŒ… í…Œì´ë¸”ì— `172.20.0.0/16` CIDR ê²½ë¡œ ì—†ìŒ â†’ **default route**ë¡œ ì²˜ë¦¬


```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                      READY   STATUS    RESTARTS   AGE   IP             NODE      NOMINATED NODE   READINESS GATES
curl-pod                  1/1     Running   0          22h   172.20.0.96    k8s-ctr   <none>           <none>
webpod-697b545f57-fz95q   1/1     Running   0          22h   172.20.2.1     k8s-w0    <none>           <none>
webpod-697b545f57-gkvrf   1/1     Running   0          22h   172.20.0.66    k8s-ctr   <none>           <none>
webpod-697b545f57-rpz7h   1/1     Running   0          22h   172.20.1.126   k8s-w1    <none>           <none>
```

### **5. ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
root@router:~# ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.1.0/24 dev loop1 proto kernel scope link src 10.10.1.200 
10.10.2.0/24 dev loop2 proto kernel scope link src 10.10.2.200 
192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.200 
192.168.20.0/24 dev eth2 proto kernel scope link src 192.168.20.200
```

- `172.20.x.x` ëŒ€ì—­ì— ëŒ€í•œ ê²½ë¡œ ë¯¸ë“±ë¡ í™•ì¸


```bash
root@router:~# ip route get 172.20.2.1
```

âœ…Â **ì¶œë ¥**

```bash
172.20.2.1 via 10.0.2.2 dev eth0 src 10.0.2.15 uid 0 
    cache
```

- `ip route get 172.20.2.1` ê²°ê³¼ default route(`10.0.2.2 via eth0`)ë¡œ ì „ì†¡ë¨

### **6. TCP íŠ¸ë˜í”½ ë¶„ì„**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-rpz7h
---
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
---
Hostname: webpod-697b545f57-gkvrf
---
---
Hostname: webpod-697b545f57-gkvrf
---
---
---
---
---
```

```bash
root@router:~# tcpdump -i any tcp port 80 -nn
```

âœ…Â **ì¶œë ¥**

```bash
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
23:01:08.369358 eth1  In  IP 172.20.0.96.54708 > 172.20.2.1.80: Flags [S], seq 656654546, win 64240, options [mss 1460,sackOK,TS val 677256276 ecr 0,nop,wscale 7], length 0
23:01:08.369376 eth0  Out IP 172.20.0.96.54708 > 172.20.2.1.80: Flags [S], seq 656654546, win 64240, options [mss 1460,sackOK,TS val 677256276 ecr 0,nop,wscale 7], length 0
23:01:16.429813 eth1  In  IP 172.20.0.96.37360 > 172.20.2.1.80: Flags [S], seq 1376149342, win 64240, options [mss 1460,sackOK,TS val 677264336 ecr 0,nop,wscale 7], length 0
23:01:16.429833 eth0  Out IP 172.20.0.96.37360 > 172.20.2.1.80: Flags [S], seq 1376149342, win 64240, options [mss 1460,sackOK,TS val 677264336 ecr 0,nop,wscale 7], length 0
23:01:19.444988 eth1  In  IP 172.20.0.96.37368 > 172.20.2.1.80: Flags [S], seq 1991901286, win 64240, options [mss 1460,sackOK,TS val 677267352 ecr 0,nop,wscale 7], length 0
23:01:19.445008 eth0  Out IP 172.20.0.96.37368 > 172.20.2.1.80: Flags [S], seq 1991901286, win 64240, options [mss 1460,sackOK,TS val 677267352 ecr 0,nop,wscale 7], length 0
23:01:22.461799 eth1  In  IP 172.20.0.96.41056 > 172.20.2.1.80: Flags [S], seq 958768126, win 64240, options [mss 1460,sackOK,TS val 677270368 ecr 0,nop,wscale 7], length 0
23:01:22.461831 eth0  Out IP 172.20.0.96.41056 > 172.20.2.1.80: Flags [S], seq 958768126, win 64240, options [mss 1460,sackOK,TS val 677270368 ecr 0,nop,wscale 7], length 0
23:01:24.468117 eth1  In  IP 172.20.0.96.41064 > 172.20.2.1.80: Flags [S], seq 4136195789, win 64240, options [mss 1460,sackOK,TS val 677272375 ecr 0,nop,wscale 7], length 0
23:01:24.468135 eth0  Out IP 172.20.0.96.41064 > 172.20.2.1.80: Flags [S], seq 4136195789, win 64240, options [mss 1460,sackOK,TS val 677272375 ecr 0,nop,wscale 7], length 0
23:01:26.473963 eth1  In  IP 172.20.0.96.41072 > 172.20.2.1.80: Flags [S], seq 2284309943, win 64240, options [mss 1460,sackOK,TS val 677274381 ecr 0,nop,wscale 7], length 0
23:01:26.473981 eth0  Out IP 172.20.0.96.41072 > 172.20.2.1.80: Flags [S], seq 2284309943, win 64240, options [mss 1460,sackOK,TS val 677274381 ecr 0,nop,wscale 7], length 0
23:01:28.480125 eth1  In  IP 172.20.0.96.41084 > 172.20.2.1.80: Flags [S], seq 1101677227, win 64240, options [mss 1460,sackOK,TS val 677276387 ecr 0,nop,wscale 7], length 0
23:01:28.480143 eth0  Out IP 172.20.0.96.41084 > 172.20.2.1.80: Flags [S], seq 1101677227, win 64240, options [mss 1460,sackOK,TS val 677276387 ecr 0,nop,wscale 7], length 0
23:01:32.501119 eth1  In  IP 172.20.0.96.56438 > 172.20.2.1.80: Flags [S], seq 601326350, win 64240, options [mss 1460,sackOK,TS val 677280408 ecr 0,nop,wscale 7], length 0
23:01:32.501138 eth0  Out IP 172.20.0.96.56438 > 172.20.2.1.80: Flags [S], seq 601326350, win 64240, options [mss 1460,sackOK,TS val 677280408 ecr 0,nop,wscale 7], length 0
```

- `tcpdump`ë¡œ TCP 80 í¬íŠ¸ ê´€ì°° ì‹œ SYN íŒ¨í‚·ì´ `eth1` IN â†’ `eth0` OUT
- ëª©ì ì§€ pod CIDRë¡œì˜ ê²½ë¡œ ë¶€ì¬ë¡œ ì˜ëª»ëœ ì¸í„°í˜ì´ìŠ¤ë¡œ ì†¡ì¶œë˜ëŠ” í˜„ìƒ ì¬í™•ì¸

### **7. Hubble í¬íŠ¸í¬ì›Œë”© ë° Flow ëª¨ë‹ˆí„°ë§**

**(1) í¬íŠ¸í¬ì›Œë”© ì…‹íŒ…**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium hubble port-forward&
[1] 13992
(âˆ|HomeLab:N/A) root@k8s-ctr:~# â„¹ï¸  Hubble Relay is available at 127.0.0.1:4245
```

**(2) flow ëª¨ë‹ˆí„°ë§**
![](https://velog.velcdn.com/images/tlsalswls123/post/5b9cb053-fb6f-4389-a9f6-6828ce37f102/image.png)
- `hubble observe` ê²°ê³¼ `k8s-w0` ë…¸ë“œê°€ unavailable ìƒíƒœë¡œ í‘œì‹œ
- íŠ¹ì • ì—”ë“œí¬ì¸íŠ¸ë¡œ SYNë§Œ ì „ì†¡ë˜ê³  ì‘ë‹µ(ACK)ì´ ì˜¤ì§€ ì•ŠëŠ” ì„¸ì…˜ í™•ì¸

---

## **ğŸ“¦ Overlay Network (Encapsulation) mode**

### **1. VXLAN Encapsulation ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# grep -E 'CONFIG_VXLAN=y|CONFIG_VXLAN=m|CONFIG_GENEVE=y|CONFIG_GENEVE=m|CONFIG_FIB_RULES=y' /boot/config-$(uname -r)
```

âœ…Â **ì¶œë ¥**

```bash
CONFIG_FIB_RULES=y # ì»¤ë„ì— ë‚´ì¥ë¨
CONFIG_VXLAN=m # ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©
CONFIG_GENEVE=m # ëª¨ë“ˆë¡œ ì»´íŒŒì¼ë¨ â†’ ì»¤ë„ì— ë¡œë“œí•´ì„œ ì‚¬ìš©
```

- ì»¤ë„ ì„¤ì • íŒŒì¼(`/boot/config-$(uname -r)`)ì—ì„œ `CONFIG_VXLAN=m`, `CONFIG_GENEVE=m` í™•ì¸
- Encapsulation ë°©ì‹(VXLAN, Geneve) ì§€ì› ì—¬ë¶€ ì ê²€

### **2. VXLAN ëª¨ë“ˆ ë¡œë“œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# lsmod | grep -E 'vxlan|geneve'
(âˆ|HomeLab:N/A) root@k8s-ctr:~# modprobe vxlan
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# lsmod | grep -E 'vxlan'
vxlan                 155648  0
ip6_udp_tunnel         16384  1 vxlan
udp_tunnel             32768  1 vxlan
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w0 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i sudo modprobe vxlan ; echo; done
>> node : k8s-w1 <<

>> node : k8s-w0 <<
```


```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w0 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i sudo lsmod | grep -E 'vxlan|geneve' ; echo; done
>> node : k8s-w1 <<
vxlan                 155648  0
ip6_udp_tunnel         16384  1 vxlan
udp_tunnel             32768  1 vxlan

>> node : k8s-w0 <<
vxlan                 155648  0
ip6_udp_tunnel         16384  1 vxlan
udp_tunnel             32768  1 vxlan
```

- `modprobe vxlan` ëª…ë ¹ìœ¼ë¡œ ì»¨íŠ¸ë¡¤ í”Œë ˆì¸ ë° ì›Œì»¤ ë…¸ë“œ 2ê³³ì— VXLAN ëª¨ë“ˆ ë¡œë“œ
- `lsmod`ë¡œ ë¡œë“œ ì—¬ë¶€ í™•ì¸ (`vxlan`, `ip6_udp_tunnel`, `udp_tunnel` ëª¨ë“ˆ í™œì„±í™”)

### **3. Ping í…ŒìŠ¤íŠ¸ (Native Routing ìƒíƒœ)**

**(1) ì›Œì»¤ë…¸ë“œ1ì— ë°°í¬ëœ webpod IP ì¶”ì¶œ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export WEBPOD1=$(kubectl get pod -l app=webpod --field-selector spec.nodeName=k8s-w1 -o jsonpath='{.items[0].status.podIP}')
echo $WEBPOD1

# ê²°ê³¼
172.20.1.126
```

**(2) curl-podì—ì„œ ping ìˆ˜í–‰**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- ping $WEBPOD1
```

âœ…Â **ì¶œë ¥**

```bash
PING 172.20.1.126 (172.20.1.126) 56(84) bytes of data.
64 bytes from 172.20.1.126: icmp_seq=1 ttl=62 time=0.637 ms
64 bytes from 172.20.1.126: icmp_seq=2 ttl=62 time=0.647 ms
64 bytes from 172.20.1.126: icmp_seq=3 ttl=62 time=0.438 ms
64 bytes from 172.20.1.126: icmp_seq=4 ttl=62 time=0.455 ms
64 bytes from 172.20.1.126: icmp_seq=5 ttl=62 time=0.561 ms
64 bytes from 172.20.1.126: icmp_seq=6 ttl=62 time=0.407 ms
64 bytes from 172.20.1.126: icmp_seq=7 ttl=62 time=0.367 ms
64 bytes from 172.20.1.126: icmp_seq=8 ttl=62 time=0.377 ms
64 bytes from 172.20.1.126: icmp_seq=9 ttl=62 time=0.386 ms
64 bytes from 172.20.1.126: icmp_seq=10 ttl=62 time=0.414 ms
64 bytes from 172.20.1.126: icmp_seq=11 ttl=62 time=0.368 ms
64 bytes from 172.20.1.126: icmp_seq=12 ttl=62 time=0.369 ms
64 bytes from 172.20.1.126: icmp_seq=13 ttl=62 time=0.664 ms
64 bytes from 172.20.1.126: icmp_seq=14 ttl=62 time=0.537 ms
64 bytes from 172.20.1.126: icmp_seq=15 ttl=62 time=0.387 ms
64 bytes from 172.20.1.126: icmp_seq=16 ttl=62 time=0.452 ms
64 bytes from 172.20.1.126: icmp_seq=17 ttl=62 time=0.381 ms
64 bytes from 172.20.1.126: icmp_seq=18 ttl=62 time=0.606 ms
64 bytes from 172.20.1.126: icmp_seq=19 ttl=62 time=0.975 ms
64 bytes from 172.20.1.126: icmp_seq=20 ttl=62 time=0.384 ms
64 bytes from 172.20.1.126: icmp_seq=21 ttl=62 time=0.340 ms
64 bytes from 172.20.1.126: icmp_seq=22 ttl=62 time=0.392 ms
64 bytes from 172.20.1.126: icmp_seq=23 ttl=62 time=0.490 ms
64 bytes from 172.20.1.126: icmp_seq=24 ttl=62 time=0.405 ms
64 bytes from 172.20.1.126: icmp_seq=25 ttl=62 time=0.820 ms
64 bytes from 172.20.1.126: icmp_seq=26 ttl=62 time=0.387 ms
...
```

- ì»¨íŠ¸ë¡¤í”Œë ˆì¸ê³¼ ì›Œì»¤ë…¸ë“œ1ì€ ê°™ì€ ëŒ€ì—­ì´ë¼ í†µì‹  ì •ìƒ ì‘ë‹µ

### **4. Cilium Overlay ëª¨ë“œ(VXLAN) ì „í™˜**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# helm upgrade cilium cilium/cilium --namespace kube-system --version 1.18.0 --reuse-values \
  --set routingMode=tunnel --set tunnelProtocol=vxlan \
  --set autoDirectNodeRoutes=false --set installNoConntrackIptablesRules=false
```

âœ…Â **ì¶œë ¥**

```bash
Release "cilium" has been upgraded. Happy Helming!
NAME: cilium
LAST DEPLOYED: Fri Aug  8 23:47:06 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 2
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is 1.18.0.

For any further help, visit https://docs.cilium.io/en/v1.18/gettinghelp
```

- Helm ì—…ê·¸ë ˆì´ë“œ ì‹œ `routingMode=tunnel`, `tunnelProtocol=vxlan` ì„¤ì •
- `autoDirectNodeRoutes=false`ë¡œ Direct Routing ë¹„í™œì„±í™”

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl rollout restart -n kube-system ds/cilium

# ê²°ê³¼
daemonset.apps/cilium restarted
```

- `kubectl rollout restart`ë¡œ Cilium DaemonSet ì¬ì‹œì‘

### **5. Overlay ëª¨ë“œ ì ìš© í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/264834ba-2dd2-41c8-8431-7a9c95e5f35e/image.png)

**(1) `mode=overlay-vxlan` í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium features status | grep datapath_network
```

âœ…Â **ì¶œë ¥**

```bash
Yes      cilium_feature_datapath_network                                         mode=overlay-vxlan                                1        1       1
```

**(2) `Routing: Network: Tunnel [vxlan]` ì¶œë ¥**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it -n kube-system ds/cilium -- cilium status | grep ^Routing
```

âœ…Â **ì¶œë ¥**

```bash
Routing:                 Network: Tunnel [vxlan]   Host: BPF
```

**(3) ê° ë…¸ë“œì— `cilium_vxlan` ì¸í„°í˜ì´ìŠ¤ ìƒì„± í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip -c addr show dev cilium_vxlan
```

âœ…Â **ì¶œë ¥**

```bash
26: cilium_vxlan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether 8e:c3:47:03:17:dc brd ff:ff:ff:ff:ff:ff
    inet6 fe80::8cc3:47ff:fe03:17dc/64 scope link 
       valid_lft forever preferred_lft forever
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w0 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i ip -c addr show dev cilium_vxlan ; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node : k8s-w1 <<
8: cilium_vxlan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether 2e:fb:fe:83:8f:85 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::2cfb:feff:fe83:8f85/64 scope link 
       valid_lft forever preferred_lft forever

>> node : k8s-w0 <<
8: cilium_vxlan: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN group default 
    link/ether d6:44:cc:8c:e1:ce brd ff:ff:ff:ff:ff:ff
    inet6 fe80::d444:ccff:fe8c:e1ce/64 scope link 
       valid_lft forever preferred_lft forever
```

### **6. Pod CIDR ë¼ìš°íŒ… í…Œì´ë¸” ë“±ë¡ í™•ì¸ (ì»¨íŠ¸ë¡¤ í”Œë ˆì¸)**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip -c route
```

âœ…Â **ì¶œë ¥**

```bash
default via 10.0.2.2 dev eth0 proto dhcp src 10.0.2.15 metric 100 
10.0.2.0/24 dev eth0 proto kernel scope link src 10.0.2.15 metric 100 
10.0.2.2 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.0.2.3 dev eth0 proto dhcp scope link src 10.0.2.15 metric 100 
10.10.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.0.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 
172.20.0.0/16 via 192.168.10.200 dev eth1 proto static 
172.20.0.253 dev cilium_host proto kernel scope link 
172.20.1.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 mtu 1450 
172.20.2.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 mtu 1450 
192.168.10.0/24 dev eth1 proto kernel scope link src 192.168.10.100 
192.168.20.0/24 via 192.168.10.200 dev eth1 proto static
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip -c route | grep cilium_host
```

âœ…Â **ì¶œë ¥**

```bash
172.20.0.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 
172.20.0.253 dev cilium_host proto kernel scope link 
172.20.1.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 mtu 1450 
172.20.2.0/24 via 172.20.0.253 dev cilium_host proto kernel src 172.20.0.253 mtu 1450 
```

- ê¸°ì¡´ì—ëŠ” ì—†ë˜ ë‹¤ë¥¸ ë…¸ë“œì˜ Pod CIDR(`172.20.1.0/24`, `172.20.2.0/24`) ê²½ë¡œê°€ `cilium_host` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ë“±ë¡ë¨

### **7. íŠ¹ì • Pod IP ê²½ë¡œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip route get 172.20.1.10
```

âœ…Â **ì¶œë ¥**

```bash
172.20.1.10 dev cilium_host src 172.20.0.253 uid 0 
    cache mtu 1450 
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# ip route get 172.20.2.10
```

âœ…Â **ì¶œë ¥**

```bash
172.20.2.10 dev cilium_host src 172.20.0.253 uid 0 
    cache mtu 1450
```

- `172.20.1.10`, `172.20.2.10`ì— ëŒ€í•œ ê²½ë¡œ í™•ì¸ ì‹œ `dev cilium_host` ê²½ìœ ë¡œ í†µì‹ í•¨ì„ í™•ì¸
- MTUëŠ” VXLAN í„°ë„ ì ìš©ìœ¼ë¡œ 1450ìœ¼ë¡œ ì„¤ì •

### **8. ì›Œì»¤ë…¸ë“œ ë¼ìš°íŒ… í…Œì´ë¸” ë¹„êµ**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in w1 w0 ; do echo ">> node : k8s-$i <<"; sshpass -p 'vagrant' ssh vagrant@k8s-$i ip -c route | grep cilium_host ; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node : k8s-w1 <<
172.20.0.0/24 via 172.20.1.238 dev cilium_host proto kernel src 172.20.1.238 mtu 1450 
172.20.1.0/24 via 172.20.1.238 dev cilium_host proto kernel src 172.20.1.238 
172.20.1.238 dev cilium_host proto kernel scope link 
172.20.2.0/24 via 172.20.1.238 dev cilium_host proto kernel src 172.20.1.238 mtu 1450 

>> node : k8s-w0 <<
172.20.0.0/24 via 172.20.2.13 dev cilium_host proto kernel src 172.20.2.13 mtu 1450 
172.20.1.0/24 via 172.20.2.13 dev cilium_host proto kernel src 172.20.2.13 mtu 1450 
172.20.2.0/24 via 172.20.2.13 dev cilium_host proto kernel src 172.20.2.13 
172.20.2.13 dev cilium_host proto kernel scope link
```

- ì›Œì»¤ë…¸ë“œ1, ì›Œì»¤ë…¸ë“œ0 ëª¨ë‘ ìì‹  + ë‹¤ë¥¸ ë…¸ë“œì˜ Pod CIDR ë¼ìš°íŒ… ê²½ë¡œ í¬í•¨
- `via` ë’¤ì˜ IPëŠ” ê° ë…¸ë“œ Cilium Router IPë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ

### **9. Cilium Router IP í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export CILIUMPOD0=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-ctr -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD1=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w1  -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD2=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w0  -o jsonpath='{.items[0].metadata.name}')
echo $CILIUMPOD0 $CILIUMPOD1 $CILIUMPOD2

# router ì—­í•  IPÂ í™•ì¸
kubectl exec -it $CILIUMPOD0 -n kube-system -c cilium-agent -- cilium status --all-addresses | grep router
kubectl exec -it $CILIUMPOD1 -n kube-system -c cilium-agent -- cilium status --all-addresses | grep router
kubectl exec -it $CILIUMPOD2 -n kube-system -c cilium-agent -- cilium status --all-addresses | grep router
```

âœ…Â **ì¶œë ¥**

```bash
cilium-th5dp cilium-snscc cilium-sjdzj
  172.20.0.253 (router)
  172.20.1.238 (router)
  172.20.2.13 (router)
```

- ì»¨íŠ¸ë¡¤ í”Œë ˆì¸: `172.20.0.253`, ì›Œì»¤ë…¸ë“œ1: `172.20.1.238`, ì›Œì»¤ë…¸ë“œ0: `172.20.2.13`

### **10. BPF ipcache ì •ë³´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD0 -- cilium-dbg bpf ipcache list
```

âœ…Â **ì¶œë ¥**

```bash
IP PREFIX/ADDRESS   IDENTITY
172.20.0.197/32     identity=58623 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
172.20.1.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel      
192.168.10.100/32   identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
172.20.0.71/32      identity=18480 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
172.20.0.163/32     identity=32707 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
192.168.10.101/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
192.168.20.100/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
172.20.0.33/32      identity=7496 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>             
172.20.0.96/32      identity=63446 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
172.20.0.248/32     identity=58623 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
172.20.2.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel      
172.20.0.75/32      identity=5827 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>             
172.20.0.253/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
172.20.1.238/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel      
172.20.2.1/32       identity=8469 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel   
172.20.2.13/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel      
0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
172.20.1.126/32     identity=8469 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel   
10.0.2.15/32        identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                
172.20.0.66/32      identity=8469 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>             
172.20.0.72/32      identity=48231 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>            
172.20.0.73/32      identity=22595 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD1 -- cilium-dbg bpf ipcache list
```

âœ…Â **ì¶œë ¥**

```bash
IP PREFIX/ADDRESS   IDENTITY
172.20.0.66/32      identity=8469 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.73/32      identity=22595 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.197/32     identity=58623 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.248/32     identity=58623 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.1.238/32     identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.2.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel       
192.168.20.100/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
10.0.2.15/32        identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.71/32      identity=18480 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.75/32      identity=5827 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.96/32      identity=63446 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.253/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel       
192.168.10.100/32   identity=7 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.33/32      identity=7496 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.163/32     identity=32707 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel       
172.20.1.126/32     identity=8469 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>              
172.20.2.1/32       identity=8469 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel    
192.168.10.101/32   identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.72/32      identity=48231 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.2.13/32      identity=6 encryptkey=0 tunnelendpoint=192.168.20.100 flags=hastunnel
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD2 -- cilium-dbg bpf ipcache list
```

âœ…Â **ì¶œë ¥**

```bash
IP PREFIX/ADDRESS   IDENTITY
172.20.0.72/32      identity=48231 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.248/32     identity=58623 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.2.13/32      identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.66/32      identity=8469 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.96/32      identity=63446 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.163/32     identity=32707 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.1.126/32     identity=8469 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel    
172.20.2.1/32       identity=8469 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>              
192.168.10.100/32   identity=7 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
0.0.0.0/0           identity=2 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
10.0.2.15/32        identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.71/32      identity=18480 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.73/32      identity=22595 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel       
172.20.1.238/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel       
172.20.1.0/24       identity=2 encryptkey=0 tunnelendpoint=192.168.10.101 flags=hastunnel       
192.168.20.100/32   identity=1 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none>                 
172.20.0.33/32      identity=7496 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.75/32      identity=5827 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel    
172.20.0.197/32     identity=58623 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel   
172.20.0.253/32     identity=6 encryptkey=0 tunnelendpoint=192.168.10.100 flags=hastunnel       
192.168.10.101/32   identity=6 encryptkey=0 tunnelendpoint=0.0.0.0 flags=<none> 
```

- ê° ë…¸ë“œë³„ Pod CIDRì™€ Tunnel Endpoint ë§¤í•‘ ì •ë³´ í™•ì¸
- `flags=hastunnel` í”Œë˜ê·¸ë¡œ í„°ë„ í†µì‹  ê²½ë¡œì„ì„ ì‹ë³„ ê°€ëŠ¥
- ëª¨ë“  ë…¸ë“œì—ì„œ ë‹¤ë¥¸ ë…¸ë“œ Pod CIDRê°€ Tunnel Endpointì™€ í•¨ê»˜ ë“±ë¡ë˜ì–´ ìˆìŒ

### **11. BPF socknat ë§¤í•‘ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD0 -- cilium-dbg bpf socknat list
```

âœ…Â **ì¶œë ¥**

```bash
Socket Cookie   Backend -> Frontend
59452           192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
4120            192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
55815           192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
136068          192.168.10.100:-27632 -> 10.96.213.163:-17663 (revnat=4352)   
4126            192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
55925           172.20.0.75:2600 -> 10.96.133.165:-17663 (revnat=2048)        
4202            192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
65383           192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
4562            192.168.10.100:11033 -> 10.96.0.1:-17663 (revnat=4864)        
65386           172.20.0.163:-27376 -> 10.96.33.53:20480 (revnat=4608)        
55955           172.20.0.75:2600 -> 10.96.133.165:-17663 (revnat=2048)
```

- Backend â†” Frontend NAT ë§¤í•‘ ìƒíƒœ í™•ì¸
- VXLAN í„°ë„ì„ í†µí•´ ì „ë‹¬ë˜ëŠ” ì„œë¹„ìŠ¤ íŠ¸ë˜í”½ì´ NAT í…Œì´ë¸”ì— ê¸°ë¡ë¨

## **ğŸ›œ íŒŒë“œê°„ í†µì‹  í™•ì¸**

### **1. ì „ì²´ íŒŒë“œ í†µì‹  ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-fz95q
---
Hostname: webpod-697b545f57-fz95q
```

- í´ëŸ¬ìŠ¤í„° ë‚´ `webpod` 3ê°œì™€ `curl-pod` ê°„ í†µì‹  ì •ìƒ ë™ì‘ í™•ì¸
- ëª¨ë“  Podì— ëŒ€í•´ ì •ìƒ ì‘ë‹µì´ ìˆ˜ì‹ ë¨

### **2. ì›Œì»¤ë…¸ë“œ0 ëŒ€ìƒ IP í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export WEBPOD=$(kubectl get pod -l app=webpod --field-selector spec.nodeName=k8s-w0 -o jsonpath='{.items[0].status.podIP}')
echo $WEBPOD

# ê²°ê³¼
172.20.2.1
```

### **3. Ping í…ŒìŠ¤íŠ¸ë¡œ ì—°ê²°ì„± ê²€ì¦**

**(1) `curl-pod`ì—ì„œ ì›Œì»¤ë…¸ë“œ0ì˜ `webpod`ë¡œ ping í…ŒìŠ¤íŠ¸ ìˆ˜í–‰**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- ping -c 2 -w 1 -W 1 $WEBPOD
```

âœ…Â **ì¶œë ¥**

```bash
PING 172.20.2.1 (172.20.2.1) 56(84) bytes of data.
64 bytes from 172.20.2.1: icmp_seq=1 ttl=63 time=1.25 ms

--- 172.20.2.1 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 1.246/1.246/1.246/0.000 ms
command terminated with exit code 1
```

- 0% íŒ¨í‚· ì†ì‹¤ë¡œ ì •ìƒ ì‘ë‹µ í™•ì¸ (RTT ì•½ 1.25ms)

**(2) VXLAN ìº¡ìŠí™” íŒ¨í‚· ìº¡ì²˜**

```bash
root@router:~# tcpdump -i any udp port 8472 -nn
```

âœ…Â **ì¶œë ¥**

```bash
tcpdump: data link type LINUX_SLL2
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes
00:19:44.022486 eth1  In  IP 192.168.10.100.33604 > 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 63446
IP 172.20.0.96 > 172.20.2.1: ICMP echo request, id 3995, seq 1, length 64
00:19:44.022498 eth2  Out IP 192.168.10.100.33604 > 192.168.20.100.8472: OTV, flags [I] (0x08), overlay 0, instance 63446
IP 172.20.0.96 > 172.20.2.1: ICMP echo request, id 3995, seq 1, length 64
00:19:44.023183 eth2  In  IP 192.168.20.100.45255 > 192.168.10.100.8472: OTV, flags [I] (0x08), overlay 0, instance 8469
IP 172.20.2.1 > 172.20.0.96: ICMP echo reply, id 3995, seq 1, length 64
00:19:44.023187 eth1  Out IP 192.168.20.100.45255 > 192.168.10.100.8472: OTV, flags [I] (0x08), overlay 0, instance 8469
IP 172.20.2.1 > 172.20.0.96: ICMP echo reply, id 3995, seq 1, length 64
```

- ë¼ìš°í„°ì—ì„œ `tcpdump -i any udp port 8472`ë¡œ VXLAN íŠ¸ë˜í”½ ìº¡ì²˜
- Outer í—¤ë”(ë…¸ë“œ IP: `192.168.x.x`) ì•ˆì— Inner í—¤ë”(Pod IP: `172.20.x.x`) í¬í•¨ í™•ì¸
- ICMP ì›ë³¸ íŒ¨í‚·ì´ VXLAN í—¤ë”ë¡œ ê°ì‹¸ì ¸ `eth1` â†’ `eth2`ë¡œ ì „ë‹¬ë˜ëŠ” ê²½ë¡œ í™•ì¸

### **4. ë°˜ë³µ ìš”ì²­ìœ¼ë¡œ íŠ¸ë˜í”½ ìƒì„±**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- sh -c 'while true; do curl -s --connect-timeout 1 webpod | grep Hostname; echo "---" ; sleep 1; done'
```

âœ…Â **ì¶œë ¥**

```bash

Hostname: webpod-697b545f57-fz95q
---
Hostname: webpod-697b545f57-fz95q
---
Hostname: webpod-697b545f57-gkvrf
---
Hostname: webpod-697b545f57-rpz7h
...
```

- ì‘ë‹µ Hostnameì´ ì—¬ëŸ¬ íŒŒë“œ(`fz95q`, `gkvrf`, `rpz7h`)ë¡œ ë¶„ì‚°ë˜ì–´ ìˆ˜ì‹ ë¨

### **5. VXLAN íŠ¸ë˜í”½ íŒ¨í‚· ìº¡ì²˜**

```bash
root@router:~# tcpdump -i any udp port 8472 -w /tmp/vxlan.pcap
```

âœ…Â **ì¶œë ¥**

```bash
tcpdump: data link type LINUX_SLL2
tcpdump: listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes

^C160 packets captured
162 packets received by filter
0 packets dropped by kernel
```

- ë¼ìš°í„°ì—ì„œ `tcpdump -i any udp port 8472 -w /tmp/vxlan.pcap`ìœ¼ë¡œ VXLAN íŠ¸ë˜í”½ ì €ì¥
- ì´ 160ê°œì˜ VXLAN íŒ¨í‚·ì´ ìº¡ì²˜ë˜ì–´ ì˜¤ë²„ë ˆì´ í†µì‹  íë¦„ í™•ì¸ ê°€ëŠ¥

### **6. Termshark í™•ì¸**

```bash
root@router:~# termshark -r /tmp/vxlan.pcap -d udp.port==8472,vxlan
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/53a4a334-658f-4048-85a7-36f52e3df570/image.png)
- VXLAN ê¸°ë³¸ í¬íŠ¸(8472)ë¥¼ ì§€ì •í•˜ì—¬ Termsharkì—ì„œ ìº¡ì²˜ íŒŒì¼ì„ ë¶„ì„
- Outer í—¤ë”(ë…¸ë“œ IP)ì™€ Inner í—¤ë”(Pod IP) êµ¬ì¡°ê°€ í™•ì¸ë¨
- ê° íŒ¨í‚·ì—ëŠ” Internet Protocol, UDP, VXLAN í—¤ë”ê°€ ì¶”ê°€ë˜ì–´ ì›ë³¸ Pod ê°„ íŒ¨í‚·ì´ ê°ì‹¸ì§
- ëª©ì ì§€ ë…¸ë“œì—ì„œ Decapsulation ìˆ˜í–‰, ì´ ê³¼ì •ì—ì„œ CPU ë“± ì¶”ê°€ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©

### **7. Hubble Observeë¥¼ í†µí•œ ì˜¤ë²„ë ˆì´ ê²½ë¡œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# hubble observe -f --protocol tcp --pod curl-pod
```

âœ…Â **ì¶œë ¥**

```bash
Aug  8 15:36:51.979: default/curl-pod:48788 (ID:63446) -> default/webpod-697b545f57-fz95q:80 (ID:8469) to-overlay FORWARDED (TCP Flags: SYN)
Aug  8 15:36:51.980: default/curl-pod:48788 (ID:63446) <- default/webpod-697b545f57-fz95q:80 (ID:8469) to-endpoint FORWARDED (TCP Flags: SYN, ACK)
Aug  8 15:36:51.980: default/curl-pod:48788 (ID:63446) -> default/webpod-697b545f57-fz95q:80 (ID:8469) to-overlay FORWARDED (TCP Flags: ACK)
...
```

- `hubble observe`ì—ì„œ `to-overlay` ë¡œê·¸ë¥¼ í†µí•´ íŒ¨í‚·ì´ VXLAN í„°ë„ ê²½ë¡œë¥¼ ê±°ì¹˜ëŠ” ê²ƒì„ í™•ì¸
- ì´í›„ `to-endpoint` ë‹¨ê³„ì—ì„œ ëª©ì ì§€ íŒŒë“œë¡œ ì „ë‹¬ë¨

---

## **ğŸ¯ K8S Service ê°œë… ì •ë¦¬**

**(1) Pod IP ì§ì ‘ ì ‘ê·¼ ì§€ì–‘**

- PodëŠ” ì–¸ì œë“  ì¢…ë£ŒÂ·ì¬ìƒì„±ë˜ë©° IPê°€ ë³€ê²½ë¨
- ì•ˆì •ì ì¸ ì ‘ê·¼ì„ ìœ„í•´ **ê³ ì • IP ë˜ëŠ” ë„ë©”ì¸**ì„ ì œê³µí•˜ëŠ” Service í•„ìš”

**(2) Service ì—­í• **

- Pod ì§‘í•©ì— ëŒ€í•´ **ê³ ì • ê°€ìƒ IP(ClusterIP)** ë° DNS ë„ë©”ì¸ ìƒì„±
- **í´ëŸ¬ìŠ¤í„° ë‚´ë¶€** â†’ Service ClusterIPë¡œ ë¼ìš°íŒ…í•˜ì—¬ ì ‘ê·¼
- **í´ëŸ¬ìŠ¤í„° ì™¸ë¶€** â†’ ClusterIP ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€

**(3) ì™¸ë¶€ ë…¸ì¶œ ë°©ë²•**

- **NodePort**
    - Service íƒ€ì…ì„ `NodePort`ë¡œ ì„¤ì •
    - ì§€ì • í¬íŠ¸ê°€ ëª¨ë“  ë…¸ë“œì— ë¦¬ìŠ¨ ìƒíƒœë¡œ ì—´ë¦¼
    - ì™¸ë¶€ í´ë¼ì´ì–¸íŠ¸ â†’ `ë…¸ë“œIP:NodePort`ë¡œ ì ‘ê·¼
    - kube-proxy(iptable/IPVS)ë¥¼ í†µí•´ ë°±ì—”ë“œ Podë¡œ íŠ¸ë˜í”½ ì „ë‹¬
- **LoadBalancer**
    - NodePort ê¸°ë°˜ì„ í™•ì¥í•œ ë°©ì‹
    - ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ë‹¨ì¼ ì™¸ë¶€ IP ì œê³µ ë° íŠ¸ë˜í”½ ë¶„ì‚°
    - í´ë¼ìš°ë“œ í™˜ê²½ì˜ Managed LB ë˜ëŠ” On-Premise LB ì¥ë¹„ì™€ ì—°ê³„ ê°€ëŠ¥

---

## **ğŸ—‚ï¸ Service LB-IPAM**

- [https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass](https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass)

**[k8s í´ëŸ¬ìŠ¤í„° ë‚´ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer Type ì„¤ì • with Cilium LB IPAM**

### **1. LB-IPAM ì´ˆê¸° ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get CiliumLoadBalancerIPPool -A

# ê²°ê³¼
No resources found
```

- ê¸°ì¡´ IP Pool ë¦¬ì†ŒìŠ¤ ì—†ìŒ í™•ì¸

### **2. CiliumLoadBalancerIPPool ìƒì„±**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: "cilium.io/v2"  # v1.17 : cilium.io/v2alpha1
kind: CiliumLoadBalancerIPPool
metadata:
  name: "cilium-lb-ippool"
spec:
  blocks:
  - start: "192.168.10.211"
    stop:  "192.168.10.215"
EOF

# ê²°ê³¼
ciliumloadbalancerippool.cilium.io/cilium-lb-ippool created
```

- `192.168.10.211 ~ 192.168.10.215` ë²”ìœ„ë¥¼ ê°€ì§€ëŠ” IP Pool ìƒì„±
- ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ëŠ” `kubectl get ippools`ë¡œ í™•ì¸ ê°€ëŠ¥

### **3. ë¦¬ì†ŒìŠ¤ ì¶•ì•½ì–´ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl api-resources | grep -i CiliumLoadBalancerIPPool
```

âœ…Â **ì¶œë ¥**

```bash
ciliumloadbalancerippools           ippools,ippool,lbippool,lbippools   cilium.io/v2                      false        CiliumLoadBalancerIPPool
```

- `ippool`, `lbippool` ë“± ì¶•ì•½ì–´ í™•ì¸

### **4. IP Pool ìƒíƒœ ì ê²€**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ippools
```

âœ…Â **ì¶œë ¥**

```bash
NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE
cilium-lb-ippool   false      False         5               4m2s
```

- ìƒì„± ì§í›„ `cilium-lb-ippool` ìƒíƒœ: ì‚¬ìš© ê°€ëŠ¥ IP 5ê°œ, ì¶©ëŒ ì—†ìŒ

### **5. ì„œë¹„ìŠ¤ íƒ€ì… ë³€ê²½**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP   25h
webpod       ClusterIP   10.96.163.90   <none>        80/TCP    24h
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl patch svc webpod -p '{"spec":{"type":"LoadBalancer"}}'

# ê²°ê³¼
service/webpod patched
```

- ê¸°ì¡´ `ClusterIP` íƒ€ì…ì˜ `webpod` ì„œë¹„ìŠ¤ë¥¼ `LoadBalancer`ë¡œ ë³€ê²½

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc
```

âœ…Â **ì¶œë ¥**

```bash
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE
kubernetes   ClusterIP      10.96.0.1      <none>           443/TCP        25h
webpod       LoadBalancer   10.96.163.90   192.168.10.211   80:30276/TCP   24h
```

- Cilium LB-IPAMì„ í†µí•´ ì¦‰ì‹œ External IPê°€ í• ë‹¹ë¨ (`192.168.10.211`)

### **6. ë…¸ë“œ ë° íŒŒë“œì—ì„œ LB-IP ì ‘ê·¼ í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc webpod -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
LBIP=$(kubectl get svc webpod -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# curl -s $LBIP
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-rpz7h
IP: 127.0.0.1
IP: ::1
IP: 172.20.1.126
IP: fe80::3024:a3ff:feb8:6a8
RemoteAddr: 172.20.0.253:48068
GET / HTTP/1.1
Host: 192.168.10.211
User-Agent: curl/8.5.0
Accept: */*
```

- k8s ë…¸ë“œì—ì„œ `curl` ìš”ì²­ ì‹œ ì •ìƒ ì‘ë‹µ ìˆ˜ì‹ 
- `curl-pod`ì—ì„œ LB-IP ìš”ì²­ ì‹œ ëŒ€ìƒ íŒŒë“œ Hostname ë° RemoteAddr í™•ì¸ ê°€ëŠ¥

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- curl -s $LBIP
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-rpz7h
IP: 127.0.0.1
IP: ::1
IP: 172.20.1.126
IP: fe80::3024:a3ff:feb8:6a8
RemoteAddr: 172.20.0.96:49084
GET / HTTP/1.1
Host: 192.168.10.211
User-Agent: curl/8.14.1
Accept: */*
```

ëŒ€ìƒ íŒŒë“œ ì´ë¦„ ì¶œë ¥

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- curl -s $LBIP | grep Hostname
Hostname: webpod-697b545f57-rpz7h
```

ëŒ€ìƒ íŒŒë“œ ì…ì¥ì—ì„œ ì†ŒìŠ¤ IP ì¶œë ¥(Layer3)

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -it curl-pod -- curl -s $LBIP | grep RemoteAddr
RemoteAddr: 172.20.0.96:37104
```

### **7. ìš”ì²­ ë¶„ì‚° í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# while true; do kubectl exec -it curl-pod -- curl -s $LBIP | grep Hostname; sleep 0.1; done
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-gkvrf
Hostname: webpod-697b545f57-rpz7h
Hostname: webpod-697b545f57-gkvrf
Hostname: webpod-697b545f57-rpz7h
Hostname: webpod-697b545f57-fz95q
Hostname: webpod-697b545f57-gkvrf
Hostname: webpod-697b545f57-gkvrf
Hostname: webpod-697b545f57-gkvrf
Hostname: webpod-697b545f57-rpz7h
...
```

- 0.1ì´ˆ ê°„ê²© ë°˜ë³µ ìš”ì²­ ìˆ˜í–‰ ê²°ê³¼, 3ê°œì˜ íŒŒë“œë¡œ ê· ë“±í•˜ê²Œ íŠ¸ë˜í”½ ë¶„ë°°

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# for i in {1..100};  do kubectl exec -it curl-pod -- curl -s $LBIP | grep Hostname; done | sort | uniq -c | sort -nr
```

âœ…Â **ì¶œë ¥**

```bash
     38 Hostname: webpod-697b545f57-gkvrf
     34 Hostname: webpod-697b545f57-rpz7h
     28 Hostname: webpod-697b545f57-fz95q
```

- `uniq -c` ê²°ê³¼ ê° íŒŒë“œë³„ ìš”ì²­ íšŸìˆ˜ ë¹„ìŠ·í•˜ê²Œ ë¶„ì‚°

### **8. IP Pool ì‚¬ìš©ëŸ‰ í™•ì¸**

ippoolì— ì›ë˜ 5ê°œ ìˆëŠ”ë° ì´ì œ í•˜ë‚˜ í• ë‹¹í•´ì„œ 4ê°œ ë‚¨ì•˜ë‹¤ëŠ” ì˜ë¯¸

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ippools
```

âœ…Â **ì¶œë ¥**

```bash
NAME               DISABLED   CONFLICTING   IPS AVAILABLE   AGE
cilium-lb-ippool   false      False         4               14m
```

- ì´ˆê¸° 5ê°œ IP ì¤‘ 1ê°œ í• ë‹¹ìœ¼ë¡œ ì‚¬ìš© ê°€ëŠ¥ IP 4ê°œë¡œ ê°ì†Œ

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get ippools -o jsonpath='{.items[*].status.conditions[?(@.type!="cilium.io/PoolConflict")]}' | jq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "lastTransitionTime": "2025-08-08T16:03:27Z",
  "message": "5",
  "observedGeneration": 1,
  "reason": "noreason",
  "status": "Unknown",
  "type": "cilium.io/IPsTotal"
}
{
  "lastTransitionTime": "2025-08-08T16:03:27Z",
  "message": "4",
  "observedGeneration": 1,
  "reason": "noreason",
  "status": "Unknown",
  "type": "cilium.io/IPsAvailable"
}
{
  "lastTransitionTime": "2025-08-08T16:03:27Z",
  "message": "1",
  "observedGeneration": 1,
  "reason": "noreason",
  "status": "Unknown",
  "type": "cilium.io/IPsUsed"
}
```

- `IPsTotal=5`, `IPsAvailable=4`, `IPsUsed=1` í™•ì¸

### **9. ì„œë¹„ìŠ¤ ì»¨ë””ì…˜ì—ì„œ IPAM ìƒíƒœ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc webpod -o jsonpath='{.status}' | jq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "conditions": [
    {
      "lastTransitionTime": "2025-08-08T16:09:03Z",
      "message": "",
      "reason": "satisfied",
      "status": "True",
      "type": "cilium.io/IPAMRequestSatisfied"
    }
  ],
  "loadBalancer": {
    "ingress": [
      {
        "ip": "192.168.10.211",
        "ipMode": "VIP"
      }
    ]
  }
}
```

- `cilium.io/IPAMRequestSatisfied` ìƒíƒœ `True`ë¡œ, LB-IP í• ë‹¹ì´ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë¨
- LoadBalancer Ingress ì •ë³´ì—ì„œ `ipMode`ê°€ `VIP`ë¡œ í‘œì‹œë¨

---

**[k8s í´ëŸ¬ìŠ¤í„° ì™¸ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer External IPë¡œ í˜¸ì¶œ í™•ì¸**

### **10. ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ LBIP í†µì‹  ì‹œë„**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE
kubernetes   ClusterIP      10.96.0.1      <none>           443/TCP        25h
webpod       LoadBalancer   10.96.163.90   192.168.10.211   80:30276/TCP   24h
```

```bash
root@router:~# LBIP=192.168.10.211
```

âœ…Â **ì¶œë ¥**

```bash
curl --connect-timeout 1 $LBIP
curl: (28) Failed to connect to 192.168.10.211 port 80 after 1001 ms: Timeout was reached
```

- ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€(ì¡°ì¸ë˜ì§€ ì•Šì€ router)ì—ì„œ `192.168.10.211`(webpod LoadBalancer IP)ë¡œ HTTP ìš”ì²­ ì‹œë„
- `curl --connect-timeout 1` ê²°ê³¼, 1ì´ˆ ëŒ€ê¸° í›„ íƒ€ì„ì•„ì›ƒ ë°œìƒ

### **11. ARP ìš”ì²­ ì‹¤íŒ¨**

```bash
root@router:~# arping -i eth1 $LBIP -c 1
```

âœ…Â **ì¶œë ¥**

```bash
ARPING 192.168.10.211
Timeout

--- 192.168.10.211 statistics ---
1 packets transmitted, 0 packets received, 100% unanswered (0 extra)
```

- ì‘ë‹µ ì—†ìŒ(100% unanswered)
- ê°™ì€ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ì—ì„œ í†µì‹ í•˜ë ¤ë©´ ëŒ€ìƒ IPì™€ ë§¤ì¹­ë˜ëŠ” MAC ì£¼ì†Œê°€ í•„ìš”í•˜ì§€ë§Œ, ì´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•¨

### **12. ARP í…Œì´ë¸” í™•ì¸**

```bash
root@router:~# arp -a
```

âœ…Â **ì¶œë ¥**

```bash
? (192.168.10.101) at 08:00:27:fb:78:e5 [ether] on eth1
? (10.0.2.3) at 52:55:0a:00:02:03 [ether] on eth0
? (192.168.10.100) at 08:00:27:d5:e8:d7 [ether] on eth1
_gateway (10.0.2.2) at 52:55:0a:00:02:02 [ether] on eth0
? (192.168.20.100) at 08:00:27:eb:bf:4f [ether] on eth2
? (192.168.10.211) at <incomplete> on eth1
```

- `arp -a` ëª…ë ¹ ê²°ê³¼, ë‹¤ë¥¸ í˜¸ìŠ¤íŠ¸ë“¤ì˜ MAC ì£¼ì†ŒëŠ” í‘œì‹œë˜ë‚˜ `192.168.10.211`ì€ `<incomplete>` ìƒíƒœ
- LB-IPì— í•´ë‹¹í•˜ëŠ” MAC ì£¼ì†Œë¥¼ ì•Œ ìˆ˜ ì—†ì–´ í†µì‹  ë¶ˆê°€

### **13. ì§€ì†ì ì¸ ARP ìš”ì²­ í…ŒìŠ¤íŠ¸**

```bash
root@router:~# arping -i eth1 $LBIP -c 100000
```

âœ…Â **ì¶œë ¥**

```bash
ARPING 192.168.10.211
Timeout
Timeout
Timeout
Timeout
Timeout
...
```

- `arping -i eth1 192.168.10.211 -c 100000` ì‹¤í–‰í–ˆìœ¼ë‚˜ ì—¬ì „íˆ ì‘ë‹µ ì—†ìŒ
- ì´ëŠ” LB-IPì— ëŒ€í•´ í•´ë‹¹ MAC ì£¼ì†Œë¥¼ ì‘ë‹µí•´ ì¤„ ì£¼ì²´ê°€ ì—†ëŠ” ìƒíƒœë¥¼ ì˜ë¯¸

---

## **ğŸ”„ Cilium L2 Announcement**

**[k8s í´ëŸ¬ìŠ¤í„° ì™¸ë¶€] webpod ì„œë¹„ìŠ¤ë¥¼ LoadBalancer ExternalIPë¡œ í˜¸ì¶œ with L2 Announcements**

- [https://docs.cilium.io/en/stable/network/l2-announcements/#l2-pod-announcements](https://docs.cilium.io/en/stable/network/l2-announcements/#l2-pod-announcements)

### **1. Cilium L2 Announcement ê¸°ëŠ¥ í™œì„±í™”**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# helm upgrade cilium cilium/cilium --namespace kube-system --version 1.18.0 --reuse-values \
   --set l2announcements.enabled=true && watch -d kubectl get pod -A

# ê²°ê³¼   
Release "cilium" has been upgraded. Happy Helming!
NAME: cilium
LAST DEPLOYED: Sat Aug  9 13:05:19 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 3
TEST SUITE: None
NOTES:
You have successfully installed Cilium with Hubble Relay and Hubble UI.

Your release version is 1.18.0.

For any further help, visit https://docs.cilium.io/en/v1.18/gettinghelp
```

- Helm ì—…ê·¸ë ˆì´ë“œ ì‹œ `l2announcements.enabled=true` ì˜µì…˜ ì ìš©í•˜ì—¬ ê¸°ëŠ¥ í™œì„±í™”

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl rollout restart -n kube-system ds/cilium
daemonset.apps/cilium restarted
```

- `kubectl rollout restart`ë¡œ Cilium DaemonSet ì¬ì‹œì‘

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system exec ds/cilium -c cilium-agent -- cilium-dbg config --all | grep EnableL2Announcements
EnableL2Announcements             : true
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cilium config view | grep enable-l2
enable-l2-announcements                           true
enable-l2-neigh-discovery                         false
```

- `cilium-dbg config` ë° `cilium config view`ë¥¼ í†µí•´ `EnableL2Announcements: true` ìƒíƒœ í™•ì¸

### **2. L2 Announcement ì •ì±… ì„¤ì •**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy1
spec:
  serviceSelector:
    matchLabels:
      app: webpod
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
EOF

# ê²°ê³¼
ciliuml2announcementpolicy.cilium.io/policy1 created
```

- `CiliumL2AnnouncementPolicy` ë¦¬ì†ŒìŠ¤ ìƒì„±
- `app=webpod` ì„œë¹„ìŠ¤ë§Œ ëŒ€ìƒìœ¼ë¡œ ì„¤ì •í•˜ê³ , `k8s-w0` ë…¸ë“œëŠ” ì œì™¸í•˜ì—¬ External IP ê´‘ê³  ëŒ€ìƒì—ì„œ ë°°ì œ
- ê´‘ê³  ì¸í„°í˜ì´ìŠ¤: `^eth[1-9]+` íŒ¨í„´ì˜ NIC
- `externalIPs` ë° `loadBalancerIPs` ëª¨ë‘ ê´‘ê³ í•˜ë„ë¡ ì„¤ì •

![](https://velog.velcdn.com/images/tlsalswls123/post/f5f9e286-c474-4f09-abe8-e94cdd46b9c8/image.png)
- ì •ì±… ì ìš© í›„, ì™¸ë¶€ì—ì„œ External IP ì ‘ê·¼ ê°€ëŠ¥í•´ì§(ARP ì‘ë‹µ ì£¼ì²´ ìƒì„±)

### **3. ARP ì‘ë‹µ ë¦¬ë” ë…¸ë“œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system get lease
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                   HOLDER                                                                      AGE
apiserver-k3qt3hgfvd4qocxh5wccoxpss4   apiserver-k3qt3hgfvd4qocxh5wccoxpss4_020ec706-87a6-4bd5-8d5a-49b96212344a   37h
cilium-l2announce-default-webpod       k8s-ctr                                                                     2m16s
cilium-operator-resource-lock          k8s-ctr-bstpwpr5rc                                                          37h
kube-controller-manager                k8s-ctr_5154e252-9521-4f38-8644-bb959f34c46a                                37h
kube-scheduler                         k8s-ctr_8cdbb3a1-acdc-49a5-9f9a-1be875a5ef3e                                37h
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system get lease | grep "cilium-l2announce"
cilium-l2announce-default-webpod       k8s-ctr                                                                     2m44s
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system get lease/cilium-l2announce-default-webpod -o yaml | yq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "apiVersion": "coordination.k8s.io/v1",
  "kind": "Lease",
  "metadata": {
    "creationTimestamp": "2025-08-09T04:13:07Z",
    "name": "cilium-l2announce-default-webpod",
    "namespace": "kube-system",
    "resourceVersion": "36222",
    "uid": "285205c3-c95e-497b-987b-de58a9460b84"
  },
  "spec": {
    "acquireTime": "2025-08-09T04:13:07.812116Z",
    "holderIdentity": "k8s-ctr",
    "leaseDurationSeconds": 15,
    "leaseTransitions": 0,
    "renewTime": "2025-08-09T04:17:14.673805Z"
  }
}
```

- `cilium-l2announce-default-webpod` ë¦¬ë” ë…¸ë“œê°€ `k8s-ctr`ì„ í™•ì¸

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# export CILIUMPOD0=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-ctr -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD1=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w1  -o jsonpath='{.items[0].metadata.name}')
export CILIUMPOD2=$(kubectl get -l k8s-app=cilium pods -n kube-system --field-selector spec.nodeName=k8s-w0  -o jsonpath='{.items[0].metadata.name}')
echo $CILIUMPOD0 $CILIUMPOD1 $CILIUMPOD2
```

âœ…Â **ì¶œë ¥**

```bash
cilium-bzfjl cilium-t6hbg cilium-vp87t
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD0 -- cilium-dbg shell -- db/show l2-announce
```

âœ…Â **ì¶œë ¥**

```bash
IP               NetworkInterface
192.168.10.211   eth1
```

- ë¦¬ë” ë…¸ë“œì—ì„œë§Œ External IP(`192.168.10.211)`ì™€ í•´ë‹¹ NIC(`eth1`) ì •ë³´ í‘œì‹œ

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD1 -- cilium-dbg shell -- db/show l2-announce
IP   NetworkInterface
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl exec -n kube-system $CILIUMPOD2 -- cilium-dbg shell -- db/show l2-announce
IP   NetworkInterface
```

- ë‚˜ë¨¸ì§€ ë…¸ë“œì—ì„œëŠ” í•´ë‹¹ IP ì •ë³´ ì—†ìŒ â†’ ë¦¬ë” ë…¸ë“œë§Œ ARP ì‘ë‹µ ìˆ˜í–‰

### **4. ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ ì ‘ê·¼ í™•ì¸**

```bash
root@router:~# curl --connect-timeout 1 $LBIP
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: webpod-697b545f57-fz95q
IP: 127.0.0.1
IP: ::1
IP: 172.20.2.1
IP: fe80::7c30:5bff:fe77:1d6d
RemoteAddr: 172.20.0.253:40574
GET / HTTP/1.1
Host: 192.168.10.211
User-Agent: curl/8.5.0
Accept: */*
```

- ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ LoadBalancer IP(`192.168.10.211`)ë¡œ `curl` ìš”ì²­ ì‹œ ì •ìƒ ì‘ë‹µ

```bash
root@router:~# arp -a
? (10.0.2.3) at 52:55:0a:00:02:03 [ether] on eth0
? (192.168.10.100) at 08:00:27:d5:e8:d7 [ether] on eth1
_gateway (10.0.2.2) at 52:55:0a:00:02:02 [ether] on eth0
? (192.168.20.100) at 08:00:27:eb:bf:4f [ether] on eth2
? (192.168.10.211) at 08:00:27:d5:e8:d7 [ether] on eth1
```

- `arp -a`ì—ì„œ `192.168.10.211`ê³¼ ë¦¬ë” ë…¸ë“œ IP(`192.168.10.100`)ì˜ MAC ì£¼ì†Œ ë™ì¼ í™•ì¸
- ì´ëŠ” ë¦¬ë” ë…¸ë“œê°€ External IP ì†Œìœ  ë° ARP ì‘ë‹µì„ ë‹´ë‹¹í•¨ì„ ì˜ë¯¸

```bash
root@router:~# curl -s $LBIP | grep Hostname
Hostname: webpod-697b545f57-rpz7h

root@router:~# curl -s $LBIP | grep RemoteAddr
RemoteAddr: 172.20.0.253:40236
```
![](https://velog.velcdn.com/images/tlsalswls123/post/9a4b16f2-a32f-452e-85c8-826edade8b4e/image.png)
- ì™¸ë¶€ì—ì„œ ë°˜ë³µ ìš”ì²­ ì‹œ, ëª¨ë“  íŠ¸ë˜í”½ì´ ë¨¼ì € ë¦¬ë” ë…¸ë“œ(k8s-ctr)ë¡œ ë“¤ì–´ê°€ê³  ì´í›„ ê° ì›Œì»¤ ë…¸ë“œì˜ Podë¡œ ë¶„ì‚° ì‘ë‹µë¨
- L2 Announcement êµ¬ì¡°ìƒ ë¦¬ë” ë…¸ë“œê°€ **ì•µì»¤(anchor)** ì—­í• ì„ ìˆ˜í–‰í•˜ì—¬ í•­ìƒ ì§„ì… ì§€ì ì´ ë¨
    - ì´ë¡œ ì¸í•œ íŠ¸ë˜í”½ ê²½ìœ ê°€ ë°œìƒí•˜ëŠ” ê²ƒì´ ë™ì‘ì˜ í•œê³„

---

## **ğŸ§© Service LB-IPAM ê¸°ëŠ¥**

### **1. netshoot-web Deployment ìƒì„±**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-web
  template:
    metadata:
      labels:
        app: netshoot-web
    spec:
      terminationGracePeriodSeconds: 0
      containers:
        - name: netshoot
          image: nicolaka/netshoot
          ports:
            - containerPort: 8080
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: ["sh", "-c"]
          args:
            - |
              while true; do 
                { echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\n\r\nOK from \$POD_NAME"; } | nc -l -p 8080 -q 1;
              done
EOF

# ê²°ê³¼
deployment.apps/netshoot-web created
```

- ê° Podì—ì„œ 8080 í¬íŠ¸ë¥¼ ë¦¬ìŠ¨í•˜ê³  HTTP ì‘ë‹µ ì‹œ ìì‹ ì˜ `POD_NAME` ì¶œë ¥

### **2. LoadBalancer íƒ€ì… Service ìƒì„±**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 80      
      targetPort: 8080
EOF

# ê²°ê³¼
service/netshoot-web created
```

- `netshoot-web` ì„œë¹„ìŠ¤ íƒ€ì…ì„ LoadBalancerë¡œ ì„¤ì •í•˜ì—¬ External IP(`192.168.10.212`) ë¶€ì—¬

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc netshoot-web
NAME           TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE
netshoot-web   LoadBalancer   10.96.68.82   192.168.10.212   80:30376/TCP   21s
```

### **3. CiliumL2AnnouncementPolicy ì ìš©**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: "cilium.io/v2alpha1"  # not v2
kind: CiliumL2AnnouncementPolicy
metadata:
  name: policy2
spec:
  serviceSelector:
    matchLabels:
      app: netshoot-web
  nodeSelector:
    matchExpressions:
      - key: kubernetes.io/hostname
        operator: NotIn
        values:
          - k8s-w0
  interfaces:
  - ^eth[1-9]+
  externalIPs: true
  loadBalancerIPs: true
EOF

# ê²°ê³¼
ciliuml2announcementpolicy.cilium.io/policy2 created
```

- Serviceì˜ `app=netshoot-web` ë¼ë²¨ì„ ê¸°ë°˜ìœ¼ë¡œ ë™ì‘
- `k8s-w0` ë…¸ë“œë¥¼ ì œì™¸í•œ ë…¸ë“œ ì¤‘ External IPë¥¼ ê´‘ê³ í•  ë¦¬ë” ë…¸ë“œ ì„ ì •

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system get lease | grep "cilium-l2announce"
cilium-l2announce-default-netshoot-web   k8s-w1                                                                      34s
cilium-l2announce-default-webpod         k8s-ctr                                                                     82m
```

- `netshoot-web` â†’ ë¦¬ë” ë…¸ë“œ: `k8s-w1`
- `webpod` â†’ ë¦¬ë” ë…¸ë“œ: `k8s-ctr`

### **4. ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc netshoot-web -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
LB2IP=$(kubectl get svc netshoot-web -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
curl -s $LB2IP

# ê²°ê³¼
192.168.10.212OK from netshoot-web-5c59d94bd4-rh584
```

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# curl -s $LB2IP
OK from netshoot-web-5c59d94bd4-ndg9c

(âˆ|HomeLab:N/A) root@k8s-ctr:~# curl -s $LB2IP
OK from netshoot-web-5c59d94bd4-rh584

(âˆ|HomeLab:N/A) root@k8s-ctr:~# curl -s $LB2IP
OK from netshoot-web-5c59d94bd4-ghndv
```

- LB IP(`192.168.10.212`)ë¡œ curl ìš”ì²­ ì‹œ ê°ê¸° ë‹¤ë¥¸ Pod ì‘ë‹µ í™•ì¸ â†’ ë¡œë“œë°¸ëŸ°ì‹± ë™ì‘ ì •ìƒ

### **5. ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ ì ‘ê·¼ í™•ì¸**

**(1) ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ External IP ARP í™•ì¸**

```bash
root@router:~# LB2IP=192.168.10.212
root@router:~# arping -i eth1 $LB2IP -c 2
ARPING 192.168.10.212
60 bytes from 08:00:27:fb:78:e5 (192.168.10.212): index=0 time=799.846 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.212): index=1 time=342.301 usec

--- 192.168.10.212 statistics ---
2 packets transmitted, 2 packets received,   0% unanswered (0 extra)
rtt min/avg/max/std-dev = 0.342/0.571/0.800/0.229 ms
```

- ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ `arping` ì‹¤í–‰ ì‹œ External IP(`192.168.10.212`)ê°€ ë¦¬ë” ë…¸ë“œ(`192.168.10.101`, k8s-w1)ì˜ MAC ì£¼ì†Œë¡œ ì‘ë‹µ

**(2) ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸**

```bash
root@router:~# curl -s $LB2IP
OK from netshoot-web-5c59d94bd4-rh584

root@router:~# curl -s $LB2IP
OK from netshoot-web-5c59d94bd4-ghndv
```

- `curl` ëª…ë ¹ìœ¼ë¡œ External IPì— ìš”ì²­ ì‹œ ì •ìƒ ì‘ë‹µ
- ì‘ë‹µ ë‚´ìš©ì—ì„œ ê°ê¸° ë‹¤ë¥¸ `netshoot-web` Pod ì´ë¦„ì´ ì¶œë ¥ë˜ì–´ ë¡œë“œë°¸ëŸ°ì‹± ì •ìƒ ë™ì‘ í™•ì¸

**(3) ARP í…Œì´ë¸” ë§¤í•‘ í™•ì¸**

```bash
root@router:~# arp -a
```

âœ…Â **ì¶œë ¥**

```bash
? (192.168.10.101) at 08:00:27:fb:78:e5 [ether] on eth1
? (10.0.2.3) at 52:55:0a:00:02:03 [ether] on eth0
? (192.168.10.100) at 08:00:27:d5:e8:d7 [ether] on eth1
_gateway (10.0.2.2) at 52:55:0a:00:02:02 [ether] on eth0
? (192.168.10.212) at 08:00:27:fb:78:e5 [ether] on eth1
? (192.168.20.100) at 08:00:27:eb:bf:4f [ether] on eth2
? (192.168.10.211) at 08:00:27:d5:e8:d7 [ether] on eth1
```

- `arp -a` ê²°ê³¼ External IP(`192.168.10.212`)ì™€ ë¦¬ë” ë…¸ë“œ IP(`192.168.10.101`)ì˜ MAC ì£¼ì†Œ ë™ì¼
- ì„œë¹„ìŠ¤ë³„ë¡œ ë¦¬ë” ë…¸ë“œê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë©°, í•´ë‹¹ ë¦¬ë” ë…¸ë“œê°€ ARP ì‘ë‹µ ë° External IP ê´‘ê³ ë¥¼ ë‹´ë‹¹í•¨

---

## **ğŸ“ Requesting IPs : íŠ¹ì • Serviceì— EX-IPë¥¼ ì§ì ‘ ì„¤ì •**

- [https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass](https://docs.cilium.io/en/stable/network/lb-ipam/#loadbalancerclass)

### **1. ê¸°ì¡´ External IP ìƒíƒœ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/78345633-6092-4bd9-9261-f0a47399a0fa/image.png)

```bash
root@router:~# arping -i eth1 $LB2IP -c 1000000
```

âœ…Â **ì¶œë ¥**
![](https://velog.velcdn.com/images/tlsalswls123/post/048c9c30-17b2-4855-b03a-16c0d0727fa0/image.png)
- ì„œë¹„ìŠ¤ External IP(`192.168.10.212`)ì— ëŒ€í•´ ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ `arping` ì‹¤í–‰
- ì •ìƒì ìœ¼ë¡œ ARP ì‘ë‹µì´ ìˆ˜ì‹ ë¨

### **2. íŠ¹ì • ì„œë¹„ìŠ¤ External IP ê³ ì • ì„¤ì •**
![](https://velog.velcdn.com/images/tlsalswls123/post/9a6b0533-7918-45f2-83e0-241f76811988/image.png)
- `Service` ë¦¬ì†ŒìŠ¤ì— `lbipam.cilium.io/ips: "192.168.10.215"` ì• ë…¸í…Œì´ì…˜ ì¶”ê°€

![](https://velog.velcdn.com/images/tlsalswls123/post/fdfb589a-dd93-49bd-8e50-d504232fe594/image.png)
- ê¸°ì¡´ External IP `192.168.10.212` â†’ ì§€ì •í•œ IP `192.168.10.215`ë¡œ ë³€ê²½ë¨

![](https://velog.velcdn.com/images/tlsalswls123/post/4ee506c6-1194-4149-aa4d-396809fabe8f/image.png)

### **3. ë³€ê²½ëœ External IP ARP ì‘ë‹µ í™•ì¸**

```bash
root@router:~# arping -i eth1 192.168.10.215 -c 1000000
```

âœ…Â **ì¶œë ¥**

```bash
ARPING 192.168.10.215
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=0 time=628.696 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=1 time=506.722 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=2 time=238.185 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=3 time=349.109 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=4 time=410.704 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=5 time=433.840 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=6 time=300.155 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=7 time=232.381 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=8 time=279.912 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=9 time=661.042 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=10 time=413.527 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=11 time=644.416 usec
60 bytes from 08:00:27:fb:78:e5 (192.168.10.215): index=12 time=1.569 msec
...
```

- ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ `arping` ì‹¤í–‰ ì‹œ, ìƒˆ External IP(`192.168.10.215`)ê°€ ë¦¬ë” ë…¸ë“œ(k8s-w1)ì˜ MAC ì£¼ì†Œë¡œ ì‘ë‹µ

### **4. ë³€ê²½ëœ External IP ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc netshoot-web -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
LB2IP=$(kubectl get svc netshoot-web -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
curl -s $LB2IP

192.168.10.215OK from netshoot-web-5c59d94bd4-ndg9c
```

- ì™¸ë¶€ ë¼ìš°í„° ë° í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ `curl` ìš”ì²­ ì‹œ ì •ìƒ ì‘ë‹µ

---

## **ğŸ”‘ Sharing Keys : EX-IP 1ê°œë¥¼ ê°ê¸° ë‹¤ë¥¸ Port ë¥¼ í†µí•´ì„œ ì‚¬ìš©**

- Cilium `sharing keys` ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ **í•˜ë‚˜ì˜ External IPë¥¼ ì—¬ëŸ¬ ì„œë¹„ìŠ¤ê°€ ë‹¤ë¥¸ í¬íŠ¸ë¡œ ê³µìœ ** ê°€ëŠ¥
- ê¸°ë³¸ì ìœ¼ë¡œ LoadBalancer ì„œë¹„ìŠ¤ë§ˆë‹¤ External IPê°€ 1:1ë¡œ í• ë‹¹ë˜ì§€ë§Œ, Sharing Keysë¥¼ í†µí•´ IP ì¬ì‚¬ìš© ê°€ëŠ¥

### **1. ì¶”ê°€ LoadBalancer ì„œë¹„ìŠ¤ ìƒì„±**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# cat << EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: netshoot-web2
  labels:
    app: netshoot-web
spec:
  type: LoadBalancer
  selector:
    app: netshoot-web
  ports:
    - name: http
      port: 8080      
      targetPort: 8080
EOF
service/netshoot-web2 created
```

- `netshoot-web2` ì„œë¹„ìŠ¤ ìƒì„±, í¬íŠ¸ëŠ” 8080 ì‚¬ìš©

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc -l app=netshoot-web
```

âœ…Â **ì¶œë ¥**

```bash
NAME            TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
netshoot-web    LoadBalancer   10.96.68.82    192.168.10.215   80:30376/TCP     28m
netshoot-web2   LoadBalancer   10.96.14.206   192.168.10.212   8080:30961/TCP   26s
```

- ìƒì„± ì§í›„ ê¸°ë³¸ ë™ì‘ì—ì„œëŠ” ìƒˆë¡œìš´ External IP(`192.168.10.212`)ê°€ ë°œê¸‰ë¨

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# k get svc
```

âœ…Â **ì¶œë ¥**

```bash
NAME            TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
kubernetes      ClusterIP      10.96.0.1      <none>           443/TCP          39h
netshoot-web    LoadBalancer   10.96.68.82    192.168.10.215   80:30376/TCP     28m
netshoot-web2   LoadBalancer   10.96.14.206   192.168.10.212   8080:30961/TCP   58s
webpod          LoadBalancer   10.96.163.90   192.168.10.211   80:30276/TCP     38h
```

### **2. External IP Sharing Keys ì ìš©**
![](https://velog.velcdn.com/images/tlsalswls123/post/4dc222f1-d283-44e8-9bb4-030f30d48aa7/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/a3c9aea6-ccfe-40ba-acfd-e111838a97bd/image.png)

ì„œë¹„ìŠ¤ `metadata.annotations`ì— ì•„ë˜ í•­ëª© ì¶”ê°€
```bash
"lbipam.cilium.io/ips": "192.168.10.215"
"lbipam.cilium.io/sharing-key": "1234"
```

![](https://velog.velcdn.com/images/tlsalswls123/post/95b322a6-6f01-4a1b-b91f-ca080b5a38f1/image.png)
- ë‘ ì„œë¹„ìŠ¤ê°€ ë™ì¼í•œ External IPë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ì„œ 80í¬íŠ¸ì™€ 8080í¬íŠ¸ë¡œ êµ¬ë¶„ë˜ì–´ ì ‘ê·¼ ê°€ëŠ¥

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl get svc -l app=netshoot-web
```

âœ…Â **ì¶œë ¥**

```bash
NAME            TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)          AGE
netshoot-web    LoadBalancer   10.96.68.82    192.168.10.215   80:30376/TCP     34m
netshoot-web2   LoadBalancer   10.96.14.206   192.168.10.215   8080:30961/TCP   6m41s
```

### **3. ë™ì¼ External IP ì‚¬ìš© ì‹œ ë¦¬ë” ë…¸ë“œ í™•ì¸**

```bash
(âˆ|HomeLab:N/A) root@k8s-ctr:~# kubectl -n kube-system get lease | grep "cilium-l2announce"
cilium-l2announce-default-netshoot-web    k8s-w1                                                                      33m
cilium-l2announce-default-netshoot-web2   k8s-w1                                                                      7m32s
cilium-l2announce-default-webpod          k8s-ctr                                                                     115m
```

- ë™ì¼ IP ì‚¬ìš© ì‹œ ARP ì‘ë‹µ ë° External IP ê´‘ê³ ë¥¼ ë‹´ë‹¹í•˜ëŠ” ë¦¬ë” ë…¸ë“œê°€ ë™ì¼í•´ì§ (`k8s-w1`)
- íŠ¹ì • ë…¸ë“œë¡œ íŠ¸ë˜í”½ ì§‘ì¤‘ ê°€ëŠ¥ì„±ì´ ìˆìŒ â†’ ë¶€í•˜ ë¶„ì‚° ì„¤ê³„ í•„ìš”

### **4. ì„œë¹„ìŠ¤ ì ‘ê·¼ í…ŒìŠ¤íŠ¸ (80/8080 í¬íŠ¸)**

```bash
root@router:~# curl -s 192.168.10.215
OK from netshoot-web-5c59d94bd4-ghndv

root@router:~# curl -s 192.168.10.215:8080
OK from netshoot-web-5c59d94bd4-ndg9c
```

- ì™¸ë¶€ ë¼ìš°í„°ì—ì„œ `curl` ìš”ì²­ ì‹œ ì •ìƒ ì‘ë‹µ í™•ì¸
