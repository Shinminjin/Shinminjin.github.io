---
title: CI/CD 3ì£¼ì°¨ ì •ë¦¬
date: 2025-11-02 01:00:00 +0900
categories: [CI/CD]
tags: [CI/CD]
---

## **ğŸš€ kindë¡œ k8s ë°°í¬**

### **1. kind í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
networking:
  apiServerAddress: "0.0.0.0"
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
  - containerPort: 30002
    hostPort: 30002
  - containerPort: 30003
    hostPort: 30003
- role: worker
EOF

# ê²°ê³¼
Creating cluster "myk8s" ...
 âœ“ Ensuring node image (kindest/node:v1.32.8) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
 âœ“ Joining worker nodes ğŸšœ 
Set kubectl context to "kind-myk8s"
You can now use your cluster with:

kubectl cluster-info --context kind-myk8s

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
```

### **2. ë…¸ë“œ/ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸**

```bash
kind get nodes --name myk8s

# ê²°ê³¼
myk8s-worker
myk8s-control-plane
```

```bash
kubens default

# ê²°ê³¼
âœ” Active namespace is "default"
```

### **3. Docker ì»¨í…Œì´ë„ˆ í™•ì¸ ë° API í¬íŠ¸ ë§¤í•‘**

```bash
docker ps

CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                                                           NAMES
ea4fa45f8d82   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   About a minute ago   Up About a minute   0.0.0.0:30000-30003->30000-30003/tcp, 0.0.0.0:44501->6443/tcp   myk8s-control-plane
665b94422e49   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   About a minute ago   Up About a minute                                                                   myk8s-worker
```

- ì»¨íŠ¸ë¡¤í”Œë ˆì¸: `0.0.0.0:44501 -> 6443` (K8s API)
- NodePort: `30000~30003` í˜¸ìŠ¤íŠ¸ì™€ ë§¤í•‘

### **4. í˜¸ìŠ¤íŠ¸ IP í™•ì¸ ë° K8s API í˜¸ì¶œ**

```bash
ifconfig | grep 192.

# ê²°ê³¼
        inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255
        inet 192.168.219.107  netmask 255.255.255.0  broadcast 192.168.219.255
```

```bash
curl https://192.168.219.107:44501/version -k

# ê²°ê³¼
{
  "major": "1",
  "minor": "32",
  "gitVersion": "v1.32.8",
  "gitCommit": "2e83bc4bf31e88b7de81d5341939d5ce2460f46f",
  "gitTreeState": "clean",
  "buildDate": "2025-08-13T14:21:22Z",
  "goVersion": "go1.23.11",
  "compiler": "gc",
  "platform": "linux/amd64"
}%
```

---

## **ğŸ§©** docker compose

### **1. CI/CD í”„ë¡œì íŠ¸ ë””ë ‰í„°ë¦¬ ì¤€ë¹„**

```bash
mkdir cicd-labs
cd cicd-labs
```

```bash
docker network ls

# ê²°ê³¼
NETWORK ID     NAME      DRIVER    SCOPE
...
1da18f85ffec   kind      bridge    local
...
```

### **2. docker-compose êµ¬ì„± (Jenkins + Gogs)**

```bash
export DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)
```

```bash
cat <<EOT > docker-compose.yaml
services:

  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - kind
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home
    group_add:
      - "${DOCKER_GID}"

  gogs:
    container_name: gogs
    image: gogs/gogs
    restart: unless-stopped
    networks:
      - kind
    ports:
      - "10022:22"
      - "3000:3000"
    volumes:
      - gogs-data:/data

volumes:
  jenkins_home:
  gogs-data:

networks:
  kind:
    external: true
EOT
```

### **3. ì»¨í…Œì´ë„ˆ ê¸°ë™ ë° ìƒíƒœ í™•ì¸**

```bash
docker compose up -d

# ê²°ê³¼
[+] Running 4/4
 âœ” Volume cicd-labs_jenkins_home  Created                                                                     0.0s 
 âœ” Volume cicd-labs_gogs-data     Created                                                                     0.0s 
 âœ” Container gogs                 Started                                                                     0.2s 
 âœ” Container jenkins              Started                                                                     0.2s 
```

```bash
docker compose ps

NAME      IMAGE             COMMAND                  SERVICE   CREATED          STATUS                             PORTS
gogs      gogs/gogs         "/app/gogs/docker/stâ€¦"   gogs      30 seconds ago   Up 29 seconds (health: starting)   0.0.0.0:3000->3000/tcp, [::]:3000->3000/tcp, 0.0.0.0:10022->22/tcp, [::]:10022->22/tcp
jenkins   jenkins/jenkins   "/usr/bin/tini -- /uâ€¦"   jenkins   30 seconds ago   Up 29 seconds                      0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp, 0.0.0.0:50000->50000/tcp, [::]:50000->50000/tcp
```

```bash
for i in gogs jenkins ; do echo ">> container : $i <<"; docker compose exec $i sh -c "whoami && pwd"; echo; done

>> container : gogs <<
root
/app/gogs

>> container : jenkins <<
jenkins
/
```

### **4. ë„ì»¤ë¥¼ ì´ìš©í•˜ì—¬ ê° ì»¨í…Œì´ë„ˆë¡œ ì ‘ì†**

```bash
docker compose exec jenkins bash
jenkins@4aec55fcb34f:/$ exit
exit
```

```bash
docker compose exec gogs bash
f5292520283a:/app/gogs# exit
exit
```

### **5. Jenkins ì»¨í…Œì´ë„ˆ ì´ˆê¸° ì„¤ì •**

```bash
docker compose exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword
dc92d4a5e233407f9fbb1dfaf986e75a # íŒ¨ìŠ¤ì›Œë“œ ì…ë ¥
```

**(1) ì›¹ ì ‘ì†: `http:<ìì‹ ì˜ IP>:8080` ì§„ì… í›„, ê¶Œì¥ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜**
![](https://velog.velcdn.com/images/tlsalswls123/post/e1db9a50-0138-413d-9adb-9206b08dcbb6/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/82468cfb-83ea-431f-96be-86ee6c3c6944/image.png)

**(2) ì‚¬ìš©ì ìƒì„±: `devops / qwe123`**
![](https://velog.velcdn.com/images/tlsalswls123/post/e9cc8efa-6f5e-4a41-a861-7c68484758e7/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/545854cf-04a6-4609-8efb-9e7a083a5c2c/image.png)

**(3) ì„¤ì •ì™„ë£Œ**
![](https://velog.velcdn.com/images/tlsalswls123/post/7499de4b-6906-454d-a371-aae40d2ead5a/image.png)

---

## **ğŸ¯ Jenkins ì»¨í…Œì´ë„ˆì—ì„œ í˜¸ìŠ¤íŠ¸ì— ë„ì»¤ ë°ëª¬ ì‚¬ìš© ì„¤ì •**

### **1. ì»¨í…Œì´ë„ˆ ë‚´ë¶€ Docker CLI ì„¤ì¹˜**

```bash
docker compose exec --privileged -u root jenkins bash
root@4aec55fcb34f:/# id
uid=0(root) gid=0(root) groups=0(root)
```

```bash
root@4aec55fcb34f:/# curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update && apt install docker-ce-cli curl tree jq yq -y
```

### **2. í˜¸ìŠ¤íŠ¸ ë°ëª¬ ì—°ê²° í™•ì¸**

```bash
root@4aec55fcb34f:/# docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS                    PORTS                                                                                          NAMES
4aec55fcb34f   jenkins/jenkins        "/usr/bin/tini -- /uâ€¦"   14 minutes ago   Up 14 minutes             0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp, 0.0.0.0:50000->50000/tcp, [::]:50000->50000/tcp   jenkins
f5292520283a   gogs/gogs              "/app/gogs/docker/stâ€¦"   14 minutes ago   Up 14 minutes (healthy)   0.0.0.0:3000->3000/tcp, [::]:3000->3000/tcp, 0.0.0.0:10022->22/tcp, [::]:10022->22/tcp         gogs
ea4fa45f8d82   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   17 minutes ago   Up 17 minutes             0.0.0.0:30000-30003->30000-30003/tcp, 0.0.0.0:44501->6443/tcp                                  myk8s-control-plane
665b94422e49   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   17 minutes ago   Up 17 minutes                                                                                                            myk8s-worker
```

```bash
root@a0c3ece04d03:/# which docker
/usr/bin/docker
```

### **3. jenkins ì‚¬ìš©ì ê¶Œí•œ ë¶€ì—¬ ì‹œë„**

```bash
root@4aec55fcb34f:/# chgrp docker /var/run/docker.sock
ls -l /var/run/docker.sock
usermod -aG docker jenkins
cat /etc/group | grep docker
chgrp: invalid group: â€˜dockerâ€™
srw-rw---- 1 root 957 0 Oct 25 11:35 /var/run/docker.sock
usermod: group 'docker' does not exist

root@4aec55fcb34f:/# exit
exit
```

- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ `usermod -aG docker jenkins`, `chgrp docker /var/run/docker.sock` ì‹œë„í–ˆìœ¼ë‚˜ **docker ê·¸ë£¹ ë¯¸ì¡´ì¬**ë¡œ ì‹¤íŒ¨í•¨

### **4. Jenkins ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ í›„ ê¶Œí•œ ì—ëŸ¬ ê´€ì°°**

```bash
docker compose restart jenkins

[+] Restarting 1/1
 âœ” Container jenkins  Started
```

```bash
docker compose exec jenkins docker ps

permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.51/containers/json": dial unix /var/run/docker.sock: connect: permission denied
```

### **5. docker-composeë¡œ ì†Œì¼“ GID ë§¤í•‘ ì ìš©**

```bash
export DOCKER_GID=$(stat -c '%g' /var/run/docker.sock)
```

```bash
...
services:
  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home
    group_add:
      - "${DOCKER_GID}"
...      
```

```bash
docker compose up -d
```

- í˜¸ìŠ¤íŠ¸ ì†Œì¼“ GIDë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì¶”ì¶œí•´ `group_add`ì— ë°˜ì˜í•˜ì—¬ ê¶Œí•œ ë¬¸ì œ í•´ê²°í•¨

### **6. ì»¨í…Œì´ë„ˆ ì¬ìƒì„±ìœ¼ë¡œ Docker CLI íœ˜ë°œ ë¬¸ì œì™€ ì¬ì„¤ì¹˜**

```bash
docker compose exec jenkins docker ps
OCI runtime exec failed: exec failed: unable to start container process: exec: "docker": executable file not found in $PATH
```

```bash
docker compose exec --privileged -u root jenkins bash

root@4aec55fcb34f:/# curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null
apt-get update && apt install docker-ce-cli curl tree jq yq -y
```

### **7. ìµœì¢… ë™ì‘ ê²€ì¦**

```bash
docker compose exec jenkins docker ps

CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS                    PORTS                                                                                          NAMES
af793fe999f9   jenkins/jenkins        "/usr/bin/tini -- /uâ€¦"   6 minutes ago    Up 5 minutes              0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp, 0.0.0.0:50000->50000/tcp, [::]:50000->50000/tcp   jenkins
f5292520283a   gogs/gogs              "/app/gogs/docker/stâ€¦"   27 minutes ago   Up 27 minutes (healthy)   0.0.0.0:3000->3000/tcp, [::]:3000->3000/tcp, 0.0.0.0:10022->22/tcp, [::]:10022->22/tcp         gogs
ea4fa45f8d82   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   30 minutes ago   Up 30 minutes             0.0.0.0:30000-30003->30000-30003/tcp, 0.0.0.0:44501->6443/tcp                                  myk8s-control-plane
665b94422e49   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   30 minutes ago   Up 30 minutes                                                                                                            myk8s-worker
```

```bash
docker compose exec jenkins cat /etc/group

# ê²°ê³¼
root:x:0:
daemon:x:1:
bin:x:2:
sys:x:3:
...
jenkins:x:1000:
```

- `jenkins` ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ì—ì„œ Docker ëª…ë ¹ ì •ìƒ ë™ì‘ í™•ì¸í•¨

---

## **âš™ï¸ Gogs ì»¨í…Œì´ë„ˆ ì´ˆê¸° ì„¤ì •**

### **1. ì´ˆê¸° ì„¤ì • ì›¹ ì ‘ì†**

**`http://<**ìì‹ ì˜ IP**>:3000/install**`

```
ë°ì´í„°ë² ì´ìŠ¤ ìœ í˜•: SQLite3
ì• í”Œë¦¬ì¼€ì´ì…˜ URL: http://<ìì‹ ì˜ IP>:3000/
ê¸°ë³¸ ë¸Œëœì¹˜: main
ê´€ë¦¬ì ê³„ì • ì„¤ì •: ì´ë¦„(ê³„ì •ëª… devops), ë¹„ë°€ë²ˆí˜¸, ì´ë©”ì¼ ì…ë ¥
```
![](https://velog.velcdn.com/images/tlsalswls123/post/61048f7e-8262-46d7-a842-aed42665e6bd/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/519f7675-8a43-483e-961d-8b244c6f3a37/image.png)

### **2. Token ìƒì„±**

Your Settings > Applications > Generate New Token - Token Name(devops) ë©”ëª¨í•˜ê¸°
![](https://velog.velcdn.com/images/tlsalswls123/post/c21c6e5d-5161-429d-a346-8905f64c4033/image.png)

### **3. ê°œë°œíŒ€ìš© Repository ìƒì„±**

```
Repository Name : dev-app
Visibility : (Check) This repository is Private
.gitignore : Python
Readme : Default â†’ (Check) initialize this repository with selected files and template

â‡’ Create Repository
```
![](https://velog.velcdn.com/images/tlsalswls123/post/0e20b6f2-cd9e-4029-a2dd-4db81be2d6ee/image.png)

### **4. ë°ë¸Œì˜µìŠ¤íŒ€ìš© Repository ìƒì„±**

```
Repository Name : ops-deploy
Visibility : (Check) This repository is Private
.gitignore : Python
Readme : Default â†’ (Check) initialize this repository with selected files and template
```
![](https://velog.velcdn.com/images/tlsalswls123/post/468abb47-2f4d-45d7-a97a-d1869f1f7705/image.png)

---

## **ğŸš Gogs ì‹¤ìŠµì„ ìœ„í•œ ì €ì¥ì†Œ ì„¤ì •**

### **1. Gogs ì»¨í…Œì´ë„ˆ ì…¸ ì ‘ì†**

```bash
docker exec -it gogs bash
f5292520283a:/app/gogs# 
```

```bash
f5292520283a:/app/gogs# TMOUT=0
pwd
ls
cd /data
/app/gogs

# ê²°ê³¼
data    docker  gogs    log
```

```bash
f5292520283a:/data# ls -al

# ê²°ê³¼
total 20
drwxr-xr-x    5 git      git           4096 Nov  1 09:00 .
drwxr-xr-x    1 root     root          4096 Nov  1 09:00 ..
drwxr-xr-x    4 git      git           4096 Nov  1 09:36 git
drwxr-xr-x    5 git      git           4096 Nov  1 09:00 gogs
drwx------    2 git      git           4096 Nov  1 09:00 ssh
```

### **2. í† í°Â·IP í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

```bash
f5292520283a:/data# TOKEN=<ê°ì Gogs Token>
f5292520283a:/data# MyIP=<ê°ì ìì‹ ì˜ IP>
```

### **3. dev-app ì €ì¥ì†Œ í´ë¡ **

```bash
git clone http://devops:$TOKEN@$MyIP:3000/devops/dev-app.git

f5292520283a:/data# git clone http://devops:$TOKEN@$MyIP:3000/devops/dev-app.git
Cloning into 'dev-app'...
remote: Enumerating objects: 4, done.
remote: Counting objects: 100% (4/4), done.
remote: Compressing objects: 100% (3/3), done.
remote: Total 4 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)
Unpacking objects: 100% (4/4), 690 bytes | 690.00 KiB/s, done.
```

```bash
f5292520283a:/data# cd /data/dev-app
f5292520283a:/data/dev-app# tree
.
â””â”€â”€ README.md

0 directories, 1 files
```

### **4. Git ë¡œì»¬ ì„¤ì •**

```bash
f5292520283a:/data/dev-app# git config --local user.name "devops"
git config --local user.email "a@a.com"
git config --local init.defaultBranch main
git config --local credential.helper store
git --no-pager config --local --list
cat .git/config

# ê²°ê³¼
core.repositoryformatversion=0
core.filemode=true
core.bare=false
core.logallrefupdates=true
remote.origin.url=http://devops:6f5bccf278f4e14b32d16f36db047b6440357acd@192.168.219.107:3000/devops/dev-app.git
remote.origin.fetch=+refs/heads/*:refs/remotes/origin/*
branch.main.remote=origin
branch.main.merge=refs/heads/main
user.name=devops
user.email=a@a.com
init.defaultbranch=main
credential.helper=store
[core]
	repositoryformatversion = 0
	filemode = true
	bare = false
	logallrefupdates = true
[remote "origin"]
	url = http://devops:6f5bccf278f4e14b32d16f36db047b6440357acd@192.168.219.107:3000/devops/dev-app.git
	fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
	remote = origin
	merge = refs/heads/main
[user]
	name = devops
	email = a@a.com
[init]
	defaultBranch = main
[credential]
	helper = store
```

### **5. ì• í”Œë¦¬ì¼€ì´ì…˜ íŒŒì¼ ì‘ì„±**

**(1) server.py íŒŒì¼**

```bash
f5292520283a:/data/dev-app# cat > server.py <<EOF
from http.server import ThreadingHTTPServer, BaseHTTPRequestHandler
from datetime import datetime
import socket

class RequestHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        match self.path:
            case '/':
                now = datetime.now()
                hostname = socket.gethostname()
                response_string = now.strftime("The time is %-I:%M:%S %p, VERSION 0.0.1\n")
                response_string += f"Server hostname: {hostname}\n"                
                self.respond_with(200, response_string)
            case '/healthz':
                self.respond_with(200, "Healthy")
            case _:
                self.respond_with(404, "Not Found")

    def respond_with(self, status_code: int, content: str) -> None:
        self.send_response(status_code)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(bytes(content, "utf-8")) 

def startServer():
    try:
        server = ThreadingHTTPServer(('', 80), RequestHandler)
        print("Listening on " + ":".join(map(str, server.server_address)))
        server.serve_forever()
    except KeyboardInterrupt:
        server.shutdown()

if __name__== "__main__":
    startServer()
EOF
```

**(2) Dockerfile**

```bash
f5292520283a:/data/dev-app# cat > Dockerfile <<EOF
FROM python:3.12
ENV PYTHONUNBUFFERED 1
COPY . /app
WORKDIR /app 
CMD python3 server.py
EOF
```

**(3) VERSION**

```bash
f5292520283a:/data/dev-app# echo "0.0.1" > VERSION
```

### **6. ì»¤ë°‹ ë° í‘¸ì‹œ**

```bash
f5292520283a:/data/dev-app# tree
git status
git add .
git commit -m "Add dev-app"
git push -u origin main

# ê²°ê³¼
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ README.md
â”œâ”€â”€ VERSION
â””â”€â”€ server.py

0 directories, 4 files
On branch main
Your branch is up to date with 'origin/main'.

Untracked files:
  (use "git add <file>..." to include in what will be committed)
	Dockerfile
	VERSION
	server.py

nothing added to commit but untracked files present (use "git add" to track)
[main 5e0b56b] Add dev-app
 3 files changed, 40 insertions(+)
 create mode 100644 Dockerfile
 create mode 100644 VERSION
 create mode 100644 server.py
Enumerating objects: 6, done.
Counting objects: 100% (6/6), done.
Delta compression using up to 18 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (5/5), 1014 bytes | 1014.00 KiB/s, done.
Total 5 (delta 0), reused 0 (delta 0), pack-reused 0 (from 0)
To http://192.168.219.107:3000/devops/dev-app.git
   bcd7702..5e0b56b  main -> main
branch 'main' set up to track 'origin/main'.
```
![](https://velog.velcdn.com/images/tlsalswls123/post/a489a5e6-b98b-4669-9e14-4d8b28b15d3a/image.png)

---

## **ğŸ³ ë„ì»¤ í—ˆë¸Œ**

### **1. ë„ì»¤ í—ˆë¸Œ í† í° ë°œê¸‰**
![](https://velog.velcdn.com/images/tlsalswls123/post/916813da-9428-4585-b4ea-396d36b6ec0e/image.png)

### **2. Private ë¦¬í¬ì§€í† ë¦¬ ìƒì„±(dev-app)**
![](https://velog.velcdn.com/images/tlsalswls123/post/330f8045-957e-4b23-804a-9b9ac4125a41/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/5ee0732c-7a18-4f6d-8efa-a7dd00cb8930/image.png)

---

## **ğŸ¤– Jenkins CI Pipeline**

### **1. Jenkins í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜**
![](https://velog.velcdn.com/images/tlsalswls123/post/8fe4f73e-aa20-41cb-be77-a00cec51ab47/image.png)

- **Pipeline Stage View** - [Docs](https://plugins.jenkins.io/pipeline-stage-view/)
- **Docker Pipeline** : building, testing, and using Docker images from Jenkins Pipeline - [Docs](https://plugins.jenkins.io/docker-workflow/)
- **Gogs** : Webhook Plugin - [Docs](https://plugins.jenkins.io/gogs-webhook/)

### **2. ìê²©ì¦ëª… ì„¤ì •**

**Jenkins ê´€ë¦¬ â†’ Credentials â†’ Globals â†’ Add Credentials**

```
(1) Gogs Repo ìê²©ì¦ëª… ì„¤ì • : gogs-crd
Kind : Username with password
Username : devops
Password : <Gogs í† í°>
ID : gogs-crd
```
![](https://velog.velcdn.com/images/tlsalswls123/post/7b5af0d6-0832-4a81-ad4d-5696944414f8/image.png)

```
(2) ë„ì»¤ í—ˆë¸Œ ìê²©ì¦ëª… ì„¤ì • : dockerhub-crd
Kind : Username with password
Username : <ë„ì»¤ ê³„ì •ëª…>
Password : <ë„ì»¤ ê³„ì • ì•”í˜¸ í˜¹ì€ í† í°>
ID : dockerhub-crd
```
![](https://velog.velcdn.com/images/tlsalswls123/post/9d891ef4-3bfc-4426-9e05-464d50f67c74/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/1efdf40c-8ecb-4398-ae00-d02e55b8cd03/image.png)

### **3. Jenkins Item ìƒì„±**

**(1) item ì§€ì •**
![](https://velog.velcdn.com/images/tlsalswls123/post/a1498877-59b3-44ee-bca1-955b117046cd/image.png)

**(2) Pipeline script**

```bash
pipeline {
    agent any
    environment {
        DOCKER_IMAGE = '<ìì‹ ì˜ ë„ì»¤ í—ˆë¸Œ ê³„ì •>/dev-app' // Docker ì´ë¯¸ì§€ ì´ë¦„
    }
    stages {
        stage('Checkout') {
            steps {
                 git branch: 'main',
                 url: 'http://<ìì‹ ì˜ IP>:3000/devops/dev-app.git',  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: 'gogs-crd'  // Credentials ID
            }
        }
        stage('Read VERSION') {
            steps {
                script {
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version = readFile('VERSION').trim()
                    echo "Version found: ${version}"
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG = version
                }
            }
        }
        stage('Docker Build and Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-crd') {
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        appImage.push()
                        appImage.push("latest")
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"
        }
        failure {
            echo "Pipeline failed. Please check the logs."
        }
    }
}
```
![](https://velog.velcdn.com/images/tlsalswls123/post/8dc02f4d-b8a4-4f8a-86cd-396f82103ea7/image.png)

**(3) ë¹Œë“œ ì§„í–‰**
![](https://velog.velcdn.com/images/tlsalswls123/post/36f77d7a-6dc2-490a-ad3f-cc5ab5d3a53d/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/937b5d6a-014c-4caa-8c2d-d91253b7c046/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/41fb7484-a71e-4cfb-84ce-bc072697072e/image.png)

---

## **ğŸ§­ Deploying to Kubernetes**

### **1. Deployment ìƒì„±**

```bash
DHUSER=<ë„ì»¤ í—ˆë¸Œ ê³„ì •ëª…>
```

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/$DHUSER/dev-app:0.0.1
        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 30
          httpGet:
            path: /healthz
            port: 80
            scheme: HTTP
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
EOF
deployment.apps/timeserver created
```

### **2. ImagePullBackOff ì›ì¸ ì§„ë‹¨**

```bash
kubectl get deploy,rs,pod -o wide

# ê²°ê³¼
NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                               SELECTOR
deployment.apps/timeserver   0/2     2            0           81s   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod

NAME                                    DESIRED   CURRENT   READY   AGE   CONTAINERS             IMAGES                               SELECTOR
replicaset.apps/timeserver-6cd9654cc7   2         2         0       81s   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=6cd9654cc7

NAME                              READY   STATUS             RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
pod/timeserver-6cd9654cc7-8jtdb   0/1     ImagePullBackOff   0          81s   10.244.1.2   myk8s-worker   <none>           <none>
pod/timeserver-6cd9654cc7-hkfw5   0/1     ImagePullBackOff   0          81s   10.244.1.3   myk8s-worker   <none>           <none>
```

```bash
kubectl describe pod

# ê²°ê³¼
...
Events:
  Type     Reason     Age                 From               Message
  ----     ------     ----                ----               -------
  Normal   Scheduled  104s                default-scheduler  Successfully assigned default/timeserver-6cd9654cc7-hkfw5 to myk8s-worker
  Normal   BackOff    22s (x5 over 102s)  kubelet            Back-off pulling image "docker.io/shinminjin/dev-app:0.0.1"
  Warning  Failed     22s (x5 over 102s)  kubelet            Error: ImagePullBackOff
  Normal   Pulling    10s (x4 over 104s)  kubelet            Pulling image "docker.io/shinminjin/dev-app:0.0.1"
  Warning  Failed     9s (x4 over 102s)   kubelet            Failed to pull image "docker.io/shinminjin/dev-app:0.0.1": failed to pull and unpack image "docker.io/shinminjin/dev-app:0.0.1": failed to resolve reference "docker.io/shinminjin/dev-app:0.0.1": pull access denied, repository does not exist or may require authorization: server message: insufficient_scope: authorization failed
  Warning  Failed     9s (x4 over 102s)   kubelet            Error: ErrImagePull
```

- ë³´í†µ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì˜ëª» ê¸°ì…í•˜ëŠ” ê²½ìš°ì— ë°œìƒ
- í˜¹ì€ ì´ë¯¸ì§€ ì €ì¥ì†Œì— ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜, ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ëŠ” **ìê²© ì¦ëª…ì´ ì—†ëŠ” ê²½ìš°**ì— ë°œìƒ

### **3. Docker Hub ìê²©ì¦ëª… ì‹œí¬ë¦¿ ìƒì„±**

```bash
DHUSER=<ë„ì»¤ í—ˆë¸Œ ê³„ì •>
DHPASS=<ë„ì»¤ í—ˆë¸Œ ì•”í˜¸ í˜¹ì€ í† í°>
```

```bash
kubectl create secret docker-registry dockerhub-secret \
  --docker-server=https://index.docker.io/v1/ \
  --docker-username=$DHUSER \
  --docker-password=$DHPASS
  
# ê²°ê³¼
secret/dockerhub-secret created
```

### **4. Deploymentì— imagePullSecrets ì ìš©**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeserver
spec:
  replicas: 2
  selector:
    matchLabels:
      pod: timeserver-pod
  template:
    metadata:
      labels:
        pod: timeserver-pod
    spec:
      containers:
      - name: timeserver-container
        image: docker.io/$DHUSER/dev-app:0.0.1
        livenessProbe:
          initialDelaySeconds: 30
          periodSeconds: 30
          httpGet:
            path: /healthz
            port: 80
            scheme: HTTP
          timeoutSeconds: 5
          failureThreshold: 3
          successThreshold: 1
      imagePullSecrets:
      - name: dockerhub-secret
EOF

# ê²°ê³¼
deployment.apps/timeserver configured
```

### **5. ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸**

```bash
kubectl get deploy,rs,pod -o wide

# ê²°ê³¼
NAME                         READY   UP-TO-DATE   AVAILABLE   AGE    CONTAINERS             IMAGES                               SELECTOR
deployment.apps/timeserver   2/2     2            2           7m5s   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod

NAME                                    DESIRED   CURRENT   READY   AGE    CONTAINERS             IMAGES                               SELECTOR
replicaset.apps/timeserver-69c87f9f8c   2         2         2       60s    timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=69c87f9f8c
replicaset.apps/timeserver-6cd9654cc7   0         0         0       7m5s   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=6cd9654cc7

NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
pod/timeserver-69c87f9f8c-jr2j6   1/1     Running   0          60s   10.244.1.4   myk8s-worker   <none>           <none>
pod/timeserver-69c87f9f8c-tjlp2   1/1     Running   0          22s   10.244.1.5   myk8s-worker   <none>           <none>
```

### **6. Service ê³µê°œ**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Service
metadata:
  name: timeserver
spec:
  selector:
    pod: timeserver-pod
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    nodePort: 30000
  type: NodePort
EOF

# ê²°ê³¼
service/timeserver created
```

```bash
curl http://127.0.0.1:30000

# ê²°ê³¼
The time is 1:07:41 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
```

- í˜¸ì¶œ ì‹œ ì‹œê°„/í˜¸ìŠ¤íŠ¸ëª… ì‘ë‹µ í™•ì¸

### **7. ë°˜ë³µ ì ‘ì†**

```bash
while true; do curl -s --connect-timeout 1 http://127.0.0.1:30000 ; sleep 1 ; done

# ê²°ê³¼
The time is 1:08:23 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
The time is 1:08:24 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:08:25 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:08:26 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:08:27 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:08:28 PM, VERSION 0.0.1
...
```

---

## **ğŸ–¥ï¸ Updating your application : k8s Deploying an application with Jenkins**

### **1. Git ë°˜ì˜**

**ìƒ˜í”Œ ì•± server.py, VERSION ì½”ë“œ ë³€ê²½(0.0.2)**

```bash
f5292520283a:/data/dev-app# git add . && git commit -m "VERSION $(cat VERSION) Changed" && git push -u origin main

# ê²°ê³¼
[main cc68f85] VERSION 0.0.2 Changed
 2 files changed, 2 insertions(+), 2 deletions(-)
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 18 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (4/4), 340 bytes | 340.00 KiB/s, done.
Total 4 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
To http://192.168.219.107:3000/devops/dev-app.git
   5e0b56b..cc68f85  main -> main
branch 'main' set up to track 'origin/main'.
```
![](https://velog.velcdn.com/images/tlsalswls123/post/0cfdbbc7-497d-46bc-9eb0-50874905ade5/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/861e5f15-265b-4bb3-8e17-9a08eba9e43b/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/961005f5-8f06-4815-be0e-0a20da3ae1a3/image.png)

### **2. VERSION 0.0.1 í™•ì¸**

```bash
The time is 1:16:26 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:16:27 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
The time is 1:16:28 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
The time is 1:16:29 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:16:30 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:16:31 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:16:32 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:16:33 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
The time is 1:16:34 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-jr2j6
...
```

```bash
kubectl get deploy,rs,pod,svc,ep -owide

# ê²°ê³¼
NAME                         READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS             IMAGES                               SELECTOR
deployment.apps/timeserver   2/2     2            2           18m   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod

NAME                                    DESIRED   CURRENT   READY   AGE   CONTAINERS             IMAGES                               SELECTOR
replicaset.apps/timeserver-69c87f9f8c   2         2         2       12m   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=69c87f9f8c
replicaset.apps/timeserver-6cd9654cc7   0         0         0       18m   timeserver-container   docker.io/shinminjin/dev-app:0.0.1   pod=timeserver-pod,pod-template-hash=6cd9654cc7

NAME                              READY   STATUS    RESTARTS   AGE   IP           NODE           NOMINATED NODE   READINESS GATES
pod/timeserver-69c87f9f8c-jr2j6   1/1     Running   0          12m   10.244.1.4   myk8s-worker   <none>           <none>
pod/timeserver-69c87f9f8c-tjlp2   1/1     Running   0          11m   10.244.1.5   myk8s-worker   <none>           <none>

NAME                 TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE     SELECTOR
service/kubernetes   ClusterIP   10.96.0.1      <none>        443/TCP        4h19m   <none>
service/timeserver   NodePort    10.96.88.179   <none>        80:30000/TCP   10m     pod=timeserver-pod

NAME                   ENDPOINTS                     AGE
endpoints/kubernetes   172.18.0.2:6443               4h19m
endpoints/timeserver   10.244.1.4:80,10.244.1.5:80   10m
```

- CI ë¹Œë“œÂ·í‘¸ì‹œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ K8s ìª½ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸ê°€ ìë™ìœ¼ë¡œ ë°˜ì˜ë˜ì§€ ì•ŠìŒ

### **3. ìˆ˜ë™ ë¡¤ë§ ì—…ë°ì´íŠ¸ ì‹¤í–‰**

```bash
kubectl set image deployment timeserver timeserver-container=$DHUSER/dev-app:0.0.2 && watch -d "kubectl get deploy,ep timeserver -owide; echo; kubectl get rs,pod"
```

![](https://velog.velcdn.com/images/tlsalswls123/post/01a5dbf7-ab20-4beb-9711-ccd08ccb1da1/image.png)

```bash
Server hostname: timeserver-69c87f9f8c-jr2j6
The time is 1:18:15 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:18:16 PM, VERSION 0.0.1
Server hostname: timeserver-69c87f9f8c-tjlp2
The time is 1:18:17 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-28lmt
The time is 1:18:18 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-28lmt
The time is 1:18:19 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-28lmt
The time is 1:18:20 PM, VERSION 0.0.2
...
```
- ì´ë¯¸ì§€ íƒœê·¸ 0.0.2ë¡œ ê°±ì‹ í•¨

---

## **ğŸ” Gogs Webhooks ì„¤ì •**

### **1. Gogs ë³´ì•ˆ ì„¤ì •(app.ini) ì—…ë°ì´íŠ¸**

```bash
f5292520283a:/data/dev-app# cd ../gogs/conf/
f5292520283a:/data/gogs/conf# vi app.ini
```

```bash
[security]      
INSTALL_LOCK = true            
SECRET_KEY   = QYNoxvpdPUjpRf1
LOCAL_NETWORK_ALLOWLIST = 192.168.254.110 # ê°ì ìì‹ ì˜ IP
```

```bash
f5292520283a:/data/gogs/conf# exit
exit

# gogs ì¬ì‹œì‘
docker compose restart gogs

# ê²°ê³¼
WARN[0000] The "DOCKER_GID" variable is not set. Defaulting to a blank string. 
[+] Restarting 1/1
 âœ” Container gogs  Started
```

### **2. Gogs Webhook â†’ Jenkins íŠ¸ë¦¬ê±° ì„¤ì •**

```
Payload URL : http://192.168.219.107:8080/gogs-webhook/?job=SCM-Pipeline/  # ê°ì ìì‹ ì˜ IP
Content Type : application/json
Secret : qwe123
When should this webhook be triggered? : Just the push event
Active : Check
```
![](https://velog.velcdn.com/images/tlsalswls123/post/a7dbc900-ef46-4c7d-8828-86c0e1bcd4aa/image.png)

### **3. Jenkins Item ìƒì„±(Pipeline) : SCM-Pipeline**
![](https://velog.velcdn.com/images/tlsalswls123/post/2bbae0b9-8a73-4979-84cc-9fb5cc9405be/image.png)

```
GitHub project : http://<ìì‹ ì˜ IP>:3000/<Gogs ê³„ì •ëª…>/dev-app
Use Gogs secret : qwe123
Pipeline script from SCM
- SCM : Git
	- Repo URL(http://<ìì‹ ì˜ IP>:3000/<Gogs ê³„ì •ëª…>/dev-app)
	- Credentials(devops/***)
	- Branch(*/main)
- Script Path : Jenkinsfile
```
![](https://velog.velcdn.com/images/tlsalswls123/post/f46064ea-8e4c-40af-9f09-244c5efa3fe7/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/2ad6a5b0-29fb-4afb-b592-79381de5b706/image.png)

### **4. Gogs ì»¨í…Œì´ë„ˆ ì¬ì ‘ì† ë° ë¦¬í¬ì§€í† ë¦¬ ê²½ë¡œ ì´ë™**

```bash
docker exec -it gogs bash
f5292520283a:/app/gogs# cd ../../data/dev-app/
f5292520283a:/data/dev-app# 
```

### **5. Jenkinsfile ìƒì„± ë° í‘¸ì‹œ**

```bash
f5292520283a:/data/dev-app# tree
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ README.md
â”œâ”€â”€ VERSION
â””â”€â”€ server.py

0 directories, 4 files
```

```bash
f5292520283a:/data/dev-app# touch Jenkinsfile
```

```bash
pipeline {
    agent any
    environment {
        DOCKER_IMAGE = '<ìì‹ ì˜ ë„ì»¤ í—ˆë¸Œ ê³„ì •>/dev-app' // Docker ì´ë¯¸ì§€ ì´ë¦„
    }
    stages {
        stage('Checkout') {
            steps {
                 git branch: 'main',
                 url: 'http://<ìì‹ ì˜ IP>:3000/devops/dev-app.git',  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: 'gogs-crd'  // Credentials ID
            }
        }
        stage('Read VERSION') {
            steps {
                script {
                    // VERSION íŒŒì¼ ì½ê¸°
                    def version = readFile('VERSION').trim()
                    echo "Version found: ${version}"
                    // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
                    env.DOCKER_TAG = version
                }
            }
        }
        stage('Docker Build and Push') {
            steps {
                script {
                    docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-crd') {
                        // DOCKER_TAG ì‚¬ìš©
                        def appImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                        appImage.push()
                        appImage.push("latest")
                    }
                }
            }
        }
    }
    post {
        success {
            echo "Docker image ${DOCKER_IMAGE}:${DOCKER_TAG} has been built and pushed successfully!"
        }
        failure {
            echo "Pipeline failed. Please check the logs."
        }
    }
}
```

```bash
f5292520283a:/data/dev-app# git add . && git commit -m "VERSION $(cat VERSION) Changed" && git push -u origin main

# ê²°ê³¼
[main 8d36c4b] VERSION 0.0.3 Changed
 3 files changed, 48 insertions(+), 2 deletions(-)
 create mode 100644 Jenkinsfile
Enumerating objects: 8, done.
Counting objects: 100% (8/8), done.
Delta compression using up to 18 threads
Compressing objects: 100% (4/4), done.
Writing objects: 100% (5/5), 1.06 KiB | 1.06 MiB/s, done.
Total 5 (delta 1), reused 0 (delta 0), pack-reused 0 (from 0)
To http://192.168.219.107:3000/devops/dev-app.git
   cc68f85..8d36c4b  main -> main
branch 'main' set up to track 'origin/main'.
```
![](https://velog.velcdn.com/images/tlsalswls123/post/e23db604-0b1b-4284-9773-e13a7458d05c/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/39c0fe68-c7c1-4462-a27a-6187590d0988/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/118ce629-6459-4220-aefd-c7e9dacb3968/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/0ab62ee3-e996-4f77-8fc0-f177617bcf21/image.png)

### **6. k8sì— ì‹ ê·œ ë²„ì „ ì ìš©**

```bash
kubectl set image deployment timeserver timeserver-container=$DHUSER/dev-app:0.0.3 && while true; do curl -s --connect-timeout 1 http://127.0.0.1:30000 ; sleep 1 ; done

# ê²°ê³¼
deployment.apps/timeserver image updated
Server hostname: timeserver-79d564b95c-28lmt
The time is 1:56:48 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-vpb6d
The time is 1:56:49 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-28lmt
The time is 1:56:50 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-vpb6d
The time is 1:56:51 PM, VERSION 0.0.2
Server hostname: timeserver-79d564b95c-vpb6d
The time is 1:56:52 PM, VERSION 0.0.3
Server hostname: timeserver-6566694f9d-vz2zr
The time is 1:56:53 PM, VERSION 0.0.3
Server hostname: timeserver-6566694f9d-vz2zr
The time is 1:56:54 PM, VERSION 0.0.3
Server hostname: timeserver-6566694f9d-vz2zr
The time is 1:56:55 PM, VERSION 0.0.3
...
```

---

## **ğŸŒ Jenkins CD by K8S(Kind)**

### **1. Jenkins ì»¨í…Œì´ë„ˆì— kubectl/helm ì„¤ì¹˜**

```bash
docker compose exec --privileged -u root jenkins bash
root@af793fe999f9:/# curl -LO "https://dl.k8s.io/release/v1.32.8/bin/linux/amd64/kubectl"

# ê²°ê³¼
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   138  100   138    0     0    252      0 --:--:-- --:--:-- --:--:--   251
100 54.6M  100 54.6M    0     0  15.8M      0  0:00:03  0:00:03 --:--:-- 22.7M
```

```bash
root@af793fe999f9:/# install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
kubectl version --client=true

# ê²°ê³¼
Client Version: v1.32.8
Kustomize Version: v5.5.0
```

```bash
root@af793fe999f9:/# curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
helm version

# ê²°ê³¼
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 11928  100 11928    0     0  27938      0 --:--:-- --:--:-- --:--:-- 27934
Downloading https://get.helm.sh/helm-v3.19.0-linux-amd64.tar.gz
Verifying checksum... Done.
Preparing to install helm into /usr/local/bin
helm installed into /usr/local/bin/helm
version.BuildInfo{Version:"v3.19.0", GitCommit:"3d8990f0836691f0229297773f3524598f46bda6", GitTreeState:"clean", GoVersion:"go1.24.7"}

root@af793fe999f9:/# exit
exit
```

### **2. í´ë¼ì´ì–¸íŠ¸ ë²„ì „ í™•ì¸**

```bash
docker compose exec jenkins kubectl version --client=true

# ê²°ê³¼
Client Version: v1.32.8
Kustomize Version: v5.5.0
```

```bash
docker compose exec jenkins helm version

# ê²°ê³¼
version.BuildInfo{Version:"v3.19.0", GitCommit:"3d8990f0836691f0229297773f3524598f46bda6", GitTreeState:"clean", GoVersion:"go1.24.7"}
```

### **3. Kind ì»¨íŠ¸ë¡¤í”Œë ˆì¸ IP í™•ì¸**

```bash
docker inspect myk8s-control-plane | grep IPAddress

# ê²°ê³¼
            "SecondaryIPAddresses": null,
            "IPAddress": "",
                    "IPAddress": "172.18.0.2",
```

### **4. Jenkins â†’ K8s API ì—°ê²° í™•ì¸**

```bash
docker exec -it jenkins curl https://172.18.0.2:6443/version -k

# ê²°ê³¼
{
  "major": "1",
  "minor": "32",
  "gitVersion": "v1.32.8",
  "gitCommit": "2e83bc4bf31e88b7de81d5341939d5ce2460f46f",
  "gitTreeState": "clean",
  "buildDate": "2025-08-13T14:21:22Z",
  "goVersion": "go1.23.11",
  "compiler": "gc",
  "platform": "linux/amd64"
}%                                                                     
```

### **5. Kubeconfig ì¤€ë¹„ ë° ìˆ˜ì •**

```bash
cp ~/.kube/config ./kube-config
```

```bash
        server: https://0.0.0.0:44501
      name: kind-myk8s
```

```bash
				server: https://<myk8s-control-plane ì»¨í…Œì´ë„ˆ IP>:6443 # ìì‹ ì˜ í™˜ê²½ì— ë§ê²Œ ë³€ê²½
		  name: kind-myk8s
```

### **6. Jenkins ìê²©ì¦ëª…(k8s-crd) ìƒì„±**
![](https://velog.velcdn.com/images/tlsalswls123/post/f846e64a-4d1a-41d5-a3e3-bfb9b7a67ea1/image.png)

### **7. íŒŒì´í”„ë¼ì¸ ì•„ì´í…œ ìƒì„±(k8s-cmd)**

```bash
pipeline {
    agent any
    environment {
        KUBECONFIG = credentials('k8s-crd')
    }
    stages {
        stage('List Pods') {
            steps {
                sh '''
                # Fetch and display Pods
                kubectl get pods -A --kubeconfig "$KUBECONFIG"
                '''
            }
        }
    }
}
```
![](https://velog.velcdn.com/images/tlsalswls123/post/055b63e6-ecc5-4432-bf00-cf77df7454ab/image.png)

---

## **ğŸ” Jenkinsë¥¼ ì´ìš©í•œ blue-green ë°°í¬**

### **1. ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ì •ë¦¬**

```bash
kubectl delete deploy,svc timeserver

# ê²°ê³¼
deployment.apps "timeserver" deleted from default namespace
service "timeserver" deleted from default namespace
```

### **2. ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë””ë ‰í„°ë¦¬ ìƒì„±**

```bash
f5292520283a:/data/dev-app# mkdir deploy
```

### **3. Blue/Green/Service ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„±**

```bash
f5292520283a:/data/dev-app# cat > deploy/echo-server-blue.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-blue
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: blue
  template:
    metadata:
      labels:
        app: echo-server
        version: blue
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Blue"
        ports:
        - containerPort: 5678
EOF

cat > deploy/echo-server-service.yaml <<EOF
apiVersion: v1
kind: Service
metadata:
  name: echo-server-service
spec:
  selector:
    app: echo-server
    version: blue
  ports:
  - protocol: TCP
    port: 80
    targetPort: 5678
    nodePort: 30000
  type: NodePort
EOF

cat > deploy/echo-server-green.yaml <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-server-green
spec:
  replicas: 2
  selector:
    matchLabels:
      app: echo-server
      version: green
  template:
    metadata:
      labels:
        app: echo-server
        version: green
    spec:
      containers:
      - name: echo-server
        image: hashicorp/http-echo
        args:
        - "-text=Hello from Green"
        ports:
        - containerPort: 5678
EOF
```

```bash
f5292520283a:/data/dev-app# tree
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ Jenkinsfile
â”œâ”€â”€ README.md
â”œâ”€â”€ VERSION
â”œâ”€â”€ deploy
â”‚   â”œâ”€â”€ echo-server-blue.yaml
â”‚   â”œâ”€â”€ echo-server-green.yaml
â”‚   â””â”€â”€ echo-server-service.yaml
â””â”€â”€ server.py

1 directories, 8 files
```

### **4. Git ì»¤ë°‹/í‘¸ì‹œë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°˜ì˜**

```bash
f5292520283a:/data/dev-app# git add . && git commit -m "Add echo server yaml" && git push -u origin main

# ê²°ê³¼
[main b7b758f] Add echo server yaml
 3 files changed, 60 insertions(+)
 create mode 100644 deploy/echo-server-blue.yaml
 create mode 100644 deploy/echo-server-green.yaml
 create mode 100644 deploy/echo-server-service.yaml
Enumerating objects: 7, done.
Counting objects: 100% (7/7), done.
Delta compression using up to 18 threads
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 789 bytes | 789.00 KiB/s, done.
Total 6 (delta 2), reused 0 (delta 0), pack-reused 0 (from 0)
To http://192.168.219.107:3000/devops/dev-app.git
   273223f..b7b758f  main -> main
branch 'main' set up to track 'origin/main'.
```
![](https://velog.velcdn.com/images/tlsalswls123/post/7f95ea80-c483-422f-acb9-0d18c0e730dd/image.png)

### **5. Blue-Green ê´€ì°°ìš© ë°˜ë³µ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰**

```bash
while true; do curl -s --connect-timeout 1 http://127.0.0.1:30000 ; echo ; sleep 1  ; kubectl get deploy -owide ; echo ; kubectl get svc,ep echo-server-service -owide ; echo "------------" ; done

# ê²°ê³¼
No resources found in default namespace.

Error from server (NotFound): services "echo-server-service" not found
Error from server (NotFound): endpoints "echo-server-service" not found
------------

No resources found in default namespace.

Error from server (NotFound): services "echo-server-service" not found
Error from server (NotFound): endpoints "echo-server-service" not found
------------

No resources found in default namespace.

Error from server (NotFound): services "echo-server-service" not found
Error from server (NotFound): endpoints "echo-server-service" not found
------------
...
```

### **6. Jenkins íŒŒì´í”„ë¼ì¸ ìƒì„±(k8s-bluegreen)**

```bash
pipeline {
    agent any

    environment {
        KUBECONFIG = credentials('k8s-crd')
    }

    stages {
        stage('Checkout') {
            steps {
                 git branch: 'main',
                 url: 'http://<ìì‹ ì˜ IP>:3000/devops/dev-app.git',  // Gitì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
                 credentialsId: 'gogs-crd'  // Credentials ID
            }
        }

        stage('container image build') {
            steps {
                echo "container image build"
            }
        }

        stage('container image upload') {
            steps {
                echo "container image upload"
            }
        }

        stage('k8s deployment blue version') {
            steps {
                sh "kubectl apply -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"
                sh "kubectl apply -f ./deploy/echo-server-service.yaml --kubeconfig $KUBECONFIG"
            }
        }

        stage('approve green version') {
            steps {
                input message: 'approve green version', ok: "Yes"
            }
        }

        stage('k8s deployment green version') {
            steps {
	        	sh "kubectl apply -f ./deploy/echo-server-green.yaml --kubeconfig $KUBECONFIG"
            }
        }

        stage('approve version switching') {
            steps {
                script {
                    returnValue = input message: 'Green switching?', ok: "Yes", parameters: [booleanParam(defaultValue: true, name: 'IS_SWITCHED')]
                    if (returnValue) {
                        sh "kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"green\"}}}' --kubeconfig $KUBECONFIG"
                    }
                }
            }
        }

        stage('Blue Rollback') {
            steps {
                script {
                    returnValue = input message: 'Blue Rollback?', parameters: [choice(choices: ['done', 'rollback'], name: 'IS_ROLLBACk')]
                    if (returnValue == "done") {
                        sh "kubectl delete -f ./deploy/echo-server-blue.yaml --kubeconfig $KUBECONFIG"
                    }
                    if (returnValue == "rollback") {
                        sh "kubectl patch svc echo-server-service -p '{\"spec\": {\"selector\": {\"version\": \"blue\"}}}' --kubeconfig $KUBECONFIG"
                    }
                }
            }
        }
    }
}
```
![](https://velog.velcdn.com/images/tlsalswls123/post/59fe153e-a2f6-4a5a-bc64-5220a6f846c5/image.png)

### **7. ìˆ˜ë™ ìŠ¹ì¸ ë‹¨ê³„ ì•ˆë‚´**

**(1) ê·¸ë¦° í™˜ê²½ ë°°í¬ ì§„í–‰ ì—¬ë¶€**
![](https://velog.velcdn.com/images/tlsalswls123/post/7b176371-9417-408a-82cf-829a1a594d1e/image.png)

**(2) ì„œë¹„ìŠ¤ ì „í™˜(íŠ¸ë˜í”½ ê·¸ë¦°) ì—¬ë¶€**
![](https://velog.velcdn.com/images/tlsalswls123/post/497302b5-a6c9-4953-9f05-148c8838ccc1/image.png)

**(3) ë¸”ë£¨ ì‚­ì œ ë˜ëŠ” ë¡¤ë°±(ì„œë¹„ìŠ¤ blueë¡œ ì¬ì „í™˜) ì„ íƒ**
![](https://velog.velcdn.com/images/tlsalswls123/post/006be71e-f980-463d-aa7d-cc586f9e1b27/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/b28f3f87-818c-4853-8e8c-bf496be73227/image.png)

