---
title: CI/CD 8ì£¼ì°¨ ì •ë¦¬
date: 2025-12-14 15:00:00 +0900
categories: [CI/CD]
tags: [CI/CD]
---

## **ğŸ§© Vault ì„¤ì¹˜ on K8S**

### **1. K8S(kind) ì„¤ì¹˜**

**(1) kind í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    ingress-ready: true
  extraPortMappings:
  - containerPort: 30000  # Vault Web UI
    hostPort: 30000
  - containerPort: 30001  # Sample application
    hostPort: 30001
EOF
```

**(2) kind ì„¤ì¹˜ í™•ì¸**

```bash
docker ps

CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                             NAMES
5fbe8f63e01f   kindest/node:v1.32.8   "/usr/local/bin/entrâ€¦"   47 seconds ago   Up 46 seconds   0.0.0.0:30000-30001->30000-30001/tcp, 127.0.0.1:40687->6443/tcp   myk8s-control-plane
```

- `docker ps`ë¡œ kind ë…¸ë“œ ì»¨í…Œì´ë„ˆê°€ ì˜¬ë¼ì™”ëŠ”ì§€ í™•ì¸í•¨
- 30000~30001 í¬íŠ¸ì™€ API Server í¬íŠ¸(6443)ê°€ ì •ìƒ ë°”ì¸ë”©ëœ ìƒíƒœ í™•ì¸í•¨

**(3) kind ë…¸ë“œì— ê¸°ë³¸ ìœ í‹¸ ì„¤ì¹˜**

```bash
docker exec -it myk8s-control-plane sh -c 'apt update && apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git vim -y'
```

---

### **2. Vault ì„¤ì¹˜**

**(1) Vault ì„¤ì¹˜ ì¤€ë¹„**

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com
helm repo update
```

```bash
helm search repo hashicorp/vault

NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                          
hashicorp/vault                 	0.31.0       	1.20.4     	Official HashiCorp Vault Chart       
hashicorp/vault-secrets-gateway 	0.0.2        	0.1.0      	A Helm chart for Kubernetes          
hashicorp/vault-secrets-operator	1.1.0        	1.1.0      	Official Vault Secrets Operator Chart
```

- Vault Helm Chart ì„¤ì¹˜ë¥¼ ìœ„í•´ Hashicorp Helm repoë¥¼ ë“±ë¡í•˜ê³  ìµœì‹ í™”í•¨
- ì„¤ì¹˜ ê°€ëŠ¥í•œ ì°¨íŠ¸ ëª©ë¡(vault / vault-secrets-operator ë“±) í™•ì¸í•¨

**(2) Vault ì „ìš© Namespace ìƒì„±**

```bash
kubectl create namespace vault

namespace/vault created
```

**(3) Vault Helm values êµ¬ì„±**

```bash
cat <<EOF > vault-values.yaml
global:
  enabled: true
  tlsDisable: true

server:
  standalone:
    enabled: true
    config: |
      ui = true

      listener "tcp" {
        address = "[::]:8200"
        cluster_address = "[::]:8201"
        tls_disable = 1
      }

      storage "file" {
        path = "/vault/data"
      }

  dataStorage:
    enabled: true
    size: "10Gi"
    mountPath: "/vault/data"

  auditStorage:
    enabled: true
    size: "10Gi"
    mountPath: "/vault/logs"

  service:
    enabled: true
    type: NodePort
    nodePort: 30000
  
ui:
  enabled: true

injector:
  enabled: false
EOF
```

- Standalone ëª¨ë“œ + file storage ê¸°ë°˜ìœ¼ë¡œ êµ¬ì„±í•¨
- UI í™œì„±í™”, TLS ë¹„í™œì„±í™”, ServiceëŠ” NodePort(`30000`)ë¡œ ë…¸ì¶œí•¨
- data/audit PVC ê°ê° 10Gië¡œ ì„¤ì •í•¨
- injectorëŠ” ë¹„í™œì„±í™”í•¨

**(4) Vault Helm ì„¤ì¹˜ ìˆ˜í–‰**

```bash
helm upgrade vault hashicorp/vault -n vault -f vault-values.yaml --install --dry-run=client
helm upgrade vault hashicorp/vault -n vault -f vault-values.yaml --install --version 0.31.0

# ê²°ê³¼
Release "vault" does not exist. Installing it now.
NAME: vault
LAST DEPLOYED: Sat Dec 13 16:34:45 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

- `-dry-run=client`ë¡œ ë Œë”ë§/ê²€ì¦ í›„ ì‹¤ì œ ì„¤ì¹˜ ìˆ˜í–‰í•¨
- ì°¨íŠ¸ ë²„ì „ì€ `0.31.0`, ì•± ë²„ì „ì€ `1.20.4`ë¡œ ì„¤ì¹˜ë¨
- ë¦´ë¦¬ì¦ˆ ì´ë¦„ì€ `vault`, ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” `vault`ì„

**(5) Vault ë¦¬ì†ŒìŠ¤ ìƒíƒœ í™•ì¸**

```bash
kubectl get sts,pods,svc,ep,pvc,cm -n vault

NAME                     READY   AGE
statefulset.apps/vault   0/1     38s

NAME          READY   STATUS    RESTARTS   AGE
pod/vault-0   0/1     Running   0          38s

NAME                     TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
service/vault            NodePort    10.96.2.205     <none>        8200:30000/TCP,8201:31431/TCP   38s
service/vault-internal   ClusterIP   None            <none>        8200/TCP,8201/TCP               38s
service/vault-ui         ClusterIP   10.96.112.199   <none>        8200/TCP                        38s

NAME                       ENDPOINTS                         AGE
endpoints/vault            10.244.0.7:8201,10.244.0.7:8200   38s
endpoints/vault-internal   10.244.0.7:8201,10.244.0.7:8200   38s
endpoints/vault-ui         10.244.0.7:8200                   38s

NAME                                  STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/audit-vault-0   Bound    pvc-32f2a699-e587-46dc-a883-34148df076d3   10Gi       RWO            standard       <unset>                 38s
persistentvolumeclaim/data-vault-0    Bound    pvc-e01ff826-3c05-41a6-9198-e658ea251659   10Gi       RWO            standard       <unset>                 38s

NAME                         DATA   AGE
configmap/kube-root-ca.crt   1      4m21s
configmap/vault-config       1      38s
```

- StatefulSet `vault`ê°€ 0/1 READY ìƒíƒœë¡œ ëŒ€ê¸° ì¤‘ì„
- Pod `vault-0`ëŠ” Running ì´ì§€ë§Œ READYê°€ 0/1ì´ë¼ íŠ¸ë˜í”½ ì²˜ë¦¬ ë¶ˆê°€ ìƒíƒœì„
- PVC(data/audit)ëŠ” ì •ìƒ Bound ìƒíƒœì„
- ServiceëŠ” NodePort 30000ìœ¼ë¡œ ë…¸ì¶œë¨

**(6) Vault Running(Ready) ìƒíƒœê°€ ì•ˆ ì˜¬ë¼ì˜¤ëŠ” í˜„ìƒ í™•ì¸**

**(6-1) Vault Sealed ìƒíƒœ í™•ì¸**

```bash
kubectl exec -ti vault-0 -n vault -- vault status

Key                Value
---                -----
Seal Type          shamir
Initialized        false
Sealed             true
Total Shares       0
Threshold          0
Unseal Progress    0/0
Unseal Nonce       n/a
Version            1.20.4
Build Date         2025-09-23T13:22:38Z
Storage Type       file
HA Enabled         false
command terminated with exit code 2
```

- `vault status` ê²°ê³¼ `Initialized=false`, `Sealed=true` í™•ì¸ë¨
- í˜„ì¬ëŠ” ì´ˆê¸°í™”ë˜ì§€ ì•Šì€ ìƒíƒœë¼ unseal í‚¤/thresholdê°€ 0ìœ¼ë¡œ í‘œì‹œë¨

**(6-2) Vault ë¡œê·¸ë¡œ ì›ì¸ í™•ì¸**

```bash
kubectl stern -n vault -l app.kubernetes.io/name=vault

...
vault-0 vault 2025-12-13T07:40:13.087Z [INFO]  core: security barrier not initialized
vault-0 vault 2025-12-13T07:40:13.087Z [INFO]  core: seal configuration missing, not initialized
...
```

- ë¡œê·¸ì— `security barrier not initialized` / `seal configuration missing, not initialized` ì¶œë ¥ë¨
- ì¦‰ Vaultê°€ ì•„ì§ `init` ë˜ì§€ ì•Šì€ ìƒíƒœë¼ barrierê°€ ë§Œë“¤ì–´ì§€ì§€ ì•Šì•˜ê³  sealed ì„¤ì •ë„ ì—†ì–´ì„œ â€œë¯¸ì´ˆê¸°í™” ìƒíƒœâ€ì„

**(7) Vault ì´ˆê¸°í™” ë° Unseal ìˆ˜í–‰**

```bash
kubectl exec vault-0 -n vault -- vault operator init \
    -key-shares=1 \
    -key-threshold=1 \
    -format=json > cluster-keys.json
```

- [https://developer.hashicorp.com/vault/docs/concepts/seal](https://developer.hashicorp.com/vault/docs/concepts/seal)
- VaultëŠ” ì„¤ì¹˜ ì§í›„ `Initialized=false`, `Sealed=true` ìƒíƒœì´ë¯€ë¡œ ë¨¼ì € `init`ìœ¼ë¡œ ì´ˆê¸°í™”ê°€ í•„ìš”í•¨
- ì‹¤ìŠµ ëª©ì ì´ë¼ `key-shares=1`, `key-threshold=1`ë¡œ ë‹¨ì¼ í‚¤ë¡œ ë´‰ì¸í•´ì œ ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±í•¨
- ì´ˆê¸°í™” ê²°ê³¼(unseal key, root token)ëŠ” `cluster-keys.json`ì— ì €ì¥í•´ ê´€ë¦¬í•¨

**(8) cluster-keys.json í‚¤/í† í° í™•ì¸**

```bash
cat cluster-keys.json| jq

{
  "unseal_keys_b64": [
    "oKgQsF1DjLDru9+v8bOPBgd5pcoJi9eHW6HwnWNe6Kc="
  ],
  "unseal_keys_hex": [
    "a0a810b05d438cb0ebbbdfaff1b38f060779a5ca098bd7875ba1f09d635ee8a7"
  ],
  "unseal_shares": 1,
  "unseal_threshold": 1,
  "recovery_keys_b64": [],
  "recovery_keys_hex": [],
  "recovery_keys_shares": 0,
  "recovery_keys_threshold": 0,
  "root_token": "hvs.xxxxxxxxxxxxxxxxxxxxxxxx"
}
```

**(9) Unseal Key ì¶”ì¶œ**

```bash
jq -r ".unseal_keys_b64[]" cluster-keys.json

oKgQsF1DjLDru9+v8bOPBgd5pcoJi9eHW6HwnWNe6Kc=
```

```bash
VAULT_UNSEAL_KEY=$(jq -r ".unseal_keys_b64[]" cluster-keys.json)
```

- jsonì—ì„œ `unseal_keys_b64` ê°’ì„ ì¶”ì¶œí•´ í™•ì¸í•¨
- ì´í›„ CLI ì‘ì—… í¸ì˜ë¥¼ ìœ„í•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥í•¨

**(10) Vault Unseal ì‹¤í–‰**

```bash
kubectl exec vault-0 -n vault -- vault operator unseal $VAULT_UNSEAL_KEY

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.20.4
Build Date      2025-09-23T13:22:38Z
Storage Type    file
Cluster Name    vault-cluster-b801d884
Cluster ID      f96ed384-1f8e-b1e5-27d3-2ed5364ebec3
HA Enabled      false
```

- `vault operator unseal`ë¡œ `vault-0` ë´‰ì¸ í•´ì œ ìˆ˜í–‰í•¨
- ê²°ê³¼ì—ì„œ `Initialized=true`, `Sealed=false`ë¡œ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•¨
- ë´‰ì¸ í•´ì œê°€ ì™„ë£Œë˜ë©´ readiness probeë„ í†µê³¼í•˜ë©´ì„œ Pod READYê°€ 1/1ë¡œ ì˜¬ë¼ê°

**(11) vault-0 Readiness ì •ìƒí™” í™•ì¸**

```bash
kubectl get pod -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          10m
```

- Unseal ì™„ë£Œ í›„ `vault-0`ê°€ `READY 1/1`ë¡œ ì „í™˜ë˜ì–´ ì •ìƒ ì„œë¹„ìŠ¤ ê°€ëŠ¥ ìƒíƒœ í™•ì¸í•¨

---

### **3. Vault login with CLI**

**(1) Root Token í™•ì¸**

```bash
jq -r ".root_token" cluster-keys.json

hvs.xxxxxxxxxxxxxxxxxxxxxxxx
```

**(2) Vault NodePort ì„œë¹„ìŠ¤ í™•ì¸**

```bash
kubectl get svc -n vault

NAME             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
vault            NodePort    10.96.2.205     <none>        8200:30000/TCP,8201:31431/TCP   13m
vault-internal   ClusterIP   None            <none>        8200/TCP,8201/TCP               13m
vault-ui         ClusterIP   10.96.112.199   <none>        8200/TCP                        13m
```

- Helm valuesì—ì„œ Vault ì„œë¹„ìŠ¤ NodePortë¥¼ `30000`ìœ¼ë¡œ ì§€ì •í–ˆê¸° ë•Œë¬¸ì— í•´ë‹¹ í¬íŠ¸ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•¨
- `kubectl get svc`ë¡œ NodePort ë§¤í•‘ í™•ì¸í•¨

**(3) VAULT_ADDR í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

```bash
export VAULT_ADDR='http://localhost:30000'
```

- NodePortë¡œ ê³µê°œí•œ ì£¼ì†Œë¥¼ Vault CLIê°€ ë°”ë¼ë³´ë„ë¡ `VAULT_ADDR`ë¥¼ ì„¤ì •í•¨
- kind í™˜ê²½ì—ì„œ host â†’ node ì»¨í…Œì´ë„ˆ í¬íŠ¸ ë§¤í•‘ì„ ì´ë¯¸ ê±¸ì–´ë‘” ìƒíƒœë¼ `localhost:30000` ì‚¬ìš©í•¨

**(4) Vault ìƒíƒœ í™•ì¸**

```bash
vault status

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.20.4
Build Date      2025-09-23T13:22:38Z
Storage Type    file
Cluster Name    vault-cluster-b801d884
Cluster ID      f96ed384-1f8e-b1e5-27d3-2ed5364ebec3
HA Enabled      false
```

- `vault status`ë¡œ Initialized/Sealed ìƒíƒœ ì¬í™•ì¸í•¨
- `Sealed=false`ì´ë©´ ì •ìƒì ìœ¼ë¡œ ìš”ì²­ ì²˜ë¦¬ ê°€ëŠ¥í•œ ìƒíƒœì„

**(5) Root Tokenìœ¼ë¡œ Vault ë¡œê·¸ì¸**

```bash
vault login

Token (will be hidden): hvs.xxxxxxxxxxxxxxxxxxxxxxxx
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor       CIZO8jV0MUxQ6AS4o7oaFxaz
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

---

### **4. Vault UI ì ‘ì† í™•ì¸**

**(1) Vault Service(NodePort) í™•ì¸**

```bash
kubectl get svc,ep -n vault vault

NAME            TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                         AGE
service/vault   NodePort   10.96.2.205   <none>        8200:30000/TCP,8201:31431/TCP   16m

NAME              ENDPOINTS                         AGE
endpoints/vault   10.244.0.7:8201,10.244.0.7:8200   16m
```

- NodePort(30000)ë¡œ UIì— ì ‘ê·¼ ê°€ëŠ¥í•¨

**(2) Vault UI ì ‘ì†**

```bash
# ë¡œê·¸ì¸ ë°©ì‹ì€ Token ì„ íƒ í›„ root token ì…ë ¥í•˜ì—¬ Sign in ìˆ˜í–‰í•¨
http://127.0.0.1:30000
hvs.xxxxxxxxxxxxxxxxxxxxxxxx
```
![](https://velog.velcdn.com/images/tlsalswls123/post/d311b92b-45ba-4ca6-b8c3-af7dc3b4777a/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/b50c216d-9d34-4fc8-b9dc-3233972a0791/image.png)

---

### **5. Vault Audit Log**

**(1) Vault Audit Log ì„¤ì •**

- [https://developer.hashicorp.com/vault/docs/audit/file](https://developer.hashicorp.com/vault/docs/audit/file)
- Vault Audit logëŠ” ìš”ì²­/ì‘ë‹µ ì´ë ¥ì„ ë‚¨ê¸°ëŠ” í•µì‹¬ ë³´ì•ˆ ê¸°ëŠ¥ì´ë©° ì¼ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ì²˜ëŸ¼ â€œìˆìœ¼ë©´ ì¢‹ì€â€ ìˆ˜ì¤€ì´ ì•„ë‹ˆë¼ ìš´ì˜ í•„ìˆ˜ êµ¬ì„±ì— ê°€ê¹Œì›€
- Vault ê³µì‹ Best Practiceë¡œ **Audit device ìµœì†Œ 2ê°œ ì´ìƒ í™œì„±í™”**ë¥¼ ê¶Œì¥í•¨
    - [https://developer.hashicorp.com/vault/docs/audit/best-practices#enable-at-least-two-audit-devices](https://developer.hashicorp.com/vault/docs/audit/best-practices#enable-at-least-two-audit-devices)
    - ex. `file + syslog`, `file + socket` ë“±
- íŠ¹íˆ **Audit ë¡œê·¸ ì €ì¥ì†Œ(PVC)ê°€ ê½‰ ì°¨ë©´** Auditë§Œ ë©ˆì¶”ëŠ” ê²Œ ì•„ë‹ˆë¼ **Vault ìì²´ ë™ì‘(ìš”ì²­ ì²˜ë¦¬)ê¹Œì§€ ë§‰í ìˆ˜ ìˆìŒ**
    - ì¼ë°˜ì ì¸ ë¡œê·¸ì²˜ëŸ¼ â€œë¡œê·¸ ì ì¬ ì‹¤íŒ¨í•´ë„ ì„œë¹„ìŠ¤ëŠ” ê³„ì†â€ì´ ì•„ë‹Œ ì ì´ í•µì‹¬ì„

**(2) Audit PVC í™•ì¸**

```bash
kubectl get pvc -n vault

NAME            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
audit-vault-0   Bound    pvc-32f2a699-e587-46dc-a883-34148df076d3   10Gi       RWO            standard       <unset>                 19m
data-vault-0    Bound    pvc-e01ff826-3c05-41a6-9198-e658ea251659   10Gi       RWO            standard       <unset>                 19m
```

- Helm valuesì—ì„œ auditStorageë¥¼ `/vault/logs`ë¡œ ë§ˆìš´íŠ¸í–ˆìœ¼ë¯€ë¡œ
- `audit-vault-0` PVCê°€ `Bound` ìƒíƒœì¸ì§€ í™•ì¸í•˜ì—¬ audit ë¡œê·¸ ì €ì¥ ì¤€ë¹„ ìƒíƒœ ì ê²€í•¨

**(3) File Audit Device í™œì„±í™”**

```bash
vault audit enable file file_path=/vault/logs/audit.log

Success! Enabled the file audit device at: file/
```

- audit ë¡œê·¸ê°€ PVC(`/vault/logs`)ì— ì €ì¥ë˜ë„ë¡ file audit deviceë¥¼ í™œì„±í™”í•¨
- ë¡œê·¸ íŒŒì¼ ê²½ë¡œë¥¼ `/vault/logs/audit.log`ë¡œ ì§€ì •í•¨

**(4) Audit Device ì„¤ì • í™•ì¸**

```bash
vault audit list -detailed

Path     Type    Description    Replication    Options
----     ----    -----------    -----------    -------
file/    file    n/a            replicated     file_path=/vault/logs/audit.log
```

- `vault audit list -detailed`ë¡œ audit deviceê°€ `file/` ê²½ë¡œë¡œ ë“±ë¡ëê³ 
- ì˜µì…˜ì— `file_path=/vault/logs/audit.log`ê°€ ë°˜ì˜ëëŠ”ì§€ í™•ì¸í•¨

**(5) Audit Log ê¸°ë¡ í™•ì¸**

```bash
kubectl exec -it vault-0 -n vault -- tail -f /vault/logs/audit.log

{"request":{"id":"db434e4e-f27a-d785-806e-daa442e9f387","namespace":{"id":"root"},"operation":"update","path":"sys/audit/test"},"time":"2025-12-13T07:54:25.301826447Z","type":"request"}
{"auth":{"accessor":"hmac-sha256:b7c608b656889f5e07ece5058b7e83fe84f4a84a3964083c8b9eff285eaad4bb","client_token":"hmac-sha256:9965556e3ad1c2d7f1ce766e7dd46fe683589aeb200a0e7201ff2182a46c5921","display_name":"root","policies":["root"],"policy_results":{"allowed":true,"granting_policies":[{"type":""},{"name":"root","namespace_id":"root","type":"acl"}]},"token_policies":["root"],"token_issue_time":"2025-12-13T07:42:20Z","token_type":"service"},"request":{"client_id":"0DHqvq2D77kL2/JTPSZkTMJbkFVmUu0TzMi0jiXcFy8=","client_token":"hmac-sha256:9965556e3ad1c2d7f1ce766e7dd46fe683589aeb200a0e7201ff2182a46c5921","client_token_accessor":"hmac-sha256:b7c608b656889f5e07ece5058b7e83fe84f4a84a3964083c8b9eff285eaad4bb","data":{"description":"hmac-sha256:488b5f5045b033b4d6f441aa5aa3e25858a5e25cd8c2ed3b6d41a6cc9b9244e9","local":false,"options":{"file_path":"hmac-sha256:348c40c34f2fe938fadd92ee5dc73ac8ba6d129a224ffdb1ca777790c8a51a96"},"type":"hmac-sha256:4fb2a95daa8291f9d3d383332529a76d2c99a1a2437919413de53d721fa83736"},"headers":{"user-agent":["Go-http-client/1.1"]},"id":"26b1258d-5014-63b5-4925-5180f887ad7e","mount_accessor":"system_e1ed47ae","mount_class":"secret","mount_point":"sys/","mount_running_version":"v1.20.4+builtin.vault","mount_type":"system","namespace":{"id":"root"},"operation":"update","path":"sys/audit/file","remote_address":"10.244.0.1","remote_port":62597},"time":"2025-12-13T07:54:25.302849709Z","type":"response"}
...
```

- Vault Pod ë‚´ë¶€ì—ì„œ audit ë¡œê·¸ íŒŒì¼ì„ tail í•˜ì—¬ ì‹¤ì œ ìš”ì²­/ì‘ë‹µì´ JSON í˜•íƒœë¡œ ì ì¬ë˜ëŠ”ì§€ í™•ì¸í•¨
- audit enable ê´€ë ¨ request/response ë¡œê·¸ê°€ ì°íˆëŠ” ê²ƒì„ í†µí•´ ì •ìƒ ë™ì‘ í™•ì¸í•¨

---

## ğŸ” Vault ì‚¬ìš© on K8S

### **1. Set a secret in Vault**

- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#set-a-secret-in-vault](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#set-a-secret-in-vault)

**(1) KV(v2) Secrets Engine í™œì„±í™”**

```bash
vault secrets enable -path=secret kv-v2

Success! Enabled the kv-v2 secrets engine at: secret/
```

- Kubernetesì—ì„œ Vaultë¥¼ â€œì‹œí¬ë¦¿ ì €ì¥ì†Œâ€ë¡œ ì“°ê¸° ìœ„í•´ ë¨¼ì € KV(v2) ì—”ì§„ì„ í™œì„±í™”í•¨
- ê²½ë¡œë¥¼ `secret/`ë¡œ ì§€ì •í•˜ì—¬ ì´í›„ `secret/*` í•˜ìœ„ì— ì‹œí¬ë¦¿ì„ ì €ì¥í•  ìˆ˜ ìˆê²Œ êµ¬ì„±í•¨

**(2) Secrets Engine ë“±ë¡ í™•ì¸**

```bash
vault secrets list -detailed

Path          Plugin       Accessor              Default TTL    Max TTL    Force No Cache    Replication    Seal Wrap    External Entropy Access    Options           Description                                                UUID                                    Version    Running Version          Running SHA256    Deprecation Status
----          ------       --------              -----------    -------    --------------    -----------    ---------    -----------------------    -------           -----------                                                ----                                    -------    ---------------          --------------    ------------------
cubbyhole/    cubbyhole    cubbyhole_eee41fb3    n/a            n/a        false             local          false        false                      map[]             per-token private secret storage                           6ccef8fb-cfa9-6f45-f962-9edda42bdf3c    n/a        v1.20.4+builtin.vault    n/a               n/a
identity/     identity     identity_835b0a05     system         system     false             replicated     false        false                      map[]             identity store                                             606e4462-8f91-d87b-1b72-85899f087ad0    n/a        v1.20.4+builtin.vault    n/a               n/a
secret/       kv           kv_00b73c10           system         system     false             replicated     false        false                      map[version:2]    n/a                                                        3c66051d-2139-fde4-f47b-5e2b0dfc9c24    n/a        v0.24.0+builtin          n/a               supported
sys/          system       system_e1ed47ae       n/a            n/a        false             replicated     true         false                      map[]             system endpoints used for control, policy and debugging    045f51bd-bbd4-7b8c-38a4-da38b6957630    n/a        v1.20.4+builtin.vault    n/a               n/a
```

```bash
vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_eee41fb3    per-token private secret storage
identity/     identity     identity_835b0a05     identity store
secret/       kv           kv_00b73c10           n/a
sys/          system       system_e1ed47ae       system endpoints used for control, policy and debugging
```

- `vault secrets list -detailed`ë¡œ `secret/`ì´ kv ì—”ì§„ì´ë©° `version:2` ì˜µì…˜ì´ ì ìš©ëœ ê²ƒì„ í™•ì¸í•¨
- ê°„ë‹¨ í™•ì¸ì€ `vault secrets list`ë¡œë„ ê°€ëŠ¥í•¨

**(3) ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œí¬ë¦¿ ì €ì¥**

```bash
vault kv put secret/webapp/config username="static-user" password="static-password"

====== Secret Path ======
secret/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T08:02:50.147040285Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

- `secret/webapp/config` ê²½ë¡œì— `username`, `password` ê°’ì„ ì €ì¥í•¨
- KV v2 íŠ¹ì„±ìƒ ì‹¤ì œ ì €ì¥ ê²½ë¡œëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `secret/data/...` í˜•íƒœë¡œ ê´€ë¦¬ë¨
- ê²°ê³¼ì—ì„œ `version=1`ë¡œ ì²« ë²ˆì§¸ ë²„ì „ ì €ì¥ì´ í™•ì¸ë¨

**(4) CLIë¡œ ì‹œí¬ë¦¿ ì¡°íšŒ í™•ì¸**

```bash
vault kv get secret/webapp/config

====== Secret Path ======
secret/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T08:02:50.147040285Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    static-password
username    static-user
```

**(5) Vault HTTP APIë¡œ ì‹œí¬ë¦¿ ì¡°íšŒ í™•ì¸**

```bash
export VAULT_ROOT_TOKEN=hvs.xxxxxxxxxxxxxxxxxxxxxxxx

curl -s --header "X-Vault-Token: $VAULT_ROOT_TOKEN" --request GET \
  http://127.0.0.1:30000/v1/secret/data/webapp/config | jq
  
{
  "request_id": "516ab3ad-ddbc-15ac-5ce6-fd09fd6f234a",
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "data": {
      "password": "static-password",
      "username": "static-user"
    },
    "metadata": {
      "created_time": "2025-12-13T08:02:50.147040285Z",
      "custom_metadata": null,
      "deletion_time": "",
      "destroyed": false,
      "version": 1
    }
  },
  "wrap_info": null,
  "warnings": null,
  "auth": null,
  "mount_type": "kv"
}
  
```
![](https://velog.velcdn.com/images/tlsalswls123/post/dc286f91-9bee-4fc0-aff2-aa64df60d6ae/image.png)

---

### **2. Configure K8S Authentication in Vault**

- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#configure-kubernetes-authentication](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#configure-kubernetes-authentication)

**(1) Vault ServiceAccount RBAC ê¶Œí•œ í™•ì¸**

```bash
kubectl rbac-tool lookup vault

  SUBJECT | SUBJECT TYPE   | SCOPE       | NAMESPACE | ROLE                  | BINDING               
----------+----------------+-------------+-----------+-----------------------+-----------------------
  vault   | ServiceAccount | ClusterRole |           | system:auth-delegator | vault-server-binding  
```

```bash
kubectl rolesum vault -n vault

# ê²°ê³¼
ServiceAccount: vault/vault
Secrets:

Policies:

â€¢ [CRB] */vault-server-binding âŸ¶  [CR] */system:auth-delegator
  Resource                                   Name  Exclude  Verbs  G L W C U P D DC  
  subjectaccessreviews.authorization.k8s.io  [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ– âœ– âœ–   
  tokenreviews.authentication.k8s.io         [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ– âœ– âœ–   
```

- Vaultê°€ Kubernetes Authë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ `TokenReview`, `SubjectAccessReview` ê¶Œí•œì´ í•„ìš”í•¨
- `vault` ServiceAccountê°€ `system:auth-delegator` ClusterRoleì— ë°”ì¸ë”©ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•¨

**(2) Vault Kubernetes Auth í™œì„±í™”**

```bash
vault auth enable kubernetes

Success! Enabled kubernetes auth method at: kubernetes/
```
![](https://velog.velcdn.com/images/tlsalswls123/post/abf306aa-452a-469e-aed9-9fb8699e39a7/image.png)

```bash
vault auth list -detailed

Path           Plugin        Accessor                    Default TTL    Max TTL    Token Type         Replication    Seal Wrap    External Entropy Access    Options    Description                UUID                                    Version    Running Version          Running SHA256    Deprecation Status
----           ------        --------                    -----------    -------    ----------         -----------    ---------    -----------------------    -------    -----------                ----                                    -------    ---------------          --------------    ------------------
kubernetes/    kubernetes    auth_kubernetes_12d43069    system         system     default-service    replicated     false        false                      map[]      n/a                        caeaab04-f63d-82c7-f6f7-e17ad941e0a0    n/a        v0.22.2+builtin          n/a               supported
token/         token         auth_token_d2de5f64         system         system     default-service    replicated     false        false                      map[]      token based credentials    d9f460a1-42a8-00a5-15f7-b0276a4fa229    n/a        v1.20.4+builtin.vault    n/a               n/a
```

- Vaultì— Kubernetes ì¸ì¦ ë°©ì‹(`kubernetes/`)ì„ í™œì„±í™”í•¨
- í™œì„±í™” í›„ UI/CLIì—ì„œ `kubernetes/` auth pathê°€ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸ ê°€ëŠ¥í•¨

**(3) Kubernetes API ì„œë²„ ì •ë³´ ì„¤ì •**

```bash
vault write auth/kubernetes/config \
    kubernetes_host="https://kubernetes.default.svc"

Success! Data written to: auth/kubernetes/config
```

- Vaultê°€ Kubernetes API ì„œë²„ì— í† í° ê²€ì¦(TokenReview) ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆë„ë¡ `kubernetes_host`ë¥¼ ì„¤ì •í•¨
- Vaultê°€ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ì— ì„¤ì¹˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ `https://kubernetes.default.svc` ì„œë¹„ìŠ¤ DNSë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•¨

**(4) Kubernetes Auth ì„¤ì •ê°’ í™•ì¸**

```bash
vault read auth/kubernetes/config

Key                                  Value
---                                  -----
disable_iss_validation               true
disable_local_ca_jwt                 false
issuer                               n/a
kubernetes_ca_cert                   n/a
kubernetes_host                      https://kubernetes.default.svc
pem_keys                             []
token_reviewer_jwt_set               false
use_annotations_as_alias_metadata    false
```

- `vault read`ë¡œ Kubernetes Auth ì„¤ì •ì´ ì •ìƒ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸í•¨
- í•µì‹¬ í™•ì¸ í¬ì¸íŠ¸ëŠ” `kubernetes_host` ê°’ì„

**(5) Vault Policy ìƒì„±(webapp)**

```bash
vault policy write webapp - <<EOF
path "secret/data/webapp/config" {
  capabilities = ["read"]
}
EOF

Success! Uploaded policy: webapp
```
![](https://velog.velcdn.com/images/tlsalswls123/post/ccb202c5-292a-449a-a8df-569abde3daeb/image.png)

- `secret/data/webapp/config` ê²½ë¡œì— ëŒ€í•´ `read` ê¶Œí•œë§Œ í—ˆìš©í•˜ëŠ” `webapp` ì •ì±…ì„ ìƒì„±í•¨
- KV v2ëŠ” ê²½ë¡œê°€ `secret/data/...` í˜•íƒœì¸ ì ì´ ì¤‘ìš”í•¨

**(6) Kubernetes Auth Role ìƒì„±(webapp)**

```bash
vault write auth/kubernetes/role/webapp \
        bound_service_account_names=vault \
        bound_service_account_namespaces=default \
        policies=webapp \
        ttl=24h \
        audience="https://kubernetes.default.svc.cluster.local"

Success! Data written to: auth/kubernetes/role/webapp
```
![](https://velog.velcdn.com/images/tlsalswls123/post/35badcf6-c125-4ca8-b992-3be1c47b7e33/image.png)

- Kubernetesì˜ íŠ¹ì • ServiceAccountê°€ ë¡œê·¸ì¸í–ˆì„ ë•Œ ì–´ë–¤ Vault ì •ì±…ì„ ë°›ì„ì§€ â€œRoleâ€ë¡œ ë§¤í•‘í•¨
- ì•„ë˜ ì„¤ì •ì€ `default` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ `vault` ServiceAccountê°€ ë¡œê·¸ì¸í•˜ë©´ `webapp` policyë¥¼ ë°›ë„ë¡ êµ¬ì„±í•œ ê²ƒì„
- í† í° TTLì„ 24ì‹œê°„ìœ¼ë¡œ ë¶€ì—¬í•˜ê³ , audienceë¥¼ Kubernetes ê¸°ë³¸ audienceë¡œ ì§€ì •í•¨

---

### **3. Launch a web application**

- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#launch-a-web-application](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/kubernetes-minikube-raft#launch-a-web-application)
- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/agent-kubernetes](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/agent-kubernetes)
- [https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-secrets-engine](https://developer.hashicorp.com/vault/tutorials/kubernetes/kubernetes-secrets-engine)

**(1) WebApp ì‹¤ìŠµìš© ServiceAccount ìƒì„±**

```bash
kubectl create sa vault

serviceaccount/vault created
```

**(2) Web Application ë°°í¬ + NodePort ì„œë¹„ìŠ¤ ë…¸ì¶œ**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: webapp
  labels:
    app: webapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: webapp
  template:
    metadata:
      labels:
        app: webapp
    spec:
      serviceAccountName: vault
      containers:
        - name: app
          image: hashieducation/simple-vault-client:latest
          imagePullPolicy: Always
          env:
            - name: VAULT_ADDR
              value: 'http://vault.vault.svc:8200'
            - name: JWT_PATH
              value: '/var/run/secrets/kubernetes.io/serviceaccount/token'
            - name: SERVICE_PORT
              value: '8080'
          volumeMounts:
          - name: sa-token
            mountPath: /var/run/secrets/kubernetes.io/serviceaccount
            readOnly: true
      volumes:
      - name: sa-token
        projected:
          sources:
          - serviceAccountToken:
              path: token
              expirationSeconds: 600 # 10ë¶„ ë§Œë£Œ , It defaults to 1 hour and must be at least 10 minutes (600 seconds)
---
apiVersion: v1
kind: Service
metadata:
  name: webapp
spec:
  selector:
    app: webapp
  type: NodePort
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
    nodePort: 30001
EOF

# ê²°ê³¼
deployment.apps/webapp created
service/webapp created
```

- `hashieducation/simple-vault-client` ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ëŠ” `webapp` ë””í”Œë¡œì´ë¨¼íŠ¸ë¥¼ ë°°í¬í•¨
- `serviceAccountName: vault`ë¡œ ì§€ì •í•˜ì—¬ íŒŒë“œê°€ SA í† í°(JWT)ì„ ì‚¬ìš©í•˜ë„ë¡ êµ¬ì„±í•¨
- Vault ì£¼ì†ŒëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ DNS(`vault.vault.svc:8200`)ë¡œ ì„¤ì •í•¨
- SA í† í°ì„ **Projected Volume**ìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ê³ , `expirationSeconds: 600`ìœ¼ë¡œ 10ë¶„ ë‹¨ìœ„ í† í° ê°±ì‹ ë˜ë„ë¡ ì„¤ì •í•¨
- ì„œë¹„ìŠ¤ëŠ” NodePort `30001`ë¡œ ë…¸ì¶œí•˜ì—¬ ë¡œì»¬ì—ì„œ `127.0.0.1:30001`ë¡œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±í•¨

**(3) WebApp íŒŒë“œ ê¸°ë™ í™•ì¸**

```bash
kubectl get pod -l app=webapp

NAME                     READY   STATUS    RESTARTS   AGE
webapp-9484c6fd7-vmkrd   1/1     Running   0          29s
```

**(4) ì»¨í…Œì´ë„ˆ ì½”ë“œ êµ¬ì¡° í™•ì¸**

```bash
kubectl exec -it deploy/webapp -- cat /app/main.go

# ê²°ê³¼
package main

import (
	"fmt"
	"log"
	"os"
	"time"
	"bytes"
	"net/http"
	"io/ioutil"
	"encoding/json"
)
..
```

```bash
kubectl exec -it deploy/webapp -- cat /app/types.go

# ê²°ê³¼
package main

type VaultJWTPayload struct {
	Role string `json:"role"`
	JWT  string `json:"jwt"`
}
...
```

- ì»¨í…Œì´ë„ˆ ë‚´ë¶€ `/app/main.go`, `/app/types.go` í™•ì¸
- í† í° ë°œê¸‰ í›„ ì‹œí¬ë¦¿ì„ ì¡°íšŒí•´ HTTP ì‘ë‹µìœ¼ë¡œ ì¶œë ¥í•˜ëŠ” ë¡œì§ì„ì„ í™•ì¸í•¨

**(5) ServiceAccount í† í°(JWT) í™•ì¸**

```bash
kubectl exec -it deploy/webapp -- cat /var/run/secrets/kubernetes.io/serviceaccount/token

eyJhbGciOiJSUzI1NiIsImtpZCI6IkZ6YmpXNEkzd1NZUGNtQzlWbXhaNHgtTGtvMk8xNGctVTVsZ1NqaXhLVzgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY1NjIwMjg4LCJpYXQiOjE3NjU2MTk2ODgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiYWY5YWZlNTgtMTQ4MS00MDNlLTgzZGEtNTY4NmVkOWIzOGNiIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoibXlrOHMtY29udHJvbC1wbGFuZSIsInVpZCI6IjdlNTM0NWY2LWVjYzEtNGY1Zi05NTI3LTc4NDhjYzM2YmQ5NSJ9LCJwb2QiOnsibmFtZSI6IndlYmFwcC05NDg0YzZmZDctdm1rcmQiLCJ1aWQiOiI0ODlhZTIyYi0yZjc2LTQxZDItYThiZS1lODg3NzcxN2NmOTUifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6InZhdWx0IiwidWlkIjoiYjdlN2M5ZDEtNjYxYy00MjEyLWE1OGUtOTJjZDU3Y2EwYTBlIn19LCJuYmYiOjE3NjU2MTk2ODgsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnZhdWx0In0.duPn8p9DZMr9TfsW5nO_HVIP8lH2KAhNd_vBn90ML2wKH0v2lEnkqEct-zJiTEc2vhDB6SCCyTKLJG2bWPGzIZ34ZRzjDRkAkcLXKoefdXVYaMaf_NloP74vcDqHnQnjG43bOiyUQAAkIIXn5J1v6gTnCMmCV5IpX7irLheyj99PjmpfqBXMg1QgsRQgfr1USvVmCbQAO2L0jOPhUbZ7syxO_IdBKqWEVRJvvC3Wuuz5HV0cmNs0-KKhGPnVXlbNrdR-yINw8Vi1VEN6sfVb6rgHY_1PW1f2aaXZYeRcxrJvZggOGhAQktaBBKJGD1gNHRHdKTQLCoHio5WbLvLQJw
```

```bash
kubectl exec -it deploy/webapp -- cat /var/run/secrets/kubernetes.io/serviceaccount/token | cut -d '.' -f2 | base64 -d ; echo "\"}"

{"aud":["https://kubernetes.default.svc.cluster.local"],"exp":1765620288,"iat":1765619688,"iss":"https://kubernetes.default.svc.cluster.local","jti":"af9afe58-1481-403e-83da-5686ed9b38cb","kubernetes.io":{"namespace":"default","node":{"name":"myk8s-control-plane","uid":"7e5345f6-ecc1-4f5f-9527-7848cc36bd95"},"pod":{"name":"webapp-9484c6fd7-vmkrd","uid":"489ae22b-2f76-41d2-a8be-e8877717cf95"},"serviceaccount":{"name":"vault","uid":"b7e7c9d1-661c-4212-a58e-92cd57ca0a0e"}},"nbf":1765619688,"sub":"system:serviceaccount:default:vault"}"}
```

- `JWT_PATH`ë¡œ ì§€ì •í•œ ê²½ë¡œì— SA í† í°ì´ ë§ˆìš´íŠ¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•¨
- Projected ServiceAccountToken ì„¤ì •(`expirationSeconds: 600`)ìœ¼ë¡œ í† í°ì´ ì£¼ê¸°ì ìœ¼ë¡œ ê°±ì‹ ë˜ëŠ” í˜•íƒœì„
- í† í° payloadë¥¼ base64 decode í•˜ì—¬ `aud`, `iss`, `sub(system:serviceaccount:default:vault)` ë“± í´ë ˆì„ì„ í™•ì¸í•¨

**(6) WebApp ì„œë¹„ìŠ¤(NodePort) í™•ì¸**

```bash
kubectl get svc

NAME         TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1     <none>        443/TCP        150m
webapp       NodePort    10.96.62.78   <none>        80:30001/TCP   3m29s
```

- `webapp` ì„œë¹„ìŠ¤ê°€ NodePort `30001`ë¡œ ë…¸ì¶œë˜ì—ˆëŠ”ì§€ í™•ì¸í•¨
- kindì—ì„œ `extraPortMappings`ë¡œ 30001ì„ hostì— ë°”ì¸ë”© í•´ë‘” ìƒíƒœë¼ ë¡œì»¬ì—ì„œ ë°”ë¡œ í˜¸ì¶œ ê°€ëŠ¥í•¨

**(7) WebApp ë™ì‘ í™•ì¸**

```bash
curl 127.0.0.1:30001

password:static-password username:static-user
```

- ì›¹ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ webappì´
    - SA JWTë¥¼ ì½ê³ 
    - Vault Kubernetes Authë¡œ ë¡œê·¸ì¸í•˜ì—¬ Vault í† í°ì„ ë°œê¸‰ë°›ê³ 
    - `secret/webapp/config` ì‹œí¬ë¦¿ì„ ì¡°íšŒí•œ ê²°ê³¼ë¥¼ HTTPë¡œ ì¶œë ¥í•¨
- curl ê²°ê³¼ë¡œ username/passwordê°€ ë°˜í™˜ë˜ë©´ end-to-end íë¦„ì´ ì •ìƒì„

**(8) WebApp ë¡œê·¸ë¡œ Vault ë¡œê·¸ì¸/í† í° ë°œê¸‰ í™•ì¸**

```bash
kubectl logs -l app=webapp -f

# ê²°ê³¼
2025/12/13 09:55:15 Listening on port 8080
2025/12/13 09:58:34 Received Request - Port forwarding is working.
Read JWT: eyJhbGciOiJSUzI1NiIsImtpZCI6IkZ6YmpXNEkzd1NZUGNtQzlWbXhaNHgtTGtvMk8xNGctVTVsZ1NqaXhLVzgifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY1NjIwMjg4LCJpYXQiOjE3NjU2MTk2ODgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiYWY5YWZlNTgtMTQ4MS00MDNlLTgzZGEtNTY4NmVkOWIzOGNiIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoibXlrOHMtY29udHJvbC1wbGFuZSIsInVpZCI6IjdlNTM0NWY2LWVjYzEtNGY1Zi05NTI3LTc4NDhjYzM2YmQ5NSJ9LCJwb2QiOnsibmFtZSI6IndlYmFwcC05NDg0YzZmZDctdm1rcmQiLCJ1aWQiOiI0ODlhZTIyYi0yZjc2LTQxZDItYThiZS1lODg3NzcxN2NmOTUifSwic2VydmljZWFjY291bnQiOnsibmFtZSI6InZhdWx0IiwidWlkIjoiYjdlN2M5ZDEtNjYxYy00MjEyLWE1OGUtOTJjZDU3Y2EwYTBlIn19LCJuYmYiOjE3NjU2MTk2ODgsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OnZhdWx0In0.duPn8p9DZMr9TfsW5nO_HVIP8lH2KAhNd_vBn90ML2wKH0v2lEnkqEct-zJiTEc2vhDB6SCCyTKLJG2bWPGzIZ34ZRzjDRkAkcLXKoefdXVYaMaf_NloP74vcDqHnQnjG43bOiyUQAAkIIXn5J1v6gTnCMmCV5IpX7irLheyj99PjmpfqBXMg1QgsRQgfr1USvVmCbQAO2L0jOPhUbZ7syxO_IdBKqWEVRJvvC3Wuuz5HV0cmNs0-KKhGPnVXlbNrdR-yINw8Vi1VEN6sfVb6rgHY_1PW1f2aaXZYeRcxrJvZggOGhAQktaBBKJGD1gNHRHdKTQLCoHio5WbLvLQJw
Retrieved token:  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
```

- ë¡œê·¸ì—ì„œ `Read JWT`ë¡œ SA í† í°ì„ ì½ëŠ” ê³¼ì • í™•ì¸ ê°€ëŠ¥í•¨
- ì´ì–´ì„œ `Retrieved token`ìœ¼ë¡œ Vaultì—ì„œ ë°œê¸‰ëœ í† í°(hvs.*)ì„ ë°›ì•„ì˜¤ëŠ” ê³¼ì • í™•ì¸ ê°€ëŠ¥í•¨
- ì¦‰ â€œKubernetes SA â†’ Vault Kubernetes Auth â†’ Vault Token â†’ Secret Readâ€ íë¦„ì´ ì‹¤ì œë¡œ ìˆ˜í–‰ë¨

**(9) ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸ í† í°(JWT) í™•ì¸ -** [https://www.jwt.io/](https://www.jwt.io/)

![](https://velog.velcdn.com/images/tlsalswls123/post/880947e1-f10a-4876-b169-46388cabba33/image.png)

---

### **4. Vault Secret ì—…ë°ì´íŠ¸ ë° ë°˜ì˜ í™•ì¸**

**(1) Vault Secret ì—…ë°ì´íŠ¸**

```bash
vault kv put secret/webapp/config username="changed-user" password="changed-password"

====== Secret Path ======
secret/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T10:00:11.037967412Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2
```

**(2) ì—…ë°ì´íŠ¸ëœ Secret ì¡°íšŒ ê²€ì¦**

```bash
vault kv get secret/webapp/config

====== Secret Path ======
secret/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T10:00:11.037967412Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2

====== Data ======
Key         Value
---         -----
password    changed-password
username    changed-user
```

- ì¶œë ¥ ê²°ê³¼ì—ì„œ username/passwordê°€ ë³€ê²½ëœ ê°’ìœ¼ë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸í•¨

**(3) WebAppì—ì„œ ë³€ê²½ ë°˜ì˜ í™•ì¸**

```bash
curl 127.0.0.1:30001

password:changed-password username:changed-user
```

- webapp(NodePort:30001)ì´ Vaultì—ì„œ ì‹œí¬ë¦¿ì„ ë‹¤ì‹œ ì¡°íšŒí•´ HTTP ì‘ë‹µìœ¼ë¡œ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸í•¨
- curl ê²°ê³¼ê°€ ë³€ê²½ëœ ê°’ìœ¼ë¡œ ë‚˜ì˜¤ë©´ end-to-endë¡œ â€œVault ë³€ê²½ â†’ ì•± ë°˜ì˜â€ì´ ì •ìƒ ë™ì‘í•˜ëŠ” ê²ƒì„

**(4) ì‹¤ìŠµ í™˜ê²½ ì •ë¦¬**

```bash
kind delete cluster --name myk8s

Deleting cluster "myk8s" ...
Deleted nodes: ["myk8s-control-plane"]
```

---

## **âš™ï¸ Vault Secrets Operaor(VSO)**

- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/vault-secrets-operator](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/vault-secrets-operator)
- VSO(Vault Secrets Operator)ëŠ” **Vaultì— ìˆëŠ” Secret/Dynamic Credentialì„ ê°€ì ¸ì™€ Kubernetes Native Secretìœ¼ë¡œ ìë™ ë°˜ì˜/ë™ê¸°í™”**í•˜ëŠ” Operatorì„
- ì• í”Œë¦¬ì¼€ì´ì…˜(ê°œë°œì)ì€ **Vault CLI/APIë¥¼ ì§ì ‘ ë‹¤ë£° í•„ìš” ì—†ì´** Kubernetes Secretë§Œ ì†Œë¹„í•˜ë©´ ë˜ëŠ” êµ¬ì¡°ê°€ ë¨

### **1. K8S(kind) ì„¤ì¹˜**

**(1) kind í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    ingress-ready: true
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
  - containerPort: 30000  # Vault Web UI
    hostPort: 30000
  - containerPort: 30001  # Sample application
    hostPort: 30001
EOF
```

**(2) kind ë…¸ë“œ ê¸°ë³¸ ìœ í‹¸ ì„¤ì¹˜**

```bash
docker exec -it myk8s-control-plane sh -c 'apt update && apt install tree psmisc lsof wget net-tools dnsutils tcpdump ngrep iputils-ping git vim -y'
```

---

### **2. Vault ì„¤ì¹˜: dev ëª¨ë“œ í™œì„±í™”**

- [https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/vault-secrets-operator](https://developer.hashicorp.com/vault/tutorials/kubernetes-introduction/vault-secrets-operator)
- [https://github.com/hashicorp-education/learn-vault-secrets-operator](https://github.com/hashicorp-education/learn-vault-secrets-operator)
- [https://artifacthub.io/packages/helm/hashicorp/vault/0.30.0](https://artifacthub.io/packages/helm/hashicorp/vault/0.30.0)

**(1) Vault/VSO ë²„ì „ ì „ëµ í™•ì¸**

```bash
helm search repo hashicorp/vault

NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                          
hashicorp/vault                 	0.31.0       	1.20.4     	Official HashiCorp Vault Chart       
hashicorp/vault-secrets-gateway 	0.0.2        	0.1.0      	A Helm chart for Kubernetes          
hashicorp/vault-secrets-operator	1.1.0        	1.1.0      	Official Vault Secrets Operator Chart
```

- ì‹¤ìŠµì€ **ë‚®ì€ ë²„ì „ ì¡°í•©**ìœ¼ë¡œ ì§„í–‰í•˜ê¸°ë¡œ ê²°ì •í•¨

```bash
NAME                                    CHART VERSION   APP VERSION     DESCRIPTION
hashicorp/vault                         0.28.1          1.17.2          Official HashiCorp Vault Chart
hashicorp/vault-secrets-operator        0.7.1           0.8.0           Official Vault Secrets Operator Chart
```

**(2) VSO ì‹¤ìŠµ ë ˆí¬ í´ë¡ **

```bash
git clone https://github.com/hashicorp-education/learn-vault-secrets-operator
cd learn-vault-secrets-operator
```

**(3) Vault(dev ëª¨ë“œ) ì„¤ì • íŒŒì¼ ì‘ì„±**

```bash
cat <<EOF > vault-values.yaml
server:
  image:
    repository: "hashicorp/vault"
    tag: "1.19.0"

  dev:
    enabled: true
    devRootToken: "root"

  logLevel: debug

  service:
    enabled: true
    type: ClusterIP
    port: 8200
    targetPort: 8200

ui:
  enabled: true
  serviceType: "NodePort"
  externalPort: 8200
  serviceNodePort: 30000

injector:
  enabled: "false"
EOF
```

- ì‹¤ìŠµ í¸ì˜ë¥¼ ìœ„í•´ `server.dev.enabled=true`ë¡œ dev ëª¨ë“œ ì‚¬ìš©í•¨
- dev ëª¨ë“œëŠ” **init/unseal ì—†ì´ ì¦‰ì‹œ ì‚¬ìš© ê°€ëŠ¥**í•˜ë©°, root tokenì„ `root`ë¡œ ê³ ì •í•¨
- UIëŠ” NodePort `30000`ìœ¼ë¡œ ë…¸ì¶œí•¨

**(4) Vault ì„¤ì¹˜(Helm)**

```bash
helm install vault hashicorp/vault -n vault --create-namespace --values vault-values.yaml --version 0.30.0

# ê²°ê³¼
NAME: vault
LAST DEPLOYED: Sat Dec 13 19:28:19 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

**(5) Vault íŒŒë“œ ê¸°ë™ í™•ì¸**

```bash
kubectl get pods -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          26s
```

---

### **3. Vault ì„¤ì •**

**(1) Vault ì ‘ì† ì£¼ì†Œ ì„¤ì • ë° ë¡œê·¸ì¸**

```bash
export VAULT_ADDR='http://localhost:30000'
```

```bash
vault login

Token (will be hidden): root
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                root
token_accessor       WZPwOa6gGPh0CIpsmtYF2u5c
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

- UI/CLI ì ‘ê·¼ì„ ìœ„í•´ NodePort(30000)ë¥¼ `VAULT_ADDR`ë¡œ ì§€ì •í•¨
- devRootTokenìœ¼ë¡œ ì„¤ì •í•œ `root` í† í°ìœ¼ë¡œ ë¡œê·¸ì¸í•¨

**(2) Kubernetes Auth í™œì„±í™”**

```bash
vault auth enable -path demo-auth-mount kubernetes

Success! Enabled kubernetes auth method at: demo-auth-mount/
```

```bash
vault write auth/demo-auth-mount/config kubernetes_host="https://kubernetes.default.svc"

Success! Data written to: auth/demo-auth-mount/config
```

- Kubernetes Authë¥¼ ê¸°ë³¸ pathê°€ ì•„ë‹Œ `demo-auth-mount/`ë¡œ í™œì„±í™”í•¨
- Vaultê°€ TokenReview ë“±ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ Kubernetes API ì„œë²„ ì£¼ì†Œë¥¼ ì„¤ì •í•¨

**(3) KV v2 Secrets Engine í™œì„±í™”**

```bash
vault secrets enable -path=kvv2 kv-v2

Success! Enabled the kv-v2 secrets engine at: kvv2/
```

- KV v2 ì—”ì§„ì„ `kvv2/` ê²½ë¡œë¡œ í™œì„±í™”í•˜ì—¬ ì‹œí¬ë¦¿ì„ ì €ì¥í•  ì¤€ë¹„ë¥¼ í•¨

**(4) Vault Policy ìƒì„±(webapp)**

```bash
tee webapp.json <<EOF
path "kvv2/data/webapp/config" {
   capabilities = ["read", "list"]
}
EOF
```

```bash
vault policy write webapp webapp.json

Success! Uploaded policy: webapp
```

- `kvv2/data/webapp/config` ê²½ë¡œì— ëŒ€í•´ `read`, `list` ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ì •ì±…ì„ ì‘ì„±í•¨
- íŒŒì¼ ê¸°ë°˜ ì •ì±…(`webapp.json`)ìœ¼ë¡œ ê´€ë¦¬ í›„ Vaultì— ì—…ë¡œë“œí•¨

**(5) Kubernetes SA â†” Vault Role ë§¤í•‘(role1)**

```bash
vault write auth/demo-auth-mount/role/role1 \
   bound_service_account_names=demo-static-app \
   bound_service_account_namespaces=app \
   policies=webapp \
   audience=vault \
   ttl=24h
   
Success! Data written to: auth/demo-auth-mount/role/role1
```

- `app` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ `demo-static-app` ServiceAccountê°€ ë¡œê·¸ì¸í•˜ë©´ `webapp` ì •ì±…ì„ ë°›ë„ë¡ roleì„ ìƒì„±í•¨
- audienceëŠ” `vault`, TTLì€ 24hë¡œ ì„¤ì •í•¨

**(6) Vaultì— ì‹œí¬ë¦¿ ì €ì¥**

```bash
vault kv put kvv2/webapp/config username="static-user" password="static-password"

===== Secret Path =====
kvv2/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T10:33:17.086953754Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

- `kvv2/webapp/config` ê²½ë¡œì— username/passwordë¥¼ ì €ì¥í•¨
- KV v2 íŠ¹ì„±ìƒ ì‹¤ì œ ë°ì´í„° ê²½ë¡œëŠ” `kvv2/data/webapp/config`ë¡œ ê´€ë¦¬ë˜ë©° versionì´ ì¦ê°€í•¨

---

### **4. Vault Secrets Operator(VSO) ì„¤ì¹˜**

- [https://artifacthub.io/packages/helm/hashicorp/vault-secrets-operator/0.7.1](https://artifacthub.io/packages/helm/hashicorp/vault-secrets-operator/0.7.1)

**(1) VSO Values íŒŒì¼ í™•ì¸**

```bash
cat vault/vault-operator-values.yaml

defaultVaultConnection:
  enabled: true
  address: "http://vault.vault.svc.cluster.local:8200"
  skipTLSVerify: false
controller:
  manager:
    clientCache:
      persistenceModel: direct-encrypted
      storageEncryption:
        enabled: true
        mount: demo-auth-mount
        keyName: vso-client-cache
        transitMount: demo-transit
        kubernetes:
          role: auth-role-operator
          serviceAccount: vault-secrets-operator-controller-manager
          tokenAudiences: ["vault"]
```

- VSO ê¸°ë³¸ Vault ì—°ê²° ì •ë³´(`defaultVaultConnection`) í™•ì¸í•¨
- Client cache ì˜ì†í™” ëª¨ë¸ì„ `direct-encrypted`ë¡œ ì‚¬ìš©í•˜ë©°, Vault Transit ê¸°ë°˜ ì•”í˜¸í™” ì„¤ì • í¬í•¨ë¨
- Kubernetes AuthëŠ” `demo-auth-mount` ì‚¬ìš©, Roleì€ `auth-role-operator`, audienceëŠ” `vault` ì‚¬ìš© êµ¬ì„±ì„

**(2) Vault Secrets Operator ì„¤ì¹˜**

```bash
helm install vault-secrets-operator hashicorp/vault-secrets-operator -n vault-secrets-operator-system --create-namespace --values vault/vault-operator-values.yaml --version 0.7.1

NAME: vault-secrets-operator
LAST DEPLOYED: Sat Dec 13 19:38:01 2025
NAMESPACE: vault-secrets-operator-system
STATUS: deployed
REVISION: 1
```

**(3) Helm ë¦´ë¦¬ì¦ˆ ì„¤ì¹˜ í˜„í™© í™•ì¸**

```bash
helm list -A

NAME                  	NAMESPACE                    	REVISION	UPDATED                                	STATUS  	CHART                       	APP VERSION
vault                 	vault                        	1       	2025-12-13 19:28:19.64613302 +0900 KST 	deployed	vault-0.30.0                	1.19.0     
vault-secrets-operator	vault-secrets-operator-system	1       	2025-12-13 19:38:01.785715036 +0900 KST	deployed	vault-secrets-operator-0.7.1	0.7.1      
```

- Vaultì™€ VSOê°€ ê°ê° ë³„ë„ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì •ìƒ ë°°í¬ ìƒíƒœì¸ì§€ í™•ì¸í•¨
- Vault chart `0.30.0`, VSO chart `0.7.1` ì„¤ì¹˜ ìƒíƒœ í™•ì¸í•¨

**(4) VSO CRD ìƒì„± í™•ì¸**

```bash
kubectl get crd | grep secrets.hashicorp.com

hcpauths.secrets.hashicorp.com                2025-12-13T10:38:01Z
hcpvaultsecretsapps.secrets.hashicorp.com     2025-12-13T10:38:01Z
secrettransformations.secrets.hashicorp.com   2025-12-13T10:38:01Z
vaultauths.secrets.hashicorp.com              2025-12-13T10:38:01Z
vaultconnections.secrets.hashicorp.com        2025-12-13T10:38:01Z
vaultdynamicsecrets.secrets.hashicorp.com     2025-12-13T10:38:01Z
vaultpkisecrets.secrets.hashicorp.com         2025-12-13T10:38:01Z
vaultstaticsecrets.secrets.hashicorp.com      2025-12-13T10:38:01Z
```

**(5) VSO Pod ì»¨í…Œì´ë„ˆ êµ¬ì„± í™•ì¸**

```bash
kubectl describe pod -n vault-secrets-operator-system

# ê²°ê³¼
Containers:
  kube-rbac-proxy:
    Container ID:  containerd://695d3200bbdb03da69d7e20d3b6cd271d3c544e2689a0e109baee54bcfd6d353
    Image:         gcr.io/kubebuilder/kube-rbac-proxy:v0.15.0
  ...
  manager:
    Container ID:  containerd://d45ee54bb67616f9f4da810b5df87148ad3f0ed7521c152ebbf152568f346bd6
    Image:         hashicorp/vault-secrets-operator:0.7.1
...    
```

- VSO PodëŠ” ë³´í†µ `manager` + `kube-rbac-proxy` 2ê°œ ì»¨í…Œì´ë„ˆë¡œ êµ¬ì„±ë¨
- manager ì´ë¯¸ì§€ê°€ `hashicorp/vault-secrets-operator:0.7.1`ì¸ì§€ í™•ì¸í•¨

**(6) ê¸°ë³¸ VaultConnection/VaultAuth CR ìƒì„± í™•ì¸**

```bash
kubectl get vaultconnections,vaultauths -n vault-secrets-operator-system

NAME                                            AGE
vaultconnection.secrets.hashicorp.com/default   4m29s

NAME                                                                          AGE
vaultauth.secrets.hashicorp.com/vault-secrets-operator-default-transit-auth   4m29s
```

**(7) VaultAuth CR ìŠ¤í™ í™•ì¸**

```bash
kubectl get vaultauth -n vault-secrets-operator-system vault-secrets-operator-default-transit-auth -o jsonpath='{.spec}' | jq

{
  "kubernetes": {
    "audiences": [
      "vault"
    ],
    "role": "auth-role-operator",
    "serviceAccount": "vault-secrets-operator-controller-manager",
    "tokenExpirationSeconds": 600
  },
  "method": "kubernetes",
  "mount": "demo-auth-mount",
  "storageEncryption": {
    "keyName": "vso-client-cache",
    "mount": "demo-transit"
  },
  "vaultConnectionRef": "default"
}
```

- ì¸ì¦ ë°©ì‹ì´ `kubernetes`ì¸ì§€ í™•ì¸í•¨
- mountê°€ `demo-auth-mount`ì¸ì§€ í™•ì¸í•¨
- VSOê°€ ì‚¬ìš©í•  Kubernetes Role/SA/audience/í† í° ë§Œë£Œ(600s) í™•ì¸í•¨
- client cache ì•”í˜¸í™” ì„¤ì •ì´ transit ê¸°ë°˜ì¸ì§€ í™•ì¸í•¨

**(8) VaultConnection CR ìŠ¤í™ í™•ì¸**

```bash
kubectl get vaultconnection -n vault-secrets-operator-system default -o jsonpath='{.spec}' | jq

{
  "address": "http://vault.vault.svc.cluster.local:8200",
  "skipTLSVerify": false
}
```

- VSOê°€ ì ‘ê·¼í•  Vault ì£¼ì†Œê°€ ì„œë¹„ìŠ¤ DNS ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ í™•ì¸í•¨
- TLS ê²€ì¦ ìŠ¤í‚µ ì—¬ë¶€(`skipTLSVerify`) í™•ì¸í•¨

**(9) VSO ì»¨íŠ¸ë¡¤ëŸ¬ ServiceAccount RBAC í™•ì¸**

```bash
kubectl rbac-tool lookup vault-secrets-operator-controller-manager

  SUBJECT                                   | SUBJECT TYPE   | SCOPE       | NAMESPACE                     | ROLE                                        | BINDING                                             
--------------------------------------------+----------------+-------------+-------------------------------+---------------------------------------------+-----------------------------------------------------
  vault-secrets-operator-controller-manager | ServiceAccount | ClusterRole |                               | vault-secrets-operator-proxy-role           | vault-secrets-operator-proxy-rolebinding            
  vault-secrets-operator-controller-manager | ServiceAccount | ClusterRole |                               | vault-secrets-operator-manager-role         | vault-secrets-operator-manager-rolebinding          
  vault-secrets-operator-controller-manager | ServiceAccount | Role        | vault-secrets-operator-system | vault-secrets-operator-leader-election-role | vault-secrets-operator-leader-election-rolebinding  
```

- VSO ì»¨íŠ¸ë¡¤ëŸ¬ SAê°€ ì–´ë–¤ Role/ClusterRoleì„ ë¶€ì—¬ë°›ì•˜ëŠ”ì§€ í™•ì¸í•¨
- proxy ì—­í• ê³¼ manager ì—­í• , leader election ì—­í•  ë°”ì¸ë”© í™•ì¸í•¨

**(10) VSO RBAC ê¶Œí•œ ë²”ìœ„ ìƒì„¸ í™•ì¸**

```bash
kubectl rolesum -n vault-secrets-operator-system vault-secrets-operator-controller-manager

ServiceAccount: vault-secrets-operator-system/vault-secrets-operator-controller-manager
Secrets:

Policies:
â€¢ [RB] vault-secrets-operator-system/vault-secrets-operator-leader-election-rolebinding âŸ¶  [R] vault-secrets-operator-system/vault-secrets-operator-leader-election-role
  Resource                    Name  Exclude  Verbs  G L W C U P D DC  
  configmaps                  [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  events                      [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ” âœ– âœ–   
  leases.coordination.k8s.io  [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   

â€¢ [CRB] */vault-secrets-operator-manager-rolebinding âŸ¶  [CR] */vault-secrets-operator-manager-role
  Resource                                                Name  Exclude  Verbs  G L W C U P D DC  
  configmaps                                              [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ– âœ– âœ–   
  daemonsets.apps                                         [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ” âœ– âœ–   
  deployments.apps                                        [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ” âœ– âœ–   
  events                                                  [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ” âœ– âœ–   
  hcpauths.secrets.hashicorp.com                          [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  hcpauths.secrets.hashicorp.com/finalizers               [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  hcpauths.secrets.hashicorp.com/status                   [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  hcpvaultsecretsapps.secrets.hashicorp.com               [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  hcpvaultsecretsapps.secrets.hashicorp.com/finalizers    [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  hcpvaultsecretsapps.secrets.hashicorp.com/status        [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  rollouts.argoproj.io                                    [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ” âœ– âœ–   
  secrets                                                 [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ”   
  secrettransformations.secrets.hashicorp.com             [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  secrettransformations.secrets.hashicorp.com/finalizers  [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  secrettransformations.secrets.hashicorp.com/status      [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  serviceaccounts                                         [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ– âœ– âœ–   
  serviceaccounts/token                                   [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ– âœ– âœ– âœ–   
  statefulsets.apps                                       [*]     [-]     [-]   âœ” âœ” âœ” âœ– âœ– âœ” âœ– âœ–   
  vaultauths.secrets.hashicorp.com                        [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  vaultauths.secrets.hashicorp.com/finalizers             [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  vaultauths.secrets.hashicorp.com/status                 [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  vaultconnections.secrets.hashicorp.com                  [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  vaultconnections.secrets.hashicorp.com/finalizers       [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  vaultconnections.secrets.hashicorp.com/status           [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  vaultdynamicsecrets.secrets.hashicorp.com               [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  vaultdynamicsecrets.secrets.hashicorp.com/finalizers    [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  vaultdynamicsecrets.secrets.hashicorp.com/status        [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  vaultpkisecrets.secrets.hashicorp.com                   [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  vaultpkisecrets.secrets.hashicorp.com/finalizers        [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  vaultpkisecrets.secrets.hashicorp.com/status            [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   
  vaultstaticsecrets.secrets.hashicorp.com                [*]     [-]     [-]   âœ” âœ” âœ” âœ” âœ” âœ” âœ” âœ–   
  vaultstaticsecrets.secrets.hashicorp.com/finalizers     [*]     [-]     [-]   âœ– âœ– âœ– âœ– âœ” âœ– âœ– âœ–   
  vaultstaticsecrets.secrets.hashicorp.com/status         [*]     [-]     [-]   âœ” âœ– âœ– âœ– âœ” âœ” âœ– âœ–   

â€¢ [CRB] */vault-secrets-operator-proxy-rolebinding âŸ¶  [CR] */vault-secrets-operator-proxy-role
  Resource                                   Name  Exclude  Verbs  G L W C U P D DC  
  subjectaccessreviews.authorization.k8s.io  [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ– âœ– âœ–   
  tokenreviews.authentication.k8s.io         [*]     [-]     [-]   âœ– âœ– âœ– âœ” âœ– âœ– âœ– âœ–   
```

- VSOëŠ” Vaultì—ì„œ ê°€ì ¸ì˜¨ ê°’ì„ Kubernetes Secretë¡œ â€œìƒì„±/ê°±ì‹ â€í•´ì•¼ í•˜ë¯€ë¡œ secretsì— ëŒ€í•œ ê°•í•œ ê¶Œí•œ í•„ìš”í•¨
- Deployment/StatefulSet/Rollout ë“±ì— ë°˜ì˜ì„ ìœ„í•´ rollout ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ì¡°íšŒ/íŒ¨ì¹˜ ê¶Œí•œ í•„ìš”í•¨
- Kubernetes Auth ê²€ì¦ì„ ìœ„í•œ TokenReview/SubjectAccessReview ê¶Œí•œë„ í¬í•¨ë¨

---

### **5. Deploy and sync a secret**

**(1) ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤(app) ìƒì„±**

```bash
kubectl create ns app

namespace/app created
```

**(2) VaultAuth CRD ìŠ¤í™ í™•ì¸**

```bash
kubectl explain vaultauths.spec

# ê²°ê³¼
GROUP:      secrets.hashicorp.com
KIND:       VaultAuth
VERSION:    v1beta1

FIELD: spec <Object>

DESCRIPTION:
    VaultAuthSpec defines the desired state of VaultAuth
    
FIELDS:
  allowedNamespaces	<[]string>
    AllowedNamespaces Kubernetes Namespaces which are allow-listed for use with
    this AuthMethod.
    This field allows administrators to customize which Kubernetes namespaces
    are authorized to
    use with this AuthMethod. While Vault will still enforce its own rules, this
    has the added
    configurability of restricting which VaultAuthMethods can be used by which
    namespaces.
    Accepted values:
    []{"*"} - wildcard, all namespaces.
    []{"a", "b"} - list of namespaces.
    unset - disallow all namespaces except the Operator's the VaultAuthMethod's
    namespace, this
    is the default behavior.

  appRole	<Object>
    AppRole specific auth configuration, requires that the Method be set to
    `appRole`.

  aws	<Object>
    AWS specific auth configuration, requires that Method be set to `aws`.

  gcp	<Object>
    GCP specific auth configuration, requires that Method be set to `gcp`.

  headers	<map[string]string>
    Headers to be included in all Vault requests.

  jwt	<Object>
    JWT specific auth configuration, requires that the Method be set to `jwt`.

  kubernetes	<Object>
    Kubernetes specific auth configuration, requires that the Method be set to
    `kubernetes`.

  method	<string> -required-
  enum: kubernetes, jwt, appRole, aws, ....
    Method to use when authenticating to Vault.

  mount	<string> -required-
    Mount to use when authenticating to auth method.

  namespace	<string>
    Namespace to auth to in Vault

  params	<map[string]string>
    Params to use when authenticating to Vault

  storageEncryption	<Object>
    StorageEncryption provides the necessary configuration to encrypt the client
    storage cache.
    This should only be configured when client cache persistence with encryption
    is enabled.
    This is done by passing setting the manager's commandline argument
    --client-cache-persistence-model=direct-encrypted. Typically, there should
    only ever
    be one VaultAuth configured with StorageEncryption in the Cluster, and it
    should have
    the label: cacheStorageEncryption=true

  vaultConnectionRef	<string>
    VaultConnectionRef to the VaultConnection resource, can be prefixed with a
    namespace,
    eg: `namespaceA/vaultConnectionRefB`. If no namespace prefix is provided it
    will default to
    namespace of the VaultConnection CR. If no value is specified for
    VaultConnectionRef the
    Operator will default to the `default` VaultConnection, configured in the
    operator's namespace.
```

- VSOì˜ ì¸ì¦ ì„¤ì • ë¦¬ì†ŒìŠ¤ì¸ `VaultAuth` CRDì˜ ìŠ¤í™ êµ¬ì¡°ë¥¼ `kubectl explain`ë¡œ í™•ì¸í•¨

**(3) Secret ë™ê¸°í™”ë¥¼ ìœ„í•œ Kubernetes Auth ì„¤ì • ì ìš©**

```bash
cat vault/vault-auth-static.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  # SA bound to the VSO namespace for transit engine auth
  namespace: vault-secrets-operator-system
  name: demo-operator
---
apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: app
  name: demo-static-app
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: static-auth
  namespace: app
spec:
  method: kubernetes
  mount: demo-auth-mount
  kubernetes:
    role: role1
    serviceAccount: demo-static-app
    audiences:
      - vault
```

```bash
kubectl apply -f vault/vault-auth-static.yaml

serviceaccount/demo-operator created
serviceaccount/demo-static-app created
vaultauth.secrets.hashicorp.com/static-auth created
```

- `app` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— **Secret ì¡°íšŒìš© SA**(`demo-static-app`) ìƒì„±í•¨
- `app` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— `VaultAuth(static-auth)`ë¥¼ ìƒì„±í•´
    - `demo-auth-mount` auth mount ì‚¬ìš©
    - Vault role `role1` ì‚¬ìš©
    - í† í° audienceëŠ” `vault`ë¡œ ì§€ì •í•¨
- ë³„ë„ë¡œ `vault-secrets-operator-system` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— `demo-operator` SAë„ ìƒì„±í•˜ì—¬(Transit ë“± ìš´ì˜ìš© ëª©ì ) ì—­í•  ë¶„ë¦¬ ê¸°ë°˜ êµ¬ì„±í•¨

**(4) ServiceAccount/VaultAuth ìƒì„± í™•ì¸**

```bash
kubectl get sa,vaultauth -n app

NAME                             SECRETS   AGE
serviceaccount/default           0         2m12s
serviceaccount/demo-static-app   0         13s

NAME                                          AGE
vaultauth.secrets.hashicorp.com/static-auth   13s
```

**(5) VaultStaticSecret CRD ìŠ¤í™ í™•ì¸**

```bash
kubectl explain vaultstaticsecrets.spec

# ê²°ê³¼
GROUP:      secrets.hashicorp.com
KIND:       VaultStaticSecret
VERSION:    v1beta1

FIELD: spec <Object>

DESCRIPTION:
    VaultStaticSecretSpec defines the desired state of VaultStaticSecret
    
FIELDS:
  destination	<Object> -required-
    Destination provides configuration necessary for syncing the Vault secret to
    Kubernetes.

  hmacSecretData	<boolean>
    HMACSecretData determines whether the Operator computes the
    HMAC of the Secret's data. The MAC value will be stored in
    the resource's Status.SecretMac field, and will be used for drift detection
    and during incoming Vault secret comparison.
    Enabling this feature is recommended to ensure that Secret's data stays
    consistent with Vault.

  mount	<string> -required-
    Mount for the secret in Vault

  namespace	<string>
    Namespace to get the secret from in Vault

  path	<string> -required-
    Path of the secret in Vault, corresponds to the `path` parameter for,
    kv-v1:
    https://developer.hashicorp.com/vault/api-docs/secret/kv/kv-v1#read-secret
    kv-v2:
    https://developer.hashicorp.com/vault/api-docs/secret/kv/kv-v2#read-secret-version

  refreshAfter	<string>
    RefreshAfter a period of time, in duration notation e.g. 30s, 1m, 24h

  rolloutRestartTargets	<[]Object>
    RolloutRestartTargets should be configured whenever the application(s)
    consuming the Vault secret does
    not support dynamically reloading a rotated secret.
    In that case one, or more RolloutRestartTarget(s) can be configured here.
    The Operator will
    trigger a "rollout-restart" for each target whenever the Vault secret
    changes between reconciliation events.
    All configured targets wil be ignored if HMACSecretData is set to false.
    See RolloutRestartTarget for more details.

  type	<string> -required-
  enum: kv-v1, kv-v2
    Type of the Vault static secret

  vaultAuthRef	<string>
    VaultAuthRef to the VaultAuth resource, can be prefixed with a namespace,
    eg: `namespaceA/vaultAuthRefB`. If no namespace prefix is provided it will
    default to
    namespace of the VaultAuth CR. If no value is specified for VaultAuthRef the
    Operator will
    default to the `default` VaultAuth, configured in the operator's namespace.

  version	<integer>
    Version of the secret to fetch. Only valid for type kv-v2. Corresponds to
    version query parameter:
    https://developer.hashicorp.com/vault/api-docs/secret/kv/kv-v2#version
```

- `VaultStaticSecret`ì€ Vaultì˜ **ì •ì  ì‹œí¬ë¦¿(KV)** ì„ Kubernetes Secretìœ¼ë¡œ ë™ê¸°í™”í•˜ëŠ” CRDì„
- í•µì‹¬ í•„ë“œ
    - `type`: kv-v1 / kv-v2
    - `mount`: Vault secrets engine mount ê²½ë¡œ
    - `path`: Vault ë‚´ secret ê²½ë¡œ
    - `destination`: ìƒì„±/ê°±ì‹ í•  Kubernetes Secret ì •ë³´
    - `refreshAfter`: Vault ê°’ì„ ì¬ì¡°íšŒí•´ ë™ê¸°í™”í•˜ëŠ” ì£¼ê¸°
    - `vaultAuthRef`: ì‚¬ìš©í•  VaultAuth ë¦¬ì†ŒìŠ¤ ì§€ì •

**(6) Vault â†’ Kubernetes Secret ë™ê¸°í™” ë¦¬ì†ŒìŠ¤ ìƒì„±**

```bash
cat vault/static-secret.yaml

apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: vault-kv-app
  namespace: app
spec:
  type: kv-v2

  # mount path
  mount: kvv2

  # path of the secret
  path: webapp/config

  # dest k8s secret
  destination:
    name: secretkv
    create: true

  # static secret refresh interval
  refreshAfter: 30s

  # Name of the CRD to authenticate to Vault
  vaultAuthRef: static-auth
```

```bash
kubectl apply -f vault/static-secret.yaml

vaultstaticsecret.secrets.hashicorp.com/vault-kv-app created
```

- `VaultStaticSecret(vault-kv-app)`ë¥¼ ìƒì„±í•˜ì—¬ Vaultì˜ `kvv2/webapp/config`ë¥¼ Kubernetes Secret `secretkv`ë¡œ ìë™ ìƒì„±/ë™ê¸°í™”í•˜ë„ë¡ êµ¬ì„±í•¨
- `refreshAfter: 30s`ë¡œ 30ì´ˆë§ˆë‹¤ Vault ê°’ì„ ì¬ì¡°íšŒí•´ ë°˜ì˜í•˜ë„ë¡ ì„¤ì •í•¨
- ì¸ì¦ì€ ì•ì„œ ë§Œë“  `vaultAuthRef: static-auth`ë¥¼ ì‚¬ìš©í•¨

**(7) VaultStaticSecret ìƒì„± í™•ì¸**

```bash
kubectl get vaultstaticsecret -n app

NAME           AGE
vault-kv-app   11s
```

---

### **6. Rotate the static secret**

**(1) Kubernetes Secret ìƒì„± í™•ì¸**

```bash
kubectl get secret -n app

NAME       TYPE     DATA   AGE
secretkv   Opaque   3      63s
```

- VSOê°€ Vaultì˜ ì •ì  ì‹œí¬ë¦¿ì„ `app` ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ Kubernetes Secret(`secretkv`)ë¡œ ì •ìƒ ìƒì„±í–ˆëŠ”ì§€ í™•ì¸í•¨

**(2) Kubernetes Secret ê°’ í™•ì¸**

```bash
kubectl krew install view-secret
kubectl view-secret -n app secretkv --all

# ê²°ê³¼
_raw='{"data":{"password":"static-password","username":"static-user"},"metadata":{"created_time":"2025-12-13T10:33:17.086953754Z","custom_metadata":null,"deletion_time":"","destroyed":false,"version":1}}'
password='static-password'
username='static-user'
```
![](https://velog.velcdn.com/images/tlsalswls123/post/bc334551-023f-4f49-a069-e97a152d8a34/image.png)

**(3) Vault Secret Rotate ìˆ˜í–‰**

```bash
vault kv put kvv2/webapp/config username="static-user2" password="static-password2"

===== Secret Path =====
kvv2/data/webapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T10:56:32.93205681Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            2
```

- Vaultì˜ `kvv2/webapp/config` ê°’ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ì •ì  ì‹œí¬ë¦¿ì„ íšŒì „(rotate)í•¨
- KV v2 íŠ¹ì„±ìƒ metadataì˜ `version`ì´ 2ë¡œ ì¦ê°€í•¨

**(4) VSO ë™ê¸°í™” ê²°ê³¼ í™•ì¸**

```bash
kubectl view-secret -n app secretkv --all

_raw='{"data":{"password":"static-password2","username":"static-user2"},"metadata":{"created_time":"2025-12-13T10:56:32.93205681Z","custom_metadata":null,"deletion_time":"","destroyed":false,"version":2}}'
password='static-password2'
username='static-user2'
```
![](https://velog.velcdn.com/images/tlsalswls123/post/059efc1e-0e07-41a0-bf16-57385098cafd/image.png)

- ì¼ì • ì‹œê°„(`refreshAfter: 30s`) ì´í›„ VSOê°€ Vault ë³€ê²½ì„ ê°ì§€í•˜ê³  Kubernetes Secret(`secretkv`) ê°’ì„ ìë™ ì—…ë°ì´íŠ¸í•¨
- ì¶œë ¥ ê²°ê³¼ì—ì„œ username/passwordê°€ `static-user2/static-password2`ë¡œ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•¨
- `_raw`ì˜ metadata ë²„ì „ë„ 2ë¡œ ë°˜ì˜ë¨

**(5) Secret ë¦¬ì†ŒìŠ¤ëŠ” ì¬ìƒì„±ë˜ì§€ ì•Šê³  ê°’ë§Œ ë³€ê²½ë¨**

```bash
kubectl get secret -n app

NAME       TYPE     DATA   AGE
secretkv   Opaque   3      4m30s
```

- `kubectl get secret`ì—ì„œ `AGE`ê°€ ìœ ì§€ë˜ëŠ” ê²ƒì„ í†µí•´ Secret ì˜¤ë¸Œì íŠ¸ ìì²´ë¥¼ ìƒˆë¡œ ë§Œë“¤ì§€ ì•Šê³  **ë™ì¼ ë¦¬ì†ŒìŠ¤ì˜ dataë§Œ ê°±ì‹ (update)** í•œ ê²ƒì„ í™•ì¸í•¨
- ì¦‰, VSOëŠ” â€œSecret ì¬ìƒì„±â€ì´ ì•„ë‹ˆë¼ â€œSecret ë™ê¸°í™” ì—…ë°ì´íŠ¸â€ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•¨

---

## **ğŸ˜ dynamic secret ë™ì  ì•”í˜¸ ì£¼ê¸° ê´€ë¦¬ ì‹¤ìŠµ**

### **1. PostgreSQL íŒŒë“œ ë°°í¬ ë° Vault Database Secret Engine ì„¤ì •**

- [https://developer.hashicorp.com/vault/docs/deploy/kubernetes/vso/sources/vault#vault-client-cache](https://developer.hashicorp.com/vault/docs/deploy/kubernetes/vso/sources/vault#vault-client-cache)
- [https://developer.hashicorp.com/vault/docs/deploy/kubernetes/vso/sources/vault/client-cache](https://developer.hashicorp.com/vault/docs/deploy/kubernetes/vso/sources/vault/client-cache)

**(1) PostgreSQL ì „ìš© ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±**

```bash
kubectl create ns postgres

namespace/postgres created
```

**(2) Bitnami Helm Repo ì¶”ê°€**

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami
```

**(3) PostgreSQL ì„¤ì¹˜(Helm)**

```bash
helm upgrade --install postgres bitnami/postgresql --namespace postgres --set auth.audit.logConnections=true  --set auth.postgresPassword=secret-pass

# ê²°ê³¼
Release "postgres" does not exist. Installing it now.
NAME: postgres
LAST DEPLOYED: Sat Dec 13 20:12:10 2025
NAMESPACE: postgres
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: postgresql
CHART VERSION: 18.1.13
APP VERSION: 18.1.0
...
```

- Bitnami PostgreSQL ì°¨íŠ¸ë¡œ `postgres` ë¦´ë¦¬ì¦ˆë¥¼ ì„¤ì¹˜í•¨
- `postgres` ê³„ì • íŒ¨ìŠ¤ì›Œë“œë¥¼ `secret-pass`ë¡œ ê³ ì • ì„¤ì •í•¨
- `auth.audit.logConnections=true`ë¡œ ì—°ê²° ë¡œê·¸ë¥¼ ë‚¨ê¸°ë„ë¡ ì„¤ì •í•¨

**(4) PostgreSQL ë¦¬ì†ŒìŠ¤ ë°°í¬ ìƒíƒœ í™•ì¸**

```bash
kubectl get sts,pod,svc,ep,pvc,secret -n postgres

NAME                                   READY   AGE
statefulset.apps/postgres-postgresql   1/1     40s

NAME                        READY   STATUS    RESTARTS   AGE
pod/postgres-postgresql-0   1/1     Running   0          40s

NAME                             TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/postgres-postgresql      ClusterIP   10.96.122.63   <none>        5432/TCP   40s
service/postgres-postgresql-hl   ClusterIP   None           <none>        5432/TCP   40s

NAME                               ENDPOINTS         AGE
endpoints/postgres-postgresql      10.244.0.8:5432   40s
endpoints/postgres-postgresql-hl   10.244.0.8:5432   40s

NAME                                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-postgres-postgresql-0   Bound    pvc-447b64e3-b73a-4f0f-b25f-b6ec842d8010   8Gi        RWO            standard       <unset>                 40s

NAME                                    TYPE                 DATA   AGE
secret/postgres-postgresql              Opaque               1      40s
secret/sh.helm.release.v1.postgres.v1   helm.sh/release.v1   1      40s
```

**(5) PostgreSQL Secret ê°’ í™•ì¸**

```bash
kubectl view-secret -n postgres postgres-postgresql --all

secret-pass
```

**(6) PostgreSQL ì ‘ì† í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it -n postgres postgres-postgresql-0 -- sh -c "PGPASSWORD=secret-pass psql -U postgres -h localhost -c '\l'"

                                                     List of databases
   Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |   Access privileges   
-----------+----------+----------+-----------------+-------------+-------------+--------+-----------+-----------------------
 postgres  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | 
 template0 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
           |          |          |                 |             |             |        |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
           |          |          |                 |             |             |        |           | postgres=CTc/postgres
(3 rows)
```

---

### **2. PostgreSQL ê´€ë ¨ ì„¤ì •**

**(1) Vault Database Secrets Engine í™œì„±í™”**

```bash
vault secrets enable -path=demo-db database

Success! Enabled the database secrets engine at: demo-db/
```

- PostgreSQLì— ëŒ€í•´ **ë™ì  DB ê³„ì •(ì„ì‹œ ì‚¬ìš©ì/íŒ¨ìŠ¤ì›Œë“œ)** ì„ ë°œê¸‰í•˜ê¸° ìœ„í•´ Database Secrets Engineì„ í™œì„±í™”í•¨
- ì—”ì§„ ê²½ë¡œëŠ” `demo-db/`ë¡œ ì§€ì •í•¨

**(2) Database Secrets Engine ì—°ê²° ì„¤ì •**

```bash
vault write demo-db/config/demo-db \
   plugin_name=postgresql-database-plugin \
   allowed_roles="dev-postgres" \
   connection_url="postgresql://{{username}}:{{password}}@postgres-postgresql.postgres.svc.cluster.local:5432/postgres?sslmode=disable" \
   username="postgres" \
   password="secret-pass"
   
Success! Data written to: demo-db/config/demo-db
```

- Vaultê°€ PostgreSQLì— ì ‘ì†í•´ ë™ì  ê³„ì •ì„ ìƒì„±/íšŒìˆ˜í•  ìˆ˜ ìˆë„ë¡ DB ì—°ê²° ì •ë³´ë¥¼ ë“±ë¡í•¨
- `postgresql-database-plugin` ì‚¬ìš©
- `allowed_roles="dev-postgres"`ë¡œ ì´ ì—°ê²° ì„¤ì •ì—ì„œ í—ˆìš©í•  roleì„ ì œí•œí•¨
- `connection_url`ì— Kubernetes ì„œë¹„ìŠ¤ DNS(`postgres-postgresql.postgres.svc.cluster.local`)ë¥¼ ì‚¬ìš©í•´ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ í†µì‹ í•˜ë„ë¡ êµ¬ì„±í•¨
- ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œ `username=postgres`, `password=secret-pass`ë¥¼ ë“±ë¡í•¨

**(3) DB ì—°ê²° ì„¤ì • í™•ì¸**

```bash
vault read demo-db/config/demo-db

Key                                   Value
---                                   -----
allowed_roles                         [dev-postgres]
connection_details                    map[connection_url:postgresql://{{username}}:{{password}}@postgres-postgresql.postgres.svc.cluster.local:5432/postgres?sslmode=disable username:postgres]
disable_automated_rotation            false
password_policy                       n/a
plugin_name                           postgresql-database-plugin
plugin_version                        n/a
root_credentials_rotate_statements    []
rotation_period                       0s
rotation_schedule                     n/a
rotation_window                       0
skip_static_role_import_rotation      false
verify_connection                     true
```

**(4) PostgreSQL ë™ì  ê³„ì • ë°œê¸‰ Role ìƒì„±**

```bash
vault write demo-db/roles/dev-postgres \
   db_name=demo-db \
   creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; \
      GRANT ALL PRIVILEGES ON DATABASE postgres TO \"{{name}}\";" \
   revocation_statements="REVOKE ALL ON DATABASE postgres FROM  \"{{name}}\";" \
   backend=demo-db \
   name=dev-postgres \
   default_ttl="10m" \
   max_ttl="20m"
   
Success! Data written to: demo-db/roles/dev-postgres
```

- `demo-db/roles/dev-postgres`ë¥¼ ìƒì„±í•˜ì—¬ Vaultê°€ ë™ì ìœ¼ë¡œ DB ì‚¬ìš©ìë¥¼ ë§Œë“¤ê³ , TTL ë§Œë£Œ ì‹œ íšŒìˆ˜í•  ìˆ˜ ìˆê²Œ êµ¬ì„±í•¨
- `creation_statements`
    - `CREATE ROLE "{{name}}" ... VALID UNTIL "{{expiration}}"`ë¡œ ìœ íš¨ê¸°ê°„ì´ ìˆëŠ” ê³„ì • ìƒì„±
    - ìƒì„±ëœ ê³„ì •ì— `postgres` DBì— ëŒ€í•œ ê¶Œí•œì„ ë¶€ì—¬í•¨
- `revocation_statements`
    - ë§Œë£Œ/íšŒìˆ˜ ì‹œ í•´ë‹¹ ê³„ì •ì˜ DB ê¶Œí•œì„ ì œê±°í•¨
- TTL ì„¤ì •
    - `default_ttl=10m`: ê¸°ë³¸ ë°œê¸‰ ìœ íš¨ê¸°ê°„ 10ë¶„
    - `max_ttl=20m`: ì—°ì¥í•˜ë”ë¼ë„ ìµœëŒ€ 20ë¶„ì„ ë„˜ì§€ ëª»í•¨

**(5) Role ì„¤ì •ê°’ í™•ì¸**

```bash
vault read demo-db/roles/dev-postgres

Key                      Value
---                      -----
creation_statements      [CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';       GRANT ALL PRIVILEGES ON DATABASE postgres TO "{{name}}";]
credential_type          password
db_name                  demo-db
default_ttl              10m
max_ttl                  20m
renew_statements         []
revocation_statements    [REVOKE ALL ON DATABASE postgres FROM  "{{name}}";]
rollback_statements      []
```

- ìƒì„±/íšŒìˆ˜ SQL, TTL ê°’ì´ ì˜ë„ëŒ€ë¡œ ë“¤ì–´ê°”ëŠ”ì§€ í™•ì¸í•¨

**(6) ë™ì  DB Credential ì¡°íšŒ ê¶Œí•œ Policy ìƒì„±**

```bash
vault policy write demo-auth-policy-db - <<EOF
path "demo-db/creds/dev-postgres" {
   capabilities = ["read"]
}
EOF

Success! Uploaded policy: demo-auth-policy-db
```

- `demo-db/creds/dev-postgres` ê²½ë¡œì—ì„œ ë°œê¸‰ë˜ëŠ” Credentialì„ ì½ì„ ìˆ˜ ìˆë„ë¡ ì •ì±…ì„ ìƒì„±í•¨
- ì´í›„ Kubernetes Auth role ë“±ì— ì´ policyë¥¼ ë§¤í•‘í•˜ë©´ íŒŒë“œê°€ ë™ì  DB ê³„ì •ì„ ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ

**(7) PostgreSQL Role ëª©ë¡ í™•ì¸(psql)**

```bash
kubectl exec -it -n postgres postgres-postgresql-0 -- sh -c "PGPASSWORD=secret-pass psql -U postgres -h localhost -c '\du'"

                             List of roles
 Role name |                         Attributes                         
-----------+------------------------------------------------------------
 postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS
```

- í˜„ì¬ PostgreSQLì— ì–´ë–¤ role(ê³„ì •)ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•¨
- ì´ˆê¸° ìƒíƒœì—ì„œëŠ” `postgres` ìŠˆí¼ìœ ì €ë§Œ ì¡´ì¬í•˜ëŠ” ê²ƒì´ ì •ìƒì´ë©°, ì´í›„ Vaultê°€ ë™ì  ê³„ì •ì„ ìƒì„±í•˜ë©´ ëª©ë¡ì— ì¶”ê°€ë˜ëŠ” ë°©ì‹ìœ¼ë¡œ ê²€ì¦ ê°€ëŠ¥í•¨

---

### **3. Setup dynamic secrets**

**(1) PostgreSQL Dynamic Secretìš© Kubernetes Auth Role ìƒì„±**

```bash
vault write auth/demo-auth-mount/role/auth-role \
   bound_service_account_names=demo-dynamic-app \
   bound_service_account_namespaces=demo-ns \
   token_ttl=0 \
   token_period=120 \
   token_policies=demo-auth-policy-db \
   audience=vault
   
Success! Data written to: auth/demo-auth-mount/role/auth-role
```

**(2) ìƒì„±ëœ Auth Role ì„¤ì • í™•ì¸**

```bash
vault read auth/demo-auth-mount/role/auth-role

Key                                         Value
---                                         -----
alias_name_source                           serviceaccount_uid
audience                                    vault
bound_service_account_names                 [demo-dynamic-app]
bound_service_account_namespace_selector    n/a
bound_service_account_namespaces            [demo-ns]
token_bound_cidrs                           []
token_explicit_max_ttl                      0s
token_max_ttl                               0s
token_no_default_policy                     false
token_num_uses                              0
token_period                                2m
token_policies                              [demo-auth-policy-db]
token_ttl                                   0s
token_type                                  default
```

---

### **4. Create the application**

**(1) demo-ns ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±**

```bash
kubectl create ns demo-ns
namespace/demo-ns created
```

**(2) ë™ì  ì‹œí¬ë¦¿ ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì„± í™•ì¸**

```bash
ls dynamic-secrets/.
app-deployment.yaml   postgres                  vault-auth-operator.yaml           vault-dynamic-secret.yaml
app-secret.yaml       vault-auth-dynamic.yaml   vault-dynamic-secret-create.yaml   vault-operator-sa.yaml
```

**(3) ë™ì  ì‹œí¬ë¦¿ ê¸°ë°˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬**

```bash
kubectl apply -f dynamic-secrets/.

deployment.apps/vso-db-demo created
secret/vso-db-demo created
serviceaccount/demo-dynamic-app created
vaultauth.secrets.hashicorp.com/dynamic-auth created
vaultdynamicsecret.secrets.hashicorp.com/vso-db-demo-create created
vaultdynamicsecret.secrets.hashicorp.com/vso-db-demo created
serviceaccount/demo-operator unchanged
```

**(4) vso-db-demo íŒŒë“œ ê¸°ë™ í™•ì¸**

```bash
kubectl get pod -n demo-ns

NAME                           READY   STATUS    RESTARTS   AGE
vso-db-demo-6ccd6f964f-cvqmh   1/1     Running   0          20s
vso-db-demo-6ccd6f964f-fcpwx   1/1     Running   0          20s
vso-db-demo-6ccd6f964f-xltqp   1/1     Running   0          6s
```

**(5) íŒŒë“œì— Secret(/etc/secrets) ë§ˆìš´íŠ¸ í™•ì¸**

```bash
kubectl describe pod -n demo-ns

# ê²°ê³¼
...
    Mounts:
      /etc/secrets from secrets (ro)
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-4rqt8 (ro)
...
Volumes:
  secrets:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  vso-db-demo
    Optional:    false
...    
```

- íŒŒë“œì˜ `/etc/secrets` ë³¼ë¥¨ì´ K8S Secret `vso-db-demo`ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ˆìš´íŠ¸ë˜ëŠ”ì§€ í™•ì¸í•¨
- ì¦‰, **VSOê°€ Secretì„ ê°±ì‹ í•˜ë©´ íŒŒë“œì—ëŠ” íŒŒì¼ í˜•íƒœë¡œ ê°’ì´ ë°˜ì˜**ë˜ëŠ” êµ¬ì¡°ì„

**(6) /etc/secrets ë™ì  ìê²©ì¦ëª… íŒŒì¼ í™•ì¸**

```bash
kubectl exec -it deploy/vso-db-demo -n demo-ns -- ls -al /etc/secrets

total 8
drwxrwxrwt 3 root root  140 Dec 13 11:21 .
drwxr-xr-x 1 root root 4096 Dec 13 11:21 ..
drwxr-xr-x 2 root root  100 Dec 13 11:21 ..2025_12_13_11_21_20.3821164146
lrwxrwxrwx 1 root root   32 Dec 13 11:21 ..data -> ..2025_12_13_11_21_20.3821164146
lrwxrwxrwx 1 root root   11 Dec 13 11:21 _raw -> ..data/_raw
lrwxrwxrwx 1 root root   15 Dec 13 11:21 password -> ..data/password
lrwxrwxrwx 1 root root   15 Dec 13 11:21 username -> ..data/username
```

```bash
kubectl exec -it deploy/vso-db-demo -n demo-ns -- cat /etc/secrets/username ; echo

v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880
```

```bash
kubectl exec -it deploy/vso-db-demo -n demo-ns -- cat /etc/secrets/password ; echo

sPkElMq2JWgjX6OD-43D
```

- Secret ë³¼ë¥¨ íŠ¹ì„±ìƒ `..data` ì‹¬ë³¼ë¦­ ë§í¬ êµ¬ì¡°ë¡œ íŒŒì¼ì´ ë°°ì¹˜ë¨
- `username`, `password`, `_raw` íŒŒì¼ì´ ìƒì„±ë˜ì–´ ë™ì  DB ê³„ì •ì´ ì €ì¥ë¨

**(7) demo-ns ë„¤ì„ìŠ¤í˜ì´ìŠ¤ Secret ë™ê¸°í™” ê²°ê³¼ í™•ì¸**

```bash
kubectl get secret -n demo-ns

NAME                  TYPE     DATA   AGE
vso-db-demo           Opaque   3      3m16s
vso-db-demo-created   Opaque   3      3m16s
```

```bash
kubectl view-secret -n demo-ns vso-db-demo --all

_raw='{"password":"sPkElMq2JWgjX6OD-43D","username":"v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880"}'
password='sPkElMq2JWgjX6OD-43D'
username='v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880'
```

- `vso-db-demo`ëŠ” ì‹¤ì œ ì•±ì´ ì½ëŠ” Secret
- `vso-db-demo-created`ëŠ” ìƒì„± ì‹œì /ë©”íƒ€ ê´€ë¦¬ ëª©ì (ì‹¤ìŠµ êµ¬ì„±ì— ë”°ë¼ ìƒì„±)ìœ¼ë¡œ í•¨ê»˜ ì¡´ì¬í•¨
- `view-secret`ìœ¼ë¡œ username/passwordê°€ Vaultì—ì„œ ë°œê¸‰ëœ ê°’ìœ¼ë¡œ ë“¤ì–´ì™”ëŠ”ì§€ í™•ì¸í•¨

**(8) VaultAuth ë¦¬ì†ŒìŠ¤ í™•ì¸(dynamic-auth)**

```bash
kubectl get vaultauth -n demo-ns dynamic-auth -o yaml

...
spec:
  kubernetes:
    audiences:
    - vault
    role: auth-role
    serviceAccount: demo-dynamic-app
    tokenExpirationSeconds: 600
  method: kubernetes
  mount: demo-auth-mount
...
```

- `demo-auth-mount`ë¥¼ ì‚¬ìš©í•œ Kubernetes Auth êµ¬ì„±ì¸ì§€ í™•ì¸í•¨
- Vault roleì€ `auth-role`, SAëŠ” `demo-dynamic-app`, audienceëŠ” `vault`ë¡œ ì„¤ì •ë¨
- tokenExpirationSeconds=600ìœ¼ë¡œ K8S SA í† í°ì€ 10ë¶„ ë‹¨ìœ„ë¡œ ê°±ì‹ ë˜ëŠ” í˜•íƒœì„

**(9) VaultDynamicSecret ë¦¬ì†ŒìŠ¤ í™•ì¸(vso-db-demo)**

```bash
kubectl get vaultdynamicsecret -n demo-ns vso-db-demo -o yaml

...
spec:
  destination:
    create: false
    name: vso-db-demo
    overwrite: false
    transformation: {}
  mount: demo-db
  path: creds/dev-postgres
  renewalPercent: 67
  rolloutRestartTargets:
  - kind: Deployment
    name: vso-db-demo
  vaultAuthRef: dynamic-auth
status:
  lastGeneration: 2
  lastRenewalTime: 1765624880
  lastRuntimePodUID: 4781cbea-19a8-4675-bdec-fcc622299567
  secretLease:
    duration: 600
    id: demo-db/creds/dev-postgres/mMgHV5K7pyIXiCTOOwqG3Ed8
    renewable: true
    requestID: bfa058aa-aec9-8098-6c8d-df25c179ee82
  staticCredsMetaData:
    lastVaultRotation: 0
    rotationPeriod: 0
    ttl: 0
  vaultClientMeta:
    cacheKey: kubernetes-0a15983007d4f6e99deb3d
    id: c2afe154e8e28538ff782269b0552ef5cbfa41604a2cff01fd0004e6a60f4fcd
```

- VSOê°€ Vaultì—ì„œ **`demo-db/creds/dev-postgres`** ë¥¼ ì½ì–´ ë™ì  DB ê³„ì •ì„ ë°œê¸‰ë°›ê³  ì´ë¥¼ K8S Secret `vso-db-demo`ë¡œ ë™ê¸°í™”í•˜ëŠ” ì„¤ì •ì„
- `renewalPercent: 67`ë¡œ lease ë§Œë£Œ ì „ ì¼ì • ë¹„ìœ¨ ì‹œì ì— ê°±ì‹ ì„ ì‹œë„í•¨
- `rolloutRestartTargets`ê°€ Deploymentë¡œ ì§€ì •ë˜ì–´ ìˆì–´ Secret ë³€ê²½ ì‹œ **rollout-restart**ê°€ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŒ
- statusì—ì„œ lease ì •ë³´(ê¸°ê°„ 600ì´ˆ, renewable=true, lease id ë“±)ë¥¼ í™•ì¸ ê°€ëŠ¥í•¨

**(10) PostgreSQLì— ë™ì  ê³„ì •ì´ ì‹¤ì œ ìƒì„±ë˜ëŠ”ì§€ í™•ì¸**

```bash
kubectl exec -it -n postgres postgres-postgresql-0 -- sh -c "PGPASSWORD=secret-pass psql -U postgres -h localhost -c '\du'"

                                                  List of roles
                      Role name                      |                         Attributes                         
-----------------------------------------------------+------------------------------------------------------------
 postgres                                            | Superuser, Create role, Create DB, Replication, Bypass RLS
 v-demo-aut-dev-post-6LhL36PwSmznWj1G1W3p-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-WEfwYsV05xPot7LzG2I1-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-XWri6OMU7jRRBFBBwM6d-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880 | Password valid until 2025-12-13 11:31:25+00
```

- `\du`ë¡œ role ëª©ë¡ì„ ë³´ë©´ Vaultê°€ ë°œê¸‰í•œ ì‚¬ìš©ìë“¤ì´ PostgreSQLì— ì‹¤ì œë¡œ ìƒì„±ë¨
- ê° ê³„ì •ì—ëŠ” `Password valid until ...`ê°€ ë¶™ì–´ ìˆìœ¼ë©°, **TTL ê¸°ë°˜ ì„ì‹œ ê³„ì •**ìœ¼ë¡œ ë§Œë£Œ ì‹œê°„ì´ ëª…ì‹œë¨
- ì•± íŒŒë“œ replicasê°€ ì—¬ëŸ¬ ê°œ(ì˜ˆ: 3ê°œ)ì¸ ê²½ìš°, **ë™ì‹œ/ì£¼ê¸° ë°œê¸‰ìœ¼ë¡œ ë™ì  ê³„ì •ì´ ì—¬ëŸ¬ ê°œ ìƒì„±**ë˜ì–´ ëª©ë¡ì— ë‹¤ìˆ˜ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŒ

**(11) ë™ì  Secret ê°±ì‹  ì‹œ K8S Secretì€ â€œì¬ìƒì„±â€ì´ ì•„ë‹ˆë¼ â€œê°’ë§Œ ë³€ê²½â€**

```bash
kubectl get secret -n demo-ns
NAME                  TYPE     DATA   AGE
vso-db-demo           Opaque   3      7m33s
vso-db-demo-created   Opaque   3      7m33s
```

```bash
kubectl view-secret -n demo-ns vso-db-demo --all

_raw='{"password":"sPkElMq2JWgjX6OD-43D","username":"v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880"}'
password='sPkElMq2JWgjX6OD-43D'
username='v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880'
```

- 1ì°¨ í™•ì¸ ì‹œì ì— `vso-db-demo` / `vso-db-demo-created` Secretì´ ì¡´ì¬í•¨
- `kubectl get secret`ì˜ `AGE`ê°€ ìœ ì§€ë˜ë¯€ë¡œ **Secret ë¦¬ì†ŒìŠ¤ ìì²´ëŠ” ì¬ìƒì„±ë˜ì§€ ì•ŠìŒ**
- ëŒ€ì‹  `kubectl view-secret`ë¡œ ë³´ë©´ **data(username/password)ë§Œ ê°±ì‹ **ë˜ëŠ” ê²ƒì„ í™•ì¸ ê°€ëŠ¥í•¨

**(12) (10ë¶„ ì •ë„ ì´í›„) 2ì°¨ K8S Secret í™•ì¸**

```bash
kubectl get secret -n demo-ns

NAME                  TYPE     DATA   AGE
vso-db-demo           Opaque   3      19m
vso-db-demo-created   Opaque   3      19m
```

```bash
kubectl view-secret -n demo-ns vso-db-demo --all

_raw='{"password":"SjlnS-5Gkcl24M42pUNl","username":"v-demo-aut-dev-post-Idi5jufqzLWK5XnGAhHw-1765625777"}'
password='SjlnS-5Gkcl24M42pUNl'
username='v-demo-aut-dev-post-Idi5jufqzLWK5XnGAhHw-1765625777'
```

- `AGE`ëŠ” ì¦ê°€í–ˆì§€ë§Œ ê·¸ëŒ€ë¡œì´ë¯€ë¡œ **Secret ì˜¤ë¸Œì íŠ¸ëŠ” ìœ ì§€**
- `username/password` ê°’ì´ ë°”ë€Œì–´ **ë™ì  credentialì´ rotate/renew ë˜ë©° ë™ê¸°í™”**ëœ ê²ƒì„ í™•ì¸í•¨

**(13) Secret ë³€ê²½ì— ë”°ë¥¸ Deployment Rollout ì´ë²¤íŠ¸ í™•ì¸**

```bash
kubectl describe deploy -n demo-ns
...
Events:
  Type    Reason             Age                    From                   Message
  ----    ------             ----                   ----                   -------
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled up replica set vso-db-demo-69848c8d56 from 0 to 3
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled up replica set vso-db-demo-6ccd6f964f from 0 to 1
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled down replica set vso-db-demo-69848c8d56 from 3 to 2
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled up replica set vso-db-demo-6ccd6f964f from 1 to 2
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled down replica set vso-db-demo-69848c8d56 from 2 to 1
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled up replica set vso-db-demo-6ccd6f964f from 2 to 3
  Normal  ScalingReplicaSet  20m                    deployment-controller  Scaled down replica set vso-db-demo-69848c8d56 from 1 to 0
  Normal  ScalingReplicaSet  5m50s                  deployment-controller  Scaled up replica set vso-db-demo-6647888d75 from 0 to 1
  Normal  ScalingReplicaSet  5m50s                  deployment-controller  Scaled down replica set vso-db-demo-6ccd6f964f from 3 to 2
  Normal  ScalingReplicaSet  5m50s                  deployment-controller  Scaled up replica set vso-db-demo-6647888d75 from 1 to 2
  Normal  ScalingReplicaSet  5m48s                  deployment-controller  Scaled down replica set vso-db-demo-6ccd6f964f from 2 to 1
  Normal  ScalingReplicaSet  5m48s                  deployment-controller  Scaled up replica set vso-db-demo-6647888d75 from 2 to 3
  Normal  ScalingReplicaSet  5m46s                  deployment-controller  Scaled down replica set vso-db-demo-6ccd6f964f from 1 to 0
  Normal  ScalingReplicaSet  5m46s                  deployment-controller  Scaled up replica set vso-db-demo-7f59964f7f from 0 to 1
  Normal  ScalingReplicaSet  5m46s                  deployment-controller  Scaled down replica set vso-db-demo-6647888d75 from 3 to 2
  Normal  ScalingReplicaSet  5m46s                  deployment-controller  Scaled up replica set vso-db-demo-7f59964f7f from 1 to 2
  Normal  ScalingReplicaSet  5m41s (x3 over 5m43s)  deployment-controller  (combined from similar events): Scaled down replica set vso-db-demo-6647888d75 from 1 to 0
```

- `VaultDynamicSecret`ì— `rolloutRestartTargets`ê°€ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ Secret ë³€ê²½ ì‹œ **Deployment rollout**ì´ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆìŒ
- `kubectl describe deploy` ì´ë²¤íŠ¸ì— ReplicaSet ìŠ¤ì¼€ì¼ ì—…/ë‹¤ìš´ ê¸°ë¡ì´ ë‚¨ìœ¼ë©°, **ì£¼ê¸°ì ìœ¼ë¡œ íŒŒë“œê°€ êµì²´**ë˜ëŠ” í˜•íƒœë¡œ ê´€ì°°ë¨

**(14) PostgreSQL ì‚¬ìš©ì ëª©ë¡ì´ ê³„ì† ì¶”ê°€ë˜ëŠ” í˜„ìƒ í™•ì¸**

```bash
kubectl exec -it -n postgres postgres-postgresql-0 -- sh -c "PGPASSWORD=secret-pass psql -U postgres -h localhost -c '\du'"

                                                  List of roles
                      Role name                      |                         Attributes                         
-----------------------------------------------------+------------------------------------------------------------
 postgres                                            | Superuser, Create role, Create DB, Replication, Bypass RLS
 v-demo-aut-dev-post-6LhL36PwSmznWj1G1W3p-1765624880 | Password valid until 2025-12-13 11:41:25+00
 v-demo-aut-dev-post-FONYSNU9cqRnEIoFdcJx-1765625773 | Password valid until 2025-12-13 11:53:26+00
 v-demo-aut-dev-post-Idi5jufqzLWK5XnGAhHw-1765625777 | Password valid until 2025-12-13 11:53:34+00
 v-demo-aut-dev-post-WEfwYsV05xPot7LzG2I1-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-XWri6OMU7jRRBFBBwM6d-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880 | Password valid until 2025-12-13 11:41:25+00
```

- ë™ì  Secretì´ ê°±ì‹ ë˜ë©´ì„œ ìƒˆë¡œìš´ DB ê³„ì •ì´ ë°œê¸‰ë˜ë©´ `\du` ëª©ë¡ì— **ìƒˆ roleì´ ì¶”ê°€**ë¨
- TTL(Password valid until) ê¸°ë°˜ì´ë¼ ì‹œê°„ì´ ì§€ë‚˜ë©´ revoke/ë§Œë£Œë¡œ ì •ë¦¬ë  ìˆ˜ ìˆìœ¼ë©°, ê°±ì‹  íƒ€ì´ë°ì— ë”°ë¼ ì¼ì‹œì ìœ¼ë¡œ ì—¬ëŸ¬ ê³„ì •ì´ ê³µì¡´í•  ìˆ˜ ìˆìŒ

**(15) Vaultì—ì„œ lease ì¡°íšŒ ë° íŠ¹ì • lease Revoke**

```bash
vault list sys/leases/lookup/demo-db/creds/dev-postgres

Keys
----
S3m1OjrPMiwZZeRE02tqx1M7
Xaqjiodg0P7Nq7l0DW6QhyE5
```

```bash
vault lease revoke demo-db/creds/dev-postgres/S3m1OjrPMiwZZeRE02tqx1M7
All revocation operations queued successfully!
```

```bash
vault list sys/leases/lookup/demo-db/creds/dev-postgres

Keys
----
Xaqjiodg0P7Nq7l0DW6QhyE5
```

- ë™ì  DB credentialì€ Vaultì—ì„œ **lease ë‹¨ìœ„ë¡œ ê´€ë¦¬**ë¨
- `sys/leases/lookup/...`ë¡œ í˜„ì¬ ë°œê¸‰ëœ lease key ëª©ë¡ì„ í™•ì¸ ê°€ëŠ¥
- íŠ¹ì • leaseë¥¼ `vault lease revoke`ë¡œ íšŒìˆ˜í•˜ë©´ í•´ë‹¹ credential(ê³„ì •/ê¶Œí•œ)ì´ ë§Œë£Œ/íšŒìˆ˜ ì²˜ë¦¬ë¨

**(16) Vault CLI(Token Auth)ë¡œ ë™ì  ê³„ì • ì§ì ‘ ë°œê¸‰ í™•ì¸**

```bash
vault read demo-db/creds/dev-postgres

Key                Value
---                -----
lease_id           demo-db/creds/dev-postgres/0W1x4enoQVQoooY7bvNEKnXh
lease_duration     10m
lease_renewable    true
password           uaC2Pr-iarcQhqpHT1Qz
username           v-token-dev-post-c9wsPVQpNe4YtfgKT9bv-1765626489
```

```bash
vault read demo-db/creds/dev-postgres

Key                Value
---                -----
lease_id           demo-db/creds/dev-postgres/iVaWodO61qpiWJnKMuPWE8Gu
lease_duration     10m
lease_renewable    true
password           DdEU-A1DfQ0HvNppK9qD
username           v-token-dev-post-PUuSunlUYypHV368CEAm-1765626491
```

```bash
kubectl exec -it -n postgres postgres-postgresql-0 -- sh -c "PGPASSWORD=secret-pass psql -U postgres -h localhost -c '\du'"

                                                  List of roles
                      Role name                      |                         Attributes                         
-----------------------------------------------------+------------------------------------------------------------
 postgres                                            | Superuser, Create role, Create DB, Replication, Bypass RLS
 v-demo-aut-dev-post-6LhL36PwSmznWj1G1W3p-1765624880 | Password valid until 2025-12-13 11:41:25+00
 v-demo-aut-dev-post-FONYSNU9cqRnEIoFdcJx-1765625773 | Password valid until 2025-12-13 11:53:26+00
 v-demo-aut-dev-post-Idi5jufqzLWK5XnGAhHw-1765625777 | Password valid until 2025-12-13 11:53:34+00
 v-demo-aut-dev-post-WEfwYsV05xPot7LzG2I1-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-XWri6OMU7jRRBFBBwM6d-1765624880 | Password valid until 2025-12-13 11:31:25+00
 v-demo-aut-dev-post-oDfUm4WPS5y7TgJAIleb-1765624880 | Password valid until 2025-12-13 11:41:25+00
 v-token-dev-post-PUuSunlUYypHV368CEAm-1765626491    | Password valid until 2025-12-13 11:58:16+00
 v-token-dev-post-c9wsPVQpNe4YtfgKT9bv-1765626489    | Password valid until 2025-12-13 11:58:14+00
```

- Kubernetes Authê°€ ì•„ë‹ˆë¼ **Vault CLI(Token Auth)** ë¡œë„ ë™ì¼ ê²½ë¡œë¥¼ ì½ìœ¼ë©´ ì¦‰ì‹œ ë™ì  ê³„ì •ì´ ë°œê¸‰ë¨
- ì¶œë ¥ì—ëŠ” `lease_id`, `lease_duration(10m)`, `lease_renewable(true)`, `username/password`ê°€ í¬í•¨ë¨
- ë°œê¸‰ëœ `v-token-*` ê³„ì •ì´ PostgreSQL `\du` ëª©ë¡ì— ì¶”ê°€ë˜ëŠ” ê²ƒìœ¼ë¡œ ê²€ì¦ ê°€ëŠ¥í•¨

**(17) Vault ë¡œê·¸ë¡œ lease revoke/ë§Œë£Œ ì²˜ë¦¬ í™•ì¸**

```bash
kubectl stern -n vault -l app.kubernetes.io/name=vault
...
vault-0 vault 2025-12-13T11:31:20.632Z [INFO]  expiration: revoked lease: lease_id=demo-db/creds/dev-postgres/JhbSLvzL9hxjT92Bzkxwkea0
vault-0 vault 2025-12-13T11:31:20.652Z [INFO]  expiration: revoked lease: lease_id=demo-db/creds/dev-postgres/KKiuAow8qVdUPoc4NWnuiUZR
vault-0 vault 2025-12-13T11:41:20.146Z [INFO]  expiration: revoked lease: lease_id=demo-db/creds/dev-postgres/fiTVX2vZs8wKD4YpMRELZOWm
vault-0 vault 2025-12-13T11:41:20.555Z [INFO]  expiration: revoked lease: lease_id=demo-db/creds/dev-postgres/mMgHV5K7pyIXiCTOOwqG3Ed8
vault-0 vault 2025-12-13T11:45:47.925Z [INFO]  expiration: revoked lease: lease_id=demo-db/creds/dev-postgres/S3m1OjrPMiwZZeRE02tqx1M7
```

- Vault ì„œë²„ ë¡œê·¸ì—ì„œ expiration ëª¨ë“ˆì´ lease ë§Œë£Œ ë˜ëŠ” revoke ì²˜ë¦¬ ì‹œì ì„ ê¸°ë¡í•¨
- `expiration: revoked lease: lease_id=...` ë¡œê·¸ê°€ ë³´ì´ë©´ **ë™ì  credential íšŒìˆ˜ ë™ì‘ì´ ì •ìƒ ìˆ˜í–‰**ëœ ê²ƒì„

---

## **ğŸ” PKI secret**

- **PKI secret**ì€ PKI ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ **ë™ì ìœ¼ë¡œ ë°œê¸‰/ê°±ì‹ ë˜ëŠ” ì¸ì¦ì„œ(ë° í‚¤)** ë¥¼ Vaultê°€ ê´€ë¦¬í•˜ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë³€ê²½ëœ ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ë°©ì‹ì„
- ì•„ë˜ëŠ” Vaultì—ì„œ **PKI secrets engine í™œì„±í™” â†’ Root CA ìƒì„± â†’ CA/CRL URL ì„¤ì • â†’ Role ìƒì„± â†’ PKI ì •ì±… ìƒì„±** íë¦„ ì •ë¦¬ì„
- [https://developer.hashicorp.com/vault/tutorials/archive/kubernetes-cert-manager](https://developer.hashicorp.com/vault/tutorials/archive/kubernetes-cert-manager)

### **1. ê¸°ë³¸ ì„¤ì •**

**(1) PKI Secrets Engine í™œì„±í™” ë° TTL íŠœë‹**

```bash
vault secrets enable pki

Success! Enabled the pki secrets engine at: pki/
```

```bash
vault secrets tune -max-lease-ttl=8760h pki

Success! Tuned the secrets engine at: pki/
```

- ê¸°ë³¸ path(`pki/`)ë¡œ PKI secrets engine í™œì„±í™”
- ê¸°ë³¸ TTLì€ 30ì¼ì´ë©°, max TTLì„ 8760h(1ë…„)ë¡œ í™•ì¥

**(2) Root CA ìƒì„± (internal)**

```bash
vault write pki/root/generate/internal \
    common_name=example.com \
    ttl=8760h
    
Key              Value
---              -----
certificate      -----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
expiration       1797162811
issuer_id        04f3933e-d15e-485a-a28c-fd98c1bf25e5
issuer_name      n/a
issuing_ca       -----BEGIN CERTIFICATE-----
...
-----END CERTIFICATE-----
key_id           8040af31-a02e-1aab-c018-4b2244baa886
key_name         n/a
serial_number    20:ea:c2:25:e7:31:72:7a:8a:b9:44:e5:a1:d5:da:5a:cf:c1:ec:c1
```

**(3) ìƒì„±ëœ ì¸ì¦ì„œ ë‚´ìš© í™•ì¸**

```bash
echo "-----BEGIN CERTIFICATE-----..." | openssl x509 -noout -text

# ê²°ê³¼
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            20:ea:c2:25:e7:31:72:7a:8a:b9:44:e5:a1:d5:da:5a:cf:c1:ec:c1
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=example.com
        Validity
            Not Before: Dec 13 11:53:01 2025 GMT
            Not After : Dec 13 11:53:31 2026 GMT
        Subject: CN=example.com
...
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Subject Key Identifier: 
                DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
            X509v3 Authority Key Identifier: 
                DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
            X509v3 Subject Alternative Name: 
                DNS:example.com
...
```
![](https://velog.velcdn.com/images/tlsalswls123/post/6e22f858-7b30-4909-95c8-f045141ec3b8/image.png)

**(4) CA/CRL URL ì„¤ì •**

```bash
vault write pki/config/urls \
    issuing_certificates="http://vault.vault.svc:8200/v1/pki/ca" \
    crl_distribution_points="http://vault.vault.svc:8200/v1/pki/crl"

Key                        Value
---                        -----
crl_distribution_points    [http://vault.vault.svc:8200/v1/pki/crl]
enable_templating          false
issuing_certificates       [http://vault.vault.svc:8200/v1/pki/ca]
ocsp_servers               []
```

```bash
vault read pki/config/urls

Key                        Value
---                        -----
crl_distribution_points    [http://vault.vault.svc:8200/v1/pki/crl]
enable_templating          false
issuing_certificates       [http://vault.vault.svc:8200/v1/pki/ca]
ocsp_servers               []
```

**(5) CA / CRL ë‹¤ìš´ë¡œë“œ ë° ê²€ì¦**

```bash
http://127.0.0.1:30000/v1/pki/ca
http://127.0.0.1:30000/v1/pki/crl
```
![](https://velog.velcdn.com/images/tlsalswls123/post/07a5110f-0382-4d45-93fd-5cefbbc4c37a/image.png)

- NodePort(ì˜ˆ: 30000)ë¡œ ë…¸ì¶œëœ Vaultì—ì„œ CA/CRL ë‚´ë ¤ë°›ì•„ í™•ì¸


- **ë‹¤ìš´ë¡œë“œí•œ CA í™•ì¸**

```bash
openssl x509 -noout -text -in ~/Downloads/ca.cer

Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            20:ea:c2:25:e7:31:72:7a:8a:b9:44:e5:a1:d5:da:5a:cf:c1:ec:c1
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=example.com
        Validity
            Not Before: Dec 13 11:53:01 2025 GMT
            Not After : Dec 13 11:53:31 2026 GMT
        Subject: CN=example.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:f9:76:ab:a1:83:83:6e:ce:fe:3e:16:a6:80:e4:
                    ec:c7:c6:ef:31:11:62:fd:5c:85:05:99:b3:9b:6d:
                    54:3c:7c:61:bd:31:f6:40:89:a1:70:85:ef:55:fb:
                    9d:24:43:87:f9:ea:0d:80:21:af:9f:7b:e3:8e:4f:
                    3a:92:63:10:65:e3:68:39:9d:3c:fc:aa:87:c1:0f:
                    27:3c:f4:ea:61:cd:c3:9e:60:03:47:36:c1:14:c7:
                    49:fc:25:7f:33:8a:5f:60:88:93:b9:50:8b:ce:0a:
                    d6:b1:7a:0c:ec:ca:c5:29:1c:dd:54:b5:ec:7b:f1:
                    bf:ba:60:5a:82:7c:d4:f2:a2:02:5b:66:4d:44:09:
                    6a:3d:9e:d4:f0:ab:60:c0:bb:b2:04:0e:8b:0f:3b:
                    c7:6b:df:7d:5f:86:f8:2b:1a:32:4e:5e:f9:a9:f6:
                    6d:1b:ca:dd:17:43:97:81:6f:1b:e0:4f:d4:34:15:
                    66:e5:f7:c4:3c:00:5a:c9:44:69:85:7e:44:42:a6:
                    71:cc:52:72:85:37:60:f4:8e:88:12:ff:06:ba:76:
                    f8:e8:db:ae:94:8a:38:fa:80:c4:c2:ce:5c:0e:53:
                    79:51:b1:30:10:22:d1:bb:ea:e4:17:dd:1a:8a:d8:
                    26:96:6e:e0:d8:ea:69:58:e5:5e:16:70:90:df:2e:
                    dd:e7
                Exponent: 65537 (0x10001)
        X509v3 extensions:
            X509v3 Key Usage: critical
                Certificate Sign, CRL Sign
            X509v3 Basic Constraints: critical
                CA:TRUE
            X509v3 Subject Key Identifier: 
                DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
            X509v3 Authority Key Identifier: 
                DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
            X509v3 Subject Alternative Name: 
                DNS:example.com
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        58:bf:56:42:35:3d:9b:e2:09:53:c6:c4:d0:6b:f7:49:68:b0:
        00:04:b9:80:22:ee:93:8a:95:14:fc:2e:8d:52:f9:09:f5:78:
        85:cc:9d:bd:e3:b5:59:26:fa:c5:6d:b7:22:97:2b:e3:94:19:
        93:1d:6f:8f:09:82:e3:9c:74:48:19:58:43:51:00:a9:b5:d9:
        8c:2d:6b:a5:16:66:cc:7e:e7:6f:71:4a:46:cc:38:66:7e:ba:
        29:6f:ae:a6:f7:b2:4c:62:05:9f:86:31:cc:5e:7b:1b:20:6a:
        f9:b6:31:c2:b4:ad:0c:29:e9:9c:5e:a7:77:74:18:8c:2d:a3:
        4d:ce:d6:18:62:28:7c:82:68:7f:db:e4:b0:67:4a:bf:df:ab:
        d4:a0:75:58:8c:6b:a0:ca:65:f0:89:80:f7:3f:1c:50:9d:63:
        b5:ff:41:46:64:26:06:6a:5f:50:a5:6b:b0:eb:78:2c:e8:46:
        84:4b:c0:34:b3:0e:74:bb:74:67:52:aa:77:a2:26:4a:70:ba:
        ee:c0:a4:75:ec:0a:54:11:08:a7:d9:23:51:5d:7b:f0:91:f8:
        56:4a:48:58:24:81:4f:3a:b3:8c:a8:c5:c4:57:1e:5d:55:35:
        87:cf:b3:3c:ab:54:15:cb:07:6f:f2:df:62:7f:b1:b8:37:7d:
        18:a6:be:e6
```


- **ë‹¤ìš´ë¡œë“œí•œ CRL í™•ì¸**

```bash
openssl crl -noout -text -in ~/Downloads/crl.crl

Certificate Revocation List (CRL):
    Version 2 (0x1)
    Signature Algorithm: sha256WithRSAEncryption
    Issuer: CN=example.com
    Last Update: Dec 13 11:53:31 2025 GMT
    Next Update: Dec 16 11:53:31 2025 GMT
    CRL extensions:
        X509v3 Authority Key Identifier: 
            DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
        X509v3 CRL Number: 
            1
No Revoked Certificates.
    Signature Algorithm: sha256WithRSAEncryption
    Signature Value:
        cc:d5:f9:19:20:05:bf:7f:ca:55:f5:1c:56:94:96:18:c3:2e:
        d2:5c:97:be:6f:a4:63:5b:37:bf:5e:13:c6:f8:da:6f:ca:fd:
        33:6c:ad:9e:7f:c0:b2:2d:74:47:d5:11:1b:ba:3b:87:da:9e:
        c7:73:7b:4b:5b:14:b8:a1:77:7b:ed:d5:5b:0d:71:44:aa:39:
        7f:79:de:56:aa:f2:3d:d1:87:a0:2e:1f:61:e4:52:8e:ce:e5:
        90:71:a0:91:da:1a:84:62:0f:6b:17:98:1b:8c:33:31:79:19:
        68:34:26:ac:cc:0f:4e:a3:66:d7:88:d6:fd:59:64:ac:8b:2a:
        fb:a8:5a:5a:28:85:67:5d:bd:1e:0e:ab:7a:67:5e:6c:c4:6a:
        3a:19:87:fe:0b:95:20:ca:0a:b0:c1:95:6c:8e:ae:5d:76:a2:
        07:cc:be:d6:d3:c2:99:78:dc:22:92:19:7e:17:a7:2e:8d:ca:
        7f:e1:59:b8:b3:0f:10:fe:72:74:29:0e:86:e7:4b:a8:56:d9:
        f7:e1:06:81:d8:82:18:92:ae:35:43:9f:f2:90:15:39:46:46:
        7a:00:bb:69:0f:b2:70:a1:e6:cd:fc:2c:76:2a:f7:40:09:46:
        93:25:76:a7:8e:25:13:86:bb:1f:24:ba:5d:ad:17:1e:16:e7:
        d8:9a:96:b7
```

**(6) PKI ì •ì±…(Policy) ìƒì„±**

```bash
vault write pki/roles/example-dot-com \
    allowed_domains=example.com \
    allow_subdomains=true \
    max_ttl=72h

Key                                   Value
---                                   -----
allow_any_name                        false
allow_bare_domains                    false
allow_glob_domains                    false
allow_ip_sans                         true
allow_localhost                       true
allow_subdomains                      true
allow_token_displayname               false
allow_wildcard_certificates           true
allowed_domains                       [example.com]
allowed_domains_template              false
allowed_other_sans                    []
allowed_serial_numbers                []
allowed_uri_sans                      []
allowed_uri_sans_template             false
allowed_user_ids                      []
basic_constraints_valid_for_non_ca    false
client_flag                           true
cn_validations                        [email hostname]
code_signing_flag                     false
country                               []
email_protection_flag                 false
enforce_hostnames                     true
ext_key_usage                         []
ext_key_usage_oids                    []
generate_lease                        false
issuer_ref                            default
key_bits                              2048
key_type                              rsa
key_usage                             [DigitalSignature KeyAgreement KeyEncipherment]
locality                              []
max_ttl                               72h
no_store                              false
not_after                             n/a
not_before_duration                   30s
organization                          []
ou                                    []
policy_identifiers                    []
postal_code                           []
province                              []
require_cn                            true
serial_number_source                  json-csr
server_flag                           true
signature_bits                        256
street_address                        []
ttl                                   0s
use_csr_common_name                   true
use_csr_sans                          true
use_pss                               false
```

```bash
vault policy write pki - <<EOF
path "pki*"                        { capabilities = ["read", "list"] }
path "pki/sign/example-dot-com"    { capabilities = ["create", "update"] }
path "pki/issue/example-dot-com"   { capabilities = ["create"] }
EOF

Success! Uploaded policy: pki
```

---

### **2. ë™ì‘ ì„¤ì • ë° í™•ì¸: Cert Manager í™œìš©**

**(1) Vault Kubernetes ì¸ì¦ í™œì„±í™” ë° Role ìƒì„±**

- **kubernetes auth í™œì„±í™”**

```bash
vault auth enable kubernetes

Success! Enabled kubernetes auth method at: kubernetes/
```

- **í´ëŸ¬ìŠ¤í„° API ì£¼ì†Œ ë“±ë¡**

```bash
vault write auth/kubernetes/config kubernetes_host="https://kubernetes.default.svc"

Success! Data written to: auth/kubernetes/config
```

- **cert-managerê°€ ì‚¬ìš©í•  role(issuer) ìƒì„±**

```bash
vault write auth/kubernetes/role/issuer \
    bound_service_account_names=issuer \
    bound_service_account_namespaces=default \
    policies=pki \
    ttl=20m

Success! Data written to: auth/kubernetes/role/issuer
```

**(2) cert-manager ì„¤ì¹˜**

- **CRD ì„¤ì¹˜**

```bash
kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.12.3/cert-manager.crds.yaml

customresourcedefinition.apiextensions.k8s.io/certificaterequests.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/certificates.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/challenges.acme.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/clusterissuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/issuers.cert-manager.io created
customresourcedefinition.apiextensions.k8s.io/orders.acme.cert-manager.io created
```

- **CRD í™•ì¸**

```bash
kubectl get crd | grep cert-manager

certificaterequests.cert-manager.io           2025-12-13T12:09:05Z
certificates.cert-manager.io                  2025-12-13T12:09:05Z
challenges.acme.cert-manager.io               2025-12-13T12:09:05Z
clusterissuers.cert-manager.io                2025-12-13T12:09:05Z
issuers.cert-manager.io                       2025-12-13T12:09:05Z
orders.acme.cert-manager.io                   2025-12-13T12:09:05Z
```

- **cert-manager namespace ìƒì„±**

```bash
kubectl create namespace cert-manager

namespace/cert-manager created
```

- **helm repo ì¶”ê°€ ë° ì„¤ì¹˜**

```bash
helm repo add jetstack https://charts.jetstack.io

"jetstack" has been added to your repositories
```

```bash
helm install cert-manager --namespace cert-manager --version v1.12.3 jetstack/cert-manager

NAME: cert-manager
LAST DEPLOYED: Sat Dec 13 21:10:32 2025
NAMESPACE: cert-manager
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
cert-manager v1.12.3 has been deployed successfully!

In order to begin issuing certificates, you will need to set up a ClusterIssuer
or Issuer resource (for example, by creating a 'letsencrypt-staging' issuer).

More information on the different types of issuers and how to configure them
can be found in our documentation:

https://cert-manager.io/docs/configuration/

For information on how to configure cert-manager to automatically provision
Certificates for Ingress resources, take a look at the `ingress-shim`
documentation:

https://cert-manager.io/docs/usage/ingress/
```

- **íŒŒë“œ í™•ì¸**

```bash
kubectl get pods --namespace cert-manager

NAME                                       READY   STATUS    RESTARTS   AGE
cert-manager-cainjector-74bf899bd6-l2lk6   1/1     Running   0          52s
cert-manager-fb6f6945f-j9vkk               1/1     Running   0          52s
cert-manager-webhook-8fc69bc68-w2zd5       1/1     Running   0          52s
```

**(3) Vault Issuer ì—°ë™ìš© ServiceAccount/Secret ì¤€ë¹„**

- **default namespaceì— `issuer` ServiceAccount ìƒì„±**

```bash
kubectl create serviceaccount issuer

serviceaccount/issuer created
```

- **ServiceAccount í† í° Secret ìƒì„±**

```bash
issuer-secret.yaml <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: issuer-token-lmzpj
  annotations:
    kubernetes.io/service-account.name: issuer
type: kubernetes.io/service-account-token
EOF
kubectl apply -f issuer-secret.yaml

secret/issuer-token-lmzpj created
```

- **Secret í™•ì¸**

```bash
kubectl get secrets

NAME                 TYPE                                  DATA   AGE
issuer-token-lmzpj   kubernetes.io/service-account-token   3      16s
```

- **Secret ì´ë¦„ì„ ë³€ìˆ˜ë¡œ ì €ì¥**

```bash
ISSUER_SECRET_REF=$(kubectl get secrets --output=json | jq -r '.items[].metadata | select(.name|startswith("issuer-token-")).name')
echo $ISSUER_SECRET_REF

issuer-token-lmzpj
```

- **í† í° ê°’ í™•ì¸**

```bash
kubectl view-secret $ISSUER_SECRET_REF --all

# ê²°ê³¼
ca.crt='-----BEGIN CERTIFICATE-----
MIIDBTCCAe2gAwIBAgIIfxU/3FwXtREwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE
AxMKa3ViZXJuZXRlczAeFw0yNTEyMTMxMDE5MzBaFw0zNTEyMTExMDI0MzBaMBUx
EzARBgNVBAMTCmt1YmVybmV0ZXMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQDjg1VcWK/9XVEMn7HstJClhmlZNYb123eC9vHcDHsk6MtZzAiFVTgizyRa
KYGtZZaUdGVKmVVIVs2r1Vj97X2V/votPHchZ9OJw7h9z/1TWjN3Le8QTwqtYHRm
v3PqaAj5wOUqc/0mUiDg+8icELgh0dXHsvOALNvb8HHgtBNQ2U91RICBgX7bTC8m
dM7fjjbi+FT73wjXXaTWn6dXlXn2LanYxG7eXb087FuFErFdweDPkbAAjVrwNhOz
e8wT7zT73R0seAqMFqckWRWoaufS4Ai+jBOvVhWILywyl1wmUJ5N64Lw22YWbBaA
z9TgZEOaPQ47E6Ay8jYs4OcK7GdjAgMBAAGjWTBXMA4GA1UdDwEB/wQEAwICpDAP
BgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBQZ8E41JXCiZlobPv8m8Phkd/68uTAV
BgNVHREEDjAMggprdWJlcm5ldGVzMA0GCSqGSIb3DQEBCwUAA4IBAQCoL+CRPjRM
rHYd+UoKVz1P8vQUshTKXDtlc/ZLALszKii61xFCQB9CdGklfvWLNmHA1tX+VtYE
BSno79xB74FnDJxaOl8y0kpt68ZmVNQoZcG0GdBV6/GKkTU2Zrm/y6vI2ncBrhFG
ueTt4fn0QLUjZQLEhWivEt2lpEjGTxYOa0u0IKhRenw1K2/mvIC2CvqFTJJF8lbZ
46PwWRdViL/0aSYS3Od8S7B0aaO/FemHpNjclExKB7XIOGlnIluVP+TFEbTjAlrf
kbU8yxrWrZgGMW1l1AFi/i9T+FKBy8XaNbZq/7+OrQE8wDEnjWM/PmIbmkDOxOim
D6SgjAxin2zW
-----END CERTIFICATE-----
'
namespace='default'
token='eyJhbGciOiJSUzI1NiIsImtpZCI6IklzeVpQdUIwc1Vod282R1lyZ0stZ2Z0aERfZ0dnS1lvTjY3Zng1ODg2bEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imlzc3Vlci10b2tlbi1sbXpwaiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJpc3N1ZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4ZDMzMjQzZi0yYzRlLTRiNDgtOGI1MC1kOGI4MTk4NzU2OWMiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDppc3N1ZXIifQ.grg9Eqzj7A_MhWmb3y90_xdlGBUKIaLYJc7mZVw10vtTt0P00495lc6HtxS2IupEIw2-QovWIHPJeU3PQ4qhy_asCeWAjAWDyeYH0NqzIHgkLzDCfN_knPceH5fPqwL6E_tM2B2HBswnFL_hBgxeDrPO4MZ3bKCycoflIcNB2K4-3hLz-Iv5_eNuGXSAvfHheSTybviV5_ikkF6yR2cHE78DmhWKRBcHjONsu7A69wh-ZJdzuOpcp9ayjZmv3rqAiLsE9o_HoE6IlC0gWK9HQN9BvMR2gXmcZtTOFF-v50IWEgzmSyD93k1uloH-8JzQovk9RnnSGnbcpVyq0Ysirw'
```

**(4) cert-manager Issuer ìƒì„± (Vaultë¥¼ Issuerë¡œ ì‚¬ìš©)**

- Vaultë¥¼ ì¸ì¦ì„œ ë°œê¸‰ì(Issuer)ë¡œ ì„¤ì •

```bash
cat > vault-issuer.yaml <<EOF
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: vault-issuer
  namespace: default
spec:
  vault:
    server: http://vault.vault.svc:8200
    path: pki/sign/example-dot-com
    auth:
      kubernetes:
        mountPath: /v1/auth/kubernetes
        role: issuer
        secretRef:
          name: $ISSUER_SECRET_REF
          key: token
EOF
```

```bash
kubectl apply --filename vault-issuer.yaml

issuer.cert-manager.io/vault-issuer created
```

- **Issuer ìƒíƒœ í™•ì¸**

```bash
kubectl get issuer.cert-manager.io/vault-issuer

NAME           READY   AGE
vault-issuer   True    15s
```

**(5) Certificate ìƒì„± ë° ë°œê¸‰ í™•ì¸**

- Certificate ë¦¬ì†ŒìŠ¤ ìƒì„±

```bash
cat > example-com-cert.yaml <<EOF
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: example-com
  namespace: default
spec:
  secretName: $ISSUER_SECRET_REF
  issuerRef:
    name: vault-issuer
  commonName: www.example.com
  dnsNames:
  - www.example.com
EOF
```

```bash
kubectl apply --filename example-com-cert.yaml

certificate.cert-manager.io/example-com created
```

- **Certificate ìƒíƒœ í™•ì¸**

```bash
kubectl get certificate.cert-manager.io/example-com -owide

NAME          READY   SECRET               ISSUER         STATUS                                          AGE
example-com   True    issuer-token-lmzpj   vault-issuer   Certificate is up to date and has not expired   13s
```

- **Certificate ì´ë²¤íŠ¸ í™•ì¸ (í‚¤ ìƒì„± â†’ CSR â†’ ë°œê¸‰)**

```bash
kubectl describe certificate.cert-manager example-com

...
Events:
  Type    Reason     Age   From                                       Message
  ----    ------     ----  ----                                       -------
  Normal  Issuing    40s   cert-manager-certificates-trigger          Issuing certificate as Secret does not contain a private key
  Normal  Generated  39s   cert-manager-certificates-key-manager      Stored new private key in temporary Secret resource "example-com-jssf2"
  Normal  Requested  39s   cert-manager-certificates-request-manager  Created new CertificateRequest resource "example-com-74gk6"
  Normal  Issuing    39s   cert-manager-certificates-issuing          The certificate has been successfully issued
```

- **CertificateRequest í™•ì¸**

```bash
kubectl get certificaterequests.cert-manager.io -owide

NAME                APPROVED   DENIED   READY   ISSUER         REQUESTOR                                         STATUS                                         AGE
example-com-74gk6   True                True    vault-issuer   system:serviceaccount:cert-manager:cert-manager   Certificate fetched from issuer successfully   113s
```

**(6) ë°œê¸‰ëœ Secret(tls.crt/tls.key) í™•ì¸ ë° openssl ê²€ì¦**

- **Secret í™•ì¸**

```bash
kubectl view-secret $ISSUER_SECRET_REF --all

ca.crt='-----BEGIN CERTIFICATE-----
MIIDBTCCAe2gAwIBAgIIfxU/3FwXtREwDQYJKoZIhvcNAQELBQAwFTETMBEGA1UE
AxMKa3ViZXJuZXRlczAeFw0yNTEyMTMxMDE5MzBaFw0zNTEyMTExMDI0MzBaMBUx
EzARBgNVBAMTCmt1YmVybmV0ZXMwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEK
AoIBAQDjg1VcWK/9XVEMn7HstJClhmlZNYb123eC9vHcDHsk6MtZzAiFVTgizyRa
KYGtZZaUdGVKmVVIVs2r1Vj97X2V/votPHchZ9OJw7h9z/1TWjN3Le8QTwqtYHRm
v3PqaAj5wOUqc/0mUiDg+8icELgh0dXHsvOALNvb8HHgtBNQ2U91RICBgX7bTC8m
dM7fjjbi+FT73wjXXaTWn6dXlXn2LanYxG7eXb087FuFErFdweDPkbAAjVrwNhOz
e8wT7zT73R0seAqMFqckWRWoaufS4Ai+jBOvVhWILywyl1wmUJ5N64Lw22YWbBaA
z9TgZEOaPQ47E6Ay8jYs4OcK7GdjAgMBAAGjWTBXMA4GA1UdDwEB/wQEAwICpDAP
BgNVHRMBAf8EBTADAQH/MB0GA1UdDgQWBBQZ8E41JXCiZlobPv8m8Phkd/68uTAV
BgNVHREEDjAMggprdWJlcm5ldGVzMA0GCSqGSIb3DQEBCwUAA4IBAQCoL+CRPjRM
rHYd+UoKVz1P8vQUshTKXDtlc/ZLALszKii61xFCQB9CdGklfvWLNmHA1tX+VtYE
BSno79xB74FnDJxaOl8y0kpt68ZmVNQoZcG0GdBV6/GKkTU2Zrm/y6vI2ncBrhFG
ueTt4fn0QLUjZQLEhWivEt2lpEjGTxYOa0u0IKhRenw1K2/mvIC2CvqFTJJF8lbZ
46PwWRdViL/0aSYS3Od8S7B0aaO/FemHpNjclExKB7XIOGlnIluVP+TFEbTjAlrf
kbU8yxrWrZgGMW1l1AFi/i9T+FKBy8XaNbZq/7+OrQE8wDEnjWM/PmIbmkDOxOim
D6SgjAxin2zW
-----END CERTIFICATE-----
'
namespace='default'
tls.crt='-----BEGIN CERTIFICATE-----
MIIDyzCCArOgAwIBAgIUGYZhNBEaUjfiQ42aZ1tIE0bln84wDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLZXhhbXBsZS5jb20wHhcNMjUxMjEzMTIxNjM2WhcNMjUx
MjE2MTIxNzA2WjAaMRgwFgYDVQQDEw93d3cuZXhhbXBsZS5jb20wggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCv6Qmc2HmM3QV2i2SoGMaEBJqvIVZ3rNPA
/LNHLNO1+JwExFy0JV+w4ouMG7w8dg3Ilf3yK0I8lBzodBwdpAyuyMK3eIgg7UPr
HD5ANyVu/yDXxQsDANlcRCHyxLWyuu08yICm8HZCT/OfrxlvNNMJ3mkqEyBo7gK+
VEVsGREFNsOp9MT/1eeMUN6AXTLblKNTYl0EUAi3UImk6o3jZ+qO4x7lXfWiGbCb
c9t0vEi7TG+8MmICocRER9jVNMYRm6HkuGQwqAZ+/uC5qa3e0LdEr6VFbc3jJgxB
vzIbA3aJQXx1s3J8K2tfDL3QWzAcmI8s0GYfDbRs+V/n4DzQkgWhAgMBAAGjggEL
MIIBBzAOBgNVHQ8BAf8EBAMCA6gwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUF
BwMCMB0GA1UdDgQWBBT2re+Vd3AJeaFXebDlvBBgMjrwVDAfBgNVHSMEGDAWgBTe
BCayLtlZta4oYBB8lwOO5m/JljBBBggrBgEFBQcBAQQ1MDMwMQYIKwYBBQUHMAKG
JWh0dHA6Ly92YXVsdC52YXVsdC5zdmM6ODIwMC92MS9wa2kvY2EwGgYDVR0RBBMw
EYIPd3d3LmV4YW1wbGUuY29tMDcGA1UdHwQwMC4wLKAqoCiGJmh0dHA6Ly92YXVs
dC52YXVsdC5zdmM6ODIwMC92MS9wa2kvY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQDm
N4ZzE3wvpNmHwxrKkZ6A+3t1QSlA7csDkpBBTX707y932CComZsP/UmgGph8GBVX
GD1iCeyRzG/XOE1+tbt0L+87VZyiJD6CE/KSBPlgNLTZQJLCR3We4aP6/Lc44LOY
RzTF71DmrOgzkHm6E47QjpZAL2kVnxFg5VaKiuByL7iH5W0tRabRVW4LBcfBtdqt
4T1Ook1WvniDnNjAhGX7widDpn9rceip4nDLrS2jnKpIFnfS7BHRjLV62UjiqOWW
J56X+fAIFQCpXATJttQ0kZx220M1k8KIDOLzSBHekAMhpBsYfnR7K+YrmNlfDPQg
faUoz1JIyEBz5ux1D/5q
-----END CERTIFICATE-----
'
tls.key='-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAr+kJnNh5jN0FdotkqBjGhASaryFWd6zTwPyzRyzTtficBMRc
tCVfsOKLjBu8PHYNyJX98itCPJQc6HQcHaQMrsjCt3iIIO1D6xw+QDclbv8g18UL
AwDZXEQh8sS1srrtPMiApvB2Qk/zn68ZbzTTCd5pKhMgaO4CvlRFbBkRBTbDqfTE
/9XnjFDegF0y25SjU2JdBFAIt1CJpOqN42fqjuMe5V31ohmwm3PbdLxIu0xvvDJi
AqHEREfY1TTGEZuh5LhkMKgGfv7guamt3tC3RK+lRW3N4yYMQb8yGwN2iUF8dbNy
fCtrXwy90FswHJiPLNBmHw20bPlf5+A80JIFoQIDAQABAoIBAQCW4ib5noBbv7SQ
4q1ata2IzT40mz7EdbxHmzjXAu8w9WY1fIwbhLcYTKjva1bA8W2PMIBaeJpexZgq
FnWLQwwR22eQ4VS6EWkhP99xSxvTogf0qzFvyQmnZ1VLG0jSXh1g9oXLKxP0ewl3
XUROq5ucqmW/zhoNhqFZyYSmXLXJpqrKzIAFOa6A+4gNyOtP2xJMvLP3wqLX4ZBn
JYVfmH+g5EykXdfhLEB2zUDlWhsHBGXxf4Ka3wfnzKZxNPJqbMwSpIizG+j7lkzh
9X1aMsxMC+7jDYNQDJyPoANC+CMJBeZtnGxWwW4itFFMCIJjrlTmiP7XeBO6EXO2
f++tAoUlAoGBAMBGVZl9uGL0zHNNZtT7TlClHETRyfJgTP4NRdYT+iFN7XWg4Wha
vnVNunTRC2k1nXMLzIAO4Fz4boFFsvNclCi3Gz6I6yCVWbg9toqZmIDK2uUo0ZVL
oaw+7MLnBOTL1u1mJE6eJlZrLYG8opt3eBsF56dGRwzTSg/CfU2PplJ7AoGBAOo2
QJ5QYZpigd5HqAbJ9l7QUyleaLE7WIYL+VAO3j6GV312jVr7rPYYOCSiTUlov9Zi
iyAqAXLsdxqzPKOItSkASeMpjxxWJ5FBOQ0Oj31wTq/btAq7552ICBUQUf3MjMIT
/tpCKBb6hNlspA2pEmf9E1tHOiQyCqkMBre5wiuTAoGBAJKiEQ3prwDoqDMWyGGM
9gDSqmhhhZ1ui8kD3kqRGaTkhT+73atz6OQUzynfctBdryHZ0a+nqLu+SqgTu5GU
/PjAC+r5CDflLnMvvVKeKIuwKJezNYKiFz4BDxbkj/rc6aBK0U2TlrE5M49JiMj/
p30UV8Jd+jlxuX2jWWQZNUKZAoGBAIC4BFd9scaZcOpq00u333FIaQwJWNxe004I
cqKvKTGPv7GyYAmq2+n8cY6grH011ojKa8/nhhhVIThJXYA69+VqxTDVfFOEfgZ0
pBgq8m1sNbKsuoxTrP2E73w0Ffu4WXuoZZ4qUcIfOLgN3zOqwfTov6SgxrFx1y4E
8AQ1USOFAoGAUT8xzqCFrOkRRgXu+dqLkGYCg7q4xA+n9TNMQqqCKks4TnJstfKt
LiSut9pjN+yKE8WbhPLXJfDMs/y3W6l9Abgip228E39wIiZ4c5Hwj6xueGjx189A
fzQbCzBHwqLze46tnYnxGjJjo55tcUaLg6dv5gt5XUNHTjs/rtLTf5I=
-----END RSA PRIVATE KEY-----
'
token='eyJhbGciOiJSUzI1NiIsImtpZCI6IklzeVpQdUIwc1Vod282R1lyZ0stZ2Z0aERfZ0dnS1lvTjY3Zng1ODg2bEUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6Imlzc3Vlci10b2tlbi1sbXpwaiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJpc3N1ZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI4ZDMzMjQzZi0yYzRlLTRiNDgtOGI1MC1kOGI4MTk4NzU2OWMiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDppc3N1ZXIifQ.grg9Eqzj7A_MhWmb3y90_xdlGBUKIaLYJc7mZVw10vtTt0P00495lc6HtxS2IupEIw2-QovWIHPJeU3PQ4qhy_asCeWAjAWDyeYH0NqzIHgkLzDCfN_knPceH5fPqwL6E_tM2B2HBswnFL_hBgxeDrPO4MZ3bKCycoflIcNB2K4-3hLz-Iv5_eNuGXSAvfHheSTybviV5_ikkF6yR2cHE78DmhWKRBcHjONsu7A69wh-ZJdzuOpcp9ayjZmv3rqAiLsE9o_HoE6IlC0gWK9HQN9BvMR2gXmcZtTOFF-v50IWEgzmSyD93k1uloH-8JzQovk9RnnSGnbcpVyq0Ysirw'
```

- `tls.crt`, `tls.key` ê°€ ì¶”ê°€ë˜ì–´ **TLS Secret í˜•íƒœë¡œ í™•ì¥ë¨**
- ê¸°ì¡´ `token`/`ca.crt` ì™€ í•¨ê»˜ ë“¤ì–´ìˆëŠ” ìƒíƒœë¡œ í™•ì¸ë¨

- **ë°œê¸‰ëœ ì¸ì¦ì„œ í™•ì¸**

```bash
echo "-----BEGIN CERTIFICATE-----
MIIDyzCCArOgAwIBAgIUGYZhNBEaUjfiQ42aZ1tIE0bln84wDQYJKoZIhvcNAQEL
BQAwFjEUMBIGA1UEAxMLZXhhbXBsZS5jb20wHhcNMjUxMjEzMTIxNjM2WhcNMjUx
MjE2MTIxNzA2WjAaMRgwFgYDVQQDEw93d3cuZXhhbXBsZS5jb20wggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCv6Qmc2HmM3QV2i2SoGMaEBJqvIVZ3rNPA
/LNHLNO1+JwExFy0JV+w4ouMG7w8dg3Ilf3yK0I8lBzodBwdpAyuyMK3eIgg7UPr
HD5ANyVu/yDXxQsDANlcRCHyxLWyuu08yICm8HZCT/OfrxlvNNMJ3mkqEyBo7gK+
VEVsGREFNsOp9MT/1eeMUN6AXTLblKNTYl0EUAi3UImk6o3jZ+qO4x7lXfWiGbCb
c9t0vEi7TG+8MmICocRER9jVNMYRm6HkuGQwqAZ+/uC5qa3e0LdEr6VFbc3jJgxB
vzIbA3aJQXx1s3J8K2tfDL3QWzAcmI8s0GYfDbRs+V/n4DzQkgWhAgMBAAGjggEL
MIIBBzAOBgNVHQ8BAf8EBAMCA6gwHQYDVR0lBBYwFAYIKwYBBQUHAwEGCCsGAQUF
BwMCMB0GA1UdDgQWBBT2re+Vd3AJeaFXebDlvBBgMjrwVDAfBgNVHSMEGDAWgBTe
BCayLtlZta4oYBB8lwOO5m/JljBBBggrBgEFBQcBAQQ1MDMwMQYIKwYBBQUHMAKG
JWh0dHA6Ly92YXVsdC52YXVsdC5zdmM6ODIwMC92MS9wa2kvY2EwGgYDVR0RBBMw
EYIPd3d3LmV4YW1wbGUuY29tMDcGA1UdHwQwMC4wLKAqoCiGJmh0dHA6Ly92YXVs
dC52YXVsdC5zdmM6ODIwMC92MS9wa2kvY3JsMA0GCSqGSIb3DQEBCwUAA4IBAQDm
N4ZzE3wvpNmHwxrKkZ6A+3t1QSlA7csDkpBBTX707y932CComZsP/UmgGph8GBVX
GD1iCeyRzG/XOE1+tbt0L+87VZyiJD6CE/KSBPlgNLTZQJLCR3We4aP6/Lc44LOY
RzTF71DmrOgzkHm6E47QjpZAL2kVnxFg5VaKiuByL7iH5W0tRabRVW4LBcfBtdqt
4T1Ook1WvniDnNjAhGX7widDpn9rceip4nDLrS2jnKpIFnfS7BHRjLV62UjiqOWW
J56X+fAIFQCpXATJttQ0kZx220M1k8KIDOLzSBHekAMhpBsYfnR7K+YrmNlfDPQg
faUoz1JIyEBz5ux1D/5q
-----END CERTIFICATE-----" | openssl x509 -noout -text

# ê²°ê³¼
...
        Version: 3 (0x2)
        Serial Number:
            19:86:61:34:11:1a:52:37:e2:43:8d:9a:67:5b:48:13:46:e5:9f:ce
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=example.com
        Validity
            Not Before: Dec 13 12:16:36 2025 GMT
            Not After : Dec 16 12:17:06 2025 GMT
        Subject: CN=www.example.com
        ...
        X509v3 extensions:
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment, Key Agreement
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication, TLS Web Client Authentication
            X509v3 Subject Key Identifier: 
                F6:AD:EF:95:77:70:09:79:A1:57:79:B0:E5:BC:10:60:32:3A:F0:54
            X509v3 Authority Key Identifier: 
                DE:04:26:B2:2E:D9:59:B5:AE:28:60:10:7C:97:03:8E:E6:6F:C9:96
            Authority Information Access: 
                CA Issuers - URI:http://vault.vault.svc:8200/v1/pki/ca
            X509v3 Subject Alternative Name: 
                DNS:www.example.com
            X509v3 CRL Distribution Points: 
                Full Name:
                  URI:http://vault.vault.svc:8200/v1/pki/crl
...
```
![](https://velog.velcdn.com/images/tlsalswls123/post/0b808f22-9930-4207-ac55-cca8b8a81ded/image.png)

**(7) ì‹¤ìŠµ í™˜ê²½ ì‚­ì œ**

```bash
kind delete cluster --name myk8s

Deleting cluster "myk8s" ...
Deleted nodes: ["myk8s-control-plane"]
```

---

## **ğŸ“ˆ Vault HA**

### **1. kind í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    ingress-ready: true
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
- role: worker
- role: worker
- role: worker
EOF
```

- control-plane 1 + worker 3 êµ¬ì„±
- ingress-nginx ì‚¬ìš©ì„ ìœ„í•´ 80/443 í¬íŠ¸ ë§¤í•‘
- Vault UI NodePort(30000) ë“± ì¶”ê°€ í¬íŠ¸ ë§¤í•‘

### **2. Vault HA(Raft) ë°°í¬ (Helm)**

- [https://artifacthub.io/packages/helm/hashicorp/vault](https://artifacthub.io/packages/helm/hashicorp/vault)

**(1) Vault ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±**

```bash
kubectl create ns vault

namespace/vault created
```

**(2) HA values íŒŒì¼ ì‘ì„±**

```bash
cat << EOF > values-ha.yaml
server:
  replicas: 3

  # Vault HA mode
  ha:
    enabled: true
    replicas: 3
    raft:
      enabled: true
    config: |
      ui = true
      listener "tcp" {
        tls_disable = 1                           # TLS ë°”í™œì„±í™”
        address = "[::]:8200"                     # ëª¨ë“  IPv6 ì£¼ì†Œì—ì„œ 8200 í¬íŠ¸ ìˆ˜ì‹ 
        cluster_address = "[::]:8201"             # í´ëŸ¬ìŠ¤í„° í†µì‹  í¬íŠ¸
      }

      service_registration "kubernetes" {}        # Kubernetes ì„œë¹„ìŠ¤ ë“±ë¡ í™œì„±í™”

  readinessProbe:
    enabled: true

  # PVC for Raft storage
  dataStorage:
    enabled: true
    size: 10Gi

  service:
    enabled: true
    type: ClusterIP
    port: 8200
    targetPort: 8200

ui:
  enabled: true
  serviceType: "NodePort"
  externalPort: 8200
  serviceNodePort: 30000

injector:
  enabled: false
EOF
```

**(3) Helm ì„¤ì¹˜**

```bash
helm install vault hashicorp/vault -n vault -f values-ha.yaml --version 0.31.0

NAME: vault
LAST DEPLOYED: Sat Dec 13 21:31:25 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

**(4) íŒŒë“œ í™•ì¸ (ì´ˆê¸°ì—ëŠ” sealed ìƒíƒœë¡œ READY 0/1)**

```bash
kubectl get pods --selector='app.kubernetes.io/name=vault' -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   0/1     Running   0          54s
vault-1   0/1     Running   0          54s
vault-2   0/1     Running   0          54s
```

**(5) PVC/PV í™•ì¸ (Raft ì €ì¥ì†Œ)**

```bash
kubectl get pvc,pv -n vault

NAME                                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-vault-0   Bound    pvc-e26f3651-acbc-487d-9912-a6689e37be54   10Gi       RWO            standard       <unset>                 79s
persistentvolumeclaim/data-vault-1   Bound    pvc-2b8ff3ff-00f2-4608-9aae-deb4c3466146   10Gi       RWO            standard       <unset>                 79s
persistentvolumeclaim/data-vault-2   Bound    pvc-87b1459a-57fa-418a-a9db-c9e38c562c2a   10Gi       RWO            standard       <unset>                 79s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-2b8ff3ff-00f2-4608-9aae-deb4c3466146   10Gi       RWO            Delete           Bound    vault/data-vault-1   standard       <unset>                          75s
persistentvolume/pvc-87b1459a-57fa-418a-a9db-c9e38c562c2a   10Gi       RWO            Delete           Bound    vault/data-vault-2   standard       <unset>                          74s
persistentvolume/pvc-e26f3651-acbc-487d-9912-a6689e37be54   10Gi       RWO            Delete           Bound    vault/data-vault-0   standard       <unset>                          74s
```

**(6) ë¡œê·¸ í™•ì¸**

```bash
kubectl stern -n vault vault-0

vault-0 vault 2025-12-13T12:32:14.261Z [INFO]  proxy environment: http_proxy="" https_proxy="" no_proxy=""
vault-0 vault 2025-12-13T12:32:14.303Z [INFO]  incrementing seal generation: generation=1
vault-0 vault 2025-12-13T12:32:14.304Z [INFO]  core: Initializing version history cache for core
vault-0 vault 2025-12-13T12:32:14.304Z [INFO]  events: Starting event system
vault-0 vault 2025-12-13T12:32:21.224Z [INFO]  core: security barrier not initialized
vault-0 vault 2025-12-13T12:32:21.224Z [INFO]  core: seal configuration missing, not initialized
...
```

### **3. Vault ì´ˆê¸°í™”(Init) ë° Unseal**

**(1) vault-0ì—ì„œ init ìˆ˜í–‰**

```bash
kubectl exec -it vault-0 -n vault -- sh
/ $ vault operator init

# ê²°ê³¼
Unseal Key 1: xQJkGsv1g56rQSudtzSxdNb+muak/+pUxFN6b3qebebx
Unseal Key 2: dH7qGm95bZ1e85HHwNuM7Kn1o+eRzNbl4OugM057Xozk
Unseal Key 3: NJ4x0W1Ej/8zhL47FttZBZ5eOrgB11f5vYpgrqvFRWW8
Unseal Key 4: icUHy7ZeA3xd9qJDdnm23GqLCNfkBAINlPK4PTMllnG9
Unseal Key 5: ZH3QQ2M5iHmC3HQV3zKPYeHqTpGka/eEqyc/LF8i+aRi

Initial Root Token: hvs.xxxxxxxxxxxxxxxxxxxxxxxx

Vault initialized with 5 key shares and a key threshold of 3. Please securely
distribute the key shares printed above. When the Vault is re-sealed,
restarted, or stopped, you must supply at least 3 of these keys to unseal it
before it can start servicing requests.

Vault does not store the generated root key. Without at least 3 keys to
reconstruct the root key, Vault will remain permanently sealed!

It is possible to generate new unseal keys, provided you have a quorum of
existing unseal keys shares. See "vault operator rekey" for more information.
```

- 5ê°œ key share, threshold 3
- Root Token ìƒì„±

**(2) ì´ˆê¸° ìƒíƒœ í™•ì¸ (Initialized true, Sealed true)**

```bash
/ $ vault status

Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  true
Total Shares            5
Threshold               3
Unseal Progress         0/3
Unseal Nonce            n/a
Version                 1.20.4
Build Date              2025-09-23T13:22:38Z
Storage Type            raft
Removed From Cluster    false
HA Enabled              true
```

**(3) Unseal key 3ê°œ ì…ë ¥ í›„ sealed í•´ì œ**

```bash
/ $ vault operator unseal

Unseal Key (will be hidden): xQJkGsv1g56rQSudtzSxdNb+muak/+pUxFN6b3qebebx
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  true
Total Shares            5
Threshold               3
Unseal Progress         1/3
Unseal Nonce            47c5ba3e-67b2-fec0-aad5-75dce91a47ba
Version                 1.20.4
Build Date              2025-09-23T13:22:38Z
Storage Type            raft
Removed From Cluster    false
HA Enabled              true
```

```bash
/ $ vault operator unseal
Unseal Key (will be hidden): dH7qGm95bZ1e85HHwNuM7Kn1o+eRzNbl4OugM057Xozk
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  true
Total Shares            5
Threshold               3
Unseal Progress         2/3
Unseal Nonce            47c5ba3e-67b2-fec0-aad5-75dce91a47ba
Version                 1.20.4
Build Date              2025-09-23T13:22:38Z
Storage Type            raft
Removed From Cluster    false
HA Enabled              true
```

```bash
/ $ vault operator unseal
Unseal Key (will be hidden): NJ4x0W1Ej/8zhL47FttZBZ5eOrgB11f5vYpgrqvFRWW8
Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
Total Shares            5
Threshold               3
Version                 1.20.4
Build Date              2025-09-23T13:22:38Z
Storage Type            raft
Cluster Name            vault-cluster-3a0a246b
Cluster ID              043fc090-6a7c-9198-a998-786196e8b66b
Removed From Cluster    false
HA Enabled              true
HA Cluster              https://vault-0.vault-internal:8201
HA Mode                 active
Active Since            2025-12-13T12:38:01.768089484Z
Raft Committed Index    37
Raft Applied Index      37

/ $ exit
```

- threshold(3) ì¶©ì¡± ì‹œ `Sealed: false`
- HA Modeê°€ `active` ë¡œ í‘œì‹œë¨

```bash
kubectl get pods --selector='app.kubernetes.io/name=vault' -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          8m12s
vault-1   0/1     Running   0          8m12s
vault-2   0/1     Running   0          8m12s
```

### **4. Raft Join + ë‚˜ë¨¸ì§€ ë…¸ë“œ Unseal**

**(1) vault-1, vault-2ë¥¼ raft clusterì— join**

```bash
kubectl exec -n vault -it vault-1 -- vault operator raft join http://vault-0.vault-internal:8200

Key       Value
---       -----
Joined    true
```

```bash
kubectl exec -n vault -it vault-2 -- vault operator raft join http://vault-0.vault-internal:8200

Key       Value
---       -----
Joined    true
```

**(2) vault-0ì—ì„œ root token ë¡œê·¸ì¸**

```bash
kubectl exec -it vault-0 -n vault -- sh

/ $ vault login
Token (will be hidden): hvs.xxxxxxxxxxxxxxxxxxxxxxxx
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor       MAW2uNjALwZpAnu7tOBBjTBJ
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

**ì•„ì§ ë¦¬ë” í•˜ë‚˜ë§Œ ì¡´ì¬**

```bash
/ $ vault operator raft list-peers

Node                                    Address                        State     Voter
----                                    -------                        -----     -----
3af25dff-1555-27bf-7f59-cbd55aa89448    vault-0.vault-internal:8201    leader    true

/ $ exit
```

**(3) joinë§Œìœ¼ë¡œëŠ” follower íŒŒë“œê°€ sealed ìƒíƒœì´ë¯€ë¡œ, vault-1/2 ê°ê° unseal í•„ìš”**

```bash
kubectl exec -it vault-1 -n vault -- sh

---------------------------------------
vault status
vault operator unseal
vault operator unseal
vault operator unseal
vault status
exit
---------------------------------------
```

```bash
kubectl get pods --selector='app.kubernetes.io/name=vault' -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          15m
vault-1   1/1     Running   0          15m
vault-2   0/1     Running   0          15m
```

```bash
kubectl exec -it vault-2 -n vault -- sh

---------------------------------------
vault status
vault operator unseal
vault operator unseal
vault operator unseal
vault status
exit
---------------------------------------
```

```bash
kubectl get pods --selector='app.kubernetes.io/name=vault' -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   1/1     Running   0          17m
vault-1   1/1     Running   0          17m
vault-2   1/1     Running   0          17m
```

- 3ê°œ ëª¨ë‘ READY 1/1 í™•ì¸

### **5. ë¡œì»¬ì—ì„œ UI(NodePort)ë¡œ Vault ì ‘ì† ë° Peer í™•ì¸**

**(1) í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (NodePort 30000)**

```bash
export VAULT_ROOT_TOKEN=hvs.xxxxxxxxxxxxxxxxxxxxxxxx
export VAULT_ADDR='http://localhost:30000'
```

**(2) ë¡œê·¸ì¸**

```bash
vault login
Token (will be hidden): hvs.xxxxxxxxxxxxxxxxxxxxxxxx
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor       MAW2uNjALwZpAnu7tOBBjTBJ
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

**(3) raft peers í™•ì¸ (leader 1 + follower 2)**

```bash
vault operator raft list-peers

Node                                    Address                        State       Voter
----                                    -------                        -----       -----
3af25dff-1555-27bf-7f59-cbd55aa89448    vault-0.vault-internal:8201    leader      true
d7c30a24-4f01-b4ce-6752-b8dbf3e43e06    vault-1.vault-internal:8201    follower    true
a42215a1-ae84-cb7a-e981-33f720810d9e    vault-2.vault-internal:8201    follower    true
```

### **6. KV v2 ì‹œí¬ë¦¿ ì—”ì§„ í™œì„±í™” ë° ë°ì´í„° ì €ì¥/ì¡°íšŒ**

**(1) KV v2 í™œì„±í™”**

```bash
vault secrets enable -path=mysecret kv-v2

Success! Enabled the kv-v2 secrets engine at: mysecret/
```

**(2) ìƒ˜í”Œ ì‹œí¬ë¦¿ ì €ì¥**

```bash
vault kv put mysecret/logins/study \
  username="demo" \
  password="p@ssw0rd"

# ê²°ê³¼
======= Secret Path =======
mysecret/data/logins/study

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T12:52:13.376179475Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```

**(3) ë°ì´í„° ì¡°íšŒ**

```bash
vault kv get mysecret/logins/study

# ê²°ê³¼
======= Secret Path =======
mysecret/data/logins/study

======= Metadata =======
Key                Value
---                -----
created_time       2025-12-13T12:52:13.376179475Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    p@ssw0rd
username    demo
```

### **7. ì •ì±…(Policy) ìƒì„± ì˜ˆì‹œ**

```bash
vault policy write restrict_study - <<EOF
path "mysecret/logins/study*" {
capabilities = ["deny"]
}
EOF

Success! Uploaded policy: restrict_study
```

- `mysecret/logins/study*` ê²½ë¡œë¥¼ deny ì²˜ë¦¬í•˜ëŠ” ì •ì±… ìƒì„±

---

## **ğŸªª Vault Auth with LDAP**

### **1. OpenLDAP ì„œë²„ ë°°í¬**

- [https://www.openldap.org/](https://www.openldap.org/)

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: openldap
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: openldap
  namespace: openldap
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openldap
  template:
    metadata:
      labels:
        app: openldap
    spec:
      containers:
        - name: openldap
          image: osixia/openldap:1.5.0
          ports:
            - containerPort: 389
              name: ldap
            - containerPort: 636
              name: ldaps
          env:
            - name: LDAP_ORGANISATION    # ê¸°ê´€ëª…, LDAP ê¸°ë³¸ ì •ë³´ ìƒì„± ì‹œ ì‚¬ìš©
              value: "Example Org"
            - name: LDAP_DOMAIN          # LDAP ê¸°ë³¸ Base DN ì„ ìë™ ìƒì„±
              value: "example.org"
            - name: LDAP_ADMIN_PASSWORD  # LDAP ê´€ë¦¬ì íŒ¨ìŠ¤ì›Œë“œ
              value: "admin"
            - name: LDAP_CONFIG_PASSWORD
              value: "admin"
        - name: phpldapadmin
          image: osixia/phpldapadmin:0.9.0
          ports:
            - containerPort: 80
              name: phpldapadmin
          env:
            - name: PHPLDAPADMIN_HTTPS
              value: "false"
            - name: PHPLDAPADMIN_LDAP_HOSTS
              value: "openldap"   # LDAP hostname inside cluster
---
apiVersion: v1
kind: Service
metadata:
  name: openldap
  namespace: openldap
spec:
  selector:
    app: openldap
  ports:
    - name: phpldapadmin
      port: 80
      targetPort: 80
      nodePort: 30001
    - name: ldap
      port: 389
      targetPort: 389
    - name: ldaps
      port: 636
      targetPort: 636
  type: NodePort
EOF

namespace/openldap created
deployment.apps/openldap created
service/openldap created
```

```bash
kubectl get deploy,pod,svc,ep -n openldap

NAME                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/openldap   1/1     1            1           24s

NAME                            READY   STATUS    RESTARTS   AGE
pod/openldap-54857b746c-9q6xd   2/2     Running   0          24s

NAME               TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)                                    AGE
service/openldap   NodePort   10.96.1.204   <none>        80:30001/TCP,389:31824/TCP,636:31736/TCP   24s

NAME                 ENDPOINTS                                     AGE
endpoints/openldap   10.244.1.4:80,10.244.1.4:389,10.244.1.4:636   24s
```

---

### **2. OpenLDAP ì¡°ì§ë„ êµ¬ì„±**

**(1) OpenLDAP ì»¨í…Œì´ë„ˆ ì§„ì…**

```bash
kubectl -n openldap exec -it deploy/openldap -c openldap -- bash
root@openldap-54857b746c-9q6xd:/# 
```

**(2) OU ìƒì„±(organizationalUnit)**

```bash
root@openldap-54857b746c-9q6xd:/# cat <<EOF | ldapadd -x -D "cn=admin,dc=example,dc=org" -w admin
> dn: ou=people,dc=example,dc=org
> objectClass: organizationalUnit
> ou: people
> 
> dn: ou=groups,dc=example,dc=org
> objectClass: organizationalUnit
> ou: groups
> EOF
adding new entry "ou=people,dc=example,dc=org"
adding new entry "ou=groups,dc=example,dc=org"
```

**(3) ì‚¬ìš©ì ìƒì„± (inetOrgPerson)**

```bash
root@openldap-54857b746c-9q6xd:/# cat <<EOF | ldapadd -x -D "cn=admin,dc=example,dc=org" -w admin
> dn: uid=alice,ou=people,dc=example,dc=org
> objectClass: inetOrgPerson
> cn: Alice
> sn: Kim
> uid: alice
> mail: alice@example.org
> userPassword: alice123
> 
> dn: uid=bob,ou=people,dc=example,dc=org
> objectClass: inetOrgPerson
> cn: Bob
> sn: Lee
> uid: bob
> mail: bob@example.org
> userPassword: bob123
> EOF
adding new entry "uid=alice,ou=people,dc=example,dc=org"
adding new entry "uid=bob,ou=people,dc=example,dc=org"
```

**(4) ê·¸ë£¹ ìƒì„± ë° ë©¤ë²„ ì§€ì •**

```bash
root@openldap-54857b746c-9q6xd:/# cat <<EOF | ldapadd -x -D "cn=admin,dc=example,dc=org" -w admin
> dn: cn=devs,ou=groups,dc=example,dc=org
> objectClass: groupOfNames
> cn: devs
> member: uid=bob,ou=people,dc=example,dc=org
> 
> dn: cn=admins,ou=groups,dc=example,dc=org
> objectClass: groupOfNames
> cn: admins
> member: uid=alice,ou=people,dc=example,dc=org
> EOF
adding new entry "cn=devs,ou=groups,dc=example,dc=org"
adding new entry "cn=admins,ou=groups,dc=example,dc=org"

root@openldap-54857b746c-9q6xd:/# exit
```

**(5) phpLDAPadmin ì ‘ì† ì •ë³´**

```bash
http://127.0.0.1:30001

Login DN: cn=admin,dc=example,dc=org
Password: admin
```
![](https://velog.velcdn.com/images/tlsalswls123/post/cea19af7-7bf6-491d-af2d-52680a9e858b/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/e67b9034-ceb1-4562-8a47-47c289e42102/image.png)

---

### **3. Vault Auth with LDAP ì„¤ì •**

**(1) LDAP Auth í™œì„±í™”**

```bash
vault auth enable ldap

Success! Enabled ldap auth method at: ldap/
```

```bash
vault auth list

Path      Type     Accessor               Description                Version
----      ----     --------               -----------                -------
ldap/     ldap     auth_ldap_96da3d21     n/a                        n/a
token/    token    auth_token_1257fa38    token based credentials    n/a
```

**(2) LDAP Config ì„¤ì •**

```bash
vault write auth/ldap/config \
    url="ldap://openldap.openldap.svc:389" \
    starttls=false \
    insecure_tls=true \
    binddn="cn=admin,dc=example,dc=org" \
    bindpass="admin" \
    userdn="ou=people,dc=example,dc=org" \
    groupdn="ou=groups,dc=example,dc=org" \
    groupfilter="(member=uid={{.Username}},ou=people,dc=example,dc=org)" \
    groupattr="cn"
    
Success! Data written to: auth/ldap/config
```

**(3) LDAP ì¸ì¦ í…ŒìŠ¤íŠ¸**

- **alice ë¡œê·¸ì¸**

```bash
vault login -method=ldap username=alice

Password (will be hidden): alice123
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor         vzIEcUCjwQ1VtrwZOmt1fV82
token_duration         768h
token_renewable        true
token_policies         ["default"]
identity_policies      []
policies               ["default"]
token_meta_username    alice
```

- **ì •ì±… í™•ì¸**

```bash
vault token lookup -format=json | jq .data.policies

[
  "default"
]
```

- **í† í° ìƒì„¸ í™•ì¸**

```bash
vault token lookup

Key                 Value
---                 -----
accessor            vzIEcUCjwQ1VtrwZOmt1fV82
creation_time       1765631074
creation_ttl        768h
display_name        ldap-alice
entity_id           d87709c5-2f64-8c84-e492-7c178a142f9c
expire_time         2026-01-14T13:04:34.472217287Z
explicit_max_ttl    0s
id                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
issue_time          2025-12-13T13:04:34.472223442Z
meta                map[username:alice]
num_uses            0
orphan              true
path                auth/ldap/login/alice
policies            [default]
renewable           true
ttl                 767h58m57s
type                service
```

- **bob ë¡œê·¸ì¸**

```bash
vault login -method=ldap username=bob password=bob123

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor         YvMHJWu4hpQlDRmYUVoqeRV2
token_duration         768h
token_renewable        true
token_policies         ["default"]
identity_policies      []
policies               ["default"]
token_meta_username    bob
```

- **í† í° ìƒì„¸ í™•ì¸**

```bash
vault token lookup

Key                 Value
---                 -----
accessor            YvMHJWu4hpQlDRmYUVoqeRV2
creation_time       1765631164
creation_ttl        768h
display_name        ldap-bob
entity_id           4ba5864b-0bc3-533d-cd42-e9419500a41b
expire_time         2026-01-14T13:06:04.60339669Z
explicit_max_ttl    0s
id                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
issue_time          2025-12-13T13:06:04.603404694Z
meta                map[username:bob]
num_uses            0
orphan              true
path                auth/ldap/login/bob
policies            [default]
renewable           true
ttl                 767h59m45s
type                service
```

### **4. LDAP ê·¸ë£¹ â†’ Vault Policy ë§¤í•‘**

**(1) bob í† í°ìœ¼ë¡œ policy ì‘ì„± ì‹œë„ ì‹œ 403 ë°œìƒ í™•ì¸**

```bash
vault policy write admin - <<EOF
path "*" {
capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
EOF

Error uploading policy: Error making API request.

URL: PUT http://localhost:30000/v1/sys/policies/acl/admin
Code: 403. Errors:

* 1 error occurred:
	* permission denied
```

**(2) í˜„ì¬ ì‚¬ìš© í† í° í™•ì¸ - bob**

```bash
vault token lookup

Key                 Value
---                 -----
accessor            YvMHJWu4hpQlDRmYUVoqeRV2
creation_time       1765631164
creation_ttl        768h
display_name        ldap-bob
entity_id           4ba5864b-0bc3-533d-cd42-e9419500a41b
expire_time         2026-01-14T13:06:04.60339669Z
explicit_max_ttl    0s
id                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
issue_time          2025-12-13T13:06:04.603404694Z
meta                map[username:bob]
num_uses            0
orphan              true
path                auth/ldap/login/bob
policies            [default]
renewable           true
ttl                 767h57m39s
type                service
```

- í˜„ì¬ í† í°ì´ `default` ì •ì±…ë¿ì´ë¼ `sys/policies/acl/*` ì“°ê¸° ê¶Œí•œì´ ì—†ì–´ ê±°ë¶€ë¨

**(3) root í† í°ìœ¼ë¡œ ì¬ë¡œê·¸ì¸ í›„ ì •ì±… ìƒì„±**

```bash
vault login

Token (will be hidden): hvs.xxxxxxxxxxxxxxxxxxxxxxxx
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor       MAW2uNjALwZpAnu7tOBBjTBJ
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

- **admin ì •ì±… ìƒì„±**

```bash
vault policy write admin - <<EOF
path "*" {
capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
EOF

Success! Uploaded policy: admin
```

- **ì •ì±… í™•ì¸**

```bash
vault policy read admin

path "*" {
capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
```

**(4) LDAP admins ê·¸ë£¹ì— admin ì •ì±… ì—°ê²°**

```bash
vault write auth/ldap/groups/admins policies=admin

Success! Data written to: auth/ldap/groups/admins
```

**(5) alice ì¬ë¡œê·¸ì¸ í›„ ì •ì±… ì ìš© í™•ì¸**

```bash
vault login -method=ldap username=alice password=alice123

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor         FdLxDMguy6rXssFmLyHRNlyf
token_duration         768h
token_renewable        true
token_policies         ["admin" "default"]
identity_policies      []
policies               ["admin" "default"]
token_meta_username    alice
```

- ì¶œë ¥ì—ì„œ `token_policies` / `policies`ì— `admin`ì´ í¬í•¨ë˜ëŠ”ì§€ í™•ì¸í•¨
- LDAP admins ê·¸ë£¹ì— aliceê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë¯€ë¡œ Vault ì •ì±…ì´ í•¨ê»˜ ë¶€ì—¬ë˜ëŠ” íë¦„ì„

![](https://velog.velcdn.com/images/tlsalswls123/post/93c1d079-ce9b-47f3-bc73-22bec6721fd3/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/5c9d8b5d-0261-4cab-a27d-ec3928d13e0a/image.png)

**(6) ì •ì±… ë‚´ìš© í™•ì¸**

```bash
vault policy read admin

path "*" {
capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}
```

### **5. í´ëŸ¬ìŠ¤í„° ì‚­ì œ**

```bash
kind delete cluster --name myk8s

Deleting cluster "myk8s" ...
Deleted nodes: ["myk8s-worker2" "myk8s-worker" "myk8s-worker3" "myk8s-control-plane"]
```

---

## **ğŸ“œ Vault Server TLS**

### **1. kind í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  labels:
    ingress-ready: true
  extraPortMappings:
  - containerPort: 80
    hostPort: 80
    protocol: TCP
  - containerPort: 443
    hostPort: 443
    protocol: TCP
  - containerPort: 30000
    hostPort: 30000
EOF
```

### **2. ingress-nginx ë°°í¬ ë° SSL Passthrough í™œì„±í™”**

**(1) NGINX ingress ë°°í¬**

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml

namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
service/ingress-nginx-controller-admission created
deployment.apps/ingress-nginx-controller created
job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
ingressclass.networking.k8s.io/nginx created
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created
```

**(2) SSL Passthrough í”Œë˜ê·¸ í™œì„±í™”**

```bash
kubectl get deployment ingress-nginx-controller -n ingress-nginx -o yaml \
| sed '/- --publish-status-address=localhost/a\
        - --enable-ssl-passthrough' | kubectl apply -f -

deployment.apps/ingress-nginx-controller configured
```

**(3) nodeSelector ì§€ì •**

```bash
kubectl patch deployment ingress-nginx-controller -n ingress-nginx \
  --type='merge' \
  -p='{
    "spec": {
      "template": {
        "spec": {
          "nodeSelector": {
            "ingress-ready": "true"
          }
        }
      }
    }
  }'

deployment.apps/ingress-nginx-controller patched
```

---

### **3. Helm ì„¤ì¹˜ ë° Vault Helm Repo ì¤€ë¹„**

```bash
docker exec -it myk8s-control-plane bash
root@myk8s-control-plane:/# curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

root@myk8s-control-plane:/# helm version
version.BuildInfo{Version:"v3.19.3", GitCommit:"0707f566a3f4ced24009ef14d67fe0ce69db4be9", GitTreeState:"clean", GoVersion:"go1.24.10"}

root@myk8s-control-plane:/# helm repo add hashicorp https://helm.releases.hashicorp.com
"hashicorp" has been added to your repositories

root@myk8s-control-plane:/# helm repo update
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "hashicorp" chart repository
Update Complete. âˆHappy Helming!âˆ
```

- kind control-plane ì»¨í…Œì´ë„ˆì— helm ì„¤ì¹˜ í›„ hashicorp repo ë“±ë¡í•¨

### **4. CA ë° Vault ì„œë²„ ì¸ì¦ì„œ ìƒì„±**

**(1) CA ìƒì„±**

```bash
root@myk8s-control-plane:/# mkdir /tls && cd /tls
root@myk8s-control-plane:/tls# openssl genrsa -out ca.key 2048
openssl req -x509 -new -nodes \
  -key ca.key \
  -subj "/CN=Vault-CA" \
  -days 3650 \
  -out ca.crt

root@myk8s-control-plane:/tls#  ls
ca.crt	ca.key
```

**(2) Vault ì„œë²„ í‚¤/CSR ìƒì„±**

```bash
root@myk8s-control-plane:/tls# openssl genrsa -out vault.key 2048
openssl req -new -key vault.key \
  -subj "/CN=vault.example.com" \
  -out vault.csr

root@myk8s-control-plane:/tls# ls
ca.crt	ca.key	vault.csr  vault.key
```

**(3) CAë¡œ ì„œëª… + SAN ì§€ì •**

```bash
root@myk8s-control-plane:/tls# openssl x509 -req \
  -in vault.csr \
  -CA ca.crt \
  -CAkey ca.key \
  -CAcreateserial \
  -out vault.crt \
  -days 3650 \
  -extensions v3_req \
  -extfile <(cat <<EOF
[v3_req]
subjectAltName = @alt_names
[alt_names]
DNS.1 = vault.example.com
DNS.2 = vault
DNS.3 = localhost
DNS.4 = vault.vault.svc.cluster.local
DNS.5 = vault.vault-internal
DNS.6 = vault-0.vault-internal
DNS.7 = vault-1.vault-internal
DNS.8 = vault-2.vault-internal
DNS.9 = 127.0.0.1
EOF
)

# ê²°ê³¼
Certificate request self-signature ok
subject=CN = vault.example.com
```

### **5. Kubernetes Secret ë“±ë¡**

```bash
root@myk8s-control-plane:/tls# kubectl create namespace vault
kubectl -n vault create secret tls vault-tls \
  --cert=vault.crt \
  --key=vault.key
  
namespace/vault created
secret/vault-tls created
```

```bash
root@myk8s-control-plane:/tls# kubectl -n vault create secret generic vault-ca \
  --from-file=ca.crt=ca.crt

secret/vault-ca created
```

- Vault ì°¨íŠ¸ì—ì„œ ì‚¬ìš©í•  TLS Secret(vault-tls)ê³¼ CA Secret(vault-ca)ì„ ìƒì„±í•¨
    - `vault-tls`: ì„œë²„ ì¸ì¦ì„œ/í‚¤
    - `vault-ca`: init/í´ë¼ì´ì–¸íŠ¸ ê²€ì¦ìš© CA

### **6. Vault TLS(HTTPS) Helm ì„¤ì¹˜**

```bash
root@myk8s-control-plane:/tls# cat << EOF > values-tls.yaml
global:
  tlsDisable: false
  
injector:
  enabled: false

server:
  volumes:
    - name: vault-tls
      secret:
        secretName: vault-tls
    - name: vault-ca
      secret:
        secretName: vault-ca
  volumeMounts:
    - name: vault-tls
      mountPath: /vault/user-tls
      readOnly: true
    - name: vault-ca
      mountPath: /vault/user-ca
      readOnly: true

  # Vault HTTPS listener ì„¤ì •
  standalone:
    enabled: "true"
    config: |-
      ui = true
      listener "tcp" {
        tls_disable = 0
        address = "0.0.0.0:8200"
        cluster_address = "0.0.0.0:8201"
        tls_cert_file    = "/vault/user-tls/tls.crt"
        tls_key_file     = "/vault/user-tls/tls.key"
      }
      storage "file" {
        path = "/vault/data"
      }
      api_addr     = "https://vault.vault.svc.cluster.local:8200"
      cluster_addr = "https://vault-0.vault-internal:8201"
EOF
```

```bash
root@myk8s-control-plane:/tls# helm install vault hashicorp/vault -n vault -f values-tls.yaml --version 0.29.0

NAME: vault
LAST DEPLOYED: Sat Dec 13 13:27:17 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

```bash
root@myk8s-control-plane:/tls# helm list -A

NAME 	NAMESPACE	REVISION	UPDATED                               	STATUS  	CHART       	APP VERSION
vault	vault    	1       	2025-12-13 13:27:17.58887749 +0000 UTC	deployed	vault-0.29.0	1.18.1

root@myk8s-control-plane:/tls# exit
exit
```

```bash
kubectl get pod -n vault

NAME      READY   STATUS    RESTARTS   AGE
vault-0   0/1     Running   0          91s
```

### **7. Vault status TLS ê²€ì¦ ì˜¤ë¥˜ ë° ìš°íšŒ í™•ì¸**

```bash
kubectl exec -ti vault-0 -n vault -- vault status

Error checking seal status: Get "https://127.0.0.1:8200/v1/sys/seal-status": tls: failed to verify certificate: x509: cannot validate certificate for 127.0.0.1 because it doesn't contain any IP SANs
command terminated with exit code 1
```

```bash
kubectl exec -ti vault-0 -n vault -- vault status -tls-skip-verify

Key                Value
---                -----
Seal Type          shamir
Initialized        false
Sealed             true
Total Shares       0
Threshold          0
Unseal Progress    0/0
Unseal Nonce       n/a
Version            1.18.1
Build Date         2024-10-29T14:21:31Z
Storage Type       file
HA Enabled         false
command terminated with exit code 2
```

- Pod ë‚´ë¶€ì—ì„œ `vault status` ì‹¤í–‰ ì‹œ, ê¸°ë³¸ ìš”ì²­ ëŒ€ìƒì´ `https://127.0.0.1:8200`ì´ì–´ì„œ ì¸ì¦ì„œì— **IP SAN(`127.0.0.1`)** ì´ ì—†ë‹¤ê³  íŒë‹¨ë˜ë©´ ê²€ì¦ì´ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
- ë”°ë¼ì„œ ì´ˆê¸° í™•ì¸ì€ `-tls-skip-verify`ë¡œ ì§„í–‰í•¨

### **8. Vault init/unseal ë° Root Token í™•ì¸**

```bash
kubectl exec vault-0 -n vault -- vault operator init -tls-skip-verify \
    -key-shares=1 \
    -key-threshold=1 \
    -format=json > cluster-keys.json
```

```bash
VAULT_UNSEAL_KEY=$(jq -r ".unseal_keys_b64[]" cluster-keys.json)
kubectl exec vault-0 -n vault -- vault operator unseal -tls-skip-verify $VAULT_UNSEAL_KEY

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.18.1
Build Date      2024-10-29T14:21:31Z
Storage Type    file
Cluster Name    vault-cluster-75aab1d3
Cluster ID      030421b1-a0d4-9d26-c3f4-d670a89f6b8a
HA Enabled      false
```

- Root Token í™•ì¸

```bash
jq -r ".root_token" cluster-keys.json

hvs.xxxxxxxxxxxxxxxxxxxxxxxx
```

### **9. NodePort(30000)ë¡œ Vault ì™¸ë¶€ ë…¸ì¶œ ë° ì ‘ì† í™•ì¸**

```bash
kubectl patch svc -n vault vault -p '{"spec":{"type":"NodePort","ports":[{"port":8200,"targetPort":8200,"nodePort":30000}]}}' 

service/vault patched
```

```bash
export VAULT_ADDR='https://localhost:30000'
```

```bash
vault status -tls-skip-verify

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.18.1
Build Date      2024-10-29T14:21:31Z
Storage Type    file
Cluster Name    vault-cluster-75aab1d3
Cluster ID      030421b1-a0d4-9d26-c3f4-d670a89f6b8a
HA Enabled      false
```

- **Root Tokenìœ¼ë¡œ ë¡œê·¸ì¸**

```bash
vault login -tls-skip-verify

Token (will be hidden): hvs.xxxxxxxxxxxxxxxxxxxxxxxx
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.xxxxxxxxxxxxxxxxxxxxxxxx
token_accessor       tphoWlDINUNf5TBBhJlSt0Pk
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

### **10. ingress-nginx SSL Passthroughë¡œ HTTPS ë¼ìš°íŒ…**

**(1) hosts ë“±ë¡**

```bash
echo "127.0.0.1 vault.example.com" | sudo tee -a /etc/hosts
```

**(2) Vault Pod í¬íŠ¸ í™•ì¸**

```bash
kubectl describe pod -n vault vault-0 | grep -i ports

    Ports:         8200/TCP (https), 8201/TCP (https-internal), 8202/TCP (https-rep)
    Host Ports:    0/TCP (https), 0/TCP (https-internal), 0/TCP (https-rep)
```

**(3) Ingress ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: vault-https
  namespace: vault
  annotations:
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: "nginx"
  rules:
    - host: vault.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: vault
                port:
                  number: 8200
  tls:
    - hosts:
        - vault.example.com
      secretName: vault-tls
EOF

ingress.networking.k8s.io/vault-https created
```

**(4) Ingress í™•ì¸**

```bash
kubectl get ingress -n vault

NAME          CLASS   HOSTS               ADDRESS     PORTS     AGE
vault-https   nginx   vault.example.com   localhost   80, 443   25s
```

- **HTTPë¡œ ì ‘ê·¼ ì‹œ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ëŠ” ë™ì‘ í™•ì¸í•¨**

```bash
http://vault.example.com
```

![](https://velog.velcdn.com/images/tlsalswls123/post/7fc1b18f-0a67-4cd8-91b8-5d2e2744d147/image.png)

