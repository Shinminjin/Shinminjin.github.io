---
title: CI/CD 2주차 정리
date: 2025-10-25 19:00:00 +0900
categories: [CI/CD]
tags: [CI/CD]
---

## **🚀 kind 클러스터 생성**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000
    hostPort: 30000
  - containerPort: 30001
    hostPort: 30001
EOF

# 결과
Creating cluster "myk8s" ...
 ✓ Ensuring node image (kindest/node:v1.32.8) 🖼
 ✓ Preparing nodes 📦  
 ✓ Writing configuration 📜 
 ✓ Starting control-plane 🕹️ 
 ✓ Installing CNI 🔌 
 ✓ Installing StorageClass 💾 
Set kubectl context to "kind-myk8s"
You can now use your cluster with:

kubectl cluster-info --context kind-myk8s

Not sure what to do next? 😅  Check out https://kind.sigs.k8s.io/docs/user/quick-start/
```

---

## **🧩 Creating a Helm Project**

### **1. 헬름 차트 디렉터리 레이아웃 생성**

```bash
mkdir pacman
mkdir pacman/templates
cd pacman
```

### **2. 차트 정의 파일(`Chart.yaml`) 작성**

```bash
cat << EOF > Chart.yaml
apiVersion: v2
name: pacman
description: A Helm chart for Pacman
type: application
version: 0.1.0        # 차트 버전, 차트 정의가 바뀌면 업데이트한다
appVersion: "1.0.0"   # 애플리케이션 버전
EOF
```

### **3. 배포 매니페스트 템플릿(`deployment.yaml`) 작성**

```bash
cat << EOF > templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Chart.Name}}            # Chart.yaml 파일에 설정된 이름을 가져와 설정
  labels:
    app.kubernetes.io/name: {{ .Chart.Name}}
    {{- if .Chart.AppVersion }}     # Chart.yaml 파일에 appVersion 여부에 따라 버전을 설정
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}     # appVersion 값을 가져와 지정하고 따움표 처리
    {{- end }}
spec:
  replicas: {{ .Values.replicaCount }}     # replicaCount 속성을 넣을 자리 placeholder
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Chart.Name}}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name}}
    spec:
      containers:
        - image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion}}"   # 이미지 지정 placeholder, 이미지 태그가 있으면 넣고, 없으면 Chart.yaml에 값을 설정
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 14 }} # securityContext의 값을 YAML 객체로 지정하며 14칸 들여쓰기
          name: {{ .Chart.Name}}
          ports:
            - containerPort: {{ .Values.image.containerPort }}
              name: http
              protocol: TCP
EOF
```

### **4. 서비스 템플릿(`service.yaml`) 작성**

```bash
cat << EOF > templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  name: {{ .Chart.Name }}
spec:
  ports:
    - name: http
      port: {{ .Values.image.containerPort }}
      targetPort: {{ .Values.image.containerPort }}
  selector:
    app.kubernetes.io/name: {{ .Chart.Name }}
EOF
```

### **5. 기본값(`values.yaml`) 작성**

```bash
cat << EOF > values.yaml
image:     # image 절 정의
  repository: quay.io/gitops-cookbook/pacman-kikd
  tag: "1.0.0"
  pullPolicy: Always
  containerPort: 8080

replicaCount: 1
securityContext: {}     # securityContext 속성의 값을 비운다
EOF
```

### **6. 디렉터리 레이아웃 확인**

```bash
tree
.
├── Chart.yaml
├── templates
│   ├── deployment.yaml
│   └── service.yaml
└── values.yaml

2 directories, 4 files
```

### **7. 로컬 렌더링으로 템플릿 검증**

```bash
helm template .

# 결과
---
# Source: pacman/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: pacman
  name: pacman
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
    app.kubernetes.io/name: pacman
---
# Source: pacman/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pacman            # Chart.yaml 파일에 설정된 이름을 가져와 설정
  labels:
    app.kubernetes.io/name: pacman     # Chart.yaml 파일에 appVersion 여부에 따라 버전을 설정
    app.kubernetes.io/version: "1.0.0"     # appVersion 값을 가져와 지정하고 따움표 처리
spec:
  replicas: 1     # replicaCount 속성을 넣을 자리 placeholder
  selector:
    matchLabels:
      app.kubernetes.io/name: pacman
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pacman
    spec:
      containers:
        - image: "quay.io/gitops-cookbook/pacman-kikd:1.0.0"   # 이미지 지정 placeholder, 이미지 태그가 있으면 넣고, 없으면 Chart.yaml에 값을 설정
          imagePullPolicy: Always
          securityContext:
              {} # securityContext의 값을 YAML 객체로 지정하며 14칸 들여쓰기
          name: pacman
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
```

- Service/Deployment가 기대 값(이름, 라벨, 이미지, 포트, replicas 등)으로 출력
- `securityContext: {}`가 그대로 반영됨(초기 상태)

### **8. 런타임 오버라이드(--set) 테스트**

```bash
helm template --set replicaCount=3 .

# 결과
...
spec:
  replicas: 3     # replicaCount 속성을 넣을 자리 placeholder
...
```

- `--set replicaCount=3` 사용 시 렌더 결과 `replicas: 3`로 반영

### **9. 차트 설치**

```bash
helm install pacman .

# 결과
NAME: pacman
LAST DEPLOYED: Sat Oct 25 12:45:00 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

### **10. 릴리스 리스트 확인**

```bash
helm list

NAME  	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART       	APP VERSION
pacman	default  	1       	2025-10-25 12:45:00.039857183 +0900 KST	deployed	pacman-0.1.0	1.0.0
```

### **11. 배포된 리소스 조회**

```bash
kubectl get deploy,pod,svc,ep
```

✅ **출력**

```bash
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/pacman   1/1     1            1           59s

NAME                          READY   STATUS    RESTARTS   AGE
pod/pacman-576769bb86-dnb4x   1/1     Running   0          59s

NAME                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP    12m
service/pacman       ClusterIP   10.96.122.128   <none>        8080/TCP   59s

NAME                   ENDPOINTS         AGE
endpoints/kubernetes   172.18.0.2:6443   12m
endpoints/pacman       10.244.0.5:8080   59s
```

### **12. securityContext 적용 상태 점검**

```bash
kubectl get pod -o json | grep securityContext -A1
```

✅ **출력**

```bash
                        "securityContext": {},
                        "terminationMessagePath": "/dev/termination-log",
--
                "securityContext": {},
                "serviceAccount": "default",
```

- 현재 파드 컨테이너에 보안 컨텍스트 비어있음을 확인

### **13. 배포 이력 확인**

```bash
helm history pacman

REVISION	UPDATED                 	STATUS  	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 12:45:00 2025	deployed	pacman-0.1.0	1.0.0      	Install complete
```

### **14. Helm 릴리스 메타데이터 Secret 확인**

```bash
kubectl get secret

NAME                           TYPE                 DATA   AGE
sh.helm.release.v1.pacman.v1   helm.sh/release.v1   1      3m16s
```

- Helm이 릴리스 메타정보를 Secret에 저장함을 확인

### **15. 차트 업그레이드**

```bash
helm upgrade pacman --reuse-values --set replicaCount=2 .

# 결과
Release "pacman" has been upgraded. Happy Helming!
NAME: pacman
LAST DEPLOYED: Sat Oct 25 12:49:01 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
TEST SUITE: None
```

### **16. 업그레이드 후 릴리스/이력 재확인**

```bash
helm list

NAME  	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART       	APP VERSION
pacman	default  	2       	2025-10-25 12:49:01.423753811 +0900 KST	deployed	pacman-0.1.0	1.0.0 
```

```bash
helm history pacman

REVISION	UPDATED                 	STATUS    	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 12:45:00 2025	superseded	pacman-0.1.0	1.0.0      	Install complete
2       	Sat Oct 25 12:49:01 2025	deployed  	pacman-0.1.0	1.0.0      	Upgrade complete
```

- 리비전 증가 및 상태 갱신 확인

### **17. Secret 리비전 누적 확인**

```bash
kubectl get secret

NAME                           TYPE                 DATA   AGE
sh.helm.release.v1.pacman.v1   helm.sh/release.v1   1      6m28s
sh.helm.release.v1.pacman.v2   helm.sh/release.v1   1      2m27s
```

### **18. 스케일 변화 확인**

```bash
kubectl get pod                                   

NAME                      READY   STATUS    RESTARTS   AGE
pacman-576769bb86-dnb4x   1/1     Running   0          6m51s
pacman-576769bb86-t4g9l   1/1     Running   0          2m50s
```

### **19. 배포 상세 확인**

```bash
helm get all pacman

NAME: pacman
LAST DEPLOYED: Sat Oct 25 12:49:01 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
CHART: pacman
VERSION: 0.1.0
APP_VERSION: 1.0.0
TEST SUITE: None
USER-SUPPLIED VALUES:
replicaCount: 2

COMPUTED VALUES:
image:
  containerPort: 8080
  pullPolicy: Always
  repository: quay.io/gitops-cookbook/pacman-kikd
  tag: 1.0.0
replicaCount: 2
securityContext: {}

HOOKS:
MANIFEST:
---
# Source: pacman/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: pacman
  name: pacman
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
    app.kubernetes.io/name: pacman
---
# Source: pacman/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pacman            # Chart.yaml 파일에 설정된 이름을 가져와 설정
  labels:
    app.kubernetes.io/name: pacman     # Chart.yaml 파일에 appVersion 여부에 따라 버전을 설정
    app.kubernetes.io/version: "1.0.0"     # appVersion 값을 가져와 지정하고 따움표 처리
spec:
  replicas: 2     # replicaCount 속성을 넣을 자리 placeholder
  selector:
    matchLabels:
      app.kubernetes.io/name: pacman
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pacman
    spec:
      containers:
        - image: "quay.io/gitops-cookbook/pacman-kikd:1.0.0"   # 이미지 지정 placeholder, 이미지 태그가 있으면 넣고, 없으면 Chart.yaml에 값을 설정
          imagePullPolicy: Always
          securityContext:
              {} # securityContext의 값을 YAML 객체로 지정하며 14칸 들여쓰기
          name: pacman
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
```

### **20. 차트 삭제**

```bash
helm uninstall pacman
kubectl get secret

No resources found in default namespace.
```

---

## **♻️ Reusing Statements Between Templates**

### **1. `_helpers.tpl` 파일 작성**

```bash
cat << EOF > templates/_helpers.tpl
{{- define "pacman.selectorLabels" -}}   # stetement 이름을 정의
app.kubernetes.io/name: {{ .Chart.Name}} # 해당 stetement 가 하는 일을 정의
{{- end }}
EOF
```

- 여러 템플릿에서 동일 구문 재사용 가능

### **2. deployment/service에 헬퍼 적용**

```bash
## deployment.yaml 수정
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      {{- include "pacman.selectorLabels" . | nindent 6 }}   # pacman.selectorLabels를 호출한 결과를 6만큼 들여쓰기하여 주입
  template:
    metadata:
      labels:
        {{- include "pacman.selectorLabels" . | nindent 8 }} # pacman.selectorLabels를 호출한 결과를 8만큼 들여쓰기하여 주입
        
## service.yaml 수정
  selector:
    {{- include "pacman.selectorLabels" . | nindent 6 }}
```

### **3. 로컬 렌더링으로 적용 확인**

```bash
helm template .

---
# Source: pacman/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: pacman
  name: pacman
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
      # stetement 이름을 정의
      app.kubernetes.io/name: pacman # 해당 stetement 가 하는 일을 정의
---
# Source: pacman/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pacman            # Chart.yaml 파일에 설정된 이름을 가져와 설정
  labels:
    app.kubernetes.io/name: pacman     # Chart.yaml 파일에 appVersion 여부에 따라 버전을 설정
    app.kubernetes.io/version: "1.0.0"     # appVersion 값을 가져와 지정하고 따움표 처리
spec:
  replicas: 1     # replicaCount 속성을 넣을 자리 placeholder
  selector:
    matchLabels:
      # stetement 이름을 정의
      app.kubernetes.io/name: pacman # 해당 stetement 가 하는 일을 정의   # pacman.selectorLabels를 호출한 결과를 6만큼 들여쓰기하여 주입
  template:
    metadata:
      labels:
        # stetement 이름을 정의
        app.kubernetes.io/name: pacman # 해당 stetement 가 하는 일을 정의 # pacman.selectorLabels를 호출한 결과를 8만큼 들여쓰기하여 주입
    spec:
      containers:
        - image: "quay.io/gitops-cookbook/pacman-kikd:1.0.0"   # 이미지 지정 placeholder, 이미지 태그가 있으면 넣고, 없으면 Chart.yaml에 값을 설정
          imagePullPolicy: Always
          securityContext:
              {} # securityContext의 값을 YAML 객체로 지정하며 14칸 들여쓰기
          name: pacman
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
```

- `app.kubernetes.io/name: pacman` 라벨 반영 확인

### **4. `_helpers.tpl` 확장**

```bash
cat << EOF > templates/_helpers.tpl
{{- define "pacman.selectorLabels" -}}
app.kubernetes.io/name: {{ .Chart.Name}}
app.kubernetes.io/version: {{ .Chart.AppVersion}}
{{- end }}
EOF
```

- `app.kubernetes.io/version: {{ .Chart.AppVersion }}` 추가

### **5. 재렌더링으로 버전 라벨 확인**

```bash
helm template .

---
# Source: pacman/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: pacman
  name: pacman
spec:
  ports:
    - name: http
      port: 8080
      targetPort: 8080
  selector:
      app.kubernetes.io/name: pacman
      app.kubernetes.io/version: 1.0.0
---
# Source: pacman/templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pacman            # Chart.yaml 파일에 설정된 이름을 가져와 설정
  labels:
    app.kubernetes.io/name: pacman     # Chart.yaml 파일에 appVersion 여부에 따라 버전을 설정
    app.kubernetes.io/version: "1.0.0"     # appVersion 값을 가져와 지정하고 따움표 처리
spec:
  replicas: 1     # replicaCount 속성을 넣을 자리 placeholder
  selector:
    matchLabels:
      app.kubernetes.io/name: pacman
      app.kubernetes.io/version: 1.0.0   # pacman.selectorLabels를 호출한 결과를 6만큼 들여쓰기하여 주입
  template:
    metadata:
      labels:
        app.kubernetes.io/name: pacman
        app.kubernetes.io/version: 1.0.0 # pacman.selectorLabels를 호출한 결과를 8만큼 들여쓰기하여 주입
    spec:
      containers:
        - image: "quay.io/gitops-cookbook/pacman-kikd:1.0.0"   # 이미지 지정 placeholder, 이미지 태그가 있으면 넣고, 없으면 Chart.yaml에 값을 설정
          imagePullPolicy: Always
          securityContext:
              {} # securityContext의 값을 YAML 객체로 지정하며 14칸 들여쓰기
          name: pacman
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
```

- 이름·버전 라벨 모두 공통 헬퍼에서 관리되어 중복 제거 및 변경 용이성 향상

---

## **🔄 Updating a Container Image in Helm**

### **1. `_helpers.tpl` 초기화**

```bash
cat << EOF > templates/_helpers.tpl
{{- define "pacman.selectorLabels" -}}
app.kubernetes.io/name: {{ .Chart.Name}}
{{- end }}
EOF
```

- selector 공통 함수에서 `name`만 사용하도록 원복

### **2. 초기 배포(REVISION 1)**

```bash
helm install pacman .

# 결과
NAME: pacman
LAST DEPLOYED: Sat Oct 25 13:10:58 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

```bash
helm history pacman
kubectl get deploy -owide
```

✅ **출력**

```bash
REVISION	UPDATED                 	STATUS  	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 13:10:58 2025	deployed	pacman-0.1.0	1.0.0      	Install complete

NAME     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                                      SELECTOR
pacman   1/1     1            1           30s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.0.0   app.kubernetes.io/name=pacman
```

### **3. 이미지 태그 1.1.0으로 갱신**

```bash
cat << EOF > values.yaml
image:
  repository: quay.io/gitops-cookbook/pacman-kikd
  tag: "1.1.0"
  pullPolicy: Always
  containerPort: 8080

replicaCount: 1
securityContext: {}
EOF
```

```bash
cat << EOF > Chart.yaml
apiVersion: v2
name: pacman
description: A Helm chart for Pacman
type: application
version: 0.1.0
appVersion: "1.1.0"
EOF
```

- `values.yaml`의 `image.tag`를 `"1.1.0"`으로, `Chart.yaml`의 `appVersion`을 `"1.1.0"`으로 업데이트

### **4. 업그레이드 적용(REVISION 2)**

```bash
helm upgrade pacman .

# 결과
Release "pacman" has been upgraded. Happy Helming!
NAME: pacman
LAST DEPLOYED: Sat Oct 25 13:13:30 2025
NAMESPACE: default
STATUS: deployed
REVISION: 2
TEST SUITE: None
```

```bash
helm history pacman
kubectl get secret
```

✅ **출력**

```bash
REVISION	UPDATED                 	STATUS    	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 13:10:58 2025	superseded	pacman-0.1.0	1.0.0      	Install complete
2       	Sat Oct 25 13:13:30 2025	deployed  	pacman-0.1.0	1.1.0      	Upgrade complete

NAME                           TYPE                 DATA   AGE
sh.helm.release.v1.pacman.v1   helm.sh/release.v1   1      3m
sh.helm.release.v1.pacman.v2   helm.sh/release.v1   1      28s
```

- REVISION 2 / APP VERSION 1.1.0 / Upgrade complete

### **5. 리소스 상태 확인**

```bash
kubectl get deploy,replicaset -owide
```

✅ **출력**

```bash
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                      SELECTOR
deployment.apps/pacman   1/1     1            1           3m34s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.1.0   app.kubernetes.io/name=pacman

NAME                                DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES                                      SELECTOR
replicaset.apps/pacman-576769bb86   0         0         0       3m34s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.0.0   app.kubernetes.io/name=pacman,pod-template-hash=576769bb86
replicaset.apps/pacman-64c54b85f9   1         1         1       62s     pacman       quay.io/gitops-cookbook/pacman-kikd:1.1.0   app.kubernetes.io/name=pacman,pod-template-hash=64c54b85f9
```

- 배포: `deployment.apps/pacman` 이미지 `:1.1.0` 적용
- 레플리카셋: `:1.0.0`(이전)과 `:1.1.0`(현재) 공존, 이전 RS는 파드 0

### **6. 이전 버전으로 롤백(REVISION 3)**

```bash
helm history pacman

REVISION	UPDATED                 	STATUS    	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 13:10:58 2025	superseded	pacman-0.1.0	1.0.0      	Install complete
2       	Sat Oct 25 13:13:30 2025	deployed  	pacman-0.1.0	1.1.0      	Upgrade complete
```

```bash
helm rollback pacman 1 && kubectl get pod -w

Rollback was a success! Happy Helming!
NAME                      READY   STATUS              RESTARTS   AGE
pacman-576769bb86-gvgv4   0/1     ContainerCreating   0          0s
pacman-64c54b85f9-4bgs2   1/1     Running             0          3m52s
pacman-576769bb86-gvgv4   1/1     Running             0          2s
pacman-64c54b85f9-4bgs2   1/1     Terminating         0          3m54s
pacman-64c54b85f9-4bgs2   0/1     Error               0          3m54s
pacman-64c54b85f9-4bgs2   0/1     Error               0          3m55s
pacman-64c54b85f9-4bgs2   0/1     Error               0          3m55s
```

```bash
helm history pacman
kubectl get secret

REVISION	UPDATED                 	STATUS    	CHART       	APP VERSION	DESCRIPTION     
1       	Sat Oct 25 13:10:58 2025	superseded	pacman-0.1.0	1.0.0      	Install complete
2       	Sat Oct 25 13:13:30 2025	superseded	pacman-0.1.0	1.1.0      	Upgrade complete
3       	Sat Oct 25 13:17:22 2025	deployed  	pacman-0.1.0	1.0.0      	Rollback to 1   

NAME                           TYPE                 DATA   AGE
sh.helm.release.v1.pacman.v1   helm.sh/release.v1   1      7m11s
sh.helm.release.v1.pacman.v2   helm.sh/release.v1   1      4m39s
sh.helm.release.v1.pacman.v3   helm.sh/release.v1   1      47s
```

- `helm history`에 `REVISION 3 / APP VERSION 1.0.0 / Rollback to 1`
- Secret: `sh.helm.release.v1.pacman.v3` 추가

```bash
kubectl get deploy,replicaset -owide

# 결과
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE     CONTAINERS   IMAGES                                      SELECTOR
deployment.apps/pacman   1/1     1            1           7m45s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.0.0   app.kubernetes.io/name=pacman

NAME                                DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES                                      SELECTOR
replicaset.apps/pacman-576769bb86   1         1         1       7m45s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.0.0   app.kubernetes.io/name=pacman,pod-template-hash=576769bb86
replicaset.apps/pacman-64c54b85f9   0         0         0       5m13s   pacman       quay.io/gitops-cookbook/pacman-kikd:1.1.0   app.kubernetes.io/name=pacman,pod-template-hash=64c54b85f9
```

- Deployment 이미지 `:1.0.0`, 이전 `:1.1.0` RS는 파드 0

### **7. values 오버라이드로 템플릿만 검증**

```bash
cat << EOF > newvalues.yaml
image:
  tag: "1.2.0"
EOF
```

```bash
helm template pacman -f newvalues.yaml .

# 결과
...
        - image: "quay.io/gitops-cookbook/pacman-kikd:1.2.0"
...
```

- 렌더된 매니페스트 이미지가 `:1.2.0`으로 출력(실제 배포 변경 없음)

---

## **📦 Packaging and Distributing a Helm Chart**

### **1. 차트 패키징(.tgz 생성)**

```bash
helm package .

# 결과
Successfully packaged chart and saved it to: /home/devshin/workspace/cicd/chapters/chapters/pacman/pacman-0.1.0.tgz
```

### **2. 리포지토리 인덱스 생성**

```bash
helm repo index .
```

```bash
cat index.yaml

# 결과
apiVersion: v1
entries:
  pacman:
  - apiVersion: v2
    appVersion: 1.1.0
    created: "2025-10-25T13:24:19.927801229+09:00"
    description: A Helm chart for Pacman
    digest: 055ede949ae3c3d13e1088ae55dffd887bc6f2c7c224dfa5acd911a0e476732d
    name: pacman
    type: application
    urls:
    - pacman-0.1.0.tgz
    version: 0.1.0
generated: "2025-10-25T13:24:19.926665757+09:00"
```

---

## **🔔 Bitnami 공개 카탈로그 삭제**

### **1. BSI nginx 이미지 가져오기**

```bash
docker pull bitnamisecure/nginx:latest

# 결과
latest: Pulling from bitnamisecure/nginx
1492e1542a25: Pull complete 
Digest: sha256:1a6d9b279f8e272e170f9632df0183d22b50372b7465b77d2ba6071b88b8c803
Status: Downloaded newer image for bitnamisecure/nginx:latest
docker.io/bitnamisecure/nginx:latest
```

### **2. 이미지 목록 확인**

```bash
docker images

REPOSITORY                                  TAG                                                           IMAGE ID       CREATED        SIZE
bitnamisecure/nginx                         latest                                                        2aa2aa2b771f   27 hours ago   100MB                                             2574b2ca2237   55 years ago   281MB
```

### **3. 컨테이너 실행**

```bash
docker run -d -p 8080:8080 --name nginx bitnamisecure/nginx:latest

# 결과
c7113c60789a765e6276b91774f4d8fc2ca1070082f564ffd7a2e5f509456869
```

### **4. 동작 확인**

```bash
curl -s 127.0.0.1:8080

# 결과
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
html { color-scheme: light dark; }
body { width: 35em; margin: 0 auto;
font-family: Tahoma, Verdana, Arial, sans-serif; }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
```

### **5. 로그 확인**

```bash
docker logs nginx

# 결과
nginx 04:30:24.11 INFO  ==> 
nginx 04:30:24.11 INFO  ==> Welcome to the Bitnami nginx container
nginx 04:30:24.11 INFO  ==> Subscribe to project updates by watching https://github.com/bitnami/containers
nginx 04:30:24.11 INFO  ==> NOTICE: Starting August 28th, 2025, only a limited subset of images/charts will remain available for free. Backup will be available for some time at the 'Bitnami Legacy' repository. More info at https://github.com/bitnami/containers/issues/83267
nginx 04:30:24.12 INFO  ==> 
nginx 04:30:24.12 INFO  ==> ** Starting NGINX setup **
nginx 04:30:24.13 INFO  ==> Validating settings in NGINX_* env vars
Certificate request self-signature ok
subject=CN = example.com
nginx 04:30:24.78 INFO  ==> No custom scripts in /docker-entrypoint-initdb.d
nginx 04:30:24.78 INFO  ==> Initializing NGINX
realpath: /bitnami/nginx/conf/vhosts: No such file or directory
nginx 04:30:24.80 INFO  ==> ** NGINX setup finished! **

nginx 04:30:24.81 INFO  ==> ** Starting NGINX **
172.17.0.1 - - [25/Oct/2025:04:30:41 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.16.0" "-"
```

### **6. 정리(삭제)**

```bash
docker rm -f nginx
```

---

## **📥 Deploying a Chart from a Repository**

### **1. 레포지토리 추가**

```bash
helm repo add bitnami https://charts.bitnami.com/bitnami

# 결과
"bitnami" has been added to your repositories
```

### **2. 레포지토리 목록 확인**

```bash
helm repo list

NAME                	URL                                               
bitnami             	https://charts.bitnami.com/bitnami                
```

### **3. 차트 검색**

```bash
helm search repo postgresql

NAME                                             	CHART VERSION	APP VERSION	DESCRIPTION                                       
bitnami/postgresql                               	18.1.1       	18.0.0     	PostgreSQL (Postgres) is an open source object-...
bitnami/postgresql-ha                            	16.3.2       	17.6.0     	This PostgreSQL cluster solution includes the P...
bitnami/cloudnative-pg                           	1.0.11       	1.26.1     	CloudNativePG is an open-source tool for managi...
bitnami/supabase                                 	5.3.6        	1.24.7     	DEPRECATED Supabase is an open source Firebase ...
bitnami/minio-operator                           	0.2.9        	7.1.1      	MinIO(R) Operator is a Kubernetes-native tool f...
```

### **4. 차트 배포**

```bash
helm install my-db \
--set postgresql.postgresqlUsername=my-default,postgresql.postgresqlPassword=postgres,postgresql.postgresqlDatabase=mydb,postgresql.persistence.enabled=false \
bitnami/postgresql

# 결과
bitnami/postgresql
NAME: my-db
LAST DEPLOYED: Sat Oct 25 13:42:05 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: postgresql
CHART VERSION: 18.1.1
APP VERSION: 18.0.0
...
```

### **5. 릴리스 목록 확인**

```bash
helm list

# 결과
NAME  	NAMESPACE	REVISION	UPDATED                                	STATUS  	CHART            	APP VERSION
my-db 	default  	1       	2025-10-25 13:42:05.165856775 +0900 KST	deployed	postgresql-18.1.1	18.0.0     
pacman	default  	3       	2025-10-25 13:17:22.363146125 +0900 KST	deployed	pacman-0.1.0     	1.0.0      
```

### **6. 쿠버네티스 리소스 확인**

```bash
kubectl get sts,pod,svc,ep,secret

# 결과
NAME                                READY   AGE
statefulset.apps/my-db-postgresql   1/1     57s

NAME                          READY   STATUS    RESTARTS   AGE
pod/my-db-postgresql-0        1/1     Running   0          57s
pod/pacman-576769bb86-gvgv4   1/1     Running   0          25m

NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/kubernetes            ClusterIP   10.96.0.1      <none>        443/TCP    69m
service/my-db-postgresql      ClusterIP   10.96.175.98   <none>        5432/TCP   57s
service/my-db-postgresql-hl   ClusterIP   None           <none>        5432/TCP   57s
service/pacman                ClusterIP   10.96.36.104   <none>        8080/TCP   32m

NAME                            ENDPOINTS          AGE
endpoints/kubernetes            172.18.0.2:6443    69m
endpoints/my-db-postgresql      10.244.0.11:5432   57s
endpoints/my-db-postgresql-hl   10.244.0.11:5432   57s
endpoints/pacman                10.244.0.9:8080    32m

NAME                                  TYPE                 DATA   AGE
secret/my-db-postgresql               Opaque               1      57s
secret/sh.helm.release.v1.my-db.v1    helm.sh/release.v1   1      57s
secret/sh.helm.release.v1.pacman.v1   helm.sh/release.v1   1      32m
secret/sh.helm.release.v1.pacman.v2   helm.sh/release.v1   1      29m
secret/sh.helm.release.v1.pacman.v3   helm.sh/release.v1   1      25m
```

### **7. 서드 파티 차트 값 확인 방법**

```bash
helm show values bitnami/postgresql

# 결과
# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

## @section Global parameters
## Please, note that this will override the parameters, including dependencies, configured to use the global value
##
global:
  ## @param global.imageRegistry Global Docker image registry
  ##
  imageRegistry: ""
  ## @param global.imagePullSecrets Global Docker registry secret names as an array
  ## e.g.
  ## imagePullSecrets:
  ##   - myRegistryKeySecretName
  ##
  imagePullSecrets: []
  ## @param global.defaultStorageClass Global default StorageClass for Persistent Volume(s)
## @param global.storageClass DEPRECATED: use global.defaultStorageClass instead
  ##
  defaultStorageClass: ""
  storageClass: ""
  ## Security parameters
  ##
  security:
    ## @param global.security.allowInsecureImages Allows skipping image verification
    allowInsecureImages: false
  postgresql:
    ## @param global.postgresql.fullnameOverride Full chart name (overrides `fullnameOverride`)
    ## @param global.postgresql.auth.postgresPassword Password for the "postgres" admin user (overrides `auth.postgresPassword`)
    ## @param global.postgresql.auth.username Name for a custom user to create (overrides `auth.username`)
    ## @param global.postgresql.auth.password Password for the custom user to create (overrides `auth.password`)
    ## @param global.postgresql.auth.database Name for a custom database to create (overrides `auth.database`)
    ## @param global.postgresql.auth.existingSecret Name of existing secret to use for PostgreSQL credentials (overrides `auth.existingSecret`).
    ## @param global.postgresql.auth.secretKeys.adminPasswordKey Name of key in existing secret to use for PostgreSQL credentials (overrides `auth.secretKeys.adminPasswordKey`). Only used when `global.postgresql.auth.existingSecret` is set.
    ## @param global.postgresql.auth.secretKeys.userPasswordKey Name of key in existing secret to use for PostgreSQL credentials (overrides `auth.secretKeys.userPasswordKey`). Only used when `global.postgresql.auth.existingSecret` is set.
    ## @param global.postgresql.auth.secretKeys.replicationPasswordKey Name of key in existing secret to use for PostgreSQL credentials (overrides `auth.secretKeys.replicationPasswordKey`). Only used when `global.postgresql.auth.existingSecret` is set.
    ##
    fullnameOverride: ""
    
    auth:
      postgresPassword: ""
      username: ""
      password: ""
      database: ""
      existingSecret: ""
      secretKeys:
        adminPasswordKey: ""
        userPasswordKey: ""
        replicationPasswordKey: ""
    ## @param global.postgresql.service.ports.postgresql PostgreSQL service port (overrides `service.ports.postgresql`)
    ##
    service:
      ports:
        postgresql: ""
...
```

- 기본값과 오버라이드 가능한 파라미터를 직접 파일로 보지 못하므로 `helm show values` 사용

### **8. 실습 후 제거**

```bash
helm uninstall my-db
release "my-db" uninstalled
```

---

## **🔍 Deploying a Chart with a Dependency**

### **1. 차트 스켈레톤 생성**

```bash
cd ..
mkdir music
mkdir music/templates
cd music
```

### **2. 도전과제2. music helm 배포 실패 해결**

**(1) Deployment 템플릿 작성 (DB 대기 포함)**

```bash
cat << 'EOF' > templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Chart.Name}}
  labels:
    app.kubernetes.io/name: {{ .Chart.Name}}
    {{- if .Chart.AppVersion }}
    app.kubernetes.io/version: {{ .Chart.AppVersion | quote }}
    {{- end }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ .Chart.Name}}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name}}
    spec:
      initContainers:
        - name: wait-db
          image: postgres:16
          command: ["sh","-c"]
          args: ["until pg_isready -h {{ .Release.Name }}-postgresql -p 5432 -t 5; do echo waiting for db; sleep 2; done"]
      containers:
        - image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion}}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          name: {{ .Chart.Name}}
          ports:
            - containerPort: {{ .Values.image.containerPort }}
              name: http
              protocol: TCP
          env:
            - name: QUARKUS_DATASOURCE_JDBC_URL
              value: {{ .Values.postgresql.server | quote }}
            - name: QUARKUS_DATASOURCE_USERNAME
              value: {{ .Values.postgresql.postgresqlUsername | quote }}
            - name: QUARKUS_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.secretName | default (printf "%s-postgresql" ( .Release.Name )) | quote }}
                  key: {{ .Values.postgresql.secretKey }}
EOF
```

**(2) DB 초기화 Job 템플릿 작성 (Hook)**

```bash
cat << 'EOF' > templates/db-init-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-db-init
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 12
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ .Chart.Name }}
    spec:
      restartPolicy: OnFailure
      containers:
        - name: psql
          image: postgres:16
          env:
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgresql.secretName | default (printf "%s-postgresql" .Release.Name) | quote }}
                  key: {{ .Values.postgresql.secretKey }}
          command: ["bash","-lc"]
          args:
            - |
              set -euo pipefail
              DBNAME='{{ .Values.postgresql.postgresqlDatabase | default "mydb" }}'
              PGUSER='{{ .Values.postgresql.postgresqlUsername | default "postgres" }}'
              PGHOST='{{ printf "%s-postgresql" .Release.Name }}'
              export PGHOST PGUSER

              echo "Waiting for postgres at ${PGHOST}..."
              until pg_isready -h "${PGHOST}" -p 5432 -U "${PGUSER}" -t 5; do
                echo "postgres not ready yet, retrying..."
                sleep 2
              done

              echo "Ensuring database '${DBNAME}' on ${PGHOST} as ${PGUSER}"
              psql -tc "SELECT 1 FROM pg_database WHERE datname='${DBNAME}';" | grep -q 1 || \
              psql -c "CREATE DATABASE \"${DBNAME}\";"
EOF
```

**(3) Service 템플릿 작성**

```bash
cat << 'EOF' > templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
  name: {{ .Chart.Name }}
spec:
  ports:
    - name: http
      port: {{ .Values.image.containerPort }}
      targetPort: {{ .Values.image.containerPort }}
  selector:
    app.kubernetes.io/name: {{ .Chart.Name }}
EOF
```

**(4) `Chart.yaml`에 의존성 선언**

```bash
cat << 'EOF' > Chart.yaml
apiVersion: v2
name: music
description: A Helm chart for Music service
type: application
version: 0.1.0
appVersion: "1.0.0"
dependencies:
  - name: postgresql
    version: 18.0.17
    repository: "https://charts.bitnami.com/bitnami"
EOF
```

**(5) values.yaml 구성**

```bash
cat << 'EOF' > values.yaml
image:
  repository: quay.io/gitops-cookbook/music
  tag: "1.0.0"
  pullPolicy: Always
  containerPort: 8080

replicaCount: 1

postgresql:
  server: jdbc:postgresql://music-db-postgresql:5432/mydb
  postgresqlUsername: postgres
  postgresqlDatabase: mydb
  secretName: music-db-postgresql
  secretKey: postgres-password   # Bitnami + postgres 사용자 기본 키
EOF
```

### **3. 디렉터리 확인**

```bash
tree
.
├── Chart.yaml
├── templates
│   ├── db-init-job.yaml
│   ├── deployment.yaml
│   └── service.yaml
└── values.yaml

2 directories, 5 files
```

### **4. 의존성 다운로드**

```bash
helm dependency update

# 결과
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "bitnami" chart repository
Update Complete. ⎈Happy Helming!⎈
Saving 1 charts
Downloading postgresql from repo https://charts.bitnami.com/bitnami
Pulled: registry-1.docker.io/bitnamicharts/postgresql:18.0.17
Digest: sha256:84b63af46f41ac35e3cbcf098e8cf124211c250807cfed43f7983c39c6e30b72
Deleting outdated charts
```

```bash
tree
.
├── Chart.lock
├── charts
│   └── postgresql-18.0.17.tgz
├── Chart.yaml
├── templates
│   ├── db-init-job.yaml
│   ├── deployment.yaml
│   └── service.yaml
└── values.yaml

3 directories, 7 files
```

- `charts/postgresql-18.0.17.tgz`
- `Chart.lock` 생성 및 다이제스트 고정

### **5. 렌더 & 문법 사전검증(드라이런)**

```bash
helm template music-db . | kubectl apply --dry-run=client -f -

# 결과
networkpolicy.networking.k8s.io/music-db-postgresql created (dry run)
poddisruptionbudget.policy/music-db-postgresql created (dry run)
serviceaccount/music-db-postgresql created (dry run)
secret/music-db-postgresql created (dry run)
service/music-db-postgresql-hl created (dry run)
service/music-db-postgresql created (dry run)
service/music created (dry run)
deployment.apps/music created (dry run)
statefulset.apps/music-db-postgresql created (dry run)
job.batch/music-db-db-init created (dry run)
```

### **6. 설치(대기/타임아웃 포함)**

```bash
helm upgrade --install music-db . --wait --timeout 5m

# 결과
Release "music-db" does not exist. Installing it now.
NAME: music-db
LAST DEPLOYED: Sat Oct 25 16:30:24 2025
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

### **7. 리소스 상태 점검**

```bash
kubectl get sts,pod,svc,ep,secret,pv,pvc

# 결과
NAME                                   READY   AGE
statefulset.apps/music-db-postgresql   1/1     50s

NAME                          READY   STATUS    RESTARTS   AGE
pod/music-6cf5758b57-qn4nl    1/1     Running   0          50s
pod/music-db-postgresql-0     1/1     Running   0          50s
pod/pacman-576769bb86-gvgv4   1/1     Running   0          3h13m

NAME                             TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
service/kubernetes               ClusterIP   10.96.0.1       <none>        443/TCP    3h57m
service/music                    ClusterIP   10.96.177.103   <none>        8080/TCP   50s
service/music-db-postgresql      ClusterIP   10.96.86.68     <none>        5432/TCP   50s
service/music-db-postgresql-hl   ClusterIP   None            <none>        5432/TCP   50s
service/pacman                   ClusterIP   10.96.36.104    <none>        8080/TCP   3h20m

NAME                               ENDPOINTS          AGE
endpoints/kubernetes               172.18.0.2:6443    3h57m
endpoints/music                    10.244.0.39:8080   50s
endpoints/music-db-postgresql      10.244.0.41:5432   50s
endpoints/music-db-postgresql-hl   10.244.0.41:5432   50s
endpoints/pacman                   10.244.0.9:8080    3h20m

NAME                                    TYPE                 DATA   AGE
secret/music-db-postgresql              Opaque               1      50s
secret/sh.helm.release.v1.music-db.v1   helm.sh/release.v1   1      50s
secret/sh.helm.release.v1.pacman.v1     helm.sh/release.v1   1      3h20m
secret/sh.helm.release.v1.pacman.v2     helm.sh/release.v1   1      3h17m
secret/sh.helm.release.v1.pacman.v3     helm.sh/release.v1   1      3h13m

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-7346aabd-297e-4ad8-b163-d39e97b0881d   8Gi        RWO            Delete           Bound    default/data-music-db-postgresql-0   standard       <unset>                          47s

NAME                                               STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/data-music-db-postgresql-0   Bound    pvc-7346aabd-297e-4ad8-b163-d39e97b0881d   8Gi        RWO            standard       <unset>                 50s
```

### **8. 애플리케이션 확인(포트포워딩)**

```bash
kubectl port-forward service/music 8080:8080

# 결과
Forwarding from 127.0.0.1:8080 -> 8080
Forwarding from [::1]:8080 -> 8080
Handling connection for 8080
```

```bash
curl -s http://localhost:8080/song

# 결과
[{"id":1,"artist":"DT","name":"Quiero Munchies"},{"id":2,"artist":"Lin-Manuel Miranda","name":"We Don't Talk About Bruno"},{"id":3,"artist":"Imagination","name":"Just An Illusion"},{"id":4,"artist":"Txarango","name":"Tanca Els Ulls"},{"id":5,"artist":"Halsey","name":"Could Have Been Me"}]
```

### **9. 정리(언인스톨 & 스토리지 해제)**

```bash
helm uninstall music-db        
release "music-db" uninstalled
```

```bash
kubectl delete pvc --all
persistentvolumeclaim "data-music-db-postgresql-0" deleted from default namespace
```

---

## **🔧 Install Tekton**

### **1. Tekton Pipeline 설치**

```bash
kubectl apply -f https://storage.googleapis.com/tekton-releases/pipeline/latest/release.yaml
```

### **2. Tekton Pipeline 설치 확인**

```bash
kubectl get crd

# 결과                  
NAME                                       CREATED AT
customruns.tekton.dev                      2025-10-25T07:49:14Z
pipelineruns.tekton.dev                    2025-10-25T07:49:14Z
pipelines.tekton.dev                       2025-10-25T07:49:14Z
resolutionrequests.resolution.tekton.dev   2025-10-25T07:49:14Z
stepactions.tekton.dev                     2025-10-25T07:49:14Z
taskruns.tekton.dev                        2025-10-25T07:49:15Z
tasks.tekton.dev                           2025-10-25T07:49:14Z
verificationpolicies.tekton.dev            2025-10-25T07:49:15Z
```

```bash
kubectl get ns | grep tekton

# 결과
tekton-pipelines             Active   86s
tekton-pipelines-resolvers   Active   85s
```

```bash
kubectl get all -n tekton-pipelines

# 결과
NAME                                               READY   STATUS    RESTARTS   AGE
pod/tekton-events-controller-99665746c-6qhvv       1/1     Running   0          2m27s
pod/tekton-pipelines-controller-7595d6585d-hg2lh   1/1     Running   0          2m27s
pod/tekton-pipelines-webhook-5967d74cc4-w2vpv      1/1     Running   0          2m27s

NAME                                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                              AGE
service/tekton-events-controller      ClusterIP   10.96.175.34    <none>        9090/TCP,8008/TCP,8080/TCP           2m27s
service/tekton-pipelines-controller   ClusterIP   10.96.150.58    <none>        9090/TCP,8008/TCP,8080/TCP           2m27s
service/tekton-pipelines-webhook      ClusterIP   10.96.125.255   <none>        9090/TCP,8008/TCP,443/TCP,8080/TCP   2m27s

NAME                                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tekton-events-controller      1/1     1            1           2m27s
deployment.apps/tekton-pipelines-controller   1/1     1            1           2m27s
deployment.apps/tekton-pipelines-webhook      1/1     1            1           2m27s

NAME                                                     DESIRED   CURRENT   READY   AGE
replicaset.apps/tekton-events-controller-99665746c       1         1         1       2m27s
replicaset.apps/tekton-pipelines-controller-7595d6585d   1         1         1       2m27s
replicaset.apps/tekton-pipelines-webhook-5967d74cc4      1         1         1       2m27s

NAME                                                           REFERENCE                             TARGETS               MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/tekton-pipelines-webhook   Deployment/tekton-pipelines-webhook   cpu: <unknown>/100%   1         5         1          2m27s
```

```bash
kubectl get all -n tekton-pipelines-resolvers

# 결과
NAME                                                     READY   STATUS    RESTARTS   AGE
pod/tekton-pipelines-remote-resolvers-86f56b6664-frrqj   1/1     Running   0          3m11s

NAME                                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
service/tekton-pipelines-remote-resolvers   ClusterIP   10.96.172.248   <none>        9090/TCP,8008/TCP,8080/TCP   3m11s

NAME                                                READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tekton-pipelines-remote-resolvers   1/1     1            1           3m11s

NAME                                                           DESIRED   CURRENT   READY   AGE
replicaset.apps/tekton-pipelines-remote-resolvers-86f56b6664   1         1         1       3m11s
```

```bash
kubectl get pod -n tekton-pipelines

# 결과
NAME                                           READY   STATUS    RESTARTS   AGE
tekton-events-controller-99665746c-6qhvv       1/1     Running   0          3m30s
tekton-pipelines-controller-7595d6585d-hg2lh   1/1     Running   0          3m30s
tekton-pipelines-webhook-5967d74cc4-w2vpv      1/1     Running   0          3m30s
```

### **3. Tekton Triggers 설치**

```bash
kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/release.yaml
kubectl apply -f https://storage.googleapis.com/tekton-releases/triggers/latest/interceptors.yaml
```

### **4. Tekton Trigger 설치 확인**

```bash
kubectl get crd | grep triggers

# 결과
clusterinterceptors.triggers.tekton.dev      2025-10-25T07:53:44Z
clustertriggerbindings.triggers.tekton.dev   2025-10-25T07:53:44Z
eventlisteners.triggers.tekton.dev           2025-10-25T07:53:44Z
interceptors.triggers.tekton.dev             2025-10-25T07:53:44Z
triggerbindings.triggers.tekton.dev          2025-10-25T07:53:44Z
triggers.triggers.tekton.dev                 2025-10-25T07:53:44Z
triggertemplates.triggers.tekton.dev         2025-10-25T07:53:44Z
```

```bash
kubectl get deploy -n tekton-pipelines | grep triggers

# 결과
tekton-triggers-controller          1/1     1            1           89s
tekton-triggers-core-interceptors   1/1     1            1           88s
tekton-triggers-webhook             1/1     1            1           89s
```

### **5. Tekton Dashboard 설치**

```bash
kubectl apply -f https://storage.googleapis.com/tekton-releases/dashboard/latest/release.yaml

# 결과
customresourcedefinition.apiextensions.k8s.io/extensions.dashboard.tekton.dev created
serviceaccount/tekton-dashboard created
role.rbac.authorization.k8s.io/tekton-dashboard-info created
clusterrole.rbac.authorization.k8s.io/tekton-dashboard-backend-edit created
clusterrole.rbac.authorization.k8s.io/tekton-dashboard-backend-view created
clusterrole.rbac.authorization.k8s.io/tekton-dashboard-tenant-view created
rolebinding.rbac.authorization.k8s.io/tekton-dashboard-info created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-backend-view created
configmap/dashboard-info created
service/tekton-dashboard created
deployment.apps/tekton-dashboard created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-tenant-view created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-pipelines-view created
clusterrolebinding.rbac.authorization.k8s.io/tekton-dashboard-triggers-view created
```

### **6. Tekton Dashboard 상태 확인**

```bash
kubectl get crd | grep dashboard

extensions.dashboard.tekton.dev              2025-10-25T07:56:57Z
```

```bash
kubectl get deploy -n tekton-pipelines
                
NAME                                READY   UP-TO-DATE   AVAILABLE   AGE
tekton-dashboard                    1/1     1            1           80s
...
```

```bash
kubectl get svc,ep -n tekton-pipelines tekton-dashboard
NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/tekton-dashboard   ClusterIP   10.96.31.229   <none>        9097/TCP   2m5s

NAME                         ENDPOINTS          AGE
endpoints/tekton-dashboard   10.244.0.51:9097   2m5s
```

```bash
kubectl get svc -n tekton-pipelines tekton-dashboard -o yaml | kubectl neat | yq
{
  "apiVersion": "v1",
  "kind": "Service",
  "metadata": {
    "labels": {
      "app": "tekton-dashboard",
      "app.kubernetes.io/component": "dashboard",
      "app.kubernetes.io/instance": "default",
      "app.kubernetes.io/name": "dashboard",
      "app.kubernetes.io/part-of": "tekton-dashboard",
      "app.kubernetes.io/version": "v0.62.0",
      "dashboard.tekton.dev/release": "v0.62.0",
      "version": "v0.62.0"
    },
    "name": "tekton-dashboard",
    "namespace": "tekton-pipelines"
  },
  "spec": {
    "clusterIP": "10.96.31.229",
    "clusterIPs": [
      "10.96.31.229"
    ],
    "ipFamilies": [
      "IPv4"
    ],
    "ipFamilyPolicy": "SingleStack",
    "ports": [
      {
        "name": "http",
        "port": 9097
      }
    ],
    "selector": {
      "app.kubernetes.io/component": "dashboard",
      "app.kubernetes.io/instance": "default",
      "app.kubernetes.io/name": "dashboard",
      "app.kubernetes.io/part-of": "tekton-dashboard"
    }
  }
}
```

### **7. Tekton Dashboard NodePort 노출**

```bash
kubectl patch svc -n tekton-pipelines tekton-dashboard -p '{"spec":{"type":"NodePort","ports":[{"port":9097,"targetPort":9097,"nodePort":30000}]}}'

# 결과
service/tekton-dashboard patched
```

```bash
kubectl get svc,ep -n tekton-pipelines tekton-dashboard

# 결과
NAME                       TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/tekton-dashboard   NodePort   10.96.31.229   <none>        9097:30000/TCP   7m10s

NAME                         ENDPOINTS          AGE
endpoints/tekton-dashboard   10.244.0.51:9097   7m10s
```

- `9097:30000/TCP`

`http://localhost:30000`로 대시보드 접근
![](https://velog.velcdn.com/images/tlsalswls123/post/1a19e584-4774-41da-9b7e-894d47555a0e/image.png)

### **8. Tekton CLI 설치(Arch Linux)**

```bash
sudo pacman -Syu tekton-cli
tkn version

# 결과
Client version: 0.33.0
Pipeline version: v1.5.0
Triggers version: v0.33.0
Dashboard version: v0.62.0
```

---

## **👋 Create a Hello World Task**

### **1. Task 리소스 스펙 확인**

```bash
kubectl explain tasks.tekton.dev

# 결과
GROUP:      tekton.dev
KIND:       Task
VERSION:    v1
...
```

### **2. Task 생성**

```bash
cat << EOF | kubectl apply -f -
apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: hello
spec:
  steps:
    - name: echo    # step 이름
      image: alpine # step 수행 컨테이너 이미지
      script: |
        #!/bin/sh
        echo "Hello World"
EOF

# 결과
task.tekton.dev/hello created
```

### **3. Task 목록 확인**

```bash
tkn task list

# 결과
NAME    DESCRIPTION   AGE
hello                 35 seconds ago
```

### **4. 생성 리소스 확인(JSON/YAML)**

```bash
kubectl get tasks -o yaml | kubectl neat | yq

{
  "apiVersion": "v1",
  "items": [
    {
      "apiVersion": "tekton.dev/v1",
      "kind": "Task",
      "metadata": {
        "name": "hello",
        "namespace": "default"
      },
      "spec": {
        "steps": [
          {
            "image": "alpine",
            "name": "echo",
            "script": "#!/bin/sh\necho \"Hello World\"\n"
          }
        ]
      }
    }
  ],
  "kind": "List",
  "metadata": {}
}
```

### **5. 대시보드에서 Task 확인**

![](https://velog.velcdn.com/images/tlsalswls123/post/60407cf0-feac-488e-9402-2bfdc4b7daee/image.png)

### **6. 파드 상태 모니터링**

```bash
kubectl get pod -w
```

### **7. Task 실행 (tkn)**

```bash
tkn task start --showlog hello
```

✅ **출력**
![](https://velog.velcdn.com/images/tlsalswls123/post/30b0c2d7-9965-47ca-ab76-606b3198f24e/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/25a181b8-4cf0-429e-94aa-3b733a8cfb95/image.png)
```bash
TaskRun started: hello-run-zmcrx
Waiting for logs to be available...
[echo] Hello World
```

### **8. 파드 상세(Init 컨테이너 포함)**

```bash
kubectl describe pod -l tekton.dev/task=hello
```

✅ **출력**

```bash
Init Containers:
  prepare:
    Container ID:  containerd://d1808b262006d24f4087ea30b11f89749d4e1c88d5bae6277fe4ef615c93a359
    Image:         ghcr.io/tektoncd/pipeline/entrypoint-bff0a22da108bc2f16c818c97641a296:v1.5.0@sha256:ff5ee925ff7b08853cc4caa93e5e3e0ee761a2db6ae0a1ae6a0f6f120f170b56
    ...
  place-scripts:
    Container ID:  containerd://fea7fa128981845f6446c722a799d549473ed41bce1407d9c5fbfd8b16d298bd
    Image:         cgr.dev/chainguard/busybox@sha256:19f02276bf8dbdd62f069b922f10c65262cc34b710eea26ff928129a736be791
    ...
Containers:
  step-echo:
    Container ID:  containerd://141ca7131e149fc96b3b6aea900d519ae2517b0e7a14652f653d041cf1abec11
    Image:         alpine
    Image ID:      docker.io/library/alpine@sha256:4b7ce07002c69e8f3d704a9c5d6fd3053be500b7f1c69fc0d80990c2ad8dd412
```

### **9. 컨테이너별 로그 점검**

```bash
kubectl logs -l tekton.dev/task=hello -c prepare
2025/10/25 08:32:54 Entrypoint initialization

kubectl logs -l tekton.dev/task=hello -c place-scripts
2025/10/25 08:32:57 Decoded script /tekton/scripts/script-0-h8svq

kubectl logs -l tekton.dev/task=hello -c step-echo
Hello World
```

### **10. tkn 로그/설명 명령 활용**

```bash
tkn task logs hello

# 결과
Hello World
```

```bash
tkn task describe hello

# 결과
Name:        hello
Namespace:   default

🦶 Steps

 ∙ echo

🗂  Taskruns

NAME              STARTED         DURATION   STATUS
hello-run-zmcrx   6 minutes ago   16s        Succeeded
```

---

## **🗂️ Create a Task to Compile and Package an App from Git**

- https://tekton.dev/docs/how-to-guides/clone-repository/

### **1. 파이프라인 파일 작성**

```bash
cat << EOF | kubectl apply -f -
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: clone-read
spec:
  description: | 
    This pipeline clones a git repo, then echoes the README file to the stout.
  params:     # 매개변수 repo-url
  - name: repo-url
    type: string
    description: The git repo URL to clone from.
  workspaces: # 다운로드할 코드를 저장할 공유 볼륨인 작업 공간을 추가
  - name: shared-data
    description: | 
      This workspace contains the cloned repo files, so they can be read by the
      next task.
  tasks:      # task 정의
  - name: fetch-source
    taskRef:
      name: git-clone
    workspaces:
    - name: output
      workspace: shared-data
    params:
    - name: url
      value: \$(params.repo-url)
EOF

# 결과
pipeline.tekton.dev/clone-read created
```

### **2. 파이프라인 생성 확인**

```bash
tkn pipeline list

# 결과
NAME         AGE              LAST RUN   STARTED   DURATION   STATUS
clone-read   32 seconds ago   ---        ---       ---        ---
```

```bash
tkn pipeline describe

# 결과
Name:          clone-read
Namespace:     default
Description:   This pipeline clones a git repo, then echoes the README file to the stout.

⚓ Params

 NAME         TYPE     DESCRIPTION              DEFAULT VALUE
 ∙ repo-url   string   The git repo URL to...   ---

📂 Workspaces

 NAME            DESCRIPTION              OPTIONAL
 ∙ shared-data   This workspace cont...   false

🗒  Tasks

 NAME             TASKREF     RUNAFTER   TIMEOUT   PARAMS
 ∙ fetch-source   git-clone              ---       url: string
```
![](https://velog.velcdn.com/images/tlsalswls123/post/49a16bfa-71cc-4664-85e6-88a59a2b8907/image.png)

### **3. PipelineRun 생성(실행 인스턴스화)**

```bash
cat << EOF | kubectl create -f -
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: clone-read-run-
spec:
  pipelineRef:
    name: clone-read
  taskRunTemplate:
    podTemplate:
      securityContext:
        fsGroup: 65532
  workspaces: # 작업 공간 인스턴스화, PVC 생성
  - name: shared-data
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
  params:    # 저장소 URL 매개변수 값 설정
  - name: repo-url
    value: https://github.com/tektoncd/website
EOF

# 결과
pipelinerun.tekton.dev/clone-read-run-g89cg created
```

### **4. 초기 실패 진단**

![](https://velog.velcdn.com/images/tlsalswls123/post/40e57ac0-27d0-4001-a650-1d3a50a6c2cd/image.png)
```bash
kubectl get pipelineruns
NAME                   SUCCEEDED   REASON           STARTTIME   COMPLETIONTIME
clone-read-run-g89cg   False       CouldntGetTask   2m10s       2m10s
```

```bash
tkn pipelinerun list
NAME                   STARTED         DURATION   STATUS
clone-read-run-g89cg   2 minutes ago   0s         Failed(CouldntGetTask)
```

```bash
tkn pipelinerun logs clone-read-run-g89cg

# 결과
Pipeline default/clone-read can't be Run; it contains Tasks that don't exist: Couldn't retrieve Task "git-clone": tasks.tekton.dev "git-clone" not found
```
- 파이프라인이 참조하는 `git-clone` Task가 **클러스터에 미설치**

### **5. 누락 Task 설치(테크톤 허브)**

```bash
tkn hub install task git-clone

# 결과
WARN: This version has been deprecated
Task git-clone(0.9) installed in default namespace
```

```bash
kubectl get tasks

# 결과
NAME        AGE
git-clone   27s
hello       28m
```

### **6. PipelineRun 재실행**

```bash
cat << EOF | kubectl create -f -
apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: clone-read-run-
spec:
  pipelineRef:
    name: clone-read
  taskRunTemplate:
    podTemplate:
      securityContext:
        fsGroup: 65532
  workspaces:
  - name: shared-data
    volumeClaimTemplate:
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 1Gi
  params:
  - name: repo-url
    value: https://github.com/tektoncd/website
EOF

# 결과
pipelinerun.tekton.dev/clone-read-run-6zd5t created
```
![](https://velog.velcdn.com/images/tlsalswls123/post/1c9df38c-7e5e-4dbc-b5bf-0663835fd6d4/image.png)

### **7. 실행 산출물/스토리지 확인**

```bash
kubectl get pod,pv,pvc

# 결과
NAME                                        READY   STATUS      RESTARTS   AGE
pod/clone-read-run-6zd5t-fetch-source-pod   0/1     Completed   0          115s
pod/hello-run-zmcrx-pod                     0/1     Completed   0          27m

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-bc02a33b-e54e-458e-a411-db06ca17bed0   1Gi        RWO            Delete           Bound    default/pvc-55505f842f   standard       <unset>                          112s

NAME                                   STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/pvc-55505f842f   Bound    pvc-bc02a33b-e54e-458e-a411-db06ca17bed0   1Gi        RWO            standard       <unset>                 115s
```


