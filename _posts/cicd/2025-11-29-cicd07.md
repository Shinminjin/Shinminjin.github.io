---
title: CI/CD 7ì£¼ì°¨ ì •ë¦¬
date: 2025-11-29 19:00:00 +0900
categories: [CI/CD]
tags: [CI/CD]
---

## **âš™ï¸ ì‹¤ìŠµ í™˜ê²½ êµ¬ì„±**

### **1. Kind K8s í´ëŸ¬ìŠ¤í„° ìƒì„±**

```bash
kind create cluster --name myk8s --image kindest/node:v1.32.8 --config - <<EOF
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
  extraPortMappings:
  - containerPort: 30000 # Vault UI
    hostPort: 30000
  - containerPort: 30001 # Jenkins UI
    hostPort: 30001
  - containerPort: 30002 # DB ë°°í¬(PostgreSQL ë˜ëŠ” MySQL)
    hostPort: 30002
  - containerPort: 30003 # # Sample App
    hostPort: 30003
EOF

Creating cluster "myk8s" ...
 âœ“ Ensuring node image (kindest/node:v1.32.8) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦  
 âœ“ Writing configuration ğŸ“œ 
 âœ“ Starting control-plane ğŸ•¹ï¸ 
 âœ“ Installing CNI ğŸ”Œ 
 âœ“ Installing StorageClass ğŸ’¾ 
Set kubectl context to "kind-myk8s"
You can now use your cluster with:

kubectl cluster-info --context kind-myk8s

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
```

### **2. Kubernetesì— Vault ì„¤ì¹˜ (Helm ì‚¬ìš©)**

**(1) Vault ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ìƒì„±**

```bash
kubectl create namespace vault

namespace/vault created
```

**(2) HashiCorp Helm Repo ë“±ë¡ ë° ì°¨íŠ¸ í™•ì¸**

```bash
helm repo add hashicorp https://helm.releases.hashicorp.com

"hashicorp" has been added to your repositories
```

```bash
helm search repo hashicorp/vault

NAME                            	CHART VERSION	APP VERSION	DESCRIPTION                          
hashicorp/vault                 	0.31.0       	1.20.4     	Official HashiCorp Vault Chart       
hashicorp/vault-secrets-gateway 	0.0.2        	0.1.0      	A Helm chart for Kubernetes          
hashicorp/vault-secrets-operator	1.0.1        	1.0.1      	Official Vault Secrets Operator Chart
```

**(3) Vault Helm values ì •ì˜ (Dev ëª¨ë“œ, NodePort UI)**

```bash
# vault-values-dev.yaml ìƒì„±
cat <<EOF > vault-values-dev.yaml
global:
  enabled: true
  tlsDisable: true

injector:
  enabled: true
  # Sidecar Injectionì„ ìœ„í•´ í•„ìš”í•œ ì„¤ì •

server:
  dev:
    enabled: true
    devRootToken: "root" # í•™ìŠµ í¸ì˜ë¥¼ ìœ„í•´ Root Tokenì„ 'root'ë¡œ ê³ ì •
  
  # ë°ì´í„° ì˜êµ¬ ì €ì¥ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë¹„í™œì„±í™” (Devëª¨ë“œëŠ” ë©”ëª¨ë¦¬ ì‚¬ìš©)
  dataStorage:
    enabled: false

  # UI í™œì„±í™” ë° NodePort ë…¸ì¶œ
  service:
    type: "NodePort"
    nodePort: 30000
    
  ui:
    enabled: true
EOF
```

- Dev ëª¨ë“œë¡œ ë™ì‘í•˜ë„ë¡ ì„¤ì •í•˜ì—¬ í•™ìŠµ í¸ì˜ì„± ìš°ì„ 
- Root Tokenì„ `root`ë¡œ ê³ ì •í•´ì„œ CLIì™€ UIì—ì„œ ë™ì¼í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ êµ¬ì„±í•¨
- ìŠ¤í† ë¦¬ì§€ëŠ” in-memory ì‚¬ìš©ìœ¼ë¡œ ê°„ë‹¨íˆ ì‹¤ìŠµ í™˜ê²½ë§Œ êµ¬ì„±í•¨
- Vault UIë¥¼ NodePort 30000ìœ¼ë¡œ ë…¸ì¶œí•˜ì—¬ ë¡œì»¬ ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •í•¨

**(4) Helmìœ¼ë¡œ Vault ë°°í¬**

```bash
helm upgrade vault hashicorp/vault -n vault -f vault-values-dev.yaml --install

Release "vault" does not exist. Installing it now.
NAME: vault
LAST DEPLOYED: Sat Nov 29 16:09:12 2025
NAMESPACE: vault
STATUS: deployed
REVISION: 1
NOTES:
Thank you for installing HashiCorp Vault!

Now that you have deployed Vault, you should look over the docs on using
Vault with Kubernetes available here:

https://developer.hashicorp.com/vault/docs

Your release is named vault. To learn more about the release, try:

  $ helm status vault
  $ helm get manifest vault
```

**(5) Vault ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ì»¨í…ìŠ¤íŠ¸ ì „í™˜ ë° ë°°í¬ ìƒíƒœ í™•ì¸**

```bash
kubens vault

âœ” Active namespace is "vault"
```

```bash
kubectl get pods,svc,pvc

NAME                                        READY   STATUS    RESTARTS   AGE
pod/vault-0                                 1/1     Running   0          41s
pod/vault-agent-injector-556c5dd8fb-7qbjt   1/1     Running   0          41s

NAME                               TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE
service/vault                      NodePort    10.96.194.160   <none>        8200:30000/TCP,8201:32116/TCP   41s
service/vault-agent-injector-svc   ClusterIP   10.96.32.214    <none>        443/TCP                         41s
service/vault-internal             ClusterIP   None            <none>        8200/TCP,8201/TCP               41s
```

### **3. Vault ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™” ìƒíƒœ ì ê²€**

```bash
kubectl exec -ti vault-0 -- vault status

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.20.4
Build Date      2025-09-23T13:22:38Z
Storage Type    inmem
Cluster Name    vault-cluster-1597f923
Cluster ID      ead5b677-accb-a319-bc9b-9997309c7712
HA Enabled      false
```

### **4. Arch Linuxì—ì„œ Vault CLI ì„¤ì¹˜ ë° ì„¤ì •**

- [https://developer.hashicorp.com/vault/install](https://developer.hashicorp.com/vault/install)

**(1) í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜**

```bash
sudo pacman -Syu --needed gnupg curl
```

**(2) Vault ì„¤ì¹˜**

```bash
sudo pacman -S vault
```

```bash
vault --version
Vault v1.21.0, built 2024-11-29T07:11:16Z (cgo)
```

**(3) VAULT_ADDR í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

```bash
export VAULT_ADDR='http://localhost:30000'
```

**(4) CLIì—ì„œ Vault ìƒíƒœ í™•ì¸**

```bash
vault status

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.20.4
Build Date      2025-09-23T13:22:38Z
Storage Type    inmem
Cluster Name    vault-cluster-1597f923
Cluster ID      ead5b677-accb-a319-bc9b-9997309c7712
HA Enabled      false
```

**(5) Root Token ë¡œê·¸ì¸ ë° ì¸ì¦ í™•ì¸**

```bash
vault login

Token (will be hidden): root
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                root
token_accessor       jCymZER4nmCfHD20cjWgnFhf
token_duration       âˆ
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

### **5. Vault UI ì ‘ì† í™•ì¸**

```bash
http://localhost:30000
root
```
![](https://velog.velcdn.com/images/tlsalswls123/post/c428b5d2-8150-424a-bee5-54327e79cc05/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/c8aac09f-71bc-44f7-9842-282289dae297/image.png)

---

## **ğŸ”‘ Vault KV ì‹œí¬ë¦¿ ì—”ì§„ìœ¼ë¡œ ì •ì  ì‹œí¬ë¦¿ ì €ì¥ ë° ì¡°íšŒ**

### **1. KV ì‹œí¬ë¦¿ ì—”ì§„ ìƒíƒœ í™•ì¸**

```bash
vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_94020688    per-token private secret storage
identity/     identity     identity_d6877608     identity store
secret/       kv           kv_050b6113           key/value secret storage
sys/          system       system_428d6c50       system endpoints used for control, policy and debugging
```
- `secret/` ê²½ë¡œì— KV íƒ€ì… ì‹œí¬ë¦¿ ì—”ì§„ì´ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìŒ
- ì´ˆê¸° ìƒíƒœì—ì„œëŠ” `secret/` ì•„ë˜ì— í‚¤ê°€ ì—†ëŠ” ìƒíƒœì„

![](https://velog.velcdn.com/images/tlsalswls123/post/257996be-ac95-42dd-aedd-839c79c6a16b/image.png)

### **2. KV ì‹œí¬ë¦¿ ì—”ì§„ì— ì •ì  ì‹œí¬ë¦¿ ì €ì¥**

ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •ì„ ìœ„í•œ ìƒ˜í”Œ ì‹œí¬ë¦¿ì„ `secret/sampleapp/config` ê²½ë¡œì— ì €ì¥í•¨

```bash
vault kv put secret/sampleapp/config \
  username="demo" \
  password="p@ssw0rd"

# ê²°ê³¼
======== Secret Path ========
secret/data/sampleapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-11-29T07:15:22.793730231Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
```
![](https://velog.velcdn.com/images/tlsalswls123/post/5d215759-ec59-4bab-aad1-a030ac9e1e41/image.png)

### **3. Secrets Engine í™”ë©´ì—ì„œ Key / Value í™•ì¸**

**(1) [Secrets Engine] íƒ­ ì ‘ì† í›„ [sampleapp - config] ì ‘ì†í•˜ì—¬ ì‹¤ì œ ì €ì¥ëœ Key / Value í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/00ac7f5c-b5c4-49b8-acb4-559f12673298/image.png)

**(2) `vault kv get` ëª…ë ¹ìœ¼ë¡œ ë°ì´í„° í™•ì¸**

```bash
vault kv get secret/sampleapp/config

# ê²°ê³¼
======== Secret Path ========
secret/data/sampleapp/config

======= Metadata =======
Key                Value
---                -----
created_time       2025-11-29T07:15:22.793730231Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    p@ssw0rd
username    demo
```

### **4. REST APIë¡œ KV ì‹œí¬ë¦¿ ì¡°íšŒ**
![](https://velog.velcdn.com/images/tlsalswls123/post/65e6f84f-f2b6-4329-b250-ce789801fa7d/image.png)

```bash
curl -s --header "X-Vault-Token: root" \
  --request GET http://127.0.0.1:30000/v1/secret/data/sampleapp/config | jq

{
  "request_id": "c1b18701-a153-3019-fc6b-df878ba74065",
  "lease_id": "",
  "renewable": false,
  "lease_duration": 0,
  "data": {
    "data": {
      "password": "p@ssw0rd",
      "username": "demo"
    },
    "metadata": {
      "created_time": "2025-11-29T07:15:22.793730231Z",
      "custom_metadata": null,
      "deletion_time": "",
      "destroyed": false,
      "version": 1
    }
  },
  "wrap_info": null,
  "warnings": null,
  "auth": null,
  "mount_type": "kv"
}
```

---

## **ğŸ¤– Vault Agent**

- [https://developer.hashicorp.com/vault/docs/agent-and-proxy/agent](https://developer.hashicorp.com/vault/docs/agent-and-proxy/agent)

### **1. Vault AppRole ì¸ì¦ êµ¬ì„±ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ìš© ê¶Œí•œ ë¶„ë¦¬**

- [https://developer.hashicorp.com/vault/docs/auth/approle](https://developer.hashicorp.com/vault/docs/auth/approle)

**(1) í˜„ì¬ í™œì„±í™”ëœ ì¸ì¦ë°©ì‹ í™•ì¸**

```bash
vault auth list

Path      Type     Accessor               Description                Version
----      ----     --------               -----------                -------
token/    token    auth_token_2e19e80a    token based credentials    n/a
```

**(2) AppRole í™œì„±í™”**

```bash
vault auth enable approle || echo "AppRole already enabled"

Success! Enabled approle auth method at: approle/
```

```bash
vault auth list

Path        Type       Accessor                 Description                Version
----        ----       --------                 -----------                -------
approle/    approle    auth_approle_e1e3b07f    n/a                        n/a
token/      token      auth_token_2e19e80a      token based credentials    n/a
```

**(3) sampleappìš© ì½ê¸° ì „ìš© ì •ì±… ìƒì„±**

```bash
vault policy write sampleapp-policy - <<EOF
path "secret/data/sampleapp/*" {
  capabilities = ["read"]
}
EOF

Success! Uploaded policy: sampleapp-policy
```

**(4) AppRole Role ìƒì„±**

- ì•ì„œ ë§Œë“  `sampleapp-policy` ë¥¼ Roleì— ì—°ê²°

```bash
vault write auth/approle/role/sampleapp-role \
  token_policies="sampleapp-policy" \
  secret_id_ttl="1h" \
  token_ttl="1h" \
  token_max_ttl="4h"

Success! Data written to: auth/approle/role/sampleapp-role
```

**(5) Role ID ë° Secret ID ì¶”ì¶œ ë° ì €ì¥**

```bash
ROLE_ID=$(vault read -field=role_id auth/approle/role/sampleapp-role/role-id)
SECRET_ID=$(vault write -f -field=secret_id auth/approle/role/sampleapp-role/secret-id)
echo "ROLE_ID: $ROLE_ID"
echo "SECRET_ID: $SECRET_ID"

ROLE_ID: f7165557-3127-151e-f46b-6895400f0cb9
SECRET_ID: 0dc675d7-16a4-ea02-6edf-947ecf1df3a8
```

```bash
mkdir -p approle-creds
echo "$ROLE_ID" > approle-creds/role_id.txt
echo "$SECRET_ID" > approle-creds/secret_id.txt
```

**(6) Kubernetes Secretìœ¼ë¡œ AppRole ìê²©ì¦ëª… ì €ì¥**

- Vault Agentê°€ ì½ì„ ìˆ˜ ìˆë„ë¡ K8s Secret ìƒì„±

```bash
kubectl create secret generic vault-approle -n vault \
  --from-literal=role_id="${ROLE_ID}" \
  --from-literal=secret_id="${SECRET_ID}" \
  --save-config \
  --dry-run=client -o yaml | kubectl apply -f -

secret/vault-approle created
```

### **2. Vault Agent Sidecar êµ¬ì„±ìœ¼ë¡œ ì‹œí¬ë¦¿ ìë™ ë Œë”ë§**

**(1) Vault Agent ì„¤ì • ConfigMap ìƒì„± (`vault-agent-config.hcl`)**

```bash
cat <<EOF | kubectl create configmap vault-agent-config -n vault --from-file=agent-config.hcl=/dev/stdin --dry-run=client -o yaml | kubectl apply -f -
vault {
  address = "http://vault.vault.svc:8200"
}

auto_auth {
  method "approle" {
    config = {
      role_id_file_path = "/etc/vault/approle/role_id"
      secret_id_file_path = "/etc/vault/approle/secret_id"
      remove_secret_id_file_after_reading = false
    }
  }

  sink "file" {
    config = {
      path = "/etc/vault-agent-token/token"
    }
  }
}

template_config {
  static_secret_render_interval = "20s"
}

template {
  destination = "/etc/secrets/index.html"
  contents = <<EOH
  <html>
  <body>
    <p>username: {{ with secret "secret/data/sampleapp/config" }}{{ .Data.data.username }}{{ end }}</p>
    <p>password: {{ with secret "secret/data/sampleapp/config" }}{{ .Data.data.password }}{{ end }}</p>
  </body>
  </html>
EOH
}
EOF

configmap/vault-agent-config created
```

**(2) Nginx + Vault Agent Sidecar Deployment ë°°í¬**

```bash
kubectl apply -n vault -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-vault-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx-vault-demo
  template:
    metadata:
      labels:
        app: nginx-vault-demo
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html-volume
          mountPath: /usr/share/nginx/html
      - name: vault-agent-sidecar
        image: hashicorp/vault:latest
        args:
          - "agent"
          - "-config=/etc/vault/agent-config.hcl"
        volumeMounts:
        - name: vault-agent-config
          mountPath: /etc/vault
        - name: vault-approle
          mountPath: /etc/vault/approle
        - name: vault-token
          mountPath: /etc/vault-agent-token
        - name: html-volume
          mountPath: /etc/secrets
      volumes:
      - name: vault-agent-config
        configMap:
          name: vault-agent-config
      - name: vault-approle
        secret:
          secretName: vault-approle
      - name: vault-token
        emptyDir: {}
      - name: html-volume
        emptyDir: {}
EOF

deployment.apps/nginx-vault-demo created
```

**(3) Service(NodePort) ìƒì„±**

```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app: nginx-vault-demo
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30001 # Kindì—ì„œ ì„¤ì •í•œ Port
EOF

service/nginx-service created
```

**(4) ìƒì„±ëœ ì»¨í…Œì´ë„ˆ í™•ì¸**

- `2/2` ë¡œ ë©”ì¸ ì»¨í…Œì´ë„ˆ + ì‚¬ì´ë“œì¹´ ì»¨í…Œì´ë„ˆê°€ ì •ìƒ ê¸°ë™ëœ ìƒíƒœ í™•ì¸í•¨

```bash
kubectl get pod -l app=nginx-vault-demo

NAME                                READY   STATUS    RESTARTS   AGE
nginx-vault-demo-7776649597-nhjwx   2/2     Running   0          25s
```

- `nginx` ì™€ `vault-agent-sidecar` ë‘ ì»¨í…Œì´ë„ˆê°€ ê°™ì€ íŒŒë“œì—ì„œ ë™ì‘ ì¤‘ì¸ ê²ƒ í™•ì¸í•¨

```bash
kubectl describe pod -l app=nginx-vault-demo

...
Containers:
  nginx:
    Container ID:   containerd://90164913f860373c20944e6ecd7d7c0cbc2cf56a51fbaddbfcdb2791397ceffb
    Image:          nginx:latest
  ...
  vault-agent-sidecar:
    Container ID:  containerd://cd1d2ea7a5791e22a2edae0e21dde14986a43f4730761822325aa405175f4c4b
    Image:         hashicorp/vault:latest
    Image ID:      docker.io/hashicorp/vault@sha256:f4e2687b72858a9e2160c344c9fa1ef74c07f21a89a8c00534ab64d3f187b927
    Port:          <none>
    Host Port:     <none>
    Args:
      agent
      -config=/etc/vault/agent-config.hcl
...
```

- mutating admission

```bash
kubectl get mutatingwebhookconfigurations.admissionregistration.k8s.io   

NAME                       WEBHOOKS   AGE
vault-agent-injector-cfg   1          13m
```

**(5) Vault Agent ë™ì‘ ë° ë§ˆìš´íŠ¸ íŒŒì¼ ê²€ì¦**

- Vault Agent ë„ì›€ë§ í™•ì¸

```bash
kubectl exec -it -n vault deploy/nginx-vault-demo -c vault-agent-sidecar -- vault agent -h

Usage: vault agent [options]

  This command starts a Vault Agent that can perform automatic authentication
  in certain environments.

  Start an agent with a configuration file:

      $ vault agent -config=/etc/vault/config.hcl
...
```

- ë§ˆìš´íŠ¸ëœ íŒŒì¼ë“¤ í™•ì¸

```bash
kubectl  exec -it -n vault deploy/nginx-vault-demo -c vault-agent-sidecar -- cat /etc/vault/agent-config.hcl 

vault {
  address = "http://vault.vault.svc:8200"
}

auto_auth {
  method "approle" {
    config = {
      role_id_file_path = "/etc/vault/approle/role_id"
      secret_id_file_path = "/etc/vault/approle/secret_id"
      remove_secret_id_file_after_reading = false
    }
  }

  sink "file" {
    config = {
      path = "/etc/vault-agent-token/token"
    }
  }
}

template_config {
  static_secret_render_interval = "20s"
}

template {
  destination = "/etc/secrets/index.html"
  contents = <<EOH
  <html>
  <body>
    <p>username: {{ with secret "secret/data/sampleapp/config" }}{{ .Data.data.username }}{{ end }}</p>
    <p>password: {{ with secret "secret/data/sampleapp/config" }}{{ .Data.data.password }}{{ end }}</p>
  </body>
  </html>
EOH
}
```

```bash
kubectl  exec -it -n vault deploy/nginx-vault-demo -c vault-agent-sidecar -- ls -l /etc/vault/approle

total 0
lrwxrwxrwx    1 root     root            14 Nov 29 07:21 role_id -> ..data/role_id
lrwxrwxrwx    1 root     root            16 Nov 29 07:21 secret_id -> ..data/secret_id
```

```bash
kubectl  exec -it -n vault deploy/nginx-vault-demo -c vault-agent-sidecar -- cat /etc/vault/approle/role_id
kubectl  exec -it -n vault deploy/nginx-vault-demo -c vault-agent-sidecar -- cat /etc/vault/approle/secret_id

f7165557-3127-151e-f46b-6895400f0cb9
0dc675d7-16a4-ea02-6edf-947ecf1df3a8
```

**(6) Nginxê°€ ì„œë¹™í•˜ëŠ” index.html ë‚´ìš© í™•ì¸**

```bash
kubectl exec -it -n vault deploy/nginx-vault-demo -c nginx -- ls -l /usr/share/nginx/html 

total 4
-rw-r--r-- 1 100 1000 94 Nov 29 07:21 index.html
```

```bash
kubectl exec -it -n vault deploy/nginx-vault-demo -c nginx -- cat /usr/share/nginx/html/index.html
  
  <html>
  <body>
    <p>username: demo</p>
    <p>password: p@ssw0rd</p>
  </body>
  </html>
```
![](https://velog.velcdn.com/images/tlsalswls123/post/bed01dc6-2339-4870-b27a-8f155d63f456/image.png)

### **3. KV ê°’ ë³€ê²½ ì‹œ Vault Agent í…œí”Œë¦¿ ìë™ ê°±ì‹  í™•ì¸**

**(1) Vault UIì—ì„œ KV ê°’ ë³€ê²½**
- **[Create new version +]  í´ë¦­**

![](https://velog.velcdn.com/images/tlsalswls123/post/70887c70-4de3-45ec-9ff0-c7cebaa0420f/image.png)

- **ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í›„ Save í´ë¦­**

![](https://velog.velcdn.com/images/tlsalswls123/post/d9d261d9-3c84-43a9-82f6-d29028a0c6c3/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/bc2df2a9-13f8-4db3-9ab4-9624fb05cfd9/image.png)

**(2) Vault Agent í…œí”Œë¦¿ ì¬ë Œë”ë§ ê²°ê³¼ í™•ì¸**
![](https://velog.velcdn.com/images/tlsalswls123/post/49fa47f2-7886-4497-83e6-b94e4fc6ae58/image.png)

- ì—…ë°ì´íŠ¸ëœ `index.html` í™•ì¸

```bash
kubectl exec -it -n vault deploy/nginx-vault-demo -c nginx -- cat /usr/share/nginx/html/index.html
  
  <html>
  <body>
    <p>username: demo</p>
    <p>password: new-p@ssw0rd</p>
  </body>
  </html>
```

### **4. ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
kubectl delete deployment/nginx-vault-demo \
                service/nginx-service \
                secret/vault-approle -n vault
```

---

## **ğŸ§© Jenkins + KV ì‹œí¬ë¦¿**

### **1. Jenkins ì»¨í…Œì´ë„ˆ ì‚¬ì „êµ¬ì„±**

**(1) Jenkins ì»¨í…Œì´ë„ˆ ê¸°ë™**

- docker compose íŒŒì¼ ìƒì„±

```bash
cat <<EOT > docker-compose.yaml
services:

  jenkins:
    container_name: jenkins
    image: jenkins/jenkins
    restart: unless-stopped
    networks:
      - cicd-network
    ports:
      - "8080:8080"
      - "50000:50000"                      # Jenkins Agent - Controller : JNLP
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - jenkins_home:/var/jenkins_home

volumes:
  jenkins_home:

networks:
  cicd-network:
    driver: bridge
EOT
```

- ì»¨í…Œì´ë„ˆ ê¸°ë™

```bash
docker compose up -d

[+] Running 3/3
 âœ” Network cicd_cicd-network  Created                                      0.0s 
 âœ” Volume cicd_jenkins_home   Created                                      0.0s 
 âœ” Container jenkins          Started                                      0.2s 
```

```bash
docker compose ps

NAME      IMAGE             COMMAND                  SERVICE   CREATED          STATUS          PORTS
jenkins   jenkins/jenkins   "/usr/bin/tini -- /uâ€¦"   jenkins   28 seconds ago   Up 27 seconds   0.0.0.0:8080->8080/tcp, [::]:8080->8080/tcp, 0.0.0.0:50000->50000/tcp, [::]:50000->50000/tcp
```

- ì»¨í…Œì´ë„ˆ ê¸°ë³¸ ì •ë³´ í™•ì¸

```bash
for i in jenkins ; do echo ">> container : $i <<"; docker compose exec $i sh -c "whoami && pwd"; echo; done

>> container : jenkins <<
jenkins
/
```

- ì»¨í…Œì´ë„ˆë¡œ ì‰˜ ì ‘ì† í™•ì¸

```bash
docker compose exec jenkins bash
jenkins@98e0acb7ca41:/$ exit
exit
```

**(2) Jenkins ì»¨í…Œì´ë„ˆ ì´ˆê¸° ì„¤ì •**

- Jenkins ì´ˆê¸° ì•”í˜¸ í™•ì¸

```bash
docker compose exec jenkins cat /var/jenkins_home/secrets/initialAdminPassword

b188177001fa448d9156f59e8d4e2122
```

- Jenkins ì›¹ ì ‘ì†

```
http://127.0.0.1:8080
b188177001fa448d9156f59e8d4e2122
```
![](https://velog.velcdn.com/images/tlsalswls123/post/d7b736e5-b9fd-4fce-bd25-42a760e366b7/image.png)

- Install suggested plugins ì„ íƒí•˜ì—¬ ê¸°ë³¸ í”ŒëŸ¬ê·¸ì¸ ì„¤ì¹˜

![](https://velog.velcdn.com/images/tlsalswls123/post/97b40d89-93eb-4e3d-974a-bd2a45867139/image.png)

- ì‚¬ìš©ì ê³„ì •ìƒì„±

```
Username: admin
Password: qwe123
Full name: devops
E-mail address: devops@abc.com
```
![](https://velog.velcdn.com/images/tlsalswls123/post/e5be7b1a-c3ff-4300-9c86-7cb66aabdfc5/image.png)

- Jenkins URL ì„¤ì • : ê°ì **`ìì‹ ì˜ PCì˜ IP`**ë¥¼ ì…ë ¥

![](https://velog.velcdn.com/images/tlsalswls123/post/7e7553b0-5201-4c24-8874-2680700fd1ac/image.png)

### **2. Jenkinsì—ì„œ Vault Plugin ì„¤ì¹˜**

```
1. Jenkins UI ì ‘ì†
2. ìƒë‹¨ ë©”ë‰´ì—ì„œ Manage Jenkins â†’ Plugins
3. Available íƒ­ì—ì„œ Vault ê²€ìƒ‰
4. HashiCorp Vault Plugin ì„¤ì¹˜
```
![](https://velog.velcdn.com/images/tlsalswls123/post/6030cfb4-4a31-424f-a2c1-0adfe17f7f99/image.png)

### **3. Vault AppRole ì •ë³´ í™•ì¸**

- ì´ì „ ì‹¤ìŠµì—ì„œ ìƒì„±í•œ AppRole ìê²© ì¦ëª…ì„ íŒŒì¼ë¡œ ê´€ë¦¬í–ˆë‹¤ëŠ” ê°€ì •

```bash
cd approle-creds

cat role_id.txt
f7165557-3127-151e-f46b-6895400f0cb9

cat secret_id.txt
0dc675d7-16a4-ea02-6edf-947ecf1df3a8
```

### **4. Jenkinsì—ì„œ Vault ì„¤ì • ë° Credentials ì¶”ê°€**

**(1) Jenkins UI â†’ Manage Jenkins â†’ Configure System**
![](https://velog.velcdn.com/images/tlsalswls123/post/a9bf646a-8c4a-4019-a309-6ab3b45d3824/image.png)

**(2) Vault Plugin Configuration ì„¹ì…˜ìœ¼ë¡œ ì´ë™**

```
Vault URL ì…ë ¥ í›„ [+ Add] ë²„íŠ¼ í´ë¦­
Vault URL: http://localhost:30000
```
![](https://velog.velcdn.com/images/tlsalswls123/post/a79dd4ba-a1a2-4a67-b9d4-8e865a642a89/image.png)

**(3) Vault AppRole Credentials ìƒì„±**

```
Kind : Vault AppRole Credential
Role ID: f7165557-3127-151e-f46b-6895400f0cb9
Secret ID: 0dc675d7-16a4-ea02-6edf-947ecf1df3a8
[Save] ë²„íŠ¼ í´ë¦­í•˜ì—¬ ì €ì¥í•˜ê³  ë‚˜ì˜¤ê¸°
```
![](https://velog.velcdn.com/images/tlsalswls123/post/7f476661-077d-462f-92db-16f229c8220f/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/f4374fc3-50df-4235-afdf-10d30947dc50/image.png)

### **5. Jenkins Pipeline Job ìƒì„±**

**(1) Jenkins UI â†’ New Item â†’ Pipeline ì„ íƒ**

**(2) `jenkins-vault-kv` ì…ë ¥ í›„ ìƒì„±**
![](https://velog.velcdn.com/images/tlsalswls123/post/c3aad625-d2c1-42ae-96b8-5499d60fcca9/image.png)

**(3) Jenkinsfile ì‘ì„±**

```bash
pipeline {
  agent any

  environment {
    VAULT_ADDR = 'http://192.168.219.107:30000' // ì‹¤ì œ Vault ì£¼ì†Œë¡œ ë³€ê²½!!!
  }

  stages {
    stage('Read Vault Secret') {
      steps {
        withVault([
          vaultSecrets: [
            [
              path: 'secret/sampleapp/config',
              engineVersion: 2,
              secretValues: [
                [envVar: 'USERNAME', vaultKey: 'username'],
                [envVar: 'PASSWORD', vaultKey: 'password']
              ]
            ]
          ],
          configuration: [
            vaultUrl: "${VAULT_ADDR}",
            vaultCredentialId: 'vault-approle-creds'
          ]
        ]) {
          sh '''
            echo "Username from Vault: $USERNAME"
            echo "Password from Vault: $PASSWORD"
          '''
          script {
            echo "Username (env): ${env.USERNAME}"
            echo "Password (env): ${env.PASSWORD}"
          }
        }
      }
    }
  }
}
```
![](https://velog.velcdn.com/images/tlsalswls123/post/15e140da-ebe1-4601-9096-30f5a0914175/image.png)

**(4) Jenkins ì‹¤í–‰ê²°ê³¼ â†’ ë³´ì•ˆìƒ ì·¨ì•½í•˜ë¯€ë¡œ ë§ˆìŠ¤í‚¹ì²˜ë¦¬ë¨**
![](https://velog.velcdn.com/images/tlsalswls123/post/43ae4abd-040b-418e-88a5-d37dbca0b4bb/image.png)

---

## **ğŸ˜ Jenkins + ë™ì (Dynamic) DB ì‹œí¬ë¦¿**

### **1. PostgreSQL ë°°í¬ ë° NodePort ì„œë¹„ìŠ¤ êµ¬ì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: default
spec:
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:13
          env:
            - name: POSTGRES_PASSWORD
              value: "rootpassword"
            - name: POSTGRES_DB
              value: "mydb"
          ports:
            - containerPort: 5432
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: default
spec:
  type: NodePort
  ports:
    - port: 5432
      targetPort: 5432
      nodePort: 30002  # [External] Jenkins ì ‘ì†ìš©
  selector:
    app: postgres
EOF

deployment.apps/postgres created
service/postgres created
```

### **2. Vault Database Secrets Engine ì„¤ì •**

**(1) Vault í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**

```bash
export VAULT_ADDR=http://127.0.0.1:30000
export VAULT_TOKEN=root
```

**(2) Database Secret Engine í™œì„±í™”**

```bash
vault secrets enable database
Success! Enabled the database secrets engine at: database/

vault secrets list
Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_94020688    per-token private secret storage
database/     database     database_b1424172     n/a
identity/     identity     identity_d6877608     identity store
secret/       kv           kv_050b6113           key/value secret storage
sys/          system       system_428d6c50       system endpoints used for control, policy and debugging
```

**(3) Vault <-> Postgres ì—°ê²° êµ¬ì„±**

```bash
vault write database/config/my-postgresql-database \
    plugin_name=postgresql-database-plugin \
    allowed_roles="jenkins-role" \
    connection_url="postgresql://{{username}}:{{password}}@postgres.default.svc.cluster.local:5432/mydb?sslmode=disable" \
    username="postgres" \
    password="rootpassword"
    
Success! Data written to: database/config/my-postgresql-database
```

- Vaultê°€ Postgresì— ì ‘ê·¼í•  ë•Œ ì‚¬ìš©í•  **ê´€ë¦¬ì ê³„ì • ì •ë³´** ì§€ì •
- K8s ë‚´ë¶€ DNS(`postgres.default.svc.cluster.local`)ë¡œ ì ‘ê·¼í•¨

**(4) ë™ì  ê³„ì • ìƒì„±ìš© Role ì •ì˜**

```bash
vault write database/roles/jenkins-role \
    db_name=my-postgresql-database \
    creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"{{name}}\";" \
    default_ttl="1h" \
    max_ttl="24h"
    
Success! Data written to: database/roles/jenkins-role
```

- Vaultê°€ ì‹¤ì œ Postgresì— ë§Œë“¤ **ì„ì‹œ ê³„ì • ê·œì¹™** ì •ì˜
- ìœ íš¨ ê¸°ê°„ `default_ttl=1h`
- public ìŠ¤í‚¤ë§ˆì˜ ëª¨ë“  í…Œì´ë¸”ì— SELECT ê¶Œí•œ ë¶€ì—¬

### **3. ê¸°ì¡´ AppRole Policy í™•ì¥ (KV + Database ë™ì‹œ ì‚¬ìš©)**

**(1) sampleapp-policyì— DB ê¶Œí•œ ì¶”ê°€**

```bash
vault policy write sampleapp-policy - <<EOF
# 1. KV v2 ë°ì´í„° ì½ê¸°
path "secret/data/sampleapp/*" {
  capabilities = ["read"]
}
# 2. KV v2 ëª©ë¡ ì¡°íšŒ (í”ŒëŸ¬ê·¸ì¸ ì—ëŸ¬ ë°©ì§€ìš© í•„ìˆ˜!)
path "secret/metadata/sampleapp/*" {
  capabilities = ["list", "read"]
}
# 3. DB Creds ë°œê¸‰
path "database/creds/jenkins-role" {
  capabilities = ["read"]
}
EOF

Success! Uploaded policy: sampleapp-policy
```

- ê¸°ì¡´ KV ê¶Œí•œì— **DB ë™ì  ì‹œí¬ë¦¿ ë°œê¸‰ ê¶Œí•œ**ì„ í•©ì¹¨

**(2) `sampleapp-policy` ë¥¼ ì¡°íšŒí•´ ì •ì±…ì´ ì •ìƒ ë°˜ì˜ë˜ì—ˆëŠ”ì§€ í™•ì¸**

```bash
vault policy read sampleapp-policy

# 1. KV v2 ë°ì´í„° ì½ê¸°
path "secret/data/sampleapp/*" {
  capabilities = ["read"]
}
# 2. KV v2 ëª©ë¡ ì¡°íšŒ (í”ŒëŸ¬ê·¸ì¸ ì—ëŸ¬ ë°©ì§€ìš© í•„ìˆ˜!)
path "secret/metadata/sampleapp/*" {
  capabilities = ["list", "read"]
}
# 3. DB Creds ë°œê¸‰
path "database/creds/jenkins-role" {
  capabilities = ["read"]
}
```

**(3) AppRoleì— default + sampleapp-policy ì ìš©**

```bash
vault write auth/approle/role/sampleapp-role \
  token_policies="default,sampleapp-policy" \
  secret_id_ttl="0" \
  token_ttl="1h" \
  token_max_ttl="4h"
  
Success! Data written to: auth/approle/role/sampleapp-role
```

- ì´ë ‡ê²Œ í•˜ë©´ `sampleapp-role`ì„ ê°€ì§„ ì• í”Œë¦¬ì¼€ì´ì…˜(Jenkins)ì€ ë³„ë„ì˜ ì¬ì¸ì¦ ì—†ì´, ë‹¤ìŒ í† í° ê°±ì‹ ì´ë‚˜ ë¡œê·¸ì¸ ì‹œì ë¶€í„° ë°”ë¡œ DB ê¶Œí•œì„ ì“¸ ìˆ˜ ìˆìŒ

### **4. Jenkins Pipelineì—ì„œ Dynamic DB ì‹œí¬ë¦¿ ì‚¬ìš©**

```bash
pipeline {
  agent any

  environment {
    // Jenkins(Docker) -> Vault(K8s NodePort)
    // ì£¼ì˜: http:// ê°€ í¬í•¨ëœ ì „ì²´ ì£¼ì†Œ
    // Jenkins íŒŒë“œ ì‚¬ìš© ì‹œ : http://vault.vault.svc:8200
    VAULT_ADDR = 'http://192.168.219.107:30000' 
    
    // Jenkins(Docker) -> DB(K8s NodePort)
    // ì£¼ì˜: DB ì ‘ì†ì—ëŠ” í”„ë¡œí† ì½œ(http://) ì—†ì´ IPë§Œ í•„ìš”í•©ë‹ˆë‹¤.
    // Jenkins íŒŒë“œ ì‚¬ìš© ì‹œ : DB_HOST = 'postgres.default.svc' , DB_PORT = '5432'
    DB_HOST = '192.168.219.107'
    DB_PORT = '30002'
  }

  stages {
    stage('Vault í†µí•© ë° DB ì ‘ì† í…ŒìŠ¤íŠ¸') {
      steps {
        withVault([
          configuration: [
            vaultUrl: "${VAULT_ADDR}",
            vaultCredentialId: 'vault-approle-creds',
            // âš ï¸ ì¤‘ìš”: ì—¬ê¸°ì„œ ì „ì—­ engineVersion ì„¤ì •ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            skipSslVerification: true
          ],
          vaultSecrets: [
            // 1. KV Secret (ì •ì  ì‹œí¬ë¦¿)
            // KV v2 ì—”ì§„ì„ ì‚¬ìš©í•˜ë¯€ë¡œ engineVersion: 2ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
            [
              path: 'secret/sampleapp/config',
              engineVersion: 2,
              secretValues: [
                [envVar: 'STATIC_USER', vaultKey: 'username']
              ]
            ],
            // 2. Database Secret (ë™ì  ì‹œí¬ë¦¿)
            // DB ì—”ì§„ì€ ê¸°ë³¸ ë°©ì‹(v1)ìœ¼ë¡œ í†µì‹ í•´ì•¼ ê²½ë¡œ ì—ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.
            [
              path: 'database/creds/jenkins-role',
              engineVersion: 1,
              secretValues: [
                [envVar: 'DB_USER', vaultKey: 'username'],
                [envVar: 'DB_PASS', vaultKey: 'password']
              ]
            ]
          ]
        ]) {
          script {
            echo "=================================================="
            echo "             Vault ì—°ë™ í…ŒìŠ¤íŠ¸ ì‹œì‘                "
            echo "=================================================="

            // 1. ì •ì  ì‹œí¬ë¦¿ í™•ì¸
            // sed ëª…ë ¹ì–´ë¡œ ê¸€ì ì‚¬ì´ì— ê³µë°±ì„ ë„£ì–´ ë§ˆìŠ¤í‚¹(****)ì„ ìš°íšŒí•©ë‹ˆë‹¤.
            // ì˜ˆ: d e m o
            sh '''
              echo "[1] KV Secret (Static)"
              echo " - ì›ë³¸ ê°’ì€ ë³´ì•ˆìƒ **** ë¡œ í‘œì‹œë©ë‹ˆë‹¤."
              echo " - ì‹¤ì œ ê°’ í™•ì¸: $(echo $STATIC_USER | sed "s/./& /g")"
            '''
            
            // 2. ë™ì  ì‹œí¬ë¦¿ í™•ì¸ (í•µì‹¬!)
            // Vaultê°€ ìƒì„±í•œ ì„ì‹œ DB ê³„ì •(v-token-...)ì„ í™•ì¸í•©ë‹ˆë‹¤.
            sh '''
              echo "--------------------------------------------------"
              echo "[2] Database Secret (Dynamic)"
              echo " - Vaultê°€ ìƒì„±í•œ ì„ì‹œ ê³„ì • IDì…ë‹ˆë‹¤."
              echo " - ì‹¤ì œ ê°’ í™•ì¸: $(echo $DB_USER | sed "s/./& /g")"
              echo "--------------------------------------------------"
            '''
            
            // 3. DB ì ‘ì† ì‹œë®¬ë ˆì´ì…˜
            // ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ DB ì—°ê²° ë¬¸ìì—´ì„ ë§Œë“œëŠ” ê³¼ì •ì…ë‹ˆë‹¤.
            sh '''
              echo "[3] DB Connection Simulation"
              echo " - Connecting to: ${DB_HOST}:${DB_PORT}"
              echo " - User: ${DB_USER}"
              echo " - Password: (Hidden)"
              echo " >> âœ… DB ì ‘ì† í…ŒìŠ¤íŠ¸ ì„±ê³µ! (ê°€ìƒ)"
            '''
          }
        }
      }
    }
  }
  
  post {
    success {
      script {
        echo "ğŸ‰ Pipeline ì„±ê³µ!" 
        echo "   -> í™•ì¸ëœ DB ê³„ì •(${env.DB_USER})ì€ Vaultì˜ TTL ì„¤ì •ì— ë”°ë¼ 1ì‹œê°„ í›„ ìë™ ì‚­ì œë©ë‹ˆë‹¤."
      }
    }
    failure {
      echo "ğŸ’¥ Pipeline ì‹¤íŒ¨! Vault ë¡œê·¸ë‚˜ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”."
    }
  }
}
```
![](https://velog.velcdn.com/images/tlsalswls123/post/dc49cfd9-98f8-4073-93f6-24ae19c13b8d/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/e017008c-56f5-4ef0-ba57-8cf4eb1faee1/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/a21f3b99-342f-46a1-b70d-78e224da1660/image.png)

### **5. PostgreSQL ë‚´ë¶€ì—ì„œ ë™ì  ê³„ì • ìƒì„± ì—¬ë¶€ ê²€ì¦**

```bash
kubectl exec -it -n default deploy/postgres -- psql -U postgres

psql (13.23 (Debian 13.23-1.pgdg13+1))
Type "help" for help.

postgres=# \du
                                                        List of roles
                     Role name                      |                         Attributes                         | Member of 
----------------------------------------------------+------------------------------------------------------------+-----------
 postgres                                           | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
 v-approle-jenkins--79iZKB4v0PdCUb1JaiKU-1764403151 | Password valid until 2025-11-29 08:59:16+00                | {}
```

- Vaultê°€ ì‹¤ì œë¡œ PostgreSQLì— ê³„ì •ì„ ë§Œë“¤ì—ˆëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ DB ì•ˆì—ì„œ Role ëª©ë¡ ì¡°íšŒ
- `v-approle-jenkins-...` ë¡œ ì‹œì‘í•˜ëŠ” Roleì´ ë°”ë¡œ Vaultê°€ ë§Œë“  **ì„ì‹œ ê³„ì •**ì„
- Attributesì— `Password valid until â€¦`ì´ ëª…ì‹œë˜ì–´ ìˆìœ¼ë©° TTLì´ ì§€ë‚˜ë©´ Vaultê°€ ê³„ì •ì„ ì •ë¦¬í•˜ê±°ë‚˜ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•Šê²Œ ë¨

---

## **ğŸ“¦ ì•”í˜¸í™”(Encryption)ì™€ Vault Transit ì—”ì§„**

### **1. ì‚¬ì „ì¤€ë¹„: í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

```bash
export NS=vault-demo
export IMAGE=hyungwookhub/vault-transit-demo:v1
export VAULT_ADDR=http://localhost:30000
export VAULT_TOKEN=root
```

### **2. Vault Transit í™œì„±í™”**

**(1) Vault ì„œë²„ í˜„ì¬ ìƒíƒœ í™•ì¸ (Seal ì—¬ë¶€, í´ëŸ¬ìŠ¤í„° ìƒíƒœ ë“±)**

```bash
vault status

Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.20.4
Build Date      2025-09-23T13:22:38Z
Storage Type    inmem
Cluster Name    vault-cluster-1597f923
Cluster ID      ead5b677-accb-a319-bc9b-9997309c7712
HA Enabled      false
```

**(2) Transit Secrets Engine í™œì„±í™” (ì•”ë³µí˜¸í™” ì „ìš© ì—”ì§„)**

```bash
vault secrets enable transit

Success! Enabled the transit secrets engine at: transit/
```

```bash
vault secrets list

Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_94020688    per-token private secret storage
database/     database     database_b1424172     n/a
identity/     identity     identity_d6877608     identity store
secret/       kv           kv_050b6113           key/value secret storage
sys/          system       system_428d6c50       system endpoints used for control, policy and debugging
transit/      transit      transit_dfe4b3fa      n/a
```

**(3) ì•”í˜¸í™” í‚¤ ìƒì„± (ds-poc)**

```bash
vault write -f transit/keys/ds-poc type=aes256-gcm96

Key                       Value
---                       -----
allow_plaintext_backup    false
auto_rotate_period        0s
deletion_allowed          false
derived                   false
exportable                false
imported_key              false
keys                      map[1:1764403997]
latest_version            1
min_available_version     0
min_decryption_version    1
min_encryption_version    0
name                      ds-poc
supports_decryption       true
supports_derivation       true
supports_encryption       true
supports_signing          false
type                      aes256-gcm96
```

**(4) Transit ì—”ì§„ ë‚´ì— ìƒì„±ëœ í‚¤ ëª©ë¡ í™•ì¸**

```bash
vault list transit/keys

Keys
----
ds-poc
```

### **3. Transit ì—”ì§„ ì•”Â·ë³µí˜¸ í…ŒìŠ¤íŠ¸**

**(1) í‰ë¬¸ì„ Base64 ì¸ì½”ë”© í›„ Vault Transit Encrypt API í˜¸ì¶œ**

```bash
PLAINTEXT="My Data"

CIPHERTEXT=$(vault write -field=ciphertext transit/encrypt/ds-poc \
  plaintext=$(echo -n "$PLAINTEXT" | base64))
```

**(2) ìƒì„±ëœ ì•”í˜¸ë¬¸(Ciphertext) ê°’ í™•ì¸**

```bash
echo "ciphertext: $CIPHERTEXT"
ciphertext: vault:v1:PAXCenGUxHc/2owgm5GlP38zmq6K5ZLNzAy78n9xMjX2+2Q=
```

**(3) ì•”í˜¸ë¬¸ì„ Transit Decrypt APIì— ì „ë‹¬ í›„ Base64 ë””ì½”ë”©**

```bash
vault write -field=plaintext transit/decrypt/ds-poc \
  ciphertext="$CIPHERTEXT" | base64 -d && echo

My Data
```

### **4. MySQL ë°°í¬ ë° VaultData DB ì¤€ë¹„**

**(1) MySQL Deployment + Service(NodePort) ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: ${NS}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: ${NS}
spec:
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0.31
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "rootpassword"
        ports:
        - containerPort: 3306
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: ${NS}
spec:
  type: NodePort
  selector:
    app: mysql
  ports:
  - name: mysql
    port: 3306
    targetPort: 3306
    nodePort: 30002
EOF

namespace/vault-demo created
deployment.apps/mysql created
service/mysql created
```

**(2) MySQL ë°°í¬ ìƒíƒœ í™•ì¸**

```bash
kubectl -n ${NS} rollout status deploy/mysql
deployment "mysql" successfully rolled out
```

**(3) VaultData DB ìƒì„±**

```bash
kubectl -n ${NS} exec -it deploy/mysql -- \
  mysql -uroot -prootpassword -e "CREATE DATABASE IF NOT EXISTS VaultData;"

mysql: [Warning] Using a password on the command line interface can be insecure.
```

**(4) Database ìƒì„±í™•ì¸**

```bash
kubectl -n ${NS} exec -it deploy/mysql -- \
  mysql -uroot -prootpassword -e "SHOW DATABASES LIKE 'VaultData';"

mysql: [Warning] Using a password on the command line interface can be insecure.
+----------------------+
| Database (VaultData) |
+----------------------+
| VaultData            |
+----------------------+
```

### **5. Vault Transit Demo ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vault-transit-demo
  namespace: ${NS}
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vault-transit-demo
  template:
    metadata:
      labels:
        app: vault-transit-demo
    spec:
      containers:
      - name: app
        image: ${IMAGE}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
        env:
        - name: MYSQL_HOST
          value: mysql.${NS}.svc.cluster.local
        - name: MYSQL_PORT
          value: "3306"
        - name: MYSQL_DB_NAME
          value: VaultData
        - name: MYSQL_USERNAME
          value: root
        - name: MYSQL_USERPW
          value: rootpassword
        - name: VAULT_HOST
          value: vault.vault.svc.cluster.local    # í•„ìš” ì‹œ ë…¸ë“œ IP/NodePortë¡œ êµì²´
        - name: VAULT_PORT
          value: "8200"                           # NodePortë¡œ ë¶™ì„ ë• 30000 ë“±ìœ¼ë¡œ êµì²´
        - name: VAULT_SCHEME
          value: http
        - name: VAULT_TOKEN
          value: root
        - name: VAULT_TRANSIT_KEY_NAME
          value: ds-poc
        - name: SERVER_PORT
          value: "8080"
        - name: AWS_REGION
          value: "ap-northeast-2"
---
apiVersion: v1
kind: Service
metadata:
  name: vault-transit-demo
  namespace: ${NS}
spec:
  type: NodePort
  selector:
    app: vault-transit-demo
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 30003
    name: http
EOF

deployment.apps/vault-transit-demo created
service/vault-transit-demo created
```

### **6. ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ë°ì´í„°/íŒŒì¼ ì•”í˜¸í™” ì‹¤ìŠµ**

**(1) UI ì ‘ì†**

```bash
http://localhost:30003
```
![](https://velog.velcdn.com/images/tlsalswls123/post/2172eca2-01bc-452a-abc9-6b70ad9a6ff4/image.png)

**(2) Data Encryption: í…ìŠ¤íŠ¸ ì•”/ë³µí˜¸í™”**

- **Decrypt Data: í‰ë¬¸ ë°ì´í„° í™•ì¸**

![](https://velog.velcdn.com/images/tlsalswls123/post/be293338-d93b-4a41-8bd2-0da484193600/image.png)

- **Raw Data: `vault:` ì ‘ë‘ì‚¬ë¡œ ì‹œì‘í•˜ëŠ” ì•”í˜¸í™”ëœ ë°ì´í„° í™•ì¸**

![](https://velog.velcdn.com/images/tlsalswls123/post/e8b3ac92-ebbc-4862-914f-eb475894d910/image.png)

- **MySQLì—ì„œ ì§ì ‘ í…Œì´ë¸” í™•ì¸**

```bash
kubectl -n ${NS} exec -it deploy/mysql -- \
mysql -uroot -prootpassword -e "USE VaultData; SHOW TABLES; SELECT id,data,date_created FROM vault_data;"

# ê²°ê³¼
mysql: [Warning] Using a password on the command line interface can be insecure.
+---------------------+
| Tables_in_VaultData |
+---------------------+
| vault_data          |
+---------------------+
+----+-----------------------------------------------------------------------+----------------------------+
| id | data                                                                  | date_created               |
+----+-----------------------------------------------------------------------+----------------------------+
|  1 | vault:v1:Na0Q4biE6LjXuzqqUE6HldBzcDk/yGZ+ftjNMhm05lTACWjfGhW0WQiFFw== | 2025-11-29 17:25:56.660000 |
|  2 | vault:v1:EG+3dRyndoJHbLSQfTyNEHmOHcFKY7gwLdx1zs5ea1nJrWGWU3tc2Q==     | 2025-11-29 17:26:00.766000 |
+----+-----------------------------------------------------------------------+----------------------------+
```

**(3) Data Encryption: íŒŒì¼ ì•”/ë³µí˜¸í™”**

- í…ŒìŠ¤íŠ¸ íŒŒì¼ ìƒì„±

```bash
# ìƒ˜í”ŒíŒŒì¼ ìƒì„±
echo "hello vault transit" > original.txt

# ì—…ë¡œë“œ ì „ í™•ì¸
md5sum original.txt
5b92abfe363ae7212a37a55f96bf5967  original.txt
```

- **[File Encryption] - [Browseâ€¦]** ì„ íƒ í›„ `original.txt` íŒŒì¼ ì—…ë¡œë“œ

![](https://velog.velcdn.com/images/tlsalswls123/post/ae33da43-d4dc-4df9-9a94-4241b0ecb808/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/e1d8b943-9935-43a9-bb6e-adfff04cfa8a/image.png)

- ì•”í˜¸í™” ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ: `original.txt.enc`
- ì›ë³¸ íŒŒì¼ê³¼ í•´ì‹œ ê°’ ë¹„êµ

```bash
md5sum original.txt original.txt.enc
5b92abfe363ae7212a37a55f96bf5967  original.txt
77fd4610857f05572eeb8c12d02b3dfa  original.txt.enc # í•´ì‹œê°’ ë³€ê²½ í™•ì¸
```

- **[File Decryption] - [Choose File]** ì„ íƒ í›„ `original.txt.enc` íŒŒì¼ ì—…ë¡œë“œ

![](https://velog.velcdn.com/images/tlsalswls123/post/4d992d91-1c47-447a-902b-d4f7f4395d17/image.png)
![](https://velog.velcdn.com/images/tlsalswls123/post/9ffd1f58-1ffa-458a-ac68-06b344a54695/image.png)

- ë³µí˜¸í™” ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ: `original.txt`

```bash
mv original.txt original.dec # íŒŒì¼ëª…ì´ ë™ì¼í•´ì„œ ë³€ê²½..

md5sum original.txt original.txt.enc original.dec
5b92abfe363ae7212a37a55f96bf5967  original.txt
77fd4610857f05572eeb8c12d02b3dfa  original.txt.enc
5b92abfe363ae7212a37a55f96bf5967  original.dec
```

### **7. ì •ë¦¬/í´ë¦°ì—…**

```bash
kubectl delete ns ${NS}

namespace "vault-demo" deleted
```

