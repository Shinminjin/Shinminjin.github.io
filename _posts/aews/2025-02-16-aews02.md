---
title: AEWS 2ì£¼ì°¨ ì •ë¦¬
date: 2025-02-16 00:20:00 +0900
categories: [EKS]
tags: [AEWS]
---

## **ğŸ§ AWS EKS í™˜ê²½ ì„¤ì¹˜ ì¤€ë¹„ (Arch Linux)**

### **1. ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸**

```bash
yay -Syu
```

### **2. AWS CLI ì„¤ì¹˜**

```bash
yay -S aws-cli-v2

# ì„¤ì¹˜í™•ì¸
aws --version

# ê²°ê³¼
aws-cli/2.24.0 Python/3.13.1 Linux/6.13.1-arch1-1 source/x86_64.arch
```

### **3. eksctl ì„¤ì¹˜**

ìµœì‹  eksctl ì„¤ì¹˜ í•„ìš” (version: 1.31 ì§€ì›)

```bash
ARCH=$(uname -m)
if [[ "$ARCH" == "x86_64" ]]; then ARCH="amd64"; fi
if [[ "$ARCH" == "aarch64" ]]; then ARCH="arm64"; fi

curl --silent --location "https://github.com/eksctl-io/eksctl/releases/latest/download/eksctl_Linux_${ARCH}.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin/
sudo chmod +x /usr/local/bin/eksctl

# ì„¤ì¹˜í™•ì¸
eksctl version

# ê²°ê³¼
0.203.0
```

### 4. **kubectl ì„¤ì¹˜**

```bash
yay -S kubectl

# ì„¤ì¹˜í™•ì¸
kubectl version --client=true

# ê²°ê³¼
Client Version: v1.32.1
Kustomize Version: v5.5.0
```

### **5. Helm ì„¤ì¹˜**

```bash
yay -S helm

# ì„¤ì¹˜í™•ì¸
helm version

# ê²°ê³¼
version.BuildInfo{Version:"v3.17.0", GitCommit:"301108edc7ac2a8ba79e4ebf5701b0b6ce6a31e4", GitTreeState:"clean", GoVersion:"go1.23.4"}
```

### **6. krew ì„¤ì¹˜ ë° í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€**

```bash
yay -S krew

# ì„¤ì¹˜í™•ì¸
kubectl krew version

# ê²°ê³¼
OPTION            VALUE
GitTag            v0.4.4
GitCommit         343e657
IndexURI          https://github.com/kubernetes-sigs/krew-index.git
BasePath          /home/devshin/.krew
IndexPath         /home/devshin/.krew/index/default
InstallPath       /home/devshin/.krew/store
BinPath           /home/devshin/.krew/bin
DetectedPlatform  linux/amd64
```

```bash
echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> ~/.zshrc
echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> ~/.bashrc

source ~/.zshrc  # zsh ì‚¬ìš© ì‹œ
source ~/.bashrc # bash ì‚¬ìš© ì‹œ
```

```bash
kubectl krew install neat get-all df-pv stern
kubectl krew list

# ê²°ê³¼
PLUGIN   VERSION
df-pv    v0.3.0
get-all  v1.3.8
krew     v0.4.4
neat     v2.0.4
stern    v1.32.0
```

### **7. kube-ps1 ì„¤ì¹˜**

```bash
yay -S kube-ps1
echo "source /opt/kube-ps1/kube-ps1.sh" >> ~/.bashrc
echo 'PS1="[\u@\h \W $(kube_ps1)]$ "' >> ~/.bashrc
source ~/.bashrc

echo "source /opt/kube-ps1/kube-ps1.sh" >> ~/.zshrc
echo 'PROMPT="$(kube_ps1)$PROMPT"' >> ~/.zshrc
source ~/.zshrc
```

### **8. kubectx ì„¤ì¹˜**

```bash
yay -S kubectx
```

### **9. kubecolor ì„¤ì¹˜ ë° alias ì„¤ì •**

```bash
yay -S kubecolor

echo "alias k=kubectl" >> ~/.bashrc
echo "alias kubectl=kubecolor" >> ~/.bashrc
echo 'complete -F __start_kubectl kubecolor' >> ~/.bashrc
source ~/.bashrc

echo "alias k=kubectl" >> ~/.zshrc
echo "alias kubectl=kubecolor" >> ~/.zshrc
echo 'autoload -U compinit && compinit' >> ~/.zshrc
echo "compdef kubecolor=kubectl" >> ~/.zshrc
source ~/.zshrc
```

### **10. (ì˜µì…˜) AWS ì„¸ì…˜ ë§¤ë‹ˆì € ì„¤ì¹˜**

```bash
yay -S aws-session-manager-plugin

# ì„¤ì¹˜í™•ì¸
session-manager-plugin --version

# ê²°ê³¼
1.2.707.0
```

### **11. (ì˜µì…˜) sshpass ì„¤ì¹˜**

```bash
yay -S sshpass

# ì„¤ì¹˜í™•ì¸
sshpass -V

# ê²°ê³¼
sshpass 1.10
(C) 2006-2011 Lingnu Open Source Consulting Ltd.
(C) 2015-2016, 2021-2022 Shachar Shemesh
This program is free software, and can be distributed under the terms of the GPL
See the COPYING file for more information.

Using "assword" as the default password prompt indicator.
```

### **12. (ì˜µì…˜)  Wireshark ì„¤ì¹˜**

íŒ¨í‚· ìº¡ì³ ë° ìº¡ì³ëœ íŒŒì¼ì—ì„œ íŒ¨í‚· ë‚´ìš© í™•ì¸

```bash
yay -S wireshark-qt

# WiresharkëŠ” ì¼ë°˜ ì‚¬ìš©ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, wireshark ê·¸ë£¹ì— ì‚¬ìš©ìë¥¼ ì¶”ê°€í•´ì•¼ í•¨
sudo usermod -aG wireshark $USER
newgrp wireshark  # ë³€ê²½ ì‚¬í•­ ì¦‰ì‹œ ì ìš©

# ì„¤ì¹˜ í™•ì¸
wireshark --version

# ê²°ê³¼
Wireshark 4.4.3.
```

---

## **ğŸ” AWS Configure ìê²© ì¦ëª… ì„¤ì •**

```bash
aws configure
AWS Access Key ID [None]: XXXXXXXXXXXXXXXXXX
AWS Secret Access Key [None]: XXXXXXXXXXXXXXXXXX
Default region name [None]: ap-northeast-2
Default output format [None]: json
```

- **AWS Access Key ID**: (ë°œê¸‰ë°›ì€ Access Key ID ì…ë ¥)
- **AWS Secret Access Key**: (Secret Access Key ì…ë ¥)
- **Default region name**: `ap-northeast-2` (ì„œìš¸ ë¦¬ì „, ì›í•˜ëŠ” ë¦¬ì „ ì„ íƒ ê°€ëŠ¥)
- **Default output format**: `json` ë˜ëŠ” `yaml` (ê¸°ë³¸ê°’: `json`)

---

## **ğŸš€ AWS CloudFormationì„ í†µí•œ ê¸°ë³¸ ì‹¤ìŠµ í™˜ê²½ ë°°í¬**

![Image](https://github.com/user-attachments/assets/fcd9b7b6-0292-4dd1-b570-5b2e99514daf)

### **1. CloudFormation í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ**

```bash
cd Downloads
curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/myeks-2week.yaml
```

### **2. CloudFormation ìŠ¤íƒ ë°°í¬**

```bash
aws cloudformation deploy --template-file ~/Downloads/myeks-2week.yaml \
    --stack-name myeks --parameter-overrides KeyName=kp-aews SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2

# ê²°ê³¼
Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - myeks
```

`operator-host`ë¼ëŠ” ì´ë¦„ì˜ `t2.small` EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ í•˜ë‚˜ ë°°í¬ë¨


![Image](https://github.com/user-attachments/assets/73fb55fe-6100-45d0-9371-2a8774a39a3d)

### **3. ë°°í¬ëœ EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ì†**

**(1) CloudFormation ìŠ¤íƒ ë°°í¬ ì™„ë£Œ í›„ ìš´ì˜ì„œë²„ EC2 IP ì¶œë ¥**

```bash
aws cloudformation describe-stacks --stack-name myeks --query 'Stacks[*].Outputs[*].OutputValue' --output text
```

âœ…Â **ì¶œë ¥**

```bash
15.165.15.90
```

**(2) ìš´ì˜ì„œë²„ EC2ì— SSH ì ‘ì†**

```bash
# ssh -i kp-aews.pem ec2-user@15.165.15.90
ssh -i kp-aews.pem ec2-user@$(aws cloudformation describe-stacks --stack-name myeks --query 'Stacks[*].Outputs[0].OutputValue' --output text)
```

### **4. `ssh-agent`ë¥¼ ì´ìš©í•œ í‚¤ ê´€ë¦¬**

**(1) `ssh-agent` ì‹œì‘ ë° í‚¤ ì¶”ê°€**

```bash
eval "$(ssh-agent -s)"
# ê²°ê³¼
ssh-add ~/Downloads/kp-aews.pem
```

**(2) SSH ì ‘ì† (ë¹„ë°€ë²ˆí˜¸ ì—†ì´)**

```bash
ssh ec2-user@15.165.15.90
```

![Image](https://github.com/user-attachments/assets/a6d66e05-74cd-41dc-a1ba-a940e4a864d8)

### **5. ìš´ì˜ ì„œë²„ EC2(operator-host)ì—ì„œ EKS ì ‘ê·¼ ì„¤ì •**

**(1) AWS IAM ìê²©ì¦ëª… ì„¤ì •**

```bash
[root@operator-host ~]# aws configure
AWS Access Key ID [None]: XXXXXXXXXXXXXXXXXX
AWS Secret Access Key [None]: XXXXXXXXXXXXXXXXXX
Default region name [None]: ap-northeast-2
Default output format [None]: json
```

**(2) IAM ì‚¬ìš©ì í™•ì¸ (`get-caller-identity`)**

```bash
[root@operator-host ~]# aws sts get-caller-identity --query Arn
"arn:aws:iam::378102432899:user/eks-user"
```

### **6. Peering connections í™•ì¸**

![Image](https://github.com/user-attachments/assets/fc5a5aa6-2405-4a86-a690-12cd0f92d382)
myeks-VPCì™€ operator-VPCê°€ í”¼ì–´ë§ìœ¼ë¡œ ì—°ê²°ëœ ìƒíƒœ

![Image](https://github.com/user-attachments/assets/979948ef-b357-41d4-9e49-6135beb8e70a)

**myeks-VPC ë¼ìš°íŒ… ê²½ë¡œ**

- **myeks-VPC í¼ë¸”ë¦­ ì„œë¸Œë„·**ì—ì„  `172.20.0.0/16` ëŒ€ì—­ê³¼ í†µì‹  ì‹œ ì¸í„°ë„· ê²½ìœ  ì—†ì´ í”¼ì–´ë§(Peering)ì„ í†µí•´ **Operator VPC**ì™€ ì§ì ‘ í†µì‹ 

![Image](https://github.com/user-attachments/assets/e77ac9db-bec2-44a6-85f8-8e3f2824f4a8)

**operator-VPC ë¼ìš°íŒ… ê²½ë¡œ**

- **operator-VPC í¼ë¸”ë¦­ ì„œë¸Œë„·**ì—ì„  `192.168.0.0/16` ëŒ€ì—­ê³¼ í†µì‹  ì‹œ ì¸í„°ë„· ê²½ìœ  ì—†ì´ í”¼ì–´ë§(Peering)ì„ í†µí•´ **myeks-VPC**ì™€ ì§ì ‘ í†µì‹ 

![Image](https://github.com/user-attachments/assets/f7171c4b-acbd-4a24-85dd-72bbf0b8645d)

---

## **ğŸš¢ eksctlì„ í†µí•´ EKS ë°°í¬**

### **1. í´ëŸ¬ìŠ¤í„°ëª… ë³€ìˆ˜ ì§€ì •**

```bash
export CLUSTER_NAME=myeks
```

### **2. `myeks-VPC` ë³€ìˆ˜ ì§€ì •**

```bash
export VPCID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" --query 'Vpcs[*].VpcId' --output text)
echo $VPCID
```

âœ…Â **ì¶œë ¥**

```bash
vpc-02725f328b257230c
```

![Image](https://github.com/user-attachments/assets/77decd51-a8b3-42f7-942b-0ae1c4c85134)

**AWS ì½˜ì†” VPC > Your VPCs**ì—ì„œ ì¡°íšŒí•œ `myeks-VPC ID` : `vpc-02725f328b257230c`

![Image](https://github.com/user-attachments/assets/229704aa-c3a3-4705-b73a-00437d43071f)


### **3. `myeks` í¼ë¸”ë¦­ ì„œë¸Œë„· ë³€ìˆ˜ ì§€ì •**

**AZ1, AZ2, AZ3ì— í•´ë‹¹í•˜ëŠ” í¼ë¸”ë¦­ ì„œë¸Œë„·ì˜ IDë¥¼ ë³€ìˆ˜ë¡œ ì§€ì •**

```bash
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet3=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet3" --query "Subnets[0].[SubnetId]" --output text)
```

```bash
echo $PubSubnet1 $PubSubnet2 $PubSubnet3
```

**âœ…Â ì¶œë ¥**

```bash
subnet-0b53307d4d544b3bf subnet-019936bd535b68960 subnet-0d19099a6b73555f8
```

**ì„œë¸Œë„· ëŒ€ì—­(CIDR) ë²”ìœ„**

- **AZ1:** 192.168.1.0/24, **AZ2:** 192.168.2.0/24, **AZ3:** 192.168.3.0/24


![Image](https://github.com/user-attachments/assets/414d5cdf-58ad-495a-a850-57d35015954a)

### **4. myeks.yaml íŒŒì¼ ì‘ì„±**

**ë³€ê²½í•  í•­ëª©**

`VPC ID`, `Public Subnet1 ID`, `Public Subnet2 ID`, `Public Subnet3 ID`, `SSH Public Key Name`

```bash
echo $VPCID
vpc-02725f328b257230c
```

```bash
echo $PubSubnet1 $PubSubnet2 $PubSubnet3
subnet-0b53307d4d544b3bf subnet-019936bd535b68960 subnet-0d19099a6b73555f8
```

**myeks.yaml**

```yaml
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: myeks
  region: ap-northeast-2
  version: "1.31"

kubernetesNetworkConfig:
  ipFamily: IPv4

iam:
  vpcResourceControllerPolicy: true
  withOIDC: true

accessConfig:
  authenticationMode: API_AND_CONFIG_MAP

vpc:
  autoAllocateIPv6: false
  cidr: 192.168.0.0/16
  clusterEndpoints:
    privateAccess: true # if you only want to allow private access to the cluster
    publicAccess: true # if you want to allow public access to the cluster
  id: vpc-02725f328b257230c  # ê°ì í™˜ê²½ ì •ë³´ë¡œ ìˆ˜ì •
  manageSharedNodeSecurityGroupRules: true # if you want to manage the rules of the shared node security group
  nat:
    gateway: Disable
  subnets:
    public:
      ap-northeast-2a:
        az: ap-northeast-2a
        cidr: 192.168.1.0/24
        id: subnet-0b53307d4d544b3bf  # ê°ì í™˜ê²½ ì •ë³´ë¡œ ìˆ˜ì •
      ap-northeast-2b:
        az: ap-northeast-2b
        cidr: 192.168.2.0/24
        id: subnet-019936bd535b68960  # ê°ì í™˜ê²½ ì •ë³´ë¡œ ìˆ˜ì •
      ap-northeast-2c:
        az: ap-northeast-2c
        cidr: 192.168.3.0/24
        id: subnet-0d19099a6b73555f8  # ê°ì í™˜ê²½ ì •ë³´ë¡œ ìˆ˜ì •

addons:
  - name: vpc-cni # no version is specified so it deploys the default version
    version: latest # auto discovers the latest available
    attachPolicyARNs: # attach IAM policies to the add-on's service account
      - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
    configurationValues: |-
      enableNetworkPolicy: "true"

  - name: kube-proxy
    version: latest

  - name: coredns
    version: latest

  - name: metrics-server
    version: latest

privateCluster:
  enabled: false
  skipEndpointCreation: false

managedNodeGroups:
- amiFamily: AmazonLinux2023
  desiredCapacity: 3
  disableIMDSv1: true
  disablePodIMDS: false
  iam:
    withAddonPolicies:
      albIngress: false # Disable ALB Ingress Controller
      appMesh: false
      appMeshPreview: false
      autoScaler: false
      awsLoadBalancerController: true # Enable AWS Load Balancer Controller
      certManager: true # Enable cert-manager
      cloudWatch: false
      ebs: false
      efs: false
      externalDNS: true # Enable ExternalDNS
      fsx: false
      imageBuilder: true
      xRay: false
  instanceSelector: {}
  instanceType: t3.medium
  preBootstrapCommands:
    # install additional packages
    - "dnf install nvme-cli links tree tcpdump sysstat ipvsadm ipset bind-utils htop -y"
    # disable hyperthreading
    - "for n in $(cat /sys/devices/system/cpu/cpu*/topology/thread_siblings_list | cut -s -d, -f2- | tr ',' '\n' | sort -un); do echo 0 > /sys/devices/system/cpu/cpu${n}/online; done"
  labels:
    alpha.eksctl.io/cluster-name: myeks
    alpha.eksctl.io/nodegroup-name: ng1
  maxSize: 3
  minSize: 3
  name: ng1
  privateNetworking: false
  releaseVersion: ""
  securityGroups:
    withLocal: null
    withShared: null
  ssh:
    allow: true
    publicKeyName: kp-aews  # ê°ì í™˜ê²½ ì •ë³´ë¡œ ìˆ˜ì •
  tags:
    alpha.eksctl.io/nodegroup-name: ng1
    alpha.eksctl.io/nodegroup-type: managed
  volumeIOPS: 3000
  volumeSize: 30
  volumeThroughput: 125
  volumeType: gp3
```

### **5. ìµœì¢… yamlë¡œ eks ë°°í¬**

**(1) kubeconfig íŒŒì¼ ê²½ë¡œ ìœ„ì¹˜ ì§€ì •**

```bash
export KUBECONFIG=~/Downloads/kubeconfig
```

**(2) ë°°í¬**

```bash
eksctl create cluster -f myeks.yaml --verbose 4
```
![Image](https://github.com/user-attachments/assets/e506d8ad-f0cb-4b77-8d66-632d5cf59845)

**ë°°í¬ì™„ë£Œ**

![Image](https://github.com/user-attachments/assets/6542bf53-4e76-48b9-940b-e6b548524e6e)


### **6. ë°°í¬ í›„ ê¸°ë³¸ ì •ë³´ í™•ì¸**

**(1) API ì„œë²„ ì—”ë“œí¬ì¸íŠ¸ ë° OIDC ì •ë³´**

API Server Endpointì™€ OpenID Connect Provider URL(oidc) í¬í•¨

![Image](https://github.com/user-attachments/assets/08f940d9-cc01-4ac9-9071-f10e053d4b8d)

**(2) Compute**

Node groupsì—ì„œ AMI(AL2023) í™•ì¸ ê°€ëŠ¥

![Image](https://github.com/user-attachments/assets/8219e160-de81-4562-9314-b266885d32df)

**(3) Networking**

AccessëŠ” Public and Privateìœ¼ë¡œ ì„¤ì •ë¨

![Image](https://github.com/user-attachments/assets/48eca529-4cab-44eb-9f2b-6df95161760f)

**(4) Add-ons**

VPC CNIì—ì„œ Edit í›„ IRSA ê¶Œí•œ ì„¤ì • í™•ì¸ â†’ í•´ë‹¹ IAM Role í™•ì¸

![Image](https://github.com/user-attachments/assets/10dbff61-1bc6-4f90-9e50-959a08303fe5)

![Image](https://github.com/user-attachments/assets/7bac79e0-b688-47da-b44f-5a63568e6d6f)

**(5) Access**

IAM Access Entriesì—ì„œ ì„¤ì¹˜ ì‹œ ì‚¬ìš©í•œ ìê²©ì¦ëª… ì‚¬ìš©ì í™•ì¸

`AmazonEKSClusterAdminPolicy` ê´€ë¦¬ì ì •ì±…ì´ í¬í•¨ë˜ì–´ ìˆì–´ EKS ê´€ë¦¬ ì½˜ì†” ì ‘ê·¼ ë° ê´€ë¦¬ ê°€ëŠ¥

![Image](https://github.com/user-attachments/assets/d1378294-57dc-4e86-acfb-3b9170e8c838)

### **7. EKS ì •ë³´ í™•ì¸**

```bash
kubectl cluster-info
```

âœ…Â **ì¶œë ¥**

```bash
Kubernetes control plane is running at https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com
CoreDNS is running at https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

### **8. ë„¤ì„ìŠ¤í˜ì´ìŠ¤ default ë³€ê²½ ì ìš©**

```bash
kubens default

# ê²°ê³¼
âœ” Active namespace is "default"
```

### **9. í˜„ì¬ Kubernetes ì»¨í…ìŠ¤íŠ¸ í™•ì¸**

```bash
cat $KUBECONFIG | grep current-context
```

âœ…Â **ì¶œë ¥**

```bash
current-context: eks-user@myeks.ap-northeast-2.eksctl.io
```

### **10. Kubernetes ì»¨í…ìŠ¤íŠ¸ ì´ë¦„ ë³€ê²½**

```bash
kubectl config rename-context "eks-user@myeks.ap-northeast-2.eksctl.io" "eksworkshop"

# ê²°ê³¼
Context "eks-user@myeks.ap-northeast-2.eksctl.io" renamed to "eksworkshop".
```

```bash
cat $KUBECONFIG | grep current-context
```

âœ…Â **ì¶œë ¥**

```bash
current-context: eksworkshop
```

### **11. ë…¸ë“œ ì •ë³´ í™•ì¸**

```bash
kubectl get node --label-columns=node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE    VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE
ip-192-168-1-193.ap-northeast-2.compute.internal   Ready    <none>   169m   v1.31.4-eks-aeac579   t3.medium       ON_DEMAND      ap-northeast-2a
ip-192-168-2-52.ap-northeast-2.compute.internal    Ready    <none>   169m   v1.31.4-eks-aeac579   t3.medium       ON_DEMAND      ap-northeast-2b
ip-192-168-3-72.ap-northeast-2.compute.internal    Ready    <none>   169m   v1.31.4-eks-aeac579   t3.medium       ON_DEMAND      ap-northeast-2
```

```bash
kubectl get node -v=6
```

âœ…Â **ì¶œë ¥**

```bash
I0212 15:08:46.728964  137397 loader.go:402] Config loaded from file:  /home/devshin/Downloads/kubeconfig
I0212 15:08:46.729339  137397 envvar.go:172] "Feature gate default state" feature="ClientsAllowCBOR" enabled=false
I0212 15:08:46.729350  137397 envvar.go:172] "Feature gate default state" feature="ClientsPreferCBOR" enabled=false
I0212 15:08:46.729355  137397 envvar.go:172] "Feature gate default state" feature="InformerResourceVersion" enabled=false
I0212 15:08:46.729359  137397 envvar.go:172] "Feature gate default state" feature="WatchListClient" enabled=false
I0212 15:08:47.170830  137397 round_trippers.go:560] GET https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/nodes?limit=500 200 OK in 436 milliseconds
NAME                                               STATUS   ROLES    AGE    VERSION
ip-192-168-1-193.ap-northeast-2.compute.internal   Ready    <none>   170m   v1.31.4-eks-aeac579
ip-192-168-2-52.ap-northeast-2.compute.internal    Ready    <none>   170m   v1.31.4-eks-aeac579
ip-192-168-3-72.ap-northeast-2.compute.internal    Ready    <none>   170m   v1.31.4-eks-aeac579
```

### **12. pod ì •ë³´ í™•ì¸**

```bash
kubectl get pod -A
```

âœ…Â **ì¶œë ¥**

```bash
NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE
kube-system   aws-node-6mctb                    2/2     Running   0          173m
kube-system   aws-node-b66dj                    2/2     Running   0          173m
kube-system   aws-node-rf79g                    2/2     Running   0          173m
kube-system   coredns-86f5954566-gqf97          1/1     Running   0          177m
kube-system   coredns-86f5954566-nntgz          1/1     Running   0          177m
kube-system   kube-proxy-jg5qj                  1/1     Running   0          173m
kube-system   kube-proxy-t2sqh                  1/1     Running   0          173m
kube-system   kube-proxy-w96mt                  1/1     Running   0          173m
kube-system   metrics-server-86bbfd75bb-j72mf   1/1     Running   0          177m
kube-system   metrics-server-86bbfd75bb-pbpkd   1/1     Running   0          177m
```

```bash
kubectl get pdb -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME             MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
coredns          N/A             1                 1                     178m
metrics-server   N/A             1                 1                     178m
```

### **13. ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹ í™•ì¸**

```bash
eksctl get nodegroup --cluster $CLUSTER_NAME
```

âœ…Â **ì¶œë ¥**

```bash
CLUSTER	NODEGROUP	STATUS	CREATED			MIN SIZE	MAX SIZE	DESIRED CAPACITY	INSTANCE TYPE	IMAGE ID		ASG NAME					TYPE
myeks	ng1		ACTIVE	2025-02-12T03:17:03Z	3		3		3			t3.medium	AL2023_x86_64_STANDARD	eks-ng1-84ca7c14-790d-ef45-8256-776960f87794	managed
```

```bash
aws eks describe-nodegroup --cluster-name $CLUSTER_NAME --nodegroup-name ng1 | jq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "nodegroup": {
    "nodegroupName": "ng1",
    "nodegroupArn": "arn:aws:eks:ap-northeast-2:378102432899:nodegroup/myeks/ng1/84ca7c14-790d-ef45-8256-776960f87794",
    "clusterName": "myeks",
    "version": "1.31",
    "releaseVersion": "1.31.4-20250203",
    "createdAt": "2025-02-12T12:17:03.928000+09:00",
    "modifiedAt": "2025-02-12T15:08:14.235000+09:00",
    "status": "ACTIVE",
    "capacityType": "ON_DEMAND",
    "scalingConfig": {
      "minSize": 3,
      "maxSize": 3,
      "desiredSize": 3
    },
    "instanceTypes": [
      "t3.medium"
    ],
    "subnets": [
      "subnet-0b53307d4d544b3bf",
      "subnet-019936bd535b68960",
      "subnet-0d19099a6b73555f8"
    ],
    "amiType": "AL2023_x86_64_STANDARD",
    "nodeRole": "arn:aws:iam::378102432899:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-aJPw1zdjbXYF",
    "labels": {
      "alpha.eksctl.io/cluster-name": "myeks",
      "alpha.eksctl.io/nodegroup-name": "ng1"
    },
    "resources": {
      "autoScalingGroups": [
        {
          "name": "eks-ng1-84ca7c14-790d-ef45-8256-776960f87794"
        }
      ]
    },
    "health": {
      "issues": []
    },
    "updateConfig": {
      "maxUnavailable": 1
    },
    "launchTemplate": {
      "name": "eksctl-myeks-nodegroup-ng1",
      "version": "1",
      "id": "lt-0ec600e4f000289da"
    },
    "tags": {
      "aws:cloudformation:stack-name": "eksctl-myeks-nodegroup-ng1",
      "alpha.eksctl.io/cluster-name": "myeks",
      "alpha.eksctl.io/nodegroup-name": "ng1",
      "aws:cloudformation:stack-id": "arn:aws:cloudformation:ap-northeast-2:378102432899:stack/eksctl-myeks-nodegroup-ng1/c502af50-e8ef-11ef-89e7-022a714bdf75",
      "eksctl.cluster.k8s.io/v1alpha1/cluster-name": "myeks",
      "aws:cloudformation:logical-id": "ManagedNodeGroup",
      "alpha.eksctl.io/nodegroup-type": "managed",
      "alpha.eksctl.io/eksctl-version": "0.203.0"
    }
  }
}
```

### **14. eks addon í™•ì¸**

```bash
eksctl get addon --cluster $CLUSTER_NAME
```

âœ…Â **ì¶œë ¥**

```bash
2025-02-12 15:29:21 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-12 15:29:21 [â„¹]  getting all addons
2025-02-12 15:29:23 [â„¹]  to see issues for an addon run `eksctl get addon --name <addon-name> --cluster <cluster-name>`
NAME		VERSION			STATUS	ISSUES	IAMROLE										UPDATE AVAILABLE	CONFIGURATION VALUES		POD IDENTITY ASSOCIATION ROLES
coredns		v1.11.4-eksbuild.2	ACTIVE	0													
kube-proxy	v1.31.3-eksbuild.2	ACTIVE	0													
metrics-server	v0.7.2-eksbuild.1	ACTIVE	0													
vpc-cni		v1.19.2-eksbuild.5	ACTIVE	0	arn:aws:iam::378102432899:role/eksctl-myeks-addon-vpc-cni-Role1-fGF6qGwGjFyL			enableNetworkPolicy: "true"	
```

### **15. ê´€ë¦¬í˜• ë…¸ë“œê·¸ë£¹(EC2) ì ‘ì† ë° ë…¸ë“œ ì •ë³´ í™•ì¸**

**(1) EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ IAM Role í™•ì¸**

EC2 ì¸ìŠ¤í„´ìŠ¤ ë³´ì•ˆ ì„¤ì •ì—ì„œ IAM Roleì´ ë§¤í•‘ë˜ì–´ ìˆìœ¼ë©°, **EC2 ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼**ì— ì—°ê²°ë¨

![Image](https://github.com/user-attachments/assets/15a6bd2e-ebce-43a4-ba6b-f7f8f0d433a7)

managedNodeGroupsì˜ IAM ì„¤ì •ê³¼ ë§¤ì¹­ë˜ì–´ awsLoadBalancerController ì‹¤í–‰ ì‹œ í•„ìš”í•œ ê¶Œí•œì„ ì œê³µ

![Image](https://github.com/user-attachments/assets/a6960ec2-b4e2-4a9f-bd27-33af25932a29)

`awsLoadBalancerController`, `certManager`, `externalDNS` ê¶Œí•œ í™œì„±í™”

```yaml
managedNodeGroups:
- amiFamily: AmazonLinux2023
  desiredCapacity: 3
  disableIMDSv1: true
  disablePodIMDS: false
  iam:
    withAddonPolicies:
      albIngress: false # Disable ALB Ingress Controller
      appMesh: false
      appMeshPreview: false
      autoScaler: false
      awsLoadBalancerController: true # Enable AWS Load Balancer Controller
      certManager: true # Enable cert-manager
      cloudWatch: false
      ebs: false
      efs: false
      externalDNS: true # Enable ExternalDNS
      fsx: false
      imageBuilder: true
      xRay: false
```

**(2) ì¸ìŠ¤í„´ìŠ¤ ê³µì¸ IP í™•ì¸**

```bash
[root@operator-host ~]# aws ec2 describe-instances --query "Reservations[*].Instances[*].{InstanceID:InstanceId, PublicIPAdd:PublicIpAddress, PrivateIPAdd:PrivateIpAddress, InstanceName:Tags[?Key=='Name']|[0].Value, Status:State.Name}" --filters Name=instance-state-name,Values=running --output table
```

âœ…Â **ì¶œë ¥**

```bash
-----------------------------------------------------------------------------------------
|                                   DescribeInstances                                   |
+----------------------+-----------------+----------------+-----------------+-----------+
|      InstanceID      |  InstanceName   | PrivateIPAdd   |   PublicIPAdd   |  Status   |
+----------------------+-----------------+----------------+-----------------+-----------+
|  i-0d14501e2c8353ae6 |  myeks-ng1-Node |  192.168.3.72  |  43.201.115.81  |  running  |
|  i-00db22b426cc7efb5 |  operator-host  |  172.20.1.100  |  15.165.15.90   |  running  |
|  i-090451779dfb774e9 |  myeks-ng1-Node |  192.168.1.193 |  43.202.57.204  |  running  |
|  i-0e8bab88cd0a40ae8 |  myeks-ng1-Node |  192.168.2.52  |  15.164.179.214 |  running  |
+----------------------+-----------------+----------------+-----------------+-----------+
```

**(3) ì¸ìŠ¤í„´ìŠ¤ ê³µì¸ IP ë³€ìˆ˜ ì§€ì •**

```bash
export N1=43.202.57.204
export N2=15.164.179.214
export N3=43.201.115.81
echo $N1, $N2, $N3
```

âœ…Â **ì¶œë ¥**

```bash
43.202.57.204, 15.164.179.214, 43.201.115.81
```

**(4) ping í…ŒìŠ¤íŠ¸**

```bash
ping -c 2 $N1
```

âœ…Â **ì¶œë ¥**

```bash
# ì¶œë ¥: ping ì‹¤íŒ¨ (100% packet loss)
PING 43.202.57.204 (43.202.57.204) 56(84) bytes of data.

--- 43.202.57.204 ping statistics ---
2 packets transmitted, 0 received, 100% packet loss, time 1037ms
```

**(5) ê´€ë¦¬í˜• ì›Œì»¤ë…¸ë“œ ë³´ì•ˆê·¸ë£¹ í™•ì¸**

- **ë…¸ë“œê·¸ë£¹ Remote Access ë³´ì•ˆê·¸ë£¹**ê³¼ **EKS í´ëŸ¬ìŠ¤í„° ë³´ì•ˆê·¸ë£¹** ì¡´ì¬
- Remote Access ë³´ì•ˆê·¸ë£¹: `sg-08385fad7996593f1`
- EKS í´ëŸ¬ìŠ¤í„° ë³´ì•ˆê·¸ë£¹: `sg-073b338fccd7776e7`

![Image](https://github.com/user-attachments/assets/0a4401a3-5481-4c0c-b92d-1b9b8ad27818)

**(6) Remote Access ë³´ì•ˆê·¸ë£¹ ì„¤ì •**

- ì§‘ ê³µì¸ IPì™€ Operator ì„œë²„ ë‚´ë¶€ IP(172.20.1.100)ë¥¼ ì†ŒìŠ¤ IPë¡œ ì¶”ê°€

![Image](https://github.com/user-attachments/assets/2886c104-df7d-46df-994c-3f80eaf35715)


- **Remote Access ë³´ì•ˆê·¸ë£¹ ID ë³€ìˆ˜ ì§€ì •**

```bash
export MNSGID=sg-08385fad7996593f1
```

- **ì§‘ ê³µì¸ IP ì¸ë°”ìš´ë“œ ê·œì¹™ ì¶”ê°€**

```bash

aws ec2 authorize-security-group-ingress --group-id $MNSGID --protocol '-1' --cidr $(curl -s ipinfo.io/ip)/32

# ê²°ê³¼
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-0e2dcc79069298593",
            "GroupId": "sg-08385fad7996593f1",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "182.230.60.93/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-0e2dcc79069298593"
        }
    ]
}
```

- **Operator ì„œë²„ ë‚´ë¶€ IP ì¸ë°”ìš´ë“œ ê·œì¹™ ì¶”ê°€**

```bash
aws ec2 authorize-security-group-ingress --group-id $MNSGID --protocol '-1' --cidr 172.20.1.100/32

# ê²°ê³¼
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-062028d793058f3d1",
            "GroupId": "sg-08385fad7996593f1",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "172.20.1.100/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-062028d793058f3d1"
        }
    ]
}
```

**(7) ping í…ŒìŠ¤íŠ¸**

```bash
ping -c 2 $N1
```

âœ…Â **ì¶œë ¥**

```bash
# ping ì„±ê³µ
PING 43.202.57.204 (43.202.57.204) 56(84) bytes of data.
64 bytes from 43.202.57.204: icmp_seq=1 ttl=115 time=6.78 ms
64 bytes from 43.202.57.204: icmp_seq=2 ttl=115 time=20.1 ms

--- 43.202.57.204 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 6.783/13.453/20.123/6.670 ms
```

```bash
# Operator-hostì—ì„œ ping í…ŒìŠ¤íŠ¸
[root@operator-host ~]# ping -c 2 192.168.1.193
```

âœ…Â **ì¶œë ¥**

```bash
# ping ì„±ê³µ
PING 192.168.1.193 (192.168.1.193) 56(84) bytes of data.
64 bytes from 192.168.1.193: icmp_seq=1 ttl=127 time=0.227 ms
64 bytes from 192.168.1.193: icmp_seq=2 ttl=127 time=0.498 ms

--- 192.168.1.193 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1006ms
rtt min/avg/max/mdev = 0.227/0.362/0.498/0.136 ms
```

- **Operator-Host**ì—ì„œ **ì›Œì»¤ë…¸ë“œ ì„œë¸Œë„·**ìœ¼ë¡œ **ping** ì„±ê³µ
- **myeks-VPC ë³´ì•ˆê·¸ë£¹**ì— Operator-VPC(172.20.1.100/32) ì¸ë°”ìš´ë“œ ê·œì¹™ ì¶”ê°€ë¡œ ì ‘ê·¼ ê°€ëŠ¥

**(8) ì›Œì»¤ ë…¸ë“œ SSH  ì ‘ì† í™•ì¸**

```bash
ssh ec2-user@$N1

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Mon Feb  3 23:59:19 2025 from 52.94.123.246
[ec2-user@ip-192-168-1-193 ~]$
```

```bash
ssh ec2-user@$N2

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Mon Feb  3 23:59:19 2025 from 52.94.123.246
[ec2-user@ip-192-168-2-52 ~]$
```

```bash
ssh ec2-user@$N3

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Mon Feb  3 23:59:19 2025 from 52.94.123.246
[ec2-user@ip-192-168-3-72 ~]$
```

**(9) ìš´ì˜ì„œë²„ EC2ì—ì„œ ì›Œì»¤ë…¸ë“œ EC2 ì ‘ì† ë° ì •ë³´ í™•ì¸**

**ì¸ìŠ¤í„´ìŠ¤ ê³µì¸ IP ë³€ìˆ˜ ì§€ì •**

```bash
[root@operator-host ~]# export N1=192.168.1.193
[root@operator-host ~]# export N2=192.168.2.52
[root@operator-host ~]# export N3=192.168.3.72
[root@operator-host ~]# echo $N1, $N2, $N3
192.168.1.193, 192.168.2.52, 192.168.3.72
```

**ê° ì›Œì»¤ë…¸ë“œì— ping í…ŒìŠ¤íŠ¸**

```bash
[root@operator-host ~]# ping -c 2 $N1
```

âœ…Â **ì¶œë ¥**

```bash
PING 192.168.1.193 (192.168.1.193) 56(84) bytes of data.
64 bytes from 192.168.1.193: icmp_seq=1 ttl=127 time=0.232 ms
64 bytes from 192.168.1.193: icmp_seq=2 ttl=127 time=0.242 ms

--- 192.168.1.193 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1007ms
rtt min/avg/max/mdev = 0.232/0.237/0.242/0.005 ms
```

### **16. ë…¸ë“œ ì •ë³´ í™•ì¸**

**(1) ê° ë…¸ë“œì˜ í˜¸ìŠ¤íŠ¸ ì •ë³´ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i hostnamectl; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
 Static hostname: ip-192-168-1-193.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec2e13998d891ffbacc5d853155112da
         Boot ID: 3b6c5280edb84574b64c4edc1f352d1e
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250128
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.124-134.200.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0

>> node 15.164.179.214 <<
 Static hostname: ip-192-168-2-52.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec2e325020be14105530b18b0e81710a
         Boot ID: 1fdda72d00cd465d8074e7c6238882a9
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250128
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.124-134.200.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0

>> node 43.201.115.81 <<
 Static hostname: ip-192-168-3-72.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec2951238a61149817871c92befba51d
         Boot ID: 9a1cd0af9840421a9234e72a44777415
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250128
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.124-134.200.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0
```

**(2) ê° ë…¸ë“œì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c addr; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:23:93:a6:bc:61 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.1.193/24 metric 1024 brd 192.168.1.255 scope global dynamic ens5
       valid_lft 3137sec preferred_lft 3137sec
    inet6 fe80::23:93ff:fea6:bc61/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: eni01a4864c88a@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 56:be:6a:bd:2d:2a brd ff:ff:ff:ff:ff:ff link-netns cni-a59ccd2b-5db2-0159-b78e-e0797b300a23
    inet6 fe80::54be:6aff:febd:2d2a/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:49:8e:e5:f1:05 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.1.237/24 brd 192.168.1.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::49:8eff:fee5:f105/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: eni61c5a949744@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 52:41:42:c3:03:3f brd ff:ff:ff:ff:ff:ff link-netns cni-74caca86-36e2-a922-2920-c2c8c00e7b43
    inet6 fe80::5041:42ff:fec3:33f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 15.164.179.214 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:c5:5b:d1:77:57 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.2.52/24 metric 1024 brd 192.168.2.255 scope global dynamic ens5
       valid_lft 3138sec preferred_lft 3138sec
    inet6 fe80::4c5:5bff:fed1:7757/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: enibce2df30e87@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 4a:c8:23:ab:85:39 brd ff:ff:ff:ff:ff:ff link-netns cni-5408bb28-ad79-a3f3-3a60-9442968852b1
    inet6 fe80::48c8:23ff:feab:8539/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:91:4b:4c:9c:e9 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.2.42/24 brd 192.168.2.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::491:4bff:fe4c:9ce9/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: enic99196c7a64@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 8a:00:6e:37:b1:71 brd ff:ff:ff:ff:ff:ff link-netns cni-9343fb30-bdc8-5fab-b46d-3a5db58f8007
    inet6 fe80::8800:6eff:fe37:b171/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 43.201.115.81 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:d5:3d:4a:54:bd brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.72/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 3144sec preferred_lft 3144sec
    inet6 fe80::8d5:3dff:fe4a:54bd/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

**(3) ê° ë…¸ë“œì˜ ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c route; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
default via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.0.2 via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.1.0/24 dev ens5 proto kernel scope link src 192.168.1.193 metric 1024 
192.168.1.1 dev ens5 proto dhcp scope link src 192.168.1.193 metric 1024 
192.168.1.59 dev eni61c5a949744 scope link 
192.168.1.90 dev eni01a4864c88a scope link 

>> node 15.164.179.214 <<
default via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.0.2 via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.2.0/24 dev ens5 proto kernel scope link src 192.168.2.52 metric 1024 
192.168.2.1 dev ens5 proto dhcp scope link src 192.168.2.52 metric 1024 
192.168.2.72 dev enibce2df30e87 scope link 
192.168.2.248 dev enic99196c7a64 scope link 

>> node 43.201.115.81 <<
default via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.0.2 via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.3.0/24 dev ens5 proto kernel scope link src 192.168.3.72 metric 1024 
192.168.3.1 dev ens5 proto dhcp scope link src 192.168.3.72 metric 1024 
```

**(4) ê° ë…¸ë“œì˜ cgroup ë²„ì „ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i stat -fc %T /sys/fs/cgroup/; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
cgroup2fs

>> node 15.164.179.214 <<
cgroup2fs

>> node 43.201.115.81 <<
cgroup2fs
```

**(5) ê° ë…¸ë“œì˜ Kubelet ì„¤ì • í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo cat /etc/kubernetes/kubelet/config.json.d/00-nodeadm.conf | jq; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
{
  "apiVersion": "kubelet.config.k8s.io/v1beta1",
  "clusterDNS": [
    "10.100.0.10"
  ],
  "kind": "KubeletConfiguration",
  "maxPods": 17
}

>> node 15.164.179.214 <<
{
  "apiVersion": "kubelet.config.k8s.io/v1beta1",
  "clusterDNS": [
    "10.100.0.10"
  ],
  "kind": "KubeletConfiguration",
  "maxPods": 17
}

>> node 43.201.115.81 <<
{
  "apiVersion": "kubelet.config.k8s.io/v1beta1",
  "clusterDNS": [
    "10.100.0.10"
  ],
  "kind": "KubeletConfiguration",
  "maxPods": 17
}
```

### **17. ìš´ì˜ì„œë²„ EC2ì—ì„œ EKS ì‚¬ìš© ì„¤ì •**

**(1) IAM ìê²©ì¦ëª… ì„¤ì •**

```bash
[root@operator-host ~]# aws configure
AWS Access Key ID : XXXXXXXXXXXXXXXXXX
AWS Secret Access Key : XXXXXXXXXXXXXXXXXX
Default region name [ap-northeast-2]: ap-northeast-2
Default output format [json]: json
```

**(2) IAM ìê²© í™•ì¸**

```bash
[root@operator-host ~]# aws sts get-caller-identity --query Arn
```

âœ…Â **ì¶œë ¥**

```bash
"arn:aws:iam::378102432899:user/eks-user"
```

**(3) kubeconfig ìƒì„±**

```bash
[root@operator-host ~]# cat ~/.kube/config
cat: /root/.kube/config: No such file or directory
```

```bash
[root@operator-host ~]# aws eks update-kubeconfig --name myeks --user-alias eks-user
Added new context eks-user to /root/.kube/config
```

**(4) kubeconfig ì •ë³´ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# cat ~/.kube/config
```

âœ…Â **ì¶œë ¥**

EKS í´ëŸ¬ìŠ¤í„° ì •ë³´, ì¸ì¦ì„œ, ì‚¬ìš©ì ì •ë³´ í¬í•¨

```bash
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJYnRmWjRVZ2Fwdkl3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBeU1USXdNekF6TURSYUZ3MHpOVEF5TVRBd016QTRNRFJhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUM5UVd3L3U5UGhSOVpueEtYU3oxemZmR1p3OHlyNzJXS0lZVHozc1c4c2hXUlhpSzh6UHo4RmVaMHQKU2Q3Ym13RzdTK1JvbXltbTVreVQ3K2F1ZWt5SGZHOExhZzNKRUlMWnBQL2lOaFNGRUsvWWlSYkN0VGY3ZWp0NAovOFlwWG9Ic0pDbXpjZ3ZvQ0dwT0dnZ2dHUFh3dlNBM0lLWW5iRmVYNENTbjVUcmpVWXpURjZYVm0wSVZMT05PCjFIY1lJK0ZxQit2dDVGd3FoOVVFYUsrRHBVa3krWmswdi9FOVJ1ZDU1QzFuWUdsRFJBNnNVS1NoamZORzZ6bS8KcjZ0QUFyUmsvTDN1cGkvajMyVHE5amF2dW1ScHlHNTM2YlhIeUpULzFuU2Y5dTF4ZzNnbThYWWtLZUdXeko3TApQbzc2aHJoUnF1eEVnd0hHaysvNGV1ZzIzQi8xQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRMGpTUFNVN1pqcWFOTTJBa0NJN1FqK2RQV2xqQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUtoSXd2cmNOTQpuNS9WS2RsdFBpTjdrcTBIZ0tHdFVMbS8zQnlSZ2daSHY3MkFKNVk3bUdsZUFabUUzOFEyNVV6M2NjT25DOEVsCjNOYnlSdzFGMFdCYnR6TU1iNmxnSDZMWW5TcHZlckROWUZ5SGNQQmZKQmRLd0hyTFhBTXNGUlNCczRUL0Nhdm0KdE4reEZaVkh5azRBbk81VlN6QjJRbmJ5dENqbmRxc3ZjajJOWS9WK3ZQbzJMQzZBckh6TXhodmF2eVRyVEtDLwpCK242c2tQM0FTNy9hT3JEeEhyaHlXQUFLUGpqSXhBeUhsZS9Db1FBQjVoNTFQQ0d3NlFZRlR0N3hyaHVMWjdSCjFMc3FIazlobGRXUDRSdjZ5Skx0a0ErOVRCdEM1Y251Z1d1VHFFUXBQZVExTWRLcTgyY2M1aFlaZXFHdXFTRjgKVU9tcHRXTFVsbVpHCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com
  name: arn:aws:eks:ap-northeast-2:378102432899:cluster/myeks
contexts:
- context:
    cluster: arn:aws:eks:ap-northeast-2:378102432899:cluster/myeks
    user: eks-user
  name: eks-user
current-context: eks-user
kind: Config
preferences: {}
users:
- name: eks-user
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1beta1
      args:
      - --region
      - ap-northeast-2
      - eks
      - get-token
      - --cluster-name
      - myeks
      - --output
      - json
      command: aws
```

**(5) EKS API DNS ì¡°íšŒ**

```bash
(eks-user:N/A) [root@operator-host ~]# APIDNS=$(aws eks describe-cluster --name myeks | jq -r .cluster.endpoint | cut -d '/' -f 3)
```

```bash
(eks-user:N/A) [root@operator-host ~]# dig +short $APIDNS
```

âœ…Â **ì¶œë ¥**

```bash
43.201.119.98
15.165.73.21
```

**(6) í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl cluster-info
```

âœ…Â **ì¶œë ¥**

```bash
Kubernetes control plane is running at https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com
CoreDNS is running at https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

![Image](https://github.com/user-attachments/assets/2555477c-ba71-4b4a-92b9-42629c0d065a)

**(7) ë…¸ë“œ ì •ë³´ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get node -v6
```

âœ…Â **ì¶œë ¥**

```bash
I0212 17:07:06.500164    3826 loader.go:395] Config loaded from file:  /root/.kube/config
I0212 17:07:07.311634    3826 round_trippers.go:553] GET https://D25BC1FD83873C599EC920D5193DC864.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/nodes?limit=500 200 OK in 805 milliseconds
NAME                                               STATUS   ROLES    AGE     VERSION
ip-192-168-1-193.ap-northeast-2.compute.internal   Ready    <none>   4h48m   v1.31.4-eks-aeac579
ip-192-168-2-52.ap-northeast-2.compute.internal    Ready    <none>   4h48m   v1.31.4-eks-aeac579
ip-192-168-3-72.ap-northeast-2.compute.internal    Ready    <none>   4h48m   v1.31.4-eks-aeac579
```

---

## **ğŸŒ ë„¤íŠ¸ì›Œí¬ ê¸°ë³¸ ì •ë³´ í™•ì¸**

### **1. CNI ì •ë³´ í™•ì¸**

```bash
kubectl describe daemonset aws-node --namespace kube-system | grep Image | cut -d "/" -f 2
```

âœ…Â **ì¶œë ¥**

```bash
amazon-k8s-cni-init:v1.19.2-eksbuild.5
amazon-k8s-cni:v1.19.2-eksbuild.5
amazon
```

### **2. ë…¸ë“œ IP í™•ì¸**

```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].{PublicIPAdd:PublicIpAddress,PrivateIPAdd:PrivateIpAddress,InstanceName:Tags[?Key=='Name']|[0].Value,Status:State.Name}" --filters Name=instance-state-name,Values=running --output table
```

âœ…Â **ì¶œë ¥**

```bash
------------------------------------------------------------------
|                        DescribeInstances                       |
+----------------+-----------------+------------------+----------+
|  InstanceName  |  PrivateIPAdd   |   PublicIPAdd    | Status   |
+----------------+-----------------+------------------+----------+
|  myeks-ng1-Node|  192.168.3.72   |  43.201.115.81   |  running |
|  operator-host |  172.20.1.100   |  15.165.15.90    |  running |
|  myeks-ng1-Node|  192.168.1.193  |  43.202.57.204   |  running |
|  myeks-ng1-Node|  192.168.2.52   |  15.164.179.214  |  running |
+----------------+-----------------+------------------+----------+
```

### **3. Pod ì •ë³´ í™•ì¸**

```bash
k get pod -A
```

âœ…Â **ì¶œë ¥**

```bash
NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE
kube-system   aws-node-6mctb                    2/2     Running   0          5h8m
kube-system   aws-node-b66dj                    2/2     Running   0          5h8m
kube-system   aws-node-rf79g                    2/2     Running   0          5h8m
kube-system   coredns-86f5954566-gqf97          1/1     Running   0          5h12m
kube-system   coredns-86f5954566-nntgz          1/1     Running   0          5h12m
kube-system   kube-proxy-jg5qj                  1/1     Running   0          5h8m
kube-system   kube-proxy-t2sqh                  1/1     Running   0          5h8m
kube-system   kube-proxy-w96mt                  1/1     Running   0          5h8m
kube-system   metrics-server-86bbfd75bb-j72mf   1/1     Running   0          5h12m
kube-system   metrics-server-86bbfd75bb-pbpkd   1/1     Running   0          5h12m
```

### **4. íŒŒë“œ IP í™•ì¸**

```bash
kubectl get pod -n kube-system -o=custom-columns=NAME:.metadata.name,IP:.status.podIP,STATUS:.status.phase
```

âœ…Â **ì¶œë ¥**

**aws-node-6mctb(192.168.1.193), kube-proxy-w96mt(192.168.1.193)ê°€ ì„œë²„ì˜ IPì™€ ê°™ì€ ì´ìœ ?**

í˜¸ìŠ¤íŠ¸ ì„œë²„ì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ ê³µìœ í•˜ê¸° ë•Œë¬¸

```bash
NAME                              IP              STATUS
aws-node-6mctb                    192.168.1.193   Running
aws-node-b66dj                    192.168.2.52    Running
aws-node-rf79g                    192.168.3.72    Running
coredns-86f5954566-gqf97          192.168.1.59    Running
coredns-86f5954566-nntgz          192.168.2.248   Running
kube-proxy-jg5qj                  192.168.3.72    Running
kube-proxy-t2sqh                  192.168.2.52    Running
kube-proxy-w96mt                  192.168.1.193   Running
metrics-server-86bbfd75bb-j72mf   192.168.1.90    Running
metrics-server-86bbfd75bb-pbpkd   192.168.2.72    Running
```

### **5. ë…¸ë“œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸**

**(1) CNI ë¡œê·¸ íŒŒì¼ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i tree /var/log/aws-routed-eni; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
/var/log/aws-routed-eni
â”œâ”€â”€ ebpf-sdk.log
â”œâ”€â”€ egress-v6-plugin.log
â”œâ”€â”€ ipamd.log
â”œâ”€â”€ network-policy-agent.log
â””â”€â”€ plugin.log

0 directories, 5 files

>> node 15.164.179.214 <<
/var/log/aws-routed-eni
â”œâ”€â”€ ebpf-sdk.log
â”œâ”€â”€ egress-v6-plugin.log
â”œâ”€â”€ ipamd.log
â”œâ”€â”€ network-policy-agent.log
â””â”€â”€ plugin.log

0 directories, 5 files

>> node 43.201.115.81 <<
/var/log/aws-routed-eni
â”œâ”€â”€ ebpf-sdk.log
â”œâ”€â”€ ipamd.log
â””â”€â”€ network-policy-agent.log

0 directories, 3 files
```

**(2) ë…¸ë“œë³„ IP ì£¼ì†Œ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -br -c addr; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.1.193/24 metric 1024 fe80::23:93ff:fea6:bc61/64 
eni01a4864c88a@if3 UP             fe80::54be:6aff:febd:2d2a/64 
ens6             UP             192.168.1.237/24 fe80::49:8eff:fee5:f105/64 
eni61c5a949744@if3 UP             fe80::5041:42ff:fec3:33f/64 

>> node 15.164.179.214 <<
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.2.52/24 metric 1024 fe80::4c5:5bff:fed1:7757/64 
enibce2df30e87@if3 UP             fe80::48c8:23ff:feab:8539/64 
ens6             UP             192.168.2.42/24 fe80::491:4bff:fe4c:9ce9/64 
enic99196c7a64@if3 UP             fe80::8800:6eff:fe37:b171/64 

>> node 43.201.115.81 <<
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.3.72/24 metric 1024 fe80::8d5:3dff:fe4a:54bd/64 
```

**(3) ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c addr; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:23:93:a6:bc:61 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.1.193/24 metric 1024 brd 192.168.1.255 scope global dynamic ens5
       valid_lft 2264sec preferred_lft 2264sec
    inet6 fe80::23:93ff:fea6:bc61/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: eni01a4864c88a@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 56:be:6a:bd:2d:2a brd ff:ff:ff:ff:ff:ff link-netns cni-a59ccd2b-5db2-0159-b78e-e0797b300a23
    inet6 fe80::54be:6aff:febd:2d2a/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:49:8e:e5:f1:05 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.1.237/24 brd 192.168.1.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::49:8eff:fee5:f105/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: eni61c5a949744@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 52:41:42:c3:03:3f brd ff:ff:ff:ff:ff:ff link-netns cni-74caca86-36e2-a922-2920-c2c8c00e7b43
    inet6 fe80::5041:42ff:fec3:33f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 15.164.179.214 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:c5:5b:d1:77:57 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.2.52/24 metric 1024 brd 192.168.2.255 scope global dynamic ens5
       valid_lft 2265sec preferred_lft 2265sec
    inet6 fe80::4c5:5bff:fed1:7757/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: enibce2df30e87@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 4a:c8:23:ab:85:39 brd ff:ff:ff:ff:ff:ff link-netns cni-5408bb28-ad79-a3f3-3a60-9442968852b1
    inet6 fe80::48c8:23ff:feab:8539/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:91:4b:4c:9c:e9 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.2.42/24 brd 192.168.2.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::491:4bff:fe4c:9ce9/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: enic99196c7a64@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 8a:00:6e:37:b1:71 brd ff:ff:ff:ff:ff:ff link-netns cni-9343fb30-bdc8-5fab-b46d-3a5db58f8007
    inet6 fe80::8800:6eff:fe37:b171/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 43.201.115.81 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:d5:3d:4a:54:bd brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.72/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 2270sec preferred_lft 2270sec
    inet6 fe80::8d5:3dff:fe4a:54bd/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

---

## **ğŸ“¡ ë³´ì¡° IPv4 ì£¼ì†Œë¥¼ íŒŒë“œê°€ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸**

### **1. CoreDNS íŒŒë“œ IP í™•ì¸**

```bash
kubectl get pod -n kube-system -l k8s-app=kube-dns -owide
```

âœ…Â **ì¶œë ¥**

CoreDNS íŒŒë“œê°€ ë³´ì¡° IPv4 ì£¼ì†Œ(192.168.2.248)ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒ

```bash
NAME                       READY   STATUS    RESTARTS   AGE     IP              NODE                                               NOMINATED NODE   READINESS GATES
coredns-86f5954566-gqf97   1/1     Running   0          5h39m   192.168.1.59    ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
coredns-86f5954566-nntgz   1/1     Running   0          5h39m   192.168.2.248   ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
```

### **2. ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c route; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
default via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.0.2 via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.1.0/24 dev ens5 proto kernel scope link src 192.168.1.193 metric 1024 
192.168.1.1 dev ens5 proto dhcp scope link src 192.168.1.193 metric 1024 
192.168.1.59 dev eni61c5a949744 scope link 
192.168.1.90 dev eni01a4864c88a scope link 

>> node 15.164.179.214 <<
default via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.0.2 via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.2.0/24 dev ens5 proto kernel scope link src 192.168.2.52 metric 1024 
192.168.2.1 dev ens5 proto dhcp scope link src 192.168.2.52 metric 1024 
192.168.2.72 dev enibce2df30e87 scope link 
192.168.2.248 dev enic99196c7a64 scope link 

>> node 43.201.115.81 <<
default via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.0.2 via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.3.0/24 dev ens5 proto kernel scope link src 192.168.3.72 metric 1024 
192.168.3.1 dev ens5 proto dhcp scope link src 192.168.3.72 metric 1024 
```

### **3. ENI ì¦ê°€ì™€ Pod IP í• ë‹¹ í™•ì¸ ì‹¤ìŠµ**

**(1) ê° ë…¸ë“œì—ì„œ ENIì™€ ë¼ìš°íŒ… í…Œì´ë¸”ì„ ëª¨ë‹ˆí„°ë§**

```bash
# í„°ë¯¸ë„ 1
ssh ec2-user@$N1
watch -d "ip link | egrep 'ens|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"
```

```bash
# í„°ë¯¸ë„ 2
ssh ec2-user@$N2
watch -d "ip link | egrep 'ens|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"
```

```bash
# í„°ë¯¸ë„ 3
ssh ec2-user@$N3
watch -d "ip link | egrep 'ens|eni' ;echo;echo "[ROUTE TABLE]"; route -n | grep eni"
```

**(2) netshoot-pod ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: netshoot-pod
spec:
  replicas: 3
  selector:
    matchLabels:
      app: netshoot-pod
  template:
    metadata:
      labels:
        app: netshoot-pod
    spec:
      containers:
      - name: netshoot-pod
        image: nicolaka/netshoot
        command: ["tail"]
        args: ["-f", "/dev/null"]
        terminationGracePeriodSeconds: 0
EOF

```

**netshot pod ìƒì„± ì§í›„**

![Image](https://github.com/user-attachments/assets/8f5075b3-ec25-41a4-8e0a-09d9eb9bab32)

**netshot pod ìƒì„± ì™„ë£Œ**

![Image](https://github.com/user-attachments/assets/b00e9ade-a5da-432a-927c-1eca1f21da3b)

**(3) íŒŒë“œ ìƒì„± í›„ IP í™•ì¸**

```bash
k get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
netshoot-pod-744bd84b46-4cfhr   1/1     Running   0          69s   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
netshoot-pod-744bd84b46-hkbd6   1/1     Running   0          69s   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
netshoot-pod-744bd84b46-pzv6d   1/1     Running   0          69s   192.168.2.226   ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
```


![Image](https://github.com/user-attachments/assets/899eaf81-df62-4186-b0b6-1db5ee68f1f9)

### **4. íŒŒë“œ ì´ë¦„ ë³€ìˆ˜ ì§€ì •**

```bash
PODNAME1=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[0].metadata.name}')
PODNAME2=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[1].metadata.name}')
PODNAME3=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[2].metadata.name}')
```

### **5. ë…¸ë“œ ë¼ìš°íŒ… ì •ë³´ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c route; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
NAME                            READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
netshoot-pod-744bd84b46-4cfhr   1/1     Running   0          95m   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
netshoot-pod-744bd84b46-hkbd6   1/1     Running   0          95m   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
netshoot-pod-744bd84b46-pzv6d   1/1     Running   0          95m   192.168.2.226   ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
NAME                            IP
netshoot-pod-744bd84b46-4cfhr   192.168.3.146
netshoot-pod-744bd84b46-hkbd6   192.168.1.176
netshoot-pod-744bd84b46-pzv6d   192.168.2.226

>> node 43.202.57.204 <<
default via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.0.2 via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.1.0/24 dev ens5 proto kernel scope link src 192.168.1.193 metric 1024 
192.168.1.1 dev ens5 proto dhcp scope link src 192.168.1.193 metric 1024 
192.168.1.59 dev eni61c5a949744 scope link 
192.168.1.90 dev eni01a4864c88a scope link 
192.168.1.176 dev eni1d5278cfd98 scope link 

>> node 15.164.179.214 <<
default via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.0.2 via 192.168.2.1 dev ens5 proto dhcp src 192.168.2.52 metric 1024 
192.168.2.0/24 dev ens5 proto kernel scope link src 192.168.2.52 metric 1024 
192.168.2.1 dev ens5 proto dhcp scope link src 192.168.2.52 metric 1024 
192.168.2.72 dev enibce2df30e87 scope link 
192.168.2.226 dev enia1aaba2012e scope link 
192.168.2.248 dev enic99196c7a64 scope link 

>> node 43.201.115.81 <<
default via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.0.2 via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.3.0/24 dev ens5 proto kernel scope link src 192.168.3.72 metric 1024 
192.168.3.1 dev ens5 proto dhcp scope link src 192.168.3.72 metric 1024 
192.168.3.146 dev enia32f5632a44 scope link 
```

### **6. Pod IP í™•ì¸ê³¼ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§„ì…**

**(1) Pod IP ë° ENI ì—°ê²° í™•ì¸**

```bash
[ec2-user@ip-192-168-3-72 ~]$ ip -c addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:d5:3d:4a:54:bd brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.72/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 3318sec preferred_lft 3318sec
    inet6 fe80::8d5:3dff:fe4a:54bd/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: enia32f5632a44@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 76:e0:80:d5:57:23 brd ff:ff:ff:ff:ff:ff link-netns cni-48fae262-f8c0-ab50-61f1-b90d6344980d
    inet6 fe80::74e0:80ff:fed5:5723/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:da:c7:72:d0:e1 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.3.120/24 brd 192.168.3.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::8da:c7ff:fe72:d0e1/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

`ENI(enia32f5632a44@if3)`ê°€ ì¶”ê°€ë˜ì–´ ìˆìœ¼ë©°, Pod ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ ì—°ê²°ë¨

```bash
3: enia32f5632a44@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 76:e0:80:d5:57:23 brd ff:ff:ff:ff:ff:ff link-netns cni-48fae262-f8c0-ab50-61f1-b90d6344980d
    inet6 fe80::74e0:80ff:fed5:5723/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

**(2) `lsns` ëª…ë ¹ì–´ë¡œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸**

**pause ì»¨í…Œì´ë„ˆ**ì˜ PID(110946)ë¥¼ í™•ì¸

```bash
[ec2-user@ip-192-168-3-72 ~]$ sudo lsns -t net
        NS TYPE NPROCS    PID USER     NETNSID NSFS                                                COMMAND
4026531840 net     115      1 root  unassigned                                                     /usr/li
4026532216 net       2 110946 65535          0 /run/netns/cni-48fae262-f8c0-ab50-61f1-b90d6344980d /pause
```

**(3) `nsenter` ëª…ë ¹ì–´ë¡œ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì§„ì…**

```bash
[ec2-user@ip-192-168-3-72 ~]$ PID=110946
[ec2-user@ip-192-168-3-72 ~]$ sudo nsenter -t $PID -n ip -c addr
```

âœ…Â **ì¶œë ¥**

```bash
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host proto kernel_lo 
       valid_lft forever preferred_lft forever
3: eth0@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether e2:ab:55:84:93:dc brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.3.146/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::e0ab:55ff:fe84:93dc/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

**(4) Pod IP í™•ì¸ ê²°ê³¼**

- Pod IP(192.168.3.146)ê°€ ì¶œë ¥ë˜ë©°, ì´ëŠ” ì„œë²„ IPê°€ ì•„ë‹Œ Pod IPì„
- Podì˜ ì¸í„°í˜ì´ìŠ¤ `eth0@if3`ì™€ ENI `enia32f5632a44@if3`ê°€ ì—°ê²°ë˜ì–´ ìˆìŒ

```bash
k get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                            READY   STATUS    RESTARTS   AGE    IP              NODE                                               NOMINATED NODE   READINESS GATES
netshoot-pod-744bd84b46-4cfhr   1/1     Running   0          114m   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
netshoot-pod-744bd84b46-hkbd6   1/1     Running   0          114m   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
netshoot-pod-744bd84b46-pzv6d   1/1     Running   0          114m   192.168.2.226   ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
```

### **7. Podì— Zshë¡œ ì§„ì…í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸**

**(1) Pod ëª©ë¡ í™•ì¸**

```bash
k get pod
```

âœ…Â **ì¶œë ¥**

```bash
NAME                            READY   STATUS    RESTARTS   AGE
netshoot-pod-744bd84b46-4cfhr   1/1     Running   0          117m
netshoot-pod-744bd84b46-hkbd6   1/1     Running   0          117m
netshoot-pod-744bd84b46-pzv6d   1/1     Running   0          117m
```

**(2) Zshë¡œ Pod ë‚´ë¶€ ì§„ì… ë° ë„¤íŠ¸ì›Œí¬ í™•ì¸**

```bash
kubectl exec -it $PODNAME1 -- zsh

# ê²°ê³¼
                    dP            dP                           dP   
                    88            88                           88   
88d888b. .d8888b. d8888P .d8888b. 88d888b. .d8888b. .d8888b. d8888P 
88'  `88 88ooood8   88   Y8ooooo. 88'  `88 88'  `88 88'  `88   88   
88    88 88.  ...   88         88 88    88 88.  .88 88.  .88   88   
dP    dP `88888P'   dP   `88888P' dP    dP `88888P' `88888P'   dP   
                                                                    
Welcome to Netshoot! (github.com/nicolaka/netshoot)
Version: 0.13
```

**Netshoot ì»¨í…Œì´ë„ˆì— ì§„ì… í›„, `ip -c addr`ë¡œ ë„¤íŠ¸ì›Œí¬ ì •ë³´ í™•ì¸**

```bash
netshoot-pod-744bd84b46-4cfhr [ ~ ] ip -c addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host proto kernel_lo 
       valid_lft forever preferred_lft forever
3: eth0@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether e2:ab:55:84:93:dc brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.168.3.146/32 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::e0ab:55ff:fe84:93dc/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

**(3) Pod ë‚´ë¶€ ë¼ìš°íŒ… ì •ë³´ í™•ì¸**

```bash
netshoot-pod-744bd84b46-4cfhr [ ~ ] cat /etc/resolv.conf
```

âœ…Â **ì¶œë ¥**

```bash
search default.svc.cluster.local svc.cluster.local cluster.local ap-northeast-2.compute.internal
nameserver 10.100.0.10
options ndots:5
```

### **8. Pod ì •ë³´ í™•ì¸**

```bash
k get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                            READY   STATUS    RESTARTS   AGE    IP              NODE                                               NOMINATED NODE   READINESS GATES
netshoot-pod-744bd84b46-4cfhr   1/1     Running   0          3h3m   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
netshoot-pod-744bd84b46-hkbd6   1/1     Running   0          3h3m   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
netshoot-pod-744bd84b46-pzv6d   1/1     Running   0          3h3m   192.168.2.226   ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
```

### **9. íŒŒë“œê°„ í†µì‹  í…ŒìŠ¤íŠ¸**

**(1) íŒŒë“œ IP ë³€ìˆ˜ ì§€ì •**

```bash
PODIP1=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[0].status.podIP}')
PODIP2=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[1].status.podIP}')
PODIP3=$(kubectl get pod -l app=netshoot-pod -o jsonpath='{.items[2].status.podIP}')
```

**(2) íŒŒë“œ1ì—ì„œ íŒŒë“œ2ë¡œ ping í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it $PODNAME1 -- ping -c 2 $PODIP2
```

âœ…Â **ì¶œë ¥**

```bash
PING 192.168.1.176 (192.168.1.176) 56(84) bytes of data.
64 bytes from 192.168.1.176: icmp_seq=1 ttl=125 time=1.38 ms
64 bytes from 192.168.1.176: icmp_seq=2 ttl=125 time=1.23 ms

--- 192.168.1.176 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 1.225/1.303/1.381/0.078 ms
```

**(3) í†µì‹  í™•ì¸ì„ ìœ„í•œ íŒ¨í‚· ìº¡ì²˜**

ICMP íŒ¨í‚·ë§Œ ìº¡ì²˜í•˜ëŠ” ëª…ë ¹ ì‚¬ìš©

```bash
[ec2-user@ip-192-168-1-193 ~]$ sudo tcpdump -i any -nn icmp
tcpdump: data link type LINUX_SLL2
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes

[ec2-user@ip-192-168-2-52 ~]$ sudo tcpdump -i any -nn icmp
tcpdump: data link type LINUX_SLL2
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes

[ec2-user@ip-192-168-3-72 ~]$ sudo tcpdump -i any -nn icmp
tcpdump: data link type LINUX_SLL2
dropped privs to tcpdump
tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
listening on any, link-type LINUX_SLL2 (Linux cooked v2), snapshot length 262144 bytes

```

![Image](https://github.com/user-attachments/assets/d2d5e0de-7386-4207-a8dd-b7f84e5e1c15)

**(4) Pod ê°„ Ping í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it $PODNAME1 -- ping -c 2 $PODIP2
```


![Image](https://github.com/user-attachments/assets/c5217ef8-37e0-41d8-b9ad-dd6466a55bff)

```bash
13:00:13.795567 ens5  In  IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 1, length 64
13:00:13.795632 eni1d5278cfd98 Out IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 1, length 64
13:00:13.795646 eni1d5278cfd98 In  IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 1, length 64
13:00:13.795654 ens5  Out IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 1, length 64
13:00:14.796938 ens5  In  IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 2, length 64
13:00:14.796970 eni1d5278cfd98 Out IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 2, length 64
13:00:14.796989 eni1d5278cfd98 In  IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 2, length 64
13:00:14.796996 ens5  Out IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 2, length 64
```

```bash
13:00:13.794944 enia32f5632a44 In  IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 1, length 64
13:00:13.794990 ens5  Out IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 1, length 64
13:00:13.796201 ens5  In  IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 1, length 64
13:00:13.796236 enia32f5632a44 Out IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 1, length 64
13:00:14.796330 enia32f5632a44 In  IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 2, length 64
13:00:14.796363 ens5  Out IP 192.168.3.146 > 192.168.1.176: ICMP echo request, id 110, seq 2, length 64
13:00:14.797526 ens5  In  IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 2, length 64
13:00:14.797542 enia32f5632a44 Out IP 192.168.1.176 > 192.168.3.146: ICMP echo reply, id 110, seq 2, length 64
```

**tcpdump ê²°ê³¼ ë¶„ì„**

- `ens5`ì™€ `eni1d5278cfd98` ì¸í„°í˜ì´ìŠ¤ë¥¼ í†µí•´ ICMP ìš”ì²­ê³¼ ì‘ë‹µì´ ì˜¤ê³ ê°
- NAT ì—†ì´ ì›ë³¸ IPë¡œ í†µì‹ ë¨

### **10. ë„¤íŠ¸ì›Œí¬ ê²½ë¡œ í™•ì¸**

**(1) ip rule í™•ì¸**

```bash
[ec2-user@ip-192-168-1-193 ~]$ ip rule
```

âœ…Â **ì¶œë ¥**

```bash
0:	from all lookup local
512:	from all to 192.168.1.90 lookup main
512:	from all to 192.168.1.59 lookup main
512:	from all to 192.168.1.176 lookup main
1024:	from all fwmark 0x80/0x80 lookup main
32766:	from all lookup main
32767:	from all lookup default
```

**(2) ip route í…Œì´ë¸” í™•ì¸**

**ê° ì¸í„°í˜ì´ìŠ¤ì˜ ë¡œì»¬ IP ì •ë³´ í™•ì¸**

```bash
[ec2-user@ip-192-168-1-193 ~]$ ip route show table local
```

âœ…Â **ì¶œë ¥**

```bash
local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 
local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 
broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 
local 192.168.1.193 dev ens5 proto kernel scope host src 192.168.1.193 
local 192.168.1.237 dev ens6 proto kernel scope host src 192.168.1.237 
broadcast 192.168.1.255 dev ens5 proto kernel scope link src 192.168.1.193 
broadcast 192.168.1.255 dev ens6 proto kernel scope link src 192.168.1.237
```

ê¸°ë³¸ ê²Œì´íŠ¸ì›¨ì´ ë° ENIë³„ ì—°ê²° ì •ë³´ í™•ì¸

```bash
[ec2-user@ip-192-168-1-193 ~]$ ip route show table main
```

âœ…Â **ì¶œë ¥**

```bash
default via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.0.2 via 192.168.1.1 dev ens5 proto dhcp src 192.168.1.193 metric 1024 
192.168.1.0/24 dev ens5 proto kernel scope link src 192.168.1.193 metric 1024 
192.168.1.1 dev ens5 proto dhcp scope link src 192.168.1.193 metric 1024 
192.168.1.59 dev eni61c5a949744 scope link 
192.168.1.90 dev eni01a4864c88a scope link 
192.168.1.176 dev eni1d5278cfd98 scope link
```

---

## **ğŸ“¶ íŒŒë“œì—ì„œ ì™¸ë¶€ í†µì‹  í…ŒìŠ¤íŠ¸ ë° í™•ì¸**

- **Podì—ì„œ ì™¸ë¶€ë¡œ ping í…ŒìŠ¤íŠ¸**í•˜ë©° **NAT ê³¼ì •ì„ í™•ì¸**
- **Pod**ëŠ” ë‚´ë¶€ IPë¡œ í†µì‹ í•˜ì§€ë§Œ, ì™¸ë¶€ë¡œ ë‚˜ê°ˆ ë•ŒëŠ” **ì„œë²„ì˜ ìœ ë™ ê³µì¸ IP**ë¡œ **NAT**ë˜ì–´ í†µì‹ ë¨


### **1. Podì—ì„œ ì™¸ë¶€ë¡œ ping í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it $PODNAME1 -- ping -c 1 www.google.com
```

![Image](https://github.com/user-attachments/assets/0dc4ad34-aa79-4811-a545-608c23f0da4a)


âœ… **ì¶œë ¥**

```bash
13:35:28.230157 enia32f5632a44 In  IP 192.168.3.146 > 172.217.161.228: ICMP echo request, id 116, seq 1, length 64
13:35:28.230179 ens5  Out IP 192.168.3.72 > 172.217.161.228: ICMP echo request, id 35777, seq 1, length 64
13:35:28.256496 ens5  In  IP 172.217.161.228 > 192.168.3.72: ICMP echo reply, id 35777, seq 1, length 64
13:35:28.256529 enia32f5632a44 Out IP 172.217.161.228 > 192.168.3.146: ICMP echo reply, id 116, seq 1, length 64
```

### **2. ì™¸ë¶€ë¡œ ì§€ì†ì  ping í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it $PODNAME1 -- ping -i 0.1 www.google.com
```

![Image](https://github.com/user-attachments/assets/063608c2-140a-4993-bddf-566975d7eece)


```bash
64 bytes from sin01s16-in-f4.1e100.net (172.217.25.164): icmp_seq=174 ttl=47 time=35.0 ms
```

**veth**(enia32f5632a44)ì—ì„œëŠ” **Pod IP**ê°€ ë³´ì´ì§€ë§Œ, **ens5**ì—ì„œëŠ” **ì„œë²„ IP**ê°€ ë³´ì´ë©° **NAT**ê°€ ì ìš©ë¨

```bash
13:37:01.153999 ens5  In  IP 172.217.25.164 > 192.168.3.72: ICMP echo reply, id 48046, seq 174, length 64
13:37:01.154037 enia32f5632a44 Out IP 172.217.25.164 > 192.168.3.146: ICMP echo reply, id 122, seq 174, length 64
```

### **3. ì„œë²„ ê³µì¸ IP í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i curl -s ipinfo.io/ip; echo; echo; done
```

âœ…Â **ì¶œë ¥**

**ì¶œë ¥ëœ IPëŠ” ì„œë²„ì˜ ìœ ë™ ê³µì¸ IP**

```bash
>> node 43.202.57.204 <<
43.202.57.204

>> node 15.164.179.214 <<
15.164.179.214

>> node 43.201.115.81 <<
43.201.115.81
```

**Podê°€ ì™¸ë¶€ í†µì‹ í•  ë•Œ** ì„œë²„ì˜ **ê³µì¸ IPë¡œ NAT**ë˜ì–´ ë‚˜ê°

![Image](https://github.com/user-attachments/assets/688b33b2-2797-4ae6-beeb-eecc0d00e5ae)

### **4. Pod ì™¸ë¶€ ì¸í„°ë„· í†µì‹  ì‹œ NAT í™•ì¸**

```bash
for i in $PODNAME1 $PODNAME2 $PODNAME3; do echo ">> Pod : $i <<"; kubectl exec -it $i -- curl -s ipinfo.io/ip; echo; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> Pod : netshoot-pod-744bd84b46-4cfhr <<
43.201.115.81

>> Pod : netshoot-pod-744bd84b46-hkbd6 <<
43.202.57.204

>> Pod : netshoot-pod-744bd84b46-pzv6d <<
15.164.179.214
```

### **5. ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

**ì„œë²„ì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ë° ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
ssh ec2-user@$N3

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 11:05:36 2025 from 182.230.60.93
[ec2-user@ip-192-168-3-72 ~]$ 
```

**(1) ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´ í™•ì¸**

```bash
[ec2-user@ip-192-168-3-72 ~]$ ip -c addr
```

âœ…Â **ì¶œë ¥**

```bash
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:d5:3d:4a:54:bd brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.72/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 2513sec preferred_lft 2513sec
    inet6 fe80::8d5:3dff:fe4a:54bd/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: enia32f5632a44@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 76:e0:80:d5:57:23 brd ff:ff:ff:ff:ff:ff link-netns cni-48fae262-f8c0-ab50-61f1-b90d6344980d
    inet6 fe80::74e0:80ff:fed5:5723/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:da:c7:72:d0:e1 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.3.120/24 brd 192.168.3.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::8da:c7ff:fe72:d0e1/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

**(2) ë¼ìš°íŒ… í…Œì´ë¸” í™•ì¸**

```bash
[ec2-user@ip-192-168-3-72 ~]$ ip route show table main
```

âœ…Â **ì¶œë ¥**

```bash
default via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.0.2 via 192.168.3.1 dev ens5 proto dhcp src 192.168.3.72 metric 1024 
192.168.3.0/24 dev ens5 proto kernel scope link src 192.168.3.72 metric 1024 
192.168.3.1 dev ens5 proto dhcp scope link src 192.168.3.72 metric 1024 
192.168.3.146 dev enia32f5632a44 scope link
```

- ê¸°ë³¸ ê²½ë¡œ(ens5)ë¡œ ë‚˜ê°ˆ ë•Œ `iptables`ì˜ `SNAT` ê·œì¹™ì´ ì ìš©ë˜ì–´ ì„œë²„ IP(192.168.3.72)ë¡œ ë³€í™˜ë¨

**(3) iptables ê·œì¹™ í™•ì¸**

```bash
[ec2-user@ip-192-168-3-72 ~]$ sudo iptables -t nat -S | grep 'A AWS-SNAT-CHAIN'
-A AWS-SNAT-CHAIN-0 -d 192.168.0.0/16 -m comment --comment "AWS SNAT CHAIN" -j RETURN
-A AWS-SNAT-CHAIN-0 ! -o vlan+ -m comment --comment "AWS, SNAT" -m addrtype ! --dst-type LOCAL -j SNAT --to-source 192.168.3.72 --random-fully
```

- 192.168.0.0/16 ëŒ€ì—­(VPC ë‚´ë¶€)ì€ SNAT ì—†ì´ í†µì‹ í•˜ê³ , ì™¸ë¶€ í†µì‹  ì‹œì—ëŠ” SNAT ê·œì¹™ ì ìš©

**(4) Pod ê°„ í†µì‹  ì‹œ NAT ë¯¸ì ìš© ì´ìœ **

- **VPC ë‚´ë¶€ ëŒ€ì—­**ì€ NAT ì—†ì´ í†µì‹ í•˜ë©°, **ì™¸ë¶€ ì¸í„°ë„·** ëŒ€ì—­ì€ SNAT ì ìš©
- ê°™ì€ VPCì—ì„œ NATì„ ì ìš©í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ IPê°€ ê°ì¶°ì§€ê³  ì˜¤ë²„í—¤ë“œê°€ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— ë‚´ë¶€ë§ì—ì„œëŠ” NAT ì—†ì´ ë°”ë¡œ í†µì‹ 
- ì™¸ë¶€ ì¸í„°ë„· í†µì‹ ì€ `SNAT --to-source 192.168.3.72`ë¡œ ë³€í™˜ë˜ì–´ ë‚˜ê°€ë„ë¡ ì„¤ì •

### **6. AWS-SNAT-CHAIN-0ì˜ SNAT ê·œì¹™ê³¼ Pod í†µì‹  í™•ì¸**

**(1) iptables ì´ˆê¸°í™”**

```bash
sudo iptables -t filter --zero; sudo iptables -t nat --zero; sudo iptables -t mangle --zero; sudo iptables -t raw --zero
```

**(2) `watch` ëª…ë ¹ì–´ë¡œ `AWS-SNAT-CHAIN-0`, `KUBE-POSTROUTING`, `POSTROUTING` ì²´ì¸ ëª¨ë‹ˆí„°ë§**

```bash
watch -d 'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING'
```
![Image](https://github.com/user-attachments/assets/e7907bd3-3229-4228-8305-74d085a79a09)


**(3) AWS-SNAT-CHAIN-0 ê·œì¹™ ë¶„ì„**

- `192.168.0.0/16` ëŒ€ì—­ì€ SNAT ì—†ì´ í†µì‹ (`RETURN`)
- ì™¸ë¶€ ëŒ€ì—­ì€ SNATë˜ì–´ EC2 ë…¸ë“œ1 IP `192.168.3.72`ë¡œ ë³€ê²½

### **7. conntrackì„ ì´ìš©í•œ ì—°ê²° ì¶”ì **

`conntrack` ëª…ë ¹ì–´ë¡œ NATëœ ì—°ê²° ìƒíƒœ í™•ì¸

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo conntrack -L -n |grep -v '169.254.169'; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
conntrack v1.4.5 (conntrack-tools): 
icmp     1 28 src=172.30.66.58 dst=8.8.8.8 type=8 code=0 id=34392 src=8.8.8.8 dst=172.30.85.242 type=0 code=0 id=50705 mark=128 use=1
tcp      6 23 TIME_WAIT src=172.30.66.58 dst=34.117.59.81 sport=58144 dport=80 src=34.117.59.81 dst=172.30.85.242 sport=80 dport=44768 [ASSURED] mark=128 use=1
```

### **8. Pod í†µì‹  í…ŒìŠ¤íŠ¸**

operator-hostì—ì„œ Podë¡œ `ping` í…ŒìŠ¤íŠ¸

```bash
(eks-user:N/A) [root@operator-host ~]# POD1IP=192.168.1.176
(eks-user:N/A) [root@operator-host ~]# ping -c 1 $POD1IP
# ê²°ê³¼
PING 192.168.1.176 (192.168.1.176) 56(84) bytes of data.
64 bytes from 192.168.1.176: icmp_seq=1 ttl=126 time=0.674 ms

--- 192.168.1.176 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 0.674/0.674/0.674/0.000 ms
```

VPC ë‚´ë¶€ì—ì„œëŠ” NAT ì—†ì´ ë°”ë¡œ í†µì‹ ë¨

```bash
15:07:35.091537 ens5  In  IP 172.20.1.100 > 192.168.1.176: ICMP echo request, id 5445, seq 1, length 64
15:07:35.091600 eni1d5278cfd98 Out IP 172.20.1.100 > 192.168.1.176: ICMP echo request, id 5445, seq 1, length 64
15:07:35.091614 eni1d5278cfd98 In  IP 192.168.1.176 > 172.20.1.100: ICMP echo reply, id 5445, seq 1, length 64
15:07:35.091621 ens5  Out IP 192.168.1.176 > 172.20.1.100: ICMP echo reply, id 5445, seq 1, length 64
```

VPC ë‚´ë¶€ì—ì„œëŠ” NAT ì—†ì´ í†µì‹ í•˜ë©° ì™¸ë¶€ í†µì‹  ì‹œ `AWS-SNAT-CHAIN-0` ê·œì¹™ì— ì˜í•´ EC2 ë…¸ë“œ IPë¡œ SNATë˜ëŠ” ê³¼ì •ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

![Image](https://github.com/user-attachments/assets/820e2f72-9c89-4649-99c3-c8a4060f7b6c)

---

## **ğŸ›œ íŒŒë“œ1 â†’ ìš´ì˜ì„œë²„ EC2 í†µì‹ **

### 1. vpc cni env ì •ë³´ í™•ì¸

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get ds aws-node -n kube-system -o json | jq '.spec.template.spec.containers[0].env'
```

### **2. ìš´ì˜ì„œë²„ EC2 SSH ì ‘ì†**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl exec -it $PODNAME1 -- ping 172.20.1.100
```

### **3. íŒŒë“œ1 ë°°ì¹˜ ì›Œì»¤ë…¸ë“œì—ì„œ tcpdump í™•ì¸**

tcpdumpë¡œ NAT ì ìš© í™•ì¸

```bash
(eks-user:N/A) [root@operator-host ~]# sudo tcpdump -i any -nn icmp
```

 Pod IP â†’ ì„œë²„ IPë¡œ SNATë˜ì–´ ì™¸ë¶€ í†µì‹ 

```bash
15:35:03.714838 enia32f5632a44 In  IP 192.168.3.146 > 172.20.1.100: ICMP echo request, id 140, seq 77, length 64
15:35:03.714869 ens5  Out IP 192.168.3.72 > 172.20.1.100: ICMP echo request, id 56175, seq 77, length 64
```

![Image](https://github.com/user-attachments/assets/4c0f00b5-e73d-4fc3-aa4b-61c97a869165)

### **4. ì‚¬ë‚´ ë‚´ë¶€ì— ì—°ê²° í™•ì¥ëœ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ê³¼ SNAT ì—†ì´ í†µì‹  ê°€ëŠ¥í•˜ê²Œ ì„¤ì • í•´ë³´ê¸°**

**(1) ì›Œì»¤ë…¸ë“œ(192.168.1.193) ì ‘ì†**

```bash
ssh ec2-user@$N1

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 09:05:57 2025 from 182.230.60.93
[ec2-user@ip-192-168-1-193 ~]$ 
```

**(2) NAT ì •ì±… í™•ì¸**

```bash
[ec2-user@ip-192-168-1-193 ~]$ sudo iptables -t filter --zero; sudo iptables -t nat --zero; sudo iptables -t mangle --zero; sudo iptables -t raw --zero
[ec2-user@ip-192-168-1-193 ~]$ watch -d 'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING'
```

![Image](https://github.com/user-attachments/assets/10ef80f0-e301-47d2-9141-5795f6e89d55)

**(3) SNAT ì œì™¸ ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­ ì„¤ì •**

```bash
kubectl set env daemonset aws-node -n kube-system AWS_VPC_K8S_CNI_EXCLUDE_SNAT_CIDRS=172.20.0.0/16
# ê²°ê³¼
daemonset.apps/aws-node env updated
```

**(4) NAT ì •ì±… ë³€ê²½ í™•ì¸**

![Image](https://github.com/user-attachments/assets/363d605a-3af8-433d-a133-1425f89f40e7)

**(5) Ping í…ŒìŠ¤íŠ¸ë¡œ SNAT ì œì™¸ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl exec -it $PODNAME1 -- ping 172.20.1.100
```

![Image](https://github.com/user-attachments/assets/3813f7d0-221d-4458-9cd3-7aebd2471fc6)

```bash
15:53:57.159915 ens5  In  IP 172.20.1.100 > 192.168.3.146: ICMP echo reply, id 146, seq 23, length 64
15:53:57.159929 enia32f5632a44 Out IP 172.20.1.100 > 192.168.3.146: ICMP echo reply, id 146, seq 23, length 64
```

ì•„ë˜ì˜ ë‚´ìš©ì´ ì¶”ê°€ë¨

```bash
kubectl get ds aws-node -n kube-system -o json | jq '.spec.template.spec.containers[0].env'
[
	...
  {
    "name": "AWS_VPC_K8S_CNI_EXCLUDE_SNAT_CIDRS",
    "value": "172.20.0.0/16"
  }
  ...
]
```

**ens5ë¡œ NAT ë˜ë˜ ì´ì „ ìƒíƒœ**ì—ì„œ ì´ì œëŠ” **172.20.0.0/16 ëŒ€ì—­**ìœ¼ë¡œëŠ” **NAT ì—†ì´ ë°”ë¡œ í†µì‹ **ë¨


![Image](https://github.com/user-attachments/assets/dd74934b-ff37-4ce9-9f1f-37b505231d85)

**(6) iptables ëª¨ë‹ˆí„°ë§** ëª…ë ¹ì–´ ì‹¤í–‰ í›„ `AWS-SNAT-CHAIN-0` ì²´ì¸ì—ì„œ **ì¹´ìš´íŠ¸ ì¦ê°€** í™•ì¸

```bash
ssh ec2-user@$N3

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250203:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 14:21:22 2025 from 182.230.60.93
[ec2-user@ip-192-168-3-72 ~]$ watch -d 'sudo iptables -v --numeric --table nat --list AWS-SNAT-CHAIN-0; echo ; sudo iptables -v --numeric --table nat --list KUBE-POSTROUTING; echo ; sudo iptables -v --numeric --table nat --list POSTROUTING'
```

![Image](https://github.com/user-attachments/assets/6d5ade85-1eb4-4bd7-888e-39f51ee5daad)

### **5. ë””í”Œë¡œì´ë¨¼íŠ¸ ì‚­ì œë¡œ ì‹¤ìŠµ ë§ˆë¬´ë¦¬**

`kubectl delete deploy netshoot-pod`

---

## **ğŸ“ ë…¸ë“œì— íŒŒë“œ ìƒì„± ê°¯ìˆ˜ ì œí•œ**

### **1. kube-ops-view ì„¤ì¹˜**

- **kube-ops-view**ëŠ” ë…¸ë“œì™€ íŒŒë“œ ì •ë³´ë¥¼ ì‹œê°í™”í•˜ëŠ” ë„êµ¬

```bash
helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set service.main.type=LoadBalancer --set env.TZ="Asia/Seoul" --namespace kube-system

# ì„¤ì¹˜ ì™„ë£Œ ì‹œ ì¶œë ¥
"geek-cookbook" already exists with the same configuration, skipping
NAME: kube-ops-view
LAST DEPLOYED: Thu Feb 13 01:05:07 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
1. Get the application URL by running these commands:
     NOTE: It may take a few minutes for the LoadBalancer IP to be available.
           You can watch the status of by running 'kubectl get svc -w kube-ops-view'
  export SERVICE_IP=$(kubectl get svc --namespace kube-system kube-ops-view -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
  echo http://$SERVICE_IP:8080
```

### **2. kube-ops-view ì ‘ì† URL í™•ì¸ (1.5 ë°°ìœ¨)**

```bash
kubectl get svc -n kube-system kube-ops-view -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "KUBE-OPS-VIEW URL = http://"$1":8080/#scale=1.5"}'
```

âœ…Â **ì¶œë ¥**

```bash
KUBE-OPS-VIEW URL = http://a87c9a7b2db234e36a4a71827a7fbe54-363200146.ap-northeast-2.elb.amazonaws.com:8080/#scale=1.5
```

### **3. kube-ops-view ì„œë¹„ìŠ¤ í™•ì¸**

```bash
kubectl get svc -n kube-system kube-ops-view
```

âœ…Â **ì¶œë ¥**

```bash
NAME            TYPE           CLUSTER-IP      EXTERNAL-IP                                                                   PORT(S)          AGE
kube-ops-view   LoadBalancer   10.100.146.32   a87c9a7b2db234e36a4a71827a7fbe54-363200146.ap-northeast-2.elb.amazonaws.com   8080:32597/TCP   19h
```

- ì„¤ì¹˜ ì‹œ **LoadBalancer** ì„œë¹„ìŠ¤ê°€ í•¨ê»˜ ë°°í¬ë˜ë©°, ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤ë‹ˆì €ê°€ í´ë¼ìš°ë“œ ì œê³µìì˜ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±
- **External IP**ë¡œ í• ë‹¹ëœ ë¡œë“œë°¸ëŸ°ì„œ ë„ë©”ì¸ì„ í†µí•´ ì ‘ì† ê°€ëŠ¥
- í¬íŠ¸ëŠ” **8080**ìœ¼ë¡œ ì„¤ì •


![Image](https://github.com/user-attachments/assets/ec68c7c7-108d-47bc-9ed1-eb9b08299161)

### **4. ì›Œì»¤ë…¸ë“œì˜ ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸**

**t3 íƒ€ì…ì˜ ì •ë³´ í™•ì¸**

```bash
aws ec2 describe-instance-types --filters Name=instance-type,Values=t3.\* \
 --query "InstanceTypes[].{Type: InstanceType, MaxENI: NetworkInfo.MaximumNetworkInterfaces, IPv4addr: NetworkInfo.Ipv4AddressesPerInterface}" \ 
 --output table
```

âœ…Â **ì¶œë ¥**

```bash
--------------------------------------
|        DescribeInstanceTypes       |
+----------+----------+--------------+
| IPv4addr | MaxENI   |    Type      |
+----------+----------+--------------+
|  12      |  3       |  t3.large    |
|  6       |  3       |  t3.medium   |
|  15      |  4       |  t3.xlarge   |
|  15      |  4       |  t3.2xlarge  |
|  2       |  2       |  t3.nano     |
|  2       |  2       |  t3.micro    |
|  4       |  3       |  t3.small    |
+----------+----------+--------------+
```

- EC2 ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…ì— ë”°ë¼ ìµœëŒ€ Pod ë°°í¬ ê°œìˆ˜ê°€ ì œí•œë¨
- ì¥ì°©í•  ìˆ˜ ìˆëŠ” ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(ENI) ê°œìˆ˜ì™€ ê° ENIì— í• ë‹¹í•  ìˆ˜ ìˆëŠ” ë³´ì¡° IP ê°œìˆ˜ê°€ ì´ë¯¸ ì •í•´ì ¸ ìˆê¸° ë•Œë¬¸

### **5. t3.medium ì¸ìŠ¤í„´ìŠ¤ì—ì„œ Pod ìµœëŒ€ ê°œìˆ˜ ê³„ì‚°**

- **Max ENI(ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤)**: 3ê°œ
- **ENIë‹¹ IP í• ë‹¹ ê°œìˆ˜**: 6ê°œ
- **ê³„ì‚° ë°©ë²•**: `(6 - 1) * 3 = 15`
    - ê° ENIì—ì„œ 1ê°œì˜ IPëŠ” ì´ë¯¸ ì‚¬ìš© ì¤‘ì´ë¯€ë¡œ ì œì™¸
    - ì´ 15ê°œì˜ IPë¥¼ Podì— í• ë‹¹ ê°€ëŠ¥
- **ì¶”ê°€ ê³ ë ¤ì‚¬í•­**: CNI ë°ëª¬ì…‹ê³¼ Kube-Proxyê°€ 2ê°œì˜ IPë¥¼ ì‚¬ìš© (IP ê³µìœ )
- **ìµœì¢… ê²°ê³¼**:**t3.medium ì¸ìŠ¤í„´ìŠ¤ì—ì„œëŠ” ìµœëŒ€ 17ê°œì˜ Pod ë°°í¬ ê°€ëŠ¥**

### **6. ì›Œì»¤ë…¸ë“œ ìƒì„¸ ì •ë³´ í™•ì¸**

ê° ì›Œì»¤ë…¸ë“œì—ì„œ **ìµœëŒ€ 17ê°œì˜ Pod**ì´ ë°°í¬ ê°€ëŠ¥í•¨ì„ í™•ì¸í•  ìˆ˜ ìˆìŒ

```bash
kubectl describe node | grep Allocatable: -A6
```

âœ…Â **ì¶œë ¥**

```bash
Allocatable:
  cpu:                1930m
  ephemeral-storage:  27845546346
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364544Ki
  pods:               17
--
Allocatable:
  cpu:                1930m
  ephemeral-storage:  27845546346
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364536Ki
  pods:               17
--
Allocatable:
  cpu:                1930m
  ephemeral-storage:  27845546346
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364544Ki
  pods:               17
```

---

## **ğŸ“Š ìµœëŒ€ íŒŒë“œ ìƒì„± ë° í™•ì¸**

### **1. ì›Œì»¤ ë…¸ë“œ 3ëŒ€ EC2 ëª¨ë‹ˆí„°ë§**

```bash
[ec2-user@ip-192-168-1-193 ~]$ while true; do ip -br -c addr show && echo "--------------" ; date "+%Y-%m-%d %H:%M:%S" ; sleep 1; done
```

```bash
[ec2-user@ip-192-168-2-52 ~]$ while true; do ip -br -c addr show && echo "--------------" ; date "+%Y-%m-%d %H:%M:%S" ; sleep 1; done
```

```bash
[ec2-user@ip-192-168-3-72 ~]$ while true; do ip -br -c addr show && echo "--------------" ; date "+%Y-%m-%d %H:%M:%S" ; sleep 1; done
```

### **2. ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„± ì „ ìƒíƒœ í™•ì¸**

![Image](https://github.com/user-attachments/assets/26ce5718-88fe-467c-9514-44ace2c01ad5)

```bash
--------------
2025-02-13 12:20:21
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.2.52/24 metric 1024 fe80::4c5:5bff:fed1:7757/64 
enibce2df30e87@if3 UP             fe80::48c8:23ff:feab:8539/64 
enic99196c7a64@if3 UP             fe80::8800:6eff:fe37:b171/64 
ens7             UP             192.168.2.138/24 fe80::487:86ff:fe90:b33d/64 
--------------
```

```bash
--------------
2025-02-13 12:21:10
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.3.72/24 metric 1024 fe80::8d5:3dff:fe4a:54bd/64 
enif2c43957bf8@if3 UP             fe80::a0e3:15ff:fe62:4731/64 
ens7             UP             192.168.3.218/24 fe80::80c:3cff:fe65:9c27/64 
--------------
```

```bash
Every 2.0s: kubectl get pods -o wide                 gram88: 09:22:04 PM
                                                           in 0.538s (0)
No resources found in default namespace.
```

### **3. ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
EOF
```

### **4. ë””í”Œë¡œì´ë¨¼íŠ¸ ìƒì„± í›„ ìƒíƒœ í™•ì¸**

![Image](https://github.com/user-attachments/assets/9b26e613-09ff-4560-8701-727a5505bebe)

**ENI ì¶”ê°€**

- eni189e26c0cf7@if3 UP ìƒíƒœë¡œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ í™•ì¸
- eni422a7c2b629@if3 UP ìƒíƒœë¡œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì¶”ê°€ í™•ì¸

```bash
--------------
2025-02-13 12:24:00
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.1.193/24 metric 1024 fe80::23:93ff:fea6:bc61/64 
eni01a4864c88a@if3 UP             fe80::54be:6aff:febd:2d2a/64 
eni61c5a949744@if3 UP             fe80::5041:42ff:fec3:33f/64 
ens7             UP             192.168.1.232/24 fe80::d8:5dff:fe80:2cc9/64 
eni189e26c0cf7@if3 UP             fe80::b463:11ff:fec2:9e12/64 
--------------
```

```bash
--------------
2025-02-13 12:24:36
lo               UNKNOWN        127.0.0.1/8 ::1/128 
ens5             UP             192.168.3.72/24 metric 1024 fe80::8d5:3dff:fe4a:54bd/64 
enif2c43957bf8@if3 UP             fe80::a0e3:15ff:fe62:4731/64 
ens7             UP             192.168.3.218/24 fe80::80c:3cff:fe65:9c27/64 
eni422a7c2b629@if3 UP             fe80::b455:d1ff:fed1:d8f6/64 
--------------
```

**Pod ìŠ¤ì¼€ì¤„ë§ ì¶”ê°€**

```bash
Every 2.0s: kubectl get pods -o wide                 gram88: 09:25:54 PM                                                                               in 0.487s (0)
NAME                                READY   STATUS    RESTARTS   AGE    IP              NODE                                               NOMINATED NODE   READINESS GATES
nginx-deployment-6c8cb99bb9-77rg2   1/1     Running   0          3m5s   192.168.3.170   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
nginx-deployment-6c8cb99bb9-lcfx9   1/1     Running   0          3m5s   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>

```

### **5. Pod ê°œìˆ˜ 8ê°œë¡œ ì¦ê°€**

```bash
kubectl scale deployment nginx-deployment --replicas=8
# ê²°ê³¼
deployment.apps/nginx-deployment scaled
```
![Image](https://github.com/user-attachments/assets/daf72373-1730-4487-850b-fe276fc11560)

### **6. Pod ê°œìˆ˜ 30ê°œë¡œ ì¦ê°€**

- **Pod ê°œìˆ˜ ì¦ê°€ë¡œ ë¬¼ë¦¬ ëœì¹´ë“œ(ens6) ì¶”ê°€** â†’ ì´ **3ì¥** ì‚¬ìš©
- **ëœì¹´ë“œ 3ì¥**ìœ¼ë¡œ í™•ì¥ë˜ë©° ê° ëœì¹´ë“œì˜ **Private IPv4** í• ë‹¹ë„ ì¦ê°€

```bash
kubectl scale deployment nginx-deployment --replicas=30
# ê²°ê³¼
deployment.apps/nginx-deployment scaled
```
![Image](https://github.com/user-attachments/assets/d5e2c021-23a9-4c38-82e4-14cd6739d20e)
![Image](https://github.com/user-attachments/assets/26df238e-488f-4d44-b9d1-a293de7de93a)

### **7. Pod ê°œìˆ˜ 50ê°œë¡œ ì¦ê°€**

```bash
kubectl scale deployment nginx-deployment --replicas=50
# ê²°ê³¼
deployment.apps/nginx-deployment scaled
```
![Image](https://github.com/user-attachments/assets/3de8f22c-80cc-4c5b-93dc-b3ef826dfece)


**ì¼ë¶€ Podê°€ Pending ìƒíƒœ**ë¡œ ë‚¨ì•„ìˆìŒ

```bash
k get pod
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-6c8cb99bb9-4mz8l   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-5lbxg   1/1     Running   0          4m10s
nginx-deployment-6c8cb99bb9-5m868   1/1     Running   0          4m11s
nginx-deployment-6c8cb99bb9-77rg2   1/1     Running   0          8m19s
nginx-deployment-6c8cb99bb9-7f5tw   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-7jvvw   1/1     Running   0          4m10s
nginx-deployment-6c8cb99bb9-7kzcw   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-7nzn6   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-7qchj   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-8s2z8   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-98tfm   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-9pvbx   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-b2qjf   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-bgxsj   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-g54wb   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-gkpcw   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-h8jtz   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-h9ltb   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-hdbx8   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-hh659   1/1     Running   0          4m10s
nginx-deployment-6c8cb99bb9-hmfz8   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-jnm66   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-kbmgh   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-kjkxd   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-kzfk2   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-lcfx9   1/1     Running   0          8m19s
nginx-deployment-6c8cb99bb9-lh6l6   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-lvq6b   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-lxqcr   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-mgqcd   1/1     Running   0          28s
nginx-deployment-6c8cb99bb9-pvhps   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-qbpmp   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-qwh72   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-r58vr   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-s7bsw   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-sdxw7   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-t2h2t   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-tb47g   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-tklxp   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-ttbzh   1/1     Running   0          4m10s
nginx-deployment-6c8cb99bb9-v5dfl   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-v888x   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-vstpp   1/1     Running   0          2m38s
nginx-deployment-6c8cb99bb9-w2dr8   1/1     Running   0          4m10s
nginx-deployment-6c8cb99bb9-ww4c9   0/1     Pending   0          27s
nginx-deployment-6c8cb99bb9-xk74m   1/1     Running   0          2m39s
nginx-deployment-6c8cb99bb9-xn6k7   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-xp5tt   1/1     Running   0          28s
nginx-deployment-6c8cb99bb9-z2jwk   1/1     Running   0          27s
nginx-deployment-6c8cb99bb9-z4649   0/1     Pending   0          27s
```

**IP ë¯¸í• ë‹¹ìœ¼ë¡œ ì¸í•´ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¤€ë¹„ ë¶ˆê°€** ìƒíƒœ

```bash
k describe pod nginx-deployment-6c8cb99bb9-7nzn6
```

âœ…Â **ì¶œë ¥**

```bash
Name:             nginx-deployment-6c8cb99bb9-7nzn6
Namespace:        default
Priority:         0
Service Account:  default
Node:             <none>
Labels:           app=nginx
                  pod-template-hash=6c8cb99bb9
Annotations:      <none>
Status:           Pending
IP:               
IPs:              <none>
Controlled By:    ReplicaSet/nginx-deployment-6c8cb99bb9
Containers:
  nginx:
    Image:        nginx:alpine
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-cnct2 (ro)
Conditions:
  Type           Status
  PodScheduled   False
Volumes:
  kube-api-access-cnct2:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason            Age   From               Message
  ----     ------            ----  ----               -------
  Warning  FailedScheduling  61s   default-scheduler  0/3 nodes are available: 3 Too many pods. preemption: 0/3 nodes are available: 3 No preemption victims found for incoming pod.
```

### **8. ë””í”Œë¡œì´ë¨¼íŠ¸ ì‚­ì œ**

```bash
kubectl delete deploy nginx-deployment
# ê²°ê³¼
deployment.apps "nginx-deployment" deleted
```

---

## **âš–ï¸ AWS LoadBalancer Controller ë°°í¬**

### **1. ì„¤ì¹˜ ì „ crd í™•ì¸**

```bash
kubectl get crd
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                         CREATED AT
cninodes.vpcresources.k8s.aws                2025-02-12T03:09:25Z
eniconfigs.crd.k8s.amazonaws.com             2025-02-12T03:13:55Z
policyendpoints.networking.k8s.aws           2025-02-12T03:09:25Z
securitygrouppolicies.vpcresources.k8s.aws   2025-02-12T03:09:25Z
```

### **2. Helm Chart ì„¤ì¹˜**

```bash
helm repo add eks https://aws.github.io/eks-charts

# ê²°ê³¼
helm repo update
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=$CLUSTER_NAME
"eks" has been added to your repositories
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "eks" chart repository
...Successfully got an update from the "prometheus-community" chart repository
...Successfully got an update from the "geek-cookbook" chart repository
Update Complete. âˆHappy Helming!âˆ
NAME: aws-load-balancer-controller
LAST DEPLOYED: Thu Feb 13 21:53:34 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
AWS Load Balancer controller installed!
```

### **3. ì„¤ì¹˜ í™•ì¸**

```bash
kubectl get crd
```

âœ…Â **ì¶œë ¥**

`ingressclassparams.elbv2.k8s.aws`, `targetgroupbindings.elbv2.k8s.aws`  ì¶”ê°€

```bash
NAME                                         CREATED AT
cninodes.vpcresources.k8s.aws                2025-02-12T03:09:25Z
eniconfigs.crd.k8s.amazonaws.com             2025-02-12T03:13:55Z
ingressclassparams.elbv2.k8s.aws             2025-02-13T12:53:32Z
policyendpoints.networking.k8s.aws           2025-02-12T03:09:25Z
securitygrouppolicies.vpcresources.k8s.aws   2025-02-12T03:09:25Z
targetgroupbindings.elbv2.k8s.aws            2025-02-13T12:53:32Z
```

```bash
kubectl explain ingressclassparams.elbv2.k8s.aws
```

âœ…Â **ì¶œë ¥**

```bash
GROUP:      elbv2.k8s.aws
KIND:       IngressClassParams
VERSION:    v1beta1

DESCRIPTION:
    IngressClassParams is the Schema for the IngressClassParams API
    
FIELDS:
  apiVersion	<string>
    APIVersion defines the versioned schema of this representation of an object.
    Servers should convert recognized schemas to the latest internal value, and
    may reject unrecognized values. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

  kind	<string>
    Kind is a string value representing the REST resource this object
    represents. Servers may infer this from the endpoint the client submits
    requests to. Cannot be updated. In CamelCase. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

  metadata	<ObjectMeta>
    Standard object's metadata. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

  spec	<Object>
    IngressClassParamsSpec defines the desired state of IngressClassParams

GROUP:      elbv2.k8s.aws
KIND:       TargetGroupBinding
VERSION:    v1beta1

DESCRIPTION:
    TargetGroupBinding is the Schema for the TargetGroupBinding API
    
FIELDS:
  apiVersion	<string>
    APIVersion defines the versioned schema of this representation of an object.
    Servers should convert recognized schemas to the latest internal value, and
    may reject unrecognized values. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

  kind	<string>
    Kind is a string value representing the REST resource this object
    represents. Servers may infer this from the endpoint the client submits
    requests to. Cannot be updated. In CamelCase. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

  metadata	<ObjectMeta>
    Standard object's metadata. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

  spec	<Object>
    TargetGroupBindingSpec defines the desired state of TargetGroupBinding

  status	<Object>
    TargetGroupBindingStatus defines the observed state of TargetGroupBinding
```

---

## **ğŸ•¸ï¸ ì„œë¹„ìŠ¤/íŒŒë“œ ë°°í¬ í…ŒìŠ¤íŠ¸ with NLB**

### **1. ëª¨ë‹ˆí„°ë§**

```bash
watch -d kubectl get pod,svc,ep,endpointslices
```

### **2. ë””í”Œë¡œì´ë¨¼íŠ¸ & ì„œë¹„ìŠ¤ ìƒì„±**

```bash
cat << EOF > echo-service-nlb.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-echo
spec:
  replicas: 2
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: aews-websrv
        image: k8s.gcr.io/echoserver:1.5
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: svc-nlb-ip-type
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing 
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "8080"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
spec:
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
  type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
kubectl apply -f echo-service-nlb.yaml
deployment.apps/deploy-echo created
service/svc-nlb-ip-type created
```

### **3. ë¡œë“œë°¸ëŸ°ì„œ ìƒíƒœ í™•ì¸**

ë„¤íŠ¸ì›Œí¬ ë¡œë“œë°¸ëŸ°ì„œê°€ provisioning ë˜ê³  ìˆìŒ

```bash
aws elbv2 describe-load-balancers --query 'LoadBalancers[*].State.Code' --output text
```

âœ…Â **ì¶œë ¥**

```bash
provisioning
```


![Image](https://github.com/user-attachments/assets/27b2eab4-42e1-4d5a-8e6a-7551c8c22972)


### **4. deploy, pod ì •ë³´ í™•ì¸**

```bash
kubectl get deploy,pod
```

âœ…Â **ì¶œë ¥**

```bash
NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deploy-echo   2/2     2            2           3m21s

NAME                              READY   STATUS    RESTARTS   AGE
pod/deploy-echo-bf9bdb8bc-qcq6k   1/1     Running   0          3m21s
pod/deploy-echo-bf9bdb8bc-xlpz4   1/1     Running   0          3m21s
```

### **5. ì„œë¹„ìŠ¤, ì—”ë“œí¬ì¸íŠ¸, ì¸ê·¸ë ˆìŠ¤ í´ë˜ìŠ¤ íŒŒë¼ë¯¸í„°, íƒ€ê²Ÿ ê·¸ë£¹ ë°”ì¸ë”© í™•ì¸**

```bash
kubectl get svc,ep,ingressclassparams,targetgroupbindings
```

âœ…Â **ì¶œë ¥**

```bash
NAME                      TYPE           CLUSTER-IP       EXTERNAL-IP                                                                         PORT(S)        AGE
service/kubernetes        ClusterIP      10.100.0.1       <none>                                                                              443/TCP        33h
service/svc-nlb-ip-type   LoadBalancer   10.100.253.160   k8s-default-svcnlbip-b30242b032-f4b2a1499955f080.elb.ap-northeast-2.amazonaws.com   80:30138/TCP   3m47s

NAME                        ENDPOINTS                              AGE
endpoints/kubernetes        192.168.2.87:443,192.168.3.197:443     33h
endpoints/svc-nlb-ip-type   192.168.1.176:8080,192.168.3.77:8080   3m47s

NAME                                   GROUP-NAME   SCHEME   IP-ADDRESS-TYPE   AGE
ingressclassparams.elbv2.k8s.aws/alb                                           9m48s

NAME                                                               SERVICE-NAME      SERVICE-PORT   TARGET-TYPE   AGE
targetgroupbinding.elbv2.k8s.aws/k8s-default-svcnlbip-f4a394e732   svc-nlb-ip-type   80             ip            3m43s
```

`targetgroupbinding.elbv2.k8s.aws/k8s-default-svcnlbip-f4a394e732`ëŠ” ì•„ë˜ ì •ë³´ì™€ ë§¤ì¹­ë¨

![Image](https://github.com/user-attachments/assets/be2b5bb6-7f34-4ec4-a6f0-232a46db5856)


**Target Group Binding Attribute**ì—ì„œ `Deregistration delay`ëŠ” **graceful shutdown**ê³¼ ìœ ì‚¬í•œ ê°œë…

- ì´ ì„¤ì •ì€ ëŒ€ìƒ íƒ€ê²Ÿì´ ì¢…ë£Œë˜ê¸° ì „ì— ì—°ê²°ì„ í•´ì œí•˜ëŠ” ì‹œê°„ì„ ì˜ë¯¸

![Image](https://github.com/user-attachments/assets/5d15c725-9c68-4739-8f12-e4a9fcb128ad)

### 6. **Target Group Binding Attribute ìˆ˜ì •**

`echo-service-nlb.yaml` íŒŒì¼ì„ ì—´ì–´ ë‹¤ìŒ ì¤„ ì¶”ê°€í•¨

```yaml
service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: deregistration_delay.timeout_seconds=60
```

ë¹ ë¥¸ ì‹¤ìŠµì„ ìœ„í•´ì„œ ë“±ë¡ ì·¨ì†Œ ì§€ì—°(ë“œë ˆì´ë‹ ê°„ê²©) 60ì´ˆë¡œ ìˆ˜ì •

![Image](https://github.com/user-attachments/assets/3baf930c-bce7-4bc0-bb27-bf5754a7342a)

### **7. ë°°í¬**

```bash
kubectl apply -f echo-service-nlb.yaml

# ê²°ê³¼
deployment.apps/deploy-echo unchanged
service/svc-nlb-ip-type configured
```

`Deregistration delay`ê°€ 60ì´ˆë¡œ ë³€ê²½ë¨

![Image](https://github.com/user-attachments/assets/97765539-f6c4-4194-b287-0224035af8d7)

ë„¤íŠ¸ì›Œí¬ ë¡œë“œë°¸ëŸ°ì„œê°€ **Active ìƒíƒœë¡œ ì „í™˜ë¨**

![Image](https://github.com/user-attachments/assets/2eb0b840-0b67-4649-8806-db31cf8638a3)

**Target Groups**ì—ì„œ **Targets**ê°€ Healthy ìƒíƒœë¡œ í‘œì‹œë¨

![Image](https://github.com/user-attachments/assets/28b23fd2-c024-4bd9-8eae-cd2ddd85dfbb)


### **8. ì›¹ ì ‘ì† ì£¼ì†Œ í™•ì¸**

```bash
kubectl get svc svc-nlb-ip-type -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "Pod Web URL = http://"$1 }'
```

âœ…Â **ì¶œë ¥**

```bash
Pod Web URL = http://k8s-default-svcnlbip-b30242b032-f4b2a1499955f080.elb.ap-northeast-2.amazonaws.com
```

**ì„œë²„ ì ‘ê·¼ í™•ì¸ë¨** (http://k8s-default-svcnlbip-b30242b032-f4b2a1499955f080.elb.ap-northeast-2.amazonaws.com)

![Image](https://github.com/user-attachments/assets/9428ef5c-f0f0-4664-8426-44069f7e3227)


### **9. íŒŒë“œ ë¡œê¹… ëª¨ë‹ˆí„°ë§**

**Sternìœ¼ë¡œ íŒŒë“œ ë¡œê·¸ ëª¨ë‹ˆí„°ë§ ì§„í–‰**

```bash
kubectl stern -l  app=deploy-websrv
```

**ë¶„ì‚° ì ‘ì† í…ŒìŠ¤íŠ¸**

```bash
(eks-user:N/A) [root@operator-host ~]# NLB=$(kubectl get svc svc-nlb-ip-type -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
(eks-user:N/A) [root@operator-host ~]# curl -s $NLB
```

âœ…Â **ì¶œë ¥**

```bash
Hostname: deploy-echo-bf9bdb8bc-xlpz4

Pod Information:
	-no pod information available-

Server values:
	server_version=nginx: 1.13.0 - lua: 10008

Request Information:
	client_address=192.168.2.29
	method=GET
	real path=/
	query=
	request_version=1.1
	request_uri=http://k8s-default-svcnlbip-b30242b032-f4b2a1499955f080.elb.ap-northeast-2.amazonaws.com:8080/

Request Headers:
	accept=*/*
	host=k8s-default-svcnlbip-b30242b032-f4b2a1499955f080.elb.ap-northeast-2.amazonaws.com
	user-agent=curl/8.3.0

Request Body:
	-no body in request-
```

**100ë²ˆ ìš”ì²­ì„ ë³´ë‚´ ê° íŒŒë“œë¡œ ë¶„ì‚°ëœ ì ‘ì† ìˆ˜ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# for i in {1..100}; do curl -s $NLB | grep Hostname ; done | sort | uniq -c | sort -nr
```

âœ…Â **ì¶œë ¥**

```bash
     56 Hostname: deploy-echo-bf9bdb8bc-qcq6k
     44 Hostname: deploy-echo-bf9bdb8bc-xlpz4
```

100ë²ˆì˜ ìš”ì²­ ì¤‘ **56ë²ˆì€ `deploy-echo-bf9bdb8bc-qcq6k` íŒŒë“œë¡œ**, **44ë²ˆì€ `deploy-echo-bf9bdb8bc-xlpz4` íŒŒë“œë¡œ** ë¶„ì‚°ë˜ì–´ ì ‘ì†ë¨

![Image](https://github.com/user-attachments/assets/2dc37042-b2ad-4e9c-a759-1a99b8a86e9b)


### **10. AWS Consoleì—ì„œ NLB ë¦¬ìŠ¤ë„ˆ ë° ëŒ€ìƒ í™•ì¸**

NLB ë„ë©”ì¸ìœ¼ë¡œ ì ‘ê·¼í•˜ë©´ 80ë²ˆ í¬íŠ¸ì—ì„œ Listenerê°€ ìš”ì²­ì„ ë°›ê³ , Resource mapì„ í†µí•´ **192.168.1.176**ê³¼ **192.168.3.77**ì˜ 8080ë²ˆ í¬íŠ¸ë¡œ ì „ë‹¬ë¨

![Image](https://github.com/user-attachments/assets/4f80cfb5-20a6-4973-9fcb-09fe5bdd84f6)


**192.168.1.176**ê³¼ **192.168.3.77**ì€ ì•„ë˜ ì¶œë ¥ëœ íŒŒë“œë“¤ì˜ IPì„

```bash
k get pod -owide
NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
deploy-echo-bf9bdb8bc-qcq6k   1/1     Running   0          27m   192.168.3.77    ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
deploy-echo-bf9bdb8bc-xlpz4   1/1     Running   0          27m   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>

```

### **11. replicas í™•ì¥ìœ¼ë¡œ íƒ€ê²Ÿ ê°œìˆ˜ ì¦ê°€**

`replicas`ë¥¼ 2ê°œì—ì„œ 3ê°œë¡œ í™•ì¥í•˜ì—¬ **íƒ€ê²Ÿì„ 3ê°œë¡œ ì¦ê°€ì‹œí‚´**

```bash
kubectl scale deployment deploy-echo --replicas=3
# ê²°ê³¼
deployment.apps/deploy-echo scaled
```

![Image](https://github.com/user-attachments/assets/031203b9-7dc9-44a6-9de9-9f372f7c4ed5)

### **12. ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
kubectl delete deploy deploy-echo; kubectl delete svc svc-nlb-ip-type
# ê²°ê³¼
deployment.apps "deploy-echo" deleted
service "svc-nlb-ip-type" deleted
```

---

## **ğŸ›¤ï¸ Ingress ì‹¤ìŠµ**

IngressëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ ì„œë¹„ìŠ¤(ClusterIP, NodePort, LoadBalancer)ë¥¼ ì™¸ë¶€ì— HTTP/HTTPSë¡œ ë…¸ì¶œí•˜ëŠ” ì›¹ í”„ë¡ì‹œ ì—­í• ì„ í•¨

### **1. ê²Œì„ íŒŒë“œì™€ Service, Ingress ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Namespace
metadata:
  name: game-2048
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: game-2048
  name: deployment-2048
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: app-2048
  replicas: 2
  template:
    metadata:
      labels:
        app.kubernetes.io/name: app-2048
    spec:
      containers:
      - image: public.ecr.aws/l6m2t8p7/docker-2048:latest
        imagePullPolicy: Always
        name: app-2048
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  namespace: game-2048
  name: service-2048
spec:
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
  type: NodePort
  selector:
    app.kubernetes.io/name: app-2048
EOF             number: 80e-2048rget-type: ipt-facing

# ê²°ê³¼
namespace/game-2048 created
deployment.apps/deployment-2048 created
service/service-2048 created
```

### **2. ëª¨ë‹ˆí„°ë§**

```bash
watch -d kubectl get pod,ingress,svc,ep,endpointslices -n game-2048
```

âœ…Â **ì¶œë ¥**

```bash
Every 2.0s: kubectl get pod,ingress,svc,ep,endpointslices -n game-2048                                                         gram88: 10:37:51 PM
                                                                                                                                     in 0.718s (0)
NAME                                   READY   STATUS    RESTARTS   AGE
pod/deployment-2048-7df5f9886b-lxtmt   1/1     Running   0          95s
pod/deployment-2048-7df5f9886b-zw8n9   1/1     Running   0          95s

NAME                                     CLASS   HOSTS   ADDRESS                                                                        PORTS   AGE
ingress.networking.k8s.io/ingress-2048   alb     *       k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com   80      95s

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/service-2048   NodePort   10.100.135.188   <none>        80:31872/TCP   95s

NAME                     ENDPOINTS                          AGE
endpoints/service-2048   192.168.1.176:80,192.168.3.19:80   95s

NAME                                                ADDRESSTYPE   PORTS   ENDPOINTS                    AGE
endpointslice.discovery.k8s.io/service-2048-2h29k   IPv4          80      192.168.3.19,192.168.1.176   95s
```

### **3. ìƒì„± í™•ì¸**

**game-2048 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ì¸ê·¸ë ˆìŠ¤, ì„œë¹„ìŠ¤, ì—”ë“œí¬ì¸íŠ¸, íŒŒë“œ í™•ì¸**

```bash
kubectl get ingress,svc,ep,pod -n game-2048
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                     CLASS   HOSTS   ADDRESS                                                                        PORTS   AGE
ingress.networking.k8s.io/ingress-2048   alb     *       k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com   80      2m36s

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/service-2048   NodePort   10.100.135.188   <none>        80:31872/TCP   2m36s

NAME                     ENDPOINTS                          AGE
endpoints/service-2048   192.168.1.176:80,192.168.3.19:80   2m36s

NAME                                   READY   STATUS    RESTARTS   AGE
pod/deployment-2048-7df5f9886b-lxtmt   1/1     Running   0          2m36s
pod/deployment-2048-7df5f9886b-zw8n9   1/1     Running   0          2m36s
```

**game-2048 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ íƒ€ê²Ÿ ê·¸ë£¹ ë°”ì¸ë”© í™•ì¸**

```bash
kubectl get targetgroupbindings -n game-2048
```

âœ…Â **ì¶œë ¥**

```bash
NAME                               SERVICE-NAME   SERVICE-PORT   TARGET-TYPE   AGE
k8s-game2048-service2-168626cccc   service-2048   80             ip            3m20s
```

Listenerê°€ 80ë²ˆ í¬íŠ¸ë¡œ ìš”ì²­ì„ ë°›ì•„ rulesë¥¼ í†µí•´ ëŒ€ìƒ ê·¸ë£¹ìœ¼ë¡œ ì „ë‹¬í•¨

![Image](https://github.com/user-attachments/assets/61459ead-f077-4475-8734-0263eb6a6b79)

![Image](https://github.com/user-attachments/assets/cd7563ac-558b-4db1-80c3-d8c5717a9782)

![Image](https://github.com/user-attachments/assets/f32b627c-ac1e-4830-8c56-cd525ac3f0b1)


### **4. Ingress ì„¤ì • í™•ì¸**

```bash
kubectl describe ingress -n game-2048 ingress-2048
kubectl get ingress -n game-2048 ingress-2048 -o jsonpath="{.status.loadBalancer.ingress[*].hostname}{'\n'}"
```

âœ…Â **ì¶œë ¥**

```bash
Name:             ingress-2048
Labels:           <none>
Namespace:        game-2048
Address:          k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com
Ingress Class:    alb
Default backend:  <default>
Rules:
  Host        Path  Backends
  ----        ----  --------
  *           
              /   service-2048:80 (192.168.3.19:80,192.168.1.176:80)
Annotations:  alb.ingress.kubernetes.io/scheme: internet-facing
              alb.ingress.kubernetes.io/target-type: ip
Events:
  Type    Reason                  Age    From     Message
  ----    ------                  ----   ----     -------
  Normal  SuccessfullyReconciled  8m18s  ingress  Successfully reconciled
k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com
```

- ëª¨ë“  ìš”ì²­(*)ì€ `service-2048:80`ìœ¼ë¡œ ì „ë‹¬ë¨

```bash
Every 2.0s: kubectl get pod,ingress,svc,ep,endpointslices -n game-2048                                                         gram88: 10:46:22 PM
                                                                                                                                     in 0.724s (0)
NAME                                   READY   STATUS    RESTARTS   AGE
pod/deployment-2048-7df5f9886b-lxtmt   1/1     Running   0          10m  
pod/deployment-2048-7df5f9886b-zw8n9   1/1     Running   0          10m  

NAME                                     CLASS   HOSTS   ADDRESS                                                                        PORTS   AGE
ingress.networking.k8s.io/ingress-2048   alb     *       k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com   80      10m  

NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service/service-2048   NodePort   10.100.135.188   <none>        80:31872/TCP   10m  

NAME                     ENDPOINTS                          AGE
endpoints/service-2048   192.168.1.176:80,192.168.3.19:80   10m  

NAME                                                ADDRESSTYPE   PORTS   ENDPOINTS                    AGE
endpointslice.discovery.k8s.io/service-2048-2h29k   IPv4          80      192.168.3.19,192.168.1.176   10m  
```

- `service-2048`ì€ **NodePort** íƒ€ì…ì´ë©° `10.100.135.188` í• ë‹¹
- **Pod Endpoint IP**: `192.168.1.176:80`, `192.168.3.19:80`
- **ALBëŠ” ì´ ë‘ Podë¡œ íŠ¸ë˜í”½ ì „ë‹¬**

### **5. ê²Œì„ ì ‘ì† URL í™•ì¸**

```bash
kubectl get ingress -n game-2048 ingress-2048 -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "Game URL = http://"$1 }'
```

âœ…Â **ì¶œë ¥**

```bash
Game URL = http://k8s-game2048-ingress2-70d50ce3fd-1110214105.ap-northeast-2.elb.amazonaws.com
```

![Image](https://github.com/user-attachments/assets/674221c2-3bed-4b30-a4a4-a8813d0cb67d)

### **6. Pod ëŒ€ìƒ íƒ€ê²Ÿ í™•ì¸**

```bash
kubectl get pod -n game-2048 -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                               READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
deployment-2048-7df5f9886b-lxtmt   1/1     Running   0          13m   192.168.3.19    ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
deployment-2048-7df5f9886b-zw8n9   1/1     Running   0          13m   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
```

- ALBì˜ ëŒ€ìƒìœ¼ë¡œ ì§ì ‘ Pod IPê°€ ì‚¬ìš©ë¨ (NodePort ì•„ë‹˜)
- Pod IP: `192.168.3.19` (ë…¸ë“œ: `ip-192-168-3-72`), `192.168.1.176` (ë…¸ë“œ: `ip-192-168-1-193`)

### **7. Pod ê°œìˆ˜ ì¦ê°€ì— ë”°ë¥¸ íƒ€ê²Ÿ ê·¸ë£¹ í™•ì¥**

podë¥¼ 3ê°œë¡œ ì¦ê°€ì‹œí‚¤ë©´ íƒ€ê²Ÿê·¸ë£¹ì— í•˜ë‚˜ê°€ ë” ì¶”ê°€ë¨

```bash
kubectl scale deployment -n game-2048 deployment-2048 --replicas 3
# ê²°ê³¼
deployment.apps/deployment-2048 scaled
```

![Image](https://github.com/user-attachments/assets/d6bb93f4-7340-42db-bc09-977fc22cb700)


### **8. ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
kubectl delete ingress ingress-2048 -n game-2048
# ê²°ê³¼
ingress.networking.k8s.io "ingress-2048" deleted
```

```bash
kubectl delete svc service-2048 -n game-2048 && kubectl delete deploy deployment-2048 -n game-2048 && kubectl delete ns game-2048
# ê²°ê³¼
service "service-2048" deleted
deployment.apps "deployment-2048" deleted
namespace "game-2048" deleted
```

---

## **ğŸŒ external DNS ì‹¤ìŠµ**

### **1. ë„ë©”ì¸ ìƒì„±ê³¼ Zone ID í™•ì¸**

![Image](https://github.com/user-attachments/assets/1bbd30c8-08df-463b-9d83-56185b9c2b3b)


### **2. Route 53 ë„ë©”ì¸ ID ì¡°íšŒ ë° ë³€ìˆ˜ ì§€ì •**

```bash
MyDomain=gagajin.com
```

```bash
MyDnzHostedZoneId=$(aws route53 list-hosted-zones-by-name --dns-name "${MyDomain}." --query "HostedZones[0].Id" --output text)
```

ë³€ìˆ˜ í™•ì¸

```bash
echo $MyDomain, $MyDnzHostedZoneId
```

âœ…Â **ì¶œë ¥**

```bash
gagajin.com /hostedzone/EXAMPLEID123456789
```

### **3. ë„ë©”ì¸ì˜ A ë ˆì½”ë“œ ê°’ ë°˜ë³µ ì¡°íšŒ**

```bash
while true; do aws route53 list-resource-record-sets --hosted-zone-id "${MyDnzHostedZoneId}" --query "ResourceRecordSets[?Type == 'A']" | jq ; date ; echo ; sleep 1; done
```

![Image](https://github.com/user-attachments/assets/e2019848-a361-41bf-9853-24929eb5209a)

### **4. ExternalDNS ë°°í¬**

```bash
curl -s -O https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml
```

```bash
MyDomain=$MyDomain MyDnzHostedZoneId=$MyDnzHostedZoneId envsubst < externaldns.yaml | kubectl apply -f -
# ê²°ê³¼
serviceaccount/external-dns created
clusterrole.rbac.authorization.k8s.io/external-dns created
clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer created
deployment.apps/external-dns created
```

### **5. ì—°ê²° ë° ëª¨ë‹ˆí„°ë§**

```bash
kubectl get pod -l app.kubernetes.io/name=external-dns -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME                           READY   STATUS    RESTARTS   AGE
external-dns-dc4878f5f-98vcp   1/1     Running   0          25s
```

```bash
kubectl logs deploy/external-dns -n kube-system -f
```
![Image](https://github.com/user-attachments/assets/712aef91-56b5-4f2b-ac9d-cd1d77ea3957)


### **6. í…ŒíŠ¸ë¦¬ìŠ¤ ê²Œì„ ë°°í¬**

**í…ŒíŠ¸ë¦¬ìŠ¤ Deployment ë° ì„œë¹„ìŠ¤ ë°°í¬**

```bash
# í…ŒíŠ¸ë¦¬ìŠ¤ ë””í”Œë¡œì´ë¨¼íŠ¸ ë°°í¬
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tetris
  labels:
    app: tetris
spec:
  replicas: 1
  selector:
    matchLabels:
      app: tetris
  template:
    metadata:
      labels:
        app: tetris
    spec:
      containers:
      - name: tetris
        image: bsord/tetris
---
apiVersion: v1
kind: Service
metadata:
  name: tetris
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
    service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
    #service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "80"
spec:
  selector:
    app: tetris
  ports:
  - port: 80
    protocol: TCP
    targetPort: 80
    type: LoadBalancer
  loadBalancerClass: service.k8s.aws/nlb
EOF

deployment.apps/tetris created
service/tetris created
```

**ë°°í¬ ìƒíƒœ í™•ì¸**

```bash
kubectl get deploy,svc,ep tetris
```

âœ…Â **ì¶œë ¥**

```bash
NAME                     READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/tetris   1/1     1            1           88s

NAME             TYPE           CLUSTER-IP     EXTERNAL-IP                                                                       PORT(S)        AGE
service/tetris   LoadBalancer   10.100.6.207   k8s-default-tetris-b179cd251d-f36283420d6a53f5.elb.ap-northeast-2.amazonaws.com   80:31999/TCP   88s

NAME               ENDPOINTS          AGE
endpoints/tetris   192.168.1.176:80   88s
```

### **7. NLBì— ë„ë©”ì¸ ì—°ê²°**

```bash
kubectl annotate service tetris "external-dns.alpha.kubernetes.io/hostname=tetris.$MyDomain"
# ê²°ê³¼
service/tetris annotated
```
![Image](https://github.com/user-attachments/assets/d0e2cbe9-204b-4b7e-9426-c781188474c6)


### **8. Route 53ì—ì„œ ë„ë©”ì¸ ì—°ê²° í™•ì¸**

**Route 53 > Hosted Zone > gagajin.com**ì—ì„œ `tetris.gagajin.com` ë„ë©”ì¸ì´ **NLB**ì™€ ë§¤ì¹­ëœ ìƒíƒœ í™•ì¸

![Image](https://github.com/user-attachments/assets/2848a88f-5c8a-4d58-8892-cf73dd14ade3)


**ë„ë©”ì¸ ì—°ê²° í™•ì¸**

- **ë„ë©”ì¸ ê°’**: `tetris.gagajin.com`
- **ë§¤ì¹­ëœ ì„œë¹„ìŠ¤**: `k8s-default-tetris-b179cd251d-f36283420d6a53f5.elb.ap-northeast-2.amazonaws.com` (NLB)

![Image](https://github.com/user-attachments/assets/f78713be-57bb-42f1-bff5-0f4cbb2909d0)

### **9. ë„ë©”ì¸ ì¡°íšŒ**

```bash
dig +short tetris.$MyDomain @8.8.8.8
```

âœ…Â **ì¶œë ¥**

```bash
43.200.102.104
3.39.61.119
43.202.39.97
```

### **10. ë„ë©”ì¸ ìƒíƒœ ì²´í¬**

```bash
echo -e "My Domain Checker Site1 = https://www.whatsmydns.net/#A/tetris.$MyDomain"
echo -e "My Domain Checker Site2 = https://dnschecker.org/#A/tetris.$MyDomain"
```
![Image](https://github.com/user-attachments/assets/e1c66f7c-a1cf-42e2-a069-776e6d1cedce)


**`tetris.gagajin.com` ì ‘ì†**

![Image](https://github.com/user-attachments/assets/17476a02-d8eb-4fb2-9c5e-b5f16bb9bafd)

### **11. ë¦¬ì†ŒìŠ¤ ì‚­ì œ ë° A ë ˆì½”ë“œ ì œê±° í™•ì¸**

**`external-dns`ì— ì˜í•´ Aë ˆì½”ë“œë„ ìë™ ì‚­ì œ**

```bash
kubectl delete deploy,svc tetris
```
![Image](https://github.com/user-attachments/assets/b2119fc1-41db-4abe-a6a4-e3a3dee377f6)

![Image](https://github.com/user-attachments/assets/782fda2d-15af-44c8-ac2e-bcdd8de1b63b)


---

## **ğŸ—ºï¸ Topology Aware Routing ì‹¤ìŠµ**

### **1. í˜„ì¬ ë…¸ë“œ AZ ë°°í¬ í™•ì¸**

```bash
kubectl get node --label-columns=topology.kubernetes.io/zone
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               ZONE
ip-192-168-1-193.ap-northeast-2.compute.internal   Ready    <none>   35h   v1.31.4-eks-aeac579   ap-northeast-2a
ip-192-168-2-52.ap-northeast-2.compute.internal    Ready    <none>   35h   v1.31.4-eks-aeac579   ap-northeast-2b
ip-192-168-3-72.ap-northeast-2.compute.internal    Ready    <none>   35h   v1.31.4-eks-aeac579   ap-northeast-2c
```

### **2. í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ë””í”Œë¡œì´ë¨¼íŠ¸ì™€ ì„œë¹„ìŠ¤ ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-echo
spec:
  replicas: 3
  selector:
    matchLabels:
      app: deploy-websrv
  template:
    metadata:
      labels:
        app: deploy-websrv
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: websrv
        image: registry.k8s.io/echoserver:1.5
        ports:
        - containerPort: 8080
---
apiVersion: v1
kind: Service
metadata:
  name: svc-clusterip
spec:
  ports:
    - name: svc-webport
      port: 80
      targetPort: 8080
  selector:
    app: deploy-websrv
  type: ClusterIP
EOF

# ê²°ê³¼
deployment.apps/deploy-echo created
service/svc-clusterip created
```

**í™•ì¸**

```bash
kubectl get deploy,svc,ep,endpointslices
kubectl get pod -owide
kubectl get svc,ep svc-clusterip
kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip
kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip -o yaml
```

âœ…Â **ì¶œë ¥**

```bash
NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deploy-echo   3/3     3            3           34s

NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/kubernetes      ClusterIP   10.100.0.1       <none>        443/TCP   35h
service/svc-clusterip   ClusterIP   10.100.101.191   <none>        80/TCP    34s

NAME                      ENDPOINTS                                                 AGE
endpoints/kubernetes      192.168.2.87:443,192.168.3.197:443                        35h
endpoints/svc-clusterip   192.168.1.176:8080,192.168.2.91:8080,192.168.3.146:8080   34s

NAME                                                 ADDRESSTYPE   PORTS   ENDPOINTS                                  AGE
endpointslice.discovery.k8s.io/kubernetes            IPv4          443     192.168.2.87,192.168.3.197                 35h
endpointslice.discovery.k8s.io/svc-clusterip-8gc6m   IPv4          8080    192.168.1.176,192.168.2.91,192.168.3.146   34s
NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
deploy-echo-75b7b9558c-8kxhk   1/1     Running   0          34s   192.168.2.91    ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
deploy-echo-75b7b9558c-dwhmg   1/1     Running   0          34s   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
deploy-echo-75b7b9558c-frsbd   1/1     Running   0          34s   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/svc-clusterip   ClusterIP   10.100.101.191   <none>        80/TCP    35s

NAME                      ENDPOINTS                                                 AGE
endpoints/svc-clusterip   192.168.1.176:8080,192.168.2.91:8080,192.168.3.146:8080   35s
NAME                  ADDRESSTYPE   PORTS   ENDPOINTS                                  AGE
svc-clusterip-8gc6m   IPv4          8080    192.168.1.176,192.168.2.91,192.168.3.146   36s
apiVersion: v1
items:
- addressType: IPv4
  apiVersion: discovery.k8s.io/v1
  endpoints:
  - addresses:
    - 192.168.1.176
    conditions:
      ready: true
      serving: true
      terminating: false
    nodeName: ip-192-168-1-193.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-frsbd
      namespace: default
      uid: c79e9a50-6fe7-4862-b235-f48410dfd4e7
    zone: ap-northeast-2a
  - addresses:
    - 192.168.2.91
    conditions:
      ready: true
      serving: true
      terminating: false
    nodeName: ip-192-168-2-52.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-8kxhk
      namespace: default
      uid: fc2d6025-50e4-488d-844d-b74e64656869
    zone: ap-northeast-2b
  - addresses:
    - 192.168.3.146
    conditions:
      ready: true
      serving: true
      terminating: false
    nodeName: ip-192-168-3-72.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-dwhmg
      namespace: default
      uid: 013991cc-6c6a-465a-be3c-2a7128ed4869
    zone: ap-northeast-2c
  kind: EndpointSlice
  metadata:
    annotations:
      endpoints.kubernetes.io/last-change-trigger-time: "2025-02-13T15:02:52Z"
    creationTimestamp: "2025-02-13T15:02:50Z"
    generateName: svc-clusterip-
    generation: 4
    labels:
      endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
      kubernetes.io/service-name: svc-clusterip
    name: svc-clusterip-8gc6m
    namespace: default
    ownerReferences:
    - apiVersion: v1
      blockOwnerDeletion: true
      controller: true
      kind: Service
      name: svc-clusterip
      uid: f97f9347-cd50-40d7-881e-253b2efe5825
    resourceVersion: "437737"
    uid: 2f964436-d4df-49bd-af2d-b11ec22702b2
  ports:
  - name: svc-webport
    port: 8080
    protocol: TCP
kind: List
metadata:
  resourceVersion: ""
```

### **4. ì ‘ì† í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•  í´ë¼ì´ì–¸íŠ¸ íŒŒë“œ ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: netshoot-pod
spec:
  containers:
  - name: netshoot-pod
    image: nicolaka/netshoot
    command: ["tail"]
    args: ["-f", "/dev/null"]
  terminationGracePeriodSeconds: 0
EOF
pod/netshoot-pod created
```

**í™•ì¸**

```bash
kubectl get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                           READY   STATUS    RESTARTS   AGE    IP              NODE                                               NOMINATED NODE   READINESS GATES
deploy-echo-75b7b9558c-8kxhk   1/1     Running   0          101s   192.168.2.91    ip-192-168-2-52.ap-northeast-2.compute.internal    <none>           <none>
deploy-echo-75b7b9558c-dwhmg   1/1     Running   0          101s   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
deploy-echo-75b7b9558c-frsbd   1/1     Running   0          101s   192.168.1.176   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
netshoot-pod                   1/1     Running   0          16s    192.168.1.98    ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
```

- **Netshoot Pod**ê°€ **AZ 1ë²ˆ**ì— ë°°í¬ë¨
- AZ 1ë²ˆì—ì„œ ë°°í¬ëœ **deploy-echo** PodëŠ” ê°™ì€ AZì— ìˆëŠ” **netshoot-pod**ì— ì—°ê²°ë˜ë©´ ì¢‹ì§€ë§Œ, ë¶€í•˜ë¶„ì‚° ì‹œ ë‹¤ë¥¸ AZì˜ Podë¡œë„ ì—°ê²°ë¨

### **5. í…ŒìŠ¤íŠ¸ íŒŒë“œ(netshoot-pod)ì—ì„œ ClusterIP ì ‘ì† ì‹œ ë¶€í•˜ë¶„ì‚° í™•ì¸**

```bash
kubectl exec -it netshoot-pod -- curl svc-clusterip | grep Hostname
```

âœ…Â **ì¶œë ¥**

![Image](https://github.com/user-attachments/assets/6d7d00ab-3f4c-426f-b372-242d12eb1de1)

```bash
Hostname: deploy-echo-75b7b9558c-8kxhk
# ë˜ëŠ”
Hostname: deploy-echo-75b7b9558c-dwhmg
# ë˜ëŠ”
Hostname: deploy-echo-75b7b9558c-frsbd
```

- **netshoot-pod**ì—ì„œ `curl svc-clusterip` ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ ë„ë©”ì¸ëª…ì„ í†µí•´ Podì— ì ‘ê·¼
- ì„œë¹„ìŠ¤ ìƒì„± ì‹œ **ClusterIP**ë¼ëŠ” ê°€ìƒ IP(VIP)ê°€ ìƒì„±ë˜ì–´ ê³ ì • ì§„ì…ì  ì—­í•  ìˆ˜í–‰

**100ë²ˆ ë°˜ë³µ ì ‘ì† : 3ê°œì˜ íŒŒë“œë¡œ AZ(zone) ìƒê´€ì—†ì´ ëœë¤ í™•ë¥  ë¶€í•˜ë¶„ì‚° ë™ì‘**

```bash
kubectl exec -it netshoot-pod -- zsh -c "for i in {1..100}; do curl -s svc-clusterip | grep Hostname; done | sort | uniq -c | sort -nr"
```

âœ…Â **ì¶œë ¥**

```bash
   43 Hostname: deploy-echo-75b7b9558c-frsbd
   36 Hostname: deploy-echo-75b7b9558c-dwhmg
   21 Hostname: deploy-echo-75b7b9558c-8kxhk
```

### **6. iptables ê¸°ë°˜ ì„œë¹„ìŠ¤ ë¼ìš°íŒ… ë¶„ì„**

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SERVICES
```

âœ…Â **ì¶œë ¥**

```bash
Chain KUBE-SERVICES (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SVC-UAGC4PYEYZJJEW6D  tcp  --  *      *       0.0.0.0/0            10.100.145.143       /* kube-system/aws-load-balancer-webhook-service:webhook-server cluster IP */ tcp dpt:443
  110  6600 KUBE-SVC-KBDEBIL6IU6WL7RF  tcp  --  *      *       0.0.0.0/0            10.100.101.191       /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:80
    0     0 KUBE-SVC-I7SKRZYQ7PWYV5X7  tcp  --  *      *       0.0.0.0/0            10.100.83.10         /* kube-system/eks-extension-metrics-api:metrics-api cluster IP */ tcp dpt:443
  110 10560 KUBE-SVC-TCOU7JCQXEZGVUNU  udp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:dns cluster IP */ udp dpt:53
    0     0 KUBE-SVC-ERIFXISQEP7F7OF4  tcp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:dns-tcp cluster IP */ tcp dpt:53
    0     0 KUBE-SVC-JD5MR3NA4I4DYORP  tcp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:metrics cluster IP */ tcp dpt:9153
    0     0 KUBE-SVC-Z4ANX4WAEWEBLCTM  tcp  --  *      *       0.0.0.0/0            10.100.101.216       /* kube-system/metrics-server:https cluster IP */ tcp dpt:443
    0     0 KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  *      *       0.0.0.0/0            10.100.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443
    0     0 KUBE-SVC-7EJNTS7AENER2WX5  tcp  --  *      *       0.0.0.0/0            10.100.146.32        /* kube-system/kube-ops-view:http cluster IP */ tcp dpt:8080
  302 18120 KUBE-NODEPORTS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL
```

### **7. KUBE-SERVICES ì²´ì¸ ë¶„ì„**

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
```

âœ…Â **ì¶œë ¥**

```bash
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
   45  2700 KUBE-SEP-RSD5LYH4WSEXMEXJ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.1.176:8080 */ statistic mode random probability 0.33333333349
   23  1380 KUBE-SEP-NLHUM4JSBL2UEFAX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.2.91:8080 */ statistic mode random probability 0.50000000000
   42  2520 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

- ëœë¤ í™•ë¥  ê¸°ë°˜ìœ¼ë¡œ íŠ¸ë˜í”½ì„ ê° Podë¡œ ë¶„ì‚°
- ê° Podë¡œ 33%, 50% ë“±ì˜ í™•ë¥ ë¡œ íŠ¸ë˜í”½ ì „ë‹¬

**ëª¨ë“  ì›Œì»¤ ë…¸ë“œì˜ iptables ê·œì¹™ ì¼ê´€ì„± í™•ì¸**

```bash
ssh ec2-user@$N2 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-RSD5LYH4WSEXMEXJ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.1.176:8080 */ statistic mode random probability 0.33333333349
    0     0 KUBE-SEP-NLHUM4JSBL2UEFAX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.2.91:8080 */ statistic mode random probability 0.50000000000
    0     0 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

```bash
ssh ec2-user@$N3 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-RSD5LYH4WSEXMEXJ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.1.176:8080 */ statistic mode random probability 0.33333333349
    0     0 KUBE-SEP-NLHUM4JSBL2UEFAX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.2.91:8080 */ statistic mode random probability 0.50000000000
    0     0 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

**3ê°œì˜ SEPëŠ” ê°ê° ê°œë³„ íŒŒë“œ ì ‘ì† ì •ë³´**

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SEP-RSD5LYH4WSEXMEXJ
Chain KUBE-SEP-RSD5LYH4WSEXMEXJ (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-MARK-MASQ  all  --  *      *       192.168.1.176        0.0.0.0/0            /* default/svc-clusterip:svc-webport */
   45  2700 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:192.168.1.176:8080
```

```bash
ssh ec2-user@$N2 sudo iptables -v --numeric --table nat --list KUBE-SEP-RSD5LYH4WSEXMEXJ
Chain KUBE-SEP-RSD5LYH4WSEXMEXJ (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-MARK-MASQ  all  --  *      *       192.168.1.176        0.0.0.0/0            /* default/svc-clusterip:svc-webport */
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:192.168.1.176:8080
```

```bash
ssh ec2-user@$N3 sudo iptables -v --numeric --table nat --list KUBE-SEP-RSD5LYH4WSEXMEXJ
Chain KUBE-SEP-RSD5LYH4WSEXMEXJ (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-MARK-MASQ  all  --  *      *       192.168.1.176        0.0.0.0/0            /* default/svc-clusterip:svc-webport */
    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport */ tcp to:192.168.1.176:8080
```

### **8. Topology Aware Routing ì„¤ì •**

```bash
kubectl annotate service svc-clusterip "service.kubernetes.io/topology-mode=auto"
# ê²°ê³¼
service/svc-clusterip annotated
```

**endpointslices í™•ì¸**

ê° Endpointì— hintsë¡œ AZ(zone) ì •ë³´ í¬í•¨ë¨

```bash
kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip -o yaml
apiVersion: v1
items:
- addressType: IPv4
  apiVersion: discovery.k8s.io/v1
  endpoints:
  - addresses:
    - 192.168.1.176
    conditions:
      ready: true
      serving: true
      terminating: false
    hints:
      forZones:
      - name: ap-northeast-2a
    nodeName: ip-192-168-1-193.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-frsbd
      namespace: default
      uid: c79e9a50-6fe7-4862-b235-f48410dfd4e7
    zone: ap-northeast-2a
  - addresses:
    - 192.168.2.91
    conditions:
      ready: true
      serving: true
      terminating: false
    hints:
      forZones:
      - name: ap-northeast-2b
    nodeName: ip-192-168-2-52.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-8kxhk
      namespace: default
      uid: fc2d6025-50e4-488d-844d-b74e64656869
    zone: ap-northeast-2b
  - addresses:
    - 192.168.3.146
    conditions:
      ready: true
      serving: true
      terminating: false
    hints:
      forZones:
      - name: ap-northeast-2c
    nodeName: ip-192-168-3-72.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-dwhmg
      namespace: default
      uid: 013991cc-6c6a-465a-be3c-2a7128ed4869
    zone: ap-northeast-2c
  kind: EndpointSlice
  metadata:
    creationTimestamp: "2025-02-13T15:02:50Z"
    generateName: svc-clusterip-
    generation: 5
    labels:
      endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
      kubernetes.io/service-name: svc-clusterip
    name: svc-clusterip-8gc6m
    namespace: default
    ownerReferences:
    - apiVersion: v1
      blockOwnerDeletion: true
      controller: true
      kind: Service
      name: svc-clusterip
      uid: f97f9347-cd50-40d7-881e-253b2efe5825
    resourceVersion: "444502"
    uid: 2f964436-d4df-49bd-af2d-b11ec22702b2
  ports:
  - name: svc-webport
    port: 8080
    protocol: TCP
kind: List
metadata:
  resourceVersion: ""
```

### **9. ë¶€í•˜ ë¶„ì‚° í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it netshoot-pod -- zsh -c "for i in {1..100}; do curl -s svc-clusterip | grep Hostname; done | sort | uniq -c | sort -nr"
```

âœ…Â **ì¶œë ¥**

```bash
  100 Hostname: deploy-echo-75b7b9558c-frsbd
```

- **100ë²ˆ ì ‘ì† ì‹œ ë™ì¼ AZì˜ íŒŒë“œë¡œë§Œ ì—°ê²°**
- í¬ë¡œìŠ¤ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ

### **10. IPTables ì •ì±… í™•ì¸**

`ssh` ëª…ë ¹ì–´ë¡œ ê° ë…¸ë“œì—ì„œ `iptables` í™•ì¸

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SERVICES
```

âœ…Â **ì¶œë ¥**

```bash
Chain KUBE-SERVICES (2 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SVC-JD5MR3NA4I4DYORP  tcp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:metrics cluster IP */ tcp dpt:9153
    0     0 KUBE-SVC-UAGC4PYEYZJJEW6D  tcp  --  *      *       0.0.0.0/0            10.100.145.143       /* kube-system/aws-load-balancer-webhook-service:webhook-server cluster IP */ tcp dpt:443
  100  6000 KUBE-SVC-KBDEBIL6IU6WL7RF  tcp  --  *      *       0.0.0.0/0            10.100.101.191       /* default/svc-clusterip:svc-webport cluster IP */ tcp dpt:80
    0     0 KUBE-SVC-I7SKRZYQ7PWYV5X7  tcp  --  *      *       0.0.0.0/0            10.100.83.10         /* kube-system/eks-extension-metrics-api:metrics-api cluster IP */ tcp dpt:443
  100  9600 KUBE-SVC-TCOU7JCQXEZGVUNU  udp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:dns cluster IP */ udp dpt:53
    0     0 KUBE-SVC-ERIFXISQEP7F7OF4  tcp  --  *      *       0.0.0.0/0            10.100.0.10          /* kube-system/kube-dns:dns-tcp cluster IP */ tcp dpt:53
    0     0 KUBE-SVC-Z4ANX4WAEWEBLCTM  tcp  --  *      *       0.0.0.0/0            10.100.101.216       /* kube-system/metrics-server:https cluster IP */ tcp dpt:443
    0     0 KUBE-SVC-NPX46M4PTMTKRN6Y  tcp  --  *      *       0.0.0.0/0            10.100.0.1           /* default/kubernetes:https cluster IP */ tcp dpt:443
    0     0 KUBE-SVC-7EJNTS7AENER2WX5  tcp  --  *      *       0.0.0.0/0            10.100.146.32        /* kube-system/kube-ops-view:http cluster IP */ tcp dpt:8080
  108  6480 KUBE-NODEPORTS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service nodeports; NOTE: this must be the last rule in this chain */ ADDRTYPE match dst-type LOCAL
```

**`KUBE-SVC-KBDEBIL6IU6WL7RF` ì²´ì¸ì—ì„œ ë™ì¼ AZì˜ íŒŒë“œë¡œë§Œ íŠ¸ë˜í”½ ì „ë‹¬ í™•ì¸**

Topology Modeì˜ hints ì‚¬ìš© ì‹œ kube-proxyê°€ í•´ë‹¹ AZì— ìˆëŠ” Podë¡œë§Œ íŠ¸ë˜í”½ì„ ë¶„ì‚°í•˜ë„ë¡ ê·œì¹™ì´ ë³€ê²½ë¨

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
# ì¶œë ¥
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  100  6000 KUBE-SEP-RSD5LYH4WSEXMEXJ  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.1.176:8080 */
```

```bash
ssh ec2-user@$N2 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
# ì¶œë ¥
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-NLHUM4JSBL2UEFAX  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.2.91:8080 */
```

```bash
ssh ec2-user@$N3 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
# ì¶œë ¥
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

### **11. íŒŒë“œ ê°œìˆ˜ë¥¼ 1ê°œë¡œ ì¤„ì—¬ ê°™ì€ AZì— ëª©ì ì§€ íŒŒë“œê°€ ì—†ì„ ê²½ìš°**

**(1) íŒŒë“œ ê°œìˆ˜ 1ê°œë¡œ ì¶•ì†Œ**

```bash
kubectl scale deployment deploy-echo --replicas 1
# ê²°ê³¼
deployment.apps/deploy-echo scaled
```

**(2) íŒŒë“œ AZ í™•ì¸**

```bash
kubectl get pod -owide
```

âœ…Â **ì¶œë ¥**

```bash
NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
deploy-echo-75b7b9558c-dwhmg   1/1     Running   0          42m   192.168.3.146   ip-192-168-3-72.ap-northeast-2.compute.internal    <none>           <none>
netshoot-pod                   1/1     Running   0          41m   192.168.1.98    ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
```

**(3) 100ë²ˆ ë°˜ë³µ í…ŒìŠ¤íŠ¸**

```bash
kubectl exec -it netshoot-pod -- zsh -c "for i in {1..100}; do curl -s svc-clusterip | grep Hostname; done | sort | uniq -c | sort -nr"
```

âœ…Â **ì¶œë ¥**

100ë²ˆ ëª¨ë‘ `deploy-echo-75b7b9558c-dwhmg` íŒŒë“œë¡œ ì ‘ì†ë¨

```bash
  100 Hostname: deploy-echo-75b7b9558c-dwhmg
```

**(4) IPTables ì •ì±… í™•ì¸**

ê° ë…¸ë“œì—ì„œ `KUBE-SVC-KBDEBIL6IU6WL7RF` ì²´ì¸ í™•ì¸ ì‹œ ëª¨ë‘ ê°™ì€ AZì˜ íŒŒë“œë¡œë§Œ ì—°ê²°ë¨

```bash
ssh ec2-user@$N1 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
  100  6000 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

```bash
ssh ec2-user@$N2 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

```bash
ssh ec2-user@$N3 sudo iptables -v --numeric --table nat --list KUBE-SVC-KBDEBIL6IU6WL7RF
Chain KUBE-SVC-KBDEBIL6IU6WL7RF (1 references)
 pkts bytes target     prot opt in     out     source               destination         
    0     0 KUBE-SEP-6CT57P6L6QUJZOMH  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/svc-clusterip:svc-webport -> 192.168.3.146:8080 */
```

**(5) EndpointSlices í™•ì¸**

hint ì •ë³´ ì—†ìŒ

```bash
kubectl get endpointslices -l kubernetes.io/service-name=svc-clusterip -o yaml
```

âœ…Â **ì¶œë ¥**

```bash
apiVersion: v1
items:
- addressType: IPv4
  apiVersion: discovery.k8s.io/v1
  endpoints:
  - addresses:
    - 192.168.3.146
    conditions:
      ready: true
      serving: true
      terminating: false
    nodeName: ip-192-168-3-72.ap-northeast-2.compute.internal
    targetRef:
      kind: Pod
      name: deploy-echo-75b7b9558c-dwhmg
      namespace: default
      uid: 013991cc-6c6a-465a-be3c-2a7128ed4869
    zone: ap-northeast-2c
  kind: EndpointSlice
  metadata:
    creationTimestamp: "2025-02-13T15:02:50Z"
    generateName: svc-clusterip-
    generation: 7
    labels:
      endpointslice.kubernetes.io/managed-by: endpointslice-controller.k8s.io
      kubernetes.io/service-name: svc-clusterip
    name: svc-clusterip-8gc6m
    namespace: default
    ownerReferences:
    - apiVersion: v1
      blockOwnerDeletion: true
      controller: true
      kind: Service
      name: svc-clusterip
      uid: f97f9347-cd50-40d7-881e-253b2efe5825
    resourceVersion: "447576"
    uid: 2f964436-d4df-49bd-af2d-b11ec22702b2
  ports:
  - name: svc-webport
    port: 8080
    protocol: TCP
kind: List
metadata:
  resourceVersion: ""
```

### **12. ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
kubectl delete deploy deploy-echo; kubectl delete svc svc-clusterip
# ê²°ê³¼
deployment.apps "deploy-echo" deleted
service "svc-clusterip" deleted
```

---

## **ğŸ§ª AWS Load Balancer Controllerë¡œ ë¸”ë£¨/ê·¸ë¦° ë°°í¬, ì¹´ë‚˜ë¦¬ ë°°í¬, A/B í…ŒìŠ¤íŠ¸ ì‹¤ìŠµ**

### **1. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ í´ë¡ **

```bash
(eks-user:N/A) [root@operator-host ~]# git clone https://github.com/paulbouwer/hello-kubernetes.git
# ê²°ê³¼
Cloning into 'hello-kubernetes'...
remote: Enumerating objects: 294, done.
remote: Total 294 (delta 0), reused 0 (delta 0), pack-reused 294 (from 1)
Receiving objects: 100% (294/294), 168.42 KiB | 7.66 MiB/s, done.
Resolving deltas: 100% (120/120), done.
```

### **2. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ v1 ì„¤ì¹˜**

```bash
(eks-user:N/A) [root@operator-host ~]# helm install --create-namespace --namespace hello-kubernetes v1 \
>   ./hello-kubernetes/deploy/helm/hello-kubernetes \
>   --set message="You are reaching hello-kubernetes version 1" \
>   --set ingress.configured=true \
>   --set service.type="ClusterIP"
# ê²°ê³¼
NAME: v1
LAST DEPLOYED: Fri Feb 14 00:57:28 2025
NAMESPACE: hello-kubernetes
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

### **3. ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ v2 ì„¤ì¹˜**

```bash
(eks-user:N/A) [root@operator-host ~]# helm install --create-namespace --namespace hello-kubernetes v2 \
>   ./hello-kubernetes/deploy/helm/hello-kubernetes \
>   --set message="You are reaching hello-kubernetes version 2" \
>   --set ingress.configured=true \
>   --set service.type="ClusterIP"
# ê²°ê³¼
NAME: v2
LAST DEPLOYED: Fri Feb 14 00:57:59 2025
NAMESPACE: hello-kubernetes
STATUS: deployed
REVISION: 1
TEST SUITE: None
```

### **4. ë°°í¬ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get pod,svc,ep -n hello-kubernetes
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                       READY   STATUS    RESTARTS   AGE
pod/hello-kubernetes-v1-7b546f6687-67w5x   1/1     Running   0          92s
pod/hello-kubernetes-v1-7b546f6687-nc877   1/1     Running   0          92s
pod/hello-kubernetes-v2-7b9df8f6c5-4qtd7   1/1     Running   0          60s
pod/hello-kubernetes-v2-7b9df8f6c5-g2jp9   1/1     Running   0          60s

NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/hello-kubernetes-v1   ClusterIP   10.100.175.94    <none>        80/TCP    92s
service/hello-kubernetes-v2   ClusterIP   10.100.160.118   <none>        80/TCP    60s

NAME                            ENDPOINTS                               AGE
endpoints/hello-kubernetes-v1   192.168.1.195:8080,192.168.2.237:8080   92s
endpoints/hello-kubernetes-v2   192.168.1.176:8080,192.168.3.146:8080   60s
```

### **5. ì¸ê·¸ë ˆìŠ¤ ìƒì„±**

```bash
(eks-user:N/A) [root@operator-host ~]# cat <<EOF | kubectl apply -f -
> apiVersion: networking.k8s.io/v1
> kind: Ingress
> metadata:
>   name: "hello-kubernetes"
>   namespace: "hello-kubernetes"
>   annotations:
>     alb.ingress.kubernetes.io/scheme: internet-facing
>     alb.ingress.kubernetes.io/target-type: ip
>     alb.ingress.kubernetes.io/actions.blue-green: |
>       {
>         "type":"forward",
>         "forwardConfig":{
>           "targetGroups":[
>             {
>               "serviceName":"hello-kubernetes-v1",
>               "servicePort":"80",
>               "weight":100
>             },
>             {
>               "serviceName":"hello-kubernetes-v2",
>               "servicePort":"80",
>               "weight":0
>             }
>           ]
>         }
>       }
>   labels:
>     app: hello-kubernetes
> spec:
>   ingressClassName: alb
>   rules:
>     - http:
>         paths:
>           - path: /
>             pathType: Prefix
>             backend:
>               service:
>                 name: blue-green
>                 port:
>                   name: use-annotation
> EOF
ingress.networking.k8s.io/hello-kubernetes created
```

### **6. ì¸ê·¸ë ˆìŠ¤ ë° í¬ì›Œë”© í™•ì¸**

**ì¸ê·¸ë ˆìŠ¤ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl describe ingress -n hello-kubernetes
```

âœ…Â **ì¶œë ¥**

```bash
Name:             hello-kubernetes
Labels:           app=hello-kubernetes
Namespace:        hello-kubernetes
Address:          k8s-hellokub-hellokub-7e40b1a1ff-555575423.ap-northeast-2.elb.amazonaws.com
Ingress Class:    alb
Default backend:  <default>
Rules:
  Host        Path  Backends
  ----        ----  --------
  *           
              /   blue-green:use-annotation (<error: services "blue-green" not found>)
Annotations:  alb.ingress.kubernetes.io/actions.blue-green:
                {
                  "type":"forward",
                  "forwardConfig":{
                    "targetGroups":[
                      {
                        "serviceName":"hello-kubernetes-v1",
                        "servicePort":"80",
                        "weight":100
                      },
                      {
                        "serviceName":"hello-kubernetes-v2",
                        "servicePort":"80",
                        "weight":0
                      }
                    ]
                  }
                }
              alb.ingress.kubernetes.io/scheme: internet-facing
              alb.ingress.kubernetes.io/target-type: ip
Events:
  Type    Reason                  Age   From     Message
  ----    ------                  ----  ----     -------
  Normal  SuccessfullyReconciled  3m4s  ingress  Successfully reconciled
```

**í¬ì›Œë”© í™•ì¸**

í˜„ì¬ ë²„ì „ 1ë§Œ ì‘ë‹µ

```bash
(eks-user:N/A) [root@operator-host ~]# ELB_URL=$(kubectl get ingress -n hello-kubernetes -o=jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
(eks-user:N/A) [root@operator-host ~]# while true; do curl -s $ELB_URL | grep version; sleep 1; done
  You are reaching hello-kubernetes version 1
  You are reaching hello-kubernetes version 1
  You are reaching hello-kubernetes version 1
  You are reaching hello-kubernetes version 1
  You are reaching hello-kubernetes version 1
  You are reaching hello-kubernetes version 1
  ....
```

**ALBì˜ í¬ì›Œë”© ëŒ€ìƒ íƒ€ê²Ÿ ê·¸ë£¹ì€ 2ê°€ì§€ê°€ ìˆìŒ**

![Image](https://github.com/user-attachments/assets/5bfa8ef7-1749-4e55-a862-e48a16a388be)

- **ê¸°ì¡´ ë²„ì „**: `k8s-hellokub-hellokub-bb26fff580`ìœ¼ë¡œ 100% íŠ¸ë˜í”½ ì „ë‹¬
- **ì‹ ê·œ ë²„ì „**: `k8s-hellokub-hellokub-f58a344fd6`ìœ¼ë¡œ 0% íŠ¸ë˜í”½ ì „ë‹¬

### **7. ë¸”ë£¨/ê·¸ë¦° ë°°í¬**

**ë¸”ë£¨/ê·¸ë¦° ë°°í¬ ì„¤ì •**

```bash
(eks-user:N/A) [root@operator-host ~]# cat <<EOF | kubectl apply -f -
> apiVersion: networking.k8s.io/v1
> kind: Ingress
> metadata:
>   name: "hello-kubernetes"
>   namespace: "hello-kubernetes"
>   annotations:
>     alb.ingress.kubernetes.io/scheme: internet-facing
>     alb.ingress.kubernetes.io/target-type: ip
>     alb.ingress.kubernetes.io/actions.blue-green: |
>       {
>         "type":"forward",
>         "forwardConfig":{
>           "targetGroups":[
>             {
>               "serviceName":"hello-kubernetes-v1",
>               "servicePort":"80",
>               "weight":0
>             },
>             {
>               "serviceName":"hello-kubernetes-v2",
>               "servicePort":"80",
>               "weight":100
>             }
>           ]
>         }
>       }
>   labels:
>     app: hello-kubernetes
> spec:
>   ingressClassName: alb
>   rules:
>     - http:
>         paths:
>           - path: /
>             pathType: Prefix
>             backend:
>               service:
>                 name: blue-green
>                 port:
>                   name: use-annotation
> EOF

# ê²°ê³¼
ingress.networking.k8s.io/hello-kubernetes configured
```

**íƒ€ê²Ÿ ê·¸ë£¹ì´ version 2ë¡œ 100% í¬ì›Œë”©ë¨**

```bash
(eks-user:N/A) [root@operator-host ~]# while true; do curl -s $ELB_URL | grep version; sleep 1; done
  You are reaching hello-kubernetes version 2
  You are reaching hello-kubernetes version 2
  You are reaching hello-kubernetes version 2
  You are reaching hello-kubernetes version 2
  You are reaching hello-kubernetes version 2
  You are reaching hello-kubernetes version 2
  .....
```

**ALB íƒ€ê²Ÿ ê·¸ë£¹ ë³€ê²½ í™•ì¸**

k8s-hellokub-hellokub-f58a344fd6 100ìœ¼ë¡œ ë°”ë€Œì—ˆë‹¤. 

![Image](https://github.com/user-attachments/assets/94672a70-a9a7-4794-a3d8-66d79164bba7)

### **8. ì¹´ë‚˜ë¦¬ ë°°í¬**

**ì¹´ë‚˜ë¦¬ ë°°í¬ ì„¤ì •**

```bash
(eks-user:N/A) [root@operator-host ~]# cat <<EOF | kubectl apply -f -
> apiVersion: networking.k8s.io/v1
> kind: Ingress
> metadata:
>   name: "hello-kubernetes"
>   namespace: "hello-kubernetes"
>   annotations:
>     alb.ingress.kubernetes.io/scheme: internet-facing
>     alb.ingress.kubernetes.io/target-type: ip
>     alb.ingress.kubernetes.io/actions.blue-green: |
>       {
>         "type":"forward",
>         "forwardConfig":{
>           "targetGroups":[
>             {
>               "serviceName":"hello-kubernetes-v1",
>               "servicePort":"80",
>               "weight":90
>             },
>             {
>               "serviceName":"hello-kubernetes-v2",
>               "servicePort":"80",
>               "weight":10
>             }
>           ]
>         }
>       }
>   labels:
>     app: hello-kubernetes
> spec:
>   ingressClassName: alb
>   rules:
>     - http:
>         paths:
>           - path: /
>             pathType: Prefix
>             backend:
>               service:
>                 name: blue-green
>                 port:
>                   name: use-annotation
> EOF
# ê²°ê³¼
ingress.networking.k8s.io/hello-kubernetes configured
```

**ì ‘ì† ê²°ê³¼ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# for i in {1..100};  do curl -s $ELB_URL | grep version ; done | sort | uniq -c | sort -nr
     86   You are reaching hello-kubernetes version 1
     14   You are reaching hello-kubernetes version 2
```

![Image](https://github.com/user-attachments/assets/d9b49f8f-6217-4482-abfa-4fbaa8a99a47)

### **9. a/b í…ŒìŠ¤íŠ¸**

**A/B í…ŒìŠ¤íŠ¸ ì„¤ì •**

```bash
(eks-user:N/A) [root@operator-host ~]# cat <<EOF | kubectl apply -f -
> apiVersion: networking.k8s.io/v1
> kind: Ingress
> metadata:
>   name: "hello-kubernetes"
>   namespace: "hello-kubernetes"
>   annotations:
>     alb.ingress.kubernetes.io/scheme: internet-facing
>     alb.ingress.kubernetes.io/target-type: ip
>     alb.ingress.kubernetes.io/conditions.ab-testing: >
>       [{"field":"http-header","httpHeaderConfig":{"httpHeaderName": "HeaderName", "values":["aews-study"]}}]
>     alb.ingress.kubernetes.io/actions.ab-testing: >
>       {"type":"forward","forwardConfig":{"targetGroups":[{"serviceName":"hello-kubernetes-v2","servicePort":80}]}}
>   labels:
>     app: hello-kubernetes
> spec:
>   ingressClassName: alb
>   rules:
>     - http:
>         paths:
>           - path: /
>             pathType: Prefix
>             backend:
>               service:
>                 name: ab-testing
>                 port:
>                   name: use-annotation
>           - path: /
>             pathType: Prefix
>             backend:
>               service:
>                 name: hello-kubernetes-v1
>                 port:
>                   name: http
> EOF
# ê²°ê³¼
ingress.networking.k8s.io/hello-kubernetes configured
```

- HTTP Header `HeaderName: aews-study` ì¡°ê±´ìœ¼ë¡œ íŠ¸ë˜í”½ ë¶„í• 

**A/B í…ŒìŠ¤íŠ¸ í™•ì¸**

`HeaderName: aews-study` í¬í•¨ ì‹œ version 2ë¡œ 100% í¬ì›Œë”©

```bash
(eks-user:N/A) [root@operator-host ~]# for i in {1..100};  do curl -s -H "HeaderName: aews-study" $ELB_URL | grep version ; done | sort | uniq -c | sort -nr
    100   You are reaching hello-kubernetes version 2
```

í¬í•¨ë˜ì§€ ì•Šì„ ì‹œ version 1ë¡œ 100% í¬ì›Œë”©

```bash
(eks-user:N/A) [root@operator-host ~]# for i in {1..100};  do curl -s $ELB_URL | grep version ; done | sort | uniq -c | sort -nr
    100   You are reaching hello-kubernetes version 1
```

![Image](https://github.com/user-attachments/assets/71019cfd-ecd3-44b5-9b0f-ea85f99b89aa)

### **10. ì‹¤ìŠµ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl delete ingress -n hello-kubernetes hello-kubernetes && kubectl delete ns hello-kubernetes
# ê²°ê³¼
ingress.networking.k8s.io "hello-kubernetes" deleted
namespace "hello-kubernetes" deleted
```

---

## **ğŸ•µï¸â€â™‚ï¸ ë„¤íŠ¸ì›Œí¬ ë¶„ì„ íˆ´**

### **1. Kubeskoop ì„¤ì¹˜**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl apply -f https://raw.githubusercontent.com/alibaba/kubeskoop/main/deploy/skoopbundle.yaml
# ê²°ê³¼
namespace/kubeskoop created
daemonset.apps/kubeskoop-exporter created
configmap/kubeskoop-config created
clusterrole.rbac.authorization.k8s.io/prometheus created
clusterrolebinding.rbac.authorization.k8s.io/prometheus created
configmap/prometheus-server-conf created
deployment.apps/prometheus-deployment created
service/prometheus-service created
service/loki-service created
configmap/grafana-datasources created
deployment.apps/grafana created
service/grafana created
deployment.apps/grafana-loki created
configmap/grafana-loki-config created
clusterrole.rbac.authorization.k8s.io/kubeskoop-controller created
clusterrolebinding.rbac.authorization.k8s.io/kubeskoop-controller created
role.rbac.authorization.k8s.io/controller created
rolebinding.rbac.authorization.k8s.io/controller created
configmap/kubeskoop-controller-config created
deployment.apps/controller created
service/controller created
deployment.apps/webconsole created
service/webconsole created

(eks-user:N/A) [root@operator-host ~]# kubectl patch service webconsole -n kubeskoop -p '{"spec": {"type": "LoadBalancer"}}'
service/webconsole patched
(eks-user:N/A) [root@operator-host ~]# kubectl patch service prometheus-service -n kubeskoop -p '{"spec": {"type": "LoadBalancer"}}'
service/prometheus-service patched
(eks-user:N/A) [root@operator-host ~]# kubectl patch service grafana -n kubeskoop -p '{"spec": {"type": "LoadBalancer"}}'
service/grafana patched
```

### **2. kubeskoop ì›¹ ì ‘ì†**

**admin / kubeskoop**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get svc -n kubeskoop webconsole
NAME         TYPE           CLUSTER-IP     EXTERNAL-IP                                                                   PORT(S)        AGE
webconsole   LoadBalancer   10.100.14.77   ac2514347b0c84f0b84e1aa71fe7e0dc-996135232.ap-northeast-2.elb.amazonaws.com   80:32223/TCP   84s
```

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get svc -n kubeskoop webconsole -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "KubeSkoop URL = http://"$1""}'
KubeSkoop URL = http://ac2514347b0c84f0b84e1aa71fe7e0dc-996135232.ap-northeast-2.elb.amazonaws.com
```

![Image](https://github.com/user-attachments/assets/a2884e54-9148-451c-83a7-c9433af6d8e6)


### **3. íŒ¨í‚· ìº¡ì²˜ë§ í…ŒìŠ¤íŠ¸**

**netshoot-pod ì •ë³´ í™•ì¸**

```bash
(eks-user:N/A) [root@operator-host ~]# k get pod -owide
NAME           READY   STATUS    RESTARTS   AGE    IP             NODE                                               NOMINATED NODE   READINESS GATES
netshoot-pod   1/1     Running   0          109m   192.168.1.98   ip-192-168-1-193.ap-northeast-2.compute.internal   <none>           <none>
```

**netshoot-pod ping í…ŒìŠ¤íŠ¸**

```bash
(eks-user:N/A) [root@operator-host ~]# ping 192.168.1.98
PING 192.168.1.98 (192.168.1.98) 56(84) bytes of data.
64 bytes from 192.168.1.98: icmp_seq=1 ttl=126 time=1.08 ms
64 bytes from 192.168.1.98: icmp_seq=2 ttl=126 time=0.644 ms
64 bytes from 192.168.1.98: icmp_seq=3 ttl=126 time=0.649 ms
64 bytes from 192.168.1.98: icmp_seq=4 ttl=126 time=0.680 ms
64 bytes from 192.168.1.98: icmp_seq=5 ttl=126 time=0.767 ms
```

![Image](https://github.com/user-attachments/assets/53e02d77-5d97-47a7-aad3-dfadd0d312fe)

### **4. í”„ë¡œë©”í…Œìš°ìŠ¤ ì›¹ ì ‘ì†**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get svc -n kubeskoop prometheus-service -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "prometheus URL = http://"$1""}'
prometheus URL = http://af6d238bde2c24a829f56fd1abdc6989-1339249886.ap-northeast-2.elb.amazonaws.com
```

![Image](https://github.com/user-attachments/assets/941ff36e-6ddd-47a5-b411-10e03c36e9f2)


### **5. ê·¸ë¼íŒŒë‚˜ ì›¹ ì ‘ì†**

**admin / kubeskoop**

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl get svc -n kubeskoop grafana -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' | awk '{ print "grafana URL = http://"$1""}'
grafana URL = http://a87ee7a3d119b4d0a9a742a9d992375d-114222539.ap-northeast-2.elb.amazonaws.com
```

![Image](https://github.com/user-attachments/assets/0a31781c-fabd-4ea2-a370-373f44e27bdc)
---

## **ğŸ”— AWS EKS IPVS ëª¨ë“œ ì„¤ì •**

**IPVS ëª¨ë“œ**

- IPVS ëŠ” ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì—ì„œ ë™ì‘í•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ë¡œë“œë°¸ëŸ°ì„œì´ë‹¤. ë°±ì—”ë“œ(í”Œë«í¼)ìœ¼ë¡œ Netfilter ë¥¼ ì‚¬ìš©í•˜ë©°, TCP/UDP ìš”ì²­ì„ ì²˜ë¦¬ í•  ìˆ˜ ìˆë‹¤.
- iptables ì˜ rule ê¸°ë°˜ ì²˜ë¦¬ì˜ ì„±ëŠ¥ í•œê³„ì™€ ë¶„ì‚° ì•Œê³ ë¦¬ì¦˜ì´ ì—†ì–´ì„œ, ìµœê·¼ì—ëŠ” ëŒ€ì²´ë¡œ IPVS ë¥¼ ì‚¬ìš©í•œë‹¤.

### **1. ì„œë²„ë³„ IPVS ëª¨ë“ˆ ì„¤ì •**

ì„œë²„ 1, 2, 3 ê°ê° IPVS ëª¨ë“ˆ ì„¤ì •

```bash
[ec2-user@ip-192-168-1-193 ~]$ sudo sh -c 'cat << EOF > /etc/modules-load.d/ipvs.conf
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_lc
ip_vs_wlc
ip_vs_lblc
ip_vs_lblcr
ip_vs_sh
ip_vs_dh
ip_vs_sed
ip_vs_nq
nf_conntrack
EOF'

[ec2-user@ip-192-168-1-193 ~]$ sudo modprobe ip_vs
sudo modprobe ip_vs_rr
sudo modprobe ip_vs_wrr
sudo modprobe ip_vs_lc
sudo modprobe ip_vs_wlc
sudo modprobe ip_vs_lblc
sudo modprobe ip_vs_lblcr
sudo modprobe ip_vs_sh
sudo modprobe ip_vs_dh
sudo modprobe ip_vs_sed
sudo modprobe ip_vs_nq
sudo modprobe nf_conntrack
```

```bash
[ec2-user@ip-192-168-2-52 ~]$ sudo sh -c 'cat << EOF > /etc/modules-load.d/ipvs.conf
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_lc
ip_vs_wlc
ip_vs_lblc
ip_vs_lblcr
ip_vs_sh
ip_vs_dh
ip_vs_sed
ip_vs_nq
nf_conntrack
EOF'

[ec2-user@ip-192-168-2-52 ~]$ sudo modprobe ip_vs
sudo modprobe ip_vs_rr
sudo modprobe ip_vs_wrr
sudo modprobe ip_vs_lc
sudo modprobe ip_vs_wlc
sudo modprobe ip_vs_lblc
sudo modprobe ip_vs_lblcr
sudo modprobe ip_vs_sh
sudo modprobe ip_vs_dh
sudo modprobe ip_vs_sed
sudo modprobe ip_vs_nq
sudo modprobe nf_conntrack
```

```bash
[ec2-user@ip-192-168-3-72 ~]$ sudo sh -c 'cat << EOF > /etc/modules-load.d/ipvs.conf
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_lc
ip_vs_wlc
ip_vs_lblc
ip_vs_lblcr
ip_vs_sh
ip_vs_dh
ip_vs_sed
ip_vs_nq
nf_conntrack
EOF'

[ec2-user@ip-192-168-3-72 ~]$ sudo modprobe ip_vs
sudo modprobe ip_vs_rr
sudo modprobe ip_vs_wrr
sudo modprobe ip_vs_lc
sudo modprobe ip_vs_wlc
sudo modprobe ip_vs_lblc
sudo modprobe ip_vs_lblcr
sudo modprobe ip_vs_sh
sudo modprobe ip_vs_dh
sudo modprobe ip_vs_sed
sudo modprobe ip_vs_nq
sudo modprobe nf_conntrack
```

### **2. IPVS ëª¨ë“ˆ í™•ì¸**

ê° ì„œë²„ì—ì„œ `lsmod | grep ^ip_vs`ë¡œ IPVS ëª¨ë“ˆì´ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸

```bash
[ec2-user@ip-192-168-1-193 ~]$ sudo lsmod | grep ^ip_vs
# ì¶œë ¥
ip_vs_nq               16384  0
ip_vs_sed              16384  0
ip_vs_dh               16384  0
ip_vs_sh               16384  0
ip_vs_lblcr            16384  0
ip_vs_lblc             16384  0
ip_vs_wlc              16384  0
ip_vs_lc               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 192512  20 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed
```

```bash
[ec2-user@ip-192-168-2-52 ~]$ sudo lsmod | grep ^ip_vs
# ì¶œë ¥
ip_vs_nq               16384  0
ip_vs_sed              16384  0
ip_vs_dh               16384  0
ip_vs_sh               16384  0
ip_vs_lblcr            16384  0
ip_vs_lblc             16384  0
ip_vs_wlc              16384  0
ip_vs_lc               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 192512  20 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed
```

```bash
[ec2-user@ip-192-168-3-72 ~]$ sudo lsmod | grep ^ip_vs
# ì¶œë ¥
ip_vs_nq               16384  0
ip_vs_sed              16384  0
ip_vs_dh               16384  0
ip_vs_sh               16384  0
ip_vs_lblcr            16384  0
ip_vs_lblc             16384  0
ip_vs_wlc              16384  0
ip_vs_lc               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 192512  20 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_nq,ip_vs_lblc,ip_vs_wrr,ip_vs_lc,ip_vs_sed
```

### **3. AWS EKSì— IPVS ëª¨ë“œ ë°˜ì˜**

```bash
aws eks update-addon --cluster-name $CLUSTER_NAME --addon-name kube-proxy \
  --configuration-values '{"ipvs": {"scheduler": "rr"}, "mode": "ipvs"}' \
  --resolve-conflicts OVERWRITE

# ê²°ê³¼
{
    "update": {
        "id": "3e57ed90-40b8-3ebb-98ac-73e497864986",
        "status": "InProgress",
        "type": "AddonUpdate",
        "params": [
            {
                "type": "ResolveConflicts",
                "value": "OVERWRITE"
            },
            {
                "type": "ConfigurationValues",
                "value": "{\"ipvs\": {\"scheduler\": \"rr\"}, \"mode\": \"ipvs\"}"
            }
        ],
        "createdAt": "2025-02-14T02:06:42.661000+09:00",
        "errors": []
    }
}
```

### **4. kube-proxy ë°ëª¬ì…‹ ì¬ì‹œì‘**

```bash
kubectl -n kube-system rollout restart ds kube-proxy
# ê²°ê³¼
daemonset.apps/kube-proxy restarted
```

### **5. kube-proxy ì„¤ì • í™•ì¸**

```bash
kubectl get cm -n kube-system kube-proxy-config -o yaml
```

âœ…Â **ì¶œë ¥**

`mode: "ipvs"`, `scheduler: "rr"` ì„¤ì • í™•ì¸

```bash
apiVersion: v1
data:
  config: |-
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    bindAddress: 0.0.0.0
    clientConnection:
      acceptContentTypes: ""
      burst: 10
      contentType: application/vnd.kubernetes.protobuf
      kubeconfig: /var/lib/kube-proxy/kubeconfig
      qps: 5
    clusterCIDR: ""
    configSyncPeriod: 15m0s
    conntrack:
      maxPerCore: 32768
      min: 131072
      tcpCloseWaitTimeout: 1h0m0s
      tcpEstablishedTimeout: 24h0m0s
    enableProfiling: false
    healthzBindAddress: 0.0.0.0:10256
    hostnameOverride: ""
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      minSyncPeriod: 0s
      syncPeriod: 30s
    ipvs:
      excludeCIDRs: null
      minSyncPeriod: 0s
      scheduler: "rr"
      syncPeriod: 30s
    kind: KubeProxyConfiguration
    metricsBindAddress: 0.0.0.0:10249
    mode: "ipvs"
    nodePortAddresses: null
    oomScoreAdj: -998
    portRange: ""
kind: ConfigMap
metadata:
  creationTimestamp: "2025-02-12T03:13:56Z"
  labels:
    eks.amazonaws.com/component: kube-proxy
    k8s-app: kube-proxy
  name: kube-proxy-config
  namespace: kube-system
  resourceVersion: "466743"
  uid: 83ba2b60-5afb-4ea8-b037-84a02d9036ef
```

### **6. kube-ipvs0 ì¸í„°í˜ì´ìŠ¤ ìƒì„± í™•ì¸**

IPVS ëª¨ë“œë¡œ ë³€ê²½ ì‹œ `kube-ipvs0` ì¸í„°í˜ì´ìŠ¤ê°€ ìƒì„±ë˜ì–´ ì„œë¹„ìŠ¤ virtual IP í• ë‹¹ë¨

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c addr; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 43.202.57.204 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:23:93:a6:bc:61 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.1.193/24 metric 1024 brd 192.168.1.255 scope global dynamic ens5
       valid_lft 2300sec preferred_lft 2300sec
    inet6 fe80::23:93ff:fea6:bc61/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: eni01a4864c88a@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 56:be:6a:bd:2d:2a brd ff:ff:ff:ff:ff:ff link-netns cni-a59ccd2b-5db2-0159-b78e-e0797b300a23
    inet6 fe80::54be:6aff:febd:2d2a/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: eni61c5a949744@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 52:41:42:c3:03:3f brd ff:ff:ff:ff:ff:ff link-netns cni-74caca86-36e2-a922-2920-c2c8c00e7b43
    inet6 fe80::5041:42ff:fec3:33f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
14: ens7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:d8:5d:80:2c:c9 brd ff:ff:ff:ff:ff:ff
    altname enp0s7
    inet 192.168.1.232/24 brd 192.168.1.255 scope global ens7
       valid_lft forever preferred_lft forever
    inet6 fe80::d8:5dff:fe80:2cc9/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
38: enica32516c01a@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 92:2a:72:57:7d:03 brd ff:ff:ff:ff:ff:ff link-netns cni-f0cb87e6-1f26-e2c9-b622-9a99215f4cca
    inet6 fe80::902a:72ff:fe57:7d03/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
41: enifc4d699b169@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether b6:46:07:f2:a2:65 brd ff:ff:ff:ff:ff:ff link-netns cni-2c0732df-1963-6937-d7ad-2ea9fe9f3481
    inet6 fe80::b446:7ff:fef2:a265/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
42: enid72dce04775@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 5e:54:5b:e7:37:87 brd ff:ff:ff:ff:ff:ff link-netns cni-50b39a65-fb46-3e73-0831-6f9b159d1c56
    inet6 fe80::5c54:5bff:fee7:3787/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
43: kube-ipvs0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN group default 
    link/ether ce:47:f1:9e:78:ad brd ff:ff:ff:ff:ff:ff
    inet 10.100.110.88/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.214.208/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.73.70/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.17.159/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.14.77/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.145.143/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.83.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.146.32/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.101.216/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

>> node 15.164.179.214 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:c5:5b:d1:77:57 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.2.52/24 metric 1024 brd 192.168.2.255 scope global dynamic ens5
       valid_lft 2295sec preferred_lft 2295sec
    inet6 fe80::4c5:5bff:fed1:7757/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: enibce2df30e87@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 4a:c8:23:ab:85:39 brd ff:ff:ff:ff:ff:ff link-netns cni-5408bb28-ad79-a3f3-3a60-9442968852b1
    inet6 fe80::48c8:23ff:feab:8539/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: enic99196c7a64@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 8a:00:6e:37:b1:71 brd ff:ff:ff:ff:ff:ff link-netns cni-9343fb30-bdc8-5fab-b46d-3a5db58f8007
    inet6 fe80::8800:6eff:fe37:b171/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
28: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:0e:23:61:2c:f9 brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.2.136/24 brd 192.168.2.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::40e:23ff:fe61:2cf9/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
34: eni79cb46fcdac@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether c6:d6:b9:a4:cf:99 brd ff:ff:ff:ff:ff:ff link-netns cni-188308ca-6087-e1e0-f4f3-7e6fd2da16e3
    inet6 fe80::c4d6:b9ff:fea4:cf99/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
39: enib1a09dbf60e@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 76:23:31:29:2f:9f brd ff:ff:ff:ff:ff:ff link-netns cni-cb0b81af-c51f-85de-47fa-5036f76d4745
    inet6 fe80::7423:31ff:fe29:2f9f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
40: kube-ipvs0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN group default 
    link/ether 82:2e:0b:7a:92:81 brd ff:ff:ff:ff:ff:ff
    inet 10.100.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.17.159/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.73.70/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.110.88/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.146.32/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.83.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.145.143/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.101.216/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.214.208/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.14.77/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever

>> node 43.201.115.81 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:d5:3d:4a:54:bd brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.72/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 2304sec preferred_lft 2304sec
    inet6 fe80::8d5:3dff:fe4a:54bd/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: enif2c43957bf8@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether a2:e3:15:62:47:31 brd ff:ff:ff:ff:ff:ff link-netns cni-8acd7723-2d0b-690f-3d4b-d3e902287dd1
    inet6 fe80::a0e3:15ff:fe62:4731/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
14: ens7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:0c:3c:65:9c:27 brd ff:ff:ff:ff:ff:ff
    altname enp0s7
    inet 192.168.3.218/24 brd 192.168.3.255 scope global ens7
       valid_lft forever preferred_lft forever
    inet6 fe80::80c:3cff:fe65:9c27/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
35: eniaad872f8f96@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 5e:71:1d:0d:58:76 brd ff:ff:ff:ff:ff:ff link-netns cni-83401432-a5a6-e355-338b-5b0b2be54e2f
    inet6 fe80::5c71:1dff:fe0d:5876/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
39: eni1a06225ba03@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 6e:99:bf:09:eb:4a brd ff:ff:ff:ff:ff:ff link-netns cni-76c37d54-4b57-554c-2033-1bd0903ea10a
    inet6 fe80::6c99:bfff:fe09:eb4a/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
42: eni00c25e070e3@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 5a:70:f9:2d:fb:d6 brd ff:ff:ff:ff:ff:ff link-netns cni-ea99b434-526f-c3dc-8f3c-312ea67461e7
    inet6 fe80::5870:f9ff:fe2d:fbd6/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
43: enif2b59b1644b@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 7e:a5:ca:a5:92:ae brd ff:ff:ff:ff:ff:ff link-netns cni-d32736a6-d35d-b2bf-009d-446df94aa7b8
    inet6 fe80::7ca5:caff:fea5:92ae/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
44: kube-ipvs0: <BROADCAST,NOARP> mtu 1500 qdisc noop state DOWN group default 
    link/ether 2a:28:b6:08:eb:09 brd ff:ff:ff:ff:ff:ff
    inet 10.100.0.1/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.73.70/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.101.216/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.0.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.14.77/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.145.143/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.214.208/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.110.88/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.83.10/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.146.32/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
    inet 10.100.17.159/32 scope global kube-ipvs0
       valid_lft forever preferred_lft forever
```

---

## **ğŸ—‘ï¸ (ì‹¤ìŠµ ì™„ë£Œ í›„) ìì›  ì‚­ì œ**

Amazon EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ(10ë¶„ ì •ë„ ì†Œìš”)

```bash
eksctl delete cluster --name $CLUSTER_NAME
# ê²°ê³¼
2025-02-14 02:20:39 [â„¹]  deleting EKS cluster "myeks"
2025-02-14 02:20:39 [â„¹]  will drain 0 unmanaged nodegroup(s) in cluster "myeks"
2025-02-14 02:20:39 [â„¹]  starting parallel draining, max in-flight of 1
2025-02-14 02:20:40 [â„¹]  deleted 0 Fargate profile(s)
2025-02-14 02:20:40 [âœ”]  kubeconfig has been updated
2025-02-14 02:20:40 [â„¹]  cleaning up AWS load balancers created by Kubernetes objects of Kind Service or Ingress
2025-02-14 02:22:55 [â„¹]  4 sequential tasks: { delete nodegroup "ng1", delete IAM OIDC provider, delete addon IAM "eksctl-myeks-addon-vpc-cni", delete cluster control plane "myeks" [async] }
2025-02-14 02:22:55 [â„¹]  will delete stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:22:55 [â„¹]  waiting for stack "eksctl-myeks-nodegroup-ng1" to get deleted
2025-02-14 02:22:55 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:23:26 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:23:58 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:25:36 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:27:34 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:29:08 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:30:35 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:31:32 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:33:04 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng1"
2025-02-14 02:33:05 [â„¹]  will delete stack "eksctl-myeks-addon-vpc-cni"
2025-02-14 02:33:05 [â„¹]  will delete stack "eksctl-myeks-cluster"
2025-02-14 02:33:06 [âœ”]  all cluster resources were deleted

```

```bash
aws cloudformation delete-stack --stack-name myeks
```

