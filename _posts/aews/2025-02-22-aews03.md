---
title: AEWS 3ì£¼ì°¨ ì •ë¦¬
date: 2025-02-22 23:20:00 +0900
categories: [EKS]
tags: [AEWS]
---


## **ğŸš€ ì‹¤ìŠµ í™˜ê²½ ë°°í¬**

2ê°œì˜ VPC(EKS ë°°í¬, ìš´ì˜ìš© êµ¬ë¶„), myeks-vpcì˜ public ì— EFS ì¶”ê°€


![Image](https://github.com/user-attachments/assets/c6dc5ae2-e376-4c68-acf2-59d53d18b904)

## **ğŸ—ï¸ AWS CloudFormationì„ í†µí•´ ê¸°ë³¸ ì‹¤ìŠµ í™˜ê²½ ë°°í¬**

### **1. yaml íŒŒì¼ ë‹¤ìš´ë¡œë“œ**

```bash
curl -O https://s3.ap-northeast-2.amazonaws.com/cloudformation.cloudneta.net/K8S/myeks-3week.yaml
# ê²°ê³¼
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--100 14933  100 14933    0     0   141k      0 --:--:-- --:--:-- --:--:--  140k
```

### **2. ë°°í¬**

```bash
aws cloudformation deploy --template-file ~/Downloads/myeks-3week.yaml \
   --stack-name myeks --parameter-overrides KeyName=kp-aews SgIngressSshCidr=$(curl -s ipinfo.io/ip)/32 --region ap-northeast-2

# ê²°ê³¼
Waiting for changeset to be created..
Waiting for stack create/update to complete
Successfully created/updated stack - myeks
```

### **3. ìš´ì˜ì„œë²„ EC2 ì— SSH ì ‘ì†**

```bash
ssh -i kp-aews.pem ec2-user@$(aws cloudformation describe-stacks --stack-name myeks --query 'Stacks[*].Outputs[0].OutputValue' --output text)
   ,     #_
   ~\_  ####_        Amazon Linux 2
  ~~  \_#####\
  ~~     \###|       AL2 End of Life is 2026-06-30.
  ~~       \#/ ___
   ~~       V~' '->
    ~~~         /    A newer version of Amazon Linux is available!
      ~~._.   _/
         _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.
       _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/

[root@operator-host ~]# 
```

EFSì˜ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤(ENI)ë¥¼ í†µí•´ ì„œë¸Œë„· ID ë° IPv4 ì£¼ì†Œê°€ í• ë‹¹ë¨

EFS > Network ë©”ë‰´ì—ì„œ **ì„œë¸Œë„· ID, IPv4 Address í™•ì¸ ê°€ëŠ¥** âœ…

![Image](https://github.com/user-attachments/assets/dc27ce13-2cd2-48fe-af9f-fe94831cf368)


## **ğŸ› ï¸ eksctl ì„ í†µí•´ EKS ë°°í¬**

### **1. ë³€ìˆ˜ ì„¤ì •**

- **`Cluster Name`, `VPC ID`, `Public Subnet`, `SSH Key`** ë³€ìˆ˜ë¡œ ì €ì¥

```bash
export CLUSTER_NAME=myeks

# VPC ID ê°€ì ¸ì˜¤ê¸°
export VPCID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" --query 'Vpcs[*].VpcId' --output text)
echo $VPCID
vpc-0e32b5a6653acdcd9

# Public Subnet ID ê°€ì ¸ì˜¤ê¸°
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet3=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet3" --query "Subnets[0].[SubnetId]" --output text)
echo $PubSubnet1 $PubSubnet2 $PubSubnet3
subnet-0fed28a1b3e108719 subnet-0e4fb63cb543698fe subnet-0861bd68771150000

# ìì‹ ì˜ SSH Keypair ì´ë¦„
SSHKEYNAME=kp-aews
```

### **2. EKS í´ëŸ¬ìŠ¤í„° ì„¤ì • íŒŒì¼ ìƒì„±**

- **`myeks.yaml` íŒŒì¼ ìƒì„±**

```bash
cat << EOF > myeks.yaml
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: myeks
  region: ap-northeast-2
  version: "1.31"

iam:
  withOIDC: true # enables the IAM OIDC provider as well as IRSA for the Amazon CNI plugin

  serviceAccounts: # service accounts to create in the cluster. See IAM Service Accounts
  - metadata:
      name: aws-load-balancer-controller
      namespace: kube-system
    wellKnownPolicies:
      awsLoadBalancerController: true

vpc:
  cidr: 192.168.0.0/16
  clusterEndpoints:
    privateAccess: true # if you only want to allow private access to the cluster
    publicAccess: true # if you want to allow public access to the cluster
  id: $VPCID
  subnets:
    public:
      ap-northeast-2a:
        az: ap-northeast-2a
        cidr: 192.168.1.0/24
        id: $PubSubnet1
      ap-northeast-2b:
        az: ap-northeast-2b
        cidr: 192.168.2.0/24
        id: $PubSubnet2
      ap-northeast-2c:
        az: ap-northeast-2c
        cidr: 192.168.3.0/24
        id: $PubSubnet3

addons:
  - name: vpc-cni # no version is specified so it deploys the default version
    version: latest # auto discovers the latest available
    attachPolicyARNs: # attach IAM policies to the add-on's service account
      - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
    configurationValues: |-
      enableNetworkPolicy: "true"

  - name: kube-proxy
    version: latest

  - name: coredns
    version: latest

  - name: metrics-server
    version: latest

managedNodeGroups:
- amiFamily: AmazonLinux2023
  desiredCapacity: 3
  iam:
    withAddonPolicies:
      certManager: true # Enable cert-manager
      externalDNS: true # Enable ExternalDNS
  instanceType: t3.medium
  preBootstrapCommands:
    # install additional packages
    - "dnf install nvme-cli links tree tcpdump sysstat ipvsadm ipset bind-utils htop -y"
  labels:
    alpha.eksctl.io/cluster-name: myeks
    alpha.eksctl.io/nodegroup-name: ng1
  maxPodsPerNode: 100
  maxSize: 3
  minSize: 3
  name: ng1
  ssh:
    allow: true
    publicKeyName: $SSHKEYNAME
  tags:
    alpha.eksctl.io/nodegroup-name: ng1
    alpha.eksctl.io/nodegroup-type: managed
  volumeIOPS: 3000
  volumeSize: 120
  volumeThroughput: 125
  volumeType: gp3
EOF
```

- **ì‹¤ì œ ì‘ì„±ëœ `myeks.yaml` íŒŒì¼**

```bash
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: myeks
  region: ap-northeast-2
  version: "1.31"

iam:
  withOIDC: true # enables the IAM OIDC provider as well as IRSA for the Amazon CNI plugin

  serviceAccounts: # service accounts to create in the cluster. See IAM Service Accounts
  - metadata:
      name: aws-load-balancer-controller
      namespace: kube-system
    wellKnownPolicies:
      awsLoadBalancerController: true

vpc:
  cidr: 192.168.0.0/16
  clusterEndpoints:
    privateAccess: true # if you only want to allow private access to the cluster
    publicAccess: true # if you want to allow public access to the cluster
  id: vpc-0e32b5a6653acdcd9
  subnets:
    public:
      ap-northeast-2a:
        az: ap-northeast-2a
        cidr: 192.168.1.0/24
        id: subnet-0fed28a1b3e108719
      ap-northeast-2b:
        az: ap-northeast-2b
        cidr: 192.168.2.0/24
        id: subnet-0e4fb63cb543698fe
      ap-northeast-2c:
        az: ap-northeast-2c
        cidr: 192.168.3.0/24
        id: subnet-0861bd68771150000

addons:
  - name: vpc-cni # no version is specified so it deploys the default version
    version: latest # auto discovers the latest available
    attachPolicyARNs: # attach IAM policies to the add-on's service account
      - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
    configurationValues: |-
      enableNetworkPolicy: "true"

  - name: kube-proxy
    version: latest

  - name: coredns
    version: latest

  - name: metrics-server
    version: latest

managedNodeGroups:
- amiFamily: AmazonLinux2023
  desiredCapacity: 3
  iam:
    withAddonPolicies:
      certManager: true # Enable cert-manager
      externalDNS: true # Enable ExternalDNS
  instanceType: t3.medium
  preBootstrapCommands:
    # install additional packages
    - "dnf install nvme-cli links tree tcpdump sysstat ipvsadm ipset bind-utils htop -y"
  labels:
    alpha.eksctl.io/cluster-name: myeks
    alpha.eksctl.io/nodegroup-name: ng1
  maxPodsPerNode: 100
  maxSize: 3
  minSize: 3
  name: ng1
  ssh:
    allow: true
    publicKeyName: kp-aews
  tags:
    alpha.eksctl.io/nodegroup-name: ng1
    alpha.eksctl.io/nodegroup-type: managed
  volumeIOPS: 3000
  volumeSize: 120
  volumeThroughput: 125
  volumeType: gp3
```

### **3. eks ë°°í¬**

```bash
eksctl create cluster -f myeks.yaml --verbose 4

# ê²°ê³¼
2025-02-18 11:31:47 [â–¶]  Setting credentials expiry window to 30 minutes
2025-02-18 11:31:48 [â–¶]  role ARN for the current session is "arn:aws:iam::378102432899:user/eks-user"
2025-02-18 11:31:48 [â„¹]  eksctl version 0.203.0
2025-02-18 11:31:48 [â„¹]  using region ap-northeast-2
2025-02-18 11:31:48 [âœ”]  using existing VPC (vpc-0e32b5a6653acdcd9) and subnets (private:map[] public:map[ap-northeast-2a:{subnet-0fed28a1b3e108719 ap-northeast-2a 192.168.1.0/24 0 } ap-northeast-2b:{subnet-0e4fb63cb543698fe ap-northeast-2b 192.168.2.0/24 0 } ap-northeast-2c:{subnet-0861bd68771150000 ap-northeast-2c 192.168.3.0/24 0 }])
2025-02-18 11:31:48 [!]  custom VPC/subnets will be used; if resulting cluster doesn't function as expected, make sure to review the configuration of VPC/subnets
2025-02-18 11:31:48 [â„¹]  nodegroup "ng1" will use "" [AmazonLinux2023/1.31]
2025-02-18 11:31:48 [â„¹]  using EC2 key pair "kp-aews"
2025-02-18 11:31:48 [â„¹]  using Kubernetes version 1.31
2025-02-18 11:31:48 [â„¹]  creating EKS cluster "myeks" in "ap-northeast-2" region with managed nodes
2025-02-18 11:31:48 [â–¶]  cfg.json = \
.......
```

![Image](https://github.com/user-attachments/assets/046d473e-9084-430b-9bda-519c0b24ea69)

![Image](https://github.com/user-attachments/assets/1b5f8b1d-861c-40c7-be8e-2efdf538e324)


### **4. EKS ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë° ì»¨í…ìŠ¤íŠ¸ ì„¤ì • ë³€ê²½**

- **ë„¤ì„ìŠ¤í˜ì´ìŠ¤ default ë³€ê²½ ì ìš©**

```bash
kubens default
# ê²°ê³¼
âœ” Active namespace is "default"
```

- **EKS ì»¨í…ìŠ¤íŠ¸ëª… ë³€ê²½ (eks-user â†’ eksworkshop)**

```bash
kubectl ctx
# ê²°ê³¼
Switched to context "eks-user@myeks.ap-northeast-2.eksctl.io".

kubectl config rename-context "eks-user@myeks.ap-northeast-2.eksctl.io" "eksworkshop"
# ê²°ê³¼
Context "eks-user@myeks.ap-northeast-2.eksctl.io" renamed to "eksworkshop".
```

### **5. EKS í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸**

```bash
kubectl cluster-info
```

âœ…Â **ì¶œë ¥**

```bash
Kubernetes control plane is running at https://791BC5A9BB3716EA88C45304E0696F83.gr7.ap-northeast-2.eks.amazonaws.com
CoreDNS is running at https://791BC5A9BB3716EA88C45304E0696F83.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

### **6. EKS ë…¸ë“œ ì •ë³´ ì¡°íšŒ**

- í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ìƒíƒœ, ì¸ìŠ¤í„´ìŠ¤ ìœ í˜•, ìš©ëŸ‰ ìœ í˜•(ì˜¨ë””ë§¨ë“œ), ê°€ìš© ì˜ì—­ í™•ì¸

```bash
kubectl get node --label-columns=node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   26m   v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2a
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   26m   v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2b
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   26m   v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2c
```

### **7. ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹ í™•ì¸**

```bash
eksctl get nodegroup --cluster $CLUSTER_NAME
```

âœ…Â **ì¶œë ¥**

```bash
CLUSTER	NODEGROUP	STATUS	CREATED			MIN SIZE	MAX SIZE	DESIRED CAPACITY	INSTANCE TYPE	IMAGE ID		ASG NAME					TYPE
myeks	ng1		ACTIVE	2025-02-18T02:45:19Z	3		3		3			t3.medium	AL2023_x86_64_STANDARD	eks-ng1-c8ca8b79-064a-1771-a08d-6ace8e163bd4	managed
```

```bash
aws eks describe-nodegroup --cluster-name $CLUSTER_NAME --nodegroup-name ng1 | jq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "nodegroup": {
    "nodegroupName": "ng1",
    "nodegroupArn": "arn:aws:eks:ap-northeast-2:378102432899:nodegroup/myeks/ng1/c8ca8b79-064a-1771-a08d-6ace8e163bd4",
    "clusterName": "myeks",
    "version": "1.31",
    "releaseVersion": "1.31.5-20250212",
    "createdAt": "2025-02-18T11:45:19.813000+09:00",
    "modifiedAt": "2025-02-18T12:06:04.747000+09:00",
    "status": "ACTIVE",
    "capacityType": "ON_DEMAND",
    "scalingConfig": {
      "minSize": 3,
      "maxSize": 3,
      "desiredSize": 3
    },
    "instanceTypes": [
      "t3.medium"
    ],
    "subnets": [
      "subnet-0fed28a1b3e108719",
      "subnet-0e4fb63cb543698fe",
      "subnet-0861bd68771150000"
    ],
    "amiType": "AL2023_x86_64_STANDARD",
    "nodeRole": "arn:aws:iam::378102432899:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-rGyQG9rZlOwl",
    "labels": {
      "alpha.eksctl.io/cluster-name": "myeks",
      "alpha.eksctl.io/nodegroup-name": "ng1"
    },
    "resources": {
      "autoScalingGroups": [
        {
          "name": "eks-ng1-c8ca8b79-064a-1771-a08d-6ace8e163bd4"
        }
      ]
    },
    "health": {
      "issues": []
    },
    "updateConfig": {
      "maxUnavailable": 1
    },
    "launchTemplate": {
      "name": "eksctl-myeks-nodegroup-ng1",
      "version": "1",
      "id": "lt-070d49ace29ca00a6"
    },
    "tags": {
      "aws:cloudformation:stack-name": "eksctl-myeks-nodegroup-ng1",
      "alpha.eksctl.io/cluster-name": "myeks",
      "alpha.eksctl.io/nodegroup-name": "ng1",
      "aws:cloudformation:stack-id": "arn:aws:cloudformation:ap-northeast-2:378102432899:stack/eksctl-myeks-nodegroup-ng1/55132e60-eda2-11ef-876d-06d9644ecb71",
      "eksctl.cluster.k8s.io/v1alpha1/cluster-name": "myeks",
      "aws:cloudformation:logical-id": "ManagedNodeGroup",
      "alpha.eksctl.io/nodegroup-type": "managed",
      "alpha.eksctl.io/eksctl-version": "0.203.0"
    }
  }
}
```

### **8. EKS addon ìƒíƒœ í™•ì¸**

```bash
eksctl get addon --cluster $CLUSTER_NAME
```

âœ…Â **ì¶œë ¥**

```bash
2025-02-18 12:16:16 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-18 12:16:16 [â„¹]  getting all addons
2025-02-18 12:16:18 [â„¹]  to see issues for an addon run `eksctl get addon --name <addon-name> --cluster <cluster-name>`
NAME		VERSION			STATUS	ISSUES	IAMROLE										UPDATE AVAILABLE	CONFIGURATION VALUES		POD IDENTITY ASSOCIATION ROLES
coredns		v1.11.4-eksbuild.2	ACTIVE	0													
kube-proxy	v1.31.3-eksbuild.2	ACTIVE	0													
metrics-server	v0.7.2-eksbuild.2	ACTIVE	0													
vpc-cni		v1.19.2-eksbuild.5	ACTIVE	0	arn:aws:iam::378102432899:role/eksctl-myeks-addon-vpc-cni-Role1-ZTYxtOMDwfFu			enableNetworkPolicy: "true"	
```

### **9. AWS Load Balancer Controllerìš© IAM ì„œë¹„ìŠ¤ ê³„ì • í™•ì¸**

**(1) IAM ì„œë¹„ìŠ¤ ê³„ì • í™•ì¸**

- `aws-load-balancer-controller` ì„œë¹„ìŠ¤ ê³„ì •ì´ **IAM Role**ê³¼ ì˜¬ë°”ë¥´ê²Œ ë°”ì¸ë”©ë˜ì—ˆëŠ”ì§€ í™•ì¸

```bash
eksctl get iamserviceaccount --cluster $CLUSTER_NAME
```

âœ…Â **ì¶œë ¥**

```bash
NAMESPACE	NAME				ROLE ARN
kube-system	aws-load-balancer-controller	arn:aws:iam::378102432899:role/eksctl-myeks-addon-iamserviceaccount-kube-sys-Role1-O6YEYsN7iVeQ
```

**(2) myeks.yaml íŒŒì¼ í™•ì¸**

- `certManager` ë° `externalDNS`ë¥¼ í™œì„±í™”í•˜ì—¬ **SSL ì¸ì¦ì„œ ìë™í™” ë° ì™¸ë¶€ DNS ë ˆì½”ë“œ ê´€ë¦¬ ê¸°ëŠ¥ ì¶”ê°€í–ˆìŒ**

```bash
managedNodeGroups:
- amiFamily: AmazonLinux2023
  desiredCapacity: 3
  iam:
    withAddonPolicies:
      certManager: true # Enable cert-manager
      externalDNS: true # Enable ExternalDNS
```

**(3) EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ IAM Role í™•ì¸**

- í´ëŸ¬ìŠ¤í„°ì˜ ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹(`myeks-ng1-Node`)ì— ì—°ê²°ëœ **IAM Role** í™•ì¸
- `eksctl-myeks-nodegroup-ng1-NodeInstanceRole-rGyQG9rZlOwl` ì—­í• ì´ ë¶€ì—¬ë¨

![Image](https://github.com/user-attachments/assets/d186768c-2d88-4c5c-bf63-117579cea517)


- ì´ ì—­í• ì„ í†µí•´ `externalDNS` ë° `certManager`ì˜ IAM ì •ì±…ì´ ì ìš©ë¨

![Image](https://github.com/user-attachments/assets/b34a83c7-1596-4bca-be99-b0ed84524bdd)

---

## **ğŸ–¥ï¸ ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹(EC2) ì ‘ì†**

### **1. ì¸ìŠ¤í„´ìŠ¤ ì •ë³´ í™•ì¸**

```bash
aws ec2 describe-instances --query "Reservations[*].Instances[*].{InstanceID:InstanceId, PublicIPAdd:PublicIpAddress, PrivateIPAdd:PrivateIpAddress, InstanceName:Tags[?Key=='Name']|[0].Value, Status:State.Name}" --filters Name=instance-state-name,Values=running --output table
```

âœ…Â **ì¶œë ¥**

```bash
----------------------------------------------------------------------------------------
|                                   DescribeInstances                                  |
+----------------------+-----------------+----------------+----------------+-----------+
|      InstanceID      |  InstanceName   | PrivateIPAdd   |  PublicIPAdd   |  Status   |
+----------------------+-----------------+----------------+----------------+-----------+
|  i-0484d2b724be33973 |  myeks-ng1-Node |  192.168.3.80  |  15.164.49.232 |  running  |
|  i-0b995a92db06f58d8 |  operator-host  |  172.20.1.100  |  3.35.230.35   |  running  |
|  i-093ad32d5ff5a8770 |  myeks-ng1-Node |  192.168.1.207 |  3.35.47.226   |  running  |
|  i-0a80fdc36a856f394 |  myeks-ng1-Node |  192.168.2.84  |  43.203.131.45 |  running  |
+----------------------+-----------------+----------------+----------------+-----------+
```

### **2. ê°€ìš© ì˜ì—­(AZ)ë³„ EC2 ê³µì¸ IP ì¡°íšŒ**

- **AZ1 ë°°ì¹˜ëœ EC2 ê³µì¸ IP**

```bash
aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2a" \
    --query 'Reservations[*].Instances[*].PublicIpAddress' \
    --output text

# ê²°ê³¼
3.35.47.226
```

- **AZ2 ë°°ì¹˜ëœ EC2 ê³µì¸ IP**

```bash
aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2b" \
    --query 'Reservations[*].Instances[*].PublicIpAddress' \
    --output text

# ê²°ê³¼
43.203.131.45
```

- **AZ3 ë°°ì¹˜ëœ EC2 ê³µì¸ IP**

```bash
aws ec2 describe-instances \
    --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2c" \
    --query 'Reservations[*].Instances[*].PublicIpAddress' \
    --output text

# ê²°ê³¼
15.164.49.232
```

### **3. AZë³„ EC2 ê³µì¸ IPë¥¼ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥**

- ê° ê°€ìš© ì˜ì—­(AZ)ì— ë°°ì¹˜ëœ EC2 ê³µì¸ IPë¥¼ ë³€ìˆ˜(`N1`, `N2`, `N3`)ì— ì €ì¥

```bash
export N1=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2a" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
export N2=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2b" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
export N3=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=myeks-ng1-Node" "Name=availability-zone,Values=ap-northeast-2c" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)

echo $N1, $N2, $N3
```

âœ…Â **ì¶œë ¥**

```bash
3.35.47.226, 43.203.131.45, 15.164.49.232
```

### **4. EKS ì›Œì»¤ë…¸ë“œì˜ SSH ë³´ì•ˆ ê·¸ë£¹ ìë™ ì¶”ê°€ í™•ì¸**

- `myeks.yaml`ì—ì„œ `ssh.allow: true`ë¡œ ì„¤ì •í•˜ë©´ **EKS ì›Œì»¤ë…¸ë“œ ë³´ì•ˆ ê·¸ë£¹**ì´ ìë™ ìƒì„±ë¨

```bash
  ssh:
    allow: true
    publicKeyName: kp-aews
```

- ìƒì„±ëœ ë³´ì•ˆ ê·¸ë£¹: **`sg-0edd80591095505a9 (eksctl-myeks-nodegroup-ng1-remoteAccess)`**

![Image](https://github.com/user-attachments/assets/787514f6-98b4-4013-a802-c1df0c973bd4)

- ê¸°ë³¸ì„¤ì •:  **í¬íŠ¸ 22ë²ˆ(SSH)ì´ Any(0.0.0.0/0)ë¡œ ì˜¤í”ˆ**ë¨
- **ë³´ì•ˆ ìœ„í—˜:** ë¶ˆíŠ¹ì • ë‹¤ìˆ˜ê°€ SSH ì ‘ê·¼ ê°€ëŠ¥í•˜ì—¬ ë³´ì•ˆ ì·¨ì•½ì  ë°œìƒ ê°€ëŠ¥
- **ê°œì„  ë°©ì•ˆ:** `ssh.allow: false`ë¡œ ì„¤ì •í•˜ê³ , **ì§ì ‘ ë³´ì•ˆ ê·¸ë£¹ì—ì„œ IPë¥¼ í†µì œí•˜ëŠ” ë°©ì‹ì´ ì•ˆì „**

![Image](https://github.com/user-attachments/assets/b6840204-d4df-49c7-8257-b8da0b9a1af2)


### **5. íŠ¹ì • IPì—ì„œë§Œ ì ‘ê·¼ í—ˆìš© (ë³´ì•ˆ ê°•í™”)**

- ë³´ì•ˆ ê·¸ë£¹(`remoteAccess`)ì—ì„œ **ì§‘ IPì™€ ìš´ì˜ ì„œë²„ EC2ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •**
- **ëª¨ë“  íŠ¸ë˜í”½ì„ í—ˆìš©í•˜ì§€ ì•Šê³ , íŠ¹ì • IPì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ**

**(1) `remoteAccess` í¬í•¨ëœ ë³´ì•ˆ ê·¸ë£¹ ID í™•ì¸**

```bash
aws ec2 describe-security-groups --filters "Name=group-name,Values=*remoteAccess*" | jq
export MNSGID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=*remoteAccess*" --query 'SecurityGroups[*].GroupId' --output text)
```

âœ…Â **ì¶œë ¥**

```bash
{
  "SecurityGroups": [
    {
      "GroupId": "sg-0edd80591095505a9",
      "IpPermissionsEgress": [
        {
          "IpProtocol": "-1",
          "UserIdGroupPairs": [],
          "IpRanges": [
            {
              "CidrIp": "0.0.0.0/0"
            }
          ],
          "Ipv6Ranges": [],
          "PrefixListIds": []
        }
      ],
      "Tags": [
        {
          "Key": "alpha.eksctl.io/nodegroup-type",
          "Value": "managed"
        },
        {
          "Key": "aws:cloudformation:logical-id",
          "Value": "SSH"
        },
        {
          "Key": "alpha.eksctl.io/nodegroup-name",
          "Value": "ng1"
        },
        {
          "Key": "alpha.eksctl.io/cluster-name",
          "Value": "myeks"
        },
        {
          "Key": "Name",
          "Value": "eksctl-myeks-nodegroup-ng1/SSH"
        },
        {
          "Key": "aws:cloudformation:stack-name",
          "Value": "eksctl-myeks-nodegroup-ng1"
        },
        {
          "Key": "aws:cloudformation:stack-id",
          "Value": "arn:aws:cloudformation:ap-northeast-2:378102432899:stack/eksctl-myeks-nodegroup-ng1/55132e60-eda2-11ef-876d-06d9644ecb71"
        },
        {
          "Key": "alpha.eksctl.io/eksctl-version",
          "Value": "0.203.0"
        },
        {
          "Key": "eksctl.cluster.k8s.io/v1alpha1/cluster-name",
          "Value": "myeks"
        }
      ],
      "VpcId": "vpc-0e32b5a6653acdcd9",
      "SecurityGroupArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group/sg-0edd80591095505a9",
      "OwnerId": "378102432899",
      "GroupName": "eksctl-myeks-nodegroup-ng1-remoteAccess",
      "Description": "Allow SSH access",
      "IpPermissions": [
        {
          "IpProtocol": "tcp",
          "FromPort": 22,
          "ToPort": 22,
          "UserIdGroupPairs": [],
          "IpRanges": [
            {
              "Description": "Allow SSH access to managed worker nodes in group ng1",
              "CidrIp": "0.0.0.0/0"
            }
          ],
          "Ipv6Ranges": [
            {
              "Description": "Allow SSH access to managed worker nodes in group ng1",
              "CidrIpv6": "::/0"
            }
          ],
          "PrefixListIds": []
        }
      ]
    }
  ]
}
```

**(2) ì§‘ ê³µì¸ IPë¥¼ ë³´ì•ˆ ê·¸ë£¹ Inboundì— ì¶”ê°€**

- í˜„ì¬ ì ‘ì† ì¤‘ì¸ **ì§‘ ê³µì¸ IP**ë¥¼ ë³´ì•ˆ ê·¸ë£¹(`remoteAccess`)ì˜ Inbound ë£°ì— ì¶”ê°€

```bash
aws ec2 authorize-security-group-ingress --group-id $MNSGID --protocol '-1' --cidr $(curl -s ipinfo.io/ip)/32
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-08fceda8b8811d00b",
            "GroupId": "sg-0edd80591095505a9",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "182.230.60.93/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-08fceda8b8811d00b"
        }
    ]
}
```

**(3) ìš´ì˜ ì„œë²„ ë‚´ë¶€ IPë¥¼ ë³´ì•ˆ ê·¸ë£¹ Inboundì— ì¶”ê°€**

- ìš´ì˜ ì„œë²„ ë‚´ë¶€ IP(`172.20.1.100/32`)ë„ ë³´ì•ˆ ê·¸ë£¹ì˜ Inbound ë£°ì— ì¶”ê°€

```bash
aws ec2 authorize-security-group-ingress --group-id $MNSGID --protocol '-1' --cidr 172.20.1.100/32
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-02799adf73d669efa",
            "GroupId": "sg-0edd80591095505a9",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "172.20.1.100/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-02799adf73d669efa"
        }
    ]
}
```

**(4) ì›Œì»¤ë…¸ë“œ ping í…ŒìŠ¤íŠ¸**

```bash
ping -c 2 $N1
```

âœ…Â **ì¶œë ¥**

```bash
PING 3.35.47.226 (3.35.47.226) 56(84) bytes of data.
64 bytes from 3.35.47.226: icmp_seq=1 ttl=115 time=13.7 ms
64 bytes from 3.35.47.226: icmp_seq=2 ttl=115 time=13.8 ms

--- 3.35.47.226 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 13.744/13.779/13.815/0.035 ms
```

**(5) ì›Œì»¤ë…¸ë“œ SSH ì ‘ì† í…ŒìŠ¤íŠ¸**

```bash
ssh -i kp-aews.pem -o StrictHostKeyChecking=no ec2-user@$N1 hostname
```

âœ…Â **ì¶œë ¥**

```bash
ip-192-168-1-207.ap-northeast-2.compute.internal
```

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh -o StrictHostKeyChecking=no ec2-user@$i hostname; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
ip-192-168-1-207.ap-northeast-2.compute.internal

>> node 43.203.131.45 <<
ip-192-168-2-84.ap-northeast-2.compute.internal

>> node 15.164.49.232 <<
ip-192-168-3-80.ap-northeast-2.compute.internal
```

```bash
ssh ec2-user@$N1

# ê²°ê³¼
A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 05:52:48 2025 from 52.94.123.236
[ec2-user@ip-192-168-1-207 ~]$ 
```

```bash
ssh ec2-user@$N2

# ê²°ê³¼
A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 05:52:48 2025 from 52.94.123.236
[ec2-user@ip-192-168-2-84 ~]$ 
```

```bash
ssh ec2-user@$N3

# ê²°ê³¼
A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Wed Feb 12 05:52:48 2025 from 52.94.123.236
[ec2-user@ip-192-168-3-80 ~]$ 
```

---

## ğŸ” **ë…¸ë“œ ì •ë³´ í™•ì¸**

### **1. EKS ì›Œì»¤ë…¸ë“œ ê¸°ë³¸ ì •ë³´ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i hostnamectl; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
 Static hostname: ip-192-168-1-207.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec26a612d3fd1934a5b6b39b72fa9d18
         Boot ID: 98d99077d96a424daa3ab81b196f38a0
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250203
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.127-135.201.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0

>> node 43.203.131.45 <<
 Static hostname: ip-192-168-2-84.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec2f16bc9e1f90914542402b6bd7e2db
         Boot ID: b921993e9cd54993bed4e93693d89aab
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250203
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.127-135.201.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0

>> node 15.164.49.232 <<
 Static hostname: ip-192-168-3-80.ap-northeast-2.compute.internal
       Icon name: computer-vm
         Chassis: vm ğŸ–´
      Machine ID: ec2e2414fefb5afd3b0c3ec76d9735ce
         Boot ID: 909e95d8c70f4b00a9cd6545fad4d33b
  Virtualization: amazon
Operating System: Amazon Linux 2023.6.20250203
     CPE OS Name: cpe:2.3:o:amazon:amazon_linux:2023
          Kernel: Linux 6.1.127-135.201.amzn2023.x86_64
    Architecture: x86-64
 Hardware Vendor: Amazon EC2
  Hardware Model: t3.medium
Firmware Version: 1.0
```

### **2. EKS ì›Œì»¤ë…¸ë“œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ í™•ì¸**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo ip -c addr; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:e7:74:d0:4e:63 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.1.207/24 metric 1024 brd 192.168.1.255 scope global dynamic ens5
       valid_lft 1811sec preferred_lft 1811sec
    inet6 fe80::e7:74ff:fed0:4e63/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 43.203.131.45 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 06:3b:f6:53:20:41 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.2.84/24 metric 1024 brd 192.168.2.255 scope global dynamic ens5
       valid_lft 1812sec preferred_lft 1812sec
    inet6 fe80::43b:f6ff:fe53:2041/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever

>> node 15.164.49.232 <<
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute 
       valid_lft forever preferred_lft forever
2: ens5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:2f:05:2e:be:c1 brd ff:ff:ff:ff:ff:ff
    altname enp0s5
    inet 192.168.3.80/24 metric 1024 brd 192.168.3.255 scope global dynamic ens5
       valid_lft 1805sec preferred_lft 1805sec
    inet6 fe80::82f:5ff:fe2e:bec1/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
3: eni81d769258b0@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether ae:50:23:e1:4f:0f brd ff:ff:ff:ff:ff:ff link-netns cni-fa2faa2f-0179-8831-ef6d-458723488300
    inet6 fe80::ac50:23ff:fee1:4f0f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
4: enia025c0419e6@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 4e:d3:3a:8d:e9:53 brd ff:ff:ff:ff:ff:ff link-netns cni-994c349e-66b0-685d-52c0-6358456a1ee1
    inet6 fe80::4cd3:3aff:fe8d:e953/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
5: eni181f90d8a40@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether be:89:71:d7:fc:1c brd ff:ff:ff:ff:ff:ff link-netns cni-dca67549-f5c2-daf8-b13c-c641ff9b4191
    inet6 fe80::bc89:71ff:fed7:fc1c/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
6: enifa068c4d7bd@if3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc noqueue state UP group default 
    link/ether 92:11:37:91:87:7f brd ff:ff:ff:ff:ff:ff link-netns cni-99f480e7-d3cc-12d0-c204-65a883192bdb
    inet6 fe80::9011:37ff:fe91:877f/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
7: ens6: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 0a:75:29:ce:c9:4d brd ff:ff:ff:ff:ff:ff
    altname enp0s6
    inet 192.168.3.26/24 brd 192.168.3.255 scope global ens6
       valid_lft forever preferred_lft forever
    inet6 fe80::875:29ff:fece:c94d/64 scope link proto kernel_ll 
       valid_lft forever preferred_lft forever
```

### **3. EKS ì›Œì»¤ë…¸ë“œ ìŠ¤í† ë¦¬ì§€ ì •ë³´ í™•ì¸**

- ìŠ¤í† ë¦¬ì§€ í™•ì¸ ë° ë£¨íŠ¸ ë³¼ë¥¨ í¬ê¸° ì²´í¬
- ë£¨íŠ¸ ë³¼ë¥¨ **120GB** (`nvme0n1`)
- `/boot/efi` í¬í•¨ëœ íŒŒí‹°ì…˜ êµ¬ì¡° í™•ì¸

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i lsblk; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
NAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
nvme0n1       259:0    0  120G  0 disk 
â”œâ”€nvme0n1p1   259:1    0  120G  0 part /
â”œâ”€nvme0n1p127 259:2    0    1M  0 part 
â””â”€nvme0n1p128 259:3    0   10M  0 part /boot/efi

>> node 43.203.131.45 <<
NAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
nvme0n1       259:0    0  120G  0 disk 
â”œâ”€nvme0n1p1   259:1    0  120G  0 part /
â”œâ”€nvme0n1p127 259:2    0    1M  0 part 
â””â”€nvme0n1p128 259:3    0   10M  0 part /boot/efi

>> node 15.164.49.232 <<
NAME          MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS
nvme0n1       259:0    0  120G  0 disk 
â”œâ”€nvme0n1p1   259:1    0  120G  0 part /
â”œâ”€nvme0n1p127 259:2    0    1M  0 part 
â””â”€nvme0n1p128 259:3    0   10M  0 part /boot/efi
```

### **4. EKS ì›Œì»¤ë…¸ë“œ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸**

- ë£¨íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì˜ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i df -hT /; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme0n1p1 xfs   120G  3.4G  117G   3% /

>> node 43.203.131.45 <<
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme0n1p1 xfs   120G  3.4G  117G   3% /

>> node 15.164.49.232 <<
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme0n1p1 xfs   120G  3.5G  117G   3% /
```

### **5. ê¸°ë³¸ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ í™•ì¸**

- ê¸°ë³¸ì ìœ¼ë¡œ `gp2`(AWS EBS) ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì‚¬ìš©
- `gp3`ê°€ **ì„±ëŠ¥ ë° ë¹„ìš© ì¸¡ë©´ì—ì„œ ë” ìœ ë¦¬**í•˜ë¯€ë¡œ ì´í›„ `gp3` ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•  ì˜ˆì •

```bash
kubectl get sc
```

âœ…Â **ì¶œë ¥**

```bash
NAME   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2    kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  102m
```

- ê¸°ë³¸ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤(`gp2`) ìƒì„¸ ì •ë³´ ì¡°íšŒ

```bash
kubectl describe sc gp2
```

âœ…Â **ì¶œë ¥**

```bash
Name:            gp2
IsDefaultClass:  No
Annotations:     kubectl.kubernetes.io/last-applied-configuration={"apiVersion":"storage.k8s.io/v1","kind":"StorageClass","metadata":{"annotations":{},"name":"gp2"},"parameters":{"fsType":"ext4","type":"gp2"},"provisioner":"kubernetes.io/aws-ebs","volumeBindingMode":"WaitForFirstConsumer"}

Provisioner:           kubernetes.io/aws-ebs
Parameters:            fsType=ext4,type=gp2
AllowVolumeExpansion:  <unset>
MountOptions:          <none>
ReclaimPolicy:         Delete
VolumeBindingMode:     WaitForFirstConsumer
Events:                <none>
```

### **6. í˜„ì¬ ì„¤ì¹˜ëœ CRD í™•ì¸**

- ê¸°ë³¸ CRD ëª©ë¡ ì¡°íšŒ
- **ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜ í›„ CRDê°€ ì¶”ê°€ë  ì˜ˆì •**

```bash
kubectl get crd
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                         CREATED AT
cninodes.vpcresources.k8s.aws                2025-02-18T02:37:25Z
eniconfigs.crd.k8s.amazonaws.com             2025-02-18T02:40:58Z
policyendpoints.networking.k8s.aws           2025-02-18T02:37:25Z
securitygrouppolicies.vpcresources.k8s.aws   2025-02-18T02:37:25Z
```

### **7. CSI ë…¸ë“œ í™•ì¸**

- í˜„ì¬ **CSI(Storage Interface) ë“œë¼ì´ë²„ ì—†ìŒ**
- ì´í›„ **ìŠ¤í† ë¦¬ì§€ ê´€ë ¨ ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜ ì‹œ ì¶”ê°€ë  ì˜ˆì •**

```bash
kubectl get csinodes
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                               DRIVERS   AGE
ip-192-168-1-207.ap-northeast-2.compute.internal   0         97m
ip-192-168-2-84.ap-northeast-2.compute.internal    0         97m
ip-192-168-3-80.ap-northeast-2.compute.internal    0         97m
```

### **8. EKS ë…¸ë“œë³„ ìµœëŒ€ Pod ê°œìˆ˜ í™•ì¸**

```bash
kubectl describe node | grep Capacity: -A13
```

âœ…Â **ì¶œë ¥**

```bash
Capacity:
  cpu:                2
  ephemeral-storage:  125751276Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3919536Ki
  pods:               100
Allocatable:
  cpu:                1930m
  ephemeral-storage:  114818633946
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364528Ki
  pods:               100
--
Capacity:
  cpu:                2
  ephemeral-storage:  125751276Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3919536Ki
  pods:               100
Allocatable:
  cpu:                1930m
  ephemeral-storage:  114818633946
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364528Ki
  pods:               100
--
Capacity:
  cpu:                2
  ephemeral-storage:  125751276Ki
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3919544Ki
  pods:               100
Allocatable:
  cpu:                1930m
  ephemeral-storage:  114818633946
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3364536Ki
  pods:               100
```

```bash
kubectl get nodes -o custom-columns="NAME:.metadata.name,MAXPODS:.status.capacity.pods"
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                               MAXPODS
ip-192-168-1-207.ap-northeast-2.compute.internal   100
ip-192-168-2-84.ap-northeast-2.compute.internal    100
ip-192-168-3-80.ap-northeast-2.compute.internal    100
```

### **9. Kubelet `maxPods` ê¸°ë³¸ê°’ í™•ì¸**

- `/etc/kubernetes/kubelet/config.json`

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo cat /etc/kubernetes/kubelet/config.json | grep maxPods; echo; done
```

âœ…Â **ì¶œë ¥**

```bash
>> node 3.35.47.226 <<
    "maxPods": 17,

>> node 43.203.131.45 <<
    "maxPods": 17,

>> node 15.164.49.232 <<
    "maxPods": 17,
```

### **10. ì‚¬ìš©ì ì •ì˜ Kubelet ì„¤ì • í™•ì¸**

- `/etc/kubernetes/kubelet/config.json.d/00-nodeadm.conf`
- `maxPods: 100`ì´ ì„¤ì •ëœ íŒŒì¼ í™•ì¸
- ê¸°ë³¸ ê°’(17)ì´ **ì˜¤ë²„ë¼ì´ë“œë˜ì–´ 100ìœ¼ë¡œ ì ìš©ë¨**

```bash
for i in $N1 $N2 $N3; do echo ">> node $i <<"; ssh ec2-user@$i sudo cat /etc/kubernetes/kubelet/config.json.d/00-nodeadm.conf | grep maxPods; echo; done
>> node 3.35.47.226 <<
    "maxPods": 100

>> node 43.203.131.45 <<
    "maxPods": 100

>> node 15.164.49.232 <<
    "maxPods": 100
```

---

## **ğŸ”— ìš´ì˜ì„œë²„ EC2 : eks kubeconfig ì„¤ì •, EFS ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸**

### **1. ìš´ì˜ ì„œë²„ SSH ì ‘ì†**

```bash
ssh -i kp-aews.pem ec2-user@$(aws cloudformation describe-stacks --stack-name myeks --query 'Stacks[*].Outputs[0].OutputValue' --output text)
Last login: Tue Feb 18 11:20:41 2025 from 182.230.60.93
   ,     #_
   ~\_  ####_        Amazon Linux 2
  ~~  \_#####\
  ~~     \###|       AL2 End of Life is 2026-06-30.
  ~~       \#/ ___
   ~~       V~' '->
    ~~~         /    A newer version of Amazon Linux is available!
      ~~._.   _/
         _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.
       _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/

Last login: Tue Feb 18 11:20:41 KST 2025 on pts/0
[root@operator-host ~]# 
```

### **2. AWS CLI ìê²©ì¦ëª… ì„¤ì •**

```bash
[root@operator-host ~]# aws configure
AWS Access Key ID [None]: XXXXXXXXXXXXXXXXXX
AWS Secret Access Key [None]: XXXXXXXXXXXXXXXXXX
Default region name [None]: ap-northeast-2
Default output format [None]: json
```
- **AWS Access Key ID**: (ë°œê¸‰ë°›ì€ Access Key ID ì…ë ¥)
- **AWS Secret Access Key**: (Secret Access Key ì…ë ¥)
- **Default region name**:Â `ap-northeast-2`Â (ì„œìš¸ ë¦¬ì „, ì›í•˜ëŠ” ë¦¬ì „ ì„ íƒ ê°€ëŠ¥)
- **Default output format**:Â `json`Â ë˜ëŠ”Â `yaml`Â (ê¸°ë³¸ê°’:Â `json`)


### **3. í˜„ì¬ IAM ì‚¬ìš©ì í™•ì¸**

```bash
[root@operator-host ~]# aws sts get-caller-identity --query Arn

# ê²°ê³¼
"arn:aws:iam::378102432899:user/eks-user"
```

### **4. `kubeconfig` ìƒì„± ë° EKS ì—°ê²° ì„¤ì •**

- ìš´ì˜ ì„œë²„ì—ì„œ EKS í´ëŸ¬ìŠ¤í„°ì™€ ì—°ê²°í•˜ê¸° ìœ„í•´ `kubeconfig` íŒŒì¼ì„ ìƒì„±

```bash
[root@operator-host ~]# aws eks update-kubeconfig --name myeks --user-alias eks-user
Added new context eks-user to /root/.kube/config
(eks-user:N/A) [root@operator-host ~]# 
```

- `kubectl`ì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„° ì •ë³´ í™•ì¸

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl cluster-info
```

âœ…Â **ì¶œë ¥**

```bash
Kubernetes control plane is running at https://791BC5A9BB3716EA88C45304E0696F83.gr7.ap-northeast-2.eks.amazonaws.com
CoreDNS is running at https://791BC5A9BB3716EA88C45304E0696F83.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

- ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë³€ê²½
- ê¸°ë³¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ `default`ë¡œ ì„¤ì •

```bash
(eks-user:N/A) [root@operator-host ~]# kubectl ns default
Context "eks-user" modified.
Active namespace is "default".
(eks-user:default) [root@operator-host ~]# 
```

### **5. EKS í´ëŸ¬ìŠ¤í„°ì˜ ë…¸ë“œ ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# kubectl get node -v6
```

âœ…Â **ì¶œë ¥**

```bash
I0218 13:47:55.441335    2910 loader.go:395] Config loaded from file:  /root/.kube/config
I0218 13:47:56.203890    2910 round_trippers.go:553] GET https://791BC5A9BB3716EA88C45304E0696F83.gr7.ap-northeast-2.eks.amazonaws.com/api/v1/nodes?limit=500 200 OK in 755 milliseconds
NAME                                               STATUS   ROLES    AGE    VERSION
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   121m   v1.31.5-eks-5d632ec
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   121m   v1.31.5-eks-5d632ec
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   121m   v1.31.5-eks-5d632ec
```

### **6. EFS ë§ˆìš´íŠ¸ í…ŒìŠ¤íŠ¸ ì¤€ë¹„**

- ìš´ì˜ ì„œë²„(172.20.1.100/24)ê°€ **VPC Peering**ì„ í†µí•´ EFSë¥¼ ì›ê²© ë§ˆìš´íŠ¸í•˜ì—¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© ì˜ˆì •
- í˜„ì¬ ìš´ì˜ ì„œë²„ì™€ EKS í´ëŸ¬ìŠ¤í„°ê°€ **ë‹¤ë¥¸ VPCì— ìˆìœ¼ë¯€ë¡œ**, VPC Peeringì„ í†µí•´ ìš´ì˜ ì„œë²„ì—ì„œ EFSì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•  ê²ƒ

![Image](https://github.com/user-attachments/assets/a7dccf44-06a6-4eab-9913-60d5aebb77ab)


### 7. íŒŒì¼ ì‹œìŠ¤í…œ ID í™•ì¸

- í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ **EFS íŒŒì¼ ì‹œìŠ¤í…œ ID** í™•ì¸

```bash
(eks-user:default) [root@operator-host ~]# aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text
```

âœ…Â **ì¶œë ¥**

```bash
fs-0aeb6f8c0c228b9d2
```

![Image](https://github.com/user-attachments/assets/4a04c5ae-b981-463c-8c25-33bddadc701c)


### **8. EFS ë§ˆìš´íŠ¸ ëŒ€ìƒ ì •ë³´ í™•ì¸**

- EFSì— ì—°ê²° ê°€ëŠ¥í•œ **ë§ˆìš´íŠ¸ íƒ€ê²Ÿ(Subnet ë° IP) ì¡°íšŒ**

```bash
(eks-user:default) [root@operator-host ~]# aws efs describe-mount-targets --file-system-id $(aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text) | jq
```

âœ…Â **ì¶œë ¥**

```bash
{
  "MountTargets": [
    {
      "OwnerId": "378102432899",
      "MountTargetId": "fsmt-0604d5d000fcd5bac",
      "FileSystemId": "fs-0aeb6f8c0c228b9d2",
      "SubnetId": "subnet-0e4fb63cb543698fe",
      "LifeCycleState": "available",
      "IpAddress": "192.168.2.121",
      "NetworkInterfaceId": "eni-01a6638b93a0f3c69",
      "AvailabilityZoneId": "apne2-az2",
      "AvailabilityZoneName": "ap-northeast-2b",
      "VpcId": "vpc-0e32b5a6653acdcd9"
    },
    {
      "OwnerId": "378102432899",
      "MountTargetId": "fsmt-06d0ec46b5d5eb2e7",
      "FileSystemId": "fs-0aeb6f8c0c228b9d2",
      "SubnetId": "subnet-0fed28a1b3e108719",
      "LifeCycleState": "available",
      "IpAddress": "192.168.1.145",
      "NetworkInterfaceId": "eni-081306b696d34563b",
      "AvailabilityZoneId": "apne2-az1",
      "AvailabilityZoneName": "ap-northeast-2a",
      "VpcId": "vpc-0e32b5a6653acdcd9"
    },
    {
      "OwnerId": "378102432899",
      "MountTargetId": "fsmt-079d4fd81a4d39374",
      "FileSystemId": "fs-0aeb6f8c0c228b9d2",
      "SubnetId": "subnet-0861bd68771150000",
      "LifeCycleState": "available",
      "IpAddress": "192.168.3.250",
      "NetworkInterfaceId": "eni-05a1c8ad9d2d52f44",
      "AvailabilityZoneId": "apne2-az3",
      "AvailabilityZoneName": "ap-northeast-2c",
      "VpcId": "vpc-0e32b5a6653acdcd9"
    }
  ]
}
```

### **9. ë§ˆìš´íŠ¸ ëŒ€ìƒ IPë§Œ ì¶œë ¥**

- ë§ˆìš´íŠ¸ ê°€ëŠ¥í•œ **EFS ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ IP ëª©ë¡ ì¡°íšŒ**

```bash
(eks-user:default) [root@operator-host ~]# aws efs describe-mount-targets --file-system-id $(aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text) --query "MountTargets[*].IpAddress" --output text
192.168.2.121	192.168.1.145	192.168.3.250
```

![Image](https://github.com/user-attachments/assets/a4619d15-cc10-465a-a186-61c8e7e810e0)


### **10. VPC Peering í™˜ê²½ì—ì„œ ë§ˆìš´íŠ¸ ë°©ì‹ ê²°ì •**

- **ê°™ì€ VPC ë‚´ë¶€ë¼ë©´** `fs-xxxx.efs.ap-northeast-2.amazonaws.com` í˜•ì‹ì˜ **DNS ê¸°ë°˜ ë§ˆìš´íŠ¸ ê°€ëŠ¥**
- **ë‹¤ë¥¸ VPCì—ì„œ VPC Peeringì„ í†µí•´ ì ‘ê·¼í•˜ëŠ” ê²½ìš°** â†’ **IP ê¸°ë°˜ ë§ˆìš´íŠ¸ í•„ìš”**

```bash
# DNS ì§ˆì˜ í…ŒìŠ¤íŠ¸: ê°™ì€ VPCê°€ ì•„ë‹ˆë¯€ë¡œ DNS ì§ˆì˜ ì‹¤íŒ¨
(eks-user:default) [root@operator-host ~]# dig +short $(aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text).efs.ap-northeast-2.amazonaws.com
```

### **11. EFS ë§ˆìš´íŠ¸ IP ì„ íƒ ë° í™˜ê²½ ë³€ìˆ˜ ì„¤ì •**

- ë§ˆìš´íŠ¸í•  **IP ì£¼ì†Œ(ì˜ˆ: 192.168.1.145)** ì„ íƒ í›„ í™˜ê²½ ë³€ìˆ˜ ì €ì¥

```bash
(eks-user:default) [root@operator-host ~]# EFSIP1=192.168.1.145
```

### **12. EFS ë§ˆìš´íŠ¸ ìˆ˜í–‰**

- ìš´ì˜ ì„œë²„ì—ì„œ **EFSë¥¼ ë§ˆìš´íŠ¸í•  ë””ë ‰í„°ë¦¬ ìƒì„±**
- `192.168.1.145:/mnt/myefs` ê²½ë¡œë¡œ ë§ˆìš´íŠ¸ë¨

```bash
(eks-user:default) [root@operator-host ~]# mkdir /mnt/myefs
(eks-user:default) [root@operator-host ~]# mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport $EFSIP1:/ /mnt/myefs
```

- **AWS ì½˜ì†” â†’ EFS â†’ Attach ì˜µì…˜**ì—ì„œ **ë§ˆìš´íŠ¸ ë°©ë²• ë° ëª…ë ¹ì–´ ì œê³µ**

![Image](https://github.com/user-attachments/assets/f3be2fab-0a0c-4fc0-8b67-91e6b642393b)

- `sudo mount -t nfs4 -o nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport 192.168.1.145:/ efs`

![Image](https://github.com/user-attachments/assets/ef2f670d-33d3-4905-9fc0-bee26fe489e1)


### **13. ë§ˆìš´íŠ¸ ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# findmnt -t nfs4
```

âœ…Â **ì¶œë ¥**

```bash
TARGET     SOURCE          FSTYPE OPTIONS
/mnt/myefs 192.168.1.145:/ nfs4   rw,relatime,vers=4.1,rsize=1048576,wsize=1048576,namlen=255,hard,noresvport,proto=tcp,timeo=600,retrans=2,sec=sy
```

**NFS4 íƒ€ì… íŒŒì¼ ì‹œìŠ¤í…œë§Œ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# df -hT --type nfs4
```

âœ…Â **ì¶œë ¥**

```bash
Filesystem      Type  Size  Used Avail Use% Mounted on
192.168.1.145:/ nfs4  8.0E     0  8.0E   0% /mnt/myefs
```

### **14. EFSì— íŒŒì¼ ì €ì¥ ë° NFS í†µê³„ í™•ì¸**

**(1) íŒŒì¼ ì €ì¥ ì „ NFS ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# nfsstat
```

âœ…Â **ì¶œë ¥**

```bash
Client rpc stats:
calls      retrans    authrefrsh
22         0          22      

Client nfs v4:
null         read         write        commit       open         open_conf    
1         4% 0         0% 0         0% 0         0% 0         0% 0         0% 
open_noat    open_dgrd    close        setattr      fsinfo       renew        
0         0% 0         0% 0         0% 0         0% 2         9% 0         0% 
setclntid    confirm      lock         lockt        locku        access       
0         0% 0         0% 0         0% 0         0% 0         0% 0         0% 
getattr      lookup       lookup_root  remove       rename       link         
2         9% 0         0% 1         4% 0         0% 0         0% 0         0% 
symlink      create       pathconf     statfs       readlink     readdir      
0         0% 0         0% 1         4% 1         4% 0         0% 0         0% 
server_caps  delegreturn  getacl       setacl       fs_locations rel_lkowner  
3        13% 0         0% 0         0% 0         0% 0         0% 0         0% 
secinfo      exchange_id  create_ses   destroy_ses  sequence     get_lease_t  
0         0% 0         0% 2         9% 1         4% 0         0% 6        27% 
reclaim_comp layoutget    getdevinfo   layoutcommit layoutreturn getdevlist   
0         0% 1         4% 0         0% 0         0% 0         0% 0         0% 
(null)       
1         4%
```

- ì´ ìš”ì²­(Call) ìˆ˜: `22`
- `write` ìš”ì²­ ì—†ìŒ

**(2) íŒŒì¼ ì €ì¥ ì‹¤í–‰**

- EFS ë§ˆìš´íŠ¸ ë””ë ‰í† ë¦¬(`/mnt/myefs`)ì— íŒŒì¼ ìƒì„±
- ì›ê²© NFS ì €ì¥ì†Œì— íŒŒì¼(`memo.txt`) ìƒì„±ë¨

```bash
(eks-user:default) [root@operator-host ~]# echo "EKS Workshop" > /mnt/myefs/memo.txt
```

**(3) íŒŒì¼ ì €ì¥ í›„ NFS ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# nfsstat
```

âœ…Â **ì¶œë ¥**

```bash
Client rpc stats:
calls      retrans    authrefrsh
27         0          27      

Client nfs v4:
null         read         write        commit       open         open_conf    
1         3% 0         0% 1         3% 0         0% 1         3% 0         0% 
open_noat    open_dgrd    close        setattr      fsinfo       renew        
0         0% 0         0% 1         3% 0         0% 2         7% 0         0% 
setclntid    confirm      lock         lockt        locku        access       
0         0% 0         0% 0         0% 0         0% 0         0% 1         3% 
getattr      lookup       lookup_root  remove       rename       link         
2         7% 0         0% 1         3% 0         0% 0         0% 0         0% 
symlink      create       pathconf     statfs       readlink     readdir      
0         0% 0         0% 1         3% 1         3% 0         0% 0         0% 
server_caps  delegreturn  getacl       setacl       fs_locations rel_lkowner  
3        11% 0         0% 0         0% 0         0% 0         0% 0         0% 
secinfo      exchange_id  create_ses   destroy_ses  sequence     get_lease_t  
0         0% 0         0% 2         7% 1         3% 0         0% 7        25% 
reclaim_comp layoutget    getdevinfo   layoutcommit layoutreturn getdevlist   
0         0% 1         3% 0         0% 0         0% 0         0% 0         0% 
(null)       
1         3% 
```

- ì´ ìš”ì²­(Call) ìˆ˜: `27`
- `write` ìš”ì²­ 1íšŒ ê¸°ë¡ë¨

### **15. ì €ì¥ëœ íŒŒì¼ í™•ì¸**

**(1) ì €ì¥ëœ íŒŒì¼ ëª©ë¡ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# ls -l /mnt/myefs
```

âœ…Â **ì¶œë ¥**

```bash
total 4
-rw-r--r-- 1 root root 13 Feb 18 14:09 memo.txt
```

**(2) íŒŒì¼ ë‚´ìš© í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# cat /mnt/myefs/memo.txt
```

âœ…Â **ì¶œë ¥**

```bash
EKS Workshop
```

### **16. EFS ìë™ ë§ˆìš´íŠ¸ ì„¤ì • (EC2 ì¬ë¶€íŒ… í›„ ìœ ì§€)**

**(1) í˜„ì¬ `/etc/fstab` ìƒíƒœ í™•ì¸**

- ê¸°ì¡´ ë§ˆìš´íŠ¸ ì„¤ì • í™•ì¸

```bash
(eks-user:default) [root@operator-host ~]# cat /etc/fstab
```

âœ…Â **ì¶œë ¥**

```bash
UUID=43b4f483-987f-429f-ad61-9e2993518248     /           xfs    defaults,noatime  1   1
```

**(2) `/etc/fstab` íŒŒì¼ ìˆ˜ì • (EFS ìë™ ë§ˆìš´íŠ¸ ì¶”ê°€)**

- **`fstab` íŒŒì¼ ì—´ê¸°**

```bash
sudo vim /etc/fstab
```

- **íŒŒì¼ ë§¨ ì•„ë˜ì— EFS ë§ˆìš´íŠ¸ ì •ë³´ ì¶”ê°€**

```bash
192.168.1.145:/ /mnt/myefs nfs4 defaults,_netdev,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport 0 0
```

![Image](https://github.com/user-attachments/assets/344434e5-3431-4241-a8ac-c527cc875b03)


**(3) ë³€ê²½ ì‚¬í•­ ì ìš©**

- ìˆ˜ì •í•œ `/etc/fstab` ë‚´ìš©ì„ ì¦‰ì‹œ ë°˜ì˜

```bash
(eks-user:default) [root@operator-host ~]# sudo mount -a
```

**(4) ë§ˆìš´íŠ¸ ìƒíƒœ í™•ì¸**

- ë§ˆìš´íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ì ìš©ë˜ì—ˆëŠ”ì§€ í™•ì¸

```bash
(eks-user:default) [root@operator-host ~]# df -hT
```

âœ…Â **ì¶œë ¥**

```bash
Filesystem      Type      Size  Used Avail Use% Mounted on
devtmpfs        devtmpfs  981M     0  981M   0% /dev
tmpfs           tmpfs     990M     0  990M   0% /dev/shm
tmpfs           tmpfs     990M  432K  989M   1% /run
tmpfs           tmpfs     990M     0  990M   0% /sys/fs/cgroup
/dev/xvda1      xfs        30G  3.0G   28G  10% /
tmpfs           tmpfs     198M     0  198M   0% /run/user/1000
192.168.1.145:/ nfs4      8.0E     0  8.0E   0% /mnt/myefs
```

---

## ğŸ—ï¸ **EKS ë°°í¬ í›„ ì‹¤ìŠµì„ ìœ„í•œ í¸ì˜ ì„¤ì •**

### **1. í™˜ê²½ ë³€ìˆ˜ ìë™ ì„¤ì • ë°°ê²½**

- **ì´ì „ ì‹¤ìŠµì—ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ë§¤ë²ˆ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ì•¼ í•˜ëŠ” ë¶ˆí¸í•¨**ì´ ìˆì—ˆìŒ
- ì‹ ê·œ í„°ë¯¸ë„ ì°½ì„ ì—´ ë•Œë§ˆë‹¤ **í™˜ê²½ ë³€ìˆ˜ê°€ ìœ ì§€ë˜ë„ë¡ ìë™ ì„¤ì •**

### **2. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (`~/.bashrc`ì— ì¶”ê°€)**

- **Route 53 ë„ë©”ì¸ ë° Hosted Zone ID ê°€ì ¸ì˜¤ê¸°**

```bash
MyDomain=gagajin.com
MyDnzHostedZoneId=$(aws route53 list-hosted-zones-by-name --dns-name "$MyDomain." --query "HostedZones[0].Id" --output text)
```

- **í™˜ê²½ ë³€ìˆ˜ë¥¼ `~/.bashrc`ì— ì¶”ê°€í•˜ì—¬ ìƒˆ í„°ë¯¸ë„ì—ì„œë„ ìœ ì§€**

```bash
cat << EOF >> ~/.bashrc

# eksworkshop
export CLUSTER_NAME=myeks
export VPCID=$(aws ec2 describe-vpcs --filters "Name=tag:Name,Values=$CLUSTER_NAME-VPC" --query 'Vpcs[*].VpcId' --output text)
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet3=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet3" --query "Subnets[0].[SubnetId]" --output text)
export N1=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$CLUSTER_NAME-ng1-Node" "Name=availability-zone,Values=ap-northeast-2a" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
export N2=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$CLUSTER_NAME-ng1-Node" "Name=availability-zone,Values=ap-northeast-2b" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
export N3=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=$CLUSTER_NAME-ng1-Node" "Name=availability-zone,Values=ap-northeast-2c" --query 'Reservations[*].Instances[*].PublicIpAddress' --output text)
MyDomain=gagajin.com # ê°ì ìì‹ ì˜ ë„ë©”ì¸ ì´ë¦„ ì…ë ¥
MyDnzHostedZoneId=$(aws route53 list-hosted-zones-by-name --dns-name "$MyDomain." --query "HostedZones[0].Id" --output text)
EOF
```

### **3. í™˜ê²½ ë³€ìˆ˜ ì ìš© í™•ì¸**

- **ì‹ ê·œ í„°ë¯¸ë„ì—ì„œ í™˜ê²½ ë³€ìˆ˜ í™•ì¸**

```bash
echo $CLUSTER_NAME $VPCID $PubSubnet1 $PubSubnet2 $PubSubnet3
echo $N1 $N2 $N3 $MyDomain $MyDnzHostedZoneId
```

âœ…Â **ì¶œë ¥**

```bash
myeks vpc-0e32b5a6653acdcd9 subnet-0fed28a1b3e108719 subnet-0e4fb63cb543698fe subnet-0861bd68771150000
3.35.47.226 43.203.131.45 15.164.49.232 gagajin.com /hostedzone/Z099663315X74TRCYB7J5
```

- í™˜ê²½ ë³€ìˆ˜ê°€ `~/.bashrc`ì— ì •ìƒì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸

```bash
tail -n 12 ~/.bashrc
```

âœ…Â **ì¶œë ¥**

```bash
# eksworkshop
export CLUSTER_NAME=myeks
export VPCID=vpc-0e32b5a6653acdcd9
export PubSubnet1=subnet-0fed28a1b3e108719
export PubSubnet2=subnet-0e4fb63cb543698fe
export PubSubnet3=subnet-0861bd68771150000
export N1=3.35.47.226
export N2=43.203.131.45
export N3=15.164.49.232
MyDomain=gagajin.com # ê°ì ìì‹ ì˜ ë„ë©”ì¸ ì´ë¦„ ì…ë ¥
MyDnzHostedZoneId=/hostedzone/Z099663315X74TRCYB7J5
```

### **4. ì‹¤ìŠµ í›„ í™˜ê²½ ë³€ìˆ˜ ì‚­ì œ í•„ìš”**

- **ìƒˆë¡œìš´ í„°ë¯¸ë„ ì°½ì—ì„œë„ í™˜ê²½ ë³€ìˆ˜ê°€ ìë™ ì„¤ì •ë˜ì–´ í¸ë¦¬í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥**
- **ì‹¤ìŠµì´ ëë‚˜ë©´ `~/.bashrc`ì—ì„œ í•´ë‹¹ ë‚´ìš©ì„ ì‚­ì œí•  ê²ƒ**

---

## **ğŸŒ AWS LoadBalancerController, ExternalDNS, kube-ops-view ì„¤ì¹˜**

### **1. Helm ì €ì¥ì†Œ ì¶”ê°€ ë° ì—…ë°ì´íŠ¸**

```bash
helm repo add geek-cookbook https://geek-cookbook.github.io/charts/
helm repo add eks https://aws.github.io/eks-charts
helm repo update
```

âœ…Â **ì¶œë ¥**

```bash
"geek-cookbook" already exists with the same configuration, skipping
"eks" already exists with the same configuration, skipping
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "eks" chart repository
...Successfully got an update from the "prometheus-community" chart repository
...Successfully got an update from the "geek-cookbook" chart repository
Update Complete. âˆHappy Helming!âˆ
```

### **2. kube-ops-view ì„¤ì¹˜**

```bash
helm install kube-ops-view geek-cookbook/kube-ops-view --version 1.2.2 --set service.main.type=ClusterIP  --set env.TZ="Asia/Seoul" --namespace kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME: kube-ops-view
LAST DEPLOYED: Tue Feb 18 14:43:54 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace kube-system -l "app.kubernetes.io/name=kube-ops-view,app.kubernetes.io/instance=kube-ops-view" -o jsonpath="{.items[0].metadata.name}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl port-forward $POD_NAME 8080:8080
```

### **3. AWS LoadBalancerController ë°°í¬**

```bash
helm install aws-load-balancer-controller eks/aws-load-balancer-controller -n kube-system --set clusterName=$CLUSTER_NAME \
  --set serviceAccount.create=false --set serviceAccount.name=aws-load-balancer-controller
```

âœ…Â **ì¶œë ¥**

```bash
NAME: aws-load-balancer-controller
LAST DEPLOYED: Tue Feb 18 14:46:39 2025
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
AWS Load Balancer controller installed!
```

### **4. ExternalDNS ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì¹˜**

ë„ë©”ì¸ê³¼ Route 53 Hosted Zoneì„ ì—°ë™í•˜ì—¬ ìë™ìœ¼ë¡œ DNS ë ˆì½”ë“œ ê´€ë¦¬

```bash
curl -s https://raw.githubusercontent.com/gasida/PKOS/main/aews/externaldns.yaml | MyDomain=$MyDomain MyDnzHostedZoneId=$MyDnzHostedZoneId envsubst | kubectl apply -f -
```

âœ…Â **ì¶œë ¥**

```bash
serviceaccount/external-dns created
clusterrole.rbac.authorization.k8s.io/external-dns created
clusterrolebinding.rbac.authorization.k8s.io/external-dns-viewer created
deployment.apps/external-dns created
```

### **5. HTTPS ì„¤ì •ì„ ìœ„í•œ ì¸ì¦ì„œ ë°œê¸‰ (AWS Certificate Manager)**

**(1) ë„ë©”ì¸ ì¸ì¦ì„œ ë°œê¸‰ ìš”ì²­**

**ìš”ì²­ í›„, Create records in Route 53 í´ë¦­í•˜ì—¬ CNAME ë ˆì½”ë“œ ì¶”ê°€**


![Image](https://github.com/user-attachments/assets/38c0c2c7-9f90-4e17-a4af-094f1d731555)

**Route 53ì— CNAME ë ˆì½”ë“œê°€ ìë™ìœ¼ë¡œ ì¶”ê°€ë¨**


![Image](https://github.com/user-attachments/assets/d9d4a2a1-7a96-41a7-8e02-0d9e56bb90a6)

**ì¸ì¦ì„œ ìƒíƒœê°€ "Issued"ë¡œ ë³€ê²½ë˜ë©´ ì™„ë£Œ**

![Image](https://github.com/user-attachments/assets/285a05b2-ede3-4314-9120-77571ea1ca23)


**(2) ì¸ì¦ì„œ ARN í™•ì¸**

```bash
CERT_ARN=$(aws acm list-certificates --query 'CertificateSummaryList[].CertificateArn[]' --output text)
echo $CERT_ARN
```

âœ…Â **ì¶œë ¥**

```bash
arn:aws:acm:ap-northeast-2:378102432899:certificate/f967e8ca-f0b5-471d-bbe4-bee231aeb32b
```

### **6. ALB ê¸°ë°˜ Ingress ì„¤ì • ë° kube-ops-view ë°°í¬**

**(1) Ingress ë°°í¬**

- **ALB ê·¸ë£¹ ì´ë¦„ì„ ì¶”ê°€í•˜ì—¬ ì—¬ëŸ¬ Ingressì—ì„œ ë™ì¼í•œ ALB ì‚¬ìš© ê°€ëŠ¥**
- Ingressë¥¼ ë°°í¬í•˜ì—¬ HTTPS ê¸°ë°˜ìœ¼ë¡œ ë„ë©”ì¸(`kubeopsview.$MyDomain`) ì—°ê²°

```bash
cat <<EOF | kubectl apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    alb.ingress.kubernetes.io/certificate-arn: $CERT_ARN
    alb.ingress.kubernetes.io/group.name: study
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTPS":443}, {"HTTP":80}]'
    alb.ingress.kubernetes.io/load-balancer-name: myeks-ingress-alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/ssl-redirect: "443"
    alb.ingress.kubernetes.io/success-codes: 200-399
    alb.ingress.kubernetes.io/target-type: ip
  labels:
    app.kubernetes.io/name: kubeopsview
  name: kubeopsview
  namespace: kube-system
spec:
  ingressClassName: alb
  rules:
  - host: kubeopsview.$MyDomain
    http:
      paths:
      - backend:
          service:
            name: kube-ops-view
            port:
              number: 8080
        path: /
        pathType: Prefix
EOF

# ê²°ê³¼
ingress.networking.k8s.io/kubeopsview created
```

**(2) ë°°í¬ëœ íŒŒë“œ í™•ì¸**

```bash
kubectl get pods -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                          READY   STATUS    RESTARTS   AGE
aws-load-balancer-controller-554fbd9d-vk2p8   1/1     Running   0          74m
aws-load-balancer-controller-554fbd9d-xnx6r   1/1     Running   0          74m
aws-node-rf9bf                                2/2     Running   0          4h14m
aws-node-tbbhl                                2/2     Running   0          4h14m
aws-node-xb7dt                                2/2     Running   0          4h14m
coredns-86f5954566-mskq6                      1/1     Running   0          4h20m
coredns-86f5954566-wxwqw                      1/1     Running   0          4h20m
external-dns-dc4878f5f-mvnt9                  1/1     Running   0          72m
kube-ops-view-657dbc6cd8-fgbqc                1/1     Running   0          77m
kube-proxy-6bc4m                              1/1     Running   0          4h14m
kube-proxy-qsd8t                              1/1     Running   0          4h14m
kube-proxy-rvw86                              1/1     Running   0          4h14m
metrics-server-6bf5998d9c-nt4ks               1/1     Running   0          4h20m
metrics-server-6bf5998d9c-prz6f               1/1     Running   0          4h20m
```

**(3) ì„œë¹„ìŠ¤(Service), ì—”ë“œí¬ì¸íŠ¸(Endpoints), Ingress ì •ë³´ í™•ì¸**

```bash
kubectl get ingress,svc,ep -n kube-system
```

âœ…Â **ì¶œë ¥**

```bash
NAME                                    CLASS   HOSTS                     ADDRESS                                                       PORTS   AGE
ingress.networking.k8s.io/kubeopsview   alb     kubeopsview.gagajin.com   myeks-ingress-alb-60898722.ap-northeast-2.elb.amazonaws.com   80      100s

NAME                                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE
service/aws-load-balancer-webhook-service   ClusterIP   10.100.118.159   <none>        443/TCP                  75m
service/eks-extension-metrics-api           ClusterIP   10.100.124.121   <none>        443/TCP                  4h24m
service/kube-dns                            ClusterIP   10.100.0.10      <none>        53/UDP,53/TCP,9153/TCP   4h20m
service/kube-ops-view                       ClusterIP   10.100.136.90    <none>        8080/TCP                 77m
service/metrics-server                      ClusterIP   10.100.110.47    <none>        443/TCP                  4h20m

NAME                                          ENDPOINTS                                                        AGE
endpoints/aws-load-balancer-webhook-service   192.168.1.218:9443,192.168.2.198:9443                            75m
endpoints/eks-extension-metrics-api           172.0.32.0:10443                                                 4h24m
endpoints/kube-dns                            192.168.3.104:53,192.168.3.131:53,192.168.3.104:53 + 3 more...   4h20m
endpoints/kube-ops-view                       192.168.1.204:8080                                               77m
endpoints/metrics-server                      192.168.3.152:10251,192.168.3.77:10251                           4h20m
```

**(4) kube-ops-view ì ‘ì† URL í™•ì¸**

```bash
echo -e "Kube Ops View URL = https://kubeopsview.$MyDomain/#scale=1.5"
```

âœ…Â **ì¶œë ¥**

```bash
Kube Ops View URL = https://kubeopsview.gagajin.com/#scale=1.5
```

**(5) ì ‘ì† ê²°ê³¼**

![Image](https://github.com/user-attachments/assets/f791a085-fef5-444a-b064-82274f71e8a9)

---

## **ğŸ“¦ Pod ê¸°ë³¸ ì €ì¥ì†Œë¥¼ í™œìš©í•œ ë°ì´í„° ìœ ì§€ í…ŒìŠ¤íŠ¸**

### **1. EBS ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬ ì „ ìƒíƒœ í™•ì¸**

- **EBS ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬ ì „ì—ëŠ” `kubectl describe csinodes` ëª…ë ¹ì–´ ì‹¤í–‰ ì‹œ Spec ì •ë³´ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ**
- **EBS ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬ í›„ì—ëŠ” ê° ë…¸ë“œì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŒ**

```bash
kubectl describe csinodes
```

âœ…Â **ì¶œë ¥**

```bash
Name:               ip-192-168-1-207.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:46 +0900
Spec:
Events:  <none>

Name:               ip-192-168-2-84.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:49 +0900
Spec:
Events:  <none>

Name:               ip-192-168-3-80.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:42 +0900
Spec:
Events:  <none>
```

### **2. í„°ë¯¸ë„ í™˜ê²½ ì¤€ë¹„**

- **ìš´ì˜ ì„œë²„ì™€ ë¡œì»¬ PCì—ì„œ ê°ê° í„°ë¯¸ë„ ì°½ì„ ì—´ì–´ ëª¨ë‹ˆí„°ë§**

```bash
ssh -i kp-aews.pem ec2-user@$(aws cloudformation describe-stacks --stack-name myeks --query 'Stacks[*].Outputs[0].OutputValue' --output text)
# ê²°ê³¼
Last login: Tue Feb 18 16:22:43 2025 from 182.230.60.93
   ,     #_
   ~\_  ####_        Amazon Linux 2
  ~~  \_#####\
  ~~     \###|       AL2 End of Life is 2026-06-30.
  ~~       \#/ ___
   ~~       V~' '->
    ~~~         /    A newer version of Amazon Linux is available!
      ~~._.   _/
         _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.
       _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/

Last login: Tue Feb 18 16:22:43 KST 2025 on pts/0
(eks-user:default) [root@operator-host ~]#
```

- **Pod ìƒíƒœ ì‹¤ì‹œê°„ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# kubectl get pod -w
```

### **3. Redis íŒŒë“œ ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: **Pod**
metadata:
  name: **redis**
spec:
  terminationGracePeriodSeconds: 0
  containers:
  - name: redis
    image: **redis**
EOF
```

![Image](https://github.com/user-attachments/assets/e766da6b-a327-4315-8338-ece6ad8c4e8e)


### **4. Redis Pod ë‚´ ë°ì´í„° ì €ì¥ ë° í™•ì¸**

**(1) Redis Podì˜ ê¸°ë³¸ ì‘ì—… ë””ë ‰í† ë¦¬(`/data`) í™•ì¸**

```bash
kubectl exec -it redis -- pwd
# ê²°ê³¼
/data
```

**(2) Pod ë‚´ë¶€ `data` ë””ë ‰í† ë¦¬ì— íŒŒì¼ ìƒì„±**

```bash
kubectl exec -it redis -- sh -c "echo hello > /data/hello.txt"
```

**(3) íŒŒì¼ ë‚´ìš© í™•ì¸**

```bash
kubectl exec -it redis -- cat /data/hello.txt
# ê²°ê³¼
hello
```

### **5. Pod ì¬ì‹œì‘ ë° ë°ì´í„° ìœ ì‹¤ í…ŒìŠ¤íŠ¸**

**(1) ps ì„¤ì¹˜**

```bash
kubectl exec -it redis -- sh -c "apt update && apt install procps -y"

Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8792 kB]
Get:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [13.5 kB]
Get:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [246 kB]
Fetched 9306 kB in 1s (6437 kB/s)
Reading package lists... Done
Building dependency tree... Done
....
```

**(2) Redis ì»¨í…Œì´ë„ˆ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (kill 1)**

- Pod ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸ (`redis-server`ê°€ PID 1ë¡œ ì‹¤í–‰ë¨)

```bash
kubectl exec -it redis -- ps aux
```

âœ… **ì¶œë ¥**

```bash
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
redis          1  0.2  0.2 143876 10436 ?        Ssl  07:27   0:01 redis-server 
root         227  0.0  0.1   8088  4100 pts/0    Rs+  07:34   0:00 ps aux
```

- PID 1(ë©”ì¸ í”„ë¡œì„¸ìŠ¤) ì¢…ë£Œ

```bash
kubectl exec -it redis -- kill 1
```

**(3) Pod ìƒíƒœ ë³€í™” í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# kubectl get pod -w
NAME    READY   STATUS              RESTARTS     AGE
redis   0/1     Pending             0            0s
redis   0/1     Pending             0            0s
redis   0/1     ContainerCreating   0            0s
redis   1/1     Running             0            9s
redis   0/1     Completed           0            9m2s
redis   1/1     Running             1 (3s ago)   9m4s
```

![Image](https://github.com/user-attachments/assets/9b7ab91f-6861-43ac-be84-011fefa5d8b8)

![Image](https://github.com/user-attachments/assets/015f05ab-a750-4b95-98af-63751a3434cf)


- **Podê°€ ì‚­ì œë˜ì§€ ì•Šê³  ì»¨í…Œì´ë„ˆë§Œ ì¬ì‹œì‘ë¨**
- **ì»¨í…Œì´ë„ˆì˜ Restart Count ê°’ì´ ì¦ê°€í•¨ (`RESTARTS: 1`)**

**(4) Redis Podì˜ ì¬ì‹œì‘ ì›ì¸ í™•ì¸**

```bash
k describe pod
```

âœ… **ì¶œë ¥**

```bash
Name:             redis
Namespace:        default
Priority:         0
Service Account:  default
Node:             ip-192-168-1-207.ap-northeast-2.compute.internal/192.168.1.207
Start Time:       Tue, 18 Feb 2025 16:27:11 +0900
Labels:           <none>
Annotations:      <none>
Status:           Running
IP:               192.168.1.234
IPs:
  IP:  192.168.1.234
Containers:
  redis:
    Container ID:   containerd://c76cf2a72506effed078046cd25d30bcfed857b594b228071541967ade2058c7
    Image:          redis
    Image ID:       docker.io/library/redis@sha256:93a8d83b707d0d6a1b9186edecca2e37f83722ae0e398aee4eea0ff17c2fad0e
    Port:           <none>
    Host Port:      <none>
    State:          Running
      Started:      Tue, 18 Feb 2025 16:36:14 +0900
    Last State:     Terminated
      Reason:       Completed
      Exit Code:    0
      Started:      Tue, 18 Feb 2025 16:27:19 +0900
      Finished:     Tue, 18 Feb 2025 16:36:12 +0900
    Ready:          True
    Restart Count:  1
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-dr52g (ro)
...
```

- **Redis ì»¨í…Œì´ë„ˆê°€ "Completed" ìƒíƒœë¡œ ì¢…ë£Œë¨ â†’ Kubernetesê°€ ìë™ìœ¼ë¡œ ì¬ì‹œì‘**
- **Pod ìì²´ëŠ” ìœ ì§€ë˜ì§€ë§Œ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í”„ë¡œì„¸ìŠ¤ê°€ ì¬ì‹œì‘ë¨**

**(5) Redis Pod ì¬ì‹œì‘ í›„ ë°ì´í„° ìœ ì‹¤ í™•ì¸**

- ê¸°ì¡´ì— ì €ì¥í•œ íŒŒì¼ í™•ì¸

```bash
kubectl exec -it redis -- cat /data/redis/hello.txt
```

âœ… **ì¶œë ¥**

```bash
cat: /data/redis/hello.txt: No such file or directory
command terminated with exit code 1
```

- **Podê°€ ì‚­ì œë˜ì§€ ì•Šì•˜ì§€ë§Œ, ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ìœ¼ë¡œ ì¸í•´ ë‚´ë¶€ ì €ì¥ ë°ì´í„°ê°€ ìœ ì‹¤ë¨**
- **ê¸°ë³¸ì ìœ¼ë¡œ Pod ë‚´ë¶€ì˜ íŒŒì¼ ì‹œìŠ¤í…œì€ íœ˜ë°œì„±ì´ë©°, ì¬ì‹œì‘ í›„ì—ë„ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ë ¤ë©´ ë³¼ë¥¨ ì„¤ì •ì´ í•„ìš”**

### **6. Redis Pod ì‚­ì œ**

```bash
kubectl delete pod redis

# ê²°ê³¼
pod "redis" deleted
```

---

## ğŸ—‚ï¸ **emptyDirë¥¼ í™œìš©í•œ Pod ë°ì´í„° ìœ ì§€ í…ŒìŠ¤íŠ¸**

### **1. emptyDir ë³¼ë¥¨ì„ í™œìš©í•œ Redis Pod ë°°í¬**

- Pod ë‚´ì—ì„œ `emptyDir` ë³¼ë¥¨ì„ ìƒì„± í›„ `/data/redis` ê²½ë¡œì— ë§ˆìš´íŠ¸
- Podê°€ ì¬ì‹œì‘ë˜ë”ë¼ë„ `emptyDir` ë³¼ë¥¨ì€ ìœ ì§€ë¨

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: redis
spec:
  terminationGracePeriodSeconds: 0
  containers:
  - name: redis
    image: redis
    volumeMounts:
    - name: redis-storage
      mountPath: /data/redis
  volumes:
  - name: redis-storage
    emptyDir: {}
EOF

# ê²°ê³¼
pod/redis created
```

### **2. Pod ë‚´ë¶€ ë°ì´í„° ì €ì¥ ë° í™•ì¸**

**(1) Pod ë‚´ë¶€ì—ì„œ íŒŒì¼ ìƒì„±**

```bash
kubectl exec -it redis -- sh -c "echo hello > /data/redis/hello.txt"
```

**(2) íŒŒì¼ ë‚´ìš© í™•ì¸**

```bash
kubectl exec -it redis -- cat /data/redis/hello.txt
```

âœ… **ì¶œë ¥**

```bash
hello
```

### **3. Pod ì¬ì‹œì‘ ë° ë°ì´í„° ìœ ì§€ í™•ì¸**

**(1) ps ì„¤ì¹˜**

```bash
kubectl exec -it redis -- sh -c "apt update && apt install procps -y"

Get:1 http://deb.debian.org/debian bookworm InRelease [151 kB]
Get:2 http://deb.debian.org/debian bookworm-updates InRelease [55.4 kB]
Get:3 http://deb.debian.org/debian-security bookworm-security InRelease [48.0 kB]
Get:4 http://deb.debian.org/debian bookworm/main amd64 Packages [8792 kB]
Get:5 http://deb.debian.org/debian bookworm-updates/main amd64 Packages [13.5 kB]
Get:6 http://deb.debian.org/debian-security bookworm-security/main amd64 Packages [246 kB]
Fetched 9306 kB in 2s (6071 kB/s)
Reading package lists... Done
Building dependency tree... Done
...
```

**(2) Redis ì»¨í…Œì´ë„ˆ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (kill 1)**

- **Pod ë‚´ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸**

```bash
kubectl exec -it redis -- ps aux

USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
redis          1  0.2  0.2 143876 10416 ?        Ssl  07:50   0:00 redis
root         228 33.3  0.1   8088  4000 pts/0    Rs+  07:53   0:00 ps au
```

- **Redis í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (Pod ì¬ì‹œì‘ ìœ ë„)**

```bash
kubectl exec -it redis -- kill 1
```

**(3) Pod ìƒíƒœ í™•ì¸**

```bash
kubectl get pod
```

âœ… **ì¶œë ¥**

```bash
NAME    READY   STATUS    RESTARTS      AGE
redis   1/1     Running   1 (17s ago)   4m52s
```

**(4) íŒŒì¼ ë°ì´í„° ìœ ì§€ ì—¬ë¶€ í™•ì¸**

```bash
kubectl exec -it redis -- ls -l
```

âœ… **ì¶œë ¥**

```bash
total 0
drwxrwxrwx. 2 redis root 23 Feb 18 07:51 redis
```

```bash
kubectl exec -it redis -- cat /data/redis/hello.txt
```

âœ… **ì¶œë ¥**

```bash
hello
```

- **Podê°€ ì¬ì‹œì‘ë˜ë”ë¼ë„ `emptyDir` ë³¼ë¥¨ì€ ìœ ì§€ë¨**
- **ì»¨í…Œì´ë„ˆê°€ ì¬ì‹œì‘ë˜ë”ë¼ë„ ë°ì´í„°ëŠ” ë³´ì¡´ë¨**

### **4. Pod ì‚­ì œ ë° ë°ì´í„° ìœ ì‹¤ í…ŒìŠ¤íŠ¸**

**(1) Redis Pod ì‚­ì œ**

```bash
kubectl delete pod redis
# ê²°ê³¼
pod "redis" deleted
```

```bash
k get pod
```

âœ… **ì¶œë ¥**

```bash
No resources found in default namespace.
```

**(2) ìƒˆë¡œìš´ Redis Pod ì¬ë°°í¬**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: redis
spec:
  terminationGracePeriodSeconds: 0
  containers:
  - name: redis
    image: redis
    volumeMounts:
    - name: redis-storage
      mountPath: /data/redis
  volumes:
  - name: redis-storage
    emptyDir: {}
EOF
# ê²°ê³¼
pod/redis created
```

**(3) íŒŒì¼ ë°ì´í„° í™•ì¸**

```bash
kubectl exec -it redis -- ls -l /data/redis
```

âœ… **ì¶œë ¥**

```bash
total 0
```

```bash
kubectl exec -it redis -- cat /data/redis/hello.txt
```

âœ… **ì¶œë ¥**

```bash
cat: /data/redis/hello.txt: No such file or directory
command terminated with exit code 1
```

- **Podë¥¼ ì‚­ì œí•˜ë©´ `emptyDir` ë³¼ë¥¨ë„ í•¨ê»˜ ì‚­ì œë¨**
- **ìƒˆë¡œìš´ Podê°€ ìƒì„±ë˜ë©´ ìƒˆë¡œìš´ `emptyDir` ë³¼ë¥¨ì´ ìƒì„±ë˜ë¯€ë¡œ ê¸°ì¡´ ë°ì´í„°ëŠ” ìœ ì§€ë˜ì§€ ì•ŠìŒ**

### **5. Redis Pod ì‚­ì œ**

```bash
kubectl delete pod redis
# ê²°ê³¼
pod "redis" deleted
```

---

## **ğŸ“‚ EKSì—ì„œ Local Path Provisionerë¥¼ í™œìš©í•œ ë™ì  ë³¼ë¥¨ ê´€ë¦¬**

### **1. Pod ì €ì¥ì†Œì™€ ë³¼ë¥¨ ë¼ì´í”„ì‚¬ì´í´ ê°œë…**

- **Pod ì‚­ì œ ì‹œ ë‚´ë¶€ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë¨**
- **ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ Persistent Volume(PV) ì‚¬ìš© í•„ìš”**
- **PVë¥¼ í™œìš©í•˜ì—¬ Podì˜ ë¼ì´í”„ì‚¬ì´í´ê³¼ ë°ì´í„° ì €ì¥ì†Œë¥¼ ë¶„ë¦¬í•´ ì§€ì†ì ì¸ ë°ì´í„° ìœ ì§€ ê°€ëŠ¥**
- **`hostPath`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë…¸ë“œì˜ íŠ¹ì • ë””ë ‰í† ë¦¬ì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë°©ë²• ì‹¤ìŠµ**

### **2. Local Path Provisioner ì„¤ì¹˜**

- **ë…¸ë“œì˜ íŠ¹ì • ë””ë ‰í† ë¦¬(`/opt/local-path-provisioner` ë“±)ë¥¼ ë™ì ìœ¼ë¡œ ë§ˆìš´íŠ¸í•˜ì—¬ ì €ì¥ì†Œë¡œ í™œìš©**
- **StorageClassë¥¼ ì‚¬ìš©í•´ PVC ìš”ì²­ ì‹œ ìë™ìœ¼ë¡œ PVë¥¼ ìƒì„± ë° í• ë‹¹**

```bash
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml

# ê²°ê³¼
namespace/local-path-storage created
serviceaccount/local-path-provisioner-service-account created
role.rbac.authorization.k8s.io/local-path-provisioner-role created
clusterrole.rbac.authorization.k8s.io/local-path-provisioner-role created
rolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created
clusterrolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created
deployment.apps/local-path-provisioner created
storageclass.storage.k8s.io/local-path created
configmap/local-path-config created
```

### **3. Local Path Provisioner êµ¬ì„± í™•ì¸**

```bash
kubectl get-all -n local-path-storage
```

âœ… **ì¶œë ¥**

```bash
NAME                                                               NAMESPACE           AGE
configmap/kube-root-ca.crt                                         local-path-storage  2m40s  
configmap/local-path-config                                        local-path-storage  2m40s  
pod/local-path-provisioner-84967477f-g6xvh                         local-path-storage  2m40s  
serviceaccount/default                                             local-path-storage  2m40s  
serviceaccount/local-path-provisioner-service-account              local-path-storage  2m40s  
deployment.apps/local-path-provisioner                             local-path-storage  2m40s  
replicaset.apps/local-path-provisioner-84967477f                   local-path-storage  2m40s  
rolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind  local-path-storage  2m40s  
role.rbac.authorization.k8s.io/local-path-provisioner-role         local-path-storage  2m40s  
```

```bash
kubectl get pod -n local-path-storage -owide
```

âœ… **ì¶œë ¥**

```bash
NAME                                     READY   STATUS    RESTARTS   AGE     IP             NODE                                              NOMINATED NODE   READINESS GATES
local-path-provisioner-84967477f-g6xvh   1/1     Running   0          3m14s   192.168.2.14   ip-192-168-2-84.ap-northeast-2.compute.internal   <none>           <none>
```

### **4. ConfigMap ì„¤ì • í™•ì¸**

PVê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë  ê²½ë¡œë¥¼ ì§€ì •í•˜ëŠ” ConfigMap í™•ì¸

```bash
kubectl describe cm -n local-path-storage local-path-config
```

âœ… **ì¶œë ¥ (config.json)**

```bash
config.json:
----
{
        "nodePathMap":[
        {
                "node":"DEFAULT_PATH_FOR_NON_LISTED_NODES",
                "paths":["/opt/local-path-provisioner"]
        }
        ]
}
```

- `/opt/local-path-provisioner` í•˜ìœ„ì— ë™ì  ë””ë ‰í† ë¦¬ ìƒì„± ë° ê´€ë¦¬
- PVC ìš”ì²­ ì‹œ í•´ë‹¹ ê²½ë¡œì— PVê°€ ìë™ ìƒì„±ë¨

âœ… **ì¶œë ¥ (helperPod.yaml)**

ë””ë ‰í† ë¦¬ ìƒì„± ë° ì‚­ì œë¥¼ ê´€ë¦¬í•˜ëŠ” Pod ì„¤ì •

```bash
helperPod.yaml:
----
apiVersion: v1
kind: Pod
metadata:
  name: helper-pod
spec:
  priorityClassName: system-node-critical
  tolerations:
    - key: node.kubernetes.io/disk-pressure
      operator: Exists
      effect: NoSchedule
  containers:
  - name: helper-pod
    image: busybox
    imagePullPolicy: IfNotPresent
    
setup:
----
#!/bin/sh
set -eu
mkdir -m 0777 -p "$VOL_DIR"

teardown:
----
#!/bin/sh
set -eu
rm -rf "$VOL_DIR"

BinaryData
====
```

- helperPodë¥¼ í†µí•´ ë™ì  ë””ë ‰í† ë¦¬ ìƒì„± (`setup` ìŠ¤í¬ë¦½íŠ¸)
- PV ì‚­ì œ ì‹œ í•´ë‹¹ ë””ë ‰í† ë¦¬ë„ ì œê±° (`teardown` ìŠ¤í¬ë¦½íŠ¸)

### **5. StorageClass í™•ì¸**

```bash
kubectl get sc local-path
```

âœ… **ì¶œë ¥**

```bash
NAME         PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
local-path   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  5m28s
```

### **6. PVC(Persistent Volume Claim) ìƒì„± ë° ìƒíƒœ í™•ì¸**

**(1)  PVC ìƒíƒœ ëª¨ë‹ˆí„°ë§**

```bash
(eks-user:default) [root@operator-host ~]# watch -d kubectl get pv,pvc,pod
```

âœ… **ì¶œë ¥**

```bash
Every 2.0s: kubectl get pv,pvc,pod              Tue Feb 18 17:18:32 2025

No resources found
```

**(2) PVC ìƒì„±ì„ ìœ„í•œ í™˜ê²½ í™•ì¸**

```bash
k get pod -A
```

âœ… **ì¶œë ¥**

```bash
NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE
kube-system          aws-load-balancer-controller-554fbd9d-vk2p8   1/1     Running   0          158m
kube-system          aws-load-balancer-controller-554fbd9d-xnx6r   1/1     Running   0          158m
kube-system          aws-node-rf9bf                                2/2     Running   0          5h38m
kube-system          aws-node-tbbhl                                2/2     Running   0          5h38m
kube-system          aws-node-xb7dt                                2/2     Running   0          5h38m
kube-system          coredns-86f5954566-mskq6                      1/1     Running   0          5h44m
kube-system          coredns-86f5954566-wxwqw                      1/1     Running   0          5h44m
kube-system          external-dns-dc4878f5f-mvnt9                  1/1     Running   0          156m
kube-system          kube-ops-view-657dbc6cd8-fgbqc                1/1     Running   0          161m
kube-system          kube-proxy-6bc4m                              1/1     Running   0          5h38m
kube-system          kube-proxy-qsd8t                              1/1     Running   0          5h38m
kube-system          kube-proxy-rvw86                              1/1     Running   0          5h38m
kube-system          metrics-server-6bf5998d9c-nt4ks               1/1     Running   0          5h44m
kube-system          metrics-server-6bf5998d9c-prz6f               1/1     Running   0          5h44m
local-path-storage   local-path-provisioner-84967477f-g6xvh        1/1     Running   0          16m
```

- `local-path-provisioner` Podê°€ ë°°í¬ë˜ì–´ ìˆì–´ì•¼ PVCë¥¼ ë™ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆìŒ

**(3) PVC(Persistent Volume Claim) ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: localpath-claim
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 1Gi
EOF

# ê²°ê³¼
persistentvolumeclaim/localpath-claim created
```

**(4) PVC ìƒíƒœ í™•ì¸**

- PVCê°€ Pending ìƒíƒœ
- PVCê°€ ì•„ì§ ë°”ì¸ë”©ë˜ì§€ ì•Šì•˜ìœ¼ë©°, Podê°€ ìƒì„±ë˜ë©´ ë°”ì¸ë”©ë¨

```bash
Every 2.0s: kubectl get pv,pvc,pod              Tue Feb 18 17:28:31 2025

NAME                                    STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/localpath-claim   Pending                                      local-path     <unset>                 31s
```

![Image](https://github.com/user-attachments/assets/579de882-1e09-4991-871b-1a7aa118fc44)


**(5) StorageClass í™•ì¸**

- **StorageClassì˜ `VOLUMEBINDINGMODE`ê°€ `WaitForFirstConsumer` ìƒíƒœ**
- **PVCê°€ Podì— ì˜í•´ ìš”ì²­ë  ë•Œê¹Œì§€ PVê°€ ìë™ ìƒì„±ë˜ì§€ ì•ŠìŒ**

```bash
k get sc
```

âœ… **ì¶œë ¥**

```bash
NAME         PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2          kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  5h52m
local-path   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  20m
```

**(6) PVC ìƒì„¸ ì •ë³´ í™•ì¸**

- **PVCê°€ ë°”ì¸ë”©ë˜ì§€ ì•Šì€ ì´ìœ  ë° ì´ë²¤íŠ¸ í™•ì¸**
- **Pod ìƒì„± ì „ê¹Œì§€ PVCëŠ” `WaitForFirstConsumer` ìƒíƒœ**

```bash
kubectl describe pvc
```

âœ… **ì¶œë ¥**

```bash
Name:          localpath-claim
Namespace:     default
StorageClass:  local-path
Status:        Pending
Volume:        
Labels:        <none>
Annotations:   <none>
Finalizers:    [kubernetes.io/pvc-protection]
Capacity:      
Access Modes:  
VolumeMode:    Filesystem
Used By:       <none>
Events:
  Type    Reason                Age                  From                         Message
  ----    ------                ----                 ----                         -------
  Normal  WaitForFirstConsumer  6s (x15 over 3m25s)  persistentvolume-controller  waiting for first consumer to be created before binding
```

**(7) Pod ìƒì„± ë° PVC ë°”ì¸ë”©**

- PVCë¥¼ ì‚¬ìš©í•˜ëŠ” Pod ìƒì„±
- Podì—ì„œ `localpath-claim` PVCë¥¼ `/data` ê²½ë¡œì— ë§ˆìš´íŠ¸

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo \$(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: localpath-claim
EOF

# ê²°ê³¼
pod/app created
```

- **Podê°€ ìƒì„±ë˜ë©´ PVCê°€ ìë™ìœ¼ë¡œ PVì— ë°”ì¸ë”©ë¨**


![Image](https://github.com/user-attachments/assets/836fb881-6286-4d61-b08d-5ce574ece21c)

**(8) PVC ë° PV ë°”ì¸ë”© í™•ì¸**

- **PVC ìƒíƒœê°€ `Bound`ë¡œ ë³€ê²½ë¨**
- **PVê°€ ìë™ ìƒì„±ë˜ì–´ PVCì™€ ì—°ê²°ë¨**

```bash
k get pod,pv,pvc
```

âœ… **ì¶œë ¥**

```bash
NAME      READY   STATUS    RESTARTS   AGE
pod/app   1/1     Running   0          109s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018   1Gi        RWO            Delete           Bound    default/localpath-claim   local-path     <unset>                          101s

NAME                                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/localpath-claim   Bound    pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018   1Gi        RWO            local-path     <unset>                 11m
```

**(9) PV ìƒì„¸ ì •ë³´ í™•ì¸**

- PVëŠ” íŠ¹ì • ë…¸ë“œ(`192.168.1.207`)**ì— ë°”ì¸ë”©ë¨ (**`Node Affinity` ì„¤ì •)
- ì €ì¥ì†ŒëŠ” `HostPath`ë¥¼ ì‚¬ìš©í•˜ì—¬ **ë…¸ë“œì˜ íŠ¹ì • ê²½ë¡œ(`/opt/local-path-provisioner/...`)ì— ì €ì¥ë¨**
- Podê°€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì´ë™í•˜ë©´ ê¸°ì¡´ PVë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ

```bash
kubectl describe pv
```

âœ… **ì¶œë ¥**

```bash
Name:              pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018
Labels:            <none>
Annotations:       local.path.provisioner/selected-node: ip-192-168-1-207.ap-northeast-2.compute.internal
                   pv.kubernetes.io/provisioned-by: rancher.io/local-path
Finalizers:        [kubernetes.io/pv-protection]
StorageClass:      local-path
Status:            Bound
Claim:             default/localpath-claim
Reclaim Policy:    Delete
Access Modes:      RWO
VolumeMode:        Filesystem
Capacity:          1Gi
Node Affinity:     
  Required Terms:  
    Term 0:        kubernetes.io/hostname in [ip-192-168-1-207.ap-northeast-2.compute.internal]
Message:           
Source:
    Type:          HostPath (bare host directory volume)
    Path:          /opt/local-path-provisioner/pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018_default_localpath-claim
    HostPathType:  DirectoryOrCreate
Events:            <none>
```

### **7. Pod ë‚´ ë°ì´í„° ì €ì¥ ë° ì˜ì†ì„± í…ŒìŠ¤íŠ¸**

**(1) ë°ì´í„° ì €ì¥ í™•ì¸**

- **PodëŠ” 5ì´ˆë§ˆë‹¤ `/data/out.txt`ì— íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë¡**
- **ë°ì´í„°ê°€ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë˜ëŠ”ì§€ í™•ì¸**

```bash
kubectl exec -it app -- tail -f /data/out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 08:48:00 UTC 2025
Tue Feb 18 08:48:05 UTC 2025
Tue Feb 18 08:48:10 UTC 2025
Tue Feb 18 08:48:15 UTC 2025
Tue Feb 18 08:48:20 UTC 2025
Tue Feb 18 08:48:25 UTC 2025
Tue Feb 18 08:48:30 UTC 2025
Tue Feb 18 08:48:35 UTC 2025
Tue Feb 18 08:48:40 UTC 2025
Tue Feb 18 08:48:45 UTC 2025
...
```

**(2) ë°ì´í„° ì €ì¥ ìœ„ì¹˜ í™•ì¸**

- **í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì— 3ê°œì˜ ì›Œì»¤ ë…¸ë“œ ì¡´ì¬**
- **ê° ë…¸ë“œì˜ `/opt/local-path-provisioner` ê²½ë¡œë¥¼ í™•ì¸í•˜ì—¬ ë°ì´í„° ì €ì¥ ì—¬ë¶€ í™•ì¸**

```bash
for node in $N1 $N2 $N3; do ssh ec2-user@$node tree /opt/local-path-provisioner; done
```

âœ… **ì¶œë ¥**

```bash
/opt/local-path-provisioner
â””â”€â”€ pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018_default_localpath-claim
    â””â”€â”€ out.txt

1 directory, 1 file
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
```

- Podê°€ ë°°í¬ëœ ë…¸ë“œì—ì„œë§Œ ë°ì´í„°ê°€ ì €ì¥ë¨
- ë‹¤ë¥¸ ë…¸ë“œì—ì„œëŠ” ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ

**(3) ë…¸ë“œ ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ë°ì´í„° í™•ì¸**

- **ì„œë²„ì— ì§ì ‘ ì ‘ê·¼í•˜ì—¬ `out.txt` íŒŒì¼ ë‚´ìš© í™•ì¸**
- **Pod ë‚´ì—ì„œ í™•ì¸í•˜ëŠ” ê²ƒê³¼ ë™ì¼í•œ ê²°ê³¼ í™•ì¸ ê°€ëŠ¥**

```bash
ssh ec2-user@$N1 tail -f /opt/local-path-provisioner/pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018_default_localpath-claim/out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 08:53:46 UTC 2025
Tue Feb 18 08:53:51 UTC 2025
Tue Feb 18 08:53:56 UTC 2025
Tue Feb 18 08:54:01 UTC 2025
Tue Feb 18 08:54:06 UTC 2025
Tue Feb 18 08:54:11 UTC 2025
Tue Feb 18 08:54:16 UTC 2025
Tue Feb 18 08:54:21 UTC 2025
Tue Feb 18 08:54:26 UTC 2025
...
```

### **8. Pod ì‚­ì œ í›„ ë°ì´í„° ìœ ì§€ í™•ì¸**

**(1) pod ì‚­ì œ**

- Podë¥¼ ì‚­ì œí•˜ì—¬ ë°ì´í„°ê°€ ìœ ì§€ë˜ëŠ”ì§€ í™•ì¸

```bash
kubectl delete pod app
# ê²°ê³¼
pod "app" deleted
```

**(2) pod ì‚­ì œ í›„ PVC ìƒíƒœ í™•ì¸**

```bash
kubectl get pod,pv,pvc
```

âœ… **ì¶œë ¥**

```bash
NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018   1Gi        RWO            Delete           Bound    default/localpath-claim   local-path     <unset>                          21m

NAME                                    STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/localpath-claim   Bound    pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018   1Gi        RWO            local-path     <unset>                 31m
```

- **PVCì™€ PVëŠ” ì‚­ì œë˜ì§€ ì•Šê³  ìœ ì§€ë¨**
- **Podê°€ ì—†ì–´ë„ ë°ì´í„°ëŠ” ë³´ì¡´ë¨**

**(3) ì„œë²„ì—ì„œ ë°ì´í„° ìœ ì§€ ì—¬ë¶€ í™•ì¸**

- **Podê°€ ì‚­ì œëœ í›„ì—ë„ ë°ì´í„°ê°€ ìœ ì§€ë˜ëŠ”ì§€ ì§ì ‘ í™•ì¸**
- **ê° ë…¸ë“œì˜ `/opt/local-path-provisioner` ê²½ë¡œë¥¼ í™•ì¸í•˜ì—¬ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸**

```bash
for node in $N1 $N2 $N3; do ssh ec2-user@$node tree /opt/local-path-provisioner; done
```

âœ… **ì¶œë ¥**

```bash
/opt/local-path-provisioner
â””â”€â”€ pvc-fc043ac6-1fdc-4ef1-b03b-cabf03df8018_default_localpath-claim
    â””â”€â”€ out.txt

1 directory, 1 file
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
```

- **Podê°€ ë°°í¬ëœ ë…¸ë“œ(1ë²ˆ ì„œë²„)ì— ë°ì´í„°ê°€ ìœ ì§€ë¨**
- **Podê°€ ì‚­ì œë˜ì—ˆì–´ë„ íŒŒì¼(`out.txt`)ì´ ë³´ì¡´ë¨**

**(4) Pod ì¬ë°°í¬**

- Podë¥¼ ë‹¤ì‹œ ë°°í¬í•˜ì—¬ ê¸°ì¡´ PVCì— ì—°ê²°

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo \$(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: localpath-claim
EOF

# ê²°ê³¼
pod/app created
```

**(5) ê¸°ì¡´ ë°ì´í„° ìœ ì§€ ì—¬ë¶€ í™•ì¸**

```bash
kubectl exec -it app -- tail -f /data/out.txt
Tue Feb 18 08:38:35 UTC 2025
Tue Feb 18 08:38:40 UTC 2025
Tue Feb 18 09:02:27 UTC 2025
Tue Feb 18 09:02:32 UTC 2025
Tue Feb 18 09:02:37 UTC 2025
Tue Feb 18 09:02:42 UTC 2025
Tue Feb 18 09:02:47 UTC 2025
Tue Feb 18 09:02:52 UTC 2025
Tue Feb 18 09:02:57 UTC 2025
Tue Feb 18 09:03:02 UTC 2025
Tue Feb 18 09:03:07 UTC 2025
Tue Feb 18 09:03:12 UTC 2025
...
```

- **Pod ì‚­ì œ í›„ì—ë„ ê¸°ì¡´ ë°ì´í„°(`out.txt`)ê°€ ìœ ì§€ë¨**
- **emptyDirì™€ ë‹¬ë¦¬ PVCë¥¼ ì‚¬ìš©í•˜ë©´ Podê°€ ì‚­ì œë˜ì–´ë„ ë°ì´í„°ê°€ ë³´ì¡´ë¨**

### **9. PVC ì‚­ì œ í›„ ë°ì´í„° ì™„ì „ ì‚­ì œ í™•ì¸**

**(1) PVC ì‚­ì œ**

```bash
kubectl delete pvc localpath-claim
```

âœ… **ì¶œë ¥**

```bash
persistentvolumeclaim "localpath-claim" deleted
```

**(2) PV ìƒíƒœ í™•ì¸**

```bash
kubectl get pv
```

âœ… **ì¶œë ¥**

```bash
No resources found
```

- **PVCë¥¼ ì‚­ì œí•˜ë©´ PVë„ ìë™ìœ¼ë¡œ ì‚­ì œë¨**
- **ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë¨**

**(3) ë…¸ë“œì—ì„œ ë°ì´í„° ì‚­ì œ í™•ì¸**

```bash
for node in $N1 $N2 $N3; do ssh ec2-user@$node tree /opt/local-path-provisioner; done
```

âœ… **ì¶œë ¥**

```bash
/opt/local-path-provisioner

0 directories, 0 files
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
/opt/local-path-provisioner [error opening dir]

0 directories, 0 files
```

- **PVC ì‚­ì œ ì‹œ PVë„ ì‚­ì œë˜ë©°, ì €ì¥ëœ ë°ì´í„°ë„ ì™„ì „íˆ ì œê±°ë¨**
- **PVCë¥¼ ìœ ì§€í•˜ë©´ ë°ì´í„° ë³´ì¡´, ì‚­ì œí•˜ë©´ ë°ì´í„° ì™„ì „ ì‚­ì œë¨**

---

## **ğŸ“Š ë””ìŠ¤í¬ ì„±ëŠ¥ ì¸¡ì • ë° Kubestr í™œìš©**

### **1. ë””ìŠ¤í¬ ì„±ëŠ¥ ì¸¡ì • ê°œìš”**

**(1) ë””ìŠ¤í¬ ì„±ëŠ¥ ì¸¡ì • ì‹œ ì£¼ìš” ì§€í‘œ**

- **IOPS (Input/Output Operations Per Second)**: ì´ˆë‹¹ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” I/O ì‘ì—… ìˆ˜
- **Bandwidth (Throughput)**: ì´ˆë‹¹ ë°ì´í„° ì „ì†¡ëŸ‰

**(2) í˜„ì¬ ì›Œì»¤ ë…¸ë“œì˜ ë””ìŠ¤í¬ ì •ë³´**

- ì‚¬ìš© ì¤‘ì¸ ë””ìŠ¤í¬: **AWS EBS gp3 íƒ€ì…**
- IOPS: **3000**
- Throughput: **125 MB/s**


![Image](https://github.com/user-attachments/assets/d5b970ac-dd72-449f-a466-22f6365106e0)

### **2. Kubestr ì„¤ì¹˜**

- **`Kubestr`: Kubernetesì—ì„œ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë³„ ì„±ëŠ¥ ì¸¡ì •ì„ ìœ„í•œ ë„êµ¬**
- **PVë¥¼ ìƒì„±í•˜ì—¬ íŠ¹ì •í•œ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ì˜ ì†ë„ë¥¼ ì¸¡ì • í›„ ìë™ ì‚­ì œ**

**(1) Kubestr ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜**

```bash
(eks-user:default) [root@operator-host ~]# wget https://github.com/kastenhq/kubestr/releases/download/v0.4.48/kubestr_0.4.48_Linux_amd64.tar.gz
```

âœ… **ì¶œë ¥**

```bash
--2025-02-18 18:36:53--  https://github.com/kastenhq/kubestr/releases/download/v0.4.48/kubestr_0.4.48_Linux_amd64.tar.gz
Resolving github.com (github.com)... 20.200.245.247
Connecting to github.com (github.com)|20.200.245.247|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://objects.githubusercontent.com/github-production-release-asset-2e65be/291834502/210e8359-9fb9-4740-afef-17a5b458ab0e?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=releaseassetproduction%2F20250218%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250218T093653Z&X-Amz-Expires=300&X-Amz-Signature=8fb0bacd16f3bcb0eec0ff2fc8939dd6fe2549fcea74b7edcb30e345e4bf026b&X-Amz-SignedHeaders=host&response-content-disposition=attachment%3B%20filename%3Dkubestr_0.4.48_Linux_amd64.tar.gz&response-content-type=application%2Foctet-stream [following]
--2025-02-18 18:36:53--  https://objects.githubusercontent.com/github-production-release-asset-2e65be/291834502/210e8359-9fb9-4740-afef-17a5b458ab0e?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=releaseassetproduction%2F20250218%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250218T093653Z&X-Amz-Expires=300&X-Amz-Signature=8fb0bacd16f3bcb0eec0ff2fc8939dd6fe2549fcea74b7edcb30e345e4bf026b&X-Amz-SignedHeaders=host&response-content-disposition=attachment%3B%20filename%3Dkubestr_0.4.48_Linux_amd64.tar.gz&response-content-type=application%2Foctet-stream
Resolving objects.githubusercontent.com (objects.githubusercontent.com)... 185.199.108.133, 185.199.109.133, 185.199.110.133, ...
Connecting to objects.githubusercontent.com (objects.githubusercontent.com)|185.199.108.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 14703952 (14M) [application/octet-stream]
Saving to: â€˜kubestr_0.4.48_Linux_amd64.tar.gzâ€™

100%[========================================================================================================>] 14,703,952  38.6MB/s   in 0.4s   

2025-02-18 18:36:55 (38.6 MB/s) - â€˜kubestr_0.4.48_Linux_amd64.tar.gzâ€™ saved [14703952/14703952]
```

```bash
(eks-user:default) [root@operator-host ~]# tar xvfz kubestr_0.4.48_Linux_amd64.tar.gz && mv kubestr /usr/local/bin/ && chmod +x /usr/local/bin/kubestr
```

âœ… **ì¶œë ¥**

```bash
LICENSE
README.md
kubestr
```

**(2) ì„¤ì¹˜ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# kubestr -h
```

âœ… **ì¶œë ¥**

```bash
kubestr is a tool that will scan your k8s cluster
		and validate that the storage systems in place as well as run
		performance tests.

Usage:
  kubestr [flags]
  kubestr [command]

Available Commands:
  blockmount   Checks if a storage class supports block volumes
  completion   Generate the autocompletion script for the specified shell
  csicheck     Runs the CSI snapshot restore check
  file-restore Restore file(s) from a Snapshot or PVC to it's source PVC
  fio          Runs an fio test
  help         Help about any command

Flags:
  -h, --help             help for kubestr
  -e, --outfile string   The file where test results will be written
  -o, --output string    Options(json)

Use "kubestr [command] --help" for more information about a command.
```

### **3. í´ëŸ¬ìŠ¤í„° ë‚´ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# kubestr
```

âœ… **ì¶œë ¥**

```bash
**************************************
  _  ___   _ ___ ___ ___ _____ ___
  | |/ / | | | _ ) __/ __|_   _| _ \
  | ' <| |_| | _ \ _|\__ \ | | |   /
  |_|\_\\___/|___/___|___/ |_| |_|_\

Explore your Kubernetes storage options
**************************************
Kubernetes Version Check:
  Valid kubernetes version (v1.31.5-eks-8cce635)  -  OK

RBAC Check:
  Kubernetes RBAC is enabled  -  OK

Aggregated Layer Check:
  The Kubernetes Aggregated Layer is enabled  -  OK

Available Storage Provisioners:

  kubernetes.io/aws-ebs:
    This is an in tree provisioner.

    Storage Classes:
      * gp2

    To perform a FIO test, run-
      ./kubestr fio -s <storage class>

    To perform a check for block device support, run-
      ./kubestr blockmount -s <storage class>

  rancher.io/local-path:
    Unknown driver type.

    Storage Classes:
      * local-path

    To perform a FIO test, run-
      ./kubestr fio -s <storage class>

    To perform a check for block device support, run-
      ./kubestr blockmount -s <storage class>
```

- **ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ëª©ë¡ í™•ì¸ (`gp2`, `local-path`)**
- **í•´ë‹¹ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ë¥¼ ëŒ€ìƒìœ¼ë¡œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥**

### **4.  ëª¨ë‹ˆí„°ë§ ì„¤ì •**

**(1) ìŠ¤í† ë¦¬ì§€ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**

```bash
(eks-user:default) [root@operator-host ~]# watch 'kubectl get pod -owide;echo;kubectl get pv,pvc'
```

âœ… **ì¶œë ¥**

```bash
Every 2.0s: kubectl get pod -owide;echo;kubectl get pv,pvc                                                                Tue Feb 18 18:39:29 2025

No resources found in default namespace.

No resources found
```

**(2) ë…¸ë“œë³„ ë””ìŠ¤í¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (`iostat`)**

```bash
ssh ec2-user@$N1

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Tue Feb 18 10:13:47 2025 from 182.230.60.93
[ec2-user@ip-192-168-1-207 ~]$ iostat -xmdz 1
```

```bash
ssh ec2-user@$N2

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Tue Feb 18 10:13:58 2025 from 182.230.60.93
[ec2-user@ip-192-168-2-84 ~]$ iostat -xmdz 1
```

```bash
ssh ec2-user@$N3

A newer release of "Amazon Linux" is available.
  Version 2023.6.20250211:
Run "/usr/bin/dnf check-release-update" for full release and version update info
   ,     #_
   ~\_  ####_        Amazon Linux 2023
  ~~  \_#####\
  ~~     \###|
  ~~       \#/ ___   https://aws.amazon.com/linux/amazon-linux-2023
   ~~       V~' '->
    ~~~         /
      ~~._.   _/
         _/ _/
       _/m/'
Last login: Tue Feb 18 10:14:06 2025 from 182.230.60.93
[ec2-user@ip-192-168-3-80 ~]$ iostat -xmdz 1
```

![Image](https://github.com/user-attachments/assets/20614297-8fc2-4d6b-abb8-659fd44817cd)

- 1ì´ˆ ë‹¨ìœ„ë¡œ ë””ìŠ¤í¬ ë¶€í•˜ ëª¨ë‹ˆí„°ë§ (`nvme0n1`)

### **5. Kubestrë¥¼ í™œìš©í•œ ë””ìŠ¤í¬ ì„±ëŠ¥ ì¸¡ì •**

**ëœë¤ì½ê¸° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**

**(1) FIO í…ŒìŠ¤íŠ¸ ì„¤ì • íŒŒì¼ ìƒì„±**

```bash
(eks-user:default) [root@operator-host ~]# cat << EOF > fio-read.fio
> [global]
> ioengine=libaio
> direct=1
> bs=4k
> runtime=120
> time_based=1
> iodepth=16
> numjobs=4
> group_reporting
> size=1g
> rw=randread
> [read]
> EOF
```

**(2) Kubestrë¥¼ ì´ìš©í•œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰**

```bash
(eks-user:default) [root@operator-host ~]# kubestr fio -f fio-read.fio -s local-path --size 10G
```

âœ… **ì¶œë ¥**

```bash
PVC created kubestr-fio-pvc-lsl6j
Pod created kubestr-fio-pod-xdnwx
Running FIO test (fio-read.fio) on StorageClass (local-path) with a PVC of Size (10G)
```

- PV, PVC, Podë¥¼ ìƒì„± í›„ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤(`local-path`)ì˜ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì§„í–‰


![Image](https://github.com/user-attachments/assets/ef20a2d3-ccd0-432a-82b5-9a1afbdb527d)

![Image](https://github.com/user-attachments/assets/8cbbf677-9053-4db0-9c93-cf4be41de8f8)

- í…ŒìŠ¤íŠ¸ê°€ **192.168.1.207 ë…¸ë“œì—ì„œ ì‹¤í–‰ë¨**

![Image](https://github.com/user-attachments/assets/88dc6565-f94f-4718-94e6-4a3f87a039ea)


**(3) ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ (IOPS ë° Bandwidth)**

âœ… **ì¶œë ¥**

```bash
FIO test results:
  
FIO version - fio-3.36
Global options - ioengine=libaio verify= direct=1 gtod_reduce=

JobName: 
  blocksize= filesize= iodepth= rw=
read:
  IOPS=3023.845947 BW(KiB/s)=12095
  iops: min=2220 max=9001 avg=3025.832520
  bw(KiB/s): min=8880 max=36007 avg=12103.798828

Disk stats (read/write):
  nvme0n1: ios=362379/201 merge=0/30 ticks=6373605/3593 in_queue=6377198, util=95.415291%
  -  OK
```

- **IOPS (ì´ˆë‹¹ ì…ì¶œë ¥ ì‘ì—… ìˆ˜)** : **í‰ê·  3024 (ìµœì†Œ 2220, ìµœëŒ€ 9001)**
- **Bandwidth (Throughput)** : **ì•½ 11.8 MB/s (ìµœì†Œ 8.7 MB/s, ìµœëŒ€ 35.2 MB/s)**
- **AWS EBS `gp3`ì˜ ê¸°ë³¸ ì„±ëŠ¥(3000 IOPS, 125 MB/s)ê³¼ ìœ ì‚¬**
- **ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ** : **95.4% í™œìš©ë¨**

**ëœë¤ì“°ê¸° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸**

**(1) ëœë¤ ì“°ê¸° í…ŒìŠ¤íŠ¸ ì„¤ì •**

```bash
(eks-user:default) [root@operator-host ~]# cat << EOF > fio-write.fio
> [global]
> ioengine=libaio
> numjobs=16
> iodepth=16
> direct=1
> bs=4k
> runtime=120
> time_based=1
> size=1g
> group_reporting
> rw=randrw
> rwmixread=0
> rwmixwrite=100
> [write]
> EOF
```

**(2) ëœë¤ ì“°ê¸° ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì‹¤í–‰**

- StorageClass `local-path`ë¥¼ ì‚¬ìš©í•˜ì—¬ 20GB PVC ìƒì„± í›„ í…ŒìŠ¤íŠ¸ ì§„í–‰

```bash
(eks-user:default) [root@operator-host ~]# kubestr fio -f fio-write.fio -s local-path --size 20G
```

âœ… **ì¶œë ¥**

```bash
PVC created kubestr-fio-pvc-ntvm4
Pod created kubestr-fio-pod-lhstx
```

- í…ŒìŠ¤íŠ¸ê°€ **192.168.1.207 ë…¸ë“œì—ì„œ ì‹¤í–‰ë¨**


![Image](https://github.com/user-attachments/assets/5992d68b-aefc-475d-b4d3-1008fe4c96be)

![Image](https://github.com/user-attachments/assets/ce0905ae-a503-407f-b354-b4a4abc6e8a2)


**(3) ì„±ëŠ¥ ì¸¡ì • ê²°ê³¼ (IOPS ë° Bandwidth)**

âœ… **ì¶œë ¥**

```bash
Running FIO test (fio-write.fio) on StorageClass (local-path) with a PVC of Size (20G)
Elapsed time- 4m10.953340777s
FIO test results:
  
FIO version - fio-3.36
Global options - ioengine=libaio verify= direct=1 gtod_reduce=

JobName: 
  blocksize= filesize= iodepth= rw=
write:
  IOPS=3024.511475 BW(KiB/s)=12098
  iops: min=1456 max=8625 avg=3024.983154
  bw(KiB/s): min=5824 max=34517 avg=12101.912109

Disk stats (read/write):
  nvme0n1: ios=0/362366 merge=0/8 ticks=0/7063240 in_queue=7063240, util=94.799950%
  -  OK
```

- **IOPS: í‰ê·  3024.98, ìµœì†Œ 1456, ìµœëŒ€ 8625**
- **Bandwidth: í‰ê·  12,101 KiB/s, ìµœì†Œ 5824 KiB/s, ìµœëŒ€ 34,517 KiB/s**
- **ë””ìŠ¤í¬ í™œìš©ë¥  94.8%**

---

## **ğŸ’¾ EBS CSI ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì • ë° êµ¬ì„±**

### **1. EBS CSI ì»¨íŠ¸ë¡¤ëŸ¬ ê°œìš”**

- **HostPath ë³¼ë¥¨ì˜ í•œê³„**: ë…¸ë“œì˜ ë””ìŠ¤í¬ê°€ ê½‰ ì°¨ë©´ ì‚¬ìš© ë¶ˆê°€
- **AWS EBSì˜ ì¥ì **: ë¸”ë¡ ìŠ¤í† ë¦¬ì§€ ì œê³µ, Podì—ì„œ ì‰½ê²Œ ë³¼ë¥¨ì„ ìƒì„± ë° ë¶€ì°© ê°€ëŠ¥
- **EBS CSI ì»¨íŠ¸ë¡¤ëŸ¬ ì—­í• **
    - EBS ë³¼ë¥¨ì„ ìƒì„±í•˜ê³  Podì— Attach
    - Kubernetes API ì„œë²„ë¥¼ í†µí•´ ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” **CSI ì»¨íŠ¸ë¡¤ëŸ¬** ì—­í•  ìˆ˜í–‰

### **2. EBS CSI ë“œë¼ì´ë²„ ë²„ì „ í™•ì¸**

- **EKSì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ EBS CSI ë“œë¼ì´ë²„ ë²„ì „ ì¡°íšŒ**

```bash
(eks-user:default) [root@operator-host ~]# aws eks describe-addon-versions \
>     --addon-name aws-ebs-csi-driver \
>     --kubernetes-version 1.31 \
>     --query "addons[].addonVersions[].[addonVersion, compatibilities[].defaultVersion]" \
>     --output text
```

âœ… **ì¶œë ¥**

```bash
v1.39.0-eksbuild.1
True
v1.38.1-eksbuild.2
False
v1.38.1-eksbuild.1
False
v1.37.0-eksbuild.2
False
v1.37.0-eksbuild.1
False
...
```

### **3. IAM Role for Service Account (IRSA) ìƒì„±**

- EBS CSI ë“œë¼ì´ë²„ê°€ AWS EBSì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ IAM ì—­í•  ìƒì„±
- AWS EKS í´ëŸ¬ìŠ¤í„°ì— IAM ServiceAccount ì¶”ê°€

```bash
eksctl create iamserviceaccount \
  --name ebs-csi-controller-sa \
  --namespace kube-system \
  --cluster ${CLUSTER_NAME} \
  --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy \
  --approve \
  --role-only \
  --role-name AmazonEKS_EBS_CSI_DriverRole
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 20:00:11 [â„¹]  1 existing iamserviceaccount(s) (kube-system/aws-load-balancer-controller) will be excluded
2025-02-18 20:00:11 [â„¹]  1 iamserviceaccount (kube-system/ebs-csi-controller-sa) was included (based on the include/exclude rules)
2025-02-18 20:00:11 [!]  serviceaccounts in Kubernetes will not be created or modified, since the option --role-only is used
2025-02-18 20:00:11 [â„¹]  1 task: { create IAM role for serviceaccount "kube-system/ebs-csi-controller-sa" }
2025-02-18 20:00:11 [â„¹]  building iamserviceaccount stack "eksctl-myeks-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2025-02-18 20:00:11 [â„¹]  deploying stack "eksctl-myeks-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2025-02-18 20:00:11 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
2025-02-18 20:00:42 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-addon-iamserviceaccount-kube-system-ebs-csi-controller-sa"
```

- CloudFormationì— ìƒˆë¡œìš´ Stackì´ ìƒì„±ë¨

![Image](https://github.com/user-attachments/assets/5056118f-bf72-47d1-98c6-50cce70f1ad6)

- **ISRA í™•ì¸**

```bash
eksctl get iamserviceaccount --cluster ${CLUSTER_NAME}
```

âœ… **ì¶œë ¥**

```bash
NAMESPACE	NAME				ROLE ARN
kube-system	aws-load-balancer-controller	arn:aws:iam::378102432899:role/eksctl-myeks-addon-iamserviceaccount-kube-sys-Role1-O6YEYsN7iVeQ
kube-system	ebs-csi-controller-sa		arn:aws:iam::378102432899:role/AmazonEKS_EBS_CSI_DriverRole
```

### **4. Amazon EBS CSI ë“œë¼ì´ë²„ ë°°í¬**

**(1) EBS CSI ë“œë¼ì´ë²„ Add-on ì„¤ì¹˜**

```bash
export ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
eksctl create addon --name aws-ebs-csi-driver --cluster ${CLUSTER_NAME} --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKS_EBS_CSI_DriverRole --force
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 20:05:22 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-18 20:05:23 [â„¹]  IRSA is set for "aws-ebs-csi-driver" addon; will use this to configure IAM permissions
2025-02-18 20:05:23 [!]  the recommended way to provide IAM permissions for "aws-ebs-csi-driver" addon is via pod identity associations; after addon creation is completed, run `eksctl utils migrate-to-pod-identity`
2025-02-18 20:05:23 [â„¹]  using provided ServiceAccountRoleARN "arn:aws:iam::378102432899:role/AmazonEKS_EBS_CSI_DriverRole"
2025-02-18 20:05:23 [â„¹]  creating addon
```

**(2) ì„¤ì¹˜ëœ Add-on í™•ì¸**

```bash
eksctl get addon --cluster ${CLUSTER_NAME}
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 20:09:13 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-18 20:09:13 [â„¹]  getting all addons
2025-02-18 20:09:15 [â„¹]  to see issues for an addon run `eksctl get addon --name <addon-name> --cluster <cluster-name>`
NAME			VERSION			STATUS	ISSUES	IAMROLE										UPDATE AVAILABLE	CONFIGURATION VALUES		POD IDENTITY ASSOCIATION ROLES
aws-ebs-csi-driver	v1.39.0-eksbuild.1	ACTIVE	0	arn:aws:iam::378102432899:role/AmazonEKS_EBS_CSI_DriverRole				
coredns			v1.11.4-eksbuild.2	ACTIVE	0												
kube-proxy		v1.31.3-eksbuild.2	ACTIVE	0												
metrics-server		v0.7.2-eksbuild.2	ACTIVE	0												
vpc-cni			v1.19.2-eksbuild.5	ACTIVE	0	arn:aws:iam::378102432899:role/eksctl-myeks-addon-vpc-cni-Role1-ZTYxtOMDwfFu		enableNetworkPolicy: "true"	
```

### **5. EBS CSI ì»¨íŠ¸ë¡¤ëŸ¬ ë° DaemonSet í™•ì¸**

```bash
kubectl get deploy,ds -l=app.kubernetes.io/name=aws-ebs-csi-driver -n kube-system
```

âœ… **ì¶œë ¥**

```bash
NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ebs-csi-controller   2/2     2            2           5m36s

NAME                                  DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR              AGE
daemonset.apps/ebs-csi-node           3         3         3       3            3           kubernetes.io/os=linux     5m36s
daemonset.apps/ebs-csi-node-windows   0         0         0       0            0           kubernetes.io/os=windows   5m36s
```

- **Pod ëª©ë¡ í™•ì¸**

```bash
kubectl get pod -n kube-system -l app=ebs-csi-controller -o jsonpath='{.items[0].spec.containers[*].name}' ; echo
```

âœ… **ì¶œë ¥**

```bash
ebs-plugin csi-provisioner csi-attacher csi-snapshotter csi-resizer liveness-probe
```

- **ì „ì²´ Pod ëª©ë¡ í™•ì¸**

```bash
k get pod -A
```

âœ… **ì¶œë ¥**

```bash
NAMESPACE            NAME                                          READY   STATUS    RESTARTS   AGE
kube-system          aws-load-balancer-controller-554fbd9d-vk2p8   1/1     Running   0          5h26m
kube-system          aws-load-balancer-controller-554fbd9d-xnx6r   1/1     Running   0          5h26m
kube-system          aws-node-rf9bf                                2/2     Running   0          8h
kube-system          aws-node-tbbhl                                2/2     Running   0          8h
kube-system          aws-node-xb7dt                                2/2     Running   0          8h
kube-system          coredns-86f5954566-mskq6                      1/1     Running   0          8h
kube-system          coredns-86f5954566-wxwqw                      1/1     Running   0          8h
kube-system          ebs-csi-controller-7f8f8cb84-fd2bm            6/6     Running   0          7m35s
kube-system          ebs-csi-controller-7f8f8cb84-tsvk8            6/6     Running   0          7m35s
kube-system          ebs-csi-node-8d77m                            3/3     Running   0          7m35s
kube-system          ebs-csi-node-b2qcp                            3/3     Running   0          7m35s
kube-system          ebs-csi-node-rkk64                            3/3     Running   0          7m35s
kube-system          external-dns-dc4878f5f-mvnt9                  1/1     Running   0          5h24m
kube-system          kube-ops-view-657dbc6cd8-fgbqc                1/1     Running   0          5h29m
kube-system          kube-proxy-6bc4m                              1/1     Running   0          8h
kube-system          kube-proxy-qsd8t                              1/1     Running   0          8h
kube-system          kube-proxy-rvw86                              1/1     Running   0          8h
kube-system          metrics-server-6bf5998d9c-nt4ks               1/1     Running   0          8h
kube-system          metrics-server-6bf5998d9c-prz6f               1/1     Running   0          8h
local-path-storage   local-path-provisioner-84967477f-g6xvh        1/1     Running   0          3h3m
```

### **6. CSI Node ë° Driver í™•ì¸**

**(1) CSI ê´€ë ¨ ë¦¬ì†ŒìŠ¤ í™•ì¸**

```bash
kubectl api-resources | grep -i csi
```

âœ… **ì¶œë ¥**

```bash
csidrivers                                       storage.k8s.io/v1                 false        CSIDriver
csinodes                                         storage.k8s.io/v1                 false        CSINode
csistoragecapacities                             storage.k8s.io/v1                 true         CSIStorageCapacity
```

**(2) CSI ë…¸ë“œ ìƒíƒœ í™•ì¸**

```bash
kubectl get csinodes
```

âœ… **ì¶œë ¥**

```bash
NAME                                               DRIVERS   AGE
ip-192-168-1-207.ap-northeast-2.compute.internal   1         8h
ip-192-168-2-84.ap-northeast-2.compute.internal    1         8h
ip-192-168-3-80.ap-northeast-2.compute.internal    1         8h
```

- ê° ë…¸ë“œì— `ebs.csi.aws.com` ë“œë¼ì´ë²„ê°€ ì„¤ì¹˜ë¨

**(3) CSI Node ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
kubectl describe csinodes
```

âœ… **ì¶œë ¥**

```bash
Name:               ip-192-168-1-207.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:46 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-093ad32d5ff5a8770
      Allocatables:
        Count:        25
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>

Name:               ip-192-168-2-84.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:49 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-0a80fdc36a856f394
      Allocatables:
        Count:        25
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>

Name:               ip-192-168-3-80.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:42 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-0484d2b724be33973
      Allocatables:
        Count:        25
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>
```

- ê° ë…¸ë“œì—ì„œ ìµœëŒ€ 25ê°œì˜ EBS ë³¼ë¥¨ì„ ë¶€ì°© ê°€ëŠ¥

**(4) CSI ë“œë¼ì´ë²„ ëª©ë¡ ì¡°íšŒ**

```bash
kubectl get csidrivers
```

âœ… **ì¶œë ¥**

```bash
NAME              ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE
ebs.csi.aws.com   true             false            false             <unset>         false               Persistent   12m
efs.csi.aws.com   false            false            false             <unset>         false               Persistent   8h
```

- EBS CSI ë“œë¼ì´ë²„(`ebs.csi.aws.com`)ê°€ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë¨

**(5) CSI ë“œë¼ì´ë²„ ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
kubectl describe csidrivers ebs.csi.aws.com
```

âœ… **ì¶œë ¥**

```bash
Name:         ebs.csi.aws.com
Namespace:    
Labels:       app.kubernetes.io/component=csi-driver
              app.kubernetes.io/managed-by=EKS
              app.kubernetes.io/name=aws-ebs-csi-driver
              app.kubernetes.io/version=1.39.0
Annotations:  <none>
API Version:  storage.k8s.io/v1
Kind:         CSIDriver
Metadata:
  Creation Timestamp:  2025-02-18T11:05:31Z
  Resource Version:    112312
  UID:                 4db549f5-c7ef-42b5-8dbc-7611b898b6fc
Spec:
  Attach Required:     true
  Fs Group Policy:     ReadWriteOnceWithFSType
  Pod Info On Mount:   false
  Requires Republish:  false
  Se Linux Mount:      false
  Storage Capacity:    false
  Volume Lifecycle Modes:
    Persistent
Events:  <none>
```

### **7. ë…¸ë“œì˜ ìµœëŒ€ EBS ë¶€ì°© ìˆ˜ëŸ‰ ë³€ê²½**

- **ê¸°ë³¸ì ìœ¼ë¡œ ë…¸ë“œë‹¹ EBS ë³¼ë¥¨ ìµœëŒ€ 25ê°œê¹Œì§€ ë¶€ì°© ê°€ëŠ¥**
- **ìµœëŒ€ ë¶€ì°© ìˆ˜ëŸ‰ì„ 31ê°œë¡œ ì¦ê°€**

```bash
aws eks update-addon --cluster-name ${CLUSTER_NAME} --addon-name aws-ebs-csi-driver \
  --addon-version v1.39.0-eksbuild.1 --configuration-values '{
    "node": {
      "volumeAttachLimit": 31,
      "enableMetrics": true
    }
  }'
```

âœ… **ì¶œë ¥**

```bash
{
    "update": {
        "id": "31bc4279-d50f-30e0-aebe-de2971095881",
        "status": "InProgress",
        "type": "AddonUpdate",
        "params": [
            {
                "type": "AddonVersion",
                "value": "v1.39.0-eksbuild.1"
            },
            {
                "type": "ConfigurationValues",
                "value": "{\n    \"node\": {\n      \"volumeAttachLimit\": 31,\n      \"enableMetrics\": true\n    }\n  }"
            }
        ],
        "createdAt": "2025-02-18T20:19:34.938000+09:00",
        "errors": []
    }

```

- **EKS Add-onsì—ì„œ `aws-ebs-csi-driver`ì˜ ì„¤ì • ë³€ê²½ ê°€ëŠ¥**

![Image](https://github.com/user-attachments/assets/2e785633-b22c-4ab8-a010-3f64dcb70bea)

### **8. EBS CSI Node ë°ëª¬ì…‹ ì„¤ì • í™•ì¸**

```bash
kubectl get ds -n kube-system ebs-csi-node -o yaml
```

âœ… **ì¶œë ¥ (ì¼ë¶€)**

```bash
containers:
  - args:
    - node
    - --endpoint=$(CSI_ENDPOINT)
    - --http-endpoint=0.0.0.0:3302
    - --csi-mount-point-prefix=/var/lib/kubelet/plugins/kubernetes.io/csi/ebs.csi.aws.com/
    - --volume-attach-limit=31
```

- **EBS CSI Node ë°ëª¬ì…‹ì´ ì¬ê¸°ë™ë˜ë©´ì„œ Argument ê°’ì´ ì ìš©ë¨**
- **ê° ë…¸ë“œì—ì„œ `-volume-attach-limit=31` ì„¤ì •ì´ ë°˜ì˜ë¨**

### **9. CSI Node ë³¼ë¥¨ ë¶€ì°© í•œë„ ì¦ê°€ í™•ì¸**

```bash
kubectl describe csinodes
```

âœ… **ì¶œë ¥**

```bash
Name:               ip-192-168-1-207.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:46 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-093ad32d5ff5a8770
      Allocatables:
        Count:        31
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>

Name:               ip-192-168-2-84.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:49 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-0a80fdc36a856f394
      Allocatables:
        Count:        31
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>

Name:               ip-192-168-3-80.ap-northeast-2.compute.internal
Labels:             <none>
Annotations:        storage.alpha.kubernetes.io/migrated-plugins:
                      kubernetes.io/aws-ebs,kubernetes.io/azure-disk,kubernetes.io/azure-file,kubernetes.io/cinder,kubernetes.io/gce-pd,kubernetes.io/portworx-v...
CreationTimestamp:  Tue, 18 Feb 2025 11:46:42 +0900
Spec:
  Drivers:
    ebs.csi.aws.com:
      Node ID:  i-0484d2b724be33973
      Allocatables:
        Count:        31
      Topology Keys:  [kubernetes.io/os topology.ebs.csi.aws.com/zone topology.kubernetes.io/zone]
Events:               <none>
```

### **10. ê¸°ì¡´ ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ í™•ì¸**

```bash
kubectl get sc
```

âœ… **ì¶œë ¥**

```bash
NAME         PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2          kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  8h
local-path   rancher.io/local-path   Delete          WaitForFirstConsumer   false                  3h19m
```

### **11. gp3 ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: gp3
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
allowVolumeExpansion: true
provisioner: ebs.csi.aws.com
volumeBindingMode: WaitForFirstConsumer
parameters:
  type: gp3
  #iops: "5000"
  #throughput: "250"
  allowAutoIOPSPerGBIncrease: 'true'
  encrypted: 'true'
  fsType: xfs # ê¸°ë³¸ê°’ì´ ext4
EOF

# ê²°ê³¼
storageclass.storage.k8s.io/gp3 created
```

- **ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ìƒì„± í™•ì¸**

```bash
kubectl get sc
```

âœ… **ì¶œë ¥**

```bash
NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2             kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  8h
gp3 (default)   ebs.csi.aws.com         Delete          WaitForFirstConsumer   true                   30s
local-path      rancher.io/local-path   Delete          WaitForFirstConsumer   false                  3h20m
```

### **12. `gp3` ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
kubectl describe sc gp3
```

âœ… **ì¶œë ¥**

```bash
Name:            gp3
IsDefaultClass:  Yes
Annotations:     kubectl.kubernetes.io/last-applied-configuration={"allowVolumeExpansion":true,"apiVersion":"storage.k8s.io/v1","kind":"StorageClass","metadata":{"annotations":{"storageclass.kubernetes.io/is-default-class":"true"},"name":"gp3"},"parameters":{"allowAutoIOPSPerGBIncrease":"true","encrypted":"true","fsType":"xfs","type":"gp3"},"provisioner":"ebs.csi.aws.com","volumeBindingMode":"WaitForFirstConsumer"}
,storageclass.kubernetes.io/is-default-class=true
Provisioner:           ebs.csi.aws.com
Parameters:            allowAutoIOPSPerGBIncrease=true,encrypted=true,fsType=xfs,type=gp3
AllowVolumeExpansion:  True
MountOptions:          <none>
ReclaimPolicy:         Delete
VolumeBindingMode:     WaitForFirstConsumer
Events:                <none>
```

- ë³¼ë¥¨ í™•ì¥ ê°€ëŠ¥ (`AllowVolumeExpansion: True`)
- ê¸°ë³¸ íŒŒì¼ ì‹œìŠ¤í…œ `xfs` ì ìš©

### **13. EBS ë³¼ë¥¨ ìƒì„± ëª¨ë‹ˆí„°ë§**

```bash
while true; do aws ec2 describe-volumes --filters Name=tag:ebs.csi.aws.com/cluster,Values=true --query "Volumes[].{VolumeId: VolumeId, VolumeType: VolumeType, InstanceId: Attachments[0].InstanceId, State: Attachments[0].State}" --output text; date; sleep 1; done
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 08:36:24 PM KST 2025
Tue Feb 18 08:36:25 PM KST 2025
Tue Feb 18 08:36:27 PM KST 2025
Tue Feb 18 08:36:28 PM KST 2025
```

### **14. EBS PVC ìƒì„±**

**(1) StorageClass `gp3`ë¥¼ ì‚¬ìš©í•˜ì—¬ PVCë¥¼ ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 4Gi
  storageClassName: gp3
EOF

# ê²°ê³¼
persistentvolumeclaim/ebs-claim created
```

**(2) ìƒì„± í™•ì¸**

- ì•„ì§ PVCê°€ ë°”ì¸ë”©ë˜ì§€ ì•Šì€ ìƒíƒœ

```bash
k get pv
No resources found

k get pvc
NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
ebs-claim   Pending                                      gp3            <unset>                 96s
```

### **15. PVCë¥¼ ì‚¬ìš©í•˜ëŠ” Pod ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo \$(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: ebs-claim
EOF

# ê²°ê³¼
pod/app created
```

### **16. PVCì™€ PV ë°”ì¸ë”© ìƒíƒœ í™•ì¸**

```bash
kubectl get pvc,pv,pod
```

âœ… **ì¶œë ¥**

```bash
NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/ebs-claim   Bound    pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5   4Gi        RWO            gp3            <unset>                 4m22s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5   4Gi        RWO            Delete           Bound    default/ebs-claim   gp3            <unset>                          26s

NAME      READY   STATUS    RESTARTS   AGE
pod/app   1/1     Running   0          29s
```

- PVC(`ebs-claim`)ê°€ ìë™ìœ¼ë¡œ PV(`pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5`)ì™€ ë°”ì¸ë”©ë¨
- Pod(`app`)ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë¨ (`Status: Running`)

- Pod ì‹¤í–‰ í›„ EBS ë³¼ë¥¨ì´ ìë™ ìƒì„± ë° ë¶€ì°©ë¨

![Image](https://github.com/user-attachments/assets/be0e5ab7-0ba4-4554-9435-2b7b4f9f4575)

### **17. EBS ë³¼ë¥¨ì´ íŠ¹ì • ë…¸ë“œì— ë¶€ì°©ë˜ì—ˆëŠ”ì§€ í™•ì¸**

```bash
kubectl get VolumeAttachment
```

âœ… **ì¶œë ¥**

```bash
NAME                                                                   ATTACHER          PV                                         NODE                                               ATTACHED   AGE
csi-2c549400779c2b0340a9261869f4798e1239dc965d8a47cf3b3c29fe8b2b4fd4   ebs.csi.aws.com   pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5   ip-192-168-1-207.ap-northeast-2.compute.internal   true       7m45s
```

- EBS ë³¼ë¥¨ì´ `ip-192-168-1-207` ë…¸ë“œì— ë¶€ì°©ë¨ (`ATTACHED: true`)

![Image](https://github.com/user-attachments/assets/a5a96977-d42a-443d-a2c0-3d8b8398b86c)

### **18. EBS ë³¼ë¥¨ ì‚¬ìš©ëŸ‰ í™•ì¸**

```bash
kubectl df-pv
```

âœ… **ì¶œë ¥**

```bash
 PV NAME                                   PVC NAME   NAMESPACE  NODE NAME                                         POD NAME  VOLUME MOUNT NAME   SIZE  USED  AVAILABLE  %USED  IUSED  IFREE    %IUSED 
 pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5  ebs-claim  default    ip-192-168-1-207.ap-northeast-2.compute.internal  app       persistent-storage  3Gi   60Mi  3Gi        1.50   4      2097148  0.00  
```

- **í˜„ì¬ `1.5%` ì •ë„ì˜ ë³¼ë¥¨ ê³µê°„ì´ ì‚¬ìš©ë¨**
- **Podê°€ ì‹¤í–‰ ì¤‘ì¸ ì›Œì»¤ ë…¸ë“œ(`192.168.1.207`)ì—ì„œ í•´ë‹¹ ë³¼ë¥¨ì„ ì‚¬ìš© ì¤‘**

- **AWS ì½˜ì†”ì—ì„œ ë³¼ë¥¨ ì‚¬ìš©ëŸ‰ í™•ì¸**

![Image](https://github.com/user-attachments/assets/66e5b1fa-dae7-4a8f-ac75-515d39e254f1)

### **19. EBS ë³¼ë¥¨ì˜ Node Affinity í™•ì¸**

- í˜„ì¬ PV ì„¤ì • í™•ì¸

```bash
kubectl get pv -o yaml
```

âœ… **ì¶œë ¥ (ì¼ë¶€)**

```bash
spec:
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: topology.kubernetes.io/zone
          operator: In
          values:
          - ap-northeast-2a
```

- í˜„ì¬ `ap-northeast-2a` ê°€ìš© ì˜ì—­(AZ)ì— ìˆëŠ” ë…¸ë“œì—ì„œë§Œ EBS ë¶€ì°© ê°€ëŠ¥

### **20. í˜„ì¬ ë…¸ë“œ ëª©ë¡ ë° ê°€ìš© ì˜ì—­ í™•ì¸**

```bash
kubectl get node --label-columns=topology.ebs.csi.aws.com/zone,topology.k8s.aws/zone-id
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               ZONE              ZONE-ID
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   9h    v1.31.5-eks-5d632ec   ap-northeast-2a   apne2-az1
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   9h    v1.31.5-eks-5d632ec   ap-northeast-2b   apne2-az2
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   9h    v1.31.5-eks-5d632ec   ap-northeast-2c   apne2-az3
```

- EBS ë³¼ë¥¨ì€ `ap-northeast-2a`ì— ìˆëŠ” `ip-192-168-1-207` ë…¸ë“œì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

### **21. EBS ë³¼ë¥¨ ë‚´ ë°ì´í„° ì •ìƒ ì €ì¥ í™•ì¸**

```bash
kubectl exec app -- tail -f /data/out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 12:05:17 UTC 2025
Tue Feb 18 12:05:22 UTC 2025
Tue Feb 18 12:05:27 UTC 2025
Tue Feb 18 12:05:32 UTC 2025
Tue Feb 18 12:05:37 UTC 2025
Tue Feb 18 12:05:42 UTC 2025
Tue Feb 18 12:05:47 UTC 2025
...
```

- EBS ë³¼ë¥¨ì´ ì •ìƒì ìœ¼ë¡œ `/data/out.txt` íŒŒì¼ì— ë°ì´í„° ê¸°ë¡ ì¤‘

### **22. EBS ë³¼ë¥¨ ë§ˆìš´íŠ¸ í™•ì¸**

**(1) Overlay íŒŒì¼ì‹œìŠ¤í…œ í™•ì¸**

```bash
kubectl exec -it app -- sh -c 'df -hT --type=overlay'
```

âœ… **ì¶œë ¥**

```bash
Filesystem     Type     Size  Used Avail Use% Mounted on
overlay        overlay  120G  4.5G  116G   4% /
```

**(2) XFS íŒŒì¼ì‹œìŠ¤í…œ í™•ì¸**

```bash
kubectl exec -it app -- sh -c 'df -hT --type=xfs'
```

âœ… **ì¶œë ¥**

```bash
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme1n1   xfs   4.0G   61M  3.9G   2% /data
/dev/nvme0n1p1 xfs   120G  4.5G  116G   4% /etc/hosts
```

- EBS ë³¼ë¥¨(`/dev/nvme1n1`)ì´ `/data`ì— ë§ˆìš´íŠ¸ë¨
- í˜„ì¬ `4.0GiB` ì¤‘ `61MiB` ì‚¬ìš©ë¨ (`2%`)

### **23. EBS ë³¼ë¥¨ í¬ê¸° í™•ì¥ í…ŒìŠ¤íŠ¸**

**(1) í˜„ì¬ PVC í¬ê¸° í™•ì¸**

```bash
kubectl get pvc ebs-claim -o jsonpath={.spec.resources.requests.storage} ; echo
```

âœ… **ì¶œë ¥**

```bash
4Gi
```

**(2) PVC í¬ê¸° í™•ì¥ ìš”ì²­ (`4GiB â†’ 10GiB`)**

```bash
kubectl patch pvc ebs-claim -p '{"spec":{"resources":{"requests":{"storage":"10Gi"}}}}'

# ê²°ê³¼
persistentvolumeclaim/ebs-claim patched
```

**(3) ë³€ê²½ëœ ë³¼ë¥¨ í¬ê¸° í™•ì¸**

```bash
kubectl exec -it app -- sh -c 'df -hT --type=xfs'
```

âœ… **ì¶œë ¥**

```bash
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme1n1   xfs    10G  105M  9.9G   2% /data
/dev/nvme0n1p1 xfs   120G  4.5G  116G   4% /etc/hosts
```

- EBS ë³¼ë¥¨ í¬ê¸°ê°€ `4GiB â†’ 10GiB`ë¡œ ì •ìƒ í™•ì¥ë¨

**(4) PVC ìƒíƒœ í™•ì¸ (`df-pv` í™œìš©)**

```bash
kubectl df-pv
```

âœ… **ì¶œë ¥**

```bash
 PV NAME                                   PVC NAME   NAMESPACE  NODE NAME                                         POD NAME  VOLUME MOUNT NAME   SIZE  USED   AVAILABLE  %USED  IUSED  IFREE    %IUSED 
 pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5  ebs-claim  default    ip-192-168-1-207.ap-northeast-2.compute.internal  app       persistent-storage  9Gi   104Mi  9Gi        1.02   4      5242876  0.00 
```

- ë³¼ë¥¨ í¬ê¸° `9GiB`, ì‚¬ìš©ëŸ‰ `1.02%` í™•ì¸ë¨

**(5) AWSì—ì„œ ë³¼ë¥¨ í¬ê¸° ë³€ê²½ ì‚¬í•­ í™•ì¸**

```bash
aws ec2 describe-volumes --volume-ids $(kubectl get pv -o jsonpath="{.items[0].spec.csi.volumeHandle}") | jq
```

âœ… **ì¶œë ¥**

```bash
{
  "Volumes": [
    {
      "Iops": 3000,
      "Tags": [
        {
          "Key": "kubernetes.io/created-for/pvc/name",
          "Value": "ebs-claim"
        },
        {
          "Key": "ebs.csi.aws.com/cluster",
          "Value": "true"
        },
        {
          "Key": "kubernetes.io/cluster/myeks",
          "Value": "owned"
        },
        {
          "Key": "kubernetes.io/created-for/pvc/namespace",
          "Value": "default"
        },
        {
          "Key": "KubernetesCluster",
          "Value": "myeks"
        },
        {
          "Key": "CSIVolumeName",
          "Value": "pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5"
        },
        {
          "Key": "Name",
          "Value": "myeks-dynamic-pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5"
        },
        {
          "Key": "kubernetes.io/created-for/pv/name",
          "Value": "pvc-ef2fe3fe-7117-44f2-94d0-cdb253c47af5"
        }
      ],
      "VolumeType": "gp3",
      "MultiAttachEnabled": false,
      "Throughput": 125,
      "Operator": {
        "Managed": false
      },
      "VolumeId": "vol-0b12360fbeebb9580",
      "Size": 10,
      "SnapshotId": "",
      "AvailabilityZone": "ap-northeast-2a",
      "State": "in-use",
      "CreateTime": "2025-02-18T11:46:58.192000+00:00",
      "Attachments": [
        {
          "DeleteOnTermination": false,
          "VolumeId": "vol-0b12360fbeebb9580",
          "InstanceId": "i-093ad32d5ff5a8770",
          "Device": "/dev/xvdaa",
          "State": "attached",
          "AttachTime": "2025-02-18T11:47:01+00:00"
        }
      ],
      "Encrypted": true,
      "KmsKeyId": "arn:aws:kms:ap-northeast-2:378102432899:key/8c9984ef-c009-4d66-bb63-428b05a0ed1e"
    }
  ]
}
```

- AWS ì½˜ì†”ì—ì„œë„ EBS ë³¼ë¥¨ í¬ê¸° `10GiB`ë¡œ í™•ì¥ëœ ê²ƒ í™•ì¸ ê°€ëŠ¥

![Image](https://github.com/user-attachments/assets/1676f878-276c-480a-9217-5de367769061)

### **24. ë³¼ë¥¨ í™•ì¥ í›„ Pod ë° PVC ì‚­ì œ**

```bash
kubectl delete pod app & kubectl delete pvc ebs-claim
```

âœ… **ì¶œë ¥**

```bash
[1] 208891
pod "app" deleted
persistentvolumeclaim "ebs-claim" deleted
[1]+  Done                    kubecolor delete pod app
```

- Pod ì‚­ì œ í›„ PVC ì‚­ì œ ì‹œ, EBS ë³¼ë¥¨ë„ í•¨ê»˜ ì‚­ì œë¨
- AWS ì½˜ì†”ì—ì„œ EBS ë³¼ë¥¨ì´ ìë™ìœ¼ë¡œ ì œê±°ë¨

- **AWS ì½˜ì†”ì—ì„œ EBS ë³¼ë¥¨ ì‚­ì œ í™•ì¸**

![Image](https://github.com/user-attachments/assets/30090d56-fcc3-4899-96e9-12594eb1583e)

---

## **ğŸ“¸ EBS ë³¼ë¥¨ ìŠ¤ëƒ…ìƒ· ìƒì„± ë° ë³µì›**

### **1. EBS ë³¼ë¥¨ ìŠ¤ëƒ…ìƒ· ê¸°ëŠ¥ ê°œìš”**

- AWS EBS ë³¼ë¥¨ì˜ ìŠ¤ëƒ…ìƒ·ì„ ì¿ ë²„ë„¤í‹°ìŠ¤ ë„¤ì´í‹°ë¸Œ ë°©ì‹ìœ¼ë¡œ í™œìš©
- **AWS Volume SnapShots Controller**ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŠ¤ëƒ…ìƒ· ìƒì„± ë° ë³µì› ê°€ëŠ¥

### 2. Volume Snapshot CRD ì„¤ì¹˜

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshots.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotclasses.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/client/config/crd/snapshot.storage.k8s.io_volumesnapshotcontents.yaml
```

âœ… **ì¶œë ¥**

```bash
customresourcedefinition.apiextensions.k8s.io/volumesnapshots.snapshot.storage.k8s.io created
customresourcedefinition.apiextensions.k8s.io/volumesnapshotclasses.snapshot.storage.k8s.io created
customresourcedefinition.apiextensions.k8s.io/volumesnapshotcontents.snapshot.storage.k8s.io created
```

### **3. ì„¤ì¹˜ í™•ì¸**

**(1) CRDì—ì„œ ìŠ¤ëƒ…ìƒ· ê´€ë ¨ ë¦¬ì†ŒìŠ¤ í™•ì¸**

```bash
kubectl get crd | grep snapshot
```

âœ… **ì¶œë ¥**

```bash
volumesnapshotclasses.snapshot.storage.k8s.io    2025-02-18T12:47:37Z
volumesnapshotcontents.snapshot.storage.k8s.io   2025-02-18T12:47:38Z
volumesnapshots.snapshot.storage.k8s.io          2025-02-18T12:47:36Z
```

**(2) API ë¦¬ì†ŒìŠ¤ì—ì„œ ìŠ¤ëƒ…ìƒ· ê´€ë ¨ ë¦¬ì†ŒìŠ¤ í™•ì¸**

```bash
kubectl api-resources  | grep snapshot
```

âœ… **ì¶œë ¥**

```bash
volumesnapshotclasses               vsclass,vsclasses   snapshot.storage.k8s.io/v1        false        VolumeSnapshotClass
volumesnapshotcontents              vsc,vscs            snapshot.storage.k8s.io/v1        false        VolumeSnapshotContent
volumesnapshots                     vs                  snapshot.storage.k8s.io/v1        true         VolumeSnapshot
```

### **4. ìŠ¤ëƒ…ìƒ· ì»¨íŠ¸ë¡¤ëŸ¬ ë°°í¬**

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/rbac-snapshot-controller.yaml
kubectl apply -f https://raw.githubusercontent.com/kubernetes-csi/external-snapshotter/master/deploy/kubernetes/snapshot-controller/setup-snapshot-controller.yaml
```

âœ… **ì¶œë ¥**

```bash
serviceaccount/snapshot-controller created
clusterrole.rbac.authorization.k8s.io/snapshot-controller-runner created
clusterrolebinding.rbac.authorization.k8s.io/snapshot-controller-role created
role.rbac.authorization.k8s.io/snapshot-controller-leaderelection created
rolebinding.rbac.authorization.k8s.io/snapshot-controller-leaderelection created
deployment.apps/snapshot-controller created
```

### **5. ë°°í¬ í™•ì¸**

```bash
kubectl get deploy -n kube-system snapshot-controller
```

âœ… **ì¶œë ¥**

```bash
NAME                  READY   UP-TO-DATE   AVAILABLE   AGE
snapshot-controller   2/2     2            2           48s
```

### **6. AWS EBS ìŠ¤ëƒ…ìƒ· í´ë˜ìŠ¤ ìƒì„±**

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/aws-ebs-csi-driver/master/examples/kubernetes/snapshot/manifests/classes/snapshotclass.yaml

# ê²°ê³¼
volumesnapshotclass.snapshot.storage.k8s.io/csi-aws-vsc created
```

### **7. ìŠ¤ëƒ…ìƒ· í´ë˜ìŠ¤ í™•ì¸**

**(1) ë³¼ë¥¨ ìŠ¤ëƒ…ìƒ· í´ë˜ìŠ¤(VolumeSnapshotClass) ëª©ë¡ í™•ì¸**

```bash
kubectl get vsclass
```

âœ… **ì¶œë ¥**

```bash
NAME          DRIVER            DELETIONPOLICY   AGE
csi-aws-vsc   ebs.csi.aws.com   Delete           1s
```

**(2) ë³¼ë¥¨ ìŠ¤ëƒ…ìƒ· í´ë˜ìŠ¤(VolumeSnapshotClass) ìƒì„¸ ì •ë³´ í™•ì¸**

```bash
kubectl describe vsclass
```

âœ… **ì¶œë ¥**

```bash
Name:             csi-aws-vsc
Namespace:        
Labels:           <none>
Annotations:      <none>
API Version:      snapshot.storage.k8s.io/v1
Deletion Policy:  Delete
Driver:           ebs.csi.aws.com
Kind:             VolumeSnapshotClass
Metadata:
  Creation Timestamp:  2025-02-18T12:53:56Z
  Generation:          1
  Resource Version:    142886
  UID:                 e310327c-0673-4a0d-bf3f-fa1c2791b063
Events:                <none>
```

### **8. PVC ë° Pod ìƒì„±**

**(1) ëª¨ë‹ˆí„°ë§**

```bash
watch -d kubectl get pv,pvc,pod

Every 2.0s: kubectl get pv,pvc,pod                                                                                             gram88: 09:57:32 PM
                                                                                                                                     in 0.813s (0)
No resources found
```

**(2) PVC ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-claim
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 4Gi
  storageClassName: gp3
EOF

# ê²°ê³¼
persistentvolumeclaim/ebs-claim created
```

**(3) PVC, PV ì¡°íšŒ**

```bash
kubectl get pvc,pv
```

âœ… **ì¶œë ¥**

```bash
NAME                              STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/ebs-claim   Pending                                      gp3            <unset>                 0s
```

**(4) Pod ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo \$(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: ebs-claim
EOF

# ê²°ê³¼
pod/app created
```

### **9. íŒŒì¼ ì €ì¥ í™•ì¸**

```bash
kubectl exec app -- tail -f /data/out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 13:00:45 UTC 2025
Tue Feb 18 13:00:50 UTC 2025
Tue Feb 18 13:00:55 UTC 2025
Tue Feb 18 13:01:00 UTC 2025
Tue Feb 18 13:01:05 UTC 2025
Tue Feb 18 13:01:10 UTC 2025
Tue Feb 18 13:01:15 UTC 2025
Tue Feb 18 13:01:20 UTC 2025
Tue Feb 18 13:01:25 UTC 2025
...
```

### **10. EBS ë³¼ë¥¨ ìŠ¤ëƒ…ìƒ· ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshot
metadata:
  name: ebs-volume-snapshot
spec:
  volumeSnapshotClassName: csi-aws-vsc
  source:
    persistentVolumeClaimName: ebs-claim
EOF

# ê²°ê³¼
volumesnapshot.snapshot.storage.k8s.io/ebs-volume-snapshot created
```

- AWS ì½˜ì†”ì—ì„œ **EBS ìŠ¤ëƒ…ìƒ·**ì´ ì •ìƒì ìœ¼ë¡œ ìƒì„±ë¨

![Image](https://github.com/user-attachments/assets/b7bb8e84-0730-437b-a505-73a793517479)


- **Kubernetesì˜ Podê°€ ì‚¬ìš© ì¤‘ì¸ EBS ë³¼ë¥¨**ì„ ê·¸ëŒ€ë¡œ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì €ì¥

![Image](https://github.com/user-attachments/assets/8c0d2588-c80a-4fbb-a054-09b973c8e1ed)

### **11. ìŠ¤ëƒ…ìƒ· ìƒíƒœ í™•ì¸**

**(1) ìƒì„±ëœ VolumeSnapshot í™•ì¸**

```bash
kubectl get volumesnapshot
```

âœ… **ì¶œë ¥**

```bash
NAME                  READYTOUSE   SOURCEPVC   SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS   SNAPSHOTCONTENT                                    CREATIONTIME   AGE
ebs-volume-snapshot   true         ebs-claim                           4Gi           csi-aws-vsc     snapcontent-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01   4m             4m1s
```

**(2) íŠ¹ì • VolumeSnapshotì˜ SnapshotContent ë°”ì¸ë”© ì •ë³´ ì¡°íšŒ**

```bash
kubectl get volumesnapshot ebs-volume-snapshot -o jsonpath={.status.boundVolumeSnapshotContentName} ; echo
```

âœ… **ì¶œë ¥**

```bash
snapcontent-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01
```

**(3) íŠ¹ì • VolumeSnapshot ìƒì„¸ ì •ë³´ ì¡°íšŒ**

```bash
kubectl describe volumesnapshot.snapshot.storage.k8s.io ebs-volume-snapshot
```

âœ… **ì¶œë ¥**

```bash
Name:         ebs-volume-snapshot
Namespace:    default
Labels:       <none>
Annotations:  <none>
API Version:  snapshot.storage.k8s.io/v1
Kind:         VolumeSnapshot
Metadata:
  Creation Timestamp:  2025-02-18T13:03:27Z
  Finalizers:
    snapshot.storage.kubernetes.io/volumesnapshot-as-source-protection
    snapshot.storage.kubernetes.io/volumesnapshot-bound-protection
  Generation:        1
  Resource Version:  146033
  UID:               9bd1cc5d-21d5-47f4-97de-c4b6a871ae01
Spec:
  Source:
    Persistent Volume Claim Name:  ebs-claim
  Volume Snapshot Class Name:      csi-aws-vsc
Status:
  Bound Volume Snapshot Content Name:  snapcontent-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01
  Creation Time:                       2025-02-18T13:03:28Z
  Ready To Use:                        true
  Restore Size:                        4Gi
Events:
  Type    Reason            Age    From                 Message
  ----    ------            ----   ----                 -------
  Normal  CreatingSnapshot  5m20s  snapshot-controller  Waiting for a snapshot default/ebs-volume-snapshot to be created by the CSI driver.
  Normal  SnapshotCreated   5m19s  snapshot-controller  Snapshot default/ebs-volume-snapshot was successfully created by the CSI driver.
  Normal  SnapshotReady     4m12s  snapshot-controller  Snapshot default/ebs-volume-snapshot is ready to use.
```

**(4) ìƒì„±ëœ VolumeSnapshotContent í™•ì¸**

```bash
kubectl get volumesnapshotcontents
```

âœ… **ì¶œë ¥**

```bash
NAME                                               READYTOUSE   RESTORESIZE   DELETIONPOLICY   DRIVER            VOLUMESNAPSHOTCLASS   VOLUMESNAPSHOT        VOLUMESNAPSHOTNAMESPACE   AGE
snapcontent-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01   true         4294967296    Delete           ebs.csi.aws.com   csi-aws-vsc           ebs-volume-snapshot   default                   5m52s
```

**(5) VolumeSnapshot ID í™•ì¸**

```bash
kubectl get volumesnapshotcontents -o jsonpath='{.items[*].status.snapshotHandle}' ; echo
```

âœ… **ì¶œë ¥**

```bash
snap-0f1c3fa51d2fc9d33
```

**(6) AWS  EBS ìŠ¤ëƒ…ìƒ· ëª©ë¡ ì¡°íšŒ (JSON ì¶œë ¥)**

```bash
aws ec2 describe-snapshots --owner-ids self | jq
```

âœ… **ì¶œë ¥**

```bash
{
  "Snapshots": [
    {
      "Tags": [
        {
          "Key": "Name",
          "Value": "myeks-dynamic-snapshot-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01"
        },
        {
          "Key": "CSIVolumeSnapshotName",
          "Value": "snapshot-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01"
        },
        {
          "Key": "kubernetes.io/cluster/myeks",
          "Value": "owned"
        },
        {
          "Key": "ebs.csi.aws.com/cluster",
          "Value": "true"
        }
      ],
      "StorageTier": "standard",
      "TransferType": "standard",
      "CompletionTime": "2025-02-18T13:04:04.793000+00:00",
      "SnapshotId": "snap-0f1c3fa51d2fc9d33",
      "VolumeId": "vol-090da41ed97dae65a",
      "State": "completed",
      "StartTime": "2025-02-18T13:03:28.688000+00:00",
      "Progress": "100%",
      "OwnerId": "378102432899",
      "Description": "Created by AWS EBS CSI driver for volume vol-090da41ed97dae65a",
      "VolumeSize": 4,
      "Encrypted": true,
      "KmsKeyId": "arn:aws:kms:ap-northeast-2:378102432899:key/8c9984ef-c009-4d66-bb63-428b05a0ed1e"
    }
  ]
}
```

**(7) AWS EBS ìŠ¤ëƒ…ìƒ· ëª©ë¡ ì¡°íšŒ (í…Œì´ë¸” ì¶œë ¥)**

```bash
aws ec2 describe-snapshots --owner-ids self --query 'Snapshots[]' --output table
```

âœ… **ì¶œë ¥**

```bash
--------------------------------------------------------------------------------------------------------
|                                           DescribeSnapshots                                          |
+----------------+-------------------------------------------------------------------------------------+
|  CompletionTime|  2025-02-18T13:04:04.793000+00:00                                                   |
|  Description   |  Created by AWS EBS CSI driver for volume vol-090da41ed97dae65a                     |
|  Encrypted     |  True                                                                               |
|  KmsKeyId      |  arn:aws:kms:ap-northeast-2:378102432899:key/8c9984ef-c009-4d66-bb63-428b05a0ed1e   |
|  OwnerId       |  378102432899                                                                       |
|  Progress      |  100%                                                                               |
|  SnapshotId    |  snap-0f1c3fa51d2fc9d33                                                             |
|  StartTime     |  2025-02-18T13:03:28.688000+00:00                                                   |
|  State         |  completed                                                                          |
|  StorageTier   |  standard                                                                           |
|  TransferType  |  standard                                                                           |
|  VolumeId      |  vol-090da41ed97dae65a                                                              |
|  VolumeSize    |  4                                                                                  |
+----------------+-------------------------------------------------------------------------------------+
||                                                Tags                                                ||
|+--------------------------------+-------------------------------------------------------------------+|
||               Key              |                               Value                               ||
|+--------------------------------+-------------------------------------------------------------------+|
||  Name                          |  myeks-dynamic-snapshot-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01      ||
||  CSIVolumeSnapshotName         |  snapshot-9bd1cc5d-21d5-47f4-97de-c4b6a871ae01                    ||
||  kubernetes.io/cluster/myeks   |  owned                                                            ||
||  ebs.csi.aws.com/cluster       |  true                                                             ||
|+--------------------------------+-------------------------------------------------------------------+|
```

### **12. EBS ë³¼ë¥¨ ì‚­ì œ (ì‹¤ìˆ˜ ê°€ì •)**

- **Pod ë° PVC ì‚­ì œ**
- ì‹¤ìˆ˜ë¡œ ì¸í•´ ë³¼ë¥¨ì´ ì‚­ì œëœ ìƒí™© ê°€ì •

```bash
kubectl delete pod app && kubectl delete pvc ebs-claim

# ê²°ê³¼
pod "app" deleted
persistentvolumeclaim "ebs-claim" deleted
```

![Image](https://github.com/user-attachments/assets/d8e88669-7fe7-468f-ba28-33feb8b56d70)

### **13. ìŠ¤ëƒ…ìƒ·ì„ í™œìš©í•œ PVC ë³µì›**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ebs-snapshot-restored-claim
spec:
  storageClassName: gp3
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 4Gi
  dataSource:
    name: ebs-volume-snapshot
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
EOF

# ê²°ê³¼
persistentvolumeclaim/ebs-snapshot-restored-claim created
```

### **14. ë³µì›ëœ PVCë¥¼ ì‚¬ìš©í•˜ëŠ” Pod ìƒì„±**

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: app
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: app
    image: centos
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo \$(date -u) >> /data/out.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: ebs-snapshot-restored-claim
EOF

# ê²°ê³¼
pod/app created
```

### **15. ë³µì›ëœ ë°ì´í„° í™•ì¸**

```bash
kubectl exec app -- cat /data/out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 13:03:00 UTC 2025
Tue Feb 18 13:03:05 UTC 2025
Tue Feb 18 13:03:10 UTC 2025
Tue Feb 18 13:03:15 UTC 2025
Tue Feb 18 13:18:15 UTC 2025
Tue Feb 18 13:18:20 UTC 2025
Tue Feb 18 13:18:25 UTC 2025
Tue Feb 18 13:18:30 UTC 2025
Tue Feb 18 13:18:35 UTC 2025
```

- **ìŠ¤ëƒ…ìƒ· ìƒì„± ì‹œì (`13:03:15`)ê¹Œì§€ì˜ ë°ì´í„°ê°€ ë³µì›ë¨**
- **ìƒˆë¡œìš´ ë°ì´í„°(`13:18:15` ì´í›„)ë„ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë¨**

### **16. ì‚­ì œ**

```bash
kubectl delete pod app && kubectl delete pvc ebs-snapshot-restored-claim && kubectl delete volumesnapshots ebs-volume-snapshot
```

âœ… **ì¶œë ¥**

```bash
pod "app" deleted
persistentvolumeclaim "ebs-snapshot-restored-claim" deleted
volumesnapshot.snapshot.storage.k8s.io "ebs-volume-snapshot" deleted
```

---

## **ğŸ“ AWS EFS Controller**

### **1. EFS Controller ê°œìš”**

- ê¸°ì¡´ EBSëŠ” **Block Storage**, EFSëŠ” **File System ê¸°ë°˜ì˜ ìŠ¤í† ë¦¬ì§€**
- Amazon EFS íŒŒì¼ ì‹œìŠ¤í…œì„ **CloudFormation**ì„ í†µí•´ ìƒì„±
- ì´í›„ EFSë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ CSI ë“œë¼ì´ë²„ ì„¤ì • ì§„í–‰

### **2. ìƒì„±ëœ EFS íŒŒì¼ ì‹œìŠ¤í…œ í™•ì¸**

```bash
aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text
```

âœ… **ì¶œë ¥**

```bash
fs-0aeb6f8c0c228b9d2
```

### **3. EFS CSI ë“œë¼ì´ë²„ ë²„ì „ í™•ì¸**

```bash
aws eks describe-addon-versions \
    --addon-name aws-efs-csi-driver \
    --kubernetes-version 1.31 \
    --query "addons[].addonVersions[].[addonVersion, compatibilities[].defaultVersion]" \
    --output text
```

âœ… **ì¶œë ¥**

```bash
v2.1.4-eksbuild.1
True
v2.1.3-eksbuild.1
False
v2.1.2-eksbuild.1
False
v2.1.1-eksbuild.1
False
v2.1.0-eksbuild.1
False
...
```

### **4. IAM Role for Service Account (IRSA) ì„¤ì •**

```bash
eksctl create iamserviceaccount \
  --name efs-csi-controller-sa \
  --namespace kube-system \
  --cluster ${CLUSTER_NAME} \
  --attach-policy-arn arn:aws:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy \
  --approve \
  --role-only \
  --role-name AmazonEKS_EFS_CSI_DriverRole
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 22:32:31 [â„¹]  2 existing iamserviceaccount(s) (kube-system/aws-load-balancer-controller,kube-system/ebs-csi-controller-sa) will be excluded
2025-02-18 22:32:31 [â„¹]  1 iamserviceaccount (kube-system/efs-csi-controller-sa) was included (based on the include/exclude rules)
2025-02-18 22:32:31 [!]  serviceaccounts in Kubernetes will not be created or modified, since the option --role-only is used
2025-02-18 22:32:31 [â„¹]  1 task: { create IAM role for serviceaccount "kube-system/efs-csi-controller-sa" }
2025-02-18 22:32:31 [â„¹]  building iamserviceaccount stack "eksctl-myeks-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2025-02-18 22:32:31 [â„¹]  deploying stack "eksctl-myeks-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2025-02-18 22:32:31 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
2025-02-18 22:33:01 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-addon-iamserviceaccount-kube-system-efs-csi-controller-sa"
```

- EFS CSI ë“œë¼ì´ë²„ê°€ **AWS EFS APIì™€ í†µì‹ **í•  ìˆ˜ ìˆë„ë¡ IAM ì—­í•  ìƒì„±
- Amazonì´ ì œê³µí•˜ëŠ” `AmazonEFSCSIDriverPolicy` IAM ì •ì±…ì„ ì—°ê²°

### **5. IAM Service Account í™•ì¸**

```bash
eksctl get iamserviceaccount --cluster ${CLUSTER_NAME}
```

âœ… **ì¶œë ¥**

```bash
NAMESPACE	NAME				ROLE ARN
kube-system	aws-load-balancer-controller	arn:aws:iam::378102432899:role/eksctl-myeks-addon-iamserviceaccount-kube-sys-Role1-O6YEYsN7iVeQ
kube-system	ebs-csi-controller-sa		arn:aws:iam::378102432899:role/AmazonEKS_EBS_CSI_DriverRole
kube-system	efs-csi-controller-sa		arn:aws:iam::378102432899:role/AmazonEKS_EFS_CSI_DriverRole
```

- `efs-csi-controller-sa` ì„œë¹„ìŠ¤ ê³„ì •ì´ ì˜¬ë°”ë¥´ê²Œ **IAM ì—­í• ê³¼ ì—°ê²°ë¨** í™•ì¸

### **6. Amazon EFS CSI ë“œë¼ì´ë²„ ì• ë“œì˜¨ ë°°í¬**

```bash
export ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
eksctl create addon --name aws-efs-csi-driver --cluster ${CLUSTER_NAME} --service-account-role-arn arn:aws:iam::${ACCOUNT_ID}:role/AmazonEKS_EFS_CSI_DriverRole --force
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 22:35:34 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-18 22:35:34 [â„¹]  IRSA is set for "aws-efs-csi-driver" addon; will use this to configure IAM permissions
2025-02-18 22:35:34 [!]  the recommended way to provide IAM permissions for "aws-efs-csi-driver" addon is via pod identity associations; after addon creation is completed, run `eksctl utils migrate-to-pod-identity`
2025-02-18 22:35:34 [â„¹]  using provided ServiceAccountRoleARN "arn:aws:iam::378102432899:role/AmazonEKS_EFS_CSI_DriverRole"
2025-02-18 22:35:34 [â„¹]  creating addon
```

- EFS CSI Driver ì• ë“œì˜¨ì„ EKS í´ëŸ¬ìŠ¤í„°ì— ì„¤ì¹˜

### **7. ì• ë“œì˜¨ ë°°í¬ ìƒíƒœ í™•ì¸**

```bash
eksctl get addon --cluster ${CLUSTER_NAME}
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 22:36:24 [â„¹]  Kubernetes version "1.31" in use by cluster "myeks"
2025-02-18 22:36:24 [â„¹]  getting all addons
2025-02-18 22:36:26 [â„¹]  to see issues for an addon run `eksctl get addon --name <addon-name> --cluster <cluster-name>`
NAME			VERSION			STATUS	ISSUES	IAMROLE										UPDATE AVAILABLE	CONFIGURATION VALUES									POD IDENTITY ASSOCIATION ROLES
aws-ebs-csi-driver	v1.39.0-eksbuild.1	ACTIVE	0												{
    "node": {
      "volumeAttachLimit": 31,
      "enableMetrics": true
    }
  }	
aws-efs-csi-driver	v2.1.4-eksbuild.1	ACTIVE	0	arn:aws:iam::378102432899:role/AmazonEKS_EFS_CSI_DriverRole				
coredns			v1.11.4-eksbuild.2	ACTIVE	0												
kube-proxy		v1.31.3-eksbuild.2	ACTIVE	0												
metrics-server		v0.7.2-eksbuild.2	ACTIVE	0												
vpc-cni			v1.19.2-eksbuild.5	ACTIVE	0	arn:aws:iam::378102432899:role/eksctl-myeks-addon-vpc-cni-Role1-ZTYxtOMDwfFu		enableNetworkPolicy: "true"	
```

- `aws-efs-csi-driver`ê°€ **ACTIVE ìƒíƒœ**ì„ì„ í™•ì¸

### **8. EFS CSI Driver ë°°í¬ í™•ì¸**

```bash
kubectl get csidrivers efs.csi.aws.com -o yaml
```

âœ… **ì¶œë ¥**

```bash
apiVersion: storage.k8s.io/v1
kind: CSIDriver
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"storage.k8s.io/v1","kind":"CSIDriver","metadata":{"annotations":{},"name":"efs.csi.aws.com"},"spec":{"attachRequired":false}}
  creationTimestamp: "2025-02-18T02:37:23Z"
  name: efs.csi.aws.com
  resourceVersion: "155201"
  uid: 9b68ab1a-c2c2-40e2-84c8-b0f06f04b289
spec:
  attachRequired: false
  fsGroupPolicy: ReadWriteOnceWithFSType
  podInfoOnMount: false
  requiresRepublish: false
  seLinuxMount: false
  storageCapacity: false
  volumeLifecycleModes:
  - Persistent
```

- `efs.csi.aws.com` CSI ë“œë¼ì´ë²„ê°€ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë¨ í™•ì¸

### **9. EFS ì‚¬ìš© ë°©ì‹: ì „ì²´ ê³µìœ  vs Access Points**

- **EFS íŒŒì¼ ì‹œìŠ¤í…œì„ ì „ì²´ ê³µìœ **
- **Access Pointsë¥¼ ì´ìš©í•´ íŠ¹ì • ë””ë ‰í† ë¦¬ë§Œ ë¶„ë¦¬í•˜ì—¬ ì‚¬ìš©**
- í•„ìš”ì— ë”°ë¼ **ì „ì²´ íŒŒì¼ ì‹œìŠ¤í…œ ê³µìœ  ë˜ëŠ” íŠ¹ì • ë””ë ‰í† ë¦¬ ê¶Œí•œ ê´€ë¦¬ ê°€ëŠ¥**

- EFSì˜ Access Points ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ê²½ë¡œë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì œí•œí•  ìˆ˜ ìˆìŒ

![Image](https://github.com/user-attachments/assets/22a03b3d-b98f-4c3b-b897-13561c677cf3)

### **10. EFS CSI Driver í´ë¡  ë° íŒŒì¼ êµ¬ì¡° í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# git clone https://github.com/kubernetes-sigs/aws-efs-csi-driver.git /root/efs-csi
(eks-user:default) [root@operator-host ~]# cd /root/efs-csi/examples/kubernetes/multiple_pods/specs && tree
```

âœ… **ì¶œë ¥**

```bash
Cloning into '/root/efs-csi'...
remote: Enumerating objects: 29682, done.
remote: Counting objects: 100% (5145/5145), done.
remote: Compressing objects: 100% (1142/1142), done.
remote: Total 29682 (delta 4275), reused 4015 (delta 3999), pack-reused 24537 (from 3)
Receiving objects: 100% (29682/29682), 27.11 MiB | 17.36 MiB/s, done.
Resolving deltas: 100% (16140/16140), done.

.
â”œâ”€â”€ claim.yaml
â”œâ”€â”€ pod1.yaml
â”œâ”€â”€ pod2.yaml
â”œâ”€â”€ pv.yaml
â””â”€â”€ storageclass.yaml

0 directories, 5 files
```

- **EFS CSI Driver** ì €ì¥ì†Œë¥¼ í´ë¡ í•˜ì—¬ ìƒ˜í”Œ ì„¤ì • íŒŒì¼ ë‹¤ìš´ë¡œë“œ
- StorageClass, PV, PVC, Pod ê´€ë ¨ YAML íŒŒì¼ ì¡´ì¬

### **11. EFS StorageClass ìƒì„± ë° í™•ì¸**

**(1) StorageClass í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# cat storageclass.yaml
```

âœ… **ì¶œë ¥**

```bash
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: efs-sc
provisioner: efs.csi.aws.com
```

**(2) StorageClass ìƒì„±**

```bash
(eks-user:default) [root@operator-host specs]# kubectl apply -f storageclass.yaml

# ê²°ê³¼
storageclass.storage.k8s.io/efs-sc created
```

**(3) StorageClass ìƒì„± í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get sc efs-sc
```

âœ… **ì¶œë ¥**

```bash
NAME     PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
efs-sc   efs.csi.aws.com   Delete          Immediate           false                  54s
```

### **12. EFS PersistentVolume(PV) ì„¤ì •**

**(1) EFS PV ì„¤ì • í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# cat pv.yaml
```

âœ… **ì¶œë ¥**

```bash
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-pv
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sc
  csi:
    driver: efs.csi.aws.com
    volumeHandle: fs-4af69aab
```

- ê¸°ë³¸ì ìœ¼ë¡œ `volumeHandle: fs-4af69aab`ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ

**(2) EFS ì‹œìŠ¤í…œ ID ì—…ë°ì´íŠ¸**

```bash
(eks-user:default) [root@operator-host specs]# EfsFsId=$(aws efs describe-file-systems --query "FileSystems[*].FileSystemId" --output text)
(eks-user:default) [root@operator-host specs]# sed -i "s/fs-4af69aab/$EfsFsId/g" pv.yaml
(eks-user:default) [root@operator-host specs]# cat pv.yaml
```

âœ… **ì¶œë ¥**

```bash
apiVersion: v1
kind: PersistentVolume
metadata:
  name: efs-pv
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  storageClassName: efs-sc
  csi:
    driver: efs.csi.aws.com
    volumeHandle: fs-0aeb6f8c0c228b9d2
```

- ê¸°ì¡´ `fs-4af69aab` â†’ ì‹¤ì œ ì‚¬ìš© ì¤‘ì¸ EFS ì‹œìŠ¤í…œ ID(`fs-0aeb6f8c0c228b9d2`)ë¡œ ë³€ê²½

### **13. EFS PV ìƒì„± ë° í™•ì¸**

**(1) `efs-pv` ìƒì„±**

```bash
(eks-user:default) [root@operator-host specs]# kubectl apply -f pv.yaml
# ê²°ê³¼
persistentvolume/efs-pv created
```

**(2) `efs-pv` í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get pv; kubectl describe pv
```

âœ… **ì¶œë ¥**

```bash
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
efs-pv   5Gi        RWX            Retain           Available           efs-sc         <unset>                          31s

Name:            efs-pv
Labels:          <none>
Annotations:     <none>
Finalizers:      [kubernetes.io/pv-protection]
StorageClass:    efs-sc
Status:          Available
Claim:           
Reclaim Policy:  Retain
Access Modes:    RWX
VolumeMode:      Filesystem
Capacity:        5Gi
Node Affinity:   <none>
Message:         
Source:
    Type:              CSI (a Container Storage Interface (CSI) volume source)
    Driver:            efs.csi.aws.com
    FSType:            
    VolumeHandle:      fs-0aeb6f8c0c228b9d2
    ReadOnly:          false
    VolumeAttributes:  <none>
Events:                <none>
```

- **ACCESS MODES: RWX**
- IP ê¸°ë°˜ ì ‘ê·¼ì´ë¯€ë¡œ ë‹¤ìˆ˜ì˜ íŒŒë“œê°€ ë™ì‹œì— ì ‘ê·¼ ê°€ëŠ¥

### **14. EFS PersistentVolumeClaim(PVC) ìƒì„±**

**(1) PVC ìƒì„± ë° ì ìš©**

```bash
(eks-user:default) [root@operator-host specs]# cat claim.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-claim
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-sc
  resources:
    requests:
      storage: 5Gi
      
(eks-user:default) [root@operator-host specs]# kubectl apply -f claim.yaml
# ê²°ê³¼
persistentvolumeclaim/efs-claim created
```

- `efs-pv`ë¥¼ ì‚¬ìš©í•  `efs-claim` PVCë¥¼ ìƒì„±

**(2) PVC ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get pvc
```

âœ… **ì¶œë ¥**

```bash
NAME        STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
efs-claim   Bound    efs-pv   5Gi        RWX            efs-sc         <unset>                 32s
```

- `STATUS`ê°€ `Bound`ì´ë©´ PVì™€ PVCê°€ ì •ìƒì ìœ¼ë¡œ ì—°ê²°ë¨
- `ACCESS MODES`ê°€ `RWX`ë¡œ ì„¤ì •ë˜ì–´ ì—¬ëŸ¬ Podì—ì„œ ë™ì‹œì— ì ‘ê·¼ ê°€ëŠ¥

### **15. EFS ê¸°ë°˜ ë‹¤ì¤‘ Pod ìƒì„±**

**(1) ë‹¤ì¤‘ Pod ìƒì„± ë° ì ìš©**

- ë‘ ê°œì˜ Pod(`app1`, `app2`)ë¥¼ ìƒì„±í•˜ì—¬ **EFS ë³¼ë¥¨ì„ ê³µìœ **

```bash
(eks-user:default) [root@operator-host specs]# cat pod1.yaml pod2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: app1
spec:
  containers:
  - name: app1
    image: busybox
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out1.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: efs-claim
apiVersion: v1
kind: Pod
metadata:
  name: app2
spec:
  containers:
  - name: app2
    image: busybox
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out2.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: efs-claim
```

```bash
(eks-user:default) [root@operator-host specs]# kubectl apply -f pod1.yaml,pod2.yaml

# ê²°ê³¼
pod/app1 created
pod/app2 created
```

**(2) ë‹¤ì¤‘ Pod ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get pods
```

âœ… **ì¶œë ¥** 

```bash
NAME   READY   STATUS    RESTARTS   AGE
app1   1/1     Running   0          57s
app2   1/1     Running   0          57s
```

![Image](https://github.com/user-attachments/assets/a3357cf5-1e80-4d7e-9ae7-431bac8ef4ca)

### **16. Pod ë‚´ë¶€ì—ì„œ EFS ë³¼ë¥¨ í¬ê¸° í™•ì¸**

**(1) EFS ë³¼ë¥¨ì´ ì •ìƒì ìœ¼ë¡œ ë§ˆìš´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸**

- `app1`ê³¼ `app2` Pod ë‚´ë¶€ì—ì„œ `/data` ë””ë ‰í„°ë¦¬ê°€ EFS ë³¼ë¥¨ìœ¼ë¡œ ì •ìƒ ë§ˆìš´íŠ¸ë˜ì—ˆëŠ”ì§€ í™•ì¸

```bash
(eks-user:default) [root@operator-host specs]# kubectl exec -ti app1 -- sh -c "df -hT -t nfs4"

# âœ… ì¶œë ¥
Filesystem           Type            Size      Used Available Use% Mounted on
127.0.0.1:/          nfs4            8.0E         0      8.0E   0% /data
```

```bash
(eks-user:default) [root@operator-host specs]# kubectl exec -ti app2 -- sh -c "df -hT -t nfs4"

# âœ… ì¶œë ¥
Filesystem           Type            Size      Used Available Use% Mounted on
127.0.0.1:/          nfs4            8.0E         0      8.0E   0% /data
```

**(2) EFS ë³¼ë¥¨ í¬ê¸° ì°¨ì´ ë¶„ì„**

- `kubectl get pv`ë¡œ í™•ì¸í•œ **EFSì˜ ì„¤ì •ëœ ìš©ëŸ‰ì€ 5GiB**
- ê·¸ëŸ¬ë‚˜ **Pod ë‚´ë¶€ì—ì„œëŠ” EFS í¬ê¸°ê°€ `8.0E`(ì—‘ì‚¬ë°”ì´íŠ¸)ë¡œ í‘œì‹œë¨**
- ì´ëŠ” **EFSê°€ ë¸”ë¡ ìŠ¤í† ë¦¬ì§€ê°€ ì•„ë‹Œ íŒŒì¼ ì‹œìŠ¤í…œ ê¸°ë°˜ìœ¼ë¡œ ê´€ë¦¬ë˜ë©°, í¬ê¸° ì œí•œ ì—†ì´ ìë™ í™•ì¥ ê°€ëŠ¥**í•˜ê¸° ë•Œë¬¸
- ì¦‰, EFSëŠ” **ë…¼ë¦¬ì ìœ¼ë¡œ ë¬´í•œí•œ í¬ê¸°ë¡œ ì¸ì‹ë˜ë©°, ì‹¤ì œ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì¦ê°€**

### **17. ë‹¤ì¤‘ Podì—ì„œ EFS ë§ˆìš´íŠ¸ ì„¤ì •**

- `app1`ê³¼ `app2` Podê°€ ë™ì¼í•œ EFS ë³¼ë¥¨ì„ `/data` ê²½ë¡œì— ë§ˆìš´íŠ¸í•˜ë„ë¡ ì„¤ì •
- ê° PodëŠ” `/data/out1.txt` ë° `/data/out2.txt` íŒŒì¼ì— 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ë¡œê·¸ë¥¼ ê¸°ë¡

```bash
(eks-user:default) [root@operator-host specs]# cat pod1.yaml pod2.yaml
```

âœ… **ì¶œë ¥** 

```bash
apiVersion: v1
kind: Pod
metadata:
  name: app1
spec:
  containers:
  - name: app1
    image: busybox
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out1.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: efs-claim
      
apiVersion: v1
kind: Pod
metadata:
  name: app2
spec:
  containers:
  - name: app2
    image: busybox
    command: ["/bin/sh"]
    args: ["-c", "while true; do echo $(date -u) >> /data/out2.txt; sleep 5; done"]
    volumeMounts:
    - name: persistent-storage
      mountPath: /data
  volumes:
  - name: persistent-storage
    persistentVolumeClaim:
      claimName: efs-claim
```

### **18. ìš´ì˜ì„œë²„ì—ì„œ EFS ë§ˆìš´íŠ¸ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# df -hT
```

âœ… **ì¶œë ¥** 

```bash
Filesystem      Type      Size  Used Avail Use% Mounted on
devtmpfs        devtmpfs  981M     0  981M   0% /dev
tmpfs           tmpfs     990M     0  990M   0% /dev/shm
tmpfs           tmpfs     990M  432K  989M   1% /run
tmpfs           tmpfs     990M     0  990M   0% /sys/fs/cgroup
/dev/xvda1      xfs        30G  3.2G   27G  11% /
192.168.1.145:/ nfs4      8.0E     0  8.0E   0% /mnt/myefs
tmpfs           tmpfs     198M     0  198M   0% /run/user/1000
```

- ìš´ì˜ì„œë²„ì—ì„œë„ ë™ì¼í•œ EFS ë³¼ë¥¨ì„ `/mnt/myefs`ì— ë§ˆìš´íŠ¸í•˜ì—¬ ê³µìœ  ì €ì¥ì†Œë¡œ í™œìš© ê°€ëŠ¥

### **19. ê³µìœ  ì €ì¥ì†Œ ë‚´ íŒŒì¼ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# tree /mnt/myefs
```

âœ… **ì¶œë ¥** 

```bash
/mnt/myefs
â”œâ”€â”€ memo.txt
â”œâ”€â”€ out1.txt
â””â”€â”€ out2.txt

0 directories, 3 files
```

- `out1.txt`ì™€ `out2.txt`ëŠ” ê°ê° `app1`ê³¼ `app2`ê°€ ìƒì„±í•œ íŒŒì¼
- ìš´ì˜ì„œë²„ì—ì„œë„ ë™ì¼í•œ ë°ì´í„°ë¥¼ í™•ì¸ ê°€ëŠ¥

### **20. EFS ê³µìœ  ì €ì¥ì†Œ ë™ì‘ í™•ì¸**

ìš´ì˜ì„œë²„ì™€ `app1`, `app2`ì—ì„œ ê°™ì€ íŒŒì¼ì„ ì¡°íšŒ

**(1) ìš´ì˜ì„œë²„ì—ì„œ íŒŒì¼ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# tail -f /mnt/myefs/out1.txt
```

âœ… **ì¶œë ¥** 

```bash
Tue Feb 18 14:02:30 UTC 2025
Tue Feb 18 14:02:35 UTC 2025
Tue Feb 18 14:02:40 UTC 2025
Tue Feb 18 14:02:45 UTC 2025
Tue Feb 18 14:02:50 UTC 2025
...
```

**(2) Pod ë‚´ë¶€ì—ì„œ ë™ì¼í•œ íŒŒì¼ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl exec -ti app1 -- tail -f /data/out1.txt
```

âœ… **ì¶œë ¥** 

```bash
Tue Feb 18 14:02:55 UTC 2025
Tue Feb 18 14:03:00 UTC 2025
Tue Feb 18 14:03:05 UTC 2025
Tue Feb 18 14:03:10 UTC 2025
Tue Feb 18 14:03:15 UTC 2025
...
```

- ìš´ì˜ì„œë²„ì™€ Pod ê°„ì— ë™ì¼í•œ íŒŒì¼ì„ ê³µìœ í•˜ë©° ì‹¤ì‹œê°„ìœ¼ë¡œ ë°ì´í„°ê°€ ì €ì¥ë¨

### **21. EFS ë§ˆìš´íŠ¸ í•´ì œ ë° ë¦¬ì†ŒìŠ¤ ì •ë¦¬**

**(1) Pod ë° EFS ê´€ë ¨ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

```bash
(eks-user:default) [root@operator-host specs]# kubectl delete pod app1 app2
# ê²°ê³¼
pod "app1" deleted
pod "app2" deleted
```

```bash
(eks-user:default) [root@operator-host specs]# kubectl delete pvc efs-claim && kubectl delete pv efs-pv && kubectl delete sc efs-sc
# ê²°ê³¼
persistentvolumeclaim "efs-claim" deleted
persistentvolume "efs-pv" deleted
storageclass.storage.k8s.io "efs-sc" deleted
```

---

## **ğŸ”‘ EFS AccessPointsë¥¼ í™œìš©í•œ ë™ì  í”„ë¡œë¹„ì €ë‹ ë°°í¬**

### **1. EFS AccessPoints ê¸°ë°˜ StorageClass ìƒì„±**

EFS AccessPointsë¥¼ í™œìš©í•˜ì—¬ íŠ¹ì • ë””ë ‰í† ë¦¬ì™€ ê¶Œí•œì„ ì„¤ì •í•  ìˆ˜ ìˆëŠ” StorageClass ìƒì„±

```bash
(eks-user:default) [root@operator-host specs]# curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/storageclass.yaml
(eks-user:default) [root@operator-host specs]# cat storageclass.yaml
```

âœ… **ì¶œë ¥**

```bash
kind: StorageClass
apiVersion: storage.k8s.io/v1
metadata:
  name: efs-sc
provisioner: efs.csi.aws.com
parameters:
  provisioningMode: efs-ap
  fileSystemId: fs-92107410
  directoryPerms: "700"
  gidRangeStart: "1000" # optional
  gidRangeEnd: "2000" # optional
  basePath: "/dynamic_provisioning" # optional
  subPathPattern: "${.PVC.namespace}/${.PVC.name}" # optional
  ensureUniqueDirectory: "true" # optional
  reuseAccessPoint: "false" # optional
```

**ì„¤ì • í•­ëª©**

- `fileSystemId`: ì‚¬ìš© ì¤‘ì¸ EFS IDë¥¼ ë™ì ìœ¼ë¡œ ì ìš©
- `basePath`: ë™ì  ìƒì„±ë  ë””ë ‰í† ë¦¬ ê²½ë¡œ ì„¤ì •
- `subPathPattern`: PVCë³„ ê°œë³„ ë””ë ‰í† ë¦¬ í• ë‹¹

```bash
(eks-user:default) [root@operator-host specs]# sed -i "s/fs-92107410/$EfsFsId/g" storageclass.yaml
(eks-user:default) [root@operator-host specs]# kubectl apply -f storageclass.yaml

# ê²°ê³¼
storageclass.storage.k8s.io/efs-sc created
```

### **2. StorageClass ìƒì„± í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get sc efs-sc
```

âœ… **ì¶œë ¥**

```bash
NAME     PROVISIONER       RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
efs-sc   efs.csi.aws.com   Delete          Immediate           false                  5s
```

### **3. PVC ë° Pod ìƒì„±**

**(1) PVC ë° Pod ì •ì˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ**

```bash
(eks-user:default) [root@operator-host specs]# curl -s -O https://raw.githubusercontent.com/kubernetes-sigs/aws-efs-csi-driver/master/examples/kubernetes/dynamic_provisioning/specs/pod.yaml
```

**(2) PVC ë° Pod ì„¤ì • ë‚´ìš© í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# cat pod.yaml
```

âœ… **ì¶œë ¥**

```bash
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: efs-claim
spec:
  accessModes:
    - ReadWriteMany
  storageClassName: efs-sc
  resources:
    requests:
      storage: 5Gi
---
apiVersion: v1
kind: Pod
metadata:
  name: efs-app
spec:
  containers:
    - name: app
      image: centos
      command: ["/bin/sh"]
      args: ["-c", "while true; do echo $(date -u) >> /data/out; sleep 5; done"]
      volumeMounts:
        - name: persistent-storage
          mountPath: /data
  volumes:
    - name: persistent-storage
      persistentVolumeClaim:
        claimName: efs-claim
```

**(3) PVC ë° Pod ìƒì„±**

```bash
(eks-user:default) [root@operator-host specs]# kubectl apply -f pod.yaml

# ê²°ê³¼
persistentvolumeclaim/efs-claim created
pod/efs-app created
```

### **4. PVC, PV, Pod ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl get pvc,pv,pod
```

âœ… **ì¶œë ¥**

```bash
NAME                              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
persistentvolumeclaim/efs-claim   Bound    pvc-4ea92c76-1bda-4425-b183-77f8c6ea11ef   5Gi        RWX            efs-sc         <unset>                 2s

NAME                                                        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
persistentvolume/pvc-4ea92c76-1bda-4425-b183-77f8c6ea11ef   5Gi        RWX            Delete           Bound    default/efs-claim   efs-sc         <unset>                          2s

NAME          READY   STATUS              RESTARTS   AGE
pod/efs-app   0/1     ContainerCreating   0          2s
```

### **5. PVC, PV ìƒì„± ë¡œê·¸ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl krew install stern
```

âœ… **ì¶œë ¥**

```bash
Updated the local copy of plugin index.
Installing plugin: stern
Installed plugin: stern
\
 | Use this plugin:
 | 	kubectl stern
 | Documentation:
 | 	https://github.com/stern/stern
/
WARNING: You installed plugin "stern" from the krew-index plugin repository.
   These plugins are not audited for security by the Krew maintainers.
   Run them at your own risk.
```

**EFS CSI ë“œë¼ì´ë²„ ë¡œê·¸ í™•ì¸**

```bash
kubectl stern -n kube-system -l app=efs-csi-controller -c csi-provisioner
```

![Image](https://github.com/user-attachments/assets/c203a6f2-3f8b-40d9-9191-4b45fbaa38c8)

### **6. Pod ë‚´ë¶€ì—ì„œ EFS ë§ˆìš´íŠ¸ í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# kubectl exec -it efs-app -- sh -c "df -hT -t nfs4"
```

âœ… **ì¶œë ¥** 

```bash
Filesystem     Type  Size  Used Avail Use% Mounted on
127.0.0.1:/    nfs4  8.0E     0  8.0E   0% /data
```

- EFSê°€ ì •ìƒì ìœ¼ë¡œ ë§ˆìš´íŠ¸ë¨
- ë™ì ìœ¼ë¡œ í¬ê¸° í™•ì¥ ê°€ëŠ¥

### **7. EFS AccessPointsë¥¼ í†µí•œ ì €ì¥ì†Œ ê´€ë¦¬**

- **AccessPointsë¥¼ í™œìš©í•˜ì—¬ í™˜ê²½ë³„ ì €ì¥ì†Œ ë¶„ë¦¬ ê°€ëŠ¥**

![Image](https://github.com/user-attachments/assets/07ece9ff-6f58-47b7-bbcb-7178ce9fa4bc)

### **8. ê³µìœ  ì €ì¥ì†Œ ë‚´ ë°ì´í„° í™•ì¸**

```bash
(eks-user:default) [root@operator-host specs]# tree /mnt/myefs
```

âœ… **ì¶œë ¥**

```bash
/mnt/myefs
â”œâ”€â”€ dynamic_provisioning
â”‚Â Â  â””â”€â”€ default
â”‚Â Â      â””â”€â”€ efs-claim-1a0017bc-6165-44fb-ac74-5d623fd39925
â”‚Â Â          â””â”€â”€ out
â”œâ”€â”€ memo.txt
â”œâ”€â”€ out1.txt
â””â”€â”€ out2.txt

3 directories, 4 files
```

- PVCë³„ ê°œë³„ ë””ë ‰í† ë¦¬ê°€ ìë™ ìƒì„±ë¨
- ë™ì  ë³¼ë¥¨ í• ë‹¹ì´ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë¨

### **9. ë¦¬ì†ŒìŠ¤ ì •ë¦¬**

```bash
(eks-user:default) [root@operator-host specs]# kubectl delete -f pod.yaml
persistentvolumeclaim "efs-claim" deleted
pod "efs-app" deleted
```

```bash
(eks-user:default) [root@operator-host specs]# kubectl delete -f storageclass.yaml
storageclass.storage.k8s.io "efs-sc" deleted

(eks-user:default) [root@operator-host specs]# cd $HOME
```

---

## **ğŸ—ï¸ EKS ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ê¸°ë°˜ Persistent Volumes ë° NodeGroup ì¶”ê°€**

### **1. ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´(Instance Store)ë€?**

- ë¬¼ë¦¬ ì„œë²„ì— ë¡œì»¬ ì €ì¥ì†Œë¥¼ ì œê³µí•˜ëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ì €ì¥ì†Œ
- ì¸ìŠ¤í„´ìŠ¤ê°€ ì¢…ë£Œë˜ë©´ ë°ì´í„°ê°€ ì‚­ì œë  ê°€ëŠ¥ì„±ì´ ìˆìŒ
- **IO ì„±ëŠ¥ì´ ë›°ì–´ë‚˜ë©° ë§¤ìš° ë¹ ë¥¸ ì†ë„ë¡œ ë™ì‘**

### **2. ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ì§€ì› ì¸ìŠ¤í„´ìŠ¤ ìœ í˜• ë° ìš©ëŸ‰ ì¡°íšŒ**

```bash
aws ec2 describe-instance-types \
 --filters "Name=instance-type,Values=c5*" "Name=instance-storage-supported,Values=true" \
 --query "InstanceTypes[].[InstanceType, InstanceStorageInfo.TotalSizeInGB]" \
 --output table
```

âœ… **ì¶œë ¥**

```bash
--------------------------
|  DescribeInstanceTypes |
+---------------+--------+
|  c5d.large    |  50    |
|  c5d.12xlarge |  1800  |
|  c5d.2xlarge  |  200   |
|  c5d.24xlarge |  3600  |
|  c5d.4xlarge  |  400   |
|  c5d.18xlarge |  1800  |
|  c5d.xlarge   |  100   |
|  c5d.metal    |  3600  |
|  c5d.9xlarge  |  900   |
+---------------+--------+
```

### **3. ì„œë¸Œë„· ë° SSH í‚¤í˜ì–´ ì„¤ì •**

- ë…¸ë“œ ê·¸ë£¹ì´ ë°°í¬ë  ì„œë¸Œë„· ë° SSH í‚¤í˜ì–´ ì„¤ì •

```bash
export PubSubnet1=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet1" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet2=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet2" --query "Subnets[0].[SubnetId]" --output text)
export PubSubnet3=$(aws ec2 describe-subnets --filters Name=tag:Name,Values="$CLUSTER_NAME-Vpc1PublicSubnet3" --query "Subnets[0].[SubnetId]" --output text)
echo $PubSubnet1 $PubSubnet2 $PubSubnet3

SSHKEYNAME=kp-aews
```

### **4. ì‹ ê·œ NodeGroup êµ¬ì„± íŒŒì¼ ìƒì„±**

```bash
cat << EOF > myng2.yaml
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: myeks
  region: ap-northeast-2
  version: "1.31"

managedNodeGroups:
- amiFamily: AmazonLinux2
  desiredCapacity: 1
  instanceType: c5d.large
  labels:
    alpha.eksctl.io/cluster-name: myeks
    alpha.eksctl.io/nodegroup-name: ng2
    disk: instancestore
  maxPodsPerNode: 110
  maxSize: 1
  minSize: 1
  name: ng2
  ssh:
    allow: true
    publicKeyName: $SSHKEYNAME
  subnets:
  - $PubSubnet1
  - $PubSubnet2
  - $PubSubnet3
  tags:
    alpha.eksctl.io/nodegroup-name: ng2
    alpha.eksctl.io/nodegroup-type: managed
  volumeIOPS: 3000
  volumeSize: 30
  volumeThroughput: 125
  volumeType: gp3
  preBootstrapCommands:
    - |
      # Install Tools
      yum install nvme-cli links tree jq tcpdump sysstat -y

      # Filesystem & Mount
      mkfs -t xfs /dev/nvme1n1
      echo /dev/nvme1n1 /data xfs defaults,noatime 0 2 >> /etc/fstab
EOF
```

- **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…**: `c5d.large` (50GB ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ì œê³µ)
- **ë””ìŠ¤í¬ ë§ˆìš´íŠ¸**: `/dev/nvme1n1 â†’ /data`
- **ì‚¬ì „ ì„¤ì¹˜ íŒ¨í‚¤ì§€**: `nvme-cli, jq, tree, tcpdump, sysstat`
- **ë³¼ë¥¨ í¬ê¸° ë° ì„±ëŠ¥ ì„¤ì •**: 30GB (gp3, 3000 IOPS, 125MB/s)

### **5. ì‹ ê·œ NodeGroup ë°°í¬**

```bash
eksctl create nodegroup -f myng2.yaml
```

âœ… **ì¶œë ¥**

```bash
2025-02-18 23:40:47 [â„¹]  nodegroup "ng2" will use "" [AmazonLinux2/1.31]
2025-02-18 23:40:47 [â„¹]  using EC2 key pair "kp-aews"
2025-02-18 23:40:48 [â„¹]  1 existing nodegroup(s) (ng1) will be excluded
2025-02-18 23:40:48 [â„¹]  1 nodegroup (ng2) was included (based on the include/exclude rules)
2025-02-18 23:40:48 [â„¹]  will create a CloudFormation stack for each of 1 managed nodegroups in cluster "myeks"
2025-02-18 23:40:49 [â„¹]  
2 sequential tasks: { fix cluster compatibility, 1 task: { 1 task: { create managed nodegroup "ng2" } } 
}
2025-02-18 23:40:49 [â„¹]  checking cluster stack for missing resources
2025-02-18 23:40:49 [â„¹]  cluster stack has all required resources
2025-02-18 23:40:49 [â„¹]  building managed nodegroup stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:40:49 [â„¹]  deploying stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:40:49 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:41:20 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:42:18 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:43:00 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:43:38 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng2"
2025-02-18 23:43:38 [â„¹]  no tasks
2025-02-18 23:43:38 [âœ”]  created 0 nodegroup(s) in cluster "myeks"
2025-02-18 23:43:38 [â„¹]  nodegroup "ng2" has 1 node(s)
2025-02-18 23:43:38 [â„¹]  node "ip-192-168-3-139.ap-northeast-2.compute.internal" is ready
2025-02-18 23:43:38 [â„¹]  waiting for at least 1 node(s) to become ready in "ng2"
2025-02-18 23:43:38 [â„¹]  nodegroup "ng2" has 1 node(s)
2025-02-18 23:43:38 [â„¹]  node "ip-192-168-3-139.ap-northeast-2.compute.internal" is ready
2025-02-18 23:43:38 [âœ”]  created 1 managed nodegroup(s) in cluster "myeks"
2025-02-18 23:43:38 [â„¹]  checking security group configuration for all nodegroups
2025-02-18 23:43:38 [â„¹]  all nodegroups have up-to-date cloudformation templates
```

### **6. ë°°í¬ëœ ë…¸ë“œ í™•ì¸**

```bash
kubectl get node --label-columns=node.kubernetes.io/instance-type,eks.amazonaws.com/capacityType,topology.kubernetes.io/zone
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE     VERSION               INSTANCE-TYPE   CAPACITYTYPE   ZONE
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   11h     v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2a
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   11h     v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2b
ip-192-168-3-139.ap-northeast-2.compute.internal   Ready    <none>   2m59s   v1.31.5-eks-5d632ec   c5d.large       ON_DEMAND      ap-northeast-2c
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   11h     v1.31.5-eks-5d632ec   t3.medium       ON_DEMAND      ap-northeast-2c
```

- ë…¸ë“œ `c5d.large`ê°€ ì •ìƒì ìœ¼ë¡œ ì¶”ê°€ë¨

```bash
kubectl get node -l disk=instancestore
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE     VERSION
ip-192-168-3-139.ap-northeast-2.compute.internal   Ready    <none>   3m29s   v1.31.5-eks-5d632ec
```

- ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ê°€ ìˆëŠ” ë…¸ë“œ í™•ì¸ ì™„ë£Œ

### **7. ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • (ng2-remoteAccess í¬í•¨)**

```bash
export NG2SGID=$(aws ec2 describe-security-groups --filters "Name=group-name,Values=*ng2-remoteAccess*" --query 'SecurityGroups[*].GroupId' --output text)
aws ec2 authorize-security-group-ingress --group-id $NG2SGID --protocol '-1' --cidr $(curl -s ipinfo.io/ip)/32
aws ec2 authorize-security-group-ingress --group-id $NG2SGID --protocol '-1' --cidr 172.20.1.100/32
```

âœ… **ì¶œë ¥**

```bash
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-01263a4b3dd1797db",
            "GroupId": "sg-0e186958bfe3d2895",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "182.230.60.93/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-01263a4b3dd1797db"
        }
    ]
}
{
    "Return": true,
    "SecurityGroupRules": [
        {
            "SecurityGroupRuleId": "sgr-004bfcccf4933bca4",
            "GroupId": "sg-0e186958bfe3d2895",
            "GroupOwnerId": "378102432899",
            "IsEgress": false,
            "IpProtocol": "-1",
            "FromPort": -1,
            "ToPort": -1,
            "CidrIpv4": "172.20.1.100/32",
            "SecurityGroupRuleArn": "arn:aws:ec2:ap-northeast-2:378102432899:security-group-rule/sgr-004bfcccf4933bca4"
        }
    ]
}
```

- ë³´ì•ˆ ê·¸ë£¹ ê·œì¹™ ì¶”ê°€ ì™„ë£Œ


![Image](https://github.com/user-attachments/assets/2759253f-bc7b-48de-9af0-ac2fc1eef997)

### **8. SSHë¥¼ í†µí•œ ì›Œì»¤ ë…¸ë“œ ì ‘ì†**

```bash
N4=3.34.90.173
ssh ec2-user@$N4 hostname
```

âœ… **ì¶œë ¥**

```bash
The authenticity of host '3.34.90.173 (3.34.90.173)' can't be established.
ED25519 key fingerprint is SHA256:8982ohpoaUv/4ImQwqxA8Ye4HDQZbziZ+n7vcW++NKw.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '3.34.90.173' (ED25519) to the list of known hosts.
ip-192-168-3-139.ap-northeast-2.compute.internal
```

- SSH ì ‘ì† í™•ì¸

### **9. ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ë””ìŠ¤í¬ í™•ì¸**

ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ NVMe ë””ìŠ¤í¬ ëª©ë¡ ì¡°íšŒ

```bash
ssh ec2-user@$N4 sudo nvme list
```

âœ… **ì¶œë ¥**

```bash
Node             SN                   Model                                    Namespace Usage                      Format           FW Rev  
---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------
/dev/nvme0n1     vol0c28a9e99805af630 Amazon Elastic Block Store               1          32.21  GB /  32.21  GB    512   B +  0 B   1.0     
/dev/nvme1n1     AWS3E4B64A6880B81A2C Amazon EC2 NVMe Instance Storage         1          50.00  GB /  50.00  GB    512   B +  0 B   0
```

- EBS(30GB) ì™¸ì—ë„ 50GB ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ì¶”ê°€ í™•ì¸ë¨

### **10. ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ë§ˆìš´íŠ¸ í™•ì¸**

`nvme1n1` ë””ìŠ¤í¬ê°€ `/data`ì— ë§ˆìš´íŠ¸ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

```bash
ssh ec2-user@$N4 sudo lsblk -e 7 -d
```

âœ… **ì¶œë ¥**

```bash
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
nvme1n1 259:0    0 46.6G  0 disk /data
nvme0n1 259:1    0   30G  0 disk 
```

- 50GB ì¸ìŠ¤í„´ìŠ¤ ìŠ¤í† ì–´ ë””ìŠ¤í¬ê°€ `/data`ì— ë§ˆìš´íŠ¸ë¨

```bash
ssh ec2-user@$N4 sudo df -hT -t xfs
```

âœ… **ì¶œë ¥**

```bash
Filesystem     Type  Size  Used Avail Use% Mounted on
/dev/nvme0n1p1 xfs    30G  3.7G   27G  13% /
/dev/nvme1n1   xfs    47G  365M   47G   1% /data
```

- ë””ìŠ¤í¬ê°€ `XFS` íŒŒì¼ ì‹œìŠ¤í…œìœ¼ë¡œ í¬ë§·ë˜ì–´ `/data`ì— ì •ìƒì ìœ¼ë¡œ ë§ˆìš´íŠ¸ë¨

```bash
ssh ec2-user@$N4 sudo tree /data
```

âœ… **ì¶œë ¥**

```bash
/data

0 directories, 0 files
```

- ë°ì´í„° ë””ë ‰í† ë¦¬ì— ì•„ë¬´ íŒŒì¼ë„ ì—†ìŒ

### **11. fstab ì„¤ì • í™•ì¸ (ë¶€íŒ… ì‹œ ìë™ ë§ˆìš´íŠ¸ ì—¬ë¶€)**

```bash
ssh ec2-user@$N4 sudo cat /etc/fstab
```

âœ… **ì¶œë ¥**

```bash
UUID=1dfdfe0d-276a-4d52-8572-ceb3b011d9ea     /           xfs    defaults,noatime  1   1
/dev/nvme1n1 /data xfs defaults,noatime 0 2
```

- ì¬ë¶€íŒ… ì‹œ `/data`ê°€ ìë™ ë§ˆìš´íŠ¸ë˜ë„ë¡ ì„¤ì •ë¨

### **12. ë…¸ë“œ ë¦¬ì†ŒìŠ¤ í™•ì¸**

```bash
kubectl describe node -l disk=instancestore | grep Allocatable: -A7
```

âœ… **ì¶œë ¥**

```bash
Allocatable:
  cpu:                1930m
  ephemeral-storage:  27905944324
  hugepages-1Gi:      0
  hugepages-2Mi:      0
  memory:             3097488Ki
  pods:               110
System Info:
```

- `ephemeral-storage` ë° `pods` ê°œìˆ˜ í™•ì¸ ê°€ëŠ¥

### **13. Kubelet íŒŒë¼ë¯¸í„° í™•ì¸**

```bash
ssh ec2-user@$N4 sudo ps -ef | grep kubelet
```

âœ… **ì¶œë ¥**

```bash
root        3014       1  0 14:42 ?        00:00:07 /usr/bin/kubelet --config /etc/kubernetes/kubelet/kubelet-config.json --kubeconfig /var/lib/kubelet/kubeconfig --container-runtime-endpoint unix:///run/containerd/containerd.sock --image-credential-provider-config /etc/eks/image-credential-provider/config.json --image-credential-provider-bin-dir /etc/eks/image-credential-provider --node-ip=192.168.3.139 --pod-infra-container-image=602401143452.dkr.ecr.ap-northeast-2.amazonaws.com/eks/pause:3.5 --v=2 --hostname-override=ip-192-168-3-139.ap-northeast-2.compute.internal --cloud-provider=external --node-labels=eks.amazonaws.com/sourceLaunchTemplateVersion=1,alpha.eksctl.io/cluster-name=myeks,alpha.eksctl.io/nodegroup-name=ng2,disk=instancestore,eks.amazonaws.com/nodegroup-image=ami-0fa05db9e3c145f63,eks.amazonaws.com/capacityType=ON_DEMAND,eks.amazonaws.com/nodegroup=ng2,eks.amazonaws.com/sourceLaunchTemplateId=lt-0d2cf44115bd914f2 --max-pods=29 --max-pods=110
root        3602    3110  0 14:42 ?        00:00:00 /csi-node-driver-registrar --csi-address=/csi/csi.sock --kubelet-registration-path=/var/lib/kubelet/plugins/efs.csi.aws.com/csi.sock --v=2
root        4015    3921  0 14:42 ?        00:00:00 /bin/aws-ebs-csi-driver node --endpoint=unix:/csi/csi.sock --http-endpoint=0.0.0.0:3302 --csi-mount-point-prefix=/var/lib/kubelet/plugins/kubernetes.io/csi/ebs.csi.aws.com/ --volume-attach-limit=31 --logging-format=text --v=2
root        4063    3921  0 14:42 ?        00:00:00 /csi-node-driver-registrar --csi-address=/csi/csi.sock --kubelet-registration-path=/var/lib/kubelet/plugins/ebs.csi.aws.com/csi.sock --v=2
```

- `--max-pods=110` ê°’ì´ ìµœì¢… ì ìš©ë¨

### **14. ê¸°ì¡´ local-path ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì‚­ì œ**

```bash
k get sc
```

âœ… **ì¶œë ¥**

```bash
NAME            PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
gp2             kubernetes.io/aws-ebs   Delete          WaitForFirstConsumer   false                  12h
gp3 (default)   ebs.csi.aws.com         Delete          WaitForFirstConsumer   true                   3h32m
local-path      rancher.io/local-path   Delete          WaitForFirstConsumer   false                  6h53m
```

```bash
kubectl delete -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml

# ê²°ê³¼
namespace "local-path-storage" deleted
serviceaccount "local-path-provisioner-service-account" deleted
role.rbac.authorization.k8s.io "local-path-provisioner-role" deleted
clusterrole.rbac.authorization.k8s.io "local-path-provisioner-role" deleted
rolebinding.rbac.authorization.k8s.io "local-path-provisioner-bind" deleted
clusterrolebinding.rbac.authorization.k8s.io "local-path-provisioner-bind" deleted
deployment.apps "local-path-provisioner" deleted
storageclass.storage.k8s.io "local-path" deleted
configmap "local-path-config" deleted
```

### **15. ìƒˆë¡œìš´ local-path ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ë°°í¬**

```bash
curl -sL https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml | sed 's/opt/data/g' | kubectl apply -f -

# ê²°ê³¼
namespace/local-path-storage created
serviceaccount/local-path-provisioner-service-account created
role.rbac.authorization.k8s.io/local-path-provisioner-role created
clusterrole.rbac.authorization.k8s.io/local-path-provisioner-role created
rolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created
clusterrolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created
deployment.apps/local-path-provisioner created
storageclass.storage.k8s.io/local-path created
configmap/local-path-config created
```

### **16. local-path ì„¤ì • í™•ì¸**

```bash
kubectl describe cm -n local-path-storage local-path-config
```

âœ… **ì¶œë ¥**

```bash
Name:         local-path-config
Namespace:    local-path-storage
Labels:       <none>
Annotations:  <none>

Data
====
config.json:
----
{
        "nodePathMap":[
        {
                "node":"DEFAULT_PATH_FOR_NON_LISTED_NODES",
                "paths":["/data/local-path-provisioner"]
        }
        ]
}

helperPod.yaml:
----
apiVersion: v1
kind: Pod
metadata:
  name: helper-pod
spec:
  priorityClassName: system-node-critical
  tolerations:
    - key: node.kubernetes.io/disk-pressure
      operator: Exists
      effect: NoSchedule
  containers:
  - name: helper-pod
    image: busybox
    imagePullPolicy: IfNotPresent

setup:
----
#!/bin/sh
set -eu
mkdir -m 0777 -p "$VOL_DIR"

teardown:
----
#!/bin/sh
set -eu
rm -rf "$VOL_DIR"

BinaryData
====

Events:  <none>
```

- ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì˜ ë§ˆìš´íŠ¸ ê²½ë¡œ `/data/local-path-provisioner`ë¡œ ë³€ê²½ë¨

### **17. ì¸ìŠ¤í„´ìŠ¤ ì ‘ì†**

```bash
ssh ec2-user@$N4
Last login: Tue Feb 18 15:07:08 2025 from 182.230.60.93
   ,     #_
   ~\_  ####_        Amazon Linux 2
  ~~  \_#####\
  ~~     \###|       AL2 End of Life is 2026-06-30.
  ~~       \#/ ___
   ~~       V~' '->
    ~~~         /    A newer version of Amazon Linux is available!
      ~~._.   _/
         _/ _/       Amazon Linux 2023, GA and supported until 2028-03-15.
       _/m/'           https://aws.amazon.com/linux/amazon-linux-2023/

[ec2-user@ip-192-168-3-139 ~]$ 
```

### **18. ë””ìŠ¤í¬ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (IOPS í™•ì¸)**

```bash
[ec2-user@ip-192-168-3-139 ~]$ iostat -xmdz 1 -p nvme1n1
```

âœ… **ì¶œë ¥**

```bash
Linux 5.10.233-224.894.amzn2.x86_64 (ip-192-168-3-139.ap-northeast-2.compute.internal) 	02/18/2025 	_x86_64_	(2 CPU)

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
nvme1n1           0.00     0.00    0.19    0.16     0.00     0.02   118.97     0.00    0.23    0.08    0.41   0.28   0.01

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util

Device:         rrqm/s   wrqm/s     r/s     w/s    rMB/s    wMB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
```

- nvme1n1 ë””ìŠ¤í¬ì˜ ì…ì¶œë ¥(IO) ì†ë„ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸ ê°€ëŠ¥

### **19. FIO í…ŒìŠ¤íŠ¸ë¡œ IOPS ì„±ëŠ¥ ì¸¡ì •**

```bash
(eks-user:default) [root@operator-host ~]# kubestr fio -f fio-read.fio -s local-path --size 10G --nodeselector disk=instancestore
```

- **FIO ë²¤ì¹˜ë§ˆí¬ í…ŒìŠ¤íŠ¸ê°€ ì§„í–‰ë¨**

![Image](https://github.com/user-attachments/assets/a8e229cb-f43d-4b4c-9c2f-801c3deb746b)

âœ… **ì¶œë ¥**

```bash
PVC created kubestr-fio-pvc-cvqpl
Pod created kubestr-fio-pod-xzw7g
Running FIO test (fio-read.fio) on StorageClass (local-path) with a PVC of Size (10G)
Elapsed time- 3m42.67154584s
FIO test results:
  
FIO version - fio-3.36
Global options - ioengine=libaio verify= direct=1 gtod_reduce=

JobName: 
  blocksize= filesize= iodepth= rw=
read:
  IOPS=20308.564453 BW(KiB/s)=81234
  iops: min=15898 max=93734 avg=20316.953125
  bw(KiB/s): min=63592 max=374940 avg=81267.796875

Disk stats (read/write):
  nvme1n1: ios=2433492/10 merge=0/3 ticks=7648125/15 in_queue=7648141, util=99.949951%
  -  OK
```

- IOPSê°€ ê¸°ì¡´ ëŒ€ë¹„ 7ë°° ì¦ê°€ (`IOPS=20308.564453`), í‰ê·  ëŒ€ì—­í­ 81MB/s ë‹¬ì„±

### **19. ë°°í¬ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë° ì‚­ì œ**

```bash
# local-path ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì‚­ì œ
kubectl delete -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.31/deploy/local-path-storage.yaml
namespace "local-path-storage" deleted
serviceaccount "local-path-provisioner-service-account" deleted
role.rbac.authorization.k8s.io "local-path-provisioner-role" deleted
clusterrole.rbac.authorization.k8s.io "local-path-provisioner-role" deleted
rolebinding.rbac.authorization.k8s.io "local-path-provisioner-bind" deleted
clusterrolebinding.rbac.authorization.k8s.io "local-path-provisioner-bind" deleted
deployment.apps "local-path-provisioner" deleted
storageclass.storage.k8s.io "local-path" deleted
configmap "local-path-config" deleted

# ng2 ë…¸ë“œê·¸ë£¹ ì‚­ì œ
eksctl delete nodegroup -c $CLUSTER_NAME -n ng2
2025-02-19 00:18:37 [â„¹]  1 nodegroup (ng2) was included (based on the include/exclude rules)
2025-02-19 00:18:37 [â„¹]  will drain 1 nodegroup(s) in cluster "myeks"
2025-02-19 00:18:37 [â„¹]  starting parallel draining, max in-flight of 1
2025-02-19 00:18:37 [â„¹]  cordon node "ip-192-168-3-139.ap-northeast-2.compute.internal"
2025-02-19 00:18:37 [âœ”]  drained all nodes: [ip-192-168-3-139.ap-northeast-2.compute.internal]
2025-02-19 00:18:37 [â„¹]  will delete 1 nodegroups from cluster "myeks"
2025-02-19 00:18:38 [â„¹]  1 task: { 1 task: { delete nodegroup "ng2" [async] } }
2025-02-19 00:18:38 [â„¹]  will delete stack "eksctl-myeks-nodegroup-ng2"
2025-02-19 00:18:38 [âœ”]  deleted 1 nodegroup(s) from cluster "myeks"
```

---

## **ğŸ”„ ë©€í‹°í”Œë«í¼ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ECR ë°°í¬**

### **1. ë…¸ë“œ ê·¸ë£¹ ë° CPU ì•„í‚¤í…ì²˜ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# arch
# ê²°ê³¼
x86_64
```

**ë‹¤ë¥¸ ì•„í‚¤í…ì²˜(ARM, RISC-V) ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹œ ì˜¤ë¥˜ ë°œìƒ**

```bash
(eks-user:default) [root@operator-host ~]# docker run --rm -it riscv64/ubuntu bash
# ê²°ê³¼
Unable to find image 'riscv64/ubuntu:latest' locally
latest: Pulling from riscv64/ubuntu
docker: no matching manifest for linux/amd64 in the manifest list entries.
See 'docker run --help'.

(eks-user:default) [root@operator-host ~]# docker run --rm -it arm64v8/ubuntu bash
# ê²°ê³¼
Unable to find image 'arm64v8/ubuntu:latest' locally
latest: Pulling from arm64v8/ubuntu
docker: no matching manifest for linux/amd64 in the manifest list entries.
See 'docker run --help'
```

- CPU ì•„í‚¤í…ì²˜ê°€ ë‹¤ë¥¼ ê²½ìš° ê¸°ë³¸ì ìœ¼ë¡œ ì‹¤í–‰ ë¶ˆê°€ëŠ¥

### **2. ë©€í‹°í”Œë«í¼ ì»¨í…Œì´ë„ˆ ë¹Œë“œ í™˜ê²½ êµ¬ì¶•**

**(1) `buildx` ë¹Œë” ìƒíƒœ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# docker buildx ls
```

âœ… **ì¶œë ¥**

```bash
NAME/NODE DRIVER/ENDPOINT STATUS  BUILDKIT PLATFORMS
default * docker                           
  default default         running v0.12.5  linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386
```

- ê¸°ë³¸ì ìœ¼ë¡œ `amd64` í”Œë«í¼ë§Œ ì§€ì›ë¨

**(2) QEMUë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ë¥¸ ì•„í‚¤í…ì²˜ ì§€ì› í™œì„±í™”**

```bash
(eks-user:default) [root@operator-host ~]# docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
```

âœ… **ì¶œë ¥**

```bash
Unable to find image 'multiarch/qemu-user-static:latest' locally
latest: Pulling from multiarch/qemu-user-static
205dae5015e7: Pull complete 
816739e52091: Pull complete 
30abb83a18eb: Pull complete 
0657daef200b: Pull complete 
30c9c93f40b9: Pull complete 
Digest: sha256:fe60359c92e86a43cc87b3d906006245f77bfc0565676b80004cc666e4feb9f0
Status: Downloaded newer image for multiarch/qemu-user-static:latest
Setting /usr/bin/qemu-alpha-static as binfmt interpreter for alpha
Setting /usr/bin/qemu-arm-static as binfmt interpreter for arm
Setting /usr/bin/qemu-armeb-static as binfmt interpreter for armeb
Setting /usr/bin/qemu-sparc-static as binfmt interpreter for sparc
Setting /usr/bin/qemu-sparc32plus-static as binfmt interpreter for sparc32plus
Setting /usr/bin/qemu-sparc64-static as binfmt interpreter for sparc64
Setting /usr/bin/qemu-ppc-static as binfmt interpreter for ppc
Setting /usr/bin/qemu-ppc64-static as binfmt interpreter for ppc64
Setting /usr/bin/qemu-ppc64le-static as binfmt interpreter for ppc64le
Setting /usr/bin/qemu-m68k-static as binfmt interpreter for m68k
Setting /usr/bin/qemu-mips-static as binfmt interpreter for mips
Setting /usr/bin/qemu-mipsel-static as binfmt interpreter for mipsel
Setting /usr/bin/qemu-mipsn32-static as binfmt interpreter for mipsn32
Setting /usr/bin/qemu-mipsn32el-static as binfmt interpreter for mipsn32el
Setting /usr/bin/qemu-mips64-static as binfmt interpreter for mips64
Setting /usr/bin/qemu-mips64el-static as binfmt interpreter for mips64el
Setting /usr/bin/qemu-sh4-static as binfmt interpreter for sh4
Setting /usr/bin/qemu-sh4eb-static as binfmt interpreter for sh4eb
Setting /usr/bin/qemu-s390x-static as binfmt interpreter for s390x
Setting /usr/bin/qemu-aarch64-static as binfmt interpreter for aarch64
Setting /usr/bin/qemu-aarch64_be-static as binfmt interpreter for aarch64_be
Setting /usr/bin/qemu-hppa-static as binfmt interpreter for hppa
Setting /usr/bin/qemu-riscv32-static as binfmt interpreter for riscv32
Setting /usr/bin/qemu-riscv64-static as binfmt interpreter for riscv64
Setting /usr/bin/qemu-xtensa-static as binfmt interpreter for xtensa
Setting /usr/bin/qemu-xtensaeb-static as binfmt interpreter for xtensaeb
Setting /usr/bin/qemu-microblaze-static as binfmt interpreter for microblaze
Setting /usr/bin/qemu-microblazeel-static as binfmt interpreter for microblazeel
Setting /usr/bin/qemu-or1k-static as binfmt interpreter for or1k
Setting /usr/bin/qemu-hexagon-static as binfmt interpreter for hexagon
```

- QEMUë¥¼ í†µí•´ ë‹¤ì–‘í•œ ì•„í‚¤í…ì²˜ ì§€ì› ì¶”ê°€ë¨

**(3) QEMU ì„¤ì¹˜ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# docker images
```

âœ… **ì¶œë ¥**

```bash
REPOSITORY                   TAG       IMAGE ID       CREATED       SIZE
multiarch/qemu-user-static   latest    3539aaa87393   2 years ago   305MB
```

### **3. ë¹Œë“œ í™˜ê²½ ìƒì„± ë° í™•ì¸**

**(1) `buildx` ë¹Œë” ìƒì„±**

```bash
(eks-user:default) [root@operator-host ~]# docker buildx create --use --name mybuilder
# ê²°ê³¼
mybuilder
```

**(2) `buildx` ë¹Œë” ëª©ë¡ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# docker buildx ls
```

âœ… **ì¶œë ¥**

```bash
NAME/NODE    DRIVER/ENDPOINT             STATUS   BUILDKIT PLATFORMS
mybuilder *  docker-container                              
  mybuilder0 unix:///var/run/docker.sock inactive          
default      docker                                        
  default    default                     running  v0.12.5  linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386, linux/arm64, linux/riscv64, linux/ppc64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6
```

- **ë©€í‹°í”Œë«í¼ ë¹Œë“œ í™˜ê²½ì´ í™œì„±í™”ë¨**

**(3) `buildx` ë¹Œë” ë¶€íŠ¸ìŠ¤íŠ¸ë© ì‹¤í–‰**

```bash
(eks-user:default) [root@operator-host ~]# docker buildx inspect --bootstrap
```

âœ… **ì¶œë ¥**

```bash
[+] Building 8.6s (1/1) FINISHED                                                                                                                  
 => [internal] booting buildkit                                                                                                              8.6s
 => => pulling image moby/buildkit:buildx-stable-1                                                                                           7.9s
 => => creating container buildx_buildkit_mybuilder0                                                                                         0.7s
Name:          mybuilder
Driver:        docker-container
Last Activity: 2025-02-18 15:33:47 +0000 UTC

Nodes:
Name:      mybuilder0
Endpoint:  unix:///var/run/docker.sock
Status:    running
Buildkit:  v0.19.0
Platforms: linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/arm64, linux/riscv64, linux/ppc64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6
Labels:
 org.mobyproject.buildkit.worker.executor:         oci
 org.mobyproject.buildkit.worker.hostname:         9dd2e75695e3
 org.mobyproject.buildkit.worker.network:          host
 org.mobyproject.buildkit.worker.oci.process-mode: sandbox
 org.mobyproject.buildkit.worker.selinux.enabled:  false
 org.mobyproject.buildkit.worker.snapshotter:      overlayfs
GC Policy rule#0:
 All:           false
 Filters:       type==source.local,type==exec.cachemount,type==source.git.checkout
 Keep Duration: 48h0m0s
GC Policy rule#1:
 All:           false
 Keep Duration: 1440h0m0s
 Keep Bytes:    2.794GiB
GC Policy rule#2:
 All:        false
 Keep Bytes: 2.794GiB
GC Policy rule#3:
 All:        true
 Keep Bytes: 2.794GiB
```

- ì´ì œ ì—¬ëŸ¬ ì•„í‚¤í…ì²˜ì˜ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ê°€ëŠ¥

**(4) `buildx` ë¹Œë” ëª©ë¡ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# docker buildx ls
```

âœ… **ì¶œë ¥**

```bash
NAME/NODE    DRIVER/ENDPOINT             STATUS  BUILDKIT PLATFORMS
mybuilder *  docker-container                             
  mybuilder0 unix:///var/run/docker.sock running v0.19.0  linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/arm64, linux/riscv64, linux/ppc64, linux/ppc64le, linux/s390x, linux/386, linux/arm/v7, linux/arm/v6
default      docker                                       
  default    default                     running v0.12.5  linux/amd64, linux/amd64/v2, linux/amd64/v3, linux/386, linux/arm64, linux/riscv64, linux/ppc64, linux/ppc64le, linux/s390x, linux/mips64le, linux/mips64, linux/arm/v7, linux/arm/v6
```

- `linux/amd64`, `linux/arm64`, `linux/riscv64` ë“± ë‹¤ì¤‘ í”Œë«í¼ ì§€ì› í™•ì¸ ê°€ëŠ¥

**(5) `buildx` ì‹¤í–‰ í™•ì¸**

```bash
(eks-user:default) [root@operator-host ~]# docker ps
```

âœ… **ì¶œë ¥**

```bash
CONTAINER ID   IMAGE                           COMMAND       CREATED          STATUS          PORTS     NAMES
9dd2e75695e3   moby/buildkit:buildx-stable-1   "buildkitd"   58 seconds ago   Up 57 seconds             buildx_buildkit_mybuilder0
```

- moby/buildkit ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ë˜ë©° ë©€í‹°í”Œë«í¼ ë¹Œë“œ ê°€ëŠ¥

### **4. ìƒ˜í”Œ ì»¨í…Œì´ë„ˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±**

**(1) í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±**

```bash
(eks-user:default) [root@operator-host ~]# mkdir myweb && cd myweb
```

**(2) `server.py` ì‘ì„±**

```bash
(eks-user:default) [root@operator-host myweb]# cat > server.py <<EOF
> from http.server import ThreadingHTTPServer, BaseHTTPRequestHandler
> from datetime import datetime
> import socket
> 
> class RequestHandler(BaseHTTPRequestHandler):
>     def do_GET(self):
>         self.send_response(200)
>         self.send_header('Content-type', 'text/plain')
>         self.end_headers()
>         
>         now = datetime.now()
>         hostname = socket.gethostname()
>         response_string = now.strftime("The time is %-I:%M:%S %p, VERSION 0.0.1\n")
>         response_string += f"Server hostname: {hostname}\n"
>         self.wfile.write(bytes(response_string, "utf-8")) 
> 
> def startServer():
>     try:
>         server = ThreadingHTTPServer(('', 80), RequestHandler)
>         print("Listening on " + ":".join(map(str, server.server_address)))
>         server.serve_forever()
>     except KeyboardInterrupt:
>         server.shutdown()
> 
> if __name__ == "__main__":
>     startServer()
> EOF
```

**(3) `Dockerfile` ì‘ì„±**

```bash
(eks-user:default) [root@operator-host myweb]# cat > Dockerfile <<EOF
> FROM python:3.12
> ENV PYTHONUNBUFFERED 1
> COPY . /app
> WORKDIR /app 
> CMD python3 server.py
> EOF
```

### **5.  ë‹¨ì¼ í”Œë«í¼ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì‹¤í–‰**

**(1) Python 3.12 ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ**

```bash
(eks-user:default) [root@operator-host myweb]# docker pull python:3.12

# ê²°ê³¼
3.12: Pulling from library/python
a492eee5e559: Pull complete 
32b550be6cb6: Pull complete 
35af2a7690f2: Pull complete 
7576b00d9bb1: Pull complete 
07612085660d: Pull complete 
60fd44efca0f: Pull complete 
4a12975a6131: Pull complete 
Digest: sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0
Status: Downloaded newer image for python:3.12
docker.io/library/python:3.12
```

**(2) Python 3.12 ê¸°ë°˜ ì»¨í…Œì´ë„ˆ ë¹Œë“œ**

```bash
(eks-user:default) [root@operator-host myweb]# docker build -t myweb:1 -t myweb:latest .

# ê²°ê³¼
[+] Building 0.3s (8/8) FINISHED                                                                                                   docker:default
 => [internal] load build definition from Dockerfile                                                                                         0.0s
 => => transferring dockerfile: 125B                                                                                                         0.0s
 => [internal] load metadata for docker.io/library/python:3.12                                                                               0.0s
 => [internal] load .dockerignore                                                                                                            0.0s
 => => transferring context: 2B                                                                                                              0.0s
 => [internal] load build context                                                                                                            0.0s
 => => transferring context: 1.04kB                                                                                                          0.0s
 => [1/3] FROM docker.io/library/python:3.12                                                                                                 0.1s
 => [2/3] COPY . /app                                                                                                                        0.2s
 => [3/3] WORKDIR /app                                                                                                                       0.0s
 => exporting to image                                                                                                                       0.0s
 => => exporting layers                                                                                                                      0.0s
 => => writing image sha256:e8e1bb0cc5209d01fa642497dc930b06db1e6317d3eacc9b94c40033b7436efd                                                 0.0s
 => => naming to docker.io/library/myweb:1                                                                                                   0.0s
 => => naming to docker.io/library/myweb:latest                                                                                              0.0s
```

- `myweb:1` ë° `myweb:latest` íƒœê·¸ë¡œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ

### **6. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ í™•ì¸**

```bash
(eks-user:default) [root@operator-host myweb]# docker images
```

âœ… **ì¶œë ¥**

```bash
REPOSITORY                   TAG               IMAGE ID       CREATED          SIZE
myweb                        1                 e8e1bb0cc520   27 seconds ago   1.02GB
myweb                        latest            e8e1bb0cc520   27 seconds ago   1.02GB
python                       3.12              149b9784258f   13 days ago      1.02GB
moby/buildkit                buildx-stable-1   23b5a9d195cf   4 weeks ago      208MB
multiarch/qemu-user-static   latest            3539aaa87393   2 years ago      305MB
```

- ë¹Œë“œëœ `myweb:1` ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ í™•ì¸

### **7. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ë° ì„œë¹„ìŠ¤ í™•ì¸**

```bash
(eks-user:default) [root@operator-host myweb]# docker run -d -p 8080:80 --name=timeserver myweb

# ê²°ê³¼
2651f49a0fe29182098c0c6e185ee81e63816f1ddf034fa2f32cc58383f7badb
```

- `timeserver` ì»¨í…Œì´ë„ˆ ì‹¤í–‰
- 8080 í¬íŠ¸ë¡œ HTTP ìš”ì²­ì„ ë°›ì„ ìˆ˜ ìˆìŒ

```bash
(eks-user:default) [root@operator-host myweb]# curl http://localhost:8080
```

âœ… **ì¶œë ¥**

```bash
The time is 3:51:20 PM, VERSION 0.0.1
Server hostname: 2651f49a0fe2
```

- í˜„ì¬ ì‹œê°„ê³¼ ì»¨í…Œì´ë„ˆ í˜¸ìŠ¤íŠ¸ëª…ì„ ë°˜í™˜í•˜ëŠ” ê°„ë‹¨í•œ ì›¹ ì„œë²„ ë™ì‘ í™•ì¸

### **8. ì»¨í…Œì´ë„ˆ ì •ë¦¬**

```bash
(eks-user:default) [root@operator-host myweb]# docker rm -f timeserver

# ê²°ê³¼
timeserver
```

### **9. Docker Hub ë¡œê·¸ì¸**

```bash
(eks-user:default) [root@operator-host myweb]# docker login
Log in with your Docker ID or email address to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com/ to create one.
You can log in with your password or a Personal Access Token (PAT). Using a limited-scope PAT grants better security and is required for organizations using SSO. Learn more at https://docs.docker.com/go/access-tokens/

Username: shinminjin
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```

### **10. Docker ì‚¬ìš©ìëª… ë³€ìˆ˜ ì„¤ì •**

```bash
(eks-user:default) [root@operator-host myweb]# DOCKERNAME=shinminjin
```

### **11. ë‹¤ì¤‘ ì•„í‚¤í…ì²˜ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° í‘¸ì‹œ**

```bash
(eks-user:default) [root@operator-host myweb]# docker buildx build --platform linux/amd64,linux/arm64 --push --tag $DOCKERNAME/myweb:multi .
```

âœ… **ì¶œë ¥**

```bash
[+] Building 106.5s (14/14) FINISHED                                                                                   docker-container:mybuilder
 => [internal] load build definition from Dockerfile                                                                                         0.0s
 => => transferring dockerfile: 125B                                                                                                         0.0s
 => [linux/arm64 internal] load metadata for docker.io/library/python:3.12                                                                   2.6s
 => [linux/amd64 internal] load metadata for docker.io/library/python:3.12                                                                   2.5s
 => [auth] library/python:pull token for registry-1.docker.io                                                                                0.0s
 => [internal] load .dockerignore                                                                                                            0.0s
 => => transferring context: 2B                                                                                                              0.0s
 => [linux/amd64 1/3] FROM docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0            36.9s
 => => resolve docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0                         0.0s
 => => sha256:4a12975a6131fb8b18f6c80441a8533d18ec06d744cd9dd26431ae147a1b7552 248B / 248B                                                   0.5s
 => => sha256:60fd44efca0fdc711987188c7b289674aea93ed94d2beff8a1e4d92a8e1fbe7f 25.66MB / 25.66MB                                             1.1s
 => => sha256:7576b00d9bb10cc967bb5bdeeb3d5fa078ac8800e112aa03ed15ec199662d4f7 211.33MB / 211.33MB                                           5.7s
 => => sha256:07612085660d86eae935f91c31ea91065995815b395c798b5c0f8df260c7e2a8 6.16MB / 6.16MB                                               0.7s
 => => sha256:35af2a7690f2b43e7237d1fae8e3f2350dfb25f3249e9cf65121866f9c56c772 64.39MB / 64.39MB                                             2.6s
 => => sha256:32b550be6cb62359a0f3a96bc0dc289f8b45d097eaad275887f163c6780b4108 24.06MB / 24.06MB                                             1.7s
 => => sha256:a492eee5e55976c7d3feecce4c564aaf6f14fb07fdc5019d06f4154eddc93fde 48.48MB / 48.48MB                                             1.9s
 => => extracting sha256:a492eee5e55976c7d3feecce4c564aaf6f14fb07fdc5019d06f4154eddc93fde                                                    4.3s
 => => extracting sha256:32b550be6cb62359a0f3a96bc0dc289f8b45d097eaad275887f163c6780b4108                                                    1.5s
 => => extracting sha256:35af2a7690f2b43e7237d1fae8e3f2350dfb25f3249e9cf65121866f9c56c772                                                    5.4s
 => => extracting sha256:7576b00d9bb10cc967bb5bdeeb3d5fa078ac8800e112aa03ed15ec199662d4f7                                                   15.7s
 => => extracting sha256:07612085660d86eae935f91c31ea91065995815b395c798b5c0f8df260c7e2a8                                                    0.6s
 => => extracting sha256:60fd44efca0fdc711987188c7b289674aea93ed94d2beff8a1e4d92a8e1fbe7f                                                    1.6s
 => => extracting sha256:4a12975a6131fb8b18f6c80441a8533d18ec06d744cd9dd26431ae147a1b7552                                                    0.0s
 => [linux/arm64 1/3] FROM docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0            36.1s
 => => resolve docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0                         0.0s
 => => sha256:305935ae2ee22ec786106269d7da84b1df25782c691db84256ebce68190e1c79 250B / 250B                                                   0.5s
 => => sha256:d708adbcc8ee3a9b1354ffe945eb8875d5e843a6aceb8397559caf8ef2ffd214 24.91MB / 24.91MB                                             1.1s
 => => sha256:7d49e4574da2d8f2419ffdbd2cfc65c6be873a05dab52159fb02b63d8be816fe 6.24MB / 6.24MB                                               1.0s
 => => sha256:9611c2b713640ce0f9156445b244c4da5e621183b56c0901d97a8b6d54ce10d7 202.72MB / 202.72MB                                           6.2s
 => => sha256:c9d3572a68af0b860060b7ea84adfa8406fa20cfd1337c947dfb661aa965eee7 64.36MB / 64.36MB                                             2.8s
 => => sha256:193c44006e77abbadfdd7be72b4ab6d7a5c08640ef575970f722b798ee7800ac 23.60MB / 23.60MB                                             1.3s
 => => sha256:106abeaee908db66722312b3379ae398e2bcc5b2fdad0cc248509efa14a819ff 48.31MB / 48.31MB                                             2.2s
 => => extracting sha256:106abeaee908db66722312b3379ae398e2bcc5b2fdad0cc248509efa14a819ff                                                    8.1s
 => => extracting sha256:193c44006e77abbadfdd7be72b4ab6d7a5c08640ef575970f722b798ee7800ac                                                    1.6s
 => => extracting sha256:c9d3572a68af0b860060b7ea84adfa8406fa20cfd1337c947dfb661aa965eee7                                                    5.4s
 => => extracting sha256:9611c2b713640ce0f9156445b244c4da5e621183b56c0901d97a8b6d54ce10d7                                                   14.6s
 => => extracting sha256:7d49e4574da2d8f2419ffdbd2cfc65c6be873a05dab52159fb02b63d8be816fe                                                    0.6s
 => => extracting sha256:d708adbcc8ee3a9b1354ffe945eb8875d5e843a6aceb8397559caf8ef2ffd214                                                    2.2s
 => => extracting sha256:305935ae2ee22ec786106269d7da84b1df25782c691db84256ebce68190e1c79                                                    0.0s
 => [internal] load build context                                                                                                            0.0s
 => => transferring context: 1.04kB                                                                                                          0.0s
 => [linux/arm64 2/3] COPY . /app                                                                                                            0.2s
 => [linux/arm64 3/3] WORKDIR /app                                                                                                           0.0s
 => [linux/amd64 2/3] COPY . /app                                                                                                            0.1s
 => [linux/amd64 3/3] WORKDIR /app                                                                                                           0.0s
 => exporting to image                                                                                                                      66.8s
 => => exporting layers                                                                                                                      0.1s
 => => exporting manifest sha256:b73a3a9ae85ac83166587bc398a9cda723b1296cd200e7bf61a2f8fdc03f22d6                                            0.0s
 => => exporting config sha256:2e766855d2c0dc9c8a005866ec139d251b4f3cabd38586fff3fa9df874b1b14f                                              0.0s
 => => exporting attestation manifest sha256:be4b65e573ddbae236084237c32bb3e61598865f2378464082b008a268349bd7                                0.0s
 => => exporting manifest sha256:5d18951aa10d7db756c39875c1360499c3a6643a097f9ea81ed8fdc7479c9b49                                            0.0s
 => => exporting config sha256:c319f11eb4c8a52e492b75bd068715a6703f6d0afcf6d6240dbed9c0ad1011e8                                              0.0s
 => => exporting attestation manifest sha256:eaa3e8e820eb8ee42165d8d674562cc887cdf8b0e9ba7d26d24e05bde231ce07                                0.0s
 => => exporting manifest list sha256:1c6d6bc4f4383a11c8d033222ba28e68073abd45e0de31272d0b94020916ee56                                       0.0s
 => => pushing layers                                                                                                                       62.4s
 => => pushing manifest for docker.io/shinminjin/myweb:multi@sha256:1c6d6bc4f4383a11c8d033222ba28e68073abd45e0de31272d0b94020916ee56         4.2s
 => [auth] shinminjin/myweb:pull,push token for registry-1.docker.io                                                                         0.0s

 2 warnings found (use --debug to expand):
 - LegacyKeyValueFormat: "ENV key=value" should be used instead of legacy "ENV key value" format (line 2)
 - JSONArgsRecommended: JSON arguments recommended for CMD to prevent unintended behavior related to OS signals (line 5)
```

- `linux/amd64`, `linux/arm64` ì•„í‚¤í…ì²˜ë¥¼ ì§€ì›í•˜ëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ
- ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ Docker Hubë¡œ í‘¸ì‹œ

### **12. ë¹Œë“œëœ ì»¨í…Œì´ë„ˆ ì•„í‚¤í…ì²˜ í™•ì¸**

- Docker Hubì— í‘¸ì‹œëœ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì˜ OS ë° ì•„í‚¤í…ì²˜ í™•ì¸ ê°€ëŠ¥
- âœ… **ìš´ì˜ ì²´ì œ(OS):** `linux`
- âœ… **ì§€ì› ì•„í‚¤í…ì²˜(Architecture):** `amd64`, `arm64`

![Image](https://github.com/user-attachments/assets/6a269eff-0773-417c-a7e0-81ae6bed4963)

- ë‹¤ì¤‘ í”Œë«í¼ ì§€ì›ìœ¼ë¡œ ìš´ì˜ íš¨ìœ¨ì„± ì¦ê°€

![Image](https://github.com/user-attachments/assets/2afffb7e-efdd-4d6e-ab4f-679e9f3a4837)

```bash
(eks-user:default) [root@operator-host myweb]# docker manifest inspect $DOCKERNAME/myweb:multi | jq
```

âœ… **ì¶œë ¥**

```bash
{
  "schemaVersion": 2,
  "mediaType": "application/vnd.oci.image.index.v1+json",
  "manifests": [
    {
      "mediaType": "application/vnd.oci.image.manifest.v1+json",
      "size": 2010,
      "digest": "sha256:b73a3a9ae85ac83166587bc398a9cda723b1296cd200e7bf61a2f8fdc03f22d6",
      "platform": {
        "architecture": "amd64",
        "os": "linux"
      }
    },
    {
      "mediaType": "application/vnd.oci.image.manifest.v1+json",
      "size": 2010,
      "digest": "sha256:5d18951aa10d7db756c39875c1360499c3a6643a097f9ea81ed8fdc7479c9b49",
      "platform": {
        "architecture": "arm64",
        "os": "linux"
      }
    },
    {
      "mediaType": "application/vnd.oci.image.manifest.v1+json",
      "size": 566,
      "digest": "sha256:be4b65e573ddbae236084237c32bb3e61598865f2378464082b008a268349bd7",
      "platform": {
        "architecture": "unknown",
        "os": "unknown"
      }
    },
    {
      "mediaType": "application/vnd.oci.image.manifest.v1+json",
      "size": 566,
      "digest": "sha256:eaa3e8e820eb8ee42165d8d674562cc887cdf8b0e9ba7d26d24e05bde231ce07",
      "platform": {
        "architecture": "unknown",
        "os": "unknown"
      }
    }
  ]
}
```

- ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ê°€ `amd64`, `arm64` ì•„í‚¤í…ì²˜ë¥¼ ëª¨ë‘ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥

### **13. ì»¨í…Œì´ë„ˆ ì‚­ì œ**

```bash
docker rm -f timeserver
```

---

## **ğŸ¢ AWS ECR í”„ë¼ì´ë¹— ì €ì¥ì†Œ ì‚¬ìš©í•˜ê¸°**

### **1. AWS ECR ë¡œê·¸ì¸ ë° ì¸ì¦ ì„¤ì •**

**(1) AWS ê³„ì • IDë¥¼ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥**

```bash
(eks-user:default) [root@operator-host myweb]# export ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text
```

**(2) ECRì— Docker ì¸ì¦ ì •ë³´ ì„¤ì •**

```bash
(eks-user:default) [root@operator-host myweb]# aws ecr get-login-password \
> --region ap-northeast-2 | docker login \
> --username AWS \
> --password-stdin ${ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com
```

âœ… **ì¶œë ¥**

```bash
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```

### **2. ECR ì¸ì¦ ì •ë³´ í™•ì¸**

```bash
(eks-user:default) [root@operator-host myweb]# cat /root/.docker/config.json | jq
```

âœ… **ì¶œë ¥**

```bash
{
  "auths": {
    "378102432899.dkr.ecr.ap-northeast-2.amazonaws.com": {
      "auth": "xxxxxxxxxxxxxxxxxx"
    },
    "https://index.docker.io/v1/": {
      "auth": "xxxxxxxxxxxxxxxxxx"
    }
  }
}
```

- `auths` í•­ëª©ì— ECR ì €ì¥ì†Œ URLì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸

### **3. ECR í”„ë¼ì´ë¹— ì €ì¥ì†Œ ìƒì„±**

- ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì €ì¥ì†Œë¥¼ AWS ECRì—ì„œ ìƒì„±

```bash
(eks-user:default) [root@operator-host myweb]# aws ecr create-repository --repository-name myweb
```

âœ… **ì¶œë ¥**

```bash
{
    "repository": {
        "repositoryArn": "arn:aws:ecr:ap-northeast-2:378102432899:repository/myweb",
        "registryId": "378102432899",
        "repositoryName": "myweb",
        "repositoryUri": "378102432899.dkr.ecr.ap-northeast-2.amazonaws.com/myweb",
        "createdAt": "2025-02-19T01:17:53.137000+09:00",
        "imageTagMutability": "MUTABLE",
        "imageScanningConfiguration": {
            "scanOnPush": false
        },
        "encryptionConfiguration": {
            "encryptionType": "AES256"
        }
    }
}
```

### **4. ë‹¤ì¤‘ ì•„í‚¤í…ì²˜ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ECR í‘¸ì‹œ**

- `linux/amd64`, `linux/arm64` ì•„í‚¤í…ì²˜ ì§€ì› ì»¨í…Œì´ë„ˆ ë¹Œë“œ
- ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ AWS ECRë¡œ ë°”ë¡œ í‘¸ì‹œ

```bash
(eks-user:default) [root@operator-host myweb]# docker buildx build --platform linux/amd64,linux/arm64 --push --tag ${ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/myweb:multi .
```

âœ… **ì¶œë ¥**

```bash
[+] Building 13.3s (14/14) FINISHED                                                                                    docker-container:mybuilder
 => [internal] load build definition from Dockerfile                                                                                         0.0s
 => => transferring dockerfile: 125B                                                                                                         0.0s
 => [linux/arm64 internal] load metadata for docker.io/library/python:3.12                                                                   1.4s
 => [linux/amd64 internal] load metadata for docker.io/library/python:3.12                                                                   1.4s
 => [auth] library/python:pull token for registry-1.docker.io                                                                                0.0s
 => [internal] load .dockerignore                                                                                                            0.0s
 => => transferring context: 2B                                                                                                              0.0s
 => [linux/amd64 1/3] FROM docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0             0.0s
 => => resolve docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0                         0.0s
 => [linux/arm64 1/3] FROM docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0             0.0s
 => => resolve docker.io/library/python:3.12@sha256:f61c61fb2a8967599fb0874746c93530c3d2a4583478528eda06584abc736ea0                         0.0s
 => [internal] load build context                                                                                                            0.0s
 => => transferring context: 60B                                                                                                             0.0s
 => CACHED [linux/arm64 2/3] COPY . /app                                                                                                     0.0s
 => CACHED [linux/arm64 3/3] WORKDIR /app                                                                                                    0.0s
 => CACHED [linux/amd64 2/3] COPY . /app                                                                                                     0.0s
 => CACHED [linux/amd64 3/3] WORKDIR /app                                                                                                    0.0s
 => exporting to image                                                                                                                      11.8s
 => => exporting layers                                                                                                                      0.0s
 => => exporting manifest sha256:b73a3a9ae85ac83166587bc398a9cda723b1296cd200e7bf61a2f8fdc03f22d6                                            0.0s
 => => exporting config sha256:2e766855d2c0dc9c8a005866ec139d251b4f3cabd38586fff3fa9df874b1b14f                                              0.0s
 => => exporting attestation manifest sha256:75d8f32e66dee7b5268c1882a93f0107bf972a16c7972903f0fefbde843b0e08                                0.0s
 => => exporting manifest sha256:5d18951aa10d7db756c39875c1360499c3a6643a097f9ea81ed8fdc7479c9b49                                            0.0s
 => => exporting config sha256:c319f11eb4c8a52e492b75bd068715a6703f6d0afcf6d6240dbed9c0ad1011e8                                              0.0s
 => => exporting attestation manifest sha256:388d86fbeda42c224fd181d385228fa7d7ff1d0ff2c3379c5b7f6f21e4e2f8f2                                0.0s
 => => exporting manifest list sha256:2bfb7328872d6ac549cfdc136c70bca7f133b7d2da51da1a3f456ff256d774ba                                       0.0s
 => => pushing layers                                                                                                                       10.4s
 => => pushing manifest for 378102432899.dkr.ecr.ap-northeast-2.amazonaws.com/myweb:multi@sha256:2bfb7328872d6ac549cfdc136c70bca7f133b7d2da  1.4s
 => [auth] sharing credentials for 378102432899.dkr.ecr.ap-northeast-2.amazonaws.com                                                         0.0s

 2 warnings found (use --debug to expand):
 - LegacyKeyValueFormat: "ENV key=value" should be used instead of legacy "ENV key value" format (line 2)
 - JSONArgsRecommended: JSON arguments recommended for CMD to prevent unintended behavior related to OS signals (line 5)
```

- `multi-architecture` ì§€ì› ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ê°€ ECRì— í‘¸ì‹œë¨

![Image](https://github.com/user-attachments/assets/472257ad-a6cc-4796-96e3-e46307b1abc2)

### **5. AWS ECR ì»¨í…Œì´ë„ˆ ì‹¤í–‰**

- ECRì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ í’€í•˜ì—¬ ì‹¤í–‰
- ìœˆë„ìš°PC(amd64), macOS(arm64)ì—ì„œ ë™ì¼í•œ ì´ë¯¸ì§€ ì‚¬ìš© ê°€ëŠ¥

```bash
(eks-user:default) [root@operator-host myweb]# docker run -d -p 8080:80 --name=timeserver ${ACCOUNT_ID}.dkr.ecr.ap-northeast-2.amazonaws.com/myweb:multi
```

âœ… **ì¶œë ¥**

```bash
Unable to find image '378102432899.dkr.ecr.ap-northeast-2.amazonaws.com/myweb:multi' locally
multi: Pulling from myweb
a492eee5e559: Already exists 
32b550be6cb6: Already exists 
35af2a7690f2: Already exists 
7576b00d9bb1: Already exists 
07612085660d: Already exists 
60fd44efca0f: Already exists 
4a12975a6131: Already exists 
0a18c01708c3: Pull complete 
4f4fb700ef54: Pull complete 
Digest: sha256:2bfb7328872d6ac549cfdc136c70bca7f133b7d2da51da1a3f456ff256d774ba
Status: Downloaded newer image for 378102432899.dkr.ecr.ap-northeast-2.amazonaws.com/myweb:multi
c981958a36336d01c5ee98d23a9953b03261bbeceeab19e9c4b910598a9bad2e
```

- ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ìƒíƒœ í™•ì¸

```bash
(eks-user:default) [root@operator-host myweb]# curl http://localhost:8080
```

âœ… **ì¶œë ¥**

```bash
The time is 4:21:54 PM, VERSION 0.0.1
Server hostname: c981958a3633
```

### **6. ECR ì»¨í…Œì´ë„ˆ ë° ì €ì¥ì†Œ ì •ë¦¬**

**(1) ECR ì €ì¥ì†Œ ì‚­ì œ**

![Image](https://github.com/user-attachments/assets/e3f8af1c-841e-422d-af9e-f323b6decd23)

**(2) ì»¨í…Œì´ë„ˆ ì‚­ì œ**

```bash
(eks-user:default) [root@operator-host myweb]# docker rm -f timeserver
# ê²°ê³¼
timeserver
```

---

## âš¡ AWS Graviton (ARM) ë…¸ë“œê·¸ë£¹ ë° ë°°í¬ ì‹¤ìŠµ

### **1. ê¸°ì¡´ ë…¸ë“œ ì•„í‚¤í…ì²˜ í™•ì¸**

```bash
kubectl get nodes -L kubernetes.io/arch
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               ARCH
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   13h   v1.31.5-eks-5d632ec   amd64
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   13h   v1.31.5-eks-5d632ec   amd64
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   13h   v1.31.5-eks-5d632ec   amd64
```

- í˜„ì¬ EKS í´ëŸ¬ìŠ¤í„°ì˜ ëª¨ë“  ë…¸ë“œëŠ” `amd64` ì•„í‚¤í…ì²˜

### **2. Graviton(ARM) ê¸°ë°˜ ë…¸ë“œê·¸ë£¹ ìƒì„±**

**(1) YAML íŒŒì¼ ìƒì„± (`myng3.yaml`)**

```bash
eksctl create nodegroup -c $CLUSTER_NAME -r ap-northeast-2 --subnet-ids "$PubSubnet1","$PubSubnet2","$PubSubnet3" \
  -n ng3 -t t4g.medium -N 1 -m 1 -M 1 --node-volume-size=30 --node-labels family=graviton --dry-run > myng3.yaml
```

**(2) ë…¸ë“œê·¸ë£¹ ìƒì„±**

```bash
eksctl create nodegroup -f myng3.yaml

# ê²°ê³¼
2025-02-19 01:32:09 [â„¹]  nodegroup "ng3" will use "" [AmazonLinux2/1.31]
2025-02-19 01:32:10 [â„¹]  1 existing nodegroup(s) (ng1) will be excluded
2025-02-19 01:32:10 [â„¹]  1 nodegroup (ng3) was included (based on the include/exclude rules)
2025-02-19 01:32:10 [â„¹]  will create a CloudFormation stack for each of 1 managed nodegroups in cluster "myeks"
2025-02-19 01:32:11 [â„¹]  
2 sequential tasks: { fix cluster compatibility, 1 task: { 1 task: { create managed nodegroup "ng3" } } 
}
2025-02-19 01:32:11 [â„¹]  checking cluster stack for missing resources
2025-02-19 01:32:11 [â„¹]  cluster stack has all required resources
2025-02-19 01:32:12 [â„¹]  building managed nodegroup stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:32:12 [â„¹]  deploying stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:32:12 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:32:42 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:33:17 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:33:57 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:34:38 [â„¹]  waiting for CloudFormation stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 01:34:38 [â„¹]  no tasks
2025-02-19 01:34:38 [âœ”]  created 0 nodegroup(s) in cluster "myeks"
2025-02-19 01:34:38 [â„¹]  nodegroup "ng3" has 1 node(s)
2025-02-19 01:34:38 [â„¹]  node "ip-192-168-3-99.ap-northeast-2.compute.internal" is ready
2025-02-19 01:34:38 [â„¹]  waiting for at least 1 node(s) to become ready in "ng3"
2025-02-19 01:34:38 [â„¹]  nodegroup "ng3" has 1 node(s)
2025-02-19 01:34:38 [â„¹]  node "ip-192-168-3-99.ap-northeast-2.compute.internal" is ready
2025-02-19 01:34:38 [âœ”]  created 1 managed nodegroup(s) in cluster "myeks"
2025-02-19 01:34:38 [â„¹]  checking security group configuration for all nodegroups
2025-02-19 01:34:38 [â„¹]  all nodegroups have up-to-date cloudformation templates
```

### **3. ë°°í¬ëœ ë…¸ë“œ í™•ì¸**

```bash
kubectl get nodes --label-columns eks.amazonaws.com/nodegroup,kubernetes.io/arch,eks.amazonaws.com/capacityType
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE     VERSION               NODEGROUP             ARCH    CAPACITYTYPE
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   13h     v1.31.5-eks-5d632ec   ng1                   amd64   ON_DEMAND
ip-192-168-1-92.ap-northeast-2.compute.internal    Ready    <none>   7m41s   v1.31.5-eks-5d632ec   managed-spot          amd64   SPOT
ip-192-168-2-145.ap-northeast-2.compute.internal   Ready    <none>   99s     v1.31.4-eks-0f56d01   ng-bottlerocket       amd64   ON_DEMAND
ip-192-168-2-164.ap-northeast-2.compute.internal   Ready    <none>   7m40s   v1.31.5-eks-5d632ec   managed-spot          amd64   SPOT
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   13h     v1.31.5-eks-5d632ec   ng1                   amd64   ON_DEMAND
ip-192-168-3-73.ap-northeast-2.compute.internal    Ready    <none>   73s     v1.31.4-eks-0f56d01   ng-bottlerocket-ssh   amd64   ON_DEMAND
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   13h     v1.31.5-eks-5d632ec   ng1                   amd64   ON_DEMAND
ip-192-168-3-99.ap-northeast-2.compute.internal    Ready    <none>   12m     v1.31.5-eks-5d632ec   ng3                   arm64   ON_DEMAND
```

- `ng3` ë…¸ë“œê°€ `arm64`ë¡œ ë°°í¬ë¨
![Image](https://github.com/user-attachments/assets/4d147f6c-ef29-4d0d-a6fc-e6589ea63042)

### **4. í˜„ì¬ Taints ì„¤ì • í™•ì¸**

```bash
aws eks describe-nodegroup --cluster-name $CLUSTER_NAME --nodegroup-name ng3 | jq .nodegroup.taints
```

âœ… **ì¶œë ¥**

```bash
null
```

![Image](https://github.com/user-attachments/assets/4b6533a0-1ecc-4a95-a136-70a47f64d10a)

### **5. Graviton ë…¸ë“œì— Taints ì„¤ì •**

- `ng3` ë…¸ë“œì— `frontend=true:NoExecute` Taint ì ìš©
- íŠ¹ì • Podë§Œ í•´ë‹¹ ë…¸ë“œì— ìŠ¤ì¼€ì¤„ë§ ê°€ëŠ¥

```bash
aws eks update-nodegroup-config --cluster-name $CLUSTER_NAME --nodegroup-name ng3 --taints "addOrUpdateTaints=[{key=frontend, value=true, effect=NO_EXECUTE}]"
```

âœ… **ì¶œë ¥**

```bash
{
    "update": {
        "id": "eabe8298-9d6b-3ef6-965f-00120771faa6",
        "status": "InProgress",
        "type": "ConfigUpdate",
        "params": [
            {
                "type": "TaintsToAdd",
                "value": "[{\"effect\":\"NO_EXECUTE\",\"value\":\"true\",\"key\":\"frontend\"}]"
            },
            {
                "type": "TaintsToRemove",
                "value": "[]"
            }
        ],
        "createdAt": "2025-02-19T01:52:40.946000+09:00",
        "errors": []
    }
}
```

- **Taints ì„¤ì • í™•ì¸**

```bash
kubectl describe nodes --selector family=graviton | grep Taints
```

âœ… **ì¶œë ¥**

```bash
Taints:             frontend=true:NoExecute
```

![Image](https://github.com/user-attachments/assets/30054f48-8332-495f-ab1b-a8335bfd96fc)

### **6. Graviton ë…¸ë“œì— Tolerationsì„ í¬í•¨í•œ Pod ë°°í¬**

- `tolerations`ì„ ì„¤ì •í•˜ì—¬ Taintê°€ ìˆì–´ë„ Podê°€ ë°°í¬ë  ìˆ˜ ìˆë„ë¡ ì„¤ì •

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: busybox
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: busybox
    image: busybox
    command:
    - "/bin/sh"
    - "-c"
    - "while true; do date >> /home/pod-out.txt; cd /home; sync; sync; sleep 10; done"
  tolerations:
    - effect: NoExecute
      key: frontend
      operator: Exists
  nodeSelector:
    family: graviton
EOF

# ê²°ê³¼
pod/busybox created
```

![Image](https://github.com/user-attachments/assets/70663d42-56ff-431e-83bf-06fee29fc0e7)

### **7. Pod ì •ë³´ í™•ì¸**

**(1) Pod ì„¸ë¶€ ì •ë³´ í™•ì¸**

```bash
kubectl describe pod busybox
```

âœ… **ì¶œë ¥**

```bash
Name:             busybox
Namespace:        default
Priority:         0
Service Account:  default
Node:             ip-192-168-3-99.ap-northeast-2.compute.internal/192.168.3.99
Start Time:       Wed, 19 Feb 2025 01:59:49 +0900
Labels:           <none>
Annotations:      <none>
Status:           Running
IP:               192.168.3.40
IPs:
  IP:  192.168.3.40
Containers:
  busybox:
    Container ID:  containerd://620e686393b9dee8876708ba15aac6f8523fd6fa9dd0507183dd230b9277bca9
    Image:         busybox
    Image ID:      docker.io/library/busybox@sha256:a5d0ce49aa801d475da48f8cb163c354ab95cab073cd3c138bd458fc8257fbf1
    Port:          <none>
    Host Port:     <none>
    Command:
      /bin/sh
      -c
      while true; do date >> /home/pod-out.txt; cd /home; sync; sync; sleep 10; done
    State:          Running
      Started:      Wed, 19 Feb 2025 01:59:54 +0900
    Ready:          True
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-5sq9z (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   True
  Initialized                 True
  Ready                       True
  ContainersReady             True
  PodScheduled                True
Volumes:
  kube-api-access-5sq9z:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    ConfigMapOptional:       <nil>
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              family=graviton
Tolerations:                 frontend:NoExecute op=Exists
                             node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  2m27s  default-scheduler  Successfully assigned default/busybox to ip-192-168-3-99.ap-northeast-2.compute.internal
  Normal  Pulling    2m26s  kubelet            Pulling image "busybox"
  Normal  Pulled     2m22s  kubelet            Successfully pulled image "busybox" in 4.274s (4.274s including waiting). Image size: 1855561 bytes.
  Normal  Created    2m22s  kubelet            Created container busybox
  Normal  Started    2m22s  kubelet            Started container busybox
```

**(2) Pod ë‚´ë¶€ì—ì„œ ì•„í‚¤í…ì²˜ í™•ì¸**

```bash
kubectl exec -it busybox -- arch
# ê²°ê³¼
aarch64
```

**(3) Pod ë‚´ë¶€ì—ì„œ ë¡œê·¸ í™•ì¸**

```bash
kubectl exec -it busybox -- tail -f /home/pod-out.txt
```

âœ… **ì¶œë ¥**

```bash
Tue Feb 18 17:01:24 UTC 2025
Tue Feb 18 17:01:34 UTC 2025
Tue Feb 18 17:01:44 UTC 2025
Tue Feb 18 17:01:54 UTC 2025
Tue Feb 18 17:02:04 UTC 2025
Tue Feb 18 17:02:14 UTC 2025
Tue Feb 18 17:02:24 UTC 2025
Tue Feb 18 17:02:34 UTC 2025
Tue Feb 18 17:02:44 UTC 2025
...
```

- `busybox` ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘

### **8. Pod ì‚­ì œ**

```bash
kubectl delete pod busybox
# ê²°ê³¼
pod "busybox" deleted
```

### **9. ë‹¤ì¤‘ ì•„í‚¤í…ì²˜ ì»¨í…Œì´ë„ˆ ë°°í¬ (x86_64 & ARM64)**

- ìš´ì˜ì„œë²„ EC2ì—ì„œ ë¹Œë“œí•œ `myweb` ì»¨í…Œì´ë„ˆë¥¼ ë‹¤ì¤‘ ì•„í‚¤í…ì²˜ ì§€ì›í•˜ëŠ” Podë¡œ ë°°í¬
- x86_64(AMD) ë° ARM64(Graviton) ë…¸ë“œì—ì„œ ê°ê° ì‹¤í–‰

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: myweb-arm
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: myweb
    image: shinminjin/myweb:multi
  tolerations:
    - effect: NoExecute
      key: frontend
      operator: Exists
  nodeSelector:
    family: graviton
---
apiVersion: v1
kind: Pod
metadata:
  name: myweb-amd
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: myweb
    image: shinminjin/myweb:multi
EOF

# ê²°ê³¼
pod/myweb-arm created
pod/myweb-amd created
```

### **10. ë°°í¬ëœ Pod ë° ë…¸ë“œ í™•ì¸**

```bash
kubectl get pod -owide
```

âœ… **ì¶œë ¥**

```bash
NAME        READY   STATUS    RESTARTS   AGE   IP              NODE                                               NOMINATED NODE   READINESS GATES
myweb-amd   1/1     Running   0          77s   192.168.2.219   ip-192-168-2-145.ap-northeast-2.compute.internal   <none>           <none>
myweb-arm   1/1     Running   0          77s   192.168.3.40    ip-192-168-3-99.ap-northeast-2.compute.internal    <none>           <none>
```

### **11. ê° ì»¨í…Œì´ë„ˆì˜ ì•„í‚¤í…ì²˜ í™•ì¸**

```bash
kubectl exec -it myweb-arm -- arch
aarch64

kubectl exec -it myweb-amd -- arch
x86_64
```

### **12. ì›¹ ì„œë¹„ìŠ¤ ì •ìƒ ë™ì‘ í™•ì¸**

```bash
kubectl exec -it myweb-arm -- curl localhost
# ê²°ê³¼
The time is 5:09:21 PM, VERSION 0.0.1
Server hostname: myweb-arm

kubectl exec -it myweb-amd -- curl localhost
# ê²°ê³¼
The time is 5:09:30 PM, VERSION 0.0.1
Server hostname: myweb-amd
```

### **13. Pod ì‚­ì œ ë° ng3 ë…¸ë“œ ê·¸ë£¹ ì‚­ì œ**

```bash
kubectl delete pod myweb-arm myweb-amd
# ê²°ê³¼
pod "myweb-arm" deleted
pod "myweb-amd" deleted
```

```bash
eksctl delete nodegroup -c $CLUSTER_NAME -n ng3
# ê²°ê³¼
2025-02-19 02:12:21 [â„¹]  1 nodegroup (ng3) was included (based on the include/exclude rules)
2025-02-19 02:12:21 [â„¹]  will drain 1 nodegroup(s) in cluster "myeks"
2025-02-19 02:12:21 [â„¹]  starting parallel draining, max in-flight of 1
2025-02-19 02:12:21 [â„¹]  cordon node "ip-192-168-3-99.ap-northeast-2.compute.internal"
2025-02-19 02:12:22 [âœ”]  drained all nodes: [ip-192-168-3-99.ap-northeast-2.compute.internal]
2025-02-19 02:12:22 [â„¹]  will delete 1 nodegroups from cluster "myeks"
2025-02-19 02:12:22 [â„¹]  1 task: { 1 task: { delete nodegroup "ng3" [async] } }
2025-02-19 02:12:22 [â„¹]  will delete stack "eksctl-myeks-nodegroup-ng3"
2025-02-19 02:12:22 [âœ”]  deleted 1 nodegroup(s) from cluster "myeks"
```

---

## **ğŸ’° ìŠ¤íŒŸ ë…¸ë“œê·¸ë£¹ ë° ë°°í¬ ì‹¤ìŠµ**

### **1. ë…¸ë“œ ì—­í•  ì¡°íšŒ**

```bash
NODEROLEARN=$(aws iam list-roles --query "Roles[?contains(RoleName, 'nodegroup-ng1')].Arn" --output text)
echo $NODEROLEARN
```

âœ… **ì¶œë ¥**

```bash
arn:aws:iam::378102432899:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-rGyQG9rZlOwl
```

### **2. ìŠ¤íŒŸ ë…¸ë“œê·¸ë£¹ ìƒì„±**

```bash
aws eks create-nodegroup \
  --cluster-name $CLUSTER_NAME \
  --nodegroup-name managed-spot \
  --subnets $PubSubnet1 $PubSubnet2 $PubSubnet3 \
  --node-role $NODEROLEARN \
  --instance-types c5.large c5d.large c5a.large \
  --capacity-type SPOT \
  --scaling-config minSize=2,maxSize=3,desiredSize=2 \
  --disk-size 20
```

âœ… **ì¶œë ¥**

```bash
{
    "nodegroup": {
        "nodegroupName": "managed-spot",
        "nodegroupArn": "arn:aws:eks:ap-northeast-2:378102432899:nodegroup/myeks/managed-spot/56ca8cf5-e169-efa6-7b36-7922fce5434f",
        "clusterName": "myeks",
        "version": "1.31",
        "releaseVersion": "1.31.5-20250212",
        "createdAt": "2025-02-19T01:37:18.476000+09:00",
        "modifiedAt": "2025-02-19T01:37:18.476000+09:00",
        "status": "CREATING",
        "capacityType": "SPOT",
        "scalingConfig": {
            "minSize": 2,
            "maxSize": 3,
            "desiredSize": 2
        },
        "instanceTypes": [
            "c5.large",
            "c5d.large",
            "c5a.large"
        ],
        "subnets": [
            "subnet-0fed28a1b3e108719",
            "subnet-0e4fb63cb543698fe",
            "subnet-0861bd68771150000"
        ],
        "amiType": "AL2023_x86_64_STANDARD",
        "nodeRole": "arn:aws:iam::378102432899:role/eksctl-myeks-nodegroup-ng1-NodeInstanceRole-rGyQG9rZlOwl",
        "diskSize": 20,
        "health": {
            "issues": []
        },
        "updateConfig": {
            "maxUnavailable": 1
        },
        "tags": {}
    }
}
```

- `managed-spot` ë…¸ë“œê·¸ë£¹ì´ **ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒì„±ë¨**

### **3. ì ì ˆí•œ ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ**

- `ec2-instance-selector` ì„¤ì¹˜
- ìš”êµ¬í•˜ëŠ” **CPU, ë©”ëª¨ë¦¬, ì•„í‚¤í…ì²˜**ì— ë§ëŠ” ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì„ íƒ ê°€ëŠ¥

```bash
curl -Lo ec2-instance-selector https://github.com/aws/amazon-ec2-instance-selector/releases/download/v2.4.1/ec2-instance-selector-`uname | tr '[:upper:]' '[:lower:]'`-amd64 && chmod +x ec2-instance-selector
sudo mv ec2-instance-selector /usr/local/bin/
ec2-instance-selector --version
```

âœ… **ì¶œë ¥**

```bash
v2.4.1
```

- `ec2-instance-selector` ì •ìƒ ì„¤ì¹˜ ì™„ë£Œ

### **4. ì¸ìŠ¤í„´ìŠ¤ ì¶”ì²œ ì¡°íšŒ (vCPU 2, RAM 4GB, GPU ì—†ìŒ, x86_64 ì•„í‚¤í…ì²˜)**

```bash
ec2-instance-selector --vcpus 2 --memory 4 --gpus 0 --current-generation -a x86_64 --deny-list 't.*' --output table-wide
```

âœ… **ì¶œë ¥**

```bash
NOTE: Could not retrieve 30 day avg hourly spot price for instance type p2.16xlarge
Instance Type   VCPUs   Mem (GiB)  Hypervisor  Current Gen  Hibernation Support  CPU Arch  Network Performance  ENIs    GPUs    GPU Mem (GiB)  GPU Info  On-Demand Price/Hr  Spot Price/Hr (30d avg)  
-------------   -----   ---------  ----------  -----------  -------------------  --------  -------------------  ----    ----    -------------  --------  ------------------  -----------------------  
c5.large        2       4          nitro       true         true                 x86_64    Up to 10 Gigabit     3       0       0              none      $0.096              $0.02993                 
c5a.large       2       4          nitro       true         false                x86_64    Up to 10 Gigabit     3       0       0              none      $0.086              $0.0397                  
c5d.large       2       4          nitro       true         true                 x86_64    Up to 10 Gigabit     3       0       0              none      $0.11               $0.03067                 
c6i.large       2       4          nitro       true         true                 x86_64    Up to 12.5 Gigabit   3       0       0              none      $0.096              $0.03346                 
c6id.large      2       4          nitro       true         true                 x86_64    Up to 12.5 Gigabit   3       0       0              none      $0.1155             $0.03071                 
c6in.large      2       4          nitro       true         true                 x86_64    Up to 25 Gigabit     3       0       0              none      $0.1281             $0.05098                 
c7i-flex.large  2       4          nitro       true         true                 x86_64    Up to 12.5 Gigabit   3       0       0              none      $0.09576            $0.02884                 
c7i.large       2       4          nitro       true         true                 x86_64    Up to 12.5 Gigabit   3       0       0              none      $0.1008             $0.02964
```

- `c5.large` ê³„ì—´ ì¸ìŠ¤í„´ìŠ¤ê°€ **ì €ë ´í•œ ìŠ¤íŒŸ ê°€ê²©**ì„ ì œê³µí•¨

### **5. ìŠ¤íŒŸ ë° ì˜¨ë””ë§¨ë“œ ë…¸ë“œ í™•ì¸**

**(1) ì˜¨ë””ë§¨ë“œ ë…¸ë“œë§Œ ì¡°íšŒ**

```bash
kubectl get nodes -l eks.amazonaws.com/capacityType=ON_DEMAND
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   14h   v1.31.5-eks-5d632ec
ip-192-168-2-145.ap-northeast-2.compute.internal   Ready    <none>   35m   v1.31.4-eks-0f56d01
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec
ip-192-168-3-73.ap-northeast-2.compute.internal    Ready    <none>   34m   v1.31.4-eks-0f56d01
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec
```

**(2) ì „ì²´ ë…¸ë“œ (ì˜¨ë””ë§¨ë“œ vs ìŠ¤íŒŸ) ì¡°íšŒ**

```bash
kubectl get nodes -L eks.amazonaws.com/capacityType
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               CAPACITYTYPE
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
ip-192-168-1-92.ap-northeast-2.compute.internal    Ready    <none>   41m   v1.31.5-eks-5d632ec   SPOT
ip-192-168-2-145.ap-northeast-2.compute.internal   Ready    <none>   35m   v1.31.4-eks-0f56d01   ON_DEMAND
ip-192-168-2-164.ap-northeast-2.compute.internal   Ready    <none>   41m   v1.31.5-eks-5d632ec   SPOT
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
ip-192-168-3-73.ap-northeast-2.compute.internal    Ready    <none>   35m   v1.31.4-eks-0f56d01   ON_DEMAND
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
```

![Image](https://github.com/user-attachments/assets/789ecc35-6c8a-4ad7-a2a5-dfc0b7dc436e)

### **6. ìŠ¤íŒŸ ë…¸ë“œì— Pod ë°°í¬**

ìŠ¤íŒŸ ë…¸ë“œì—ì„œë§Œ ì‹¤í–‰ë˜ëŠ” `busybox` Pod ë°°í¬

```bash
cat <<EOF | kubectl apply -f -
apiVersion: v1
kind: Pod
metadata:
  name: busybox
spec:
  terminationGracePeriodSeconds: 3
  containers:
  - name: busybox
    image: busybox
    command:
    - "/bin/sh"
    - "-c"
    - "while true; do date >> /home/pod-out.txt; cd /home; sync; sync; sleep 10; done"
  nodeSelector:
    eks.amazonaws.com/capacityType: SPOT
EOF

# ê²°ê³¼
pod/busybox created
```

### **7. Pod ë°°í¬ ë…¸ë“œ í™•ì¸**

```bash
kubectl get pod -owide
```

âœ… **ì¶œë ¥**

```bash
NAME      READY   STATUS    RESTARTS   AGE   IP             NODE                                               NOMINATED NODE   READINESS GATES
busybox   1/1     Running   0          50s   192.168.2.75   ip-192-168-2-164.ap-northeast-2.compute.internal   <none>           <none>
```

```bash
k get nodes -L eks.amazonaws.com/capacityType
```

âœ… **ì¶œë ¥**

```bash
NAME                                               STATUS   ROLES    AGE   VERSION               CAPACITYTYPE
ip-192-168-1-207.ap-northeast-2.compute.internal   Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
ip-192-168-1-92.ap-northeast-2.compute.internal    Ready    <none>   47m   v1.31.5-eks-5d632ec   SPOT
ip-192-168-2-145.ap-northeast-2.compute.internal   Ready    <none>   41m   v1.31.4-eks-0f56d01   ON_DEMAND
ip-192-168-2-164.ap-northeast-2.compute.internal   Ready    <none>   47m   v1.31.5-eks-5d632ec   SPOT
ip-192-168-2-84.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
ip-192-168-3-73.ap-northeast-2.compute.internal    Ready    <none>   41m   v1.31.4-eks-0f56d01   ON_DEMAND
ip-192-168-3-80.ap-northeast-2.compute.internal    Ready    <none>   14h   v1.31.5-eks-5d632ec   ON_DEMAND
```

- `busybox` Podê°€ **ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ë¨**

### **8. ìŠ¤íŒŸ ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ ì‚­ì œ**

**(1) Pod ì‚­ì œ**

```bash
kubectl delete pod busybox
# ê²°ê³¼
pod "busybox" deleted
```

**(2) ng3 ë…¸ë“œ ê·¸ë£¹ ì‚­ì œ** 

```bash
eksctl delete nodegroup -c $CLUSTER_NAME -n managed-spot
# ê²°ê³¼
2025-02-19 02:30:04 [â„¹]  1 nodegroup (managed-spot) was included (based on the include/exclude rules)
2025-02-19 02:30:04 [â„¹]  will drain 1 nodegroup(s) in cluster "myeks"
2025-02-19 02:30:04 [â„¹]  starting parallel draining, max in-flight of 1
2025-02-19 02:30:04 [â„¹]  cordon node "ip-192-168-1-92.ap-northeast-2.compute.internal"
2025-02-19 02:30:04 [â„¹]  cordon node "ip-192-168-2-164.ap-northeast-2.compute.internal"
2025-02-19 02:30:05 [âœ”]  drained all nodes: [ip-192-168-1-92.ap-northeast-2.compute.internal ip-192-168-2-164.ap-northeast-2.compute.internal]
2025-02-19 02:30:05 [â„¹]  will delete 1 nodegroups from cluster "myeks"
2025-02-19 02:30:05 [â„¹]  
2 parallel tasks: { delete unowned nodegroup managed-spot, no tasks 
}
2025-02-19 02:30:05 [âœ”]  deleted 1 nodegroup(s) from cluster "myeks"
```

---
## **ğŸ—‘ï¸ (ì‹¤ìŠµ ì™„ë£Œ í›„) ìì› ì‚­ì œ**

**(1) Amazon EKS í´ëŸ¬ìŠ¤í„° ì‚­ì œ**

```bash
eksctl delete cluster --name $CLUSTER_NAME
```

**(2) AWS CloudFormation ìŠ¤íƒ ì‚­ì œ**

```bash
aws cloudformation delete-stack --stack-name myeks
```

**(3) ë³€ìˆ˜ ì„¤ì • ì‚­ì œ**

EKS ë°°í¬ í›„ ì‹¤ìŠµ í¸ì˜ë¥¼ ìœ„í•´ ì¶”ê°€í–ˆë˜ ë³€ìˆ˜ ì„¤ì • ì œê±°

```bash
vi ~/.bashrc
```

